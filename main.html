<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
 
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Call Log</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  </head>
  <body>
      <div class="container">
          <h1>CALL LOG</h1>
          <div class="filter">
              <div class="select">
                  <label for="status-filter">Status</label>
                  <select id="status-filter">
                      <option value="All">All</option>
                      <option value="Answer">Answer</option>
                      <option value="Miss call">Miss call</option>
                  </select>
              </div>
              <div class="search-container">
                <input type="text" id="search" placeholder="Search">
                <i class="fas fa-search"></i>
            </div>
          </div>
          
          <table>
              <thead>
                  <tr>
                      <th>Caller Number</th>
                      <th>Caller Name</th>
                      <th>Callee Name</th>
                      <th>Start Time</th>
                      <th>End Time</th>
                      <th>Call Duration</th>
                      <th>Audio Record</th>
                      <th>Transcription</th>
                      <th>Sentiment</th>
                      <th>Call Status</th>
                      <th>Caller Id</th>
                  </tr>
              </thead>
              <tbody id="content">
              </tbody>
          </table>

      </div>

      <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0, 0, 0, 0.5); z-index:999; "></div>
      <div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:400px; height:400px; background-color:#ffffff;padding:10px; overflow:auto; z-index:1000; border-radius: 5px;">
          <div id="popupContent"></div>
      </div>

  </body>
  </html>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: start;
      height: 100vh;
      background-color: #f4f4f4;
    }
  
    .container {
      width: 100%;
      margin: 20px auto;
      overflow: hidden;
      margin-top: 0;
      height: 88%;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
  
    h1 {
      text-align: left;
      margin-bottom: 20px;
      padding-left: 30px;
    }
  
    .filter {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 40px;
    }
  
    #status-filter,
    #search,
    .select select {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  
    .filter #search:focus {
      outline: none;
      border-color: #c4a699;
    }
  
    .select {
      margin-right: 80px;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      width: 240px;
    }
  
    .select select {
      width: 50%;
    }
  
    audio {
      width: 100%;
    }
  
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: fixed;
    }
  
    table,
    th,
    td {
      border: none;
      padding: 3px 12px;
      text-align: left;
    }
  
    th {
      vertical-align: top;
    }
  
    th {
      color: #999;
      padding-bottom: 10px;
      text-align: left;
      line-height: 1.2;
      font-weight: bold;
      border-bottom: 1px solid #cccccc;
    }
  
    tbody>tr:first-child>td {
      padding-top: 10px;
    }
  
    tbody {
      max-height: 600px;
      display: block;
      height: 85%;
      overflow-y: auto;
    }
  
    tbody tr td:first-child {
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px;
    }
  
    tbody tr td:last-child {
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      color: #798bab;
    }
  
    tbody tr td {
      color: #1a1a1a;
      font-size: 15px;
    }
  
    tbody tr:nth-child(even) {
      background-color: #e6e6e6;
    }
  
    tbody tr:hover {
      background-color: #f1f1f1;
    }
  
    .Answer {
      color: #0c0;
    }
  
    .MissCall {
      color: #f33;
    }
  
  
  
    thead,
    tbody tr {
      display: table;
      width: calc(100% - 1em);
      table-layout: fixed;
    }
  
    thead {
      width: calc(100% - 1em)
    }
  
    .sentiment-bar {
      display: flex;
      width: 100%;
      height: 10px;
    }
  
    .positive,
    .negative,
    .neutral {
      width: calc(var(--i) * 100%);
    }
  
    .positive {
      background-color: #28a745;
    }
  
    .negative {
      background-color: #f33;
    }
  
    .neutral {
      background-color: #f7d014;
    }
  
    .positive:hover {
      background-color: #3fc957;
    }
  
    .negative:hover {
      background-color: #ff6666;
    }
  
    .neutral:hover {
      background-color: #f7e36d;
    }
  
    .sentiment-bar>div {
      position: relative;
      width: calc(var(--i) * 100%);
    }
  
    .sentiment-bar>div>span {
      position: absolute;
      display: none;
      top: -100%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: black;
      font-size: 10px;
    }
  
    .sentiment-bar>div:hover>span {
      display: block;
    }

    .myAudio {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: -20px;
    }
    .myAudio:hover {
      cursor: pointer;
      transform: translateX(-40%);
      width: 350%;
    }
    
  
    .search-container {
      position: relative;
      display: inline-block;
    }
  
    #search {
      padding: 10px;
      padding-right: 40px;
      font-size: 16px;
    }
  
    .search-container i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }
  
    .audio-controls.hidden {
      display: none;
    }
  
    .audio-player {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .txtLink{
      text-decoration: none;
      font-style: italic;
    }
  </style>
  <script>

  const table = document.getElementById('content');
  let data = [];
  const statusMap =  {
        'Answer': 'Answer', // 1
        'Miss call': 'MissCall', // 3
        'Caller Hangup': 'CallHp',  // 2
        'other': "other"//0
      };
  const statusMap2 = {
        0: 'Miss call',
        1: 'Answer',
        2: 'Miss call',
        3 : 'Miss call',
      };

  (async () => {

      try {
        var getDate = await fetch("https://nodered.vncluster.infodation.com/api/getCallLog");
        var result = await getDate.json();


        const customerMap = await fetchAndProcessCustomers("https://nodered.vncluster.infodation.com/api/getCustomer");
        const resellerMap = await fetchAndProcessCustomers("https://nodered.vncluster.infodation.com/api/getReseller");
        let dataProcess = result.map(i => {
          const sentiment = JSON.parse(i.sentiment); 
          return {
            callerId: i.callerId ?? '',
            callerNumber: i.callerNumber,
            callerName: customerMap.get(i.callerNumber) ?? '',
            calleeName: i.calleeName == '8:acs:3b020308-3c32-47cd-8ae6-4533874b94f6_00000020-0fbf-5408-02c3-593a0d000a7a' ? 'Admin Kikker' : resellerMap.get(i.calleeName?.substring(2) ?? '') ?? '',
            startTime: formatDate(i.startTime),
            endTime: formatDate(i.endTime),
            duration: i.duration ?? '',
            audioRecord: i.audioRecord,
            transcription: i.transcription,
            sentiment: {
              positive: parseFloat(sentiment?.Positive?.toFixed(2) ?? 0), 
              neutral: parseFloat(sentiment?.Neutral?.toFixed(2) ?? 0),
              negative: parseFloat(sentiment?.Negative?.toFixed(2)?? 0)
            },
            status: statusMap2[i.status],
          };
        });
        data = dataProcess;
        updateTable(dataProcess);
      } catch (error) {
        console.error('Error:', error);
      }
    })();

    async function fetchAndProcessCustomers(url) {
        const customerNames = await fetch(url);
        const customerResult = await customerNames.json();
        const cusFilter = customerResult.filter((customer) => customer.name !== '' && customer.phone !== '' && customer.phone !== "11111111111");
        const customerMap = cusFilter.reduce((map, customer) => {
          map.set(customer.phone, customer.name);
          return map;
        }, new Map());

        return customerMap;
      }
      const formatDate = (startTime) => {
      const date = new Date(startTime);
      const year = date.getUTCFullYear();
      const month = date.getUTCMonth() + 1;
      const day = date.getUTCDate();
      const hours = date.getUTCHours();
      const minutes = date.getUTCMinutes();
      const formattedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')} ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} UTC`;
      if(year === 1970) {
        return '';
      }
      return formattedDate;
    }



    const statusFilter = document.getElementById('status-filter');
    const search = document.getElementById('search');
    statusFilter.addEventListener('change', () => {
      const status = statusFilter.value.toLowerCase();
      const filteredData = data.filter(row => status === 'all' || row.status.toLowerCase() === status);
      updateTable(filteredData);
    });

    search.addEventListener('input', () => {
        const keyword = search.value.toLowerCase();
        let filteredData;

        if (keyword === "#") {
          filteredData = data.filter(row => row.callerName === '');
        } else {
          filteredData = data.filter(row => {
            return row.callerNumber.toLowerCase().includes(keyword) ||
              row.callerName.toLowerCase().includes(keyword) || 
              row.calleeName.toLowerCase().includes(keyword) ||
              row.callerId.toLowerCase().includes(keyword) ;
          });
        }
        updateTable(filteredData);
      });

      document.getElementById('overlay').addEventListener('click', function () {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none'; 
    });

        function AddTxt()  {
            const txtLink = document.querySelectorAll('.txtLink');
            txtLink.forEach((link) => {
              link.addEventListener('click', function (e) {
                e.preventDefault();
                const data = this.getAttribute('data-content');
                document.getElementById('popupContent').innerText = data == 'null' ? '' : data;
                document.getElementById('popup').style.display = 'block';
                document.getElementById('overlay').style.display = 'block'; 
               
              });
            });
          }
    
          function BorderRadius() {
              const sentiments = document.getElementsByClassName('sentiment-bar');
              Array.from(sentiments).forEach((sentiment) => {
                var children = sentiment.children;
                const filteredChildren = Array.from(children).filter((child) => {
                  const style = window.getComputedStyle(child);
                  const iValue = style.getPropertyValue('--i').trim();
                  return iValue !== '0';
                });

                if (filteredChildren.length > 0) {
                  filteredChildren[0].style.borderTopLeftRadius = '4px';
                  filteredChildren[0].style.borderBottomLeftRadius = '4px';

                  const lastIndex = filteredChildren.length - 1;
                  filteredChildren[lastIndex].style.borderTopRightRadius = '4px';
                  filteredChildren[lastIndex].style.borderBottomRightRadius = '4px';
                }
              });
            }
    function AudioRecord()
    {
      const audioElements = document.getElementsByClassName('myAudio');
        Array.from(audioElements).forEach((audioElement) => {
          audioElement.addEventListener('play', function () {
            this.style.width = '350%';
            this.style.transform = 'translateX(-40%)';
          });

          const resizeToOriginal = () => {
            audioElement.style.width = '100%';
            audioElement.style.transform = 'none';
          };

          audioElement.addEventListener('pause', resizeToOriginal);
          audioElement.addEventListener('ended', resizeToOriginal);
        });
    }   

    function updateTable(filteredData) {
      const createSpan = (sentimentValue) => {
          if (sentimentValue == 0) {
            return '';
          } else {
            return `<span>${(sentimentValue * 100).toFixed(2)}%</span>`;
          }
        }
      table.innerHTML = ''; // Xóa dữ liệu hiện tại trên bảng
      filteredData.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td>${row.callerNumber}</td>
              <td>${row.callerName}</td>
              <td>${row.calleeName}</td>
              <td>${row.startTime}</td>
              <td>${row.endTime}</td>
              <td>${row.duration}</td>
              <td>
              <audio controls class="myAudio">
                <source src="${row.audioRecord}" type="audio/wav">
              </audio>
              </td>

              <td>
                <a href="#" class="txtLink" data-content="${row.transcription}">Open File</a>
              </td>
              <td>
                  <div class="sentiment-bar">
                    <div style="--i:${row.sentiment.positive}" class="positive">
                      ${createSpan(row.sentiment.positive)}
                    </div>
                    <div  style="--i:${row.sentiment.neutral}"class="neutral">
                      ${createSpan(row.sentiment.neutral)}
                    </div>
                    <div style="--i:${row.sentiment.negative}" class="negative">
                      ${createSpan(row.sentiment.negative)}
                      </div>
                  </div>
              </td>
              <td class="${statusMap[row.status]}">${row.status}</td>
              <td class="truncate" title="${row.callerId}">${row.callerId}</td>
          `;
          table.appendChild(tr);
      });
    BorderRadius();
    AddTxt();
    AudioRecord();
}


</script>
</body>
</html>