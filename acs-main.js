/*! For license information please see acs-main.js.LICENSE.txt */
(()=>{var e={961:function(e,t,i){!function(e,t,n){"use strict";var r,s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{};function a(e,t,i){return e(i={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&i.path)}},i.exports),i.exports}!function(e){!function(t){var i="object"==typeof s?s:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),n=r(e);function r(e,t){return function(i,n){"function"!=typeof e[i]&&Object.defineProperty(e,i,{configurable:!0,writable:!0,value:n}),t&&t(i,n)}}void 0===i.Reflect?i.Reflect=e:n=r(i.Reflect,n),function(e){var t=Object.prototype.hasOwnProperty,i="function"==typeof Symbol,n=i&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",r=i&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",s="function"==typeof Object.create,a={__proto__:[]}instanceof Array,o=!s&&!a,c={create:s?function(){return ne(Object.create(null))}:a?function(){return ne({__proto__:null})}:function(){return ne({})},has:o?function(e,i){return t.call(e,i)}:function(e,t){return t in e},get:o?function(e,i){return t.call(e,i)?e[i]:void 0}:function(e,t){return e[t]}},l=Object.getPrototypeOf(Function),d="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,h=d||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?ee():Map,u=d||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?te():Set,g=new(d||"function"!=typeof WeakMap?ie():WeakMap);function p(e,t,i,n){if(L(i)){if(!j(e))throw new TypeError;if(!W(t))throw new TypeError;return I(e,t)}if(!j(e))throw new TypeError;if(!F(t))throw new TypeError;if(!F(n)&&!L(n)&&!x(n))throw new TypeError;return x(n)&&(n=void 0),b(e,t,i=G(i),n)}function m(e,t){function i(i,n){if(!F(i))throw new TypeError;if(!L(n)&&!z(n))throw new TypeError;D(e,t,i,n)}return i}function f(e,t,i,n){if(!F(i))throw new TypeError;return L(n)||(n=G(n)),D(e,t,i,n)}function S(e,t,i){if(!F(t))throw new TypeError;return L(i)||(i=G(i)),R(e,t,i)}function v(e,t,i){if(!F(t))throw new TypeError;return L(i)||(i=G(i)),w(e,t,i)}function y(e,t,i){if(!F(t))throw new TypeError;return L(i)||(i=G(i)),P(e,t,i)}function C(e,t,i){if(!F(t))throw new TypeError;return L(i)||(i=G(i)),M(e,t,i)}function _(e,t){if(!F(e))throw new TypeError;return L(t)||(t=G(t)),O(e,t)}function E(e,t){if(!F(e))throw new TypeError;return L(t)||(t=G(t)),k(e,t)}function T(e,t,i){if(!F(t))throw new TypeError;L(i)||(i=G(i));var n=A(t,i,!1);if(L(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var r=g.get(t);return r.delete(i),r.size>0||g.delete(t),!0}function I(e,t){for(var i=e.length-1;i>=0;--i){var n=(0,e[i])(t);if(!L(n)&&!x(n)){if(!W(n))throw new TypeError;t=n}}return t}function b(e,t,i,n){for(var r=e.length-1;r>=0;--r){var s=(0,e[r])(t,i,n);if(!L(s)&&!x(s)){if(!F(s))throw new TypeError;n=s}}return n}function A(e,t,i){var n=g.get(e);if(L(n)){if(!i)return;n=new h,g.set(e,n)}var r=n.get(t);if(L(r)){if(!i)return;r=new h,n.set(t,r)}return r}function R(e,t,i){if(w(e,t,i))return!0;var n=Z(t);return!x(n)&&R(e,n,i)}function w(e,t,i){var n=A(t,i,!1);return!L(n)&&H(n.has(e))}function P(e,t,i){if(w(e,t,i))return M(e,t,i);var n=Z(t);return x(n)?void 0:P(e,n,i)}function M(e,t,i){var n=A(t,i,!1);if(!L(n))return n.get(e)}function D(e,t,i,n){A(i,n,!0).set(e,t)}function O(e,t){var i=k(e,t),n=Z(e);if(null===n)return i;var r=O(n,t);if(r.length<=0)return i;if(i.length<=0)return r;for(var s=new u,a=[],o=0,c=i;o<c.length;o++){var l=c[o];s.has(l)||(s.add(l),a.push(l))}for(var d=0,h=r;d<h.length;d++)l=h[d],s.has(l)||(s.add(l),a.push(l));return a}function k(e,t){var i=[],n=A(e,t,!1);if(L(n))return i;for(var r=K(n.keys()),s=0;;){var a=Q(r);if(!a)return i.length=s,i;var o=Y(a);try{i[s]=o}catch(e){try{X(r)}finally{throw e}}s++}}function N(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function L(e){return void 0===e}function x(e){return null===e}function U(e){return"symbol"==typeof e}function F(e){return"object"==typeof e?null!==e:"function"==typeof e}function V(e,t){switch(N(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var i=3===t?"string":5===t?"number":"default",r=J(e,n);if(void 0!==r){var s=r.call(e,i);if(F(s))throw new TypeError;return s}return B(e,"default"===i?"number":i)}function B(e,t){if("string"===t){var i=e.toString;if(q(i)&&!F(r=i.call(e)))return r;if(q(n=e.valueOf)&&!F(r=n.call(e)))return r}else{var n;if(q(n=e.valueOf)&&!F(r=n.call(e)))return r;var r,s=e.toString;if(q(s)&&!F(r=s.call(e)))return r}throw new TypeError}function H(e){return!!e}function $(e){return""+e}function G(e){var t=V(e,3);return U(t)?t:$(t)}function j(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function q(e){return"function"==typeof e}function W(e){return"function"==typeof e}function z(e){switch(N(e)){case 3:case 4:return!0;default:return!1}}function J(e,t){var i=e[t];if(null!=i){if(!q(i))throw new TypeError;return i}}function K(e){var t=J(e,r);if(!q(t))throw new TypeError;var i=t.call(e);if(!F(i))throw new TypeError;return i}function Y(e){return e.value}function Q(e){var t=e.next();return!t.done&&t}function X(e){var t=e.return;t&&t.call(e)}function Z(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===l)return t;if(t!==l)return t;var i=e.prototype,n=i&&Object.getPrototypeOf(i);if(null==n||n===Object.prototype)return t;var r=n.constructor;return"function"!=typeof r||r===e?t:r}function ee(){var e={},t=[],i=function(){function e(e,t,i){this._index=0,this._keys=e,this._values=t,this._selector=i}return e.prototype["@@iterator"]=function(){return this},e.prototype[r]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var i=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var i=this._find(e,!0);return this._values[i]=t,this},t.prototype.delete=function(t){var i=this._find(t,!1);if(i>=0){for(var n=this._keys.length,r=i+1;r<n;r++)this._keys[r-1]=this._keys[r],this._values[r-1]=this._values[r];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new i(this._keys,this._values,n)},t.prototype.values=function(){return new i(this._keys,this._values,s)},t.prototype.entries=function(){return new i(this._keys,this._values,a)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[r]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function n(e,t){return e}function s(e,t){return t}function a(e,t){return[e,t]}}function te(){return function(){function e(){this._map=new h}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[r]=function(){return this.keys()},e}()}function ie(){var e=16,i=c.create(),n=r();return function(){function e(){this._key=r()}return e.prototype.has=function(e){var t=s(e,!1);return void 0!==t&&c.has(t,this._key)},e.prototype.get=function(e){var t=s(e,!1);return void 0!==t?c.get(t,this._key):void 0},e.prototype.set=function(e,t){return s(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=s(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=r()},e}();function r(){var e;do{e="@@WeakMap@@"+l()}while(c.has(i,e));return i[e]=!0,e}function s(e,i){if(!t.call(e,n)){if(!i)return;Object.defineProperty(e,n,{value:c.create()})}return e[n]}function a(e,t){for(var i=0;i<t;++i)e[i]=255*Math.random()|0;return e}function o(e){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):a(new Uint8Array(e),e):a(new Array(e),e)}function l(){var t=o(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var i="",n=0;n<e;++n){var r=t[n];4!==n&&6!==n&&8!==n||(i+="-"),r<16&&(i+="0"),i+=r.toString(16).toLowerCase()}return i}}function ne(e){return e.__=void 0,delete e.__,e}e("decorate",p),e("metadata",m),e("defineMetadata",f),e("hasMetadata",S),e("hasOwnMetadata",v),e("getMetadata",y),e("getOwnMetadata",C),e("getMetadataKeys",_),e("getOwnMetadataKeys",E),e("deleteMetadata",T)}(n)}()}(r||(r={}));var o=a((function(e,t){function i(e,t){var i=0;return e.replace(/%[dixs%]/g,(function(e){var n=0;if("%"!==e[n++])return"";var r=e[n++];return"%"===r?"%":"s"===r||"d"===r||"i"===r?t[i++]:"x"===r?t[i++].toString(16):e}))}Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Trace=10]="Trace",e[e.Debug6=16]="Debug6",e[e.Debug5=18]="Debug5",e[e.Debug4=20]="Debug4",e[e.Debug3=30]="Debug3",e[e.Debug2=40]="Debug2",e[e.Debug1=50]="Debug1",e[e.Warning=60]="Warning",e[e.Error=70]="Error",e[e.Fatal=80]="Fatal",e[e.MetaData=90]="MetaData"}(t.LogLevel||(t.LogLevel={})),function(e){e[e.UseDefault=0]="UseDefault",e[e.Compress=1]="Compress",e[e.Disabled=2]="Disabled"}(t.LogFileCompression||(t.LogFileCompression={})),function(e){e[e.Raw=0]="Raw",e[e.Base64=1]="Base64"}(t.LogFileEncoding||(t.LogFileEncoding={})),function(e){e[e.Unencrypted=0]="Unencrypted",e[e.Encrypted=1]="Encrypted"}(t.LogFileEncryption||(t.LogFileEncryption={})),function(e){e[e.PEM=0]="PEM",e[e.DER=1]="DER",e[e.BER=2]="BER"}(t.CertStoreFormat||(t.CertStoreFormat={})),function(e){e[e.InsertFront=8]="InsertFront"}(t.AppenderFlags||(t.AppenderFlags={})),t.vsprintf=i,t.sprintf=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return i(e,t)}})),c=a((function(e,t){var i,n,r=s&&s.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});function a(e){if(null===e)return-1;for(var t=0,i=e.length-1;i>=0;i--)t=37*t+e.charCodeAt(i)|0;var n="__auf_literal:";for(i=13;i>=0;i--)t=37*t+n.charCodeAt(i)|0;return t}Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Unsafe=0]="Unsafe",e[e.Safe=1]="Safe",e[e.Inherited_Unsafe=2]="Inherited_Unsafe",e[e.Inherited_Safe=3]="Inherited_Safe",e[e.Blacklisted_Unsafe=4]="Blacklisted_Unsafe"}(n||(n={}));var c,l=function(){function e(e,t){this._level=o.LogLevel.Debug4,this._threshold=255,this._safe=n.Inherited_Unsafe,this._name=e,t&&(this._level=t.level(),this._safe=t.safe()?n.Inherited_Safe:n.Inherited_Unsafe,this._extendedInfo=t.extendedInfo())}return e.prototype.name=function(){return this._name},e.prototype.safe=function(){return this._safe===n.Safe||this._safe===n.Inherited_Safe},e.prototype.safety=function(){return this._safe},e.prototype.setSafety=function(e){this._safe=e},e.prototype.description=function(){return this._desc},e.prototype.setDescription=function(e){this._desc=e},e.prototype.level=function(){return this._level},e.prototype.setLevel=function(e){c.setLevel(this,e)},e.prototype._setLevel=function(e){this._level=e},e.prototype._setThreshold=function(e){this._threshold=e},e.prototype.isEnabled=function(e){return this._threshold<=e},e.prototype.setExtendedInfo=function(e){this._extendedInfo=e},e.prototype.extendedInfo=function(){return this._extendedInfo},e.prototype.trace=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Trace,a(e),e].concat(t))},e.prototype.debug6=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug6,a(e),e].concat(t))},e.prototype.debug5=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug5,a(e),e].concat(t))},e.prototype.debug4=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug4,a(e),e].concat(t))},e.prototype.debug3=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug3,a(e),e].concat(t))},e.prototype.debug2=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug2,a(e),e].concat(t))},e.prototype.debug1=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Debug1,a(e),e].concat(t))},e.prototype.warn=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Warning,a(e),e].concat(t))},e.prototype.error=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Error,a(e),e].concat(t))},e.prototype.fatal=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.Fatal,a(e),e].concat(t))},e.prototype.meta=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.log.apply(c,[this,o.LogLevel.MetaData,a(e),e].concat(t))},e}(),d=function(){function e(){}return e.instance=function(){return c},e.levelToString=function(e){return e<=o.LogLevel.Trace?"TRACE":e<=o.LogLevel.Debug6?"DEBUG6":e<=o.LogLevel.Debug5?"DEBUG5":e<=o.LogLevel.Debug4?"DEBUG4":e<=o.LogLevel.Debug3?"DEBUG3":e<=o.LogLevel.Debug2?"DEBUG2":e<=o.LogLevel.Debug1?"DEBUG1":e<=o.LogLevel.Warning?"WARN":e<=o.LogLevel.Error?"ERROR":e<=o.LogLevel.Fatal?"FATAL":(o.LogLevel.MetaData,"META")},e.levelFromString=function(e){return this._levelFromString[e]||parseInt(e,10)},e}();function h(e,t){for(var i=t.name();i.length>0;){if(e[i])return e[i];var n=i.lastIndexOf(".");i=n<0?"":i.substr(0,n)}return e[""]?e[""]:o.LogLevel.Debug4}function u(e,t){var i=255;return t.forEach((function(t){var n=255;t.appender.levels()?n=Math.min(n,h(t.appender.levels(),e)):t.appender.receiveAll()||(n=Math.min(n,e.level())),i=Math.min(i,n)})),i}d._levelFromString={TRACE:o.LogLevel.Trace,DEBUG6:o.LogLevel.Debug6,DEBUG5:o.LogLevel.Debug5,DEBUG4:o.LogLevel.Debug4,DEBUG3:o.LogLevel.Debug3,DEBUG2:o.LogLevel.Debug2,DEBUG1:o.LogLevel.Debug1,WARN:o.LogLevel.Warning,ERROR:o.LogLevel.Error,FATAL:o.LogLevel.Fatal,META:o.LogLevel.MetaData},t.LogFactory=d;var g=function(e){function t(){var t=e.call(this)||this;return t._nextId=0,t._appenders=[],t._components={},t._componentBlacklist=[],t._components[""]=new l("",null),t}return r(t,e),t.prototype.toHex=function(e){return(4294967296+e).toString(16).substr(-8)},t.prototype.addAppender=function(e,t){void 0===t&&(t=0);var i=this._nextId++;return t&o.AppenderFlags.InsertFront?this._appenders.unshift({appender:e,handle:i}):this._appenders.push({appender:e,handle:i}),this.recalcComponentThresholds(),i},t.prototype.removeAppender=function(e){for(var t=0;t<this._appenders.length;t++)if(this._appenders[t].handle===e){this._appenders.splice(t,1);break}this.recalcComponentThresholds()},t.prototype.log=function(e,t,i,n){for(var r=[],s=4;s<arguments.length;s++)r[s-4]=arguments[s];try{if(e.isEnabled(t)){var a={timestamp:(new Date).getTime(),component:e,level:t};this._appenders.forEach((function(s){(function(e,t,i){return!!e.appender.receiveAll()||(e.appender.levels()?i>=h(e.appender.levels(),t):i>=t.level())})(s,e,t)&&s.appender.log(a,i,n,r)}))}}catch(e){}},t.prototype.parent=function(e){for(;;){var t=e.lastIndexOf(".");if(e=t>=0?e.substr(0,t):"",this._components[e])return this._components[e]}},t.prototype.children=function(e){var t=[];for(var i in this._components)this.parent(i).name()===e&&t.push(this._components[i]);return t},t.prototype.component=function(e){if(this._components[e])return this._components[e];var t=new l(e,this.parent(e));this._components[e]=t;var i=u(t,this._appenders);return t._setThreshold(i),t},t.prototype.rootComponent=function(){return this.component("")},t.prototype.setSafetyRecursive=function(e,t){var i=this;this.children(e).forEach((function(e){e.safety()!==n.Inherited_Safe&&e.safety()!==n.Inherited_Unsafe||(e.setSafety(t),i.setSafetyRecursive(e.name(),t))}))},t.prototype.declareComponentSafe=function(e,t){var i=this.component(e);-1!==this._componentBlacklist.indexOf(i.name())?i.setSafety(n.Blacklisted_Unsafe):i.setSafety(t?n.Safe:n.Unsafe),this.setSafetyRecursive(e,t?n.Inherited_Safe:n.Inherited_Unsafe)},t.prototype.declareComponentDescription=function(e,t){this.component(e).setDescription(t)},t.prototype.setExtendedInfoRecursive=function(e,t){var i=this;this.children(e).forEach((function(e){void 0===e.extendedInfo()&&(e.setExtendedInfo(t),i.setExtendedInfoRecursive(e.name(),t))}))},t.prototype.declareComponentExtendedInfo=function(e,t){var i=this.component(e);i.setExtendedInfo(t),this.setExtendedInfoRecursive(i.name(),t)},t.prototype.recalcComponentThresholds=function(){for(var e in this._components){var t=this._components[e],i=u(t,this._appenders);t._setThreshold(i)}},t.prototype.setLevel=function(e,t){if(""===e.name())for(var i in this._components){(s=this._components[i])._setLevel(t);var n=u(s,this._appenders);s._setThreshold(n)}else{var r=e.name()+".";for(var i in e._setLevel(t),n=u(e,this._appenders),e._setThreshold(n),this._components){var s;if((s=this._components[i]).name().substr(0,r.length)===r){s._setLevel(t);var a=u(s,this._appenders);s._setThreshold(a)}}}},t.prototype.setComponentBlacklist=function(e){for(var t in this._componentBlacklist=e,this._components){var i=this._components[t];-1!==this._componentBlacklist.indexOf(i.name())&&i.setSafety(n.Blacklisted_Unsafe)}},t}(d);c=new g})),l=a((function(e,t){function i(e){return null!=e&&"function"==typeof e.then}function n(e){return null!=e&&"function"==typeof e.cancel}function r(e,i){if(!t.config.catchExceptions)return e();try{return e()}catch(e){return i(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(e){throw e}},t.fromThenable=function(e){var t=d();return e.then((function(e){t.resolve(e)}),(function(e){t.reject(e)})),t.promise().thenAsync((function(e){return e}))};var s,a=[],o="undefined"!=typeof setImmediate;function c(e){a.push(e),1===a.length&&(o?setImmediate(l):setTimeout(l,0))}function l(){var e=a;a=[];for(var t=0;t<e.length;t++)e[t]()}function d(){return new s.SyncTask}function h(e){return(new s.SyncTask).resolve(e).promise()}function u(e){var t=d(),r=!1;return t.onCancel((function(t){e.forEach((function(e){n(e)&&s.SyncTask.cancelOtherInternal(e,t)}))})),e.forEach((function(e){i(e)?e.then((function(e){r||(r=!0,t.resolve(e))}),(function(e){r||(r=!0,t.reject(e))})):r||(r=!0,t.resolve(e))})),t.promise()}t.asyncCallback=c,function(e){var s=function(){function e(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return e.prototype._addCallbackSet=function(t,i){var n=this,r=new e;return r.onCancel((function(e){t.wasCanceled=!0,t.cancelContext=e,n._cancelInternal(e)})),t.task=r,this._storedCallbackSets.push(t),i?this._mustHandleError=!1:r._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),r.promise()},e.prototype.onCancel=function(e){return this._completedSuccess||this._completedFail||(this._wasCanceled?e(this._cancelContext):this._cancelCallbacks.push(e)),this},e.prototype.then=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t},!0)},e.prototype.thenAsync=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t,asyncCallback:!0},!0)},e.prototype.catch=function(e){return this._addCallbackSet({failFunc:e},!0)},e.prototype.always=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!0)},e.prototype.setTracingEnabled=function(e){return this._traceEnabled=e,this},e.prototype.finally=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!1),this},e.prototype.done=function(e){return this._addCallbackSet({successFunc:e},!1),this},e.prototype.fail=function(e){return this._addCallbackSet({failFunc:e},!1),this},e.prototype.resolve=function(e){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=e,this._cancelCallbacks=[],this._resolveSuccesses(),this},e.prototype.reject=function(t){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=t,this._cancelCallbacks=[],this._resolveFailures(),e._enforceErrorHandled(this),this},e.prototype._checkState=function(e){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var i="Failed to "+(e?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(i)}(t.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},e._enforceErrorHandled=function(i){i._mustHandleError&&(e._rejectedTasks.push(i),e._enforceErrorHandledTimer||(e._enforceErrorHandledTimer=setTimeout((function(){e._enforceErrorHandledTimer=void 0;var i=e._rejectedTasks;e._rejectedTasks=[],i.forEach((function(e,i){e._mustHandleError&&t.config.unhandledErrorHandler(e._storedErrResolution)}))}),0)))},e.prototype.cancel=function(e){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(e)},e.prototype._cancelInternal=function(e){var t=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=e;var i=this._cancelCallbacks;this._cancelCallbacks=[],i.length>0&&i.forEach((function(e){t._completedSuccess||t._completedFail||e(t._cancelContext)}))}},e.cancelOtherInternal=function(e,t){var i=e;i._storedCallbackSets&&i._cancelInternal?i._cancelInternal(t):e.cancel(t)},e.prototype.promise=function(){return this},e.prototype._resolveSuccesses=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?c((function(){return e._resolveSuccessCallback(t)})):e._resolveSuccessCallback(t)}))}this._resolving=!1},e.prototype._resolveSuccessCallback=function(t){var s=this;t.successFunc?r((function(){var r=t.successFunc(s._storedResolution);n(r)&&(t.wasCanceled?e.cancelOtherInternal(r,t.cancelContext):t.task.onCancel((function(t){return e.cancelOtherInternal(r,t)}))),i(r)?r.then((function(e){t.task.resolve(e)}),(function(e){t.task.reject(e)})):t.task.resolve(r)}),(function(e){s._handleException(e,"SyncTask caught exception in success block: "+e.toString()),t.task.reject(e)})):t.task.resolve(this._storedResolution)},e.prototype._resolveFailures=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?c((function(){return e._resolveFailureCallback(t)})):e._resolveFailureCallback(t)}))}this._resolving=!1},e.prototype._resolveFailureCallback=function(t){var s=this;t.failFunc?r((function(){var r=t.failFunc(s._storedErrResolution);n(r)&&(t.wasCanceled?e.cancelOtherInternal(r,t.cancelContext):t.task.onCancel((function(t){return e.cancelOtherInternal(r,t)}))),i(r)?r.then((function(e){t.task.resolve(e)}),(function(e){t.task.reject(e)})):t.task.resolve(r)}),(function(e){s._handleException(e,"SyncTask caught exception in failure block: "+e.toString()),t.task.reject(e)})):t.task.reject(this._storedErrResolution)},e.prototype._handleException=function(e,i){t.config.exceptionsToConsole&&console.error(i),t.config.exceptionHandler&&t.config.exceptionHandler(e)},e.prototype.toEs6Promise=function(){var e=this;return new Promise((function(t,i){return e.then(t,i)}))},e._rejectedTasks=[],e}();e.SyncTask=s}(s||(s={})),t.all=function(e){if(0===e.length)return h([]);var t,r=d(),a=e.length,o=Array(e.length);r.onCancel((function(t){e.forEach((function(e){n(e)&&s.SyncTask.cancelOtherInternal(e,t)}))}));var c=function(){0==--a&&(void 0!==t?r.reject(t):r.resolve(o))};return e.forEach((function(e,n){i(e)?e.then((function(e){o[n]=e,c()}),(function(e){void 0===t&&(t=void 0===e||e),c()})):(o[n]=e,c())})),r.promise()},t.Defer=d,t.Resolved=h,t.Rejected=function(e){return(new s.SyncTask).reject(e).promise()},t.race=u,t.raceTimer=function(e,t){var i=d(),n=setTimeout((function(){i.resolve({timedOut:!0})}),t);return u([e.then((function(e){return clearTimeout(n),{timedOut:!1,result:e}})),i.promise()])}})),d=a((function(e,t){var i,n=s&&s.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var r,a=function(){function e(e){this._formatter=e||new h}return e.prototype.formatter=function(){return this._formatter},e.prototype.receiveAll=function(){return!1},e.prototype.levels=function(){return null},e}();function l(e){return(4294967296+e).toString(16).substr(-8)}function d(e,t){return(1e12+e).toString(10).substr(-t)}t.AbstractLogAppender=a,function(e){e[e.Timestamp=1]="Timestamp",e[e.Component=4]="Component",e[e.Level=8]="Level",e[e.FullDate=32]="FullDate",e[e.LogId=64]="LogId"}(r=t.SLF_Flags||(t.SLF_Flags={}));var h=function(){function e(e){void 0===e&&(e=4294967295),this._flags=e}return e.prototype.format=function(e,t,i,n){var s="";if(this._flags&r.FullDate)s+=new Date(e.timestamp).toISOString()+" ";else if(this._flags&r.Timestamp){var a=new Date(e.timestamp);s+=d(a.getHours(),2)+":"+d(a.getMinutes(),2)+":"+d(a.getSeconds(),2)+"."+d(a.getMilliseconds(),2)+" "}return this._flags&r.LogId&&(s+="[#"+l(t)+"-"+(e.component.safe()?"S":"u")+"] "),this._flags&r.Level&&(s+="["+c.LogFactory.levelToString(e.level)+"] "),this._flags&r.Component&&(s+="["+e.component.name()+"] "),i||""===i?s+o.vsprintf(i,n):s+l(t)+": "+n.join(" ")},e}();t.StandardLogFormatter=h;var u=console,g=console.log||function(){},p=console.info||g,m=console.warn||p,f=console.error||m,S=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.log=function(e,t,i,n){n=n.slice(0);var r=e.level<=o.LogLevel.Debug3?g:e.level<=o.LogLevel.Debug1?p:e.level<=o.LogLevel.Warning?m:f;if(-1===t){var s=this.formatter().format(e,t,"",[]);"string"==typeof n[0]&&(s+=n.shift()),r.apply(u,[s].concat(n))}else{for(var a=void 0,c=[];a=i.match(/\s*%@\s*$/);)i=i.substr(0,i.length-a[0].length),c.unshift(n.pop());s=this.formatter().format(e,t,i,n),r.apply(u,[s].concat(c))}},t}(a);t.ConsoleAppender=S;var v=function(){function e(e){this._chained=e}return e.prototype.log=function(e,t,i,n){this._chained.log(e,t,i,n)},e.prototype.receiveAll=function(){return this._chained.receiveAll()},e.prototype.levels=function(){return this._chained.levels()},e}();t.ChainedLogAppender=v;var y=function(e){function t(t,i){var n=e.call(this,t)||this;return n._levels=i,n}return n(t,e),t.prototype.levels=function(){return this._levels},t}(v);t.wrapAppenderWithLogLevels=function(e,t){return new y(e,t)}})),h=a((function(e,t){var i,n=s&&s.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var r=c.LogFactory.instance().component("RootToolsManager");c.LogFactory.instance().declareComponentSafe("RootToolsManager",!0);var a;!function(e){e[e.InternalBuild=0]="InternalBuild",e[e.PublicBuild=1]="PublicBuild"}(a=t.BuildType||(t.BuildType={}));var h=a.InternalBuild;function u(e){return(4294967296+e).toString(16).substr(-8)}function g(e,t){var i=[];for(var n in e)i.push(t(n,e[n]));return i}function p(e,t,i){if(null==e)return null==t||0===t.length;if(null==t)return null==e||0===e.length;if(e.length===t.length){for(var n=0;n<e.length;n++)if(!i(e[n],t[n]))return!1;return!0}return!1}function m(e,t){return null==e?null==t:null==t?null==e:e.arg===t.arg&&e.op===t.op&&e.value===t.value}function f(e,t){return null==e?null==t||0===t.logId:null==t?null==e||0===e.logId:e.logId===t.logId&&e.name===t.name&&p(e.matchers,t.matchers,m)}function S(e,t){return null==e?null==t:null==t?null==e:e.component===t.component&&e.parsedLevel===t.level}function v(e,t){return null==e?null==t:null==t?null==e:e.component===t.component&&e.level===t.level}function y(e){for(var t=[],i=0;i<e.length;i++)"string"==typeof e[i]||"number"==typeof e[i]?t.push(e[i]):t.push(JSON.stringify(e[i]));return t}t.setBuildType=function(e){var t=h;return h=e,t};var C=function(e){function t(t,i,n){var r=e.call(this)||this;return r._unmetConditions=[],r._rtMan=t,r._triggerCallback=i,r._ecsConfig=n,r.resetConditions(),r}return n(t,e),t.prototype.config=function(){return this._ecsConfig},t.prototype.configEquals=function(e){return this._ecsConfig.includeUnsafe===e.includeUnsafe&&this._ecsConfig.mutualSubmissionType===e.mutualSubmissionType&&this._ecsConfig.name===e.name&&this._ecsConfig.reenableAfterTriggering===e.reenableAfterTriggering&&this._ecsConfig.experimentTarget===e.experimentTarget&&f(this._ecsConfig.resetCondition,e.resetCondition)&&p(this._ecsConfig.conditions,e.conditions,f)&&p(this._ecsConfig.filters,e.filters,v)},t.prototype.nativeConfigEquals=function(e){return this._ecsConfig.includeUnsafe===e.includeUnsafe&&this._ecsConfig.name===e.name&&this._ecsConfig.reenableAfterTriggering===e.reenableAfterTriggering&&f(this._ecsConfig.resetCondition,e.resetCondition)&&p(this._ecsConfig.conditions,e.conditions,f)&&p(this._ecsConfig.filters,e.filters,S)},t.prototype.needReset=function(e){return!this.configEquals(e)},t.prototype.resetConditions=function(){this._unmetConditions=[];for(var e=0;e<this._ecsConfig.conditions.length;e++)this._unmetConditions.push(e)},t.prototype.matcherMatches=function(e,t){if(e.arg>=t.length)return!1;var i=t[e.arg],n="string"==typeof i?e.value:parseInt(e.value,10);return"="===e.op||"=="===e.op?i===n:"!="===e.op?i!==n:"<"===e.op?i<n:"<="===e.op?i<=n:">"===e.op?i>n:">="===e.op?i>=n:"CONTAINS"===e.op.toUpperCase()&&(""+i).indexOf(e.value)>=0},t.prototype.conditionMatches=function(e,t,i){if(t!==e.logId)return!1;if(e.matchers)for(var n=0;n<e.matchers.length;n++)if(!this.matcherMatches(e.matchers[n],i))return!1;return!0},t.prototype.log=function(e,t,i,n){if(0!==this._unmetConditions.length&&e.component!==r){var s=this._ecsConfig;s.resetCondition&&this.conditionMatches(s.resetCondition,t,n)&&(r.debug4("LogTrigger %s: resetCondition met",s.name),this.resetConditions());for(var a=0;a<this._unmetConditions.length;a++){var o=this._unmetConditions[a];if(this.conditionMatches(s.conditions[o],t,n)){r.debug4("LogTrigger %s: condition %s met",s.name,s.conditions[o].name),this._unmetConditions.splice(a,1);break}}0===this._unmetConditions.length&&(r.debug1("LogTrigger %s has triggered, trying to send the log",s.name),this._triggerCallback.call(this._rtMan,s),s.reenableAfterTriggering&&this.resetConditions())}},t.prototype.receiveAll=function(){return!0},t}(d.AbstractLogAppender),_=function(e){function t(t,i,n){var r=e.call(this)||this;return r._circularBuffer=[],r._circularBufferMaxSize=0,r._onBufferOverflow=null,r._circularBuffer=[],r._circularBufferMaxSize=i,r._includeUnsafe=t,r._onBufferOverflow=n||function(){return r._circularBuffer.shift()},r}return n(t,e),t.prototype.log=function(e,t,i,n){if((this._includeUnsafe||e.component.safe())&&!(this._circularBuffer.length>this._circularBufferMaxSize)){var r={md:e,logId:t,messages:y(n)};this._circularBuffer.push(r),this._circularBuffer.length>this._circularBufferMaxSize&&this._onBufferOverflow()}},t.prototype.visitReverseOrder=function(e){for(var t=this._circularBuffer.length-1;t>=0;t--){var i=this._circularBuffer[t];if(!e(i.md,i.logId,i.messages))return}},t.prototype.visitForwardOrder=function(e){for(var t=0;t<this._circularBuffer.length;t++){var i=this._circularBuffer[t];if(!e(i.md,i.logId,i.messages))return}},t.prototype.needReset=function(e,t){return e!==this._includeUnsafe||t!==this._circularBufferMaxSize},t.prototype.dumpLogBuffer=function(e,t,i){var n=this,r=new E(e.reverse),s=e.filter.map((function(e){return{component:"root"===e.component?"":e.component,parsedLevel:e.level}})),a=i||{matchedLines:0,totalLines:0};return(e.reverse?this.visitReverseOrder:this.visitForwardOrder).apply(this,[function(e,i,o){return a.totalLines++,n.filterMatches(e,i,o,s)&&(a.matchedLines++,r.log(e.component,e.timestamp,e.level,i,o)),!t||r._data.length<t}]),r.close(),r.data()},t.prototype.filterMatches=function(e,t,i,n){for(var r=0;r<n.length;r++)if((""===n[r].component||e.component.name()===n[r].component||e.component.name().substr(0,n[r].component.length)===n[r].component&&"."===e.component.name().charAt(n[r].component.length))&&e.level>=n[r].parsedLevel)return!0;return!1},t.prototype.clear=function(){this._circularBuffer=[]},t.prototype.size=function(){return this._circularBuffer.length},t.prototype.empty=function(){return 0===this.size()},t.prototype.capacity=function(){return this._circularBufferMaxSize},t}(d.AbstractLogAppender);t.CircularBuffer=_;var E=function(){function e(e){this._reverse=e,this._first=!0,this._pending=[],this._components={},this._componentCount=0,this._lastts=0,this._base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this._data="ULOG2"+String.fromCharCode(33)+String.fromCharCode(32),this._data+=e?String.fromCharCode(34):String.fromCharCode(32),this._data+=String.fromCharCode(32)}return e.prototype._add8=function(e){if(this._pending.push(255&e),3===this._pending.length){var t=(this._pending[0]<<16)+(this._pending[1]<<8)+(0|this._pending[2]),i=this._base64chars[t>>18&63]+this._base64chars[t>>12&63]+this._base64chars[t>>6&63]+this._base64chars[63&t];this._data+=i,this._pending=[]}},e.prototype._add16=function(e){this._add8(e>>8&255),this._add8(255&e)},e.prototype._add32=function(e){this._add8(e>>24&255),this._add8(e>>16&255),this._add8(e>>8&255),this._add8(255&e)},e.prototype._add64=function(e){this._add32(e/4294967296|0),this._add32(0|e)},e.prototype._addS=function(e){for(var t=0;t<e.length;t++)this._add8(e.charCodeAt(t));this._add8(0)},e.prototype._close=function(){for(;this._pending.length;)this._add8(0)},e.prototype.log=function(e,t,i,n,r){var s=this._components[e.name()];s||(s=++this._componentCount,this._components[e.name()]=s,this._add8(2),this._add16(s),this._addS(e.name()),this._addS(""),this._addS(""),this._add8(e.safe()?1:0));var a=128;this._first&&(a|=2);var o=t-this._lastts;this._lastts=t,o>-128&&o<128&&(a|=1),this._add8(a),1&a?this._add8(o):this._add64(1e3*t),this._first&&(this._add32(1),this._add8(0),this._add16(0)),this._add16(s),this._add8(i),this._add32(n),this._add8(r.length);for(var c=0;c<r.length;c++)this._add8(8),this._addS(""+r[c]);this._first=!1},e.prototype.close=function(){this._add8(7),this._close()},e.prototype.data=function(){return this._data},e.prototype.empty=function(){return this._first},e}(),T=function(e){function t(t,i,n,r){var s=e.call(this)||this;return s._capacity=t,s._onBufferOverflow=i,s._enableThrottling=n,s._maxVerbosityLevel=r,s._outputFormatter=new E(!1),s._linesStored=0,s._throttling=!1,s._linesThrottled=0,s}return n(t,e),t.prototype.log=function(e,t,i,n){this._maxVerbosityLevel&&e.level<this._maxVerbosityLevel||(this._throttling?this._linesThrottled++:(this._linesStored++,this._outputFormatter.log(e.component,e.timestamp,e.level,t,y(n))),this._linesStored>this._capacity&&(this._enableThrottling?this._throttling||(this._throttling=!0):this._onBufferOverflow()))},t.prototype.dumpAndReset=function(){if(this._outputFormatter.empty())return"";this._linesThrottled>0&&this._outputFormatter.log(r,(new Date).getTime(),o.LogLevel.Fatal,-1,["RooToolsManager: Log buffer overflow! "+this._linesThrottled+" lines thrown away"]),this._outputFormatter.close();var e=this._outputFormatter.data();return this.clearBuffer(),e},t.prototype.empty=function(){return this._outputFormatter.empty()},t.prototype.clearBuffer=function(){this._outputFormatter=new E(!1),this._linesStored=0,this._linesThrottled=0,this._throttling=!1},t.prototype.capacity=function(){return this._capacity},t.prototype.throttlingEnabled=function(){return this._enableThrottling},t.prototype.size=function(){return this._linesStored},t.prototype.maxVerbosityLevel=function(){return this._maxVerbosityLevel},t}(d.AbstractLogAppender);function I(e){return"Native"===e||"JavaScript"===e||"Mixed"===e}t.DumperBuffer=T;var b=function(){function e(){this._maxUploadSize=0,this._jsToNativeBuffer=null,this._jsToNativeBufferHandle=null,this._jsToNativeFlushTimer=null,this._jsToNativeFlushInterval=0,this._triggers={},this._defaultBuffers=[{size:2097152,level:o.LogLevel.Debug4}],this._defaultKillswitch={blacklist:[],whitelist:[]},this._defaultBlacklists={component:[],logline:[]},this._localLogLevels={},this._defaultExperimentTarget="Mixed",this._BRBCallback=null}return e.prototype.setDelegate=function(e){this._glue=e,this.registerListeners()},e.prototype.isDelegateSet=function(){return null!=this._glue},e.prototype.setNativeFunctions=function(e){this._native&&this._native.log_config.removeLogTriggerListener(this),this._native=e,this._native&&this._native.log_config.addLogTriggerListener(this)},e.prototype.applyLogLevels=function(){var e={};for(var t in this._localLogLevels)e[t]=this._localLogLevels[t];e[""]=e.root||o.LogLevel.Debug4,delete e.root;var i=g(e,(function(e,t){return{component:e,level:t}}));i.sort((function(e,t){return e.component.length-t.component.length})),i.forEach((function(e){return c.LogFactory.instance().component(e.component).setLevel(e.level)})),this._native&&this._native.log_config.setLogLevelConfig(i)},e.prototype.setLocalLogLevelConfig=function(e){this._localLogLevels=e,this.applyLogLevels()},e.prototype.parseMatcher=function(e){return null==e||null==e.arg||null==e.op||null==e.value?null:{arg:e.arg,op:e.op,value:e.value}},e.prototype.parseCondition=function(e){if(null==e||null==e.logId)return null;if(e.matchers&&!(e.matchers instanceof Array))return null;var t={name:e.name||u(e.logId),logId:e.logId,matchers:[]};if(e.matchers&&e.matchers.length)for(var i=0,n=e.matchers;i<n.length;i++){var r=n[i],s=this.parseMatcher(r);s&&t.matchers.push(s)}return t},e.prototype.parseFilter=function(e){return null==e||null==e.component||0===e.component.length?null:{component:e.component,level:e.level,parsedLevel:c.LogFactory.levelFromString(e.level)}},e.prototype.parseConfig=function(e,t,i){if(null==e)return null;if(!(e.conditions instanceof Array)||0==e.conditions.length)return null;if(!(e.filters instanceof Array)||0==e.filters.length)return null;if(e.resetCondition&&!this.parseCondition(e.resetCondition))return null;for(var n={name:e.name||t+"->"+i,ecsNs:t,reenableAfterTriggering:e.reenableAfterTriggering||!1,mutualSubmissionType:e.mutualSubmissionType||"",includeUnsafe:h!==a.PublicBuild&&(e.includeUnsafe||!1),experimentTarget:I(e.experimentTarget)&&e.experimentTarget||this._defaultExperimentTarget,conditions:[],resetCondition:null==e.resetCondition?e.resetCondition:this.parseCondition(e.resetCondition),filters:[]},r=0,s=e.conditions;r<s.length;r++){var o=s[r],c=this.parseCondition(o);c&&n.conditions.push(c)}for(var l=0,d=e.filters;l<d.length;l++){var u=d[l],g=this.parseFilter(u);g&&n.filters.push(g)}return 0===n.conditions.length?null:n},e.prototype.isExperimentListed=function(e,t,i,n){return!!e&&(!(!n||!e.some((function(e){return"*"===e.namespace})))||e.some((function(e){return e.namespace===t&&(e.experiment===i||"*"==e.experiment)})))},e.prototype.isExperimentAllowed=function(e,t,i){return!this.isExperimentListed(e.blacklist,t,i,!0)||this.isExperimentListed(e.whitelist,t,i,!1)},e.prototype.findTrigger=function(e,t){for(var i in e)if(e[i].configEquals(t))return i;return null},e.prototype.findTriggerByNativeConfig=function(e,t){for(var i in e)if(e[i].nativeConfigEquals(t))return i;return null},e.prototype.OnEcsChange=function(){var e=this;function t(e,i,n){return i<e.length?n(e[i]).then((function(){return t(e,i+1,n)})):l.Resolved()}return null==this._glue?l.Resolved():this._glue.fetchEcsConfig("SkypeRootTools","ULBaseline").then((function(i){r.debug4("Reloading ULBaseline config - new config: %@",i),i||(r.warn("No ULBaseline config"),i={}),e._maxUploadSize=i.logUpload&&i.logUpload.maxSize||1024;var n=[],s=e._triggers;e._triggers={};var a=(i.logUpload&&i.logUpload.maxSize||1024)/100,l=i.circularBuffer&&i.circularBuffer.enabled,h=i.circularBuffer&&i.circularBuffer.buffers||e._defaultBuffers,u=i.circularBuffer&&i.circularBuffer.storeUnsafe;e._defaultExperimentTarget=I(i.defaultExperimentTarget)&&i.defaultExperimentTarget||"Mixed";var p=i.killswitch||e._defaultKillswitch,m=i.blacklists||e._defaultBlacklists;m.component.length>0&&c.LogFactory.instance().setComponentBlacklist(m.component);var f={};(i.componentLevels||[]).forEach((function(e){return f[e.component]=e.level})),t(i.configPaths||[],0,(function(t){return e._glue.fetchEcsConfig(t.ns,t.key).then((function(i){var a=i instanceof Array?i:[i];r.debug4("Reloading ECS config for %s->%s - new config: %@",t.ns,t.key,a);for(var o=0,c=a;o<c.length;o++){var d=c[o];if(null!=d){var h=e.parseConfig(d,t.ns,t.key);if(null!=h)if("JavaScript"===h.experimentTarget||"Mixed"===h.experimentTarget)if(r.debug2("Parsed ECS config for %s->%s - %@",t.ns,t.key,h),e.isExperimentAllowed(p,t.ns,h.name)){r.debug2("Allowing %s->%s:%s according to killswitch",t.ns,t.key,h.name),l=!0;var g=e.findTrigger(s,h);null!=g?(r.debug2("Triggers updated, keeping trigger %s",h.name),e._triggers[g]=s[g],delete s[g]):n.push(h),h.filters&&h.filters.forEach((function(e){return f[e.component]=Math.min(f[e.component]||255,e.parsedLevel)})),h.includeUnsafe&&(u=!0)}else r.debug2("Disallowing %s->%s according to killswitch",t.ns,t.key);else r.debug4("Skipping %s->%s, targeted for %s",t.ns,t.key,h);else r.error("Failed to parse ECS config for %s->%s",t.ns,t.key)}}}))})).always((function(){for(var t in e.applyLogLevels(),s)r.debug2("Triggers updated, removing trigger %s",s[t].config().name),c.LogFactory.instance().removeAppender(+t);if(n.forEach((function(t){r.debug2("Triggers updated, adding trigger %s",t.name);var i=new C(e,e._triggered,t),n=c.LogFactory.instance().addAppender(i);e._triggers[String(n)]=i})),f[""]=f.root||o.LogLevel.Debug4,delete f.root,!e._circularBuffer||l&&!e._circularBuffer.needReset(u,a)?e._circularBuffer&&(Object.keys(s).length>0||n.length>0?(r.debug2("Buffer updated, reapplying log levels, removing log levels wrapper"),c.LogFactory.instance().removeAppender(e._circularBufferHandle),e._circularBufferHandle=null):r.debug2("Buffer updated, no change")):(r.debug2("Buffer updated, removing existing buffer"),c.LogFactory.instance().removeAppender(e._circularBufferHandle),e._circularBuffer=null,e._circularBufferHandle=null),l&&(e._circularBuffer||(r.debug2("Buffer updated, adding new buffer (storeUnsafe=%d,maxSize=%s)",u,a),e._circularBuffer=new _(u,a)),null==e._circularBufferHandle&&(r.debug2("Creating log level wrapper"),e._circularBufferHandle=c.LogFactory.instance().addAppender(d.wrapAppenderWithLogLevels(e._circularBuffer,f),o.AppenderFlags.InsertFront))),e._native){var i=g(f,(function(e,t){return{component:e,level:t}}));i.sort((function(e,t){return e.component.length-t.component.length})),e._native.log_config.setLogBufferConfig(l,{storeUnsafe:u,buffers:h},i);var p=[];for(var m in e._triggers){var S=e._triggers[m].config();p.push({name:S.name,ecsNs:S.ecsNs,conditions:S.conditions,resetCondition:S.resetCondition,includeUnsafe:S.includeUnsafe,reenableAfterTriggering:S.reenableAfterTriggering,filters:S.filters.map((function(e){return{component:e.component,level:e.parsedLevel}})),dumpFile:!1,metadata:{}})}e._native.log_config.setLogTriggerConfig(p,{})}}))}))},e.prototype._send=function(e,t){null!=this._glue&&(this._glue.sendTelemetry("638b8ba2bae14e07aa5d73ddb5d5e5c5-297b8412-5df3-4a83-83c4-7b76c6c5d3f0-7104",{logTriggerName:e.name,logEcsNs:e.ecsNs,logdata:t}),r.debug4("LogSender::send, sent %d bytes",t.length))},e.prototype.triggered=function(e,t){},e.prototype.triggeredPartially=function(e,t,i,n,r){var s=this.findTriggerByNativeConfig(this._triggers,e);if(s){var a={level:t.level,component:c.LogFactory.instance().component(t.component),timestamp:t.timestamp};this._triggers[s].log(a,i,n,r)}},e.prototype.reset=function(e){var t=this.findTriggerByNativeConfig(this._triggers,e);t&&this._triggers[t].resetConditions()},e.prototype.dumpLogBuffer=function(e,t){if(this._circularBuffer){var i={matchedLines:0,totalLines:0},n=this._circularBuffer.dumpLogBuffer(e,this._maxUploadSize,i);if(r.debug4("dumpLogBuffer: dumped %d of %d lines, size of payload: %d",i.matchedLines,i.totalLines,null!=n?n.length:0),this._native){var s=l.Defer();return this._native.log_config.mergeAndDumpLogBuffer(n,e,t,(function(e){return s.resolve(e)})),s.promise()}return l.Resolved(n)}return r.warn("dumpLogBuffer: no log buffer enabled"),l.Rejected()},e.prototype._triggered=function(e){var t=this,i={compression:o.LogFileCompression.Compress,encoding:o.LogFileEncoding.Base64,encryption:o.LogFileEncryption.Encrypted,maxRotations:0,maxSize:this._maxUploadSize,reverse:!0},n={includeUnsafe:e.includeUnsafe,filter:e.filters.map((function(e){return{component:e.component,level:e.parsedLevel}})),reverse:!0};this.dumpLogBuffer(n,i).then((function(i){return t._send(e,i)}))},e.prototype.sendBRBEvent=function(e,t){try{if(r.debug2("sendBRBEvent %s",JSON.stringify(e)),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var i={eventType:"uploadBRB",mutualSubmissionType:"call",payload:e},n=void 0!==t?JSON.stringify({userIds:t}):"";this._glue.sendLoggingEventToNative(JSON.stringify(i),n)}}catch(e){r.error("sendBRBEvent %s: %s",e.name,e.message)}},e.prototype.setBRBCallback=function(e){r.debug2("setBRBCallback"),null!=this._glue?"function"==typeof this._glue.setNativeLoggingEventCallback?this._BRBCallback=e:r.warn("setBRBCallback: RootToolsManagerDelegate missing setNativeLoggingEventCallback method"):r.warn("setBRBCallback: RootToolsManagerDelegate is not set")},e.prototype.registerListeners=function(){var e=this;null!=this._glue&&"function"==typeof this._glue.setNativeLoggingEventCallback?this._glue.setNativeLoggingEventCallback((function(t,i){return e.handleNativeLoggingEvent(t,i)})):r.warn("registerListeners: RootToolsManagerDelegate missing setNativeLoggingEventCallback method")},e.prototype.handleNativeLoggingEvent=function(e,t){try{r.debug2("Native Log event message: %s aux: %s",e,t);var i=JSON.parse(e);if(i.eventType&&"uploadBRB"===i.eventType){if("function"!=typeof this._BRBCallback)return void r.warn("BRBCallback not set, ignoring native event");r.debug4("Sending BRB callback: %@",i.payload),this._BRBCallback(i.payload)}else i.eventType&&"jsLogFileConfiguration"===i.eventType&&this.handleLogFileConfigEvent(i)}catch(e){r.error("handleNativeLoggingEvent %s: %s",e.name,e.message)}},e.prototype.handleLogFileConfigEvent=function(e){if(e.payload){var t=e.payload;if(t.enabled){if(t.chunkSize&&t.flushInterval){var i={chunkSize:t.chunkSize,flushInterval:t.flushInterval,enableThrottling:t.enableThrottling,maxVerbosityLevel:t.maxVerbosityLevel};this.startJsToNativeLogging(i)}}else this.flushDisableJsToNativeLogging()}},e.prototype.logExternalForDDL=function(e,t){try{if(r.debug2("logExternalForDDL %s %s",e,t),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var i={eventType:"logInSClog",payload:{message:e,parameters:t}};this._glue.sendLoggingEventToNative(JSON.stringify(i),"")}else r.warn("ignoring logExternalForDDL, delegate misconfigured")}catch(e){r.error("logExternalForDDL %s: %s",e.name,e.message)}},e.prototype.startJsToNativeLogging=function(e){var t=this,i=e.chunkSize,n=e.flushInterval,s=e.enableThrottling,a=this._getVerbosityLevelFromConfig(e.maxVerbosityLevel);if(this._jsToNativeBuffer){if(this._jsToNativeBuffer.capacity()===i&&this._jsToNativeFlushInterval===n&&this._jsToNativeBuffer.throttlingEnabled()===s&&this._jsToNativeBuffer.maxVerbosityLevel()===a)return void r.debug1("Same JS2Native settings received - doing nothing");r.debug1("Reapplying js to native settings"),this.flushDisableJsToNativeLogging()}this._jsToNativeBuffer=new T(i,(function(){t.onJsToNativeBufferReady(t._jsToNativeBuffer)}),s,a),this.setJsToNativeFlushTimeout(n),this._jsToNativeFlushInterval=n,this._jsToNativeBufferHandle=c.LogFactory.instance().addAppender(this._jsToNativeBuffer)},e.prototype._getVerbosityLevelFromConfig=function(e){return e?c.LogFactory.levelFromString(e):null},e.prototype.flushDisableJsToNativeLogging=function(){this._jsToNativeBuffer&&this.onJsToNativeBufferReady(this._jsToNativeBuffer),this.plainDisableJsToNativeLogging()},e.prototype.plainDisableJsToNativeLogging=function(){this.clearJsToNativeFlushTimeout(),this._jsToNativeBufferHandle&&(c.LogFactory.instance().removeAppender(this._jsToNativeBufferHandle),this._jsToNativeBufferHandle=0,this._jsToNativeBuffer=null,r.debug1("Disabling forwarding JS logs to native"))},e.prototype.onJsToNativeBufferReady=function(e){null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative?(this.clearJsToNativeFlushTimeout(),this.dumpJsToNativeBuffer(e),this.setJsToNativeFlushTimeout(this._jsToNativeFlushInterval)):this.plainDisableJsToNativeLogging()},e.prototype.dumpJsToNativeBuffer=function(e){if(!e.empty()){var t=e.dumpAndReset();this._glue.sendLoggingEventToNative(JSON.stringify({eventType:"writeLogData"}),t)}},e.prototype.clearJsToNativeFlushTimeout=function(){this._jsToNativeFlushTimer&&(clearTimeout(this._jsToNativeFlushTimer),this._jsToNativeFlushTimer=null)},e.prototype.setJsToNativeFlushTimeout=function(e){var t=this;!this._jsToNativeFlushTimer&&e&&(this._jsToNativeFlushTimer=setTimeout((function(){t._jsToNativeFlushTimer=null,t.onJsToNativeBufferReady(t._jsToNativeBuffer)}),e))},e.prototype.stopAsyncOperations=function(){this.flushDisableJsToNativeLogging()},e}();t.RootToolsManager=new b})),u=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){return e},n=!0,r=i,s={},a=0;var o,c=/^([0-9][0-9]?):([^<>\*\{\}&'\"\/\\?^`|~\s]+)$/;!function(e){e[e.MSA=1]="MSA",e[e.S4B_Bridge=2]="S4B_Bridge",e[e.PSTN=4]="PSTN",e[e.SkypeId=8]="SkypeId",e[e.Thread=19]="Thread",e[e.LegacyShortCircuit=20]="LegacyShortCircuit",e[e.OneToOneTextMessage=21]="OneToOneTextMessage",e[e.GroupTextMessage=22]="GroupTextMessage",e[e.Bot=28]="Bot",e[e.InternalSkype=48]="InternalSkype"}(o||(o={}));var l=[o.Thread,o.InternalSkype,o.Bot];t.enableAnonymization=function(e){n=e},t.useTagger=function(e){r=e||i},function(e){function t(e){return n?e?s[e]||function(e){return s[e]="u"+ ++a}(e):null:e}e.UserName=function(e){var i=t(e);return r(i)},e.Mri=function(e){var i,n=e.match(c);if(n){var s=Number(n[1]),a=n[2];i=-1!=l.indexOf(s)?e:s+":"+t(a)}else i=t(e);return r(i)},e.Omit=function(e){var t;return t=n?"number"==typeof e?19229:"string"==typeof e?e.charAt(0)+"...":null:e,r(t)}}(t.pii||(t.pii={}))})),g=a((function(e,t){function i(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),i(o),i(c),i(h),i(d),i(u)})),p=a((function(e,t){(function(){var i,n="Expected a function",r="__lodash_hash_undefined__",a="__lodash_placeholder__",o=16,c=32,l=64,d=128,h=256,u=1/0,g=9007199254740991,p=NaN,m=4294967295,f=m-1,S=m>>>1,v=[["ary",d],["bind",1],["bindKey",2],["curry",8],["curryRight",o],["flip",512],["partial",c],["partialRight",l],["rearg",h]],y="[object Arguments]",C="[object Array]",_="[object Boolean]",E="[object Date]",T="[object Error]",I="[object Function]",b="[object GeneratorFunction]",A="[object Map]",R="[object Number]",w="[object Object]",P="[object Promise]",M="[object RegExp]",D="[object Set]",O="[object String]",k="[object Symbol]",N="[object WeakMap]",L="[object ArrayBuffer]",x="[object DataView]",U="[object Float32Array]",F="[object Float64Array]",V="[object Int8Array]",B="[object Int16Array]",H="[object Int32Array]",$="[object Uint8Array]",G="[object Uint8ClampedArray]",j="[object Uint16Array]",q="[object Uint32Array]",W=/\b__p \+= '';/g,z=/\b(__p \+=) '' \+/g,J=/(__e\(.*?\)|\b__t\)) \+\n'';/g,K=/&(?:amp|lt|gt|quot|#39);/g,Y=/[&<>"']/g,Q=RegExp(K.source),X=RegExp(Y.source),Z=/<%-([\s\S]+?)%>/g,ee=/<%([\s\S]+?)%>/g,te=/<%=([\s\S]+?)%>/g,ie=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ne=/^\w*$/,re=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,se=/[\\^$.*+?()[\]{}|]/g,ae=RegExp(se.source),oe=/^\s+/,ce=/\s/,le=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,de=/\{\n\/\* \[wrapped with (.+)\] \*/,he=/,? & /,ue=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,ge=/[()=,{}\[\]\/\s]/,pe=/\\(\\)?/g,me=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,fe=/\w*$/,Se=/^[-+]0x[0-9a-f]+$/i,ve=/^0b[01]+$/i,ye=/^\[object .+?Constructor\]$/,Ce=/^0o[0-7]+$/i,_e=/^(?:0|[1-9]\d*)$/,Ee=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Te=/($^)/,Ie=/['\n\r\u2028\u2029\\]/g,be="\\ud800-\\udfff",Ae="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Re="\\u2700-\\u27bf",we="a-z\\xdf-\\xf6\\xf8-\\xff",Pe="A-Z\\xc0-\\xd6\\xd8-\\xde",Me="\\ufe0e\\ufe0f",De="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Oe="[']",ke="["+be+"]",Ne="["+De+"]",Le="["+Ae+"]",xe="\\d+",Ue="["+Re+"]",Fe="["+we+"]",Ve="[^"+be+De+xe+Re+we+Pe+"]",Be="\\ud83c[\\udffb-\\udfff]",He="[^"+be+"]",$e="(?:\\ud83c[\\udde6-\\uddff]){2}",Ge="[\\ud800-\\udbff][\\udc00-\\udfff]",je="["+Pe+"]",qe="\\u200d",We="(?:"+Fe+"|"+Ve+")",ze="(?:"+je+"|"+Ve+")",Je="(?:['](?:d|ll|m|re|s|t|ve))?",Ke="(?:['](?:D|LL|M|RE|S|T|VE))?",Ye="(?:"+Le+"|"+Be+")?",Qe="["+Me+"]?",Xe=Qe+Ye+"(?:"+qe+"(?:"+[He,$e,Ge].join("|")+")"+Qe+Ye+")*",Ze="(?:"+[Ue,$e,Ge].join("|")+")"+Xe,et="(?:"+[He+Le+"?",Le,$e,Ge,ke].join("|")+")",tt=RegExp(Oe,"g"),it=RegExp(Le,"g"),nt=RegExp(Be+"(?="+Be+")|"+et+Xe,"g"),rt=RegExp([je+"?"+Fe+"+"+Je+"(?="+[Ne,je,"$"].join("|")+")",ze+"+"+Ke+"(?="+[Ne,je+We,"$"].join("|")+")",je+"?"+We+"+"+Je,je+"+"+Ke,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",xe,Ze].join("|"),"g"),st=RegExp("["+qe+be+Ae+Me+"]"),at=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,ot=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],ct=-1,lt={};lt[U]=lt[F]=lt[V]=lt[B]=lt[H]=lt[$]=lt[G]=lt[j]=lt[q]=!0,lt[y]=lt[C]=lt[L]=lt[_]=lt[x]=lt[E]=lt[T]=lt[I]=lt[A]=lt[R]=lt[w]=lt[M]=lt[D]=lt[O]=lt[N]=!1;var dt={};dt[y]=dt[C]=dt[L]=dt[x]=dt[_]=dt[E]=dt[U]=dt[F]=dt[V]=dt[B]=dt[H]=dt[A]=dt[R]=dt[w]=dt[M]=dt[D]=dt[O]=dt[k]=dt[$]=dt[G]=dt[j]=dt[q]=!0,dt[T]=dt[I]=dt[N]=!1;var ht={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},ut=parseFloat,gt=parseInt,pt="object"==typeof s&&s&&s.Object===Object&&s,mt="object"==typeof self&&self&&self.Object===Object&&self,ft=pt||mt||Function("return this")(),St=t&&!t.nodeType&&t,vt=St&&e&&!e.nodeType&&e,yt=vt&&vt.exports===St,Ct=yt&&pt.process,_t=function(){try{return vt&&vt.require&&vt.require("util").types||Ct&&Ct.binding&&Ct.binding("util")}catch(e){}}(),Et=_t&&_t.isArrayBuffer,Tt=_t&&_t.isDate,It=_t&&_t.isMap,bt=_t&&_t.isRegExp,At=_t&&_t.isSet,Rt=_t&&_t.isTypedArray;function wt(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}function Pt(e,t,i,n){for(var r=-1,s=null==e?0:e.length;++r<s;){var a=e[r];t(n,a,i(a),e)}return n}function Mt(e,t){for(var i=-1,n=null==e?0:e.length;++i<n&&!1!==t(e[i],i,e););return e}function Dt(e,t){for(var i=null==e?0:e.length;i--&&!1!==t(e[i],i,e););return e}function Ot(e,t){for(var i=-1,n=null==e?0:e.length;++i<n;)if(!t(e[i],i,e))return!1;return!0}function kt(e,t){for(var i=-1,n=null==e?0:e.length,r=0,s=[];++i<n;){var a=e[i];t(a,i,e)&&(s[r++]=a)}return s}function Nt(e,t){return!(null==e||!e.length)&&qt(e,t,0)>-1}function Lt(e,t,i){for(var n=-1,r=null==e?0:e.length;++n<r;)if(i(t,e[n]))return!0;return!1}function xt(e,t){for(var i=-1,n=null==e?0:e.length,r=Array(n);++i<n;)r[i]=t(e[i],i,e);return r}function Ut(e,t){for(var i=-1,n=t.length,r=e.length;++i<n;)e[r+i]=t[i];return e}function Ft(e,t,i,n){var r=-1,s=null==e?0:e.length;for(n&&s&&(i=e[++r]);++r<s;)i=t(i,e[r],r,e);return i}function Vt(e,t,i,n){var r=null==e?0:e.length;for(n&&r&&(i=e[--r]);r--;)i=t(i,e[r],r,e);return i}function Bt(e,t){for(var i=-1,n=null==e?0:e.length;++i<n;)if(t(e[i],i,e))return!0;return!1}var Ht=Kt("length");function $t(e){return e.match(ue)||[]}function Gt(e,t,i){var n;return i(e,(function(e,i,r){if(t(e,i,r))return n=i,!1})),n}function jt(e,t,i,n){for(var r=e.length,s=i+(n?1:-1);n?s--:++s<r;)if(t(e[s],s,e))return s;return-1}function qt(e,t,i){return t==t?function(e,t,i){for(var n=i-1,r=e.length;++n<r;)if(e[n]===t)return n;return-1}(e,t,i):jt(e,zt,i)}function Wt(e,t,i,n){for(var r=i-1,s=e.length;++r<s;)if(n(e[r],t))return r;return-1}function zt(e){return e!=e}function Jt(e,t){var i=null==e?0:e.length;return i?Xt(e,t)/i:p}function Kt(e){return function(t){return null==t?i:t[e]}}function Yt(e){return function(t){return null==e?i:e[t]}}function Qt(e,t,i,n,r){return r(e,(function(e,r,s){i=n?(n=!1,e):t(i,e,r,s)})),i}function Xt(e,t){for(var n,r=-1,s=e.length;++r<s;){var a=t(e[r]);a!==i&&(n=n===i?a:n+a)}return n}function Zt(e,t){for(var i=-1,n=Array(e);++i<e;)n[i]=t(i);return n}function ei(e){return e?e.slice(0,Si(e)+1).replace(oe,""):e}function ti(e){return function(t){return e(t)}}function ii(e,t){return xt(t,(function(t){return e[t]}))}function ni(e,t){return e.has(t)}function ri(e,t){for(var i=-1,n=e.length;++i<n&&qt(t,e[i],0)>-1;);return i}function si(e,t){for(var i=e.length;i--&&qt(t,e[i],0)>-1;);return i}var ai=Yt({:"A",:"A",:"A",:"A",:"A",:"A",:"a",:"a",:"a",:"a",:"a",:"a",:"C",:"c",:"D",:"d",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"N",:"n",:"O",:"O",:"O",:"O",:"O",:"O",:"o",:"o",:"o",:"o",:"o",:"o",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"Y",:"y",:"y",:"Ae",:"ae",:"Th",:"th",:"ss",:"A",:"A",:"A",:"a",:"a",:"a",:"C",:"C",:"C",:"C",:"c",:"c",:"c",:"c",:"D",:"D",:"d",:"d",:"E",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"e",:"G",:"G",:"G",:"G",:"g",:"g",:"g",:"g",:"H",:"H",:"h",:"h",:"I",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"i",:"J",:"j",:"K",:"k",:"k",:"L",:"L",:"L",:"L",:"L",:"l",:"l",:"l",:"l",:"l",:"N",:"N",:"N",:"N",:"n",:"n",:"n",:"n",:"O",:"O",:"O",:"o",:"o",:"o",:"R",:"R",:"R",:"r",:"r",:"r",:"S",:"S",:"S",:"S",:"s",:"s",:"s",:"s",:"T",:"T",:"T",:"t",:"t",:"t",:"U",:"U",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"u",:"u",:"W",:"w",:"Y",:"y",:"Y",:"Z",:"Z",:"Z",:"z",:"z",:"z",:"IJ",:"ij",:"Oe",:"oe",:"'n",:"s"}),oi=Yt({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function ci(e){return"\\"+ht[e]}function li(e){return st.test(e)}function di(e){return at.test(e)}function hi(e){var t=-1,i=Array(e.size);return e.forEach((function(e,n){i[++t]=[n,e]})),i}function ui(e,t){return function(i){return e(t(i))}}function gi(e,t){for(var i=-1,n=e.length,r=0,s=[];++i<n;){var o=e[i];o!==t&&o!==a||(e[i]=a,s[r++]=i)}return s}function pi(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e})),i}function mi(e){return li(e)?function(e){for(var t=nt.lastIndex=0;nt.test(e);)++t;return t}(e):Ht(e)}function fi(e){return li(e)?function(e){return e.match(nt)||[]}(e):function(e){return e.split("")}(e)}function Si(e){for(var t=e.length;t--&&ce.test(e.charAt(t)););return t}var vi=Yt({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});function yi(e){return e.match(rt)||[]}var Ci=function e(t){var s,ce=(t=null==t?ft:Ci.defaults(ft.Object(),t,Ci.pick(ft,ot))).Array,ue=t.Date,be=t.Error,Ae=t.Function,Re=t.Math,we=t.Object,Pe=t.RegExp,Me=t.String,De=t.TypeError,Oe=ce.prototype,ke=Ae.prototype,Ne=we.prototype,Le=t["__core-js_shared__"],xe=ke.toString,Ue=Ne.hasOwnProperty,Fe=0,Ve=(s=/[^.]+$/.exec(Le&&Le.keys&&Le.keys.IE_PROTO||""))?"Symbol(src)_1."+s:"",Be=Ne.toString,He=xe.call(we),$e=ft._,Ge=Pe("^"+xe.call(Ue).replace(se,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),je=yt?t.Buffer:i,qe=t.Symbol,We=t.Uint8Array,ze=je?je.allocUnsafe:i,Je=ui(we.getPrototypeOf,we),Ke=we.create,Ye=Ne.propertyIsEnumerable,Qe=Oe.splice,Xe=qe?qe.isConcatSpreadable:i,Ze=qe?qe.iterator:i,et=qe?qe.toStringTag:i,nt=function(){try{var e=ys(we,"defineProperty");return e({},"",{}),e}catch(e){}}(),rt=t.clearTimeout!==ft.clearTimeout&&t.clearTimeout,st=ue&&ue.now!==ft.Date.now&&ue.now,at=t.setTimeout!==ft.setTimeout&&t.setTimeout,ht=Re.ceil,pt=Re.floor,mt=we.getOwnPropertySymbols,St=je?je.isBuffer:i,vt=t.isFinite,Ct=Oe.join,_t=ui(we.keys,we),Ht=Re.max,Yt=Re.min,_i=ue.now,Ei=t.parseInt,Ti=Re.random,Ii=Oe.reverse,bi=ys(t,"DataView"),Ai=ys(t,"Map"),Ri=ys(t,"Promise"),wi=ys(t,"Set"),Pi=ys(t,"WeakMap"),Mi=ys(we,"create"),Di=Pi&&new Pi,Oi={},ki=zs(bi),Ni=zs(Ai),Li=zs(Ri),xi=zs(wi),Ui=zs(Pi),Fi=qe?qe.prototype:i,Vi=Fi?Fi.valueOf:i,Bi=Fi?Fi.toString:i;function Hi(e){if(ho(e)&&!Za(e)&&!(e instanceof qi)){if(e instanceof ji)return e;if(Ue.call(e,"__wrapped__"))return Js(e)}return new ji(e)}var $i=function(){function e(){}return function(t){if(!lo(t))return{};if(Ke)return Ke(t);e.prototype=t;var n=new e;return e.prototype=i,n}}();function Gi(){}function ji(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=i}function qi(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=m,this.__views__=[]}function Wi(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function zi(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function Ji(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function Ki(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new Ji;++t<i;)this.add(e[t])}function Yi(e){var t=this.__data__=new zi(e);this.size=t.size}function Qi(e,t){var i=Za(e),n=!i&&Xa(e),r=!i&&!n&&no(e),s=!i&&!n&&!r&&yo(e),a=i||n||r||s,o=a?Zt(e.length,Me):[],c=o.length;for(var l in e)!t&&!Ue.call(e,l)||a&&("length"==l||r&&("offset"==l||"parent"==l)||s&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||As(l,c))||o.push(l);return o}function Xi(e){var t=e.length;return t?e[Qn(0,t-1)]:i}function Zi(e,t){return js(kr(e),ln(t,0,e.length))}function en(e){return js(kr(e))}function tn(e,t,n){(n!==i&&!Ka(e[t],n)||n===i&&!(t in e))&&on(e,t,n)}function nn(e,t,n){var r=e[t];Ue.call(e,t)&&Ka(r,n)&&(n!==i||t in e)||on(e,t,n)}function rn(e,t){for(var i=e.length;i--;)if(Ka(e[i][0],t))return i;return-1}function sn(e,t,i,n){return pn(e,(function(e,r,s){t(n,e,i(e),s)})),n}function an(e,t){return e&&Nr(t,Ho(t),e)}function on(e,t,i){"__proto__"==t&&nt?nt(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}function cn(e,t){for(var n=-1,r=t.length,s=ce(r),a=null==e;++n<r;)s[n]=a?i:xo(e,t[n]);return s}function ln(e,t,n){return e==e&&(n!==i&&(e=e<=n?e:n),t!==i&&(e=e>=t?e:t)),e}function dn(e,t,n,r,s,a){var o,c=1&t,l=2&t,d=4&t;if(n&&(o=s?n(e,r,s,a):n(e)),o!==i)return o;if(!lo(e))return e;var h=Za(e);if(h){if(o=function(e){var t=e.length,i=new e.constructor(t);return t&&"string"==typeof e[0]&&Ue.call(e,"index")&&(i.index=e.index,i.input=e.input),i}(e),!c)return kr(e,o)}else{var u=Es(e),g=u==I||u==b;if(no(e))return Rr(e,c);if(u==w||u==y||g&&!s){if(o=l||g?{}:Is(e),!c)return l?function(e,t){return Nr(e,_s(e),t)}(e,function(e,t){return e&&Nr(t,$o(t),e)}(o,e)):function(e,t){return Nr(e,Cs(e),t)}(e,an(o,e))}else{if(!dt[u])return s?e:{};o=function(e,t,i){var n=e.constructor;switch(t){case L:return wr(e);case _:case E:return new n(+e);case x:return function(e,t){var i=t?wr(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}(e,i);case U:case F:case V:case B:case H:case $:case G:case j:case q:return Pr(e,i);case A:return new n;case R:case O:return new n(e);case M:return function(e){var t=new e.constructor(e.source,fe.exec(e));return t.lastIndex=e.lastIndex,t}(e);case D:return new n;case k:return function(e){return Vi?we(Vi.call(e)):{}}(e)}}(e,u,c)}}a||(a=new Yi);var p=a.get(e);if(p)return p;a.set(e,o),fo(e)?e.forEach((function(i){o.add(dn(i,t,n,i,e,a))})):uo(e)&&e.forEach((function(i,r){o.set(r,dn(i,t,n,r,e,a))}));var m=h?i:(d?l?us:hs:l?$o:Ho)(e);return Mt(m||e,(function(i,r){m&&(i=e[r=i]),nn(o,r,dn(i,t,n,r,e,a))})),o}function hn(e,t,n){var r=n.length;if(null==e)return!r;for(e=we(e);r--;){var s=n[r],a=t[s],o=e[s];if(o===i&&!(s in e)||!a(o))return!1}return!0}function un(e,t,r){if("function"!=typeof e)throw new De(n);return Bs((function(){e.apply(i,r)}),t)}function gn(e,t,i,n){var r=-1,s=Nt,a=!0,o=e.length,c=[],l=t.length;if(!o)return c;i&&(t=xt(t,ti(i))),n?(s=Lt,a=!1):t.length>=200&&(s=ni,a=!1,t=new Ki(t));e:for(;++r<o;){var d=e[r],h=null==i?d:i(d);if(d=n||0!==d?d:0,a&&h==h){for(var u=l;u--;)if(t[u]===h)continue e;c.push(d)}else s(t,h,n)||c.push(d)}return c}Hi.templateSettings={escape:Z,evaluate:ee,interpolate:te,variable:"",imports:{_:Hi}},Hi.prototype=Gi.prototype,Hi.prototype.constructor=Hi,ji.prototype=$i(Gi.prototype),ji.prototype.constructor=ji,qi.prototype=$i(Gi.prototype),qi.prototype.constructor=qi,Wi.prototype.clear=function(){this.__data__=Mi?Mi(null):{},this.size=0},Wi.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},Wi.prototype.get=function(e){var t=this.__data__;if(Mi){var n=t[e];return n===r?i:n}return Ue.call(t,e)?t[e]:i},Wi.prototype.has=function(e){var t=this.__data__;return Mi?t[e]!==i:Ue.call(t,e)},Wi.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=Mi&&t===i?r:t,this},zi.prototype.clear=function(){this.__data__=[],this.size=0},zi.prototype.delete=function(e){var t=this.__data__,i=rn(t,e);return!(i<0||(i==t.length-1?t.pop():Qe.call(t,i,1),--this.size,0))},zi.prototype.get=function(e){var t=this.__data__,n=rn(t,e);return n<0?i:t[n][1]},zi.prototype.has=function(e){return rn(this.__data__,e)>-1},zi.prototype.set=function(e,t){var i=this.__data__,n=rn(i,e);return n<0?(++this.size,i.push([e,t])):i[n][1]=t,this},Ji.prototype.clear=function(){this.size=0,this.__data__={hash:new Wi,map:new(Ai||zi),string:new Wi}},Ji.prototype.delete=function(e){var t=Ss(this,e).delete(e);return this.size-=t?1:0,t},Ji.prototype.get=function(e){return Ss(this,e).get(e)},Ji.prototype.has=function(e){return Ss(this,e).has(e)},Ji.prototype.set=function(e,t){var i=Ss(this,e),n=i.size;return i.set(e,t),this.size+=i.size==n?0:1,this},Ki.prototype.add=Ki.prototype.push=function(e){return this.__data__.set(e,r),this},Ki.prototype.has=function(e){return this.__data__.has(e)},Yi.prototype.clear=function(){this.__data__=new zi,this.size=0},Yi.prototype.delete=function(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i},Yi.prototype.get=function(e){return this.__data__.get(e)},Yi.prototype.has=function(e){return this.__data__.has(e)},Yi.prototype.set=function(e,t){var i=this.__data__;if(i instanceof zi){var n=i.__data__;if(!Ai||n.length<199)return n.push([e,t]),this.size=++i.size,this;i=this.__data__=new Ji(n)}return i.set(e,t),this.size=i.size,this};var pn=Ur(Tn),mn=Ur(In,!0);function fn(e,t){var i=!0;return pn(e,(function(e,n,r){return i=!!t(e,n,r)})),i}function Sn(e,t,n){for(var r=-1,s=e.length;++r<s;){var a=e[r],o=t(a);if(null!=o&&(c===i?o==o&&!vo(o):n(o,c)))var c=o,l=a}return l}function vn(e,t,n,r){var s=e.length;for((n=Io(n))<0&&(n=-n>s?0:s+n),(r=r===i||r>s?s:Io(r))<0&&(r+=s),r=n>r?0:bo(r);n<r;)e[n++]=t;return e}function yn(e,t){var i=[];return pn(e,(function(e,n,r){t(e,n,r)&&i.push(e)})),i}function Cn(e,t,i,n,r){var s=-1,a=e.length;for(i||(i=bs),r||(r=[]);++s<a;){var o=e[s];t>0&&i(o)?t>1?Cn(o,t-1,i,n,r):Ut(r,o):n||(r[r.length]=o)}return r}var _n=Fr(),En=Fr(!0);function Tn(e,t){return e&&_n(e,t,Ho)}function In(e,t){return e&&En(e,t,Ho)}function bn(e,t){return kt(t,(function(t){return ao(e[t])}))}function An(e,t){for(var n=0,r=(t=Tr(t,e)).length;null!=e&&n<r;)e=e[Ws(t[n++])];return n&&n==r?e:i}function Rn(e,t,i){var n=t(e);return Za(e)?n:Ut(n,i(e))}function wn(e){return null==e?e===i?"[object Undefined]":"[object Null]":et&&et in we(e)?function(e){var t=Ue.call(e,et),n=e[et];try{e[et]=i;var r=!0}catch(e){}var s=Be.call(e);return r&&(t?e[et]=n:delete e[et]),s}(e):function(e){return Be.call(e)}(e)}function Pn(e,t){return e>t}function Mn(e,t){return null!=e&&Ue.call(e,t)}function Dn(e,t){return null!=e&&t in we(e)}function On(e,t,n){for(var r=n?Lt:Nt,s=e[0].length,a=e.length,o=a,c=ce(a),l=1/0,d=[];o--;){var h=e[o];o&&t&&(h=xt(h,ti(t))),l=Yt(h.length,l),c[o]=!n&&(t||s>=120&&h.length>=120)?new Ki(o&&h):i}h=e[0];var u=-1,g=c[0];e:for(;++u<s&&d.length<l;){var p=h[u],m=t?t(p):p;if(p=n||0!==p?p:0,!(g?ni(g,m):r(d,m,n))){for(o=a;--o;){var f=c[o];if(!(f?ni(f,m):r(e[o],m,n)))continue e}g&&g.push(m),d.push(p)}}return d}function kn(e,t,n){var r=null==(e=xs(e,t=Tr(t,e)))?e:e[Ws(sa(t))];return null==r?i:wt(r,e,n)}function Nn(e){return ho(e)&&wn(e)==y}function Ln(e,t,i,n,r){return e===t||(null==e||null==t||!ho(e)&&!ho(t)?e!=e&&t!=t:function(e,t,i,n,r,s){var a=Za(e),o=Za(t),c=a?C:Es(e),l=o?C:Es(t),d=(c=c==y?w:c)==w,h=(l=l==y?w:l)==w,u=c==l;if(u&&no(e)){if(!no(t))return!1;a=!0,d=!1}if(u&&!d)return s||(s=new Yi),a||yo(e)?os(e,t,i,n,r,s):cs(e,t,c,i,n,r,s);if(!(1&i)){var g=d&&Ue.call(e,"__wrapped__"),p=h&&Ue.call(t,"__wrapped__");if(g||p){var m=g?e.value():e,f=p?t.value():t;return s||(s=new Yi),r(m,f,i,n,s)}}return!!u&&(s||(s=new Yi),ls(e,t,i,n,r,s))}(e,t,i,n,Ln,r))}function xn(e,t,n,r){var s=n.length,a=s,o=!r;if(null==e)return!a;for(e=we(e);s--;){var c=n[s];if(o&&c[2]?c[1]!==e[c[0]]:!(c[0]in e))return!1}for(;++s<a;){var l=(c=n[s])[0],d=e[l],h=c[1];if(o&&c[2]){if(d===i&&!(l in e))return!1}else{var u=new Yi;if(r)var g=r(d,h,l,e,t,u);if(!(g===i?Ln(h,d,3,r,u):g))return!1}}return!0}function Un(e){return!(!lo(e)||function(e){return!!Ve&&Ve in e}(e))&&(ao(e)?Ge:ye).test(zs(e))}function Fn(e){return"function"==typeof e?e:null==e?gc:"object"==typeof e?Za(e)?jn(e[0],e[1]):Gn(e):Ec(e)}function Vn(e){if(!Ds(e))return _t(e);var t=[];for(var i in we(e))Ue.call(e,i)&&"constructor"!=i&&t.push(i);return t}function Bn(e){if(!lo(e))return function(e){var t=[];if(null!=e)for(var i in we(e))t.push(i);return t}(e);var t=Ds(e),i=[];for(var n in e)("constructor"!=n||!t&&Ue.call(e,n))&&i.push(n);return i}function Hn(e,t){return e<t}function $n(e,t){var i=-1,n=to(e)?ce(e.length):[];return pn(e,(function(e,r,s){n[++i]=t(e,r,s)})),n}function Gn(e){var t=vs(e);return 1==t.length&&t[0][2]?ks(t[0][0],t[0][1]):function(i){return i===e||xn(i,e,t)}}function jn(e,t){return ws(e)&&Os(t)?ks(Ws(e),t):function(n){var r=xo(n,e);return r===i&&r===t?Uo(n,e):Ln(t,r,3)}}function qn(e,t,n,r,s){e!==t&&_n(t,(function(a,o){if(s||(s=new Yi),lo(a))!function(e,t,n,r,s,a,o){var c=Fs(e,n),l=Fs(t,n),d=o.get(l);if(d)tn(e,n,d);else{var h=a?a(c,l,n+"",e,t,o):i,u=h===i;if(u){var g=Za(l),p=!g&&no(l),m=!g&&!p&&yo(l);h=l,g||p||m?Za(c)?h=c:io(c)?h=kr(c):p?(u=!1,h=Rr(l,!0)):m?(u=!1,h=Pr(l,!0)):h=[]:po(l)||Xa(l)?(h=c,Xa(c)?h=Ro(c):lo(c)&&!ao(c)||(h=Is(l))):u=!1}u&&(o.set(l,h),s(h,l,r,a,o),o.delete(l)),tn(e,n,h)}}(e,t,o,n,qn,r,s);else{var c=r?r(Fs(e,o),a,o+"",e,t,s):i;c===i&&(c=a),tn(e,o,c)}}),$o)}function Wn(e,t){var n=e.length;if(n)return As(t+=t<0?n:0,n)?e[t]:i}function zn(e,t,i){t=t.length?xt(t,(function(e){return Za(e)?function(t){return An(t,1===e.length?e[0]:e)}:e})):[gc];var n=-1;t=xt(t,ti(fs()));var r=$n(e,(function(e,i,r){var s=xt(t,(function(t){return t(e)}));return{criteria:s,index:++n,value:e}}));return function(e,t){var i=e.length;for(e.sort(t);i--;)e[i]=e[i].value;return e}(r,(function(e,t){return function(e,t,i){for(var n=-1,r=e.criteria,s=t.criteria,a=r.length,o=i.length;++n<a;){var c=Mr(r[n],s[n]);if(c)return n>=o?c:c*("desc"==i[n]?-1:1)}return e.index-t.index}(e,t,i)}))}function Jn(e,t,i){for(var n=-1,r=t.length,s={};++n<r;){var a=t[n],o=An(e,a);i(o,a)&&nr(s,Tr(a,e),o)}return s}function Kn(e,t,i,n){var r=n?Wt:qt,s=-1,a=t.length,o=e;for(e===t&&(t=kr(t)),i&&(o=xt(e,ti(i)));++s<a;)for(var c=0,l=t[s],d=i?i(l):l;(c=r(o,d,c,n))>-1;)o!==e&&Qe.call(o,c,1),Qe.call(e,c,1);return e}function Yn(e,t){for(var i=e?t.length:0,n=i-1;i--;){var r=t[i];if(i==n||r!==s){var s=r;As(r)?Qe.call(e,r,1):mr(e,r)}}return e}function Qn(e,t){return e+pt(Ti()*(t-e+1))}function Xn(e,t,i,n){for(var r=-1,s=Ht(ht((t-e)/(i||1)),0),a=ce(s);s--;)a[n?s:++r]=e,e+=i;return a}function Zn(e,t){var i="";if(!e||t<1||t>g)return i;do{t%2&&(i+=e),(t=pt(t/2))&&(e+=e)}while(t);return i}function er(e,t){return Hs(Ls(e,t,gc),e+"")}function tr(e){return Xi(Yo(e))}function ir(e,t){var i=Yo(e);return js(i,ln(t,0,i.length))}function nr(e,t,n,r){if(!lo(e))return e;for(var s=-1,a=(t=Tr(t,e)).length,o=a-1,c=e;null!=c&&++s<a;){var l=Ws(t[s]),d=n;if("__proto__"===l||"constructor"===l||"prototype"===l)return e;if(s!=o){var h=c[l];(d=r?r(h,l,c):i)===i&&(d=lo(h)?h:As(t[s+1])?[]:{})}nn(c,l,d),c=c[l]}return e}var rr=Di?function(e,t){return Di.set(e,t),e}:gc,sr=nt?function(e,t){return nt(e,"toString",{configurable:!0,enumerable:!1,value:dc(t),writable:!0})}:gc;function ar(e){return js(Yo(e))}function or(e,t,i){var n=-1,r=e.length;t<0&&(t=-t>r?0:r+t),(i=i>r?r:i)<0&&(i+=r),r=t>i?0:i-t>>>0,t>>>=0;for(var s=ce(r);++n<r;)s[n]=e[n+t];return s}function cr(e,t){var i;return pn(e,(function(e,n,r){return!(i=t(e,n,r))})),!!i}function lr(e,t,i){var n=0,r=null==e?n:e.length;if("number"==typeof t&&t==t&&r<=S){for(;n<r;){var s=n+r>>>1,a=e[s];null!==a&&!vo(a)&&(i?a<=t:a<t)?n=s+1:r=s}return r}return dr(e,t,gc,i)}function dr(e,t,n,r){var s=0,a=null==e?0:e.length;if(0===a)return 0;for(var o=(t=n(t))!=t,c=null===t,l=vo(t),d=t===i;s<a;){var h=pt((s+a)/2),u=n(e[h]),g=u!==i,p=null===u,m=u==u,S=vo(u);if(o)var v=r||m;else v=d?m&&(r||g):c?m&&g&&(r||!p):l?m&&g&&!p&&(r||!S):!p&&!S&&(r?u<=t:u<t);v?s=h+1:a=h}return Yt(a,f)}function hr(e,t){for(var i=-1,n=e.length,r=0,s=[];++i<n;){var a=e[i],o=t?t(a):a;if(!i||!Ka(o,c)){var c=o;s[r++]=0===a?0:a}}return s}function ur(e){return"number"==typeof e?e:vo(e)?p:+e}function gr(e){if("string"==typeof e)return e;if(Za(e))return xt(e,gr)+"";if(vo(e))return Bi?Bi.call(e):"";var t=e+"";return"0"==t&&1/e==-u?"-0":t}function pr(e,t,i){var n=-1,r=Nt,s=e.length,a=!0,o=[],c=o;if(i)a=!1,r=Lt;else if(s>=200){var l=t?null:ts(e);if(l)return pi(l);a=!1,r=ni,c=new Ki}else c=t?[]:o;e:for(;++n<s;){var d=e[n],h=t?t(d):d;if(d=i||0!==d?d:0,a&&h==h){for(var u=c.length;u--;)if(c[u]===h)continue e;t&&c.push(h),o.push(d)}else r(c,h,i)||(c!==o&&c.push(h),o.push(d))}return o}function mr(e,t){return null==(e=xs(e,t=Tr(t,e)))||delete e[Ws(sa(t))]}function fr(e,t,i,n){return nr(e,t,i(An(e,t)),n)}function Sr(e,t,i,n){for(var r=e.length,s=n?r:-1;(n?s--:++s<r)&&t(e[s],s,e););return i?or(e,n?0:s,n?s+1:r):or(e,n?s+1:0,n?r:s)}function vr(e,t){var i=e;return i instanceof qi&&(i=i.value()),Ft(t,(function(e,t){return t.func.apply(t.thisArg,Ut([e],t.args))}),i)}function yr(e,t,i){var n=e.length;if(n<2)return n?pr(e[0]):[];for(var r=-1,s=ce(n);++r<n;)for(var a=e[r],o=-1;++o<n;)o!=r&&(s[r]=gn(s[r]||a,e[o],t,i));return pr(Cn(s,1),t,i)}function Cr(e,t,n){for(var r=-1,s=e.length,a=t.length,o={};++r<s;){var c=r<a?t[r]:i;n(o,e[r],c)}return o}function _r(e){return io(e)?e:[]}function Er(e){return"function"==typeof e?e:gc}function Tr(e,t){return Za(e)?e:ws(e,t)?[e]:qs(wo(e))}var Ir=er;function br(e,t,n){var r=e.length;return n=n===i?r:n,!t&&n>=r?e:or(e,t,n)}var Ar=rt||function(e){return ft.clearTimeout(e)};function Rr(e,t){if(t)return e.slice();var i=e.length,n=ze?ze(i):new e.constructor(i);return e.copy(n),n}function wr(e){var t=new e.constructor(e.byteLength);return new We(t).set(new We(e)),t}function Pr(e,t){var i=t?wr(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}function Mr(e,t){if(e!==t){var n=e!==i,r=null===e,s=e==e,a=vo(e),o=t!==i,c=null===t,l=t==t,d=vo(t);if(!c&&!d&&!a&&e>t||a&&o&&l&&!c&&!d||r&&o&&l||!n&&l||!s)return 1;if(!r&&!a&&!d&&e<t||d&&n&&s&&!r&&!a||c&&n&&s||!o&&s||!l)return-1}return 0}function Dr(e,t,i,n){for(var r=-1,s=e.length,a=i.length,o=-1,c=t.length,l=Ht(s-a,0),d=ce(c+l),h=!n;++o<c;)d[o]=t[o];for(;++r<a;)(h||r<s)&&(d[i[r]]=e[r]);for(;l--;)d[o++]=e[r++];return d}function Or(e,t,i,n){for(var r=-1,s=e.length,a=-1,o=i.length,c=-1,l=t.length,d=Ht(s-o,0),h=ce(d+l),u=!n;++r<d;)h[r]=e[r];for(var g=r;++c<l;)h[g+c]=t[c];for(;++a<o;)(u||r<s)&&(h[g+i[a]]=e[r++]);return h}function kr(e,t){var i=-1,n=e.length;for(t||(t=ce(n));++i<n;)t[i]=e[i];return t}function Nr(e,t,n,r){var s=!n;n||(n={});for(var a=-1,o=t.length;++a<o;){var c=t[a],l=r?r(n[c],e[c],c,n,e):i;l===i&&(l=e[c]),s?on(n,c,l):nn(n,c,l)}return n}function Lr(e,t){return function(i,n){var r=Za(i)?Pt:sn,s=t?t():{};return r(i,e,fs(n,2),s)}}function xr(e){return er((function(t,n){var r=-1,s=n.length,a=s>1?n[s-1]:i,o=s>2?n[2]:i;for(a=e.length>3&&"function"==typeof a?(s--,a):i,o&&Rs(n[0],n[1],o)&&(a=s<3?i:a,s=1),t=we(t);++r<s;){var c=n[r];c&&e(t,c,r,a)}return t}))}function Ur(e,t){return function(i,n){if(null==i)return i;if(!to(i))return e(i,n);for(var r=i.length,s=t?r:-1,a=we(i);(t?s--:++s<r)&&!1!==n(a[s],s,a););return i}}function Fr(e){return function(t,i,n){for(var r=-1,s=we(t),a=n(t),o=a.length;o--;){var c=a[e?o:++r];if(!1===i(s[c],c,s))break}return t}}function Vr(e){return function(t){var n=li(t=wo(t))?fi(t):i,r=n?n[0]:t.charAt(0),s=n?br(n,1).join(""):t.slice(1);return r[e]()+s}}function Br(e){return function(t){return Ft(oc(Zo(t).replace(tt,"")),e,"")}}function Hr(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var i=$i(e.prototype),n=e.apply(i,t);return lo(n)?n:i}}function $r(e,t,n){var r=Hr(e);return function s(){for(var a=arguments.length,o=ce(a),c=a,l=ms(s);c--;)o[c]=arguments[c];var d=a<3&&o[0]!==l&&o[a-1]!==l?[]:gi(o,l);return(a-=d.length)<n?Zr(e,t,qr,s.placeholder,i,o,d,i,i,n-a):wt(this&&this!==ft&&this instanceof s?r:e,this,o)}}function Gr(e){return function(t,n,r){var s=we(t);if(!to(t)){var a=fs(n,3);t=Ho(t),n=function(e){return a(s[e],e,s)}}var o=e(t,n,r);return o>-1?s[a?t[o]:o]:i}}function jr(e){return ds((function(t){var r=t.length,s=r,a=ji.prototype.thru;for(e&&t.reverse();s--;){var o=t[s];if("function"!=typeof o)throw new De(n);if(a&&!c&&"wrapper"==ps(o))var c=new ji([],!0)}for(s=c?s:r;++s<r;){var l=ps(o=t[s]),d="wrapper"==l?gs(o):i;c=d&&Ps(d[0])&&424==d[1]&&!d[4].length&&1==d[9]?c[ps(d[0])].apply(c,d[3]):1==o.length&&Ps(o)?c[l]():c.thru(o)}return function(){var e=arguments,i=e[0];if(c&&1==e.length&&Za(i))return c.plant(i).value();for(var n=0,s=r?t[n].apply(this,e):i;++n<r;)s=t[n].call(this,s);return s}}))}function qr(e,t,n,r,s,a,o,c,l,h){var u=t&d,g=1&t,p=2&t,m=24&t,f=512&t,S=p?i:Hr(e);return function i(){for(var d=arguments.length,v=ce(d),y=d;y--;)v[y]=arguments[y];if(m)var C=ms(i),_=function(e,t){for(var i=e.length,n=0;i--;)e[i]===t&&++n;return n}(v,C);if(r&&(v=Dr(v,r,s,m)),a&&(v=Or(v,a,o,m)),d-=_,m&&d<h){var E=gi(v,C);return Zr(e,t,qr,i.placeholder,n,v,E,c,l,h-d)}var T=g?n:this,I=p?T[e]:e;return d=v.length,c?v=Us(v,c):f&&d>1&&v.reverse(),u&&l<d&&(v.length=l),this&&this!==ft&&this instanceof i&&(I=S||Hr(I)),I.apply(T,v)}}function Wr(e,t){return function(i,n){return function(e,t,i,n){return Tn(e,(function(e,r,s){t(n,i(e),r,s)})),n}(i,e,t(n),{})}}function zr(e,t){return function(n,r){var s;if(n===i&&r===i)return t;if(n!==i&&(s=n),r!==i){if(s===i)return r;"string"==typeof n||"string"==typeof r?(n=gr(n),r=gr(r)):(n=ur(n),r=ur(r)),s=e(n,r)}return s}}function Jr(e){return ds((function(t){return t=xt(t,ti(fs())),er((function(i){var n=this;return e(t,(function(e){return wt(e,n,i)}))}))}))}function Kr(e,t){var n=(t=t===i?" ":gr(t)).length;if(n<2)return n?Zn(t,e):t;var r=Zn(t,ht(e/mi(t)));return li(t)?br(fi(r),0,e).join(""):r.slice(0,e)}function Yr(e,t,i,n){var r=1&t,s=Hr(e);return function t(){for(var a=-1,o=arguments.length,c=-1,l=n.length,d=ce(l+o),h=this&&this!==ft&&this instanceof t?s:e;++c<l;)d[c]=n[c];for(;o--;)d[c++]=arguments[++a];return wt(h,r?i:this,d)}}function Qr(e){return function(t,n,r){return r&&"number"!=typeof r&&Rs(t,n,r)&&(n=r=i),t=To(t),n===i?(n=t,t=0):n=To(n),Xn(t,n,r=r===i?t<n?1:-1:To(r),e)}}function Xr(e){return function(t,i){return"string"==typeof t&&"string"==typeof i||(t=Ao(t),i=Ao(i)),e(t,i)}}function Zr(e,t,n,r,s,a,o,d,h,u){var g=8&t;t|=g?c:l,4&(t&=~(g?l:c))||(t&=-4);var p=[e,t,s,g?a:i,g?o:i,g?i:a,g?i:o,d,h,u],m=n.apply(i,p);return Ps(e)&&Vs(m,p),m.placeholder=r,$s(m,e,t)}function es(e){var t=Re[e];return function(e,i){if(e=Ao(e),(i=null==i?0:Yt(Io(i),292))&&vt(e)){var n=(wo(e)+"e").split("e");return+((n=(wo(t(n[0]+"e"+(+n[1]+i)))+"e").split("e"))[0]+"e"+(+n[1]-i))}return t(e)}}var ts=wi&&1/pi(new wi([,-0]))[1]==u?function(e){return new wi(e)}:vc;function is(e){return function(t){var i=Es(t);return i==A?hi(t):i==D?function(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=[e,e]})),i}(t):function(e,t){return xt(t,(function(t){return[t,e[t]]}))}(t,e(t))}}function ns(e,t,r,s,a,d,h,u){var g=2&t;if(!g&&"function"!=typeof e)throw new De(n);var p=s?s.length:0;if(p||(t&=-97,s=a=i),h=h===i?h:Ht(Io(h),0),u=u===i?u:Io(u),p-=a?a.length:0,t&l){var m=s,f=a;s=a=i}var S=g?i:gs(e),v=[e,t,r,s,a,m,f,d,h,u];if(S&&Ns(v,S),e=v[0],t=v[1],r=v[2],s=v[3],a=v[4],!(u=v[9]=v[9]===i?g?0:e.length:Ht(v[9]-p,0))&&24&t&&(t&=-25),t&&1!=t)y=8==t||t==o?$r(e,t,u):t!=c&&33!=t||a.length?qr.apply(i,v):Yr(e,t,r,s);else var y=function(e,t,i){var n=1&t,r=Hr(e);return function t(){return(this&&this!==ft&&this instanceof t?r:e).apply(n?i:this,arguments)}}(e,t,r);return $s((S?rr:Vs)(y,v),e,t)}function rs(e,t,n,r){return e===i||Ka(e,Ne[n])&&!Ue.call(r,n)?t:e}function ss(e,t,n,r,s,a){return lo(e)&&lo(t)&&(a.set(t,e),qn(e,t,i,ss,a),a.delete(t)),e}function as(e){return po(e)?i:e}function os(e,t,n,r,s,a){var o=1&n,c=e.length,l=t.length;if(c!=l&&!(o&&l>c))return!1;var d=a.get(e),h=a.get(t);if(d&&h)return d==t&&h==e;var u=-1,g=!0,p=2&n?new Ki:i;for(a.set(e,t),a.set(t,e);++u<c;){var m=e[u],f=t[u];if(r)var S=o?r(f,m,u,t,e,a):r(m,f,u,e,t,a);if(S!==i){if(S)continue;g=!1;break}if(p){if(!Bt(t,(function(e,t){if(!ni(p,t)&&(m===e||s(m,e,n,r,a)))return p.push(t)}))){g=!1;break}}else if(m!==f&&!s(m,f,n,r,a)){g=!1;break}}return a.delete(e),a.delete(t),g}function cs(e,t,i,n,r,s,a){switch(i){case x:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case L:return!(e.byteLength!=t.byteLength||!s(new We(e),new We(t)));case _:case E:case R:return Ka(+e,+t);case T:return e.name==t.name&&e.message==t.message;case M:case O:return e==t+"";case A:var o=hi;case D:var c=1&n;if(o||(o=pi),e.size!=t.size&&!c)return!1;var l=a.get(e);if(l)return l==t;n|=2,a.set(e,t);var d=os(o(e),o(t),n,r,s,a);return a.delete(e),d;case k:if(Vi)return Vi.call(e)==Vi.call(t)}return!1}function ls(e,t,n,r,s,a){var o=1&n,c=hs(e),l=c.length;if(l!=hs(t).length&&!o)return!1;for(var d=l;d--;){var h=c[d];if(!(o?h in t:Ue.call(t,h)))return!1}var u=a.get(e),g=a.get(t);if(u&&g)return u==t&&g==e;var p=!0;a.set(e,t),a.set(t,e);for(var m=o;++d<l;){var f=e[h=c[d]],S=t[h];if(r)var v=o?r(S,f,h,t,e,a):r(f,S,h,e,t,a);if(!(v===i?f===S||s(f,S,n,r,a):v)){p=!1;break}m||(m="constructor"==h)}if(p&&!m){var y=e.constructor,C=t.constructor;y==C||!("constructor"in e)||!("constructor"in t)||"function"==typeof y&&y instanceof y&&"function"==typeof C&&C instanceof C||(p=!1)}return a.delete(e),a.delete(t),p}function ds(e){return Hs(Ls(e,i,ea),e+"")}function hs(e){return Rn(e,Ho,Cs)}function us(e){return Rn(e,$o,_s)}var gs=Di?function(e){return Di.get(e)}:vc;function ps(e){for(var t=e.name+"",i=Oi[t],n=Ue.call(Oi,t)?i.length:0;n--;){var r=i[n],s=r.func;if(null==s||s==e)return r.name}return t}function ms(e){return(Ue.call(Hi,"placeholder")?Hi:e).placeholder}function fs(){var e=Hi.iteratee||pc;return e=e===pc?Fn:e,arguments.length?e(arguments[0],arguments[1]):e}function Ss(e,t){var i=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?i["string"==typeof t?"string":"hash"]:i.map}function vs(e){for(var t=Ho(e),i=t.length;i--;){var n=t[i],r=e[n];t[i]=[n,r,Os(r)]}return t}function ys(e,t){var n=function(e,t){return null==e?i:e[t]}(e,t);return Un(n)?n:i}var Cs=mt?function(e){return null==e?[]:(e=we(e),kt(mt(e),(function(t){return Ye.call(e,t)})))}:bc,_s=mt?function(e){for(var t=[];e;)Ut(t,Cs(e)),e=Je(e);return t}:bc,Es=wn;function Ts(e,t,i){for(var n=-1,r=(t=Tr(t,e)).length,s=!1;++n<r;){var a=Ws(t[n]);if(!(s=null!=e&&i(e,a)))break;e=e[a]}return s||++n!=r?s:!!(r=null==e?0:e.length)&&co(r)&&As(a,r)&&(Za(e)||Xa(e))}function Is(e){return"function"!=typeof e.constructor||Ds(e)?{}:$i(Je(e))}function bs(e){return Za(e)||Xa(e)||!!(Xe&&e&&e[Xe])}function As(e,t){var i=typeof e;return!!(t=null==t?g:t)&&("number"==i||"symbol"!=i&&_e.test(e))&&e>-1&&e%1==0&&e<t}function Rs(e,t,i){if(!lo(i))return!1;var n=typeof t;return!!("number"==n?to(i)&&As(t,i.length):"string"==n&&t in i)&&Ka(i[t],e)}function ws(e,t){if(Za(e))return!1;var i=typeof e;return!("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!vo(e))||ne.test(e)||!ie.test(e)||null!=t&&e in we(t)}function Ps(e){var t=ps(e),i=Hi[t];if("function"!=typeof i||!(t in qi.prototype))return!1;if(e===i)return!0;var n=gs(i);return!!n&&e===n[0]}(bi&&Es(new bi(new ArrayBuffer(1)))!=x||Ai&&Es(new Ai)!=A||Ri&&Es(Ri.resolve())!=P||wi&&Es(new wi)!=D||Pi&&Es(new Pi)!=N)&&(Es=function(e){var t=wn(e),n=t==w?e.constructor:i,r=n?zs(n):"";if(r)switch(r){case ki:return x;case Ni:return A;case Li:return P;case xi:return D;case Ui:return N}return t});var Ms=Le?ao:Ac;function Ds(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Ne)}function Os(e){return e==e&&!lo(e)}function ks(e,t){return function(n){return null!=n&&n[e]===t&&(t!==i||e in we(n))}}function Ns(e,t){var i=e[1],n=t[1],r=i|n,s=r<131,o=n==d&&8==i||n==d&&i==h&&e[7].length<=t[8]||384==n&&t[7].length<=t[8]&&8==i;if(!s&&!o)return e;1&n&&(e[2]=t[2],r|=1&i?0:4);var c=t[3];if(c){var l=e[3];e[3]=l?Dr(l,c,t[4]):c,e[4]=l?gi(e[3],a):t[4]}return(c=t[5])&&(l=e[5],e[5]=l?Or(l,c,t[6]):c,e[6]=l?gi(e[5],a):t[6]),(c=t[7])&&(e[7]=c),n&d&&(e[8]=null==e[8]?t[8]:Yt(e[8],t[8])),null==e[9]&&(e[9]=t[9]),e[0]=t[0],e[1]=r,e}function Ls(e,t,n){return t=Ht(t===i?e.length-1:t,0),function(){for(var i=arguments,r=-1,s=Ht(i.length-t,0),a=ce(s);++r<s;)a[r]=i[t+r];r=-1;for(var o=ce(t+1);++r<t;)o[r]=i[r];return o[t]=n(a),wt(e,this,o)}}function xs(e,t){return t.length<2?e:An(e,or(t,0,-1))}function Us(e,t){for(var n=e.length,r=Yt(t.length,n),s=kr(e);r--;){var a=t[r];e[r]=As(a,n)?s[a]:i}return e}function Fs(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var Vs=Gs(rr),Bs=at||function(e,t){return ft.setTimeout(e,t)},Hs=Gs(sr);function $s(e,t,i){var n=t+"";return Hs(e,function(e,t){var i=t.length;if(!i)return e;var n=i-1;return t[n]=(i>1?"& ":"")+t[n],t=t.join(i>2?", ":" "),e.replace(le,"{\n/* [wrapped with "+t+"] */\n")}(n,function(e,t){return Mt(v,(function(i){var n="_."+i[0];t&i[1]&&!Nt(e,n)&&e.push(n)})),e.sort()}(function(e){var t=e.match(de);return t?t[1].split(he):[]}(n),i)))}function Gs(e){var t=0,n=0;return function(){var r=_i(),s=16-(r-n);if(n=r,s>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(i,arguments)}}function js(e,t){var n=-1,r=e.length,s=r-1;for(t=t===i?r:t;++n<t;){var a=Qn(n,s),o=e[a];e[a]=e[n],e[n]=o}return e.length=t,e}var qs=function(e){var t=Ga(e,(function(e){return 500===i.size&&i.clear(),e})),i=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(re,(function(e,i,n,r){t.push(n?r.replace(pe,"$1"):i||e)})),t}));function Ws(e){if("string"==typeof e||vo(e))return e;var t=e+"";return"0"==t&&1/e==-u?"-0":t}function zs(e){if(null!=e){try{return xe.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Js(e){if(e instanceof qi)return e.clone();var t=new ji(e.__wrapped__,e.__chain__);return t.__actions__=kr(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var Ks=er((function(e,t){return io(e)?gn(e,Cn(t,1,io,!0)):[]})),Ys=er((function(e,t){var n=sa(t);return io(n)&&(n=i),io(e)?gn(e,Cn(t,1,io,!0),fs(n,2)):[]})),Qs=er((function(e,t){var n=sa(t);return io(n)&&(n=i),io(e)?gn(e,Cn(t,1,io,!0),i,n):[]}));function Xs(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var r=null==i?0:Io(i);return r<0&&(r=Ht(n+r,0)),jt(e,fs(t,3),r)}function Zs(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var s=r-1;return n!==i&&(s=Io(n),s=n<0?Ht(r+s,0):Yt(s,r-1)),jt(e,fs(t,3),s,!0)}function ea(e){return null!=e&&e.length?Cn(e,1):[]}function ta(e){return e&&e.length?e[0]:i}var ia=er((function(e){var t=xt(e,_r);return t.length&&t[0]===e[0]?On(t):[]})),na=er((function(e){var t=sa(e),n=xt(e,_r);return t===sa(n)?t=i:n.pop(),n.length&&n[0]===e[0]?On(n,fs(t,2)):[]})),ra=er((function(e){var t=sa(e),n=xt(e,_r);return(t="function"==typeof t?t:i)&&n.pop(),n.length&&n[0]===e[0]?On(n,i,t):[]}));function sa(e){var t=null==e?0:e.length;return t?e[t-1]:i}var aa=er(oa);function oa(e,t){return e&&e.length&&t&&t.length?Kn(e,t):e}var ca=ds((function(e,t){var i=null==e?0:e.length,n=cn(e,t);return Yn(e,xt(t,(function(e){return As(e,i)?+e:e})).sort(Mr)),n}));function la(e){return null==e?e:Ii.call(e)}var da=er((function(e){return pr(Cn(e,1,io,!0))})),ha=er((function(e){var t=sa(e);return io(t)&&(t=i),pr(Cn(e,1,io,!0),fs(t,2))})),ua=er((function(e){var t=sa(e);return t="function"==typeof t?t:i,pr(Cn(e,1,io,!0),i,t)}));function ga(e){if(!e||!e.length)return[];var t=0;return e=kt(e,(function(e){if(io(e))return t=Ht(e.length,t),!0})),Zt(t,(function(t){return xt(e,Kt(t))}))}function pa(e,t){if(!e||!e.length)return[];var n=ga(e);return null==t?n:xt(n,(function(e){return wt(t,i,e)}))}var ma=er((function(e,t){return io(e)?gn(e,t):[]})),fa=er((function(e){return yr(kt(e,io))})),Sa=er((function(e){var t=sa(e);return io(t)&&(t=i),yr(kt(e,io),fs(t,2))})),va=er((function(e){var t=sa(e);return t="function"==typeof t?t:i,yr(kt(e,io),i,t)})),ya=er(ga);var Ca=er((function(e){var t=e.length,n=t>1?e[t-1]:i;return n="function"==typeof n?(e.pop(),n):i,pa(e,n)}));function _a(e){var t=Hi(e);return t.__chain__=!0,t}function Ea(e,t){return t(e)}var Ta=ds((function(e){var t=e.length,n=t?e[0]:0,r=this.__wrapped__,s=function(t){return cn(t,e)};return!(t>1||this.__actions__.length)&&r instanceof qi&&As(n)?((r=r.slice(n,+n+(t?1:0))).__actions__.push({func:Ea,args:[s],thisArg:i}),new ji(r,this.__chain__).thru((function(e){return t&&!e.length&&e.push(i),e}))):this.thru(s)}));var Ia=Lr((function(e,t,i){Ue.call(e,i)?++e[i]:on(e,i,1)}));var ba=Gr(Xs),Aa=Gr(Zs);function Ra(e,t){return(Za(e)?Mt:pn)(e,fs(t,3))}function wa(e,t){return(Za(e)?Dt:mn)(e,fs(t,3))}var Pa=Lr((function(e,t,i){Ue.call(e,i)?e[i].push(t):on(e,i,[t])}));var Ma=er((function(e,t,i){var n=-1,r="function"==typeof t,s=to(e)?ce(e.length):[];return pn(e,(function(e){s[++n]=r?wt(t,e,i):kn(e,t,i)})),s})),Da=Lr((function(e,t,i){on(e,i,t)}));function Oa(e,t){return(Za(e)?xt:$n)(e,fs(t,3))}var ka=Lr((function(e,t,i){e[i?0:1].push(t)}),(function(){return[[],[]]}));var Na=er((function(e,t){if(null==e)return[];var i=t.length;return i>1&&Rs(e,t[0],t[1])?t=[]:i>2&&Rs(t[0],t[1],t[2])&&(t=[t[0]]),zn(e,Cn(t,1),[])})),La=st||function(){return ft.Date.now()};function xa(e,t,n){return t=n?i:t,t=e&&null==t?e.length:t,ns(e,d,i,i,i,i,t)}function Ua(e,t){var r;if("function"!=typeof t)throw new De(n);return e=Io(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=i),r}}var Fa=er((function(e,t,i){var n=1;if(i.length){var r=gi(i,ms(Fa));n|=c}return ns(e,n,t,i,r)})),Va=er((function(e,t,i){var n=3;if(i.length){var r=gi(i,ms(Va));n|=c}return ns(t,n,e,i,r)}));function Ba(e,t,r){var s,a,o,c,l,d,h=0,u=!1,g=!1,p=!0;if("function"!=typeof e)throw new De(n);function m(t){var n=s,r=a;return s=a=i,h=t,c=e.apply(r,n)}function f(e){var n=e-d;return d===i||n>=t||n<0||g&&e-h>=o}function S(){var e=La();if(f(e))return v(e);l=Bs(S,function(e){var i=t-(e-d);return g?Yt(i,o-(e-h)):i}(e))}function v(e){return l=i,p&&s?m(e):(s=a=i,c)}function y(){var e=La(),n=f(e);if(s=arguments,a=this,d=e,n){if(l===i)return function(e){return h=e,l=Bs(S,t),u?m(e):c}(d);if(g)return Ar(l),l=Bs(S,t),m(d)}return l===i&&(l=Bs(S,t)),c}return t=Ao(t)||0,lo(r)&&(u=!!r.leading,o=(g="maxWait"in r)?Ht(Ao(r.maxWait)||0,t):o,p="trailing"in r?!!r.trailing:p),y.cancel=function(){l!==i&&Ar(l),h=0,s=d=a=l=i},y.flush=function(){return l===i?c:v(La())},y}var Ha=er((function(e,t){return un(e,1,t)})),$a=er((function(e,t,i){return un(e,Ao(t)||0,i)}));function Ga(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new De(n);var i=function(){var n=arguments,r=t?t.apply(this,n):n[0],s=i.cache;if(s.has(r))return s.get(r);var a=e.apply(this,n);return i.cache=s.set(r,a)||s,a};return i.cache=new(Ga.Cache||Ji),i}function ja(e){if("function"!=typeof e)throw new De(n);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}Ga.Cache=Ji;var qa=Ir((function(e,t){var i=(t=1==t.length&&Za(t[0])?xt(t[0],ti(fs())):xt(Cn(t,1),ti(fs()))).length;return er((function(n){for(var r=-1,s=Yt(n.length,i);++r<s;)n[r]=t[r].call(this,n[r]);return wt(e,this,n)}))})),Wa=er((function(e,t){var n=gi(t,ms(Wa));return ns(e,c,i,t,n)})),za=er((function(e,t){var n=gi(t,ms(za));return ns(e,l,i,t,n)})),Ja=ds((function(e,t){return ns(e,h,i,i,i,t)}));function Ka(e,t){return e===t||e!=e&&t!=t}var Ya=Xr(Pn),Qa=Xr((function(e,t){return e>=t})),Xa=Nn(function(){return arguments}())?Nn:function(e){return ho(e)&&Ue.call(e,"callee")&&!Ye.call(e,"callee")},Za=ce.isArray,eo=Et?ti(Et):function(e){return ho(e)&&wn(e)==L};function to(e){return null!=e&&co(e.length)&&!ao(e)}function io(e){return ho(e)&&to(e)}var no=St||Ac,ro=Tt?ti(Tt):function(e){return ho(e)&&wn(e)==E};function so(e){if(!ho(e))return!1;var t=wn(e);return t==T||"[object DOMException]"==t||"string"==typeof e.message&&"string"==typeof e.name&&!po(e)}function ao(e){if(!lo(e))return!1;var t=wn(e);return t==I||t==b||"[object AsyncFunction]"==t||"[object Proxy]"==t}function oo(e){return"number"==typeof e&&e==Io(e)}function co(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=g}function lo(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function ho(e){return null!=e&&"object"==typeof e}var uo=It?ti(It):function(e){return ho(e)&&Es(e)==A};function go(e){return"number"==typeof e||ho(e)&&wn(e)==R}function po(e){if(!ho(e)||wn(e)!=w)return!1;var t=Je(e);if(null===t)return!0;var i=Ue.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&xe.call(i)==He}var mo=bt?ti(bt):function(e){return ho(e)&&wn(e)==M};var fo=At?ti(At):function(e){return ho(e)&&Es(e)==D};function So(e){return"string"==typeof e||!Za(e)&&ho(e)&&wn(e)==O}function vo(e){return"symbol"==typeof e||ho(e)&&wn(e)==k}var yo=Rt?ti(Rt):function(e){return ho(e)&&co(e.length)&&!!lt[wn(e)]};var Co=Xr(Hn),_o=Xr((function(e,t){return e<=t}));function Eo(e){if(!e)return[];if(to(e))return So(e)?fi(e):kr(e);if(Ze&&e[Ze])return function(e){for(var t,i=[];!(t=e.next()).done;)i.push(t.value);return i}(e[Ze]());var t=Es(e);return(t==A?hi:t==D?pi:Yo)(e)}function To(e){return e?(e=Ao(e))===u||e===-u?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}function Io(e){var t=To(e),i=t%1;return t==t?i?t-i:t:0}function bo(e){return e?ln(Io(e),0,m):0}function Ao(e){if("number"==typeof e)return e;if(vo(e))return p;if(lo(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=lo(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=ei(e);var i=ve.test(e);return i||Ce.test(e)?gt(e.slice(2),i?2:8):Se.test(e)?p:+e}function Ro(e){return Nr(e,$o(e))}function wo(e){return null==e?"":gr(e)}var Po=xr((function(e,t){if(Ds(t)||to(t))Nr(t,Ho(t),e);else for(var i in t)Ue.call(t,i)&&nn(e,i,t[i])})),Mo=xr((function(e,t){Nr(t,$o(t),e)})),Do=xr((function(e,t,i,n){Nr(t,$o(t),e,n)})),Oo=xr((function(e,t,i,n){Nr(t,Ho(t),e,n)})),ko=ds(cn);var No=er((function(e,t){e=we(e);var n=-1,r=t.length,s=r>2?t[2]:i;for(s&&Rs(t[0],t[1],s)&&(r=1);++n<r;)for(var a=t[n],o=$o(a),c=-1,l=o.length;++c<l;){var d=o[c],h=e[d];(h===i||Ka(h,Ne[d])&&!Ue.call(e,d))&&(e[d]=a[d])}return e})),Lo=er((function(e){return e.push(i,ss),wt(jo,i,e)}));function xo(e,t,n){var r=null==e?i:An(e,t);return r===i?n:r}function Uo(e,t){return null!=e&&Ts(e,t,Dn)}var Fo=Wr((function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=Be.call(t)),e[t]=i}),dc(gc)),Vo=Wr((function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=Be.call(t)),Ue.call(e,t)?e[t].push(i):e[t]=[i]}),fs),Bo=er(kn);function Ho(e){return to(e)?Qi(e):Vn(e)}function $o(e){return to(e)?Qi(e,!0):Bn(e)}var Go=xr((function(e,t,i){qn(e,t,i)})),jo=xr((function(e,t,i,n){qn(e,t,i,n)})),qo=ds((function(e,t){var i={};if(null==e)return i;var n=!1;t=xt(t,(function(t){return t=Tr(t,e),n||(n=t.length>1),t})),Nr(e,us(e),i),n&&(i=dn(i,7,as));for(var r=t.length;r--;)mr(i,t[r]);return i}));var Wo=ds((function(e,t){return null==e?{}:function(e,t){return Jn(e,t,(function(t,i){return Uo(e,i)}))}(e,t)}));function zo(e,t){if(null==e)return{};var i=xt(us(e),(function(e){return[e]}));return t=fs(t),Jn(e,i,(function(e,i){return t(e,i[0])}))}var Jo=is(Ho),Ko=is($o);function Yo(e){return null==e?[]:ii(e,Ho(e))}var Qo=Br((function(e,t,i){return t=t.toLowerCase(),e+(i?Xo(t):t)}));function Xo(e){return ac(wo(e).toLowerCase())}function Zo(e){return(e=wo(e))&&e.replace(Ee,ai).replace(it,"")}var ec=Br((function(e,t,i){return e+(i?"-":"")+t.toLowerCase()})),tc=Br((function(e,t,i){return e+(i?" ":"")+t.toLowerCase()})),ic=Vr("toLowerCase");var nc=Br((function(e,t,i){return e+(i?"_":"")+t.toLowerCase()}));var rc=Br((function(e,t,i){return e+(i?" ":"")+ac(t)}));var sc=Br((function(e,t,i){return e+(i?" ":"")+t.toUpperCase()})),ac=Vr("toUpperCase");function oc(e,t,n){return e=wo(e),(t=n?i:t)===i?di(e)?yi(e):$t(e):e.match(t)||[]}var cc=er((function(e,t){try{return wt(e,i,t)}catch(e){return so(e)?e:new be(e)}})),lc=ds((function(e,t){return Mt(t,(function(t){t=Ws(t),on(e,t,Fa(e[t],e))})),e}));function dc(e){return function(){return e}}var hc=jr(),uc=jr(!0);function gc(e){return e}function pc(e){return Fn("function"==typeof e?e:dn(e,1))}var mc=er((function(e,t){return function(i){return kn(i,e,t)}})),fc=er((function(e,t){return function(i){return kn(e,i,t)}}));function Sc(e,t,i){var n=Ho(t),r=bn(t,n);null!=i||lo(t)&&(r.length||!n.length)||(i=t,t=e,e=this,r=bn(t,Ho(t)));var s=!(lo(i)&&"chain"in i&&!i.chain),a=ao(e);return Mt(r,(function(i){var n=t[i];e[i]=n,a&&(e.prototype[i]=function(){var t=this.__chain__;if(s||t){var i=e(this.__wrapped__);return(i.__actions__=kr(this.__actions__)).push({func:n,args:arguments,thisArg:e}),i.__chain__=t,i}return n.apply(e,Ut([this.value()],arguments))})})),e}function vc(){}var yc=Jr(xt),Cc=Jr(Ot),_c=Jr(Bt);function Ec(e){return ws(e)?Kt(Ws(e)):function(e){return function(t){return An(t,e)}}(e)}var Tc=Qr(),Ic=Qr(!0);function bc(){return[]}function Ac(){return!1}var Rc=zr((function(e,t){return e+t}),0),wc=es("ceil"),Pc=zr((function(e,t){return e/t}),1),Mc=es("floor");var Dc,Oc=zr((function(e,t){return e*t}),1),kc=es("round"),Nc=zr((function(e,t){return e-t}),0);return Hi.after=function(e,t){if("function"!=typeof t)throw new De(n);return e=Io(e),function(){if(--e<1)return t.apply(this,arguments)}},Hi.ary=xa,Hi.assign=Po,Hi.assignIn=Mo,Hi.assignInWith=Do,Hi.assignWith=Oo,Hi.at=ko,Hi.before=Ua,Hi.bind=Fa,Hi.bindAll=lc,Hi.bindKey=Va,Hi.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return Za(e)?e:[e]},Hi.chain=_a,Hi.chunk=function(e,t,n){t=(n?Rs(e,t,n):t===i)?1:Ht(Io(t),0);var r=null==e?0:e.length;if(!r||t<1)return[];for(var s=0,a=0,o=ce(ht(r/t));s<r;)o[a++]=or(e,s,s+=t);return o},Hi.compact=function(e){for(var t=-1,i=null==e?0:e.length,n=0,r=[];++t<i;){var s=e[t];s&&(r[n++]=s)}return r},Hi.concat=function(){var e=arguments.length;if(!e)return[];for(var t=ce(e-1),i=arguments[0],n=e;n--;)t[n-1]=arguments[n];return Ut(Za(i)?kr(i):[i],Cn(t,1))},Hi.cond=function(e){var t=null==e?0:e.length,i=fs();return e=t?xt(e,(function(e){if("function"!=typeof e[1])throw new De(n);return[i(e[0]),e[1]]})):[],er((function(i){for(var n=-1;++n<t;){var r=e[n];if(wt(r[0],this,i))return wt(r[1],this,i)}}))},Hi.conforms=function(e){return function(e){var t=Ho(e);return function(i){return hn(i,e,t)}}(dn(e,1))},Hi.constant=dc,Hi.countBy=Ia,Hi.create=function(e,t){var i=$i(e);return null==t?i:an(i,t)},Hi.curry=function e(t,n,r){var s=ns(t,8,i,i,i,i,i,n=r?i:n);return s.placeholder=e.placeholder,s},Hi.curryRight=function e(t,n,r){var s=ns(t,o,i,i,i,i,i,n=r?i:n);return s.placeholder=e.placeholder,s},Hi.debounce=Ba,Hi.defaults=No,Hi.defaultsDeep=Lo,Hi.defer=Ha,Hi.delay=$a,Hi.difference=Ks,Hi.differenceBy=Ys,Hi.differenceWith=Qs,Hi.drop=function(e,t,n){var r=null==e?0:e.length;return r?or(e,(t=n||t===i?1:Io(t))<0?0:t,r):[]},Hi.dropRight=function(e,t,n){var r=null==e?0:e.length;return r?or(e,0,(t=r-(t=n||t===i?1:Io(t)))<0?0:t):[]},Hi.dropRightWhile=function(e,t){return e&&e.length?Sr(e,fs(t,3),!0,!0):[]},Hi.dropWhile=function(e,t){return e&&e.length?Sr(e,fs(t,3),!0):[]},Hi.fill=function(e,t,i,n){var r=null==e?0:e.length;return r?(i&&"number"!=typeof i&&Rs(e,t,i)&&(i=0,n=r),vn(e,t,i,n)):[]},Hi.filter=function(e,t){return(Za(e)?kt:yn)(e,fs(t,3))},Hi.flatMap=function(e,t){return Cn(Oa(e,t),1)},Hi.flatMapDeep=function(e,t){return Cn(Oa(e,t),u)},Hi.flatMapDepth=function(e,t,n){return n=n===i?1:Io(n),Cn(Oa(e,t),n)},Hi.flatten=ea,Hi.flattenDeep=function(e){return null!=e&&e.length?Cn(e,u):[]},Hi.flattenDepth=function(e,t){return null!=e&&e.length?Cn(e,t=t===i?1:Io(t)):[]},Hi.flip=function(e){return ns(e,512)},Hi.flow=hc,Hi.flowRight=uc,Hi.fromPairs=function(e){for(var t=-1,i=null==e?0:e.length,n={};++t<i;){var r=e[t];n[r[0]]=r[1]}return n},Hi.functions=function(e){return null==e?[]:bn(e,Ho(e))},Hi.functionsIn=function(e){return null==e?[]:bn(e,$o(e))},Hi.groupBy=Pa,Hi.initial=function(e){return null!=e&&e.length?or(e,0,-1):[]},Hi.intersection=ia,Hi.intersectionBy=na,Hi.intersectionWith=ra,Hi.invert=Fo,Hi.invertBy=Vo,Hi.invokeMap=Ma,Hi.iteratee=pc,Hi.keyBy=Da,Hi.keys=Ho,Hi.keysIn=$o,Hi.map=Oa,Hi.mapKeys=function(e,t){var i={};return t=fs(t,3),Tn(e,(function(e,n,r){on(i,t(e,n,r),e)})),i},Hi.mapValues=function(e,t){var i={};return t=fs(t,3),Tn(e,(function(e,n,r){on(i,n,t(e,n,r))})),i},Hi.matches=function(e){return Gn(dn(e,1))},Hi.matchesProperty=function(e,t){return jn(e,dn(t,1))},Hi.memoize=Ga,Hi.merge=Go,Hi.mergeWith=jo,Hi.method=mc,Hi.methodOf=fc,Hi.mixin=Sc,Hi.negate=ja,Hi.nthArg=function(e){return e=Io(e),er((function(t){return Wn(t,e)}))},Hi.omit=qo,Hi.omitBy=function(e,t){return zo(e,ja(fs(t)))},Hi.once=function(e){return Ua(2,e)},Hi.orderBy=function(e,t,n,r){return null==e?[]:(Za(t)||(t=null==t?[]:[t]),Za(n=r?i:n)||(n=null==n?[]:[n]),zn(e,t,n))},Hi.over=yc,Hi.overArgs=qa,Hi.overEvery=Cc,Hi.overSome=_c,Hi.partial=Wa,Hi.partialRight=za,Hi.partition=ka,Hi.pick=Wo,Hi.pickBy=zo,Hi.property=Ec,Hi.propertyOf=function(e){return function(t){return null==e?i:An(e,t)}},Hi.pull=aa,Hi.pullAll=oa,Hi.pullAllBy=function(e,t,i){return e&&e.length&&t&&t.length?Kn(e,t,fs(i,2)):e},Hi.pullAllWith=function(e,t,n){return e&&e.length&&t&&t.length?Kn(e,t,i,n):e},Hi.pullAt=ca,Hi.range=Tc,Hi.rangeRight=Ic,Hi.rearg=Ja,Hi.reject=function(e,t){return(Za(e)?kt:yn)(e,ja(fs(t,3)))},Hi.remove=function(e,t){var i=[];if(!e||!e.length)return i;var n=-1,r=[],s=e.length;for(t=fs(t,3);++n<s;){var a=e[n];t(a,n,e)&&(i.push(a),r.push(n))}return Yn(e,r),i},Hi.rest=function(e,t){if("function"!=typeof e)throw new De(n);return er(e,t=t===i?t:Io(t))},Hi.reverse=la,Hi.sampleSize=function(e,t,n){return t=(n?Rs(e,t,n):t===i)?1:Io(t),(Za(e)?Zi:ir)(e,t)},Hi.set=function(e,t,i){return null==e?e:nr(e,t,i)},Hi.setWith=function(e,t,n,r){return r="function"==typeof r?r:i,null==e?e:nr(e,t,n,r)},Hi.shuffle=function(e){return(Za(e)?en:ar)(e)},Hi.slice=function(e,t,n){var r=null==e?0:e.length;return r?(n&&"number"!=typeof n&&Rs(e,t,n)?(t=0,n=r):(t=null==t?0:Io(t),n=n===i?r:Io(n)),or(e,t,n)):[]},Hi.sortBy=Na,Hi.sortedUniq=function(e){return e&&e.length?hr(e):[]},Hi.sortedUniqBy=function(e,t){return e&&e.length?hr(e,fs(t,2)):[]},Hi.split=function(e,t,n){return n&&"number"!=typeof n&&Rs(e,t,n)&&(t=n=i),(n=n===i?m:n>>>0)?(e=wo(e))&&("string"==typeof t||null!=t&&!mo(t))&&!(t=gr(t))&&li(e)?br(fi(e),0,n):e.split(t,n):[]},Hi.spread=function(e,t){if("function"!=typeof e)throw new De(n);return t=null==t?0:Ht(Io(t),0),er((function(i){var n=i[t],r=br(i,0,t);return n&&Ut(r,n),wt(e,this,r)}))},Hi.tail=function(e){var t=null==e?0:e.length;return t?or(e,1,t):[]},Hi.take=function(e,t,n){return e&&e.length?or(e,0,(t=n||t===i?1:Io(t))<0?0:t):[]},Hi.takeRight=function(e,t,n){var r=null==e?0:e.length;return r?or(e,(t=r-(t=n||t===i?1:Io(t)))<0?0:t,r):[]},Hi.takeRightWhile=function(e,t){return e&&e.length?Sr(e,fs(t,3),!1,!0):[]},Hi.takeWhile=function(e,t){return e&&e.length?Sr(e,fs(t,3)):[]},Hi.tap=function(e,t){return t(e),e},Hi.throttle=function(e,t,i){var r=!0,s=!0;if("function"!=typeof e)throw new De(n);return lo(i)&&(r="leading"in i?!!i.leading:r,s="trailing"in i?!!i.trailing:s),Ba(e,t,{leading:r,maxWait:t,trailing:s})},Hi.thru=Ea,Hi.toArray=Eo,Hi.toPairs=Jo,Hi.toPairsIn=Ko,Hi.toPath=function(e){return Za(e)?xt(e,Ws):vo(e)?[e]:kr(qs(wo(e)))},Hi.toPlainObject=Ro,Hi.transform=function(e,t,i){var n=Za(e),r=n||no(e)||yo(e);if(t=fs(t,4),null==i){var s=e&&e.constructor;i=r?n?new s:[]:lo(e)&&ao(s)?$i(Je(e)):{}}return(r?Mt:Tn)(e,(function(e,n,r){return t(i,e,n,r)})),i},Hi.unary=function(e){return xa(e,1)},Hi.union=da,Hi.unionBy=ha,Hi.unionWith=ua,Hi.uniq=function(e){return e&&e.length?pr(e):[]},Hi.uniqBy=function(e,t){return e&&e.length?pr(e,fs(t,2)):[]},Hi.uniqWith=function(e,t){return t="function"==typeof t?t:i,e&&e.length?pr(e,i,t):[]},Hi.unset=function(e,t){return null==e||mr(e,t)},Hi.unzip=ga,Hi.unzipWith=pa,Hi.update=function(e,t,i){return null==e?e:fr(e,t,Er(i))},Hi.updateWith=function(e,t,n,r){return r="function"==typeof r?r:i,null==e?e:fr(e,t,Er(n),r)},Hi.values=Yo,Hi.valuesIn=function(e){return null==e?[]:ii(e,$o(e))},Hi.without=ma,Hi.words=oc,Hi.wrap=function(e,t){return Wa(Er(t),e)},Hi.xor=fa,Hi.xorBy=Sa,Hi.xorWith=va,Hi.zip=ya,Hi.zipObject=function(e,t){return Cr(e||[],t||[],nn)},Hi.zipObjectDeep=function(e,t){return Cr(e||[],t||[],nr)},Hi.zipWith=Ca,Hi.entries=Jo,Hi.entriesIn=Ko,Hi.extend=Mo,Hi.extendWith=Do,Sc(Hi,Hi),Hi.add=Rc,Hi.attempt=cc,Hi.camelCase=Qo,Hi.capitalize=Xo,Hi.ceil=wc,Hi.clamp=function(e,t,n){return n===i&&(n=t,t=i),n!==i&&(n=(n=Ao(n))==n?n:0),t!==i&&(t=(t=Ao(t))==t?t:0),ln(Ao(e),t,n)},Hi.clone=function(e){return dn(e,4)},Hi.cloneDeep=function(e){return dn(e,5)},Hi.cloneDeepWith=function(e,t){return dn(e,5,t="function"==typeof t?t:i)},Hi.cloneWith=function(e,t){return dn(e,4,t="function"==typeof t?t:i)},Hi.conformsTo=function(e,t){return null==t||hn(e,t,Ho(t))},Hi.deburr=Zo,Hi.defaultTo=function(e,t){return null==e||e!=e?t:e},Hi.divide=Pc,Hi.endsWith=function(e,t,n){e=wo(e),t=gr(t);var r=e.length,s=n=n===i?r:ln(Io(n),0,r);return(n-=t.length)>=0&&e.slice(n,s)==t},Hi.eq=Ka,Hi.escape=function(e){return(e=wo(e))&&X.test(e)?e.replace(Y,oi):e},Hi.escapeRegExp=function(e){return(e=wo(e))&&ae.test(e)?e.replace(se,"\\$&"):e},Hi.every=function(e,t,n){var r=Za(e)?Ot:fn;return n&&Rs(e,t,n)&&(t=i),r(e,fs(t,3))},Hi.find=ba,Hi.findIndex=Xs,Hi.findKey=function(e,t){return Gt(e,fs(t,3),Tn)},Hi.findLast=Aa,Hi.findLastIndex=Zs,Hi.findLastKey=function(e,t){return Gt(e,fs(t,3),In)},Hi.floor=Mc,Hi.forEach=Ra,Hi.forEachRight=wa,Hi.forIn=function(e,t){return null==e?e:_n(e,fs(t,3),$o)},Hi.forInRight=function(e,t){return null==e?e:En(e,fs(t,3),$o)},Hi.forOwn=function(e,t){return e&&Tn(e,fs(t,3))},Hi.forOwnRight=function(e,t){return e&&In(e,fs(t,3))},Hi.get=xo,Hi.gt=Ya,Hi.gte=Qa,Hi.has=function(e,t){return null!=e&&Ts(e,t,Mn)},Hi.hasIn=Uo,Hi.head=ta,Hi.identity=gc,Hi.includes=function(e,t,i,n){e=to(e)?e:Yo(e),i=i&&!n?Io(i):0;var r=e.length;return i<0&&(i=Ht(r+i,0)),So(e)?i<=r&&e.indexOf(t,i)>-1:!!r&&qt(e,t,i)>-1},Hi.indexOf=function(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var r=null==i?0:Io(i);return r<0&&(r=Ht(n+r,0)),qt(e,t,r)},Hi.inRange=function(e,t,n){return t=To(t),n===i?(n=t,t=0):n=To(n),function(e,t,i){return e>=Yt(t,i)&&e<Ht(t,i)}(e=Ao(e),t,n)},Hi.invoke=Bo,Hi.isArguments=Xa,Hi.isArray=Za,Hi.isArrayBuffer=eo,Hi.isArrayLike=to,Hi.isArrayLikeObject=io,Hi.isBoolean=function(e){return!0===e||!1===e||ho(e)&&wn(e)==_},Hi.isBuffer=no,Hi.isDate=ro,Hi.isElement=function(e){return ho(e)&&1===e.nodeType&&!po(e)},Hi.isEmpty=function(e){if(null==e)return!0;if(to(e)&&(Za(e)||"string"==typeof e||"function"==typeof e.splice||no(e)||yo(e)||Xa(e)))return!e.length;var t=Es(e);if(t==A||t==D)return!e.size;if(Ds(e))return!Vn(e).length;for(var i in e)if(Ue.call(e,i))return!1;return!0},Hi.isEqual=function(e,t){return Ln(e,t)},Hi.isEqualWith=function(e,t,n){var r=(n="function"==typeof n?n:i)?n(e,t):i;return r===i?Ln(e,t,i,n):!!r},Hi.isError=so,Hi.isFinite=function(e){return"number"==typeof e&&vt(e)},Hi.isFunction=ao,Hi.isInteger=oo,Hi.isLength=co,Hi.isMap=uo,Hi.isMatch=function(e,t){return e===t||xn(e,t,vs(t))},Hi.isMatchWith=function(e,t,n){return n="function"==typeof n?n:i,xn(e,t,vs(t),n)},Hi.isNaN=function(e){return go(e)&&e!=+e},Hi.isNative=function(e){if(Ms(e))throw new be("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return Un(e)},Hi.isNil=function(e){return null==e},Hi.isNull=function(e){return null===e},Hi.isNumber=go,Hi.isObject=lo,Hi.isObjectLike=ho,Hi.isPlainObject=po,Hi.isRegExp=mo,Hi.isSafeInteger=function(e){return oo(e)&&e>=-g&&e<=g},Hi.isSet=fo,Hi.isString=So,Hi.isSymbol=vo,Hi.isTypedArray=yo,Hi.isUndefined=function(e){return e===i},Hi.isWeakMap=function(e){return ho(e)&&Es(e)==N},Hi.isWeakSet=function(e){return ho(e)&&"[object WeakSet]"==wn(e)},Hi.join=function(e,t){return null==e?"":Ct.call(e,t)},Hi.kebabCase=ec,Hi.last=sa,Hi.lastIndexOf=function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var s=r;return n!==i&&(s=(s=Io(n))<0?Ht(r+s,0):Yt(s,r-1)),t==t?function(e,t,i){for(var n=i+1;n--;)if(e[n]===t)return n;return n}(e,t,s):jt(e,zt,s,!0)},Hi.lowerCase=tc,Hi.lowerFirst=ic,Hi.lt=Co,Hi.lte=_o,Hi.max=function(e){return e&&e.length?Sn(e,gc,Pn):i},Hi.maxBy=function(e,t){return e&&e.length?Sn(e,fs(t,2),Pn):i},Hi.mean=function(e){return Jt(e,gc)},Hi.meanBy=function(e,t){return Jt(e,fs(t,2))},Hi.min=function(e){return e&&e.length?Sn(e,gc,Hn):i},Hi.minBy=function(e,t){return e&&e.length?Sn(e,fs(t,2),Hn):i},Hi.stubArray=bc,Hi.stubFalse=Ac,Hi.stubObject=function(){return{}},Hi.stubString=function(){return""},Hi.stubTrue=function(){return!0},Hi.multiply=Oc,Hi.nth=function(e,t){return e&&e.length?Wn(e,Io(t)):i},Hi.noConflict=function(){return ft._===this&&(ft._=$e),this},Hi.noop=vc,Hi.now=La,Hi.pad=function(e,t,i){e=wo(e);var n=(t=Io(t))?mi(e):0;if(!t||n>=t)return e;var r=(t-n)/2;return Kr(pt(r),i)+e+Kr(ht(r),i)},Hi.padEnd=function(e,t,i){e=wo(e);var n=(t=Io(t))?mi(e):0;return t&&n<t?e+Kr(t-n,i):e},Hi.padStart=function(e,t,i){e=wo(e);var n=(t=Io(t))?mi(e):0;return t&&n<t?Kr(t-n,i)+e:e},Hi.parseInt=function(e,t,i){return i||null==t?t=0:t&&(t=+t),Ei(wo(e).replace(oe,""),t||0)},Hi.random=function(e,t,n){if(n&&"boolean"!=typeof n&&Rs(e,t,n)&&(t=n=i),n===i&&("boolean"==typeof t?(n=t,t=i):"boolean"==typeof e&&(n=e,e=i)),e===i&&t===i?(e=0,t=1):(e=To(e),t===i?(t=e,e=0):t=To(t)),e>t){var r=e;e=t,t=r}if(n||e%1||t%1){var s=Ti();return Yt(e+s*(t-e+ut("1e-"+((s+"").length-1))),t)}return Qn(e,t)},Hi.reduce=function(e,t,i){var n=Za(e)?Ft:Qt,r=arguments.length<3;return n(e,fs(t,4),i,r,pn)},Hi.reduceRight=function(e,t,i){var n=Za(e)?Vt:Qt,r=arguments.length<3;return n(e,fs(t,4),i,r,mn)},Hi.repeat=function(e,t,n){return t=(n?Rs(e,t,n):t===i)?1:Io(t),Zn(wo(e),t)},Hi.replace=function(){var e=arguments,t=wo(e[0]);return e.length<3?t:t.replace(e[1],e[2])},Hi.result=function(e,t,n){var r=-1,s=(t=Tr(t,e)).length;for(s||(s=1,e=i);++r<s;){var a=null==e?i:e[Ws(t[r])];a===i&&(r=s,a=n),e=ao(a)?a.call(e):a}return e},Hi.round=kc,Hi.runInContext=e,Hi.sample=function(e){return(Za(e)?Xi:tr)(e)},Hi.size=function(e){if(null==e)return 0;if(to(e))return So(e)?mi(e):e.length;var t=Es(e);return t==A||t==D?e.size:Vn(e).length},Hi.snakeCase=nc,Hi.some=function(e,t,n){var r=Za(e)?Bt:cr;return n&&Rs(e,t,n)&&(t=i),r(e,fs(t,3))},Hi.sortedIndex=function(e,t){return lr(e,t)},Hi.sortedIndexBy=function(e,t,i){return dr(e,t,fs(i,2))},Hi.sortedIndexOf=function(e,t){var i=null==e?0:e.length;if(i){var n=lr(e,t);if(n<i&&Ka(e[n],t))return n}return-1},Hi.sortedLastIndex=function(e,t){return lr(e,t,!0)},Hi.sortedLastIndexBy=function(e,t,i){return dr(e,t,fs(i,2),!0)},Hi.sortedLastIndexOf=function(e,t){if(null!=e&&e.length){var i=lr(e,t,!0)-1;if(Ka(e[i],t))return i}return-1},Hi.startCase=rc,Hi.startsWith=function(e,t,i){return e=wo(e),i=null==i?0:ln(Io(i),0,e.length),t=gr(t),e.slice(i,i+t.length)==t},Hi.subtract=Nc,Hi.sum=function(e){return e&&e.length?Xt(e,gc):0},Hi.sumBy=function(e,t){return e&&e.length?Xt(e,fs(t,2)):0},Hi.template=function(e,t,n){var r=Hi.templateSettings;n&&Rs(e,t,n)&&(t=i),e=wo(e),t=Do({},t,r,rs);var s,a,o=Do({},t.imports,r.imports,rs),c=Ho(o),l=ii(o,c),d=0,h=t.interpolate||Te,u="__p += '",g=Pe((t.escape||Te).source+"|"+h.source+"|"+(h===te?me:Te).source+"|"+(t.evaluate||Te).source+"|$","g"),p="//# sourceURL="+(Ue.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++ct+"]")+"\n";e.replace(g,(function(t,i,n,r,o,c){return n||(n=r),u+=e.slice(d,c).replace(Ie,ci),i&&(s=!0,u+="' +\n__e("+i+") +\n'"),o&&(a=!0,u+="';\n"+o+";\n__p += '"),n&&(u+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),d=c+t.length,t})),u+="';\n";var m=Ue.call(t,"variable")&&t.variable;if(m){if(ge.test(m))throw new be("Invalid `variable` option passed into `_.template`")}else u="with (obj) {\n"+u+"\n}\n";u=(a?u.replace(W,""):u).replace(z,"$1").replace(J,"$1;"),u="function("+(m||"obj")+") {\n"+(m?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(s?", __e = _.escape":"")+(a?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+u+"return __p\n}";var f=cc((function(){return Ae(c,p+"return "+u).apply(i,l)}));if(f.source=u,so(f))throw f;return f},Hi.times=function(e,t){if((e=Io(e))<1||e>g)return[];var i=m,n=Yt(e,m);t=fs(t),e-=m;for(var r=Zt(n,t);++i<e;)t(i);return r},Hi.toFinite=To,Hi.toInteger=Io,Hi.toLength=bo,Hi.toLower=function(e){return wo(e).toLowerCase()},Hi.toNumber=Ao,Hi.toSafeInteger=function(e){return e?ln(Io(e),-g,g):0===e?e:0},Hi.toString=wo,Hi.toUpper=function(e){return wo(e).toUpperCase()},Hi.trim=function(e,t,n){if((e=wo(e))&&(n||t===i))return ei(e);if(!e||!(t=gr(t)))return e;var r=fi(e),s=fi(t);return br(r,ri(r,s),si(r,s)+1).join("")},Hi.trimEnd=function(e,t,n){if((e=wo(e))&&(n||t===i))return e.slice(0,Si(e)+1);if(!e||!(t=gr(t)))return e;var r=fi(e);return br(r,0,si(r,fi(t))+1).join("")},Hi.trimStart=function(e,t,n){if((e=wo(e))&&(n||t===i))return e.replace(oe,"");if(!e||!(t=gr(t)))return e;var r=fi(e);return br(r,ri(r,fi(t))).join("")},Hi.truncate=function(e,t){var n=30,r="...";if(lo(t)){var s="separator"in t?t.separator:s;n="length"in t?Io(t.length):n,r="omission"in t?gr(t.omission):r}var a=(e=wo(e)).length;if(li(e)){var o=fi(e);a=o.length}if(n>=a)return e;var c=n-mi(r);if(c<1)return r;var l=o?br(o,0,c).join(""):e.slice(0,c);if(s===i)return l+r;if(o&&(c+=l.length-c),mo(s)){if(e.slice(c).search(s)){var d,h=l;for(s.global||(s=Pe(s.source,wo(fe.exec(s))+"g")),s.lastIndex=0;d=s.exec(h);)var u=d.index;l=l.slice(0,u===i?c:u)}}else if(e.indexOf(gr(s),c)!=c){var g=l.lastIndexOf(s);g>-1&&(l=l.slice(0,g))}return l+r},Hi.unescape=function(e){return(e=wo(e))&&Q.test(e)?e.replace(K,vi):e},Hi.uniqueId=function(e){var t=++Fe;return wo(e)+t},Hi.upperCase=sc,Hi.upperFirst=ac,Hi.each=Ra,Hi.eachRight=wa,Hi.first=ta,Sc(Hi,(Dc={},Tn(Hi,(function(e,t){Ue.call(Hi.prototype,t)||(Dc[t]=e)})),Dc),{chain:!1}),Hi.VERSION="4.17.21",Mt(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(e){Hi[e].placeholder=Hi})),Mt(["drop","take"],(function(e,t){qi.prototype[e]=function(n){n=n===i?1:Ht(Io(n),0);var r=this.__filtered__&&!t?new qi(this):this.clone();return r.__filtered__?r.__takeCount__=Yt(n,r.__takeCount__):r.__views__.push({size:Yt(n,m),type:e+(r.__dir__<0?"Right":"")}),r},qi.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),Mt(["filter","map","takeWhile"],(function(e,t){var i=t+1,n=1==i||3==i;qi.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:fs(e,3),type:i}),t.__filtered__=t.__filtered__||n,t}})),Mt(["head","last"],(function(e,t){var i="take"+(t?"Right":"");qi.prototype[e]=function(){return this[i](1).value()[0]}})),Mt(["initial","tail"],(function(e,t){var i="drop"+(t?"":"Right");qi.prototype[e]=function(){return this.__filtered__?new qi(this):this[i](1)}})),qi.prototype.compact=function(){return this.filter(gc)},qi.prototype.find=function(e){return this.filter(e).head()},qi.prototype.findLast=function(e){return this.reverse().find(e)},qi.prototype.invokeMap=er((function(e,t){return"function"==typeof e?new qi(this):this.map((function(i){return kn(i,e,t)}))})),qi.prototype.reject=function(e){return this.filter(ja(fs(e)))},qi.prototype.slice=function(e,t){e=Io(e);var n=this;return n.__filtered__&&(e>0||t<0)?new qi(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==i&&(n=(t=Io(t))<0?n.dropRight(-t):n.take(t-e)),n)},qi.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},qi.prototype.toArray=function(){return this.take(m)},Tn(qi.prototype,(function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),r=/^(?:head|last)$/.test(t),s=Hi[r?"take"+("last"==t?"Right":""):t],a=r||/^find/.test(t);s&&(Hi.prototype[t]=function(){var t=this.__wrapped__,o=r?[1]:arguments,c=t instanceof qi,l=o[0],d=c||Za(t),h=function(e){var t=s.apply(Hi,Ut([e],o));return r&&u?t[0]:t};d&&n&&"function"==typeof l&&1!=l.length&&(c=d=!1);var u=this.__chain__,g=!!this.__actions__.length,p=a&&!u,m=c&&!g;if(!a&&d){t=m?t:new qi(this);var f=e.apply(t,o);return f.__actions__.push({func:Ea,args:[h],thisArg:i}),new ji(f,u)}return p&&m?e.apply(this,o):(f=this.thru(h),p?r?f.value()[0]:f.value():f)})})),Mt(["pop","push","shift","sort","splice","unshift"],(function(e){var t=Oe[e],i=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",n=/^(?:pop|shift)$/.test(e);Hi.prototype[e]=function(){var e=arguments;if(n&&!this.__chain__){var r=this.value();return t.apply(Za(r)?r:[],e)}return this[i]((function(i){return t.apply(Za(i)?i:[],e)}))}})),Tn(qi.prototype,(function(e,t){var i=Hi[t];if(i){var n=i.name+"";Ue.call(Oi,n)||(Oi[n]=[]),Oi[n].push({name:t,func:i})}})),Oi[qr(i,2).name]=[{name:"wrapper",func:i}],qi.prototype.clone=function(){var e=new qi(this.__wrapped__);return e.__actions__=kr(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=kr(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=kr(this.__views__),e},qi.prototype.reverse=function(){if(this.__filtered__){var e=new qi(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},qi.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,i=Za(e),n=t<0,r=i?e.length:0,s=function(e,t,i){for(var n=-1,r=i.length;++n<r;){var s=i[n],a=s.size;switch(s.type){case"drop":e+=a;break;case"dropRight":t-=a;break;case"take":t=Yt(t,e+a);break;case"takeRight":e=Ht(e,t-a)}}return{start:e,end:t}}(0,r,this.__views__),a=s.start,o=s.end,c=o-a,l=n?o:a-1,d=this.__iteratees__,h=d.length,u=0,g=Yt(c,this.__takeCount__);if(!i||!n&&r==c&&g==c)return vr(e,this.__actions__);var p=[];e:for(;c--&&u<g;){for(var m=-1,f=e[l+=t];++m<h;){var S=d[m],v=S.iteratee,y=S.type,C=v(f);if(2==y)f=C;else if(!C){if(1==y)continue e;break e}}p[u++]=f}return p},Hi.prototype.at=Ta,Hi.prototype.chain=function(){return _a(this)},Hi.prototype.commit=function(){return new ji(this.value(),this.__chain__)},Hi.prototype.next=function(){this.__values__===i&&(this.__values__=Eo(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?i:this.__values__[this.__index__++]}},Hi.prototype.plant=function(e){for(var t,n=this;n instanceof Gi;){var r=Js(n);r.__index__=0,r.__values__=i,t?s.__wrapped__=r:t=r;var s=r;n=n.__wrapped__}return s.__wrapped__=e,t},Hi.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof qi){var t=e;return this.__actions__.length&&(t=new qi(this)),(t=t.reverse()).__actions__.push({func:Ea,args:[la],thisArg:i}),new ji(t,this.__chain__)}return this.thru(la)},Hi.prototype.toJSON=Hi.prototype.valueOf=Hi.prototype.value=function(){return vr(this.__wrapped__,this.__actions__)},Hi.prototype.first=Hi.prototype.head,Ze&&(Hi.prototype[Ze]=function(){return this}),Hi}();vt?((vt.exports=Ci)._=Ci,St._=Ci):ft._=Ci}).call(s)})),m=a((function(e,t){var i=window;!function(t,i){e.exports=i()}(0,((e,t)=>{var n={},r={exports:n},s=Object.create,a=Object.defineProperty,o=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyNames,l=Object.getPrototypeOf,d=Object.prototype.hasOwnProperty,h=(e,t)=>function(){return t||(0,e[c(e)[0]])((t={exports:{}}).exports,t),t.exports},u=(e,t)=>{for(var i in t)a(e,i,{get:t[i],enumerable:!0})},m=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of c(t))d.call(e,r)||r===i||a(e,r,{get:()=>t[r],enumerable:!(n=o(t,r))||n.enumerable});return e},f=(e,t,i)=>(i=null!=e?s(l(e)):{},m(!t&&e&&e.__esModule?i:a(i,"default",{value:e,enumerable:!0}),e)),S=(e,t,i,n)=>{for(var r,s=n>1?void 0:n?o(t,i):t,c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n?r(t,i,s):r(s))||s);return n&&s&&a(t,i,s),s},v=(e,t)=>(i,n)=>t(i,n,e),y=h({"../node_modules/axios/lib/helpers/bind.js"(e,t){t.exports=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}}}}),C=h({"../node_modules/axios/lib/utils.js"(e,t){var i=y(),n=Object.prototype.toString;function r(e){return"[object Array]"===n.call(e)}function s(e){return void 0===e}function a(e){return null!==e&&"object"==typeof e}function o(e){return"[object Function]"===n.call(e)}function c(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),r(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.call(null,e[s],s,e)}t.exports={isArray:r,isArrayBuffer:function(e){return"[object ArrayBuffer]"===n.call(e)},isBuffer:function(e){return null!==e&&!s(e)&&null!==e.constructor&&!s(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:a,isUndefined:s,isDate:function(e){return"[object Date]"===n.call(e)},isFile:function(e){return"[object File]"===n.call(e)},isBlob:function(e){return"[object Blob]"===n.call(e)},isFunction:o,isStream:function(e){return a(e)&&o(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:c,merge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]=i}for(var n=0,r=arguments.length;n<r;n++)c(arguments[n],i);return t},deepMerge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]="object"==typeof i?e({},i):i}for(var n=0,r=arguments.length;n<r;n++)c(arguments[n],i);return t},extend:function(e,t,n){return c(t,(function(t,r){e[r]=n&&"function"==typeof t?i(t,n):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}}}}),_=h({"../node_modules/axios/lib/helpers/buildURL.js"(e,t){var i=C();function n(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}t.exports=function(e,t,r){if(!t)return e;var s;if(r)s=r(t);else if(i.isURLSearchParams(t))s=t.toString();else{var a=[];i.forEach(t,(function(e,t){null!=e&&(i.isArray(e)?t+="[]":e=[e],i.forEach(e,(function(e){i.isDate(e)?e=e.toISOString():i.isObject(e)&&(e=JSON.stringify(e)),a.push(n(t)+"="+n(e))})))})),s=a.join("&")}if(s){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}}}),E=h({"../node_modules/axios/lib/core/InterceptorManager.js"(e,t){var i=C();function n(){this.handlers=[]}n.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},n.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},n.prototype.forEach=function(e){i.forEach(this.handlers,(function(t){null!==t&&e(t)}))},t.exports=n}}),T=h({"../node_modules/axios/lib/core/transformData.js"(e,t){var i=C();t.exports=function(e,t,n){return i.forEach(n,(function(i){e=i(e,t)})),e}}}),I=h({"../node_modules/axios/lib/cancel/isCancel.js"(e,t){t.exports=function(e){return!(!e||!e.__CANCEL__)}}}),b=h({"../node_modules/axios/lib/helpers/normalizeHeaderName.js"(e,t){var i=C();t.exports=function(e,t){i.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))}}}),A=h({"../node_modules/axios/lib/core/enhanceError.js"(e,t){t.exports=function(e,t,i,n,r){return e.config=t,i&&(e.code=i),e.request=n,e.response=r,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}}}),R=h({"../node_modules/axios/lib/core/createError.js"(e,t){var i=A();t.exports=function(e,t,n,r,s){var a=new Error(e);return i(a,t,n,r,s)}}}),w=h({"../node_modules/axios/lib/core/settle.js"(e,t){var i=R();t.exports=function(e,t,n){var r=n.config.validateStatus;!r||r(n.status)?e(n):t(i("Request failed with status code "+n.status,n.config,null,n.request,n))}}}),P=h({"../node_modules/axios/lib/helpers/isAbsoluteURL.js"(e,t){t.exports=function(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)}}}),M=h({"../node_modules/axios/lib/helpers/combineURLs.js"(e,t){t.exports=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}}}),D=h({"../node_modules/axios/lib/core/buildFullPath.js"(e,t){var i=P(),n=M();t.exports=function(e,t){return e&&!i(t)?n(e,t):t}}}),O=h({"../node_modules/axios/lib/helpers/parseHeaders.js"(e,t){var i=C(),n=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];t.exports=function(e){var t,r,s,a={};return e?(i.forEach(e.split("\n"),(function(e){if(s=e.indexOf(":"),t=i.trim(e.substr(0,s)).toLowerCase(),r=i.trim(e.substr(s+1)),t){if(a[t]&&n.indexOf(t)>=0)return;a[t]="set-cookie"===t?(a[t]?a[t]:[]).concat([r]):a[t]?a[t]+", "+r:r}})),a):a}}}),k=h({"../node_modules/axios/lib/helpers/isValidXss.js"(e,t){t.exports=function(e){return/(\b)(on\w+)=|javascript|(<\s*)(\/*)script/gi.test(e)}}}),N=h({"../node_modules/axios/lib/helpers/isURLSameOrigin.js"(e,t){var i=C(),n=k();t.exports=i.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function s(e){var i=e;if(n(e))throw new Error("URL contains XSS injection attempt");return t&&(r.setAttribute("href",i),i=r.href),r.setAttribute("href",i),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return e=s(window.location.href),function(t){var n=i.isString(t)?s(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0}}}),L=h({"../node_modules/axios/lib/helpers/cookies.js"(e,t){var i=C();t.exports=i.isStandardBrowserEnv()?{write:function(e,t,n,r,s,a){var o=[];o.push(e+"="+encodeURIComponent(t)),i.isNumber(n)&&o.push("expires="+new Date(n).toGMTString()),i.isString(r)&&o.push("path="+r),i.isString(s)&&o.push("domain="+s),!0===a&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}}}}),x=h({"../node_modules/axios/lib/adapters/xhr.js"(e,t){var i=C(),n=w(),r=_(),s=D(),a=O(),o=N(),c=R();t.exports=function(e){return new Promise((function(t,l){var d=e.data,h=e.headers;i.isFormData(d)&&delete h["Content-Type"];var u=new XMLHttpRequest;if(e.auth){var g=e.auth.username||"",p=e.auth.password||"";h.Authorization="Basic "+btoa(g+":"+p)}var m=s(e.baseURL,e.url);if(u.open(e.method.toUpperCase(),r(m,e.params,e.paramsSerializer),!0),u.timeout=e.timeout,u.onreadystatechange=function(){if(u&&4===u.readyState&&(0!==u.status||u.responseURL&&0===u.responseURL.indexOf("file:"))){var i="getAllResponseHeaders"in u?a(u.getAllResponseHeaders()):null,r={data:e.responseType&&"text"!==e.responseType?u.response:u.responseText,status:u.status,statusText:u.statusText,headers:i,config:e,request:u};n(t,l,r),u=null}},u.onabort=function(){u&&(l(c("Request aborted",e,"ECONNABORTED",u)),u=null)},u.onerror=function(){l(c("Network Error",e,null,u)),u=null},u.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),l(c(t,e,"ECONNABORTED",u)),u=null},i.isStandardBrowserEnv()){var f=L(),S=(e.withCredentials||o(m))&&e.xsrfCookieName?f.read(e.xsrfCookieName):void 0;S&&(h[e.xsrfHeaderName]=S)}if("setRequestHeader"in u&&i.forEach(h,(function(e,t){void 0===d&&"content-type"===t.toLowerCase()?delete h[t]:u.setRequestHeader(t,e)})),i.isUndefined(e.withCredentials)||(u.withCredentials=!!e.withCredentials),e.responseType)try{u.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&u.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&u.upload&&u.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){u&&(u.abort(),l(e),u=null)})),void 0===d&&(d=null),u.send(d)}))}}}),U=h({"../node_modules/axios/lib/defaults.js"(e,t){var i=C(),n=b(),r={"Content-Type":"application/x-www-form-urlencoded"};function s(e,t){!i.isUndefined(e)&&i.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var a={adapter:function(){var e;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(e=x()),e}(),transformRequest:[function(e,t){return n(t,"Accept"),n(t,"Content-Type"),i.isFormData(e)||i.isArrayBuffer(e)||i.isBuffer(e)||i.isStream(e)||i.isFile(e)||i.isBlob(e)?e:i.isArrayBufferView(e)?e.buffer:i.isURLSearchParams(e)?(s(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):i.isObject(e)?(s(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};i.forEach(["delete","get","head"],(function(e){a.headers[e]={}})),i.forEach(["post","put","patch"],(function(e){a.headers[e]=i.merge(r)})),t.exports=a}}),F=h({"../node_modules/axios/lib/core/dispatchRequest.js"(e,t){var i=C(),n=T(),r=I(),s=U();function a(e){e.cancelToken&&e.cancelToken.throwIfRequested()}t.exports=function(e){return a(e),e.headers=e.headers||{},e.data=n(e.data,e.headers,e.transformRequest),e.headers=i.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),i.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||s.adapter)(e).then((function(t){return a(e),t.data=n(t.data,t.headers,e.transformResponse),t}),(function(t){return r(t)||(a(e),t&&t.response&&(t.response.data=n(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))}}}),V=h({"../node_modules/axios/lib/core/mergeConfig.js"(e,t){var i=C();t.exports=function(e,t){t=t||{};var n={},r=["url","method","params","data"],s=["headers","auth","proxy"],a=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];i.forEach(r,(function(e){void 0!==t[e]&&(n[e]=t[e])})),i.forEach(s,(function(r){i.isObject(t[r])?n[r]=i.deepMerge(e[r],t[r]):void 0!==t[r]?n[r]=t[r]:i.isObject(e[r])?n[r]=i.deepMerge(e[r]):void 0!==e[r]&&(n[r]=e[r])})),i.forEach(a,(function(i){void 0!==t[i]?n[i]=t[i]:void 0!==e[i]&&(n[i]=e[i])}));var o=r.concat(s).concat(a),c=Object.keys(t).filter((function(e){return-1===o.indexOf(e)}));return i.forEach(c,(function(i){void 0!==t[i]?n[i]=t[i]:void 0!==e[i]&&(n[i]=e[i])})),n}}}),B=h({"../node_modules/axios/lib/core/Axios.js"(e,t){var i=C(),n=_(),r=E(),s=F(),a=V();function o(e){this.defaults=e,this.interceptors={request:new r,response:new r}}o.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=a(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[s,void 0],i=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)i=i.then(t.shift(),t.shift());return i},o.prototype.getUri=function(e){return e=a(this.defaults,e),n(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},i.forEach(["delete","get","head","options"],(function(e){o.prototype[e]=function(t,n){return this.request(i.merge(n||{},{method:e,url:t}))}})),i.forEach(["post","put","patch"],(function(e){o.prototype[e]=function(t,n,r){return this.request(i.merge(r||{},{method:e,url:t,data:n}))}})),t.exports=o}}),H=h({"../node_modules/axios/lib/cancel/Cancel.js"(e,t){function i(e){this.message=e}i.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},i.prototype.__CANCEL__=!0,t.exports=i}}),$=h({"../node_modules/axios/lib/cancel/CancelToken.js"(e,t){var i=H();function n(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var n=this;e((function(e){n.reason||(n.reason=new i(e),t(n.reason))}))}n.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},n.source=function(){var e;return{token:new n((function(t){e=t})),cancel:e}},t.exports=n}}),G=h({"../node_modules/axios/lib/helpers/spread.js"(e,t){t.exports=function(e){return function(t){return e.apply(null,t)}}}}),j=h({"../node_modules/axios/lib/axios.js"(e,t){var i=C(),n=y(),r=B(),s=V();function a(e){var t=new r(e),s=n(r.prototype.request,t);return i.extend(s,r.prototype,t),i.extend(s,t),s}var o=a(U());o.Axios=r,o.create=function(e){return a(s(o.defaults,e))},o.Cancel=H(),o.CancelToken=$(),o.isCancel=I(),o.all=function(e){return Promise.all(e)},o.spread=G(),t.exports=o,t.exports.default=o}}),q=h({"../node_modules/axios/index.js"(e,t){t.exports=j()}}),W=h({"../node_modules/@skype/hydra_player_hls_sdk/hydra_player_hls_sdk_bundle.js"(e,t){var i,n;i=e,n=function(){return e={458:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.LiveStreamStatistic=void 0;var r=i(844),s=i(68),a=i(329),o=function(){function e(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}return e.prototype.complete=function(){try{a.assert(this.startTime,"not started",this.stopCrash),a.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(e){if(this.name!==r.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==r.PlayerScenarioType.HlsKeyLoad)throw e}this.duration=Date.now()-this.startTime},e.prototype.fail=function(e){this.failReason=e,this.complete()},e.prototype.setDetail=function(e){this.details=e},e.prototype.getTelemetryEvent=function(){a.assert(this.startTime,"not started",this.stopCrash);var e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e},e.prototype.getName=function(){return this.name},e.prototype.getDuration=function(){var e;return null!==(e=this.duration)&&void 0!==e?e:0},e.prototype.getFailReason=function(){return this.failReason},e.prototype.getDetails=function(){return this.details},e.prototype.start=function(e){a.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),e&&(this.details=e)},e.prototype.updateDetails=function(e,t){if(this.details&&"object"==typeof this.details)for(var i=0;i<e.length;i++)this.details[e[i]]=t[i]},e}(),c=function(){function e(e,t,i,n,r){this.config=e,this.logFn=t,this.playerDiagnosticsLog=i,this.playerMetadata=n,this.hydraInitResult=r,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=e.maxPlayerExperimentalEvents||100,a.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e.prototype.registerStatsUpdated=function(e){var t=this;this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((function(i){var n,r=i,s=null!==(n=t.playerDiagnosticsLog[i])&&void 0!==n?n:[];if(Array.isArray(s)){s.push(e[r]);var a="memoryLog"===r&&s.length>t.maxPlayerMemoryTraceLogCount,o="memoryLog"!==r&&s.length>t.maxPlayerDiagnosticsCount;(a||o)&&s.splice(0,1)}else t.playerDiagnosticsLog[i]=e[r]}))},e.prototype.registerEventLoadAttempt=function(e,t){this.registerScenario(e,t)},e.prototype.registerEventLoadFailed=function(e,t){this.completeScenario(e,t)},e.prototype.registerEventLoadSucceeded=function(e,t){this.completeScenario(e,void 0,t),e===r.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e.prototype.registerSdnPluginLoadAttempt=function(e){this.registerScenario(r.PlayerScenarioType.SdnPluginLoad,JSON.stringify(e))},e.prototype.registerSdnPluginLoadFailed=function(e){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad,e)},e.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad)},e.prototype.registerStreamConnectionAttempt=function(e){this.registerScenario(r.PlayerScenarioType.StreamConnection,{streamUrl:e})},e.prototype.registerStreamConnectionSucceeded=function(e){var t=this.getScenario(r.PlayerScenarioType.StreamConnection);null==t||t.updateDetails(["results"],[a.stringifyObject(e)]),this.completeScenario(r.PlayerScenarioType.StreamConnection)},e.prototype.registerStreamConnectionFailed=function(e,t){var i=this.getScenario(r.PlayerScenarioType.StreamConnection);null==i||i.updateDetails(["results"],[a.stringifyObject(t)]),this.completeScenario(r.PlayerScenarioType.StreamConnection,e)},e.prototype.registerSetSourceAttempt=function(e,t,i){var n=e||"";i&&(n={src:e||"",isPrimary:a.stringifyObject(t),reason:i}),this.registerScenario(r.PlayerScenarioType.SetSource,n)},e.prototype.registerSetSourceSucceeded=function(e,t,i,n){var s=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(s,"no SetSource scenario to update details",this.stopCrash),null==s||s.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[e,a.stringifyObject(t),a.stringifyObject(i),a.stringifyObject(n)]),this.completeScenario(r.PlayerScenarioType.SetSource)},e.prototype.registerSetSourceFailed=function(e,t,i,n,s){var o=null!=t?t:"Failed to find stream url",c=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(c,"no SetSource scenario to update details",this.stopCrash),null==c||c.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[o,a.stringifyObject(i),a.stringifyObject(n),a.stringifyObject(s)]),this.completeScenario(r.PlayerScenarioType.SetSource,e)},e.prototype.registerPlayerDestroyed=function(e){this.registerScenario(r.PlayerScenarioType.Destroyed,e),this.completeScenario(r.PlayerScenarioType.Destroyed)},e.prototype.registerPlaybackStateChanged=function(e){e!==s.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?e!==s.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(r.TelemetryEventType.StateChanged,e)},e.prototype.registerHydraInputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraInputStateChanged,e,t)},e.prototype.registerHydraOutputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraOutputStateChanged,e,t)},e.prototype.registerPlaybackBuffering=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Buffering,e)},e.prototype.registerPlaybackError=function(e,t,i){this.registerPlaybackEvent(r.TelemetryEventType.Error,{errorType:e,details:t,errorSource:i})},e.prototype.registerIgnoredPlaybackError=function(e){this.registerPlaybackEvent(r.TelemetryEventType.IgnoredError,e)},e.prototype.registerDownloadBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedDownload,e)},e.prototype.registerStreamOptionsConfigured=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.StreamOptionsConfigured,e,t)},e.prototype.registerPlaybackBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedPlayback,e)},e.prototype.registerVolumeChange=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Volume,e)},e.prototype.getSnapshotReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents,s={};return this.currentPlayerDiagnosticSnapshot&&(s=this.filterAndPrepareTelemetry()),n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),s)},e.prototype.getReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents;return n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),this.getPlayerDiagnosticLog())},e.prototype.getHydraLoadEvent=function(){var e,t,i,n={name:r.PlayerScenarioType.LoadHydra,startTime:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initStartTime)||-1,duration:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initDuration)||0};(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)&&(n.failReason=this.hydraInitResult.errorMsg);var s=this.getHydraRuntimeDownloadDetails();return s&&(n.details=s),n},e.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var e=[],t=0,i=this.hydraInitResult.runtimeDownloadResults;t<i.length;t++){var n=i[t],r={success:n.success,url:n.url,startTime:n.startTime,duration:n.duration,trackingReference:n.trackingReference,timeTakenToDownloadScript:n.timeTakenToDownloadScript};n.errorMsg&&(r.errorMsg=n.errorMsg),e.push(r)}return a.stringifyObject(e)}return null},e.prototype.getTotalLoadEvent=function(){var e,t,i,n=this.playerEvents.find((function(e){return e.getName()===r.PlayerScenarioType.LoadPlayer})),s=(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initDuration)||0,a=(null==n?void 0:n.getDuration())||0,o=null==n?void 0:n.getFailReason(),c={name:r.PlayerScenarioType.Load,startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,duration:s+a};return(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)?c.failReason=this.hydraInitResult.errorMsg:o&&(c.failReason=o),c},e.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e.prototype.registerPlaybackEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);e===r.TelemetryEventType.Error&&(null==t?void 0:t.errorType)!==s.HydraPlayerPlaybackErrorType.PlaybackRetried&&(n.fatal=!0,this.callDropped=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getPlayerDiagnosticLog=function(){var e=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var t=this.currentPlayerDiagnosticSnapshot,i=this.playerDiagnosticsLog,r=n(n({},t),i),s={};return Object.keys(r).forEach((function(t){s["player_".concat(t)]=e.prepareForTelemetry(r[t])})),s},e.prototype.getHydraInitializationReport=function(){var e,t,i,n;return{hydraInit_succeeded:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initSucceeded)||!1,hydraInit_startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,hydraInit_errorMessage:(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)||"",hydraInit_duration:(null===(n=this.hydraInitResult)||void 0===n?void 0:n.initDuration)||0}},e.prototype.getPlayerInitializationReport=function(e,t){var i=e.find((function(e){return e.name===r.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(null!=i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(null!=i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}},e.prototype.getHydraInternalReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraInputStateChanged})),i=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(t),hydra_outputStateChangeEvents:this.prepareForTelemetry(i)}},e.prototype.getPlaybackReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.StateChanged})),i=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.CanPlayThrough})),n=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Play})),a=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Start})),o=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Playing})),c=null!=i&&null!=n?n.timestamp-i.timestamp:-1,l=null!=n&&null!=a?a.timestamp-n.timestamp:-1,d=null!=a&&null!=o?o.timestamp-a.timestamp:-1,h=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeked})),u=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeking})),g=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Pause})),p=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Waiting})),m=[r.TelemetryEventType.BitrateChangedDownload,r.TelemetryEventType.BitrateChangedPlayback,r.TelemetryEventType.Error,r.TelemetryEventType.Mute,r.TelemetryEventType.StateChanged,r.TelemetryEventType.Volume,r.TelemetryEventType.StreamOptionsConfigured,r.TelemetryEventType.IgnoredError],f=e.filter((function(e){return e.eventType===r.TelemetryEventType.Error})),S=e.filter((function(e){return e.eventType===r.TelemetryEventType.IgnoredError})),v=e.filter((function(e){return e.eventType===r.TelemetryEventType.Volume||e.eventType===r.TelemetryEventType.Mute})),y=e.filter((function(e){return e.eventType===r.TelemetryEventType.StreamOptionsConfigured})),C=e.filter((function(e){return!m.includes(e.eventType)}));return{playback_timeReadyToPlay:c,playback_timePlayToStart:l,playback_timeStartToPlaying:d,playback_bufferingEvents:this.prepareForTelemetry(p),playback_errorEvents:this.prepareForTelemetry(f),playback_ignoredErrorEvents:this.prepareForTelemetry(S),playback_pauseEvents:this.prepareForTelemetry(g),playback_otherEvents:this.prepareForTelemetry(C),playback_seekedEvents:this.prepareForTelemetry(h),playback_seekingEvents:this.prepareForTelemetry(u),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(v),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(y)}},e.prototype.getBitrateReport=function(e){var t,i,s,a,o=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedDownload})),c=o.sort((function(e){return Number(e.payload)})),l=o.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(o),bitrate_downloadChangeCount:o.length>0||-1,bitrate_downloadMin:(null===(t=c[0])||void 0===t?void 0:t.payload)||-1,bitrate_downloadMax:(null===(i=c[c.length-1])||void 0===i?void 0:i.payload)||-1}:{},d=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedPlayback})),h=d.sort((function(e){return Number(e.payload)})),u=d.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(d),bitrate_playbackChangeCount:d.length>0||-1,bitrate_playbackMin:(null===(s=h[0])||void 0===s?void 0:s.payload)||-1,bitrate_playbackMax:(null===(a=h[h.length-1])||void 0===a?void 0:a.payload)||-1}:{};return n(n({},l),u)},e.prototype.addNetworkTypeEventListener=function(){var e,t,i,n,r=this;(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)&&(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n||n.addEventListener("change",(function(){r.updateClientNetworkType()})))},e.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e.prototype.getClientNetworkType=function(){var e,t,i,n;if(void 0===this.clientNetworkType){var r="Unknown";if(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)switch(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n?void 0:n.type){case"cellular":r="WWAN";break;case"ethernet":r="Wired";break;case"wifi":r="Wireless";break;default:r="Unknown"}this.clientNetworkType=r}return this.clientNetworkType},e.prototype.getSdnReport=function(e){var t,i,n=e.filter((function(e){return e.name===r.PlayerScenarioType.SdnPluginLoad})),s=n.length>0?n[n.length-1]:void 0;return{sdn_loaded:!(null==s||void 0!==s.failReason),sdn_details:null!==(t=null==s?void 0:s.details)&&void 0!==t?t:"",sdn_error:null!==(i=null==s?void 0:s.failReason)&&void 0!==i?i:"",sdn_events:this.prepareForTelemetry(n)}},e.prototype.getStreamConnectionReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(t)}},e.prototype.getSetSourceReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(t)}},e.prototype.registerScenario=function(e,t){var i=this.currentScenarioMap.get(e),n=new o(e,this.stopCrash,t);try{a.assert(null==i,"previous scenario:".concat(a.stringifyObject(i)," is not completed, new scenario:").concat(a.stringifyObject(n)),this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}this.currentScenarioMap.set(e,n),this.playerEvents.push(n)},e.prototype.completeScenario=function(e,t,i){var n=this.currentScenarioMap.get(e);try{a.assert(n,"no scenario to complete",this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}t?null==n||n.fail(t):(e!==r.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(null==n||n.setDetail(i)),null==n||n.complete()),this.currentScenarioMap.delete(e)},e.prototype.logTelemetryEvent=function(e){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(e))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e.prototype.filterAndPrepareTelemetry=function(){var e=this,t=new Set;t.add("serviceLatencyCdg"),t.add("endToEndLatencyCdg"),t.add("videoEdgeLatencyCdg");var i={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(n){t.has(n)||(i["player_".concat(n)]=e.prepareForTelemetry(e.currentPlayerDiagnosticSnapshot[n]))})),i},e.prototype.prepareForTelemetry=function(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?null!=e?e:-1:JSON.stringify(e)},e.prototype.getScenario=function(e){return this.currentScenarioMap.get(e)},e.prototype.createTelemetryEvent=function(e,t,i){var n,r,s={eventType:e,timestamp:Date.now(),currentPlayPosition:null!==(r=null===(n=this.currentPlayerDiagnosticSnapshot)||void 0===n?void 0:n.currentPlayPosition)&&void 0!==r?r:-1};return void 0!==t&&(s.payload=this.prepareForTelemetry(t)),s.message=i,s},e.prototype.registerExperimentalEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e}();t.LiveStreamStatistic=c},751:function(e,t){var i,n,r,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(o=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",o.HLS="MiddleLaneHttpLiveStreaming",o.Ums="MiddleLaneUltraLowLatency",(a=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",a.PlayerInitializationFailed="PlayerInitializationFailed",a.InvalidStream="InvalidStream",a.SetSourceFailed="SetSourceFailed",(s=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",s.LoadedData="loadeddata",s.LoadedMetadata="loadedmetadata",s.Start="start",s.CanPlayThrough="canplaythrough",s.Play="play",s.Playing="playing",s.Pause="pause",s.Waiting="waiting",s.Seeking="seeking",s.Seeked="seeked",s.Ended="ended",s.Error="error",s.Destroyed="destroyed",s.Initialized="initialized",s.Stalled="stalled",s.VolumeChange="volumechange",s.PlaybackBitrateChanged="playbackbitratechanged",s.DownloadBitrateChanged="downloadbitratechanged",s.HlsKeyLoading="hlsKeyLoading",s.HlsKeyLoaded="hlsKeyLoaded",s.HlsKeyLoadedFailed="hlsKeyLoadedFailed",s.HlsManifestLoading="hlsManifestLoading",s.HlsManifestLoaded="hlsManifestLoaded",s.HlsManifestLoadedFailed="hlsManifestLoadedFailed",s.HlsFirstFragmentLoading="hlsFragLoading",s.HlsFirstFragmentBuffered="hlsFragBuffered",s.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",s.Online="online",s.Offline="offline",s.NetworkChange="networkChange",(r=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",r.NetworkError="NetworkError",r.PlaybackRetried="PlaybackRetried",r.PlaybackError="PlaybackError",r.Unknown="Unknown",(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},855:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),r(i(952),t),r(i(751),t)},952:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)},r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},a=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,s=t.length;r<s;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.HlsHydraPlayer=t.getSdkVersion=void 0;var o=i(124),c=i(68),l=i(328),d=i(844),h=i(944),u=i(329),g=i(63),p=i(458);t.getSdkVersion=function(){return"4.2488.1"};var m=function(){function e(e,t){this.playerSettings=e,this.eventHandler=t,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2488.1"}return Object.defineProperty(e.prototype,"contextWindow",{get:function(){var e;return null===(e=this.container)||void 0===e?void 0:e.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var e=(0,u.getMajorFromVersion)("4.2488.1");return e&&this.playerSettings.playerRuntimeJsUrls[e]||[]}return this.playerSettings.playerRuntimeJsUrls},e.prototype.initializeIFrame=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.container=e,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2488.1",', URLs: "').concat((0,u.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,u.createIFrame)(e,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(t=i.sent()).initResult.initSucceeded&&t.iframe&&(this.iframe=t.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,t.initResult]}}))}))},e.prototype.setup=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.spinner=new u.Spinner(e),[4,this.initializeIFrame(e)];case 1:return t=i.sent(),this.telemetryReportHandler=new S(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),t,this.spinner),this.playerInternalEventHandler=new f(this.spinner,this.telemetryReportHandler),t.initSucceeded?[4,this.sendCommand("createHlsHydraPlayer",this.playerSettings,t)]:[3,3];case 2:return i.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(t.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e.prototype.isIFrameCommunicationActive=function(){var e;return!!(null===(e=this.iframe)||void 0===e?void 0:e.contentWindow)&&!!this.contextWindow},e.prototype.getFullTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getFullTelemetryReport())||{}},e.prototype.getSnapshotTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getSnapshotTelemetryReport())||{}},e.prototype.callPlayerApi=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return r(this,void 0,void 0,(function(){return s(this,(function(i){switch(i.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,a([e],t,!1))]:[3,2];case 1:case 3:return[2,i.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e.prototype.dispose=function(){var e;null===(e=this.telemetryReportHandler)||void 0===e||e.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e.prototype.release=function(){var e;null===(e=this.spinner)||void 0===e||e.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e.prototype.sendCommand=function(e){for(var t,i,n=[],a=1;a<arguments.length;a++)n[a-1]=arguments[a];return r(this,void 0,void 0,(function(){var r,a,c;return s(this,(function(s){switch(s.label){case 0:if(r={msgType:o.MessageType.Command,name:e,args:n},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(a=this.commandResultsMap.get(e.toString()))&&a.reject(new Error("function ".concat(e," is invoked again, before previous call is completed"))),c=h.defer(),this.commandResultsMap.set(e,c),null===(i=null===(t=this.iframe)||void 0===t?void 0:t.contentWindow)||void 0===i||i.postMessage(r,"*"),[4,c.promise];case 1:return[2,s.sent()]}}))}))},e.prototype.onMessage=function(e){switch(e.data.msgType){case o.MessageType.PlayerEvent:this.processPlayerEvent(e.data);break;case o.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(e.data);break;case o.MessageType.CommandSuccessResult:this.processCommandSuccessResult(e.data);break;case o.MessageType.CommandFailureResult:this.processCommandFailureResult(e.data)}},e.prototype.processCommandSuccessResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.resolve(e.result),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processCommandFailureResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.reject(e.error),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processPlayerEvent=function(e){this.eventHandler[e.name].apply(this.eventHandler,e.args)},e.prototype.processInternalPlayerEvent=function(e){this.playerInternalEventHandler&&this.playerInternalEventHandler[e.name].apply(this,e.args)},e}();t.HlsHydraPlayer=m;var f=function(){function e(e,t){this.spinner=e,this.telemetryReportHandler=t}return e.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e.prototype.fullTelemetryReportUpdated=function(e){this.telemetryReportHandler.setFullTelemetryReport(e)},e.prototype.snapshotTelemetryReportUpdated=function(e){this.telemetryReportHandler.setSnapshotTelemetryReport(e)},e}(),S=function(){function e(e,t,i,n){var r=this;this.logFn=t,this.spinner=n;var s=new p.LiveStreamStatistic(e,(function(e,t){r.logFn(e,t)}),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],statsInterval:[],serviceAvgLatency:[],endToEndAvgLatency:[]},{hydraPlayerSdkVersion:e.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:l.HydraPlayerType.Hls},i);this.fullTelemetryReport=s.getReport(),this.snapshotTelemetryReport=s.getSnapshotReport()}return e.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e.prototype.setFullTelemetryReport=function(e){var t,i,r;this.fullTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.setSnapshotTelemetryReport=function(e){var t,i,r;this.snapshotTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.addDisposeTelemetry=function(){var e=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=e,this.snapshotTelemetryReport.hydraDisposeTimestamp=e},e.prototype.updateInitEventsWithDisposeEvent=function(e,t){var i=e.init_allEvents,n=JSON.parse(i);n[n.length-1].name!==d.PlayerScenarioType.Destroyed&&n.push({name:d.PlayerScenarioType.Destroyed,startTime:t,duration:0,details:g.HydraPlayerDestroyedReason.PlayerStopped}),e.init_allEvents=(0,u.stringifyObject)(n)},e.prototype.updateStateChangeEventsWithDisposeEvent=function(e,t){var i=e.playback_stateChangeEvents,n=JSON.parse(i);n[n.length-1].payload!==c.HydraPlayerPlaybackState.Destroyed&&n.push({eventType:d.TelemetryEventType.StateChanged,timestamp:t,currentPlayPosition:-1,payload:c.HydraPlayerPlaybackState.Destroyed}),e.playback_stateChangeEvents=(0,u.stringifyObject)(n)},e}()},124:function(e,t){var i;Object.defineProperty(t,"__esModule",{value:!0}),t.MessageType=void 0,(i=t.MessageType||(t.MessageType={})).Command="Command",i.CommandSuccessResult="CommandSuccessResult",i.CommandFailureResult="CommandFailureResult",i.PlayerEvent="PlayerEvent",i.InternalPlayerEvent="InternalPlayerEvent"},63:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraSupportedSDN=t.HydraPlayerDestroyedReason=void 0,(n=t.HydraPlayerDestroyedReason||(t.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",n.PlaybackError="PlaybackError",(i=t.HydraSupportedSDN||(t.HydraSupportedSDN={})).Hive="hive",i.Kollective="kollective",i.Ramp="ramp",i.Peer5="peer5",i.Microsoft="microsoft"},844:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerScenarioType=t.TelemetryEventType=void 0,(n=t.TelemetryEventType||(t.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",n.StreamOptionsConfigured="StreamOptionsConfigured",n.BitrateChangedPlayback="BitrateChangedPlayback",n.CaptionsToggled="CaptionsToggled",n.Error="Error",n.IgnoredError="IgnoredError",n.FullscreenChanged="FullscreenChanged",n.Mute="Mute",n.PotentialMediaFreeze="PotentialMediaFreeze",n.StateChanged="StateChanged",n.HydraInputStateChanged="HydraInputStateChanged",n.HydraOutputStateChanged="HydraOutputStateChanged",n.Volume="Volume",n.Buffering="Buffering",n.Online="Online",n.Offline="Offline",n.NetworkChange="NetworkChange",n.HlsEvents="HlsEvents",(i=t.PlayerScenarioType||(t.PlayerScenarioType={})).LoadHydra="LoadHydra",i.LoadHlsScript="LoadHlsScript",i.LoadPlayer="LoadPlayer",i.Load="Load",i.LoadHlsAuthCookie="LoadHlsAuthCookie",i.HlsManifestLoad="HlsManifestLoad",i.HlsKeyLoad="HlsKeyLoad",i.LoadHlsFirstFragment="LoadHlsFirstFragment",i.SetSource="SetSource",i.SdnPluginLoad="SdnPluginLoad",i.ThaPluginLoad="ThaPluginLoad",i.HydraPipelineInitialization="HydraPipelineInitialization",i.Destroyed="Destroyed",i.Setup="Setup",i.StreamConnection="StreamConnection"},328:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=void 0,(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},68:function(e,t){var i,n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(s=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",s.HLS="MiddleLaneHttpLiveStreaming",s.Ums="MiddleLaneUltraLowLatency",(r=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",r.PlayerInitializationFailed="PlayerInitializationFailed",r.InvalidStream="InvalidStream",r.SetSourceFailed="SetSourceFailed",(n=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",n.LoadedData="loadeddata",n.LoadedMetadata="loadedmetadata",n.Start="start",n.CanPlayThrough="canplaythrough",n.Play="play",n.Playing="playing",n.Pause="pause",n.Waiting="waiting",n.Seeking="seeking",n.Seeked="seeked",n.Ended="ended",n.Error="error",n.Destroyed="destroyed",n.Initialized="initialized",n.Stalled="stalled",n.VolumeChange="volumechange",n.PlaybackBitrateChanged="playbackbitratechanged",n.DownloadBitrateChanged="downloadbitratechanged",n.HlsKeyLoading="hlsKeyLoading",n.HlsKeyLoaded="hlsKeyLoaded",n.HlsKeyLoadedFailed="hlsKeyLoadedFailed",n.HlsManifestLoading="hlsManifestLoading",n.HlsManifestLoaded="hlsManifestLoaded",n.HlsManifestLoadedFailed="hlsManifestLoadedFailed",n.HlsFirstFragmentLoading="hlsFragLoading",n.HlsFirstFragmentBuffered="hlsFragBuffered",n.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",n.Online="online",n.Offline="offline",n.NetworkChange="networkChange",(i=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",i.NetworkError="NetworkError",i.PlaybackRetried="PlaybackRetried",i.PlaybackError="PlaybackError",i.Unknown="Unknown"},944:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defer=void 0,t.defer=function(){var e,t;return{promise:new Promise((function(i,n){e=i,t=n})),resolve:e,reject:t}}},329:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.createVideoElement=t.createVideoElementDiv=t.showPlayerControls=t.getSdnStats=t.Spinner=t.repeatUntilCancel=t.wait=t.stringifyError=t.stringifyObject=t.getRandomHexString=t.getPlayerSetting=t.getECSSetting=t.assert=t.createIFrame=t.getMajorFromVersion=void 0;var s=i(63),a=i(328);function o(e,t,i,s,a){return n(this,void 0,void 0,(function(){var o,c,d,u,g=this;return r(this,(function(p){switch(p.label){case 0:return o=100,c=Date.now(),[4,l(i,d={trackingRef:"",timeTakenToDownloadScript:-1},a).catch((function(e){return n(g,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t="Failed to get IFrame source: ".concat(h(e)),s.push({success:!1,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),[4,Promise.reject(new Error(t))];case 1:return[2,n.sent()]}}))}))}))];case 1:return u=p.sent(),t.srcdoc=u,e.appendChild(t),[4,new Promise((function(e,n){t.onload=function(){s.push({success:!0,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript}),s.length>o&&s.shift(),e()},t.onerror=function(e){var t="Failed to load HydraPlayer IFrame: ".concat(h(e));s.push({success:!1,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),n(new Error(t))}}))];case 2:return p.sent(),[2]}}))}))}function c(e,t){return n(this,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,e(t).catch((function(s){return n(i,void 0,void 0,(function(){var i=this;return r(this,(function(a){switch(a.label){case 0:return 0!=--t?[3,2]:[4,Promise.reject(s)];case 1:case 3:return[2,a.sent()];case 2:return[4,new Promise((function(a){return setTimeout((function(){a(c(e,t).catch((function(e){return n(i,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(new Error("".concat(h(s)).concat(", ",h(e))))];case 1:return[2,t.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return s.sent(),[2]}}))}))}function l(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,c=this;return r(this,(function(l){switch(l.label){case 0:return s=Date.now(),[4,d(e,t,i).catch((function(e){return n(c,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 1:return a=l.sent(),o="<script> ".concat(a,"<\/script>"),t.timeTakenToDownloadScript=Date.now()-s,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(o,"\n        </body>\n        </html>\n    ")]}}))}))}function d(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,c=this;return r(this,(function(l){switch(l.label){case 0:return s=function(e,t){var i,n;return t.includes("vz")?null!==(n=e.headers.get("uuid"))&&void 0!==n?n:"":null!==(i=e.headers.get("X-Azure-Ref"))&&void 0!==i?i:""},i?(a=new AbortController,o=setTimeout((function(){a.abort()}),i),[4,fetch(e,{signal:a.signal,cache:"no-cache"}).then((function(i){return n(c,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return clearTimeout(o),i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(c,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))})).catch((function(e){return n(c,void 0,void 0,(function(){return r(this,(function(t){throw clearTimeout(o),e}))}))}))]):[3,2];case 1:case 3:return[2,l.sent()];case 2:return[4,fetch(e,{cache:"no-cache"}).then((function(i){return n(c,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(c,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))}))]}}))}))}function h(e){try{if(!e)return"".concat(e);if(e instanceof Map)return i={},e.forEach((function(e,t){i[t.toString()]=e})),JSON.stringify(i);var t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}catch(e){return""}var i}function u(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t){return setTimeout(t,e)}))];case 1:return t.sent(),[2]}}))}))}t.getMajorFromVersion=function(e){var t=e.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return t?t[1]:null},t.createIFrame=function(e,t,i,s,a){return void 0===s&&(s=!1),n(this,void 0,void 0,(function(){var l,d,u,g,p=this;return r(this,(function(m){switch(m.label){case 0:return l=[],d=Date.now(),(u=e.ownerDocument.createElement("iframe")).id="player-iframe",s||u.sandbox.add("allow-scripts"),u.allowFullscreen=!0,u.allow="camera; microphone; autoplay",u.style.height="100%",u.style.width="100%",u.style.border="none",g=function(e){return t[e%t.length]},[4,c((function(t){return n(p,void 0,void 0,(function(){var i;return r(this,(function(n){switch(n.label){case 0:return i=g(t),[4,o(e,u,i,l,a)];case 1:return n.sent(),[2]}}))}))}),i).then((function(){return{iframe:u,initResult:{initSucceeded:!0,initStartTime:d,initDuration:Date.now()-d,runtimeDownloadResults:l}}})).catch((function(e){return n(p,void 0,void 0,(function(){var i;return r(this,(function(n){return i="Failed to load Hydra player runtime scripts, src: ",t.forEach((function(e){return i=i.concat(e,", ")})),i+="errors: ".concat(h(e)),[2,{initResult:{initSucceeded:!1,initStartTime:d,initDuration:Date.now()-d,runtimeDownloadResults:l,errorMsg:i}}]}))}))}))];case 1:return[2,m.sent()]}}))}))},t.assert=function(e,t,i){if(void 0===i&&(i=!1),!e){if(!i)throw new Error("Assert failed".concat(void 0!==t?": ".concat(t):""));console.error("Assert failed".concat(void 0!==t?": ".concat(t):""))}},t.getECSSetting=function(e,t,i){var n,r=i,s=null===(n=e.ecsSettings)||void 0===n?void 0:n[t];return typeof s==typeof r&&(r=s),r},t.getPlayerSetting=function(e,t){var i;return void 0!==(null===(i=e.ecsSettings)||void 0===i?void 0:i[t])?e.ecsSettings[t]:e[t]},t.getRandomHexString=function(e){return Array.from(Array(e)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},t.stringifyObject=h,t.stringifyError=function(e){return e instanceof Error?e.message:h(e)},t.wait=u,t.repeatUntilCancel=function(e,t,i,s){var a=!1,o=s||console.log;return o("RepeatUntilCancel starting task: ".concat(e)),n(this,void 0,void 0,(function(){var n,s,c;return r(this,(function(r){switch(r.label){case 0:return a?[3,2]:(n=new Date,t(),s=(new Date).getTime()-n.getTime(),(c=i-s)<0&&(c=i+c%i,o("Skipping execution for ".concat(e,", last execution took: ").concat(s," ms, delayMs: ").concat(i),"warn")),[4,u(c)]);case 1:return r.sent(),[3,0];case 2:return[2]}}))})),function(){o("RepeatUntilCancel stopping task: ".concat(e)),a=!0}};var g=function(){function e(e){this.container=e,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var t=this.container.ownerDocument.getElementById(this.spinnerId);if(t)return this.spinner=t,void this.show();var i=this.container.ownerDocument.createElement("style");i.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(i),this.container.style.position="relative";var n=this.container.ownerDocument.createElement("div");n.classList.add("ml-player-spinner-container"),this.container.appendChild(n),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,n.appendChild(this.spinner);var r=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");r.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(r);var s=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");s.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(s),this.show()}return Object.defineProperty(e.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var e=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];e.hideTimestamp||(e.displayDuration=Date.now()-e.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e.prototype.show=function(){var e=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=e),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:e,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e.prototype.hide=function(){var e=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=e),this.spinnerInfoHistory.length>0){var t=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];t.hideTimestamp||(t.hideTimestamp=e,t.displayDuration=e-t.showTimestamp)}this.spinner.style.display="none"},e.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e}();t.Spinner=g,t.getSdnStats=function(e,t){(null==e?void 0:e.peer5)&&(t.sdnName=e.peer5?s.HydraSupportedSDN.Microsoft:"",t.sdnVersion=e.peer5?e.peer5.version:"","function"==typeof e.peer5.getStats&&(t.sdnStats=e.peer5.getStats(),t.isP2PSdnUsed=e.peer5.getStats().numOfPeers>0))},t.showPlayerControls=function(e){return void 0!==e.allowPlayerControls?e.allowPlayerControls:e.streamingEventType===a.HydraStreamingEventType.TLE},t.createVideoElementDiv=function(e,t,i){i("createVideoElementDiv started");var n=t.ownerDocument.createElement("div");return n.id=e,n.style.position="relative",n.style.width="100%",n.style.height="100%",t.appendChild(n),i("createVideoElementDiv done"),n},t.createVideoElement=function(e,t,i,n,r){r("createVideoElement started");var s=t.ownerDocument.createElement("video");s.controls=n,s.id=e,s.setAttribute("playsinline","");var a=i.videoLang;a&&(s.setAttribute("lang",a),r("createVideoElement: language set to ".concat(a)));for(var o=i.videoElementStyles,c=0;c<o.length;c++)s.classList.add(o[c]);return s.style.width="100%",s.style.height="100%",s.style.position="absolute",s.muted=i.muteVideo,s.addEventListener("contextmenu",(function(e){e.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(e){try{navigator.mediaSession.setActionHandler(e,(function(){}))}catch(e){}})),t.appendChild(s),r("createVideoElement done"),s}}},t={},function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(855);var e,t},"object"==typeof e&&"object"==typeof t?t.exports=n():"object"==typeof e?e.hydra_player_hls_sdk=n():i.hydra_player_hls_sdk=n()}}),z=h({"../node_modules/@skype/hydra_player_ums_sdk/hydra_player_ums_sdk_bundle.js"(e,t){var i,n;i=e,n=function(){return e={458:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.LiveStreamStatistic=void 0;var r=i(844),s=i(68),a=i(329),o=function(){function e(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}return e.prototype.complete=function(){try{a.assert(this.startTime,"not started",this.stopCrash),a.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(e){if(this.name!==r.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==r.PlayerScenarioType.HlsKeyLoad)throw e}this.duration=Date.now()-this.startTime},e.prototype.fail=function(e){this.failReason=e,this.complete()},e.prototype.setDetail=function(e){this.details=e},e.prototype.getTelemetryEvent=function(){a.assert(this.startTime,"not started",this.stopCrash);var e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e},e.prototype.getName=function(){return this.name},e.prototype.getDuration=function(){var e;return null!==(e=this.duration)&&void 0!==e?e:0},e.prototype.getFailReason=function(){return this.failReason},e.prototype.getDetails=function(){return this.details},e.prototype.start=function(e){a.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),e&&(this.details=e)},e.prototype.updateDetails=function(e,t){if(this.details&&"object"==typeof this.details)for(var i=0;i<e.length;i++)this.details[e[i]]=t[i]},e}(),c=function(){function e(e,t,i,n,r){this.config=e,this.logFn=t,this.playerDiagnosticsLog=i,this.playerMetadata=n,this.hydraInitResult=r,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=e.maxPlayerExperimentalEvents||100,a.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e.prototype.registerStatsUpdated=function(e){var t=this;this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((function(i){var n,r=i,s=null!==(n=t.playerDiagnosticsLog[i])&&void 0!==n?n:[];if(Array.isArray(s)){s.push(e[r]);var a="memoryLog"===r&&s.length>t.maxPlayerMemoryTraceLogCount,o="memoryLog"!==r&&s.length>t.maxPlayerDiagnosticsCount;(a||o)&&s.splice(0,1)}else t.playerDiagnosticsLog[i]=e[r]}))},e.prototype.registerEventLoadAttempt=function(e,t){this.registerScenario(e,t)},e.prototype.registerEventLoadFailed=function(e,t){this.completeScenario(e,t)},e.prototype.registerEventLoadSucceeded=function(e,t){this.completeScenario(e,void 0,t),e===r.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e.prototype.registerSdnPluginLoadAttempt=function(e){this.registerScenario(r.PlayerScenarioType.SdnPluginLoad,JSON.stringify(e))},e.prototype.registerSdnPluginLoadFailed=function(e){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad,e)},e.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad)},e.prototype.registerStreamConnectionAttempt=function(e){this.registerScenario(r.PlayerScenarioType.StreamConnection,{streamUrl:e})},e.prototype.registerStreamConnectionSucceeded=function(e){var t=this.getScenario(r.PlayerScenarioType.StreamConnection);null==t||t.updateDetails(["results"],[a.stringifyObject(e)]),this.completeScenario(r.PlayerScenarioType.StreamConnection)},e.prototype.registerStreamConnectionFailed=function(e,t){var i=this.getScenario(r.PlayerScenarioType.StreamConnection);null==i||i.updateDetails(["results"],[a.stringifyObject(t)]),this.completeScenario(r.PlayerScenarioType.StreamConnection,e)},e.prototype.registerSetSourceAttempt=function(e,t,i){var n=e||"";i&&(n={src:e||"",isPrimary:a.stringifyObject(t),reason:i}),this.registerScenario(r.PlayerScenarioType.SetSource,n)},e.prototype.registerSetSourceSucceeded=function(e,t,i,n){var s=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(s,"no SetSource scenario to update details",this.stopCrash),null==s||s.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[e,a.stringifyObject(t),a.stringifyObject(i),a.stringifyObject(n)]),this.completeScenario(r.PlayerScenarioType.SetSource)},e.prototype.registerSetSourceFailed=function(e,t,i,n,s){var o=null!=t?t:"Failed to find stream url",c=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(c,"no SetSource scenario to update details",this.stopCrash),null==c||c.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[o,a.stringifyObject(i),a.stringifyObject(n),a.stringifyObject(s)]),this.completeScenario(r.PlayerScenarioType.SetSource,e)},e.prototype.registerPlayerDestroyed=function(e){this.registerScenario(r.PlayerScenarioType.Destroyed,e),this.completeScenario(r.PlayerScenarioType.Destroyed)},e.prototype.registerPlaybackStateChanged=function(e){e!==s.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?e!==s.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(r.TelemetryEventType.StateChanged,e)},e.prototype.registerHydraInputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraInputStateChanged,e,t)},e.prototype.registerHydraOutputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraOutputStateChanged,e,t)},e.prototype.registerPlaybackBuffering=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Buffering,e)},e.prototype.registerPlaybackError=function(e,t,i){this.registerPlaybackEvent(r.TelemetryEventType.Error,{errorType:e,details:t,errorSource:i})},e.prototype.registerIgnoredPlaybackError=function(e){this.registerPlaybackEvent(r.TelemetryEventType.IgnoredError,e)},e.prototype.registerDownloadBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedDownload,e)},e.prototype.registerStreamOptionsConfigured=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.StreamOptionsConfigured,e,t)},e.prototype.registerPlaybackBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedPlayback,e)},e.prototype.registerVolumeChange=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Volume,e)},e.prototype.getSnapshotReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents,s={};return this.currentPlayerDiagnosticSnapshot&&(s=this.filterAndPrepareTelemetry()),n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),s)},e.prototype.getReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents;return n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),this.getPlayerDiagnosticLog())},e.prototype.getHydraLoadEvent=function(){var e,t,i,n={name:r.PlayerScenarioType.LoadHydra,startTime:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initStartTime)||-1,duration:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initDuration)||0};(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)&&(n.failReason=this.hydraInitResult.errorMsg);var s=this.getHydraRuntimeDownloadDetails();return s&&(n.details=s),n},e.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var e=[],t=0,i=this.hydraInitResult.runtimeDownloadResults;t<i.length;t++){var n=i[t],r={success:n.success,url:n.url,startTime:n.startTime,duration:n.duration,trackingReference:n.trackingReference,timeTakenToDownloadScript:n.timeTakenToDownloadScript};n.errorMsg&&(r.errorMsg=n.errorMsg),e.push(r)}return a.stringifyObject(e)}return null},e.prototype.getTotalLoadEvent=function(){var e,t,i,n=this.playerEvents.find((function(e){return e.getName()===r.PlayerScenarioType.LoadPlayer})),s=(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initDuration)||0,a=(null==n?void 0:n.getDuration())||0,o=null==n?void 0:n.getFailReason(),c={name:r.PlayerScenarioType.Load,startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,duration:s+a};return(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)?c.failReason=this.hydraInitResult.errorMsg:o&&(c.failReason=o),c},e.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e.prototype.registerPlaybackEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);e===r.TelemetryEventType.Error&&(null==t?void 0:t.errorType)!==s.HydraPlayerPlaybackErrorType.PlaybackRetried&&(n.fatal=!0,this.callDropped=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getPlayerDiagnosticLog=function(){var e=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var t=this.currentPlayerDiagnosticSnapshot,i=this.playerDiagnosticsLog,r=n(n({},t),i),s={};return Object.keys(r).forEach((function(t){s["player_".concat(t)]=e.prepareForTelemetry(r[t])})),s},e.prototype.getHydraInitializationReport=function(){var e,t,i,n;return{hydraInit_succeeded:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initSucceeded)||!1,hydraInit_startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,hydraInit_errorMessage:(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)||"",hydraInit_duration:(null===(n=this.hydraInitResult)||void 0===n?void 0:n.initDuration)||0}},e.prototype.getPlayerInitializationReport=function(e,t){var i=e.find((function(e){return e.name===r.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(null!=i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(null!=i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}},e.prototype.getHydraInternalReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraInputStateChanged})),i=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(t),hydra_outputStateChangeEvents:this.prepareForTelemetry(i)}},e.prototype.getPlaybackReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.StateChanged})),i=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.CanPlayThrough})),n=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Play})),a=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Start})),o=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Playing})),c=null!=i&&null!=n?n.timestamp-i.timestamp:-1,l=null!=n&&null!=a?a.timestamp-n.timestamp:-1,d=null!=a&&null!=o?o.timestamp-a.timestamp:-1,h=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeked})),u=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeking})),g=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Pause})),p=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Waiting})),m=[r.TelemetryEventType.BitrateChangedDownload,r.TelemetryEventType.BitrateChangedPlayback,r.TelemetryEventType.Error,r.TelemetryEventType.Mute,r.TelemetryEventType.StateChanged,r.TelemetryEventType.Volume,r.TelemetryEventType.StreamOptionsConfigured,r.TelemetryEventType.IgnoredError],f=e.filter((function(e){return e.eventType===r.TelemetryEventType.Error})),S=e.filter((function(e){return e.eventType===r.TelemetryEventType.IgnoredError})),v=e.filter((function(e){return e.eventType===r.TelemetryEventType.Volume||e.eventType===r.TelemetryEventType.Mute})),y=e.filter((function(e){return e.eventType===r.TelemetryEventType.StreamOptionsConfigured})),C=e.filter((function(e){return!m.includes(e.eventType)}));return{playback_timeReadyToPlay:c,playback_timePlayToStart:l,playback_timeStartToPlaying:d,playback_bufferingEvents:this.prepareForTelemetry(p),playback_errorEvents:this.prepareForTelemetry(f),playback_ignoredErrorEvents:this.prepareForTelemetry(S),playback_pauseEvents:this.prepareForTelemetry(g),playback_otherEvents:this.prepareForTelemetry(C),playback_seekedEvents:this.prepareForTelemetry(h),playback_seekingEvents:this.prepareForTelemetry(u),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(v),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(y)}},e.prototype.getBitrateReport=function(e){var t,i,s,a,o=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedDownload})),c=o.sort((function(e){return Number(e.payload)})),l=o.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(o),bitrate_downloadChangeCount:o.length>0||-1,bitrate_downloadMin:(null===(t=c[0])||void 0===t?void 0:t.payload)||-1,bitrate_downloadMax:(null===(i=c[c.length-1])||void 0===i?void 0:i.payload)||-1}:{},d=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedPlayback})),h=d.sort((function(e){return Number(e.payload)})),u=d.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(d),bitrate_playbackChangeCount:d.length>0||-1,bitrate_playbackMin:(null===(s=h[0])||void 0===s?void 0:s.payload)||-1,bitrate_playbackMax:(null===(a=h[h.length-1])||void 0===a?void 0:a.payload)||-1}:{};return n(n({},l),u)},e.prototype.addNetworkTypeEventListener=function(){var e,t,i,n,r=this;(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)&&(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n||n.addEventListener("change",(function(){r.updateClientNetworkType()})))},e.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e.prototype.getClientNetworkType=function(){var e,t,i,n;if(void 0===this.clientNetworkType){var r="Unknown";if(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)switch(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n?void 0:n.type){case"cellular":r="WWAN";break;case"ethernet":r="Wired";break;case"wifi":r="Wireless";break;default:r="Unknown"}this.clientNetworkType=r}return this.clientNetworkType},e.prototype.getSdnReport=function(e){var t,i,n=e.filter((function(e){return e.name===r.PlayerScenarioType.SdnPluginLoad})),s=n.length>0?n[n.length-1]:void 0;return{sdn_loaded:!(null==s||void 0!==s.failReason),sdn_details:null!==(t=null==s?void 0:s.details)&&void 0!==t?t:"",sdn_error:null!==(i=null==s?void 0:s.failReason)&&void 0!==i?i:"",sdn_events:this.prepareForTelemetry(n)}},e.prototype.getStreamConnectionReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(t)}},e.prototype.getSetSourceReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(t)}},e.prototype.registerScenario=function(e,t){var i=this.currentScenarioMap.get(e),n=new o(e,this.stopCrash,t);try{a.assert(null==i,"previous scenario:".concat(a.stringifyObject(i)," is not completed, new scenario:").concat(a.stringifyObject(n)),this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}this.currentScenarioMap.set(e,n),this.playerEvents.push(n)},e.prototype.completeScenario=function(e,t,i){var n=this.currentScenarioMap.get(e);try{a.assert(n,"no scenario to complete",this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}t?null==n||n.fail(t):(e!==r.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(null==n||n.setDetail(i)),null==n||n.complete()),this.currentScenarioMap.delete(e)},e.prototype.logTelemetryEvent=function(e){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(e))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e.prototype.filterAndPrepareTelemetry=function(){var e=this,t=new Set;t.add("serviceLatencyCdg"),t.add("endToEndLatencyCdg"),t.add("videoEdgeLatencyCdg");var i={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(n){t.has(n)||(i["player_".concat(n)]=e.prepareForTelemetry(e.currentPlayerDiagnosticSnapshot[n]))})),i},e.prototype.prepareForTelemetry=function(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?null!=e?e:-1:JSON.stringify(e)},e.prototype.getScenario=function(e){return this.currentScenarioMap.get(e)},e.prototype.createTelemetryEvent=function(e,t,i){var n,r,s={eventType:e,timestamp:Date.now(),currentPlayPosition:null!==(r=null===(n=this.currentPlayerDiagnosticSnapshot)||void 0===n?void 0:n.currentPlayPosition)&&void 0!==r?r:-1};return void 0!==t&&(s.payload=this.prepareForTelemetry(t)),s.message=i,s},e.prototype.registerExperimentalEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e}();t.LiveStreamStatistic=c},751:function(e,t){var i,n,r,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(o=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",o.HLS="MiddleLaneHttpLiveStreaming",o.Ums="MiddleLaneUltraLowLatency",(a=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",a.PlayerInitializationFailed="PlayerInitializationFailed",a.InvalidStream="InvalidStream",a.SetSourceFailed="SetSourceFailed",(s=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",s.LoadedData="loadeddata",s.LoadedMetadata="loadedmetadata",s.Start="start",s.CanPlayThrough="canplaythrough",s.Play="play",s.Playing="playing",s.Pause="pause",s.Waiting="waiting",s.Seeking="seeking",s.Seeked="seeked",s.Ended="ended",s.Error="error",s.Destroyed="destroyed",s.Initialized="initialized",s.Stalled="stalled",s.VolumeChange="volumechange",s.PlaybackBitrateChanged="playbackbitratechanged",s.DownloadBitrateChanged="downloadbitratechanged",s.HlsKeyLoading="hlsKeyLoading",s.HlsKeyLoaded="hlsKeyLoaded",s.HlsKeyLoadedFailed="hlsKeyLoadedFailed",s.HlsManifestLoading="hlsManifestLoading",s.HlsManifestLoaded="hlsManifestLoaded",s.HlsManifestLoadedFailed="hlsManifestLoadedFailed",s.HlsFirstFragmentLoading="hlsFragLoading",s.HlsFirstFragmentBuffered="hlsFragBuffered",s.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",s.Online="online",s.Offline="offline",s.NetworkChange="networkChange",(r=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",r.NetworkError="NetworkError",r.PlaybackRetried="PlaybackRetried",r.PlaybackError="PlaybackError",r.Unknown="Unknown",(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},979:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),r(i(165),t),r(i(751),t)},165:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)},r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},a=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,s=t.length;r<s;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.UmsHydraPlayer=t.getSdkVersion=void 0;var o=i(124),c=i(68),l=i(328),d=i(844),h=i(63),u=i(458),g=i(329),p=i(944);t.getSdkVersion=function(){return"4.2488.1"};var m=function(){function e(e,t){this.playerSettings=e,this.eventHandler=t,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2488.1"}return Object.defineProperty(e.prototype,"contextWindow",{get:function(){var e;return null===(e=this.container)||void 0===e?void 0:e.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var e=(0,g.getMajorFromVersion)("4.2488.1");return e&&this.playerSettings.playerRuntimeJsUrls[e]||[]}return this.playerSettings.playerRuntimeJsUrls},e.prototype.initializeIFrame=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.container=e,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2488.1",', URLs: "').concat((0,g.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,g.createIFrame)(e,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(t=i.sent()).initResult.initSucceeded&&t.iframe&&(this.iframe=t.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,t.initResult]}}))}))},e.prototype.setup=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.spinner=new g.Spinner(e),[4,this.initializeIFrame(e)];case 1:return t=i.sent(),this.telemetryReportHandler=new S(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),t,this.spinner),this.playerInternalEventHandler=new f(this.spinner,this.telemetryReportHandler),t.initSucceeded?[4,this.sendCommand("createUmsHydraPlayer",this.playerSettings,t)]:[3,3];case 2:return i.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(t.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e.prototype.isIFrameCommunicationActive=function(){var e;return!!(null===(e=this.iframe)||void 0===e?void 0:e.contentWindow)&&!!this.contextWindow},e.prototype.getFullTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getFullTelemetryReport())||{}},e.prototype.getSnapshotTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getSnapshotTelemetryReport())||{}},e.prototype.callPlayerApi=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return r(this,void 0,void 0,(function(){return s(this,(function(i){switch(i.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,a([e],t,!1))]:[3,2];case 1:case 3:return[2,i.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e.prototype.dispose=function(){var e;null===(e=this.telemetryReportHandler)||void 0===e||e.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e.prototype.release=function(){var e;null===(e=this.spinner)||void 0===e||e.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e.prototype.sendCommand=function(e){for(var t,i,n=[],a=1;a<arguments.length;a++)n[a-1]=arguments[a];return r(this,void 0,void 0,(function(){var r,a,c;return s(this,(function(s){switch(s.label){case 0:if(r={msgType:o.MessageType.Command,name:e,args:n},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(a=this.commandResultsMap.get(e.toString()))&&a.reject(new Error("function ".concat(e," is invoked again, before previous call is completed"))),c=p.defer(),this.commandResultsMap.set(e,c),null===(i=null===(t=this.iframe)||void 0===t?void 0:t.contentWindow)||void 0===i||i.postMessage(r,"*"),[4,c.promise];case 1:return[2,s.sent()]}}))}))},e.prototype.onMessage=function(e){switch(e.data.msgType){case o.MessageType.PlayerEvent:this.processPlayerEvent(e.data);break;case o.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(e.data);break;case o.MessageType.CommandSuccessResult:this.processCommandSuccessResult(e.data);break;case o.MessageType.CommandFailureResult:this.processCommandFailureResult(e.data)}},e.prototype.processCommandSuccessResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.resolve(e.result),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processCommandFailureResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.reject(e.error),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processPlayerEvent=function(e){this.eventHandler[e.name].apply(this.eventHandler,e.args)},e.prototype.processInternalPlayerEvent=function(e){this.playerInternalEventHandler&&this.playerInternalEventHandler[e.name].apply(this,e.args)},e}();t.UmsHydraPlayer=m;var f=function(){function e(e,t){this.spinner=e,this.telemetryReportHandler=t}return e.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e.prototype.fullTelemetryReportUpdated=function(e){this.telemetryReportHandler.setFullTelemetryReport(e)},e.prototype.snapshotTelemetryReportUpdated=function(e){this.telemetryReportHandler.setSnapshotTelemetryReport(e)},e}(),S=function(){function e(e,t,i,n){var r=this;this.logFn=t,this.spinner=n;var s=new u.LiveStreamStatistic(e,(function(e,t){r.logFn(e,t)}),{currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]},{hydraPlayerSdkVersion:e.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:l.HydraPlayerType.Ums},i);this.fullTelemetryReport=s.getReport(),this.snapshotTelemetryReport=s.getSnapshotReport()}return e.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e.prototype.setFullTelemetryReport=function(e){var t,i,r;this.fullTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.setSnapshotTelemetryReport=function(e){var t,i,r;this.snapshotTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.addDisposeTelemetry=function(){var e=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=e,this.snapshotTelemetryReport.hydraDisposeTimestamp=e},e.prototype.updateInitEventsWithDisposeEvent=function(e,t){var i=e.init_allEvents,n=JSON.parse(i);n[n.length-1].name!==d.PlayerScenarioType.Destroyed&&n.push({name:d.PlayerScenarioType.Destroyed,startTime:t,duration:0,details:h.HydraPlayerDestroyedReason.PlayerStopped}),e.init_allEvents=(0,g.stringifyObject)(n)},e.prototype.updateStateChangeEventsWithDisposeEvent=function(e,t){var i=e.playback_stateChangeEvents,n=JSON.parse(i);n[n.length-1].payload!==c.HydraPlayerPlaybackState.Destroyed&&n.push({eventType:d.TelemetryEventType.StateChanged,timestamp:t,currentPlayPosition:-1,payload:c.HydraPlayerPlaybackState.Destroyed}),e.playback_stateChangeEvents=(0,g.stringifyObject)(n)},e}()},124:function(e,t){var i;Object.defineProperty(t,"__esModule",{value:!0}),t.MessageType=void 0,(i=t.MessageType||(t.MessageType={})).Command="Command",i.CommandSuccessResult="CommandSuccessResult",i.CommandFailureResult="CommandFailureResult",i.PlayerEvent="PlayerEvent",i.InternalPlayerEvent="InternalPlayerEvent"},63:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraSupportedSDN=t.HydraPlayerDestroyedReason=void 0,(n=t.HydraPlayerDestroyedReason||(t.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",n.PlaybackError="PlaybackError",(i=t.HydraSupportedSDN||(t.HydraSupportedSDN={})).Hive="hive",i.Kollective="kollective",i.Ramp="ramp",i.Peer5="peer5",i.Microsoft="microsoft"},844:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerScenarioType=t.TelemetryEventType=void 0,(n=t.TelemetryEventType||(t.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",n.StreamOptionsConfigured="StreamOptionsConfigured",n.BitrateChangedPlayback="BitrateChangedPlayback",n.CaptionsToggled="CaptionsToggled",n.Error="Error",n.IgnoredError="IgnoredError",n.FullscreenChanged="FullscreenChanged",n.Mute="Mute",n.PotentialMediaFreeze="PotentialMediaFreeze",n.StateChanged="StateChanged",n.HydraInputStateChanged="HydraInputStateChanged",n.HydraOutputStateChanged="HydraOutputStateChanged",n.Volume="Volume",n.Buffering="Buffering",n.Online="Online",n.Offline="Offline",n.NetworkChange="NetworkChange",n.HlsEvents="HlsEvents",(i=t.PlayerScenarioType||(t.PlayerScenarioType={})).LoadHydra="LoadHydra",i.LoadHlsScript="LoadHlsScript",i.LoadPlayer="LoadPlayer",i.Load="Load",i.LoadHlsAuthCookie="LoadHlsAuthCookie",i.HlsManifestLoad="HlsManifestLoad",i.HlsKeyLoad="HlsKeyLoad",i.LoadHlsFirstFragment="LoadHlsFirstFragment",i.SetSource="SetSource",i.SdnPluginLoad="SdnPluginLoad",i.ThaPluginLoad="ThaPluginLoad",i.HydraPipelineInitialization="HydraPipelineInitialization",i.Destroyed="Destroyed",i.Setup="Setup",i.StreamConnection="StreamConnection"},328:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=void 0,(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},68:function(e,t){var i,n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(s=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",s.HLS="MiddleLaneHttpLiveStreaming",s.Ums="MiddleLaneUltraLowLatency",(r=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",r.PlayerInitializationFailed="PlayerInitializationFailed",r.InvalidStream="InvalidStream",r.SetSourceFailed="SetSourceFailed",(n=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",n.LoadedData="loadeddata",n.LoadedMetadata="loadedmetadata",n.Start="start",n.CanPlayThrough="canplaythrough",n.Play="play",n.Playing="playing",n.Pause="pause",n.Waiting="waiting",n.Seeking="seeking",n.Seeked="seeked",n.Ended="ended",n.Error="error",n.Destroyed="destroyed",n.Initialized="initialized",n.Stalled="stalled",n.VolumeChange="volumechange",n.PlaybackBitrateChanged="playbackbitratechanged",n.DownloadBitrateChanged="downloadbitratechanged",n.HlsKeyLoading="hlsKeyLoading",n.HlsKeyLoaded="hlsKeyLoaded",n.HlsKeyLoadedFailed="hlsKeyLoadedFailed",n.HlsManifestLoading="hlsManifestLoading",n.HlsManifestLoaded="hlsManifestLoaded",n.HlsManifestLoadedFailed="hlsManifestLoadedFailed",n.HlsFirstFragmentLoading="hlsFragLoading",n.HlsFirstFragmentBuffered="hlsFragBuffered",n.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",n.Online="online",n.Offline="offline",n.NetworkChange="networkChange",(i=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",i.NetworkError="NetworkError",i.PlaybackRetried="PlaybackRetried",i.PlaybackError="PlaybackError",i.Unknown="Unknown"},944:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defer=void 0,t.defer=function(){var e,t;return{promise:new Promise((function(i,n){e=i,t=n})),resolve:e,reject:t}}},329:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.createVideoElement=t.createVideoElementDiv=t.showPlayerControls=t.getSdnStats=t.Spinner=t.repeatUntilCancel=t.wait=t.stringifyError=t.stringifyObject=t.getRandomHexString=t.getPlayerSetting=t.getECSSetting=t.assert=t.createIFrame=t.getMajorFromVersion=void 0;var s=i(63),a=i(328);function o(e,t,i,s,a){return n(this,void 0,void 0,(function(){var o,c,d,u,g=this;return r(this,(function(p){switch(p.label){case 0:return o=100,c=Date.now(),[4,l(i,d={trackingRef:"",timeTakenToDownloadScript:-1},a).catch((function(e){return n(g,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t="Failed to get IFrame source: ".concat(h(e)),s.push({success:!1,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),[4,Promise.reject(new Error(t))];case 1:return[2,n.sent()]}}))}))}))];case 1:return u=p.sent(),t.srcdoc=u,e.appendChild(t),[4,new Promise((function(e,n){t.onload=function(){s.push({success:!0,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript}),s.length>o&&s.shift(),e()},t.onerror=function(e){var t="Failed to load HydraPlayer IFrame: ".concat(h(e));s.push({success:!1,url:i,startTime:c,duration:Date.now()-c,trackingReference:d.trackingRef,timeTakenToDownloadScript:d.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),n(new Error(t))}}))];case 2:return p.sent(),[2]}}))}))}function c(e,t){return n(this,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,e(t).catch((function(s){return n(i,void 0,void 0,(function(){var i=this;return r(this,(function(a){switch(a.label){case 0:return 0!=--t?[3,2]:[4,Promise.reject(s)];case 1:case 3:return[2,a.sent()];case 2:return[4,new Promise((function(a){return setTimeout((function(){a(c(e,t).catch((function(e){return n(i,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(new Error("".concat(h(s)).concat(", ",h(e))))];case 1:return[2,t.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return s.sent(),[2]}}))}))}function l(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,c=this;return r(this,(function(l){switch(l.label){case 0:return s=Date.now(),[4,d(e,t,i).catch((function(e){return n(c,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 1:return a=l.sent(),o="<script> ".concat(a,"<\/script>"),t.timeTakenToDownloadScript=Date.now()-s,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(o,"\n        </body>\n        </html>\n    ")]}}))}))}function d(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,c=this;return r(this,(function(l){switch(l.label){case 0:return s=function(e,t){var i,n;return t.includes("vz")?null!==(n=e.headers.get("uuid"))&&void 0!==n?n:"":null!==(i=e.headers.get("X-Azure-Ref"))&&void 0!==i?i:""},i?(a=new AbortController,o=setTimeout((function(){a.abort()}),i),[4,fetch(e,{signal:a.signal,cache:"no-cache"}).then((function(i){return n(c,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return clearTimeout(o),i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(c,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))})).catch((function(e){return n(c,void 0,void 0,(function(){return r(this,(function(t){throw clearTimeout(o),e}))}))}))]):[3,2];case 1:case 3:return[2,l.sent()];case 2:return[4,fetch(e,{cache:"no-cache"}).then((function(i){return n(c,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(c,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))}))]}}))}))}function h(e){try{if(!e)return"".concat(e);if(e instanceof Map)return i={},e.forEach((function(e,t){i[t.toString()]=e})),JSON.stringify(i);var t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}catch(e){return""}var i}function u(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t){return setTimeout(t,e)}))];case 1:return t.sent(),[2]}}))}))}t.getMajorFromVersion=function(e){var t=e.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return t?t[1]:null},t.createIFrame=function(e,t,i,s,a){return void 0===s&&(s=!1),n(this,void 0,void 0,(function(){var l,d,u,g,p=this;return r(this,(function(m){switch(m.label){case 0:return l=[],d=Date.now(),(u=e.ownerDocument.createElement("iframe")).id="player-iframe",s||u.sandbox.add("allow-scripts"),u.allowFullscreen=!0,u.allow="camera; microphone; autoplay",u.style.height="100%",u.style.width="100%",u.style.border="none",g=function(e){return t[e%t.length]},[4,c((function(t){return n(p,void 0,void 0,(function(){var i;return r(this,(function(n){switch(n.label){case 0:return i=g(t),[4,o(e,u,i,l,a)];case 1:return n.sent(),[2]}}))}))}),i).then((function(){return{iframe:u,initResult:{initSucceeded:!0,initStartTime:d,initDuration:Date.now()-d,runtimeDownloadResults:l}}})).catch((function(e){return n(p,void 0,void 0,(function(){var i;return r(this,(function(n){return i="Failed to load Hydra player runtime scripts, src: ",t.forEach((function(e){return i=i.concat(e,", ")})),i+="errors: ".concat(h(e)),[2,{initResult:{initSucceeded:!1,initStartTime:d,initDuration:Date.now()-d,runtimeDownloadResults:l,errorMsg:i}}]}))}))}))];case 1:return[2,m.sent()]}}))}))},t.assert=function(e,t,i){if(void 0===i&&(i=!1),!e){if(!i)throw new Error("Assert failed".concat(void 0!==t?": ".concat(t):""));console.error("Assert failed".concat(void 0!==t?": ".concat(t):""))}},t.getECSSetting=function(e,t,i){var n,r=i,s=null===(n=e.ecsSettings)||void 0===n?void 0:n[t];return typeof s==typeof r&&(r=s),r},t.getPlayerSetting=function(e,t){var i;return void 0!==(null===(i=e.ecsSettings)||void 0===i?void 0:i[t])?e.ecsSettings[t]:e[t]},t.getRandomHexString=function(e){return Array.from(Array(e)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},t.stringifyObject=h,t.stringifyError=function(e){return e instanceof Error?e.message:h(e)},t.wait=u,t.repeatUntilCancel=function(e,t,i,s){var a=!1,o=s||console.log;return o("RepeatUntilCancel starting task: ".concat(e)),n(this,void 0,void 0,(function(){var n,s,c;return r(this,(function(r){switch(r.label){case 0:return a?[3,2]:(n=new Date,t(),s=(new Date).getTime()-n.getTime(),(c=i-s)<0&&(c=i+c%i,o("Skipping execution for ".concat(e,", last execution took: ").concat(s," ms, delayMs: ").concat(i),"warn")),[4,u(c)]);case 1:return r.sent(),[3,0];case 2:return[2]}}))})),function(){o("RepeatUntilCancel stopping task: ".concat(e)),a=!0}};var g=function(){function e(e){this.container=e,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var t=this.container.ownerDocument.getElementById(this.spinnerId);if(t)return this.spinner=t,void this.show();var i=this.container.ownerDocument.createElement("style");i.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(i),this.container.style.position="relative";var n=this.container.ownerDocument.createElement("div");n.classList.add("ml-player-spinner-container"),this.container.appendChild(n),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,n.appendChild(this.spinner);var r=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");r.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(r);var s=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");s.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(s),this.show()}return Object.defineProperty(e.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var e=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];e.hideTimestamp||(e.displayDuration=Date.now()-e.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e.prototype.show=function(){var e=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=e),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:e,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e.prototype.hide=function(){var e=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=e),this.spinnerInfoHistory.length>0){var t=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];t.hideTimestamp||(t.hideTimestamp=e,t.displayDuration=e-t.showTimestamp)}this.spinner.style.display="none"},e.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e}();t.Spinner=g,t.getSdnStats=function(e,t){(null==e?void 0:e.peer5)&&(t.sdnName=e.peer5?s.HydraSupportedSDN.Microsoft:"",t.sdnVersion=e.peer5?e.peer5.version:"","function"==typeof e.peer5.getStats&&(t.sdnStats=e.peer5.getStats(),t.isP2PSdnUsed=e.peer5.getStats().numOfPeers>0))},t.showPlayerControls=function(e){return void 0!==e.allowPlayerControls?e.allowPlayerControls:e.streamingEventType===a.HydraStreamingEventType.TLE},t.createVideoElementDiv=function(e,t,i){i("createVideoElementDiv started");var n=t.ownerDocument.createElement("div");return n.id=e,n.style.position="relative",n.style.width="100%",n.style.height="100%",t.appendChild(n),i("createVideoElementDiv done"),n},t.createVideoElement=function(e,t,i,n,r){r("createVideoElement started");var s=t.ownerDocument.createElement("video");s.controls=n,s.id=e,s.setAttribute("playsinline","");var a=i.videoLang;a&&(s.setAttribute("lang",a),r("createVideoElement: language set to ".concat(a)));for(var o=i.videoElementStyles,c=0;c<o.length;c++)s.classList.add(o[c]);return s.style.width="100%",s.style.height="100%",s.style.position="absolute",s.muted=i.muteVideo,s.addEventListener("contextmenu",(function(e){e.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(e){try{navigator.mediaSession.setActionHandler(e,(function(){}))}catch(e){}})),t.appendChild(s),r("createVideoElement done"),s}}},t={},function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(979);var e,t},"object"==typeof e&&"object"==typeof t?t.exports=n():"object"==typeof e?e.hydra_player_ums_sdk=n():i.hydra_player_ums_sdk=n()}}),J=h({"../node_modules/pako/lib/utils/common.js"(e){var t="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var r in n)i(n,r)&&(e[r]=n[r])}}return e},e.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,i,n,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),r);else for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){var t,i,n,r,s,a;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(a=new Uint8Array(n),r=0,t=0,i=e.length;t<i;t++)s=e[t],a.set(s,r),r+=s.length;return a}},r={arraySet:function(e,t,i,n,r){for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){return[].concat.apply([],e)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,n)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,r))},e.setTyped(t)}}),K=h({"../node_modules/pako/lib/zlib/trees.js"(e){var t=J();function i(e){for(var t=e.length;--t>=0;)e[t]=0}var n=256,r=286,s=30,a=15,o=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],c=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],d=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],h=new Array(576);i(h);var u=new Array(60);i(u);var g=new Array(512);i(g);var p=new Array(256);i(p);var m=new Array(29);i(m);var f,S,v,y=new Array(s);function C(e,t,i,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}function _(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function E(e){return e<256?g[e]:g[256+(e>>>7)]}function T(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function I(e,t,i){e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,T(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function b(e,t,i){I(e,i[2*t],i[2*t+1])}function A(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function R(e,t,i){var n,r,s=new Array(16),o=0;for(n=1;n<=a;n++)s[n]=o=o+i[n-1]<<1;for(r=0;r<=t;r++){var c=e[2*r+1];0!==c&&(e[2*r]=A(s[c]++,c))}}function w(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<s;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function P(e){e.bi_valid>8?T(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function M(e,i,n,r){P(e),r&&(T(e,n),T(e,~n)),t.arraySet(e.pending_buf,e.window,i,n,e.pending),e.pending+=n}function D(e,t,i,n){var r=2*t,s=2*i;return e[r]<e[s]||e[r]===e[s]&&n[t]<=n[i]}function O(e,t,i){for(var n=e.heap[i],r=i<<1;r<=e.heap_len&&(r<e.heap_len&&D(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!D(t,n,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=n}function k(e,t,i){var r,s,a,l,d=0;if(0!==e.last_lit)do{r=e.pending_buf[e.d_buf+2*d]<<8|e.pending_buf[e.d_buf+2*d+1],s=e.pending_buf[e.l_buf+d],d++,0===r?b(e,s,t):(b(e,(a=p[s])+n+1,t),0!==(l=o[a])&&I(e,s-=m[a],l),b(e,a=E(--r),i),0!==(l=c[a])&&I(e,r-=y[a],l))}while(d<e.last_lit);b(e,256,t)}function N(e,t){var i,n,r,s=t.dyn_tree,o=t.stat_desc.static_tree,c=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=573,i=0;i<l;i++)0!==s[2*i]?(e.heap[++e.heap_len]=d=i,e.depth[i]=0):s[2*i+1]=0;for(;e.heap_len<2;)s[2*(r=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[r]=0,e.opt_len--,c&&(e.static_len-=o[2*r+1]);for(t.max_code=d,i=e.heap_len>>1;i>=1;i--)O(e,s,i);r=l;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],O(e,s,1),n=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=n,s[2*r]=s[2*i]+s[2*n],e.depth[r]=(e.depth[i]>=e.depth[n]?e.depth[i]:e.depth[n])+1,s[2*i+1]=s[2*n+1]=r,e.heap[1]=r++,O(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,n,r,s,o,c,l=t.dyn_tree,d=t.max_code,h=t.stat_desc.static_tree,u=t.stat_desc.has_stree,g=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,m=t.stat_desc.max_length,f=0;for(s=0;s<=a;s++)e.bl_count[s]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<573;i++)(s=l[2*l[2*(n=e.heap[i])+1]+1]+1)>m&&(s=m,f++),l[2*n+1]=s,n>d||(e.bl_count[s]++,o=0,n>=p&&(o=g[n-p]),c=l[2*n],e.opt_len+=c*(s+o),u&&(e.static_len+=c*(h[2*n+1]+o)));if(0!==f){do{for(s=m-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[m]--,f-=2}while(f>0);for(s=m;0!==s;s--)for(n=e.bl_count[s];0!==n;)(r=e.heap[--i])>d||(l[2*r+1]!==s&&(e.opt_len+=(s-l[2*r+1])*l[2*r],l[2*r+1]=s),n--)}}(e,t),R(s,d,e.bl_count)}function L(e,t,i){var n,r,s=-1,a=t[1],o=0,c=7,l=4;for(0===a&&(c=138,l=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)r=a,a=t[2*(n+1)+1],++o<c&&r===a||(o<l?e.bl_tree[2*r]+=o:0!==r?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,s=r,0===a?(c=138,l=3):r===a?(c=6,l=3):(c=7,l=4))}function x(e,t,i){var n,r,s=-1,a=t[1],o=0,c=7,l=4;for(0===a&&(c=138,l=3),n=0;n<=i;n++)if(r=a,a=t[2*(n+1)+1],!(++o<c&&r===a)){if(o<l)do{b(e,r,e.bl_tree)}while(0!=--o);else 0!==r?(r!==s&&(b(e,r,e.bl_tree),o--),b(e,16,e.bl_tree),I(e,o-3,2)):o<=10?(b(e,17,e.bl_tree),I(e,o-3,3)):(b(e,18,e.bl_tree),I(e,o-11,7));o=0,s=r,0===a?(c=138,l=3):r===a?(c=6,l=3):(c=7,l=4)}}function U(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<n;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}i(y);var F=!1;function V(e,t,i,n){I(e,0+(n?1:0),3),M(e,t,i,!0)}e._tr_init=function(e){F||(function(){var e,t,i,n,d,_=new Array(16);for(i=0,n=0;n<28;n++)for(m[n]=i,e=0;e<1<<o[n];e++)p[i++]=n;for(p[i-1]=n,d=0,n=0;n<16;n++)for(y[n]=d,e=0;e<1<<c[n];e++)g[d++]=n;for(d>>=7;n<s;n++)for(y[n]=d<<7,e=0;e<1<<c[n]-7;e++)g[256+d++]=n;for(t=0;t<=a;t++)_[t]=0;for(e=0;e<=143;)h[2*e+1]=8,e++,_[8]++;for(;e<=255;)h[2*e+1]=9,e++,_[9]++;for(;e<=279;)h[2*e+1]=7,e++,_[7]++;for(;e<=287;)h[2*e+1]=8,e++,_[8]++;for(R(h,287,_),e=0;e<s;e++)u[2*e+1]=5,u[2*e]=A(e,5);f=new C(h,o,257,r,a),S=new C(u,c,0,s,a),v=new C(new Array(0),l,0,19,7)}(),F=!0),e.l_desc=new _(e.dyn_ltree,f),e.d_desc=new _(e.dyn_dtree,S),e.bl_desc=new _(e.bl_tree,v),e.bi_buf=0,e.bi_valid=0,w(e)},e._tr_stored_block=V,e._tr_flush_block=function(e,t,i,n){var r,s,a=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=U(e)),N(e,e.l_desc),N(e,e.d_desc),a=function(e){var t;for(L(e,e.dyn_ltree,e.l_desc.max_code),L(e,e.dyn_dtree,e.d_desc.max_code),N(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*d[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=r&&(r=s)):r=s=i+5,i+4<=r&&-1!==t?V(e,t,i,n):4===e.strategy||s===r?(I(e,2+(n?1:0),3),k(e,h,u)):(I(e,4+(n?1:0),3),function(e,t,i,n){var r;for(I(e,t-257,5),I(e,i-1,5),I(e,n-4,4),r=0;r<n;r++)I(e,e.bl_tree[2*d[r]+1],3);x(e,e.dyn_ltree,t-1),x(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),k(e,e.dyn_ltree,e.dyn_dtree)),w(e),n&&P(e)},e._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(p[i]+n+1)]++,e.dyn_dtree[2*E(t)]++),e.last_lit===e.lit_bufsize-1},e._tr_align=function(e){I(e,2,3),b(e,256,h),function(e){16===e.bi_valid?(T(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}}}),Y=h({"../node_modules/pako/lib/zlib/adler32.js"(e,t){t.exports=function(e,t,i,n){for(var r=65535&e,s=e>>>16&65535,a=0;0!==i;){i-=a=i>2e3?2e3:i;do{s=s+(r=r+t[n++]|0)|0}while(--a);r%=65521,s%=65521}return r|s<<16}}}),Q=h({"../node_modules/pako/lib/zlib/crc32.js"(e,t){var i=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();t.exports=function(e,t,n,r){var s=i,a=r+n;e^=-1;for(var o=r;o<a;o++)e=e>>>8^s[255&(e^t[o])];return~e}}}),X=h({"../node_modules/pako/lib/zlib/messages.js"(e,t){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}}}),Z=h({"../node_modules/pako/lib/zlib/deflate.js"(e){var t,i=J(),n=K(),r=Y(),s=Q(),a=X(),o=-2,c=258,l=262,d=103,h=113,u=666;function g(e,t){return e.msg=a[t],t}function p(e){return(e<<1)-(e>4?9:0)}function m(e){for(var t=e.length;--t>=0;)e[t]=0}function f(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(i.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function S(e,t){n._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,f(e.strm)}function v(e,t){e.pending_buf[e.pending++]=t}function y(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function C(e,t,n,a){var o=e.avail_in;return o>a&&(o=a),0===o?0:(e.avail_in-=o,i.arraySet(t,e.input,e.next_in,o,n),1===e.state.wrap?e.adler=r(e.adler,t,o,n):2===e.state.wrap&&(e.adler=s(e.adler,t,o,n)),e.next_in+=o,e.total_in+=o,o)}function _(e,t){var i,n,r=e.max_chain_length,s=e.strstart,a=e.prev_length,o=e.nice_match,d=e.strstart>e.w_size-l?e.strstart-(e.w_size-l):0,h=e.window,u=e.w_mask,g=e.prev,p=e.strstart+c,m=h[s+a-1],f=h[s+a];e.prev_length>=e.good_match&&(r>>=2),o>e.lookahead&&(o=e.lookahead);do{if(h[(i=t)+a]===f&&h[i+a-1]===m&&h[i]===h[s]&&h[++i]===h[s+1]){s+=2,i++;do{}while(h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&s<p);if(n=c-(p-s),s=p-c,n>a){if(e.match_start=t,a=n,n>=o)break;m=h[s+a-1],f=h[s+a]}}}while((t=g[t&u])>d&&0!=--r);return a<=e.lookahead?a:e.lookahead}function E(e){var t,n,r,s,a,o=e.w_size;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=o+(o-l)){i.arraySet(e.window,e.window,o,o,0),e.match_start-=o,e.strstart-=o,e.block_start-=o,t=n=e.hash_size;do{r=e.head[--t],e.head[t]=r>=o?r-o:0}while(--n);t=n=o;do{r=e.prev[--t],e.prev[t]=r>=o?r-o:0}while(--n);s+=o}if(0===e.strm.avail_in)break;if(n=C(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=n,e.lookahead+e.insert>=3)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=(e.ins_h<<e.hash_shift^e.window[a+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[a+3-1])&e.hash_mask,e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<l&&0!==e.strm.avail_in)}function T(e,t){for(var i,r;;){if(e.lookahead<l){if(E(e),e.lookahead<l&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-l&&(e.match_length=_(e,i)),e.match_length>=3)if(r=n._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else r=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}function I(e,t){for(var i,r,s;;){if(e.lookahead<l){if(E(e),e.lookahead<l&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-l&&(e.match_length=_(e,i),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,r=n._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(S(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((r=n._tr_tally(e,0,e.window[e.strstart-1]))&&S(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=n._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}function b(e,t,i,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=r}function A(e){e.window_size=2*e.w_size,m(e.head),e.max_lazy_match=t[e.level].max_lazy,e.good_match=t[e.level].good_length,e.nice_match=t[e.level].nice_length,e.max_chain_length=t[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0}function R(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(1146),this.dyn_dtree=new i.Buf16(122),this.bl_tree=new i.Buf16(78),m(this.dyn_ltree),m(this.dyn_dtree),m(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(16),this.heap=new i.Buf16(573),m(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(573),m(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function w(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:h,e.adler=2===t.wrap?0:1,t.last_flush=0,n._tr_init(t),0):g(e,o)}function P(e){var t=w(e);return 0===t&&A(e.state),t}function M(e,t,n,r,s,a){if(!e)return o;var c=1;if(-1===t&&(t=6),r<0?(c=0,r=-r):r>15&&(c=2,r-=16),s<1||s>9||8!==n||r<8||r>15||t<0||t>9||a<0||a>4)return g(e,o);8===r&&(r=9);var l=new R;return e.state=l,l.strm=e,l.wrap=c,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=s+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new i.Buf8(2*l.w_size),l.head=new i.Buf16(l.hash_size),l.prev=new i.Buf16(l.w_size),l.lit_bufsize=1<<s+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new i.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=a,l.method=n,P(e)}t=[new b(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(E(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+i;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,S(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-l&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(S(e,!1),e.strm.avail_out),1)})),new b(4,4,8,4,T),new b(4,5,16,8,T),new b(4,6,32,32,T),new b(4,4,16,16,I),new b(8,16,32,32,I),new b(8,16,128,128,I),new b(8,32,128,256,I),new b(32,128,258,1024,I),new b(32,258,258,4096,I)],e.deflateInit=function(e,t){return M(e,t,8,15,8,0)},e.deflateInit2=M,e.deflateReset=P,e.deflateResetKeep=w,e.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?o:(e.state.gzhead=t,0):o},e.deflate=function(e,i){var r,a,l,C;if(!e||!e.state||i>5||i<0)return e?g(e,o):o;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||a.status===u&&4!==i)return g(e,0===e.avail_out?-5:o);if(a.strm=e,r=a.last_flush,a.last_flush=i,42===a.status)if(2===a.wrap)e.adler=0,v(a,31),v(a,139),v(a,8),a.gzhead?(v(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),v(a,255&a.gzhead.time),v(a,a.gzhead.time>>8&255),v(a,a.gzhead.time>>16&255),v(a,a.gzhead.time>>24&255),v(a,9===a.level?2:a.strategy>=2||a.level<2?4:0),v(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(v(a,255&a.gzhead.extra.length),v(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=s(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=69):(v(a,0),v(a,0),v(a,0),v(a,0),v(a,0),v(a,9===a.level?2:a.strategy>=2||a.level<2?4:0),v(a,3),a.status=h);else{var _=8+(a.w_bits-8<<4)<<8;_|=(a.strategy>=2||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(_|=32),_+=31-_%31,a.status=h,y(a,_),0!==a.strstart&&(y(a,e.adler>>>16),y(a,65535&e.adler)),e.adler=1}if(69===a.status)if(a.gzhead.extra){for(l=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),f(e),l=a.pending,a.pending!==a.pending_buf_size));)v(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=73)}else a.status=73;if(73===a.status)if(a.gzhead.name){l=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),f(e),l=a.pending,a.pending===a.pending_buf_size)){C=1;break}C=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0,v(a,C)}while(0!==C);a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),0===C&&(a.gzindex=0,a.status=91)}else a.status=91;if(91===a.status)if(a.gzhead.comment){l=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),f(e),l=a.pending,a.pending===a.pending_buf_size)){C=1;break}C=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0,v(a,C)}while(0!==C);a.gzhead.hcrc&&a.pending>l&&(e.adler=s(e.adler,a.pending_buf,a.pending-l,l)),0===C&&(a.status=d)}else a.status=d;if(a.status===d&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&f(e),a.pending+2<=a.pending_buf_size&&(v(a,255&e.adler),v(a,e.adler>>8&255),e.adler=0,a.status=h)):a.status=h),0!==a.pending){if(f(e),0===e.avail_out)return a.last_flush=-1,0}else if(0===e.avail_in&&p(i)<=p(r)&&4!==i)return g(e,-5);if(a.status===u&&0!==e.avail_in)return g(e,-5);if(0!==e.avail_in||0!==a.lookahead||0!==i&&a.status!==u){var T=2===a.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(E(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,i=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}(a,i):3===a.strategy?function(e,t){for(var i,r,s,a,o=e.window;;){if(e.lookahead<=c){if(E(e),e.lookahead<=c&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=o[s=e.strstart-1])===o[++s]&&r===o[++s]&&r===o[++s]){a=e.strstart+c;do{}while(r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&s<a);e.match_length=c-(a-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=n._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}(a,i):t[a.level].func(a,i);if(3!==T&&4!==T||(a.status=u),1===T||3===T)return 0===e.avail_out&&(a.last_flush=-1),0;if(2===T&&(1===i?n._tr_align(a):5!==i&&(n._tr_stored_block(a,0,0,!1),3===i&&(m(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),f(e),0===e.avail_out))return a.last_flush=-1,0}return 4!==i?0:a.wrap<=0?1:(2===a.wrap?(v(a,255&e.adler),v(a,e.adler>>8&255),v(a,e.adler>>16&255),v(a,e.adler>>24&255),v(a,255&e.total_in),v(a,e.total_in>>8&255),v(a,e.total_in>>16&255),v(a,e.total_in>>24&255)):(y(a,e.adler>>>16),y(a,65535&e.adler)),f(e),a.wrap>0&&(a.wrap=-a.wrap),0!==a.pending?0:1)},e.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==d&&t!==h&&t!==u?g(e,o):(e.state=null,t===h?g(e,-3):0):o},e.deflateSetDictionary=function(e,t){var n,s,a,c,l,d,h,u,g=t.length;if(!e||!e.state)return o;if(2===(c=(n=e.state).wrap)||1===c&&42!==n.status||n.lookahead)return o;for(1===c&&(e.adler=r(e.adler,t,g,0)),n.wrap=0,g>=n.w_size&&(0===c&&(m(n.head),n.strstart=0,n.block_start=0,n.insert=0),u=new i.Buf8(n.w_size),i.arraySet(u,t,g-n.w_size,n.w_size,0),t=u,g=n.w_size),l=e.avail_in,d=e.next_in,h=e.input,e.avail_in=g,e.next_in=0,e.input=t,E(n);n.lookahead>=3;){s=n.strstart,a=n.lookahead-2;do{n.ins_h=(n.ins_h<<n.hash_shift^n.window[s+3-1])&n.hash_mask,n.prev[s&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=s,s++}while(--a);n.strstart=s,n.lookahead=2,E(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=d,e.input=h,e.avail_in=l,n.wrap=c,0},e.deflateInfo="pako deflate (from Nodeca project)"}}),ee=h({"../node_modules/pako/lib/utils/strings.js"(e){var t=J(),i=!0,n=!0;try{String.fromCharCode.apply(null,[0])}catch(e){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){n=!1}var r,s=new t.Buf8(256);for(r=0;r<256;r++)s[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;function a(e,r){if(r<65534&&(e.subarray&&n||!e.subarray&&i))return String.fromCharCode.apply(null,t.shrinkBuf(e,r));for(var s="",a=0;a<r;a++)s+=String.fromCharCode(e[a]);return s}s[254]=s[254]=1,e.string2buf=function(e){var i,n,r,s,a,o=e.length,c=0;for(s=0;s<o;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(r=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(r-56320),s++),c+=n<128?1:n<2048?2:n<65536?3:4;for(i=new t.Buf8(c),a=0,s=0;a<c;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(r=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(r-56320),s++),n<128?i[a++]=n:n<2048?(i[a++]=192|n>>>6,i[a++]=128|63&n):n<65536?(i[a++]=224|n>>>12,i[a++]=128|n>>>6&63,i[a++]=128|63&n):(i[a++]=240|n>>>18,i[a++]=128|n>>>12&63,i[a++]=128|n>>>6&63,i[a++]=128|63&n);return i},e.buf2binstring=function(e){return a(e,e.length)},e.binstring2buf=function(e){for(var i=new t.Buf8(e.length),n=0,r=i.length;n<r;n++)i[n]=e.charCodeAt(n);return i},e.buf2string=function(e,t){var i,n,r,o,c=t||e.length,l=new Array(2*c);for(n=0,i=0;i<c;)if((r=e[i++])<128)l[n++]=r;else if((o=s[r])>4)l[n++]=65533,i+=o-1;else{for(r&=2===o?31:3===o?15:7;o>1&&i<c;)r=r<<6|63&e[i++],o--;o>1?l[n++]=65533:r<65536?l[n++]=r:(r-=65536,l[n++]=55296|r>>10&1023,l[n++]=56320|1023&r)}return a(l,n)},e.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+s[e[i]]>t?i:t}}}),te=h({"../node_modules/pako/lib/zlib/zstream.js"(e,t){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}}}),ie=h({"../node_modules/pako/lib/deflate.js"(e){var t=Z(),i=J(),n=ee(),r=X(),s=te(),a=Object.prototype.toString;function o(e){if(!(this instanceof o))return new o(e);this.options=i.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var c=this.options;c.raw&&c.windowBits>0?c.windowBits=-c.windowBits:c.gzip&&c.windowBits>0&&c.windowBits<16&&(c.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new s,this.strm.avail_out=0;var l=t.deflateInit2(this.strm,c.level,c.method,c.windowBits,c.memLevel,c.strategy);if(0!==l)throw new Error(r[l]);if(c.header&&t.deflateSetHeader(this.strm,c.header),c.dictionary){var d;if(d="string"==typeof c.dictionary?n.string2buf(c.dictionary):"[object ArrayBuffer]"===a.call(c.dictionary)?new Uint8Array(c.dictionary):c.dictionary,0!==(l=t.deflateSetDictionary(this.strm,d)))throw new Error(r[l]);this._dict_set=!0}}function c(e,t){var i=new o(t);if(i.push(e,!0),i.err)throw i.msg||r[i.err];return i.result}o.prototype.push=function(e,r){var s,o,c=this.strm,l=this.options.chunkSize;if(this.ended)return!1;o=r===~~r?r:!0===r?4:0,"string"==typeof e?c.input=n.string2buf(e):"[object ArrayBuffer]"===a.call(e)?c.input=new Uint8Array(e):c.input=e,c.next_in=0,c.avail_in=c.input.length;do{if(0===c.avail_out&&(c.output=new i.Buf8(l),c.next_out=0,c.avail_out=l),1!==(s=t.deflate(c,o))&&0!==s)return this.onEnd(s),this.ended=!0,!1;0!==c.avail_out&&(0!==c.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(n.buf2binstring(i.shrinkBuf(c.output,c.next_out))):this.onData(i.shrinkBuf(c.output,c.next_out)))}while((c.avail_in>0||0===c.avail_out)&&1!==s);return 4===o?(s=t.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,0===s):2!==o||(this.onEnd(0),c.avail_out=0,!0)},o.prototype.onData=function(e){this.chunks.push(e)},o.prototype.onEnd=function(e){0===e&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},e.Deflate=o,e.deflate=c,e.deflateRaw=function(e,t){return(t=t||{}).raw=!0,c(e,t)},e.gzip=function(e,t){return(t=t||{}).gzip=!0,c(e,t)}}}),ne=h({"../node_modules/pako/lib/zlib/inffast.js"(e,t){t.exports=function(e,t){var i,n,r,s,a,o,c,l,d,h,u,g,p,m,f,S,v,y,C,_,E,T,I,b,A;i=e.state,n=e.next_in,b=e.input,r=n+(e.avail_in-5),s=e.next_out,A=e.output,a=s-(t-e.avail_out),o=s+(e.avail_out-257),c=i.dmax,l=i.wsize,d=i.whave,h=i.wnext,u=i.window,g=i.hold,p=i.bits,m=i.lencode,f=i.distcode,S=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{p<15&&(g+=b[n++]<<p,p+=8,g+=b[n++]<<p,p+=8),y=m[g&S];t:for(;;){if(g>>>=C=y>>>24,p-=C,0==(C=y>>>16&255))A[s++]=65535&y;else{if(!(16&C)){if(!(64&C)){y=m[(65535&y)+(g&(1<<C)-1)];continue t}if(32&C){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}_=65535&y,(C&=15)&&(p<C&&(g+=b[n++]<<p,p+=8),_+=g&(1<<C)-1,g>>>=C,p-=C),p<15&&(g+=b[n++]<<p,p+=8,g+=b[n++]<<p,p+=8),y=f[g&v];i:for(;;){if(g>>>=C=y>>>24,p-=C,!(16&(C=y>>>16&255))){if(!(64&C)){y=f[(65535&y)+(g&(1<<C)-1)];continue i}e.msg="invalid distance code",i.mode=30;break e}if(E=65535&y,p<(C&=15)&&(g+=b[n++]<<p,(p+=8)<C&&(g+=b[n++]<<p,p+=8)),(E+=g&(1<<C)-1)>c){e.msg="invalid distance too far back",i.mode=30;break e}if(g>>>=C,p-=C,E>(C=s-a)){if((C=E-C)>d&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(T=0,I=u,0===h){if(T+=l-C,C<_){_-=C;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}}else if(h<C){if(T+=l+h-C,(C-=h)<_){_-=C;do{A[s++]=u[T++]}while(--C);if(T=0,h<_){_-=C=h;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}}}else if(T+=h-C,C<_){_-=C;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}for(;_>2;)A[s++]=I[T++],A[s++]=I[T++],A[s++]=I[T++],_-=3;_&&(A[s++]=I[T++],_>1&&(A[s++]=I[T++]))}else{T=s-E;do{A[s++]=A[T++],A[s++]=A[T++],A[s++]=A[T++],_-=3}while(_>2);_&&(A[s++]=A[T++],_>1&&(A[s++]=A[T++]))}break}}break}}while(n<r&&s<o);n-=_=p>>3,g&=(1<<(p-=_<<3))-1,e.next_in=n,e.next_out=s,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=s<o?o-s+257:257-(s-o),i.hold=g,i.bits=p}}}),re=h({"../node_modules/pako/lib/zlib/inftrees.js"(e,t){var i=J(),n=15,r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,c,l,d,h,u,g){var p,m,f,S,v,y,C,_,E,T=g.bits,I=0,b=0,A=0,R=0,w=0,P=0,M=0,D=0,O=0,k=0,N=null,L=0,x=new i.Buf16(16),U=new i.Buf16(16),F=null,V=0;for(I=0;I<=n;I++)x[I]=0;for(b=0;b<l;b++)x[t[c+b]]++;for(w=T,R=n;R>=1&&0===x[R];R--);if(w>R&&(w=R),0===R)return d[h++]=20971520,d[h++]=20971520,g.bits=1,0;for(A=1;A<R&&0===x[A];A++);for(w<A&&(w=A),D=1,I=1;I<=n;I++)if(D<<=1,(D-=x[I])<0)return-1;if(D>0&&(0===e||1!==R))return-1;for(U[1]=0,I=1;I<n;I++)U[I+1]=U[I]+x[I];for(b=0;b<l;b++)0!==t[c+b]&&(u[U[t[c+b]]++]=b);if(0===e?(N=F=u,y=19):1===e?(N=r,L-=257,F=s,V-=257,y=256):(N=a,F=o,y=-1),k=0,b=0,I=A,v=h,P=w,M=0,f=-1,S=(O=1<<w)-1,1===e&&O>852||2===e&&O>592)return 1;for(;;){C=I-M,u[b]<y?(_=0,E=u[b]):u[b]>y?(_=F[V+u[b]],E=N[L+u[b]]):(_=96,E=0),p=1<<I-M,A=m=1<<P;do{d[v+(k>>M)+(m-=p)]=C<<24|_<<16|E}while(0!==m);for(p=1<<I-1;k&p;)p>>=1;if(0!==p?(k&=p-1,k+=p):k=0,b++,0==--x[I]){if(I===R)break;I=t[c+u[b]]}if(I>w&&(k&S)!==f){for(0===M&&(M=w),v+=A,D=1<<(P=I-M);P+M<R&&!((D-=x[P+M])<=0);)P++,D<<=1;if(O+=1<<P,1===e&&O>852||2===e&&O>592)return 1;d[f=k&S]=w<<24|P<<16|v-h}}return 0!==k&&(d[v+k]=I-M<<24|64<<16),g.bits=w,0}}}),se=h({"../node_modules/pako/lib/zlib/inflate.js"(e){var t=J(),i=Y(),n=Q(),r=ne(),s=re(),a=-2,o=12,c=30;function l(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function d(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function h(e){var i;return e&&e.state?(i=e.state,e.total_in=e.total_out=i.total=0,e.msg="",i.wrap&&(e.adler=1&i.wrap),i.mode=1,i.last=0,i.havedict=0,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new t.Buf32(852),i.distcode=i.distdyn=new t.Buf32(592),i.sane=1,i.back=-1,0):a}function u(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,h(e)):a}function g(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?a:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,u(e))):a}function p(e,t){var i,n;return e?(n=new d,e.state=n,n.window=null,0!==(i=g(e,t))&&(e.state=null),i):a}var m,f,S=!0;function v(e){if(S){var i;for(m=new t.Buf32(512),f=new t.Buf32(32),i=0;i<144;)e.lens[i++]=8;for(;i<256;)e.lens[i++]=9;for(;i<280;)e.lens[i++]=7;for(;i<288;)e.lens[i++]=8;for(s(1,e.lens,0,288,m,0,e.work,{bits:9}),i=0;i<32;)e.lens[i++]=5;s(2,e.lens,0,32,f,0,e.work,{bits:5}),S=!1}e.lencode=m,e.lenbits=9,e.distcode=f,e.distbits=5}function y(e,i,n,r){var s,a=e.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new t.Buf8(a.wsize)),r>=a.wsize?(t.arraySet(a.window,i,n-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):((s=a.wsize-a.wnext)>r&&(s=r),t.arraySet(a.window,i,n-r,s,a.wnext),(r-=s)?(t.arraySet(a.window,i,n-r,r,0),a.wnext=r,a.whave=a.wsize):(a.wnext+=s,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=s))),0}e.inflateReset=u,e.inflateReset2=g,e.inflateResetKeep=h,e.inflateInit=function(e){return p(e,15)},e.inflateInit2=p,e.inflate=function(e,d){var h,u,g,p,m,f,S,C,_,E,T,I,b,A,R,w,P,M,D,O,k,N,L,x,U=0,F=new t.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return a;(h=e.state).mode===o&&(h.mode=13),m=e.next_out,g=e.output,S=e.avail_out,p=e.next_in,u=e.input,f=e.avail_in,C=h.hold,_=h.bits,E=f,T=S,N=0;e:for(;;)switch(h.mode){case 1:if(0===h.wrap){h.mode=13;break}for(;_<16;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(2&h.wrap&&35615===C){h.check=0,F[0]=255&C,F[1]=C>>>8&255,h.check=n(h.check,F,2,0),C=0,_=0,h.mode=2;break}if(h.flags=0,h.head&&(h.head.done=!1),!(1&h.wrap)||(((255&C)<<8)+(C>>8))%31){e.msg="incorrect header check",h.mode=c;break}if(8!=(15&C)){e.msg="unknown compression method",h.mode=c;break}if(_-=4,k=8+(15&(C>>>=4)),0===h.wbits)h.wbits=k;else if(k>h.wbits){e.msg="invalid window size",h.mode=c;break}h.dmax=1<<k,e.adler=h.check=1,h.mode=512&C?10:o,C=0,_=0;break;case 2:for(;_<16;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(h.flags=C,8!=(255&h.flags)){e.msg="unknown compression method",h.mode=c;break}if(57344&h.flags){e.msg="unknown header flags set",h.mode=c;break}h.head&&(h.head.text=C>>8&1),512&h.flags&&(F[0]=255&C,F[1]=C>>>8&255,h.check=n(h.check,F,2,0)),C=0,_=0,h.mode=3;case 3:for(;_<32;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.head&&(h.head.time=C),512&h.flags&&(F[0]=255&C,F[1]=C>>>8&255,F[2]=C>>>16&255,F[3]=C>>>24&255,h.check=n(h.check,F,4,0)),C=0,_=0,h.mode=4;case 4:for(;_<16;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.head&&(h.head.xflags=255&C,h.head.os=C>>8),512&h.flags&&(F[0]=255&C,F[1]=C>>>8&255,h.check=n(h.check,F,2,0)),C=0,_=0,h.mode=5;case 5:if(1024&h.flags){for(;_<16;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.length=C,h.head&&(h.head.extra_len=C),512&h.flags&&(F[0]=255&C,F[1]=C>>>8&255,h.check=n(h.check,F,2,0)),C=0,_=0}else h.head&&(h.head.extra=null);h.mode=6;case 6:if(1024&h.flags&&((I=h.length)>f&&(I=f),I&&(h.head&&(k=h.head.extra_len-h.length,h.head.extra||(h.head.extra=new Array(h.head.extra_len)),t.arraySet(h.head.extra,u,p,I,k)),512&h.flags&&(h.check=n(h.check,u,I,p)),f-=I,p+=I,h.length-=I),h.length))break e;h.length=0,h.mode=7;case 7:if(2048&h.flags){if(0===f)break e;I=0;do{k=u[p+I++],h.head&&k&&h.length<65536&&(h.head.name+=String.fromCharCode(k))}while(k&&I<f);if(512&h.flags&&(h.check=n(h.check,u,I,p)),f-=I,p+=I,k)break e}else h.head&&(h.head.name=null);h.length=0,h.mode=8;case 8:if(4096&h.flags){if(0===f)break e;I=0;do{k=u[p+I++],h.head&&k&&h.length<65536&&(h.head.comment+=String.fromCharCode(k))}while(k&&I<f);if(512&h.flags&&(h.check=n(h.check,u,I,p)),f-=I,p+=I,k)break e}else h.head&&(h.head.comment=null);h.mode=9;case 9:if(512&h.flags){for(;_<16;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(C!==(65535&h.check)){e.msg="header crc mismatch",h.mode=c;break}C=0,_=0}h.head&&(h.head.hcrc=h.flags>>9&1,h.head.done=!0),e.adler=h.check=0,h.mode=o;break;case 10:for(;_<32;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}e.adler=h.check=l(C),C=0,_=0,h.mode=11;case 11:if(0===h.havedict)return e.next_out=m,e.avail_out=S,e.next_in=p,e.avail_in=f,h.hold=C,h.bits=_,2;e.adler=h.check=1,h.mode=o;case o:if(5===d||6===d)break e;case 13:if(h.last){C>>>=7&_,_-=7&_,h.mode=27;break}for(;_<3;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}switch(h.last=1&C,_-=1,3&(C>>>=1)){case 0:h.mode=14;break;case 1:if(v(h),h.mode=20,6===d){C>>>=2,_-=2;break e}break;case 2:h.mode=17;break;case 3:e.msg="invalid block type",h.mode=c}C>>>=2,_-=2;break;case 14:for(C>>>=7&_,_-=7&_;_<32;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if((65535&C)!=(C>>>16^65535)){e.msg="invalid stored block lengths",h.mode=c;break}if(h.length=65535&C,C=0,_=0,h.mode=15,6===d)break e;case 15:h.mode=16;case 16:if(I=h.length){if(I>f&&(I=f),I>S&&(I=S),0===I)break e;t.arraySet(g,u,p,I,m),f-=I,p+=I,S-=I,m+=I,h.length-=I;break}h.mode=o;break;case 17:for(;_<14;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(h.nlen=257+(31&C),C>>>=5,_-=5,h.ndist=1+(31&C),C>>>=5,_-=5,h.ncode=4+(15&C),C>>>=4,_-=4,h.nlen>286||h.ndist>30){e.msg="too many length or distance symbols",h.mode=c;break}h.have=0,h.mode=18;case 18:for(;h.have<h.ncode;){for(;_<3;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.lens[V[h.have++]]=7&C,C>>>=3,_-=3}for(;h.have<19;)h.lens[V[h.have++]]=0;if(h.lencode=h.lendyn,h.lenbits=7,L={bits:h.lenbits},N=s(0,h.lens,0,19,h.lencode,0,h.work,L),h.lenbits=L.bits,N){e.msg="invalid code lengths set",h.mode=c;break}h.have=0,h.mode=19;case 19:for(;h.have<h.nlen+h.ndist;){for(;w=(U=h.lencode[C&(1<<h.lenbits)-1])>>>16&255,P=65535&U,!((R=U>>>24)<=_);){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(P<16)C>>>=R,_-=R,h.lens[h.have++]=P;else{if(16===P){for(x=R+2;_<x;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(C>>>=R,_-=R,0===h.have){e.msg="invalid bit length repeat",h.mode=c;break}k=h.lens[h.have-1],I=3+(3&C),C>>>=2,_-=2}else if(17===P){for(x=R+3;_<x;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}_-=R,k=0,I=3+(7&(C>>>=R)),C>>>=3,_-=3}else{for(x=R+7;_<x;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}_-=R,k=0,I=11+(127&(C>>>=R)),C>>>=7,_-=7}if(h.have+I>h.nlen+h.ndist){e.msg="invalid bit length repeat",h.mode=c;break}for(;I--;)h.lens[h.have++]=k}}if(h.mode===c)break;if(0===h.lens[256]){e.msg="invalid code -- missing end-of-block",h.mode=c;break}if(h.lenbits=9,L={bits:h.lenbits},N=s(1,h.lens,0,h.nlen,h.lencode,0,h.work,L),h.lenbits=L.bits,N){e.msg="invalid literal/lengths set",h.mode=c;break}if(h.distbits=6,h.distcode=h.distdyn,L={bits:h.distbits},N=s(2,h.lens,h.nlen,h.ndist,h.distcode,0,h.work,L),h.distbits=L.bits,N){e.msg="invalid distances set",h.mode=c;break}if(h.mode=20,6===d)break e;case 20:h.mode=21;case 21:if(f>=6&&S>=258){e.next_out=m,e.avail_out=S,e.next_in=p,e.avail_in=f,h.hold=C,h.bits=_,r(e,T),m=e.next_out,g=e.output,S=e.avail_out,p=e.next_in,u=e.input,f=e.avail_in,C=h.hold,_=h.bits,h.mode===o&&(h.back=-1);break}for(h.back=0;w=(U=h.lencode[C&(1<<h.lenbits)-1])>>>16&255,P=65535&U,!((R=U>>>24)<=_);){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(w&&!(240&w)){for(M=R,D=w,O=P;w=(U=h.lencode[O+((C&(1<<M+D)-1)>>M)])>>>16&255,P=65535&U,!(M+(R=U>>>24)<=_);){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}C>>>=M,_-=M,h.back+=M}if(C>>>=R,_-=R,h.back+=R,h.length=P,0===w){h.mode=26;break}if(32&w){h.back=-1,h.mode=o;break}if(64&w){e.msg="invalid literal/length code",h.mode=c;break}h.extra=15&w,h.mode=22;case 22:if(h.extra){for(x=h.extra;_<x;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.length+=C&(1<<h.extra)-1,C>>>=h.extra,_-=h.extra,h.back+=h.extra}h.was=h.length,h.mode=23;case 23:for(;w=(U=h.distcode[C&(1<<h.distbits)-1])>>>16&255,P=65535&U,!((R=U>>>24)<=_);){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(!(240&w)){for(M=R,D=w,O=P;w=(U=h.distcode[O+((C&(1<<M+D)-1)>>M)])>>>16&255,P=65535&U,!(M+(R=U>>>24)<=_);){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}C>>>=M,_-=M,h.back+=M}if(C>>>=R,_-=R,h.back+=R,64&w){e.msg="invalid distance code",h.mode=c;break}h.offset=P,h.extra=15&w,h.mode=24;case 24:if(h.extra){for(x=h.extra;_<x;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}h.offset+=C&(1<<h.extra)-1,C>>>=h.extra,_-=h.extra,h.back+=h.extra}if(h.offset>h.dmax){e.msg="invalid distance too far back",h.mode=c;break}h.mode=25;case 25:if(0===S)break e;if(I=T-S,h.offset>I){if((I=h.offset-I)>h.whave&&h.sane){e.msg="invalid distance too far back",h.mode=c;break}I>h.wnext?(I-=h.wnext,b=h.wsize-I):b=h.wnext-I,I>h.length&&(I=h.length),A=h.window}else A=g,b=m-h.offset,I=h.length;I>S&&(I=S),S-=I,h.length-=I;do{g[m++]=A[b++]}while(--I);0===h.length&&(h.mode=21);break;case 26:if(0===S)break e;g[m++]=h.length,S--,h.mode=21;break;case 27:if(h.wrap){for(;_<32;){if(0===f)break e;f--,C|=u[p++]<<_,_+=8}if(T-=S,e.total_out+=T,h.total+=T,T&&(e.adler=h.check=h.flags?n(h.check,g,T,m-T):i(h.check,g,T,m-T)),T=S,(h.flags?C:l(C))!==h.check){e.msg="incorrect data check",h.mode=c;break}C=0,_=0}h.mode=28;case 28:if(h.wrap&&h.flags){for(;_<32;){if(0===f)break e;f--,C+=u[p++]<<_,_+=8}if(C!==(4294967295&h.total)){e.msg="incorrect length check",h.mode=c;break}C=0,_=0}h.mode=29;case 29:N=1;break e;case c:N=-3;break e;case 31:return-4;default:return a}return e.next_out=m,e.avail_out=S,e.next_in=p,e.avail_in=f,h.hold=C,h.bits=_,(h.wsize||T!==e.avail_out&&h.mode<c&&(h.mode<27||4!==d))&&y(e,e.output,e.next_out,T-e.avail_out),E-=e.avail_in,T-=e.avail_out,e.total_in+=E,e.total_out+=T,h.total+=T,h.wrap&&T&&(e.adler=h.check=h.flags?n(h.check,g,T,e.next_out-T):i(h.check,g,T,e.next_out-T)),e.data_type=h.bits+(h.last?64:0)+(h.mode===o?128:0)+(20===h.mode||15===h.mode?256:0),(0===E&&0===T||4===d)&&0===N&&(N=-5),N},e.inflateEnd=function(e){if(!e||!e.state)return a;var t=e.state;return t.window&&(t.window=null),e.state=null,0},e.inflateGetHeader=function(e,t){var i;return e&&e.state&&2&(i=e.state).wrap?(i.head=t,t.done=!1,0):a},e.inflateSetDictionary=function(e,t){var n,r=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?a:11===n.mode&&i(1,t,r,0)!==n.check?-3:y(e,t,r,r)?(n.mode=31,-4):(n.havedict=1,0):a},e.inflateInfo="pako inflate (from Nodeca project)"}}),ae=h({"../node_modules/pako/lib/zlib/constants.js"(e,t){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}}}),oe=h({"../node_modules/pako/lib/zlib/gzheader.js"(e,t){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}}}),ce=h({"../node_modules/pako/lib/inflate.js"(e){var t=se(),i=J(),n=ee(),r=ae(),s=X(),a=te(),o=oe(),c=Object.prototype.toString;function l(e){if(!(this instanceof l))return new l(e);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},e||{});var d=this.options;d.raw&&d.windowBits>=0&&d.windowBits<16&&(d.windowBits=-d.windowBits,0===d.windowBits&&(d.windowBits=-15)),!(d.windowBits>=0&&d.windowBits<16)||e&&e.windowBits||(d.windowBits+=32),d.windowBits>15&&d.windowBits<48&&!(15&d.windowBits)&&(d.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var h=t.inflateInit2(this.strm,d.windowBits);if(h!==r.Z_OK)throw new Error(s[h]);if(this.header=new o,t.inflateGetHeader(this.strm,this.header),d.dictionary&&("string"==typeof d.dictionary?d.dictionary=n.string2buf(d.dictionary):"[object ArrayBuffer]"===c.call(d.dictionary)&&(d.dictionary=new Uint8Array(d.dictionary)),d.raw&&(h=t.inflateSetDictionary(this.strm,d.dictionary))!==r.Z_OK))throw new Error(s[h])}function d(e,t){var i=new l(t);if(i.push(e,!0),i.err)throw i.msg||s[i.err];return i.result}l.prototype.push=function(e,s){var a,o,l,d,h,u=this.strm,g=this.options.chunkSize,p=this.options.dictionary,m=!1;if(this.ended)return!1;o=s===~~s?s:!0===s?r.Z_FINISH:r.Z_NO_FLUSH,"string"==typeof e?u.input=n.binstring2buf(e):"[object ArrayBuffer]"===c.call(e)?u.input=new Uint8Array(e):u.input=e,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new i.Buf8(g),u.next_out=0,u.avail_out=g),(a=t.inflate(u,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&p&&(a=t.inflateSetDictionary(this.strm,p)),a===r.Z_BUF_ERROR&&!0===m&&(a=r.Z_OK,m=!1),a!==r.Z_STREAM_END&&a!==r.Z_OK)return this.onEnd(a),this.ended=!0,!1;u.next_out&&(0!==u.avail_out&&a!==r.Z_STREAM_END&&(0!==u.avail_in||o!==r.Z_FINISH&&o!==r.Z_SYNC_FLUSH)||("string"===this.options.to?(l=n.utf8border(u.output,u.next_out),d=u.next_out-l,h=n.buf2string(u.output,l),u.next_out=d,u.avail_out=g-d,d&&i.arraySet(u.output,u.output,l,d,0),this.onData(h)):this.onData(i.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(m=!0)}while((u.avail_in>0||0===u.avail_out)&&a!==r.Z_STREAM_END);return a===r.Z_STREAM_END&&(o=r.Z_FINISH),o===r.Z_FINISH?(a=t.inflateEnd(this.strm),this.onEnd(a),this.ended=!0,a===r.Z_OK):o!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),u.avail_out=0,!0)},l.prototype.onData=function(e){this.chunks.push(e)},l.prototype.onEnd=function(e){e===r.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},e.Inflate=l,e.inflate=d,e.inflateRaw=function(e,t){return(t=t||{}).raw=!0,d(e,t)},e.ungzip=d}}),le=h({"../node_modules/pako/index.js"(e,t){var i={};(0,J().assign)(i,ie(),ce(),ae()),t.exports=i}}),de=h({"../signaling-agent/node_modules/sdp-transform/lib/grammar.js"(e,t){var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"rtcp-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"x-signaling-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))}}),he=h({"../signaling-agent/node_modules/sdp-transform/lib/parser.js"(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var s=e.push?{}:r?i[e.name]:i;(function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(i[n[s]]=t(e[s+1]))})(n.match(e.reg),s,e.names,e.name),e.push&&i[e.push].push(s)},n=de(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var o=0;o<(n[t]||[]).length;o+=1){var c=n[t][o];if(c.reg.test(r))return i(c,a,r)}})),t.media=s,t};var s=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}}}),ue=h({"../signaling-agent/node_modules/sdp-transform/lib/writer.js"(e,t){var i=de(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?n.push(i[t.name][a]):n.push(i[t.names[s]])}else n.push(i[t.name]);return r.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||a,r=t.innerOrder||o,c=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))})),e.media.forEach((function(e){c.push(s("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))}))})),c.join("\r\n")+"\r\n"}}}),ge=h({"../signaling-agent/node_modules/sdp-transform/lib/index.js"(e){var t=he(),i=ue();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList}}),pe=h({"../skype-calling-utilities/dist/skype-calling-utilities.bundle.js"(e,t){var i,n;i=e,n=(e,t)=>{var i={},n={exports:i},r=Object.defineProperty,s=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,c={};((e,t)=>{for(var i in t)r(e,i,{get:t[i],enumerable:!0})})(c,{SlimCoreElectronControlCapturer:()=>f}),n.exports=(e=>((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of a(t))o.call(e,c)||c===i||r(e,c,{get:()=>t[c],enumerable:!(n=s(t,c))||n.enumerable});return e})(r({},"__esModule",{value:!0}),e))(c);var l=p;function d(e){if(!e)return`${e}`;if(e instanceof Map)return function(e){const t={};return e.forEach(((e,i)=>{t[i.toString()]=e})),JSON.stringify(t)}(e);const t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}var h,u=class{constructor(e){this.eventLogger=e,this.subscriptions=[]}subscribe(e){return new g(this.subscriptions,e)}dispose(e){this.subscriptions=[]}raiseEvents(e){this.subscriptions.slice().forEach((t=>{try{void 0!==t.eventHandler&&e(t.eventHandler)}catch(e){this.eventLogger?.warn?.("Event handler exception caught!",d(e))}}))}},g=class{constructor(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}dispose(){(0,l.remove)(this.subscriptions,(e=>e===this)),this.eventHandler=void 0}},m=class extends u{constructor(e){super(e)}changed(e,t){return this.subscribe({changed:{skipEventConfig:t,handler:e},on:void 0})}on(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})}once(e,t,i){let n;return n=this.on(e,this._fromEventCallback(((...e)=>{n.dispose(i),this._toEventCallback(t)(...e)}))),n}raiseChanged(e){this.raiseEvents((t=>{if(!t.changed)return;const{skipEventConfig:i,handler:n}=t.changed;!this.getShouldSkipChangedEvent(e,i)&&n()}))}event(e){return{raise:this._fromEventCallback(((...t)=>this._raiseEventImpl(String(e),...t)))}}_raiseEventImpl(e,...t){this.raiseEvents((i=>i.on&&i.on.name===e&&i.on.handler(...t)))}_toEventCallback(e){return e}_fromEventCallback(e){return e}getShouldSkipChangedEvent(e,t){return e?.skipDominantSpeakerUpdatesOnCall?!!t?.skipDominantSpeakerUpdatesOnCall:!!e?.skipParticipantsUpdatesOnCall&&!!t?.skipParticipantsUpdatesOnCall}};(e=>{e.encodeMouseEvent=function(e){if(!e)return new Uint8Array(0);e.buttonType||(e.buttonType=0),e.xPos||(e.xPos=0),e.yPos||(e.yPos=0),e.wheelRotation||(e.wheelRotation=0);const t=new ArrayBuffer(7),i=new DataView(t),n=3&e.type,r=(7&e.buttonType)<<2,s=(e.buttonDown?1:0)<<5,a=(e.wheelButtonDown?1:0)<<6;return i.setUint8(0,1),i.setUint8(1,n|r|s|a),i.setUint16(2,e.xPos,!0),i.setUint16(4,e.yPos,!0),i.setUint8(6,e.wheelRotation),new Uint8Array(t)},e.encodeKeyboardEvent=function(e){const t=new ArrayBuffer(3),i=new DataView(t),n=3&e.codeType,r=(e.keyUp?1:0)<<4,s=(e.repeat?1:0)<<5;return i.setUint8(0,0),i.setUint8(1,n|r|s),i.setUint8(2,e.code),new Uint8Array(t)},e.decodeEventType=function(e){return e[0]},e.decodeMouseEvent=function(e){if(1!==e[0]||7!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{type:3&i,buttonType:i>>2&7,buttonDown:!!(i>>5&1),wheelButtonDown:!!(i>>6&1),xPos:t.getUint16(2,!0),yPos:t.getUint16(4,!0),wheelRotation:t.getUint8(6)}},e.decodeKeyboardEvent=function(e){if(0!==e[0]||3!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{codeType:3&i,code:t.getUint8(2),repeat:!!(i>>5&1),keyUp:!!(i>>4&1)}}})(h||(h={}));var f=class extends m{constructor(e,t,i=!0,n=1){super(),this._logger=e,this._element=t,this._captureRegionPreserveAspectRatio=i,this._mouseMoveCount=0,this._mouseMoveStartTime=0,this._isMouseDown=!1,this._isMouseOnRenderer=!1,this._captureMode=0,this._pollTimerID=0,this._resizeTimerID=0,this._mouseMoveThrottlingEnabled=!1,this._handleResizeEvents=()=>{clearTimeout(this._resizeTimerID),this._resizeTimerID=window.setTimeout((()=>{this.updateCaptureRegion()}),250)},this._handleMouseLeave=e=>{!this._isOnScreenContent(e)&&this._isMouseOnRenderer&&(this._raiseCaptureEvent(2),this._logger.info("Mouse leaving render region")),this._isMouseOnRenderer=!1},this._handleMouseEnter=e=>{this._isOnScreenContent(e)&&(this._isMouseOnRenderer=!0,this._raiseCaptureEvent(1),this._logger.info("Mouse entering render region"))},this._handleLosingFocus=()=>{this._syncKeyStates(!0)},this._handleClick=e=>{this._isOnScreenContent(e)&&(this._raiseCaptureEvent(0),this._logger.info("Mouse clicked"))},this._handleMouseMove=e=>{if(!this._isOnScreenContent(e)&&this._isMouseOnRenderer)return this._raiseCaptureEvent(2),this._isMouseOnRenderer=!1,void this._logger.info("Mouse leaving render region");if(this._isOnScreenContent(e)&&!this._isMouseOnRenderer&&(this._raiseCaptureEvent(1),this._isMouseOnRenderer=!0,this._logger.info("Mouse entering render region")),2!==this._captureMode&&3!==this._captureMode)return;if(this._mouseMoveCount++,this._mouseMoveThrottlingEnabled){if(!this._isOnScreenContent(e)||!this._shouldMoveMouse())return}else if(!this._isOnScreenContent(e)||this._mouseMoveCount%2==0)return;const t={type:0};this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleMouseDown=e=>{if(2!==this._captureMode&&3!==this._captureMode)return;if(!this._isOnScreenContent(e))return;const t={type:2,buttonType:S(e.button),buttonDown:!0};this._isMouseDown=!0,this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleMouseUp=e=>{if(2!==this._captureMode&&3!==this._captureMode)return;if(!this._isOnScreenContent(e))return;const t={type:2,buttonType:S(e.button),buttonDown:!1};this._isMouseDown=!1,this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleKeyDown=e=>{this._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!1}),e.stopPropagation(),e.preventDefault()},this._handleKeyUp=e=>{this._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!0}),e.stopPropagation(),e.preventDefault()},this._handleWheel=e=>{this._raiseMouseEvent({type:1,wheelRotation:e.deltaY>0?-120:120})},this._handleContextMenu=e=>{e.preventDefault()},this._ensureCanReceiveKeyboardInput(),this._element.ownerDocument?.defaultView?.addEventListener("resize",this._handleResizeEvents,!1),this._captureRegion={left:0,top:0,width:this._element.clientWidth,height:this._element.clientHeight},this._videoSize={width:Math.floor(t.clientHeight*n),height:t.clientHeight},this._origElementSize={width:0,height:0},this._checkElementSize(),this._mouseMoveStartTime=new Date(0).getTime()}get captureMode(){return this._captureMode}get captureRegion(){return this._captureRegion}setMouseMoveThrottlingFeatureFlag(e){this._mouseMoveThrottlingEnabled=e}dispose(e){this._logger.info(`dispose causeId: ${e}`),window.clearTimeout(this._pollTimerID),this._element.ownerDocument?.defaultView?.removeEventListener("resize",this._handleResizeEvents,!1),super.dispose(e)}updateVideoSize(e,t){this._videoSize.width=e,this._videoSize.height=t,this.updateCaptureRegion()}updateCaptureRegion(){this._captureRegionPreserveAspectRatio?(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientWidth*this._videoSize.height/this._videoSize.width,this._captureRegion.height>this._element.clientHeight?(this._captureRegion.width=this._element.clientHeight*this._videoSize.width/this._videoSize.height,this._captureRegion.height=this._element.clientHeight,this._captureRegion.left=(this._element.clientWidth-this._captureRegion.width)/2,this._captureRegion.top=0):(this._captureRegion.left=0,this._captureRegion.top=(this._element.clientHeight-this._captureRegion.height)/2)):(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientHeight,this._captureRegion.top=0,this._captureRegion.left=0)}setCaptureMode(e){3===this._captureMode&&3!==e&&this._syncKeyStates(!0),this._captureMode=e,0!==e?("none"===this._element.style.pointerEvents&&this._logger.warn("Element pointer-events is 'none', event handlers will not work"),this._element.addEventListener("click",this._handleClick),this._element.addEventListener("pointermove",this._handleMouseMove),this._element.addEventListener("pointerdown",this._handleMouseDown),this._element.addEventListener("pointerup",this._handleMouseUp),this._element.addEventListener("pointerenter",this._handleMouseEnter),this._element.addEventListener("pointerleave",this._handleMouseLeave),3===e?(this._element.addEventListener("wheel",this._handleWheel),this._element.addEventListener("keydown",this._handleKeyDown),this._element.addEventListener("keyup",this._handleKeyUp),this._element.addEventListener("contextmenu",this._handleContextMenu),this._element.addEventListener("blur",this._handleLosingFocus)):(this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))):(this._element.removeEventListener("pointermove",this._handleMouseMove),this._element.removeEventListener("pointerdown",this._handleMouseDown),this._element.removeEventListener("pointerup",this._handleMouseUp),this._element.removeEventListener("pointerenter",this._handleMouseEnter),this._element.removeEventListener("pointerleave",this._handleMouseLeave),this._element.removeEventListener("click",this._handleClick),this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))}_ensureCanReceiveKeyboardInput(){this._element.tabIndex=this._element.tabIndex}_checkElementSize(){this._origElementSize.width===this._element.clientWidth&&this._origElementSize.height===this._element.clientHeight||(this.updateCaptureRegion(),this._origElementSize.width=this._element.clientWidth,this._origElementSize.height=this._element.clientHeight),this._pollTimerID=window.setTimeout((()=>{this._checkElementSize()}),3e3)}_raiseMouseEvent(e){this.event("mouseControlEvent").raise(e)}_raiseKeyboardEvent(e){this.event("keyboardControlEvent").raise(e)}_raiseCaptureEvent(e){this.event("ctrlCaptureEvent").raise(e)}_normalizeMousePosition(e,t){t.xPos=(e.offsetX-this._captureRegion.left)/this._captureRegion.width*65535,t.yPos=(e.offsetY-this._captureRegion.top)/this._captureRegion.height*65535}_isOnScreenContent(e){const t=this._captureRegion.left,i=this._captureRegion.left+this._captureRegion.width,n=this._captureRegion.top,r=this._captureRegion.top+this._captureRegion.height;return t<=e.offsetX&&e.offsetX<i&&n<=e.offsetY&&e.offsetY<r}_shouldMoveMouse(){if(this._mouseMoveStartTime){const e=(new Date).getTime(),t=e-this._mouseMoveStartTime;if(this._isMouseDown&&t>=30||!this._isMouseDown&&t>=50)return this._mouseMoveStartTime=e,!0}else this._mouseMoveStartTime=(new Date).getTime();return!1}_syncKeyStates(e){this._raiseKeyboardEvent({codeType:1,code:17,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:16,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:18,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:91,repeat:!1,keyUp:e}),this._logger.info("Synced Key states.")}static formatMouseEvent(e){return h.encodeMouseEvent(e)}static formatKeyboardEvent(e){return h.encodeKeyboardEvent(e)}};function S(e){switch(e){case 0:return 0;case 2:return 1;case 1:return 2;default:return}}if("object"==typeof n.exports&&"object"==typeof i){n.exports=((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,r)||r===i||Object.defineProperty(e,r,{get:()=>t[r],enumerable:!(n=Object.getOwnPropertyDescriptor(t,r))||n.enumerable});return e})(n.exports,i)}return n.exports},"object"==typeof e&&"object"==typeof t?t.exports=n():"object"==typeof e?e["skype-calling-utilities"]=n():i["skype-calling-utilities"]=n(i["@skype/rt-js-bindings"],i.lodash)}}),me=h({"../node_modules/synctasks/dist/SyncTasks.js"(e){function t(e){return null!=e&&"function"==typeof e.then}function i(e){return null!=e&&"function"==typeof e.cancel}function n(t,i){if(!e.config.catchExceptions)return t();try{return t()}catch(e){return i(e)}}Object.defineProperty(e,"__esModule",{value:!0}),e.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(e){throw e}},e.fromThenable=function(e){var t=h();return e.then((function(e){t.resolve(e)}),(function(e){t.reject(e)})),t.promise().thenAsync((function(e){return e}))};var r,s,a,o=[],c="undefined"!=typeof setImmediate;function l(e){o.push(e),1===o.length&&(c?setImmediate(d):setTimeout(d,0))}function d(){var e=o;o=[];for(var t=0;t<e.length;t++)e[t]()}function h(){return new r.SyncTask}function u(e){return(new r.SyncTask).resolve(e).promise()}function g(e){var n=h(),s=!1;return n.onCancel((function(t){e.forEach((function(e){i(e)&&r.SyncTask.cancelOtherInternal(e,t)}))})),e.forEach((function(e){t(e)?e.then((function(e){s||(s=!0,n.resolve(e))}),(function(e){s||(s=!0,n.reject(e))})):s||(s=!0,n.resolve(e))})),n.promise()}e.asyncCallback=l,s=r||(r={}),a=function(){function r(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return r.prototype._addCallbackSet=function(e,t){var i=this,n=new r;return n.onCancel((function(t){e.wasCanceled=!0,e.cancelContext=t,i._cancelInternal(t)})),e.task=n,this._storedCallbackSets.push(e),t?this._mustHandleError=!1:n._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),n.promise()},r.prototype.onCancel=function(e){return this._completedSuccess||this._completedFail||(this._wasCanceled?e(this._cancelContext):this._cancelCallbacks.push(e)),this},r.prototype.then=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t},!0)},r.prototype.thenAsync=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t,asyncCallback:!0},!0)},r.prototype.catch=function(e){return this._addCallbackSet({failFunc:e},!0)},r.prototype.always=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!0)},r.prototype.setTracingEnabled=function(e){return this._traceEnabled=e,this},r.prototype.finally=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!1),this},r.prototype.done=function(e){return this._addCallbackSet({successFunc:e},!1),this},r.prototype.fail=function(e){return this._addCallbackSet({failFunc:e},!1),this},r.prototype.resolve=function(e){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=e,this._cancelCallbacks=[],this._resolveSuccesses(),this},r.prototype.reject=function(e){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=e,this._cancelCallbacks=[],this._resolveFailures(),r._enforceErrorHandled(this),this},r.prototype._checkState=function(t){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var i="Failed to "+(t?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(i)}(e.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},r._enforceErrorHandled=function(t){t._mustHandleError&&(r._rejectedTasks.push(t),r._enforceErrorHandledTimer||(r._enforceErrorHandledTimer=setTimeout((function(){r._enforceErrorHandledTimer=void 0;var t=r._rejectedTasks;r._rejectedTasks=[],t.forEach((function(t,i){t._mustHandleError&&e.config.unhandledErrorHandler(t._storedErrResolution)}))}),0)))},r.prototype.cancel=function(e){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(e)},r.prototype._cancelInternal=function(e){var t=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=e;var i=this._cancelCallbacks;this._cancelCallbacks=[],i.length>0&&i.forEach((function(e){t._completedSuccess||t._completedFail||e(t._cancelContext)}))}},r.cancelOtherInternal=function(e,t){var i=e;i._storedCallbackSets&&i._cancelInternal?i._cancelInternal(t):e.cancel(t)},r.prototype.promise=function(){return this},r.prototype._resolveSuccesses=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?l((function(){return e._resolveSuccessCallback(t)})):e._resolveSuccessCallback(t)}))}this._resolving=!1},r.prototype._resolveSuccessCallback=function(e){var s=this;e.successFunc?n((function(){var n=e.successFunc(s._storedResolution);i(n)&&(e.wasCanceled?r.cancelOtherInternal(n,e.cancelContext):e.task.onCancel((function(e){return r.cancelOtherInternal(n,e)}))),t(n)?n.then((function(t){e.task.resolve(t)}),(function(t){e.task.reject(t)})):e.task.resolve(n)}),(function(t){s._handleException(t,"SyncTask caught exception in success block: "+t.toString()),e.task.reject(t)})):e.task.resolve(this._storedResolution)},r.prototype._resolveFailures=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?l((function(){return e._resolveFailureCallback(t)})):e._resolveFailureCallback(t)}))}this._resolving=!1},r.prototype._resolveFailureCallback=function(e){var s=this;e.failFunc?n((function(){var n=e.failFunc(s._storedErrResolution);i(n)&&(e.wasCanceled?r.cancelOtherInternal(n,e.cancelContext):e.task.onCancel((function(e){return r.cancelOtherInternal(n,e)}))),t(n)?n.then((function(t){e.task.resolve(t)}),(function(t){e.task.reject(t)})):e.task.resolve(n)}),(function(t){s._handleException(t,"SyncTask caught exception in failure block: "+t.toString()),e.task.reject(t)})):e.task.reject(this._storedErrResolution)},r.prototype._handleException=function(t,i){e.config.exceptionsToConsole&&console.error(i),e.config.exceptionHandler&&e.config.exceptionHandler(t)},r.prototype.toEs6Promise=function(){var e=this;return new Promise((function(t,i){return e.then(t,i)}))},r._rejectedTasks=[],r}(),s.SyncTask=a,e.all=function(e){if(0===e.length)return u([]);var n,s=h(),a=e.length,o=Array(e.length);s.onCancel((function(t){e.forEach((function(e){i(e)&&r.SyncTask.cancelOtherInternal(e,t)}))}));var c=function(){0==--a&&(void 0!==n?s.reject(n):s.resolve(o))};return e.forEach((function(e,i){t(e)?e.then((function(e){o[i]=e,c()}),(function(e){void 0===n&&(n=void 0===e||e),c()})):(o[i]=e,c())})),s.promise()},e.Defer=h,e.Resolved=u,e.Rejected=function(e){return(new r.SyncTask).reject(e).promise()},e.race=g,e.raceTimer=function(e,t){var i=h(),n=setTimeout((function(){i.resolve({timedOut:!0})}),t);return g([e.then((function(e){return clearTimeout(n),{timedOut:!1,result:e}})),i.promise()])}}}),fe=h({"../node_modules/sdp-transform/lib/grammar.js"(e,t){var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"rtcp-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"x-signaling-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{name:"xMultiStream",reg:/^x-multi-stream:(\d*) (\d*) (\d*) (\d*)/,names:["numberOfStreams","startSsrc","ssrcRange","ssrcGroupRange"],format:"x-multi-stream:%d %d %d %d"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))}}),Se=h({"../node_modules/sdp-transform/lib/parser.js"(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var s=e.push?{}:r?i[e.name]:i;(function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(i[n[s]]=t(e[s+1]))})(n.match(e.reg),s,e.names,e.name),e.push&&i[e.push].push(s)},n=fe(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var o=0;o<(n[t]||[]).length;o+=1){var c=n[t][o];if(c.reg.test(r))return i(c,a,r)}})),t.media=s,t};var s=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}}}),ve=h({"../node_modules/sdp-transform/lib/writer.js"(e,t){var i=fe(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?n.push(i[t.name][a]):n.push(i[t.names[s]])}else n.push(i[t.name]);return r.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||a,r=t.innerOrder||o,c=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))})),e.media.forEach((function(e){c.push(s("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))}))})),c.join("\r\n")+"\r\n"}}}),ye=h({"../node_modules/sdp-transform/lib/index.js"(e){var t=Se(),i=ve();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList}}),Ce={};u(Ce,{HttpRequestDispatcherImplementation:()=>Be,generateCauseId:()=>Te,getOvb:()=>Zt,getVersion:()=>Xt,pluginlessStackFactory:()=>aF}),r.exports=(e=>m(a({},"__esModule",{value:!0}),e))(Ce);var _e=f(q()),Ee=8;function Te(){const e="abcdef0123456789";let t="";for(let i=0;i<Ee;i++)t+=e.charAt(Math.floor(16*Math.random()));return t}var Ie=g,be=p,Ae=class e{constructor(e,t,i=""){this.ulLogComponent=e,this.ulSafeComponent=t,this._getPrefix=(0,be.isFunction)(i)?i:()=>i,this.logComponent=Ie.LogFactory.instance().component(this.ulLogComponent),Ie.LogFactory.instance().declareComponentSafe(this.ulLogComponent,t)}createChild(t){const i=(0,be.isFunction)(t)?t:()=>t;return new e(this.ulLogComponent,this.ulSafeComponent,(()=>this._getPrefix()?`${this._getPrefix()}/${i()}`:i()))}log(...e){this._apply((e=>this.logComponent.debug2(null,e)),e)}debug(...e){this._apply((e=>this.logComponent.debug4(null,e)),e)}info(...e){this._apply((e=>this.logComponent.debug1(null,e)),e)}warn(...e){this._apply((e=>this.logComponent.warn(null,e)),e)}error(...e){this._apply((e=>this.logComponent.error(null,e)),e)}_apply(e,t=[]){this._addPrefix(t),e(t.map((e=>e instanceof DOMException?e.toString():e)).map((e=>(0,be.isObject)(e)?JSON.stringify(e):e)).join(", "))}_addPrefix(e){if(e&&e[0]){const t=`${this._getPrefix()} ${e[0]}`;e[0]=t}}},Re=g;function we(e){return"string"==typeof e?Re.pii.Mri(e):Re.pii.Omit(e)}function Pe(e){return e&&Re.pii.Mri(e)}function Me(e){const t=function(e){const t="99:";return e&&e.substr(0,3)===t?Re.pii.Omit(e):e}(e);return t&&t.substr(0,8)}var De=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function Oe(e){try{return JSON.parse(JSON.stringify(e,De,4))}catch(e){return{error:"failed to parse object"}}}var ke=e=>{try{return e.split("\n")[0]}catch(e){return"invalid stack"}};function Ne(e,t=!1){if(null==e)return"void";if(e instanceof Error)return e.toString();if(e instanceof String||e instanceof Number||e instanceof Boolean)return e.toString();try{return e.stack&&(e.stack=ke(e.stack)),(t?JSON.stringify(e):JSON.stringify(e,De,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(t){return`failed to get error information:${e&&"function"==typeof e.toString&&e.toString()} ${e?.response&&JSON.stringify(e.response)}`}}function Le(e){try{return JSON.stringify(e,null,2)}catch(t){return`failed to stringify obj ${e}`}}function xe(e,t){try{return e.substring(0,length)}catch(t){return e}}function Ue(e){return e||!1===e||""===e||0===e}function Fe(e){if(!e)return!1;try{return atob(e),!0}catch(e){return!1}}function Ve(e){if(!e)return`${e}`;if(e instanceof Map)return function(e){const t={};return e.forEach(((e,i)=>{t[i.toString()]=e})),JSON.stringify(t)}(e);const t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}var Be=class{constructor(e){e&&"function"==typeof e.createChild?this.logger=e.createChild("RequestDispatcher"):this.logger=new Ae("JS.TsCalling.RequestDispatcher",!1)}getRequestOptions(e,t,i,n,r){return{headers:t||{},timeout:n,payload:i||null,responseType:r}}getAsync(e,t){return this.sendRequest(e,t,"GET")}postAsync(e,t){return this.sendRequest(e,t,"POST")}putAsync(e,t){return this.sendRequest(e,t,"PUT")}removeAsync(e,t){return this.sendRequest(e,t,"DELETE")}async sendRequest(e,t={headers:{}},i){const n=this.logger.createChild(`[${t.causeId||Te()}][Request]`);n.info(`sending, ${i}-${e}`);const r=Date.now();let s;t.headers=t.headers||{},t.headers["content-type"]||(t.headers["content-type"]=t.contentType||"application/json");try{const a=_e.default.request({url:e,method:i,headers:t.headers||{},timeout:"number"==typeof t.timeout?t.timeout:45e3,data:t.payload||"",responseType:t.responseType||t.dataType||"json",withCredentials:He(t.withCredentials,!1),cancelToken:new _e.default.CancelToken((e=>{s=e}))});(function(e){return!!e&&"function"==typeof e.then})(t.timeout)&&t.timeout.then((()=>{n.info("Aborting pending request"),s()}),(()=>{n.info("Timeout promise rejected, ignoring")}));const o=await a;return n.info(`success, status=${o.status}`),{response:o.data,request:o.request,duration:Date.now()-r}}catch(e){if(n.info("failed"),_e.default.isCancel(e))throw n.info(`response=${Le(e.response)}`),{aborted:!0};throw e.response?n.info(`response=${Le(e.response)}`):e.request?n.info(`no response, request=${Le(e.request)}`):n.info(`request not made, error=${Le(e)}`),e||new Error("Request failed")}}};function He(e,t){return void 0!==e?e:t}var $e=p,Ge=p,je=class{constructor(e){this.eventLogger=e,this.subscriptions=[]}subscribe(e){return new qe(this.subscriptions,e)}dispose(e){this.subscriptions=[]}raiseEvents(e){this.subscriptions.slice().forEach((t=>{try{void 0!==t.eventHandler&&e(t.eventHandler)}catch(e){this.eventLogger?.warn?.("Event handler exception caught!",Ve(e))}}))}},qe=class{constructor(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}dispose(){(0,Ge.remove)(this.subscriptions,(e=>e===this)),this.eventHandler=void 0}},We=class extends je{constructor(e){super(e)}changed(e,t){return this.subscribe({changed:{skipEventConfig:t,handler:e},on:void 0})}on(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})}once(e,t,i){let n;return n=this.on(e,this._fromEventCallback(((...e)=>{n.dispose(i),this._toEventCallback(t)(...e)}))),n}raiseChanged(e){this.raiseEvents((t=>{if(!t.changed)return;const{skipEventConfig:i,handler:n}=t.changed;!this.getShouldSkipChangedEvent(e,i)&&n()}))}event(e){return{raise:this._fromEventCallback(((...t)=>this._raiseEventImpl(String(e),...t)))}}_raiseEventImpl(e,...t){this.raiseEvents((i=>i.on&&i.on.name===e&&i.on.handler(...t)))}_toEventCallback(e){return e}_fromEventCallback(e){return e}getShouldSkipChangedEvent(e,t){return e?.skipDominantSpeakerUpdatesOnCall?!!t?.skipDominantSpeakerUpdatesOnCall:!!e?.skipParticipantsUpdatesOnCall&&!!t?.skipParticipantsUpdatesOnCall}},ze=We,Je="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",Ke="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",Ye="http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00",Qe={MEDIA_STATE:{send:"sendonly",receive:"recvonly",sendReceive:"sendrecv",inactive:"inactive"},MEDIA_DIRECTION:{SEND:"send",RECV:"recv"},MEDIA_DEVICE_KIND:{audioInput:"audioinput",audioOutput:"audiooutput",videoInput:"videoinput",compositeAudio:"compositeAudio",virtualDevice:"virtualDevice"},MEDIA_DEVICE:{camera:"camera",microphone:"microphone",speaker:"speaker",compositeAudio:"compositeAudio",defaultId:"default",communicationsId:"communications",defaultDeviceLabel:"Default",audioIngestDevice:"audioIngestDevice",virtualDevice:"virtualDevice"},MEDIA_ERROR:{constraintNotSatisfiedError:"ConstraintNotSatisfiedError",iceConnectionError:"iceConnectionError",srtpError:"srtpError",permissionDeniedError:"permissionDeniedError",internalError:"internalError",sourceUnavailableError:"SourceUnavailableError",devicesNotFoundError:"DevicesNotFoundError",noDeviceSelected:"noDeviceSelected",noNetworkError:"noNetworkError",incompatibleOffer:"IncompatibleOffer",mediaStreamRequestError:"MediaStreamRequestError",extensionNotFoundError:"ExtensionNotFoundError",sharingCancelledError:"SharingCancelledError",permissionDeniedBySystemError:"PermissionsDeniedBySystem",chromeRuntimeNotDefinedError:"ChromeRuntimeNotDefinedError",mediaStreamRequestTimedOut:"MediaStreamRequestTimedout",unsupportedStream:"UnsupportedStream",webGlRendererError:"WebGlRendererError",audioPlaybackError:"audioPlaybackError",unexpectedClose:"unexpectedClose",incompatibleOriginator:"incompatibleOriginator"},HISTOGRAM_BATCH:{seconds1to3:2,seconds3to5:4,seconds5to8:7,seconds8to15:14,seconds15to60:59,seconds60toMax:1e6},RENEGOTIATION_ERROR:{local:"local",glare:"glare",signaling:"signaling",media:"media",escalation:"escalation"},MSI:{unsubscribe:-1,subscribeAny:-2},MEDIA_LABEL:{audio:"main-audio",video:"main-video",sharing:"applicationsharing-video",data:"data"},MEDIA_TYPE:{audio:"audio",video:"video",sharing:"sharing",data:"x-data",dataChannel:"application"},MODALITY:{audio:"audio",video:"video",sharing:"sharing",data:"data"},TRACK_KIND:{audio:"audio",video:"video"},ICE_TRANSPORT_POLICY:{all:"all",relay:"relay"},RENDERER_TYPE:{video:"video",sharing:"sharing"},CONTENT_TYPE:{SDP:"application/sdp"},ALLOWED_CONTENT_TYPES:{SDP_ONLY:["application/sdp"],SDP_NGC:["application/sdp","application/sdp-ngc-0.5","application/sdp-ngc-1.0"]},STREAMING_STATE:{created:"created",started:"started",active:"active",inactive:"inactive",stopped:"stopped",removed:"removed",failed:"failed"},TIME_INTERVAL:{SEC_1:1},DISPLAY_SOURCE_ID:"display",EMPTY_DEVICE_ID:"0",SYSTEM_AUDIO_SOURCE_ID:"system",MULTIPLE_RECV_STREAMS:"multipleVideoStreams",PROFILES:{udpTlsRtpSavpf:"UDP/TLS/RTP/SAVPF",rtpSavpf:"RTP/SAVPF",rtpSavp:"RTP/SAVP",udpDtlsSctp:"UDP/DTLS/SCTP"},REPORTING_PROFILE:{RT_PROFILE:"REAL_TIME",BE_PROFILE:"BEST_EFFORT",NRT_PROFILE:"NEAR_REAL_TIME"},PAYLOAD_TYPE:{DATA_CHANNEL:"webrtc-datachannel",X_DATA:"127 126",MSRTC_RED:97,MSRTC_CNFB:120},VIDEO_CAPABILITIES:{MAX_FS_PATH:"max-fs",MAX_MBPS_PATH:"max-mbps",MAX_FPS_PATH:"max-fps",MAX_BR_PATH:"max-br",SSRC_PATH:"ssrc",RID_PATH:"rid",KEYFRAME_PATH:"KeyFrame",MAX_WIDTH:"max-width",MAX_HEIGHT:"max-height",VLA_DEBUG:"vla-debug"},TRANSPORT_CC:{EXT_URI:Je,MSSDP_ENCODED_URI:Je.replace(/\//g,"\\"),ATTRIBUTE:"transport-cc"},ABS_SEND_TIME:{EXT_URI:Ke,MSSDP_ENCODED_URI:Ke.replace(/\//g,"\\")},VLA:{EXT_URI:Ye,EXT_URI_NON_ADV:Ye+"-non-advertised",DEFAULT_VALUE:10},AUDIO_DECODER:{MUCHv2:{CODEC:{NAME:"x-much2",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:113},SatinFB:{CODEC:{NAME:"SATINFB",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:109}},MACROBLOCK_SIZE:16,MEDIA_EVENT_FIELDS:{Extensions:["IceConnectionState","IceConnectionStatePrevious","SignalingState","SignalingStatePrevious"],metrics:["ReconnectInProgress","IceConnectedStateTime","ErrorType","ErrorDetail","InitialNegotiationType","InitialNegotiationCompleted"]},RES_TABLE:{SEND:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:416,h:234,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}],RECV:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:426,h:240,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}]}};function Xe(e,t){for(const i in e)e.hasOwnProperty(i)&&t(e[i],i)}function Ze(e,t){for(const i in e)e.hasOwnProperty(i)&&("object"==typeof e[i]?Ze(e[i],t):t(e[i],i,e))}function et(e){return null!=e&&!Number.isNaN(e)}function tt(e,t){return et(t)?et(e)?Math.min(e,t):t:e}function it(e){let t=0;return e.forEach((e=>t+=e)),t/=e.length,t}function nt(e,t){let i=!1;for(let n=e.length;n-- >0;)t(e[n],n,e)&&(e.splice(n,1),i=!0);return i}function rt(e){const t=[];for(const i in e)e.hasOwnProperty(i)&&t.push(e[i]);return t}function st(e){return!Object.keys(e).length}function at(e){return Object.keys(e)}function ot(e){const t={};return Xe(e,((e,i)=>{t[i]=e})),t}function ct(e){let t;if(!e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(let i=0,n=e.length;i<n;i++)t[i]=ct(e[i]);return t}if(e instanceof Object)return t={},Xe(e,(function(e,i){t[i]=ct(e)})),t;throw new Error("Unable to copy: "+Ve(e))}function lt(e){return Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),e}function dt(){const e=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e()}function ht(e,t){let i;const n=typeof e;if(e===t)return!0;if(n!==typeof t||"object"!==n&&"function"!==n)return!1;if(null===e||null===t)return e===t;if(e instanceof Date&&t instanceof Date)return+e==+t;if(e instanceof Map&&t instanceof Map)return function(e,t){let i;if(e.size!==t.size)return!1;let n=!0;return e.forEach(((e,r)=>{i=t.get(r),(i!==e||void 0===i&&!t.has(r))&&(n=!1)})),n}(e,t);for(i in e)if(!(i in t)||!ht(e[i],t[i]))return!1;for(i in t)if(!(i in e)||!ht(e[i],t[i]))return!1;return!0}function ut(e,t){if(-1===t.indexOf(e))throw{detail:`${e} mediaContent.contentType is not supported`,type:Qe.MEDIA_ERROR.incompatibleOffer}}function gt(e,t){e.forEach((e=>{if(""!==e&&-1!==t.findIndex((t=>t===e)))throw{detail:`Required feature '${e}' is not acceptable.`,type:Qe.MEDIA_ERROR.incompatibleOffer}}))}function pt(e,t,i,n=0){for(let r=1;r<e.length;r++)if(e[r-1]+n<t&&t<=e[r]+n)return i?e[r]:e[r-1];return e[0]}function mt(e,t,i){return t<=e&&e<=i}function ft(e,...t){for(const i of t)if(i.hasOwnProperty(e))return i[e]}function St(e,t){return e.filter((e=>!t.some((t=>t===e))))}function vt(e,t){if(e===t)return e;let i=0,n=0,r="";for(let s=0;s<e.length&&!(r.length>e.length-s);s++){let a=s;n-i>r.length&&(r=e.substring(i,n),s=n-1),i=s,n=s;for(let o=0;o<t.length;o++)a<e.length&&t[o]===e[a++]?n=a:(a=s,n-i>r.length&&(r=e.substring(i,n),s=n-1),i=s,n=s)}return r}function yt(e,t){const i=new Array(e.length+1);for(let n=0;n<e.length+1;n++){i[n]=new Array(t.length+1);for(let e=0;e<t.length+1;e++)i[n][e]=0}for(let t=1;t<e.length+1;t++)i[t][0]=t;for(let e=1;e<t.length+1;e++)i[0][e]=e;for(let n=1;n<e.length+1;n++)for(let r=1;r<t.length+1;r++){let s=1;e[n-1]===t[r-1]&&(s=0),i[n][r]=Math.min(i[n-1][r]+1,i[n][r-1]+1,i[n-1][r-1]+s)}return i[e.length][t.length]}function Ct(e,t=3){return e&&parseFloat(e.toFixed(t))}function _t(e,t){if(!e)return"";if(e.length<3)return e;const i=[],n=e.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);n&&i.push(n[1]);try{if(t?.length){const n=new RegExp(`(${t.join("|")})`,"gi");let r=n.exec(e);for(;r;)i.push(r[1]),r=n.exec(e)}else i.push("no_keywords")}catch(e){i.push(`Error: ${Ve(e)}`)}return 0===i.length?"unknown":i.join(" ")}function Et(e,t,i=0){return e&&void 0!==t&&t>-1&&e.length>t&&e.splice(i,e.length-t),e}function Tt(e,t,i,n=0){Et(e,0===i?0:i-1,n),0!==i&&e.push(t)}function It(e,t){const i={};for(const e in t)i[e]={get:t[e],configurable:!1,enumerable:!0};Object.defineProperties(e,i)}function bt(e){return e?.length>0?e[e.length-1]:void 0}var At=window?.performance?.now&&window?.performance?.timeOrigin,Rt=At?()=>window.performance.now():()=>Date.now(),wt=At?window.performance.timeOrigin:0,Pt=Rt,Mt=wt;function Dt(e,t,i){if(e?.length>0){const n=[];for(const r of e){const e=ct(r);e[t]=e[t]&&e[t]-i,n.push(e)}return n}return e}function Ot(e,t){if(!e)return;const i={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]};for(const[n,r]of Object.entries(e))for(const e of r)i[n].push(e-t);return i}function kt(e,t,i=!1){const n=e?.map(t).filter((e=>void 0!==e&&!isNaN(e)&&null!==e&&""!==e&&(!1===i||0!==e)));return n?.length?n.join(","):void 0}function Nt(e,t,i){const n=e?.map(t).filter((e=>void 0!==e&&!isNaN(e)&&null!==e&&""!==e)).splice(-i);return n?.length?n:void 0}function Lt(e,t){const i=[];for(const n of e.keys())t.has(n)||i.push(n);for(const t of i)e.delete(t)}function xt(e){return"object"==typeof e?Ve(e):e}function Ut(e){const t=Object.keys(e).map(Number).sort(((e,t)=>e-t)),i=t.reduce(((t,i)=>t+(e[i]??0)),0);return{getPercentile:n=>{const r=i*n;let s=0;for(const i of t)if(s+=e[i],s>=r)return i}}}function Ft(e,t){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t.toLowerCase())?e[t.toLowerCase()]:void 0}function Vt(e){const t=e.toLowerCase(),i='token_types="',n=t.indexOf(i);if(-1===n)return[];const r=t.indexOf('"',n+13);if(-1===r)return[];const s=t.substring(n+13,r).trim();return""===s?[]:s.split(" ")}var Bt=p,Ht={numVideoChannelsGvc:({current:e,constraints:t})=>jt(e,t),specCompliantSimulcast:({current:e,constraints:t})=>Wt(e,t),multiviewResolutionLimits:({current:e,constraints:t,logger:i})=>qt(e,t,i),enableVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Kt(e,t,i,n),allowRemoteVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Kt(e,t,i,n),enableNonAdvVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Kt(e,t,i,n),outgoingVideoLimit:({current:e,constraints:t})=>Jt(e,t)},$t=(e,t,i)=>({...Gt(e,t,i),...Gt(e,t,i,"1on1"),...Gt(e,t,i,"Multiparty")}),Gt=(e,t,i,n)=>{const r={};for(const s of Object.keys(Ht)){const a=`${s}${n??""}`;n&&!et(t[a])||(r[a]=Ht[s]({current:t[a],settings:t,constraints:i,settingsSuffix:n,logger:e}))}return r},jt=(e,t)=>tt(e,t.maxIncomingStreams),qt=(e,t,i)=>{const n=t.maxParticipantResolutions;if(!n)return e;const r={more:e.more};if(Number.isInteger(n))Object.keys(e).forEach((t=>{r[t]=tt(n,e[t])}));else{const t=Object.keys(n);if(!t.length)return i.warn(`ignoring invalid value provided for maxParticipantResolutions: ${n}}`),e;t.forEach((t=>{r[t]=tt(n[t],e[t]||e.more)}))}return r},Wt=(e,t)=>void 0!==t.maxSimulcastLayers||e.allowOverride?{...e,video:zt(e.video,t),sharing:zt(e.sharing,t)}:e,zt=(e,t)=>{const i=e?.layerScaleFactors?.filter((e=>e<=t.maxSimulcastLayers));return i?.length>1?{...e,layerScaleFactors:i}:{...e,enableLocally:!1,allowEnableRemotely:!1}},Jt=(e,t)=>{const{outgoingVideoLimit:i,maxOutgoingResolution:n}=t,r=(0,Bt.isNumber)(i),s=tt(r?i:i?.maxResolution,n),a=tt(e?.maxResolution,s),o=tt(e?.maxBitrate,r?void 0:i?.maxBitrate),c=tt(e?.maxFramerate,r?void 0:i?.maxFramerate);return{...e,maxResolution:a,maxBitrate:o,maxFramerate:c}},Kt=(e,t,i,n)=>!((t.specCompliantSimulcast.constraintsDisableVla||t[`specCompliantSimulcast${n}`]?.constraintsDisableVla)&&i.maxSimulcastLayers<2)&&e,Yt=class extends ze{constructor(e){super(e),this.logger=e,this._constraints={},this._callConstraintsTelemetry=[]}get constraints(){return this._constraints}get callConstraintsTelemetry(){return this._callConstraintsTelemetry}addCallConstraintsTelemetryEvent(e,t){const i={timestamp:(new Date).getTime(),type:t,value:e};this._callConstraintsTelemetry.push(i)}setConstraints(e){this.logger.debug("Setting new platform call constraints",JSON.stringify(e)),this._constraints=e,this.addCallConstraintsTelemetryEvent(e,"requested"),this.raiseChanged()}getSettings(e){return $t(this.logger,e,this._constraints)}},Qt=class e{constructor(e){this._callingLogger=e,this._maybeLog=(e,...t)=>{try{this._callingLogger[e](...t)}catch(e){this._callingLogger.info("[failed to log]",Ne(e))}}}getPrefix(e,t){let i="";return t&&(i+=`[${t}]`),e&&(i+=`[${e}]`),i}createChild(t,i){return new e(this._callingLogger.createChild(t,i))}createFnLogger(t,i,...n){return new e(this._callingLogger.createChild(this.getPrefix(t,i)+n.join(""),!1))}logSuccess(e){this._maybeLog("info",`success=${e}}`)}logFailure(e){const t=Ne(e);this._maybeLog("info",`failed=${t}}`)}log(...e){this._maybeLog("log",...e)}debug(...e){this._maybeLog("debug",...e)}info(...e){this._maybeLog("info",...e)}warn(...e){this._maybeLog("warn",...e)}error(...e){this._maybeLog("error",...e)}};function Xt(){return"2024.14.01.41"}function Zt(){return"a7c1622acc37a0ab89ed93e9fad06dfff1477239"}var ei=p,ti="0.0";function ii(e,t){let i=[];if(t.some((t=>(i=e.match(t),!!i))),!i||i.length<2)return ti;const n=i[1]?.replace(/_/g,".");return n||ti}function ni(e){return"136"===function(){const e="os-sku",t=window.external;return t?.getHostEnvironmentValue?JSON.parse(t.getHostEnvironmentValue(e))[e]:"-1"}()?"Hololens":/hostAudio-Processing/i.test(e)?"RoomAudioProcessing":/iPhone|iPad|iPod|Android|Mobi/i.test(e)?"Mobile":"Desktop"}function ri(){const e="((\\d+\\.?){2,4})",t={name:"Unknown",engine:"Unknown",version:ti,formFactor:"Unknown"},i=[{name:"WebView2",engine:"Chromium",key:"maglev",masks:[new RegExp(`maglev/${e}`)]},{name:"Edge",engine:"Edge",key:"Edge",masks:[new RegExp(`Edge/${e}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"EdgA",masks:[new RegExp(`Chrome/${e}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"Edg",masks:[new RegExp(`Edg/${e}`)]},{name:"Chromium",engine:"Chromium",key:"Chromium",masks:[new RegExp(`Chromium/${e}`)]},{name:"Opera",engine:"Chromium",key:"OPR",masks:[new RegExp(`Chrome/${e}`)]},{name:"YandexBrowser",engine:"Chromium",key:"YaBrowser",masks:[new RegExp(`Chrome/${e}`)]},{name:"Electron",engine:"Chromium",key:"Electron",masks:[new RegExp(`Electron/${e}`)]},{name:"CiscoOS",engine:"Chromium",key:"Cisco",masks:[new RegExp(`Chrome/${e}`)]},{name:"ZoomRoom",engine:"Chromium",key:"ZoomRoom",masks:[new RegExp(`Chrome/${e}`)]},{name:"SamsungTV",engine:"Chromium",key:"TeamsSamsungTVBrowser",masks:[new RegExp(`Chrome/${e}`)]},{name:"Chrome",engine:"Chromium",key:"Chrome",masks:[new RegExp(`Chrome/${e}`)]},{name:"Firefox",engine:"Firefox",key:"Firefox",masks:[new RegExp(`Firefox/${e}`)]},{name:"Safari",engine:"Safari",key:"Safari",masks:[new RegExp(`Version/${e}.*?Safari/`)]},{name:"AppleWebView",engine:"Safari",key:"Mac OS X",masks:[new RegExp("(\\d+_\\d+(_\\d+)?).*Mac OS X"),new RegExp("(\\d+_\\d+(_\\d+)?).*")]},{name:"MSIE",engine:"MSIE",key:"Trident",masks:[new RegExp(`MSIE ${e}`),new RegExp(`rv:${e}`)]}],n=navigator.userAgent;let r=t;return i.some((e=>{if(-1!==n.indexOf(e.key)){const t=window.navigator.mediaDevices?.isRemote;return r={name:e.name,engine:t?"ChromiumAVD":e.engine,version:ii(n,e.masks),formFactor:ni(n)},!0}return!1})),r}var si={src:["//amp.azure.net/libs/amp/2.3.8.4/azuremediaplayer.min.js","https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.js"],css:["https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.css","https://statics.teams.cdn.office.net/evergreen-assets/broadcast/video-player.css?v=2"],styles:["azuremediaplayer","amp-stream-skin","amp-big-play-centered"],lang:"en-us",disableFullscreenButton:!1,playerType:0},ai={src:["https://azuremdncdnhlsendpoint.azureedge.net/hlsjsv115/hls.js","https://vzmdncdnendpoint.azureedge.net/hlsjsv115/hls.js"],css:[],styles:[],lang:"en-us",disableFullscreenButton:!1,muteVideo:!1,playerType:1,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js"]},oi={src:[],css:[],styles:[],playerType:2,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js"]},ci=class{constructor(e,t,i,n){this.configIds=i,this.logger=n,this.defaultSettings=function(){let e;return e="Safari"===ri().engine?new di:new li,e.getSettings()}(),this.logger.info(`client settings: ${JSON.stringify(t)}`),this.defaultSettings.debug=t?.debug||!1,this.defaultSettings.playerType=t?.playerConfig?.playerType||this.defaultSettings.playerType,t?.playerConfig&&(0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration=t.playerConfig:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration=t.playerConfig:2===this.defaultSettings.playerType&&(this.defaultSettings.umsSettings.liveStreamPlayerConfiguration=t.playerConfig)),(0,ei.mergeWith)(this.defaultSettings,e,hi),this.logger.info(`applied settings: ${JSON.stringify(this.defaultSettings)}`)}get playerConfig(){return 0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration:2===this.defaultSettings.playerType?this.defaultSettings.umsSettings.liveStreamPlayerConfiguration:null}get config(){return this.defaultSettings}},li=class{constructor(){this.defaultSettings={allowSdnPlugins:!0,capturePlayerLogs:!0,playerType:0,loadType:1,maxPlayerDiagnosticsCount:50,maxPlayerMemoryTraceLogCount:1e3,maxPlayerPlaybackEventCount:50,maxRetryCount:10,playerTelemetryTickMs:1e3,removeEmptyDefaultTextTrack:!0,sendSnapshotTelemetry:!1,sendSnapshotTelemetryEveryMs:1e4,sendInitialTelemetryAfterMs:6e4,sendTelemetry:!0,textTrackKind:"subtitles",maxRetryCountForLoadingResources:5,maxVideoTrackHistoryLogCount:100,ampSettings:{errorCodesEligibleForStreamingUrlSwitch:[4194309,2097564,2097556,2097752,2097753,5242884],liveStreamPlayerConfiguration:si,sourceResetTimeoutInMs:1e3,streamingUrlSwitchMaxCount:2,resetStreamingUrlSwitchCount:!1,useBrowserWindowSizeForBitRate:!0,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,collectUserInitiatedSeekEventsTelemetry:!0,maxUserInitiatedSeekEventCount:100,noMediaTimeoutMs:-1},hlsSettings:{liveStreamPlayerConfiguration:ai,timeoutForSwitchingUrl:9e3,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,playlistInitialSequenceNumber:1,skipNonce:!1,maxStreamConnectionResultsLogCount:100,logHlsJsEvents:!1,logHlsJsEventsEveryMs:5e3,maxPlayerExperimentalEvents:100},umsSettings:{liveStreamPlayerConfiguration:oi,timeoutForSwitchingUrl:9e3,maxStreamConnectionResultsLogCount:100,minTargetEdgeLatency:.2,maxEdgeLatencyHistoryLength:300,latencyCompensationThreshold:.5,maxPlayerExperimentalEvents:100}}}getSettings(){return this.defaultSettings}},di=class extends li{constructor(){super(),this.settings=super.getSettings(),this.settings.loadType=0,this.settings.allowSdnPlugins=!1,this.settings.umsSettings.minTargetEdgeLatency=.6,this.settings.umsSettings.latencyCompensationThreshold=.9}getSettings(){return this.settings}};function hi(e,t){if((0,ei.isArray)(e))return t.slice()}function ui(e){return!!e&&!!e.url&&!!e.decryptionToken}function gi(e,t,i){if(!e&&!i)throw new Error("Assert failed"+(void 0!==t?`: ${t}`:""))}var pi=class{constructor(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}complete(){gi(this.startTime,"not started",this.stopCrash),gi(void 0===this.duration,"already completed",this.stopCrash),this.duration=Date.now()-this.startTime}updateDetails(e,t){if(this.details&&"object"==typeof this.details)for(let i=0;i<e.length;i++)this.details[e[i]]=t[i]}fail(e){this.failReason=e,this.complete()}set detail(e){this.details=e}getTelemetryEvent(){gi(this.startTime,"not started",this.stopCrash);try{gi(void 0!==this.duration,"not completed",this.stopCrash)}catch(e){if("SetSource"!==this.name&&"Load"!==this.name)throw e}const e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e}start(e){gi(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),this.details=e}},mi=class{constructor(e,t,i){this.config=e,this.logger=t,this.playerDiagnosticsLog=i,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.userInitiatedSeekEvents=[],this.experimentalEvents=[],this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxUserInitiatedSeekEventCount=e.ampSettings?.maxUserInitiatedSeekEventCount||100,this.stopCrash=e.stopCrash||!1,this.config.debug&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}getPlayerDiagnosticSnapshot(){return this.currentPlayerDiagnosticSnapshot}registerStatsUpdated(e){this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((t=>{const i=t,n=this.playerDiagnosticsLog[t];if(Array.isArray(n)){n.push(e[i]);const t="memoryLog"===i&&n.length>this.maxPlayerMemoryTraceLogCount,r="memoryLog"!==i&&n.length>this.maxPlayerDiagnosticsCount;(t||r)&&n.splice(0,1)}else this.playerDiagnosticsLog[t]=e[i]}))}registerEventLoadAttempt(e,t){this.registerScenario(e,t)}registerEventLoadFailed(e,t){this.completeScenario(e,t)}registerEventLoadSucceeded(e,t){this.completeScenario(e,void 0,t)}registerPlayerLoadAttempt(){this.registerScenario("Load")}registerPlayerLoadSucceeded(e){this.completeScenario("Load",void 0,e)}registerPlayerLoadFailed(e){this.completeScenario("Load",e)}registerPlayerSetupAttempt(){this.registerScenario("Setup")}registerPlayerSetupSucceeded(){this.completeScenario("Setup")}registerPlayerSetupFailed(e){this.completeScenario("Setup",e)}registerStreamConnectionAttempt(e){this.registerScenario("StreamConnection")}registerStreamConnectionSucceeded(){this.completeScenario("StreamConnection")}registerStreamConnectionFailed(e){this.completeScenario("StreamConnection",e)}registerSetSourceAttempt(e,t){let i=e;t&&(i={src:e,reason:t}),this.registerScenario("SetSource",i)}registerSetSourceSucceeded(e){this.getScenario("SetSource").updateDetails(["src"],[e]),this.completeScenario("SetSource")}registerSetSourcedFailed(e,t){this.getScenario("SetSource").updateDetails(["src"],[t]),this.completeScenario("SetSource",e)}registerSdnPluginLoad(e,t,i){this.registerScenario("SdnPluginLoad",e);const n=t?void 0:i;this.completeScenario("SdnPluginLoad",n)}registerPlayerDestroyed(e){this.registerScenario("Destroyed",e),this.completeScenario("Destroyed")}registerPlaybackStateChanged(e,t){let i;"Ready"!==e||this.firstReadyStateTimestamp?"Playing"!==e||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),t&&"Buffering"===e&&(t?i=t.message:this.logger.debug(`Unexpected buffering payload: ${JSON.stringify(t)}`)),this.registerPlaybackEvent("StateChanged",e,i)}registerPlaybackError(e,t){this.registerPlaybackEvent("Error",{errorType:e,details:t})}registerDownloadBitratechanged(e){this.registerPlaybackEvent("BitrateChangedDownload",e)}registerStreamOptionsConfigured(e,t){this.registerPlaybackEvent("StreamOptionsConfigured",this.generateCleanedStreamOption(e),t)}registerPlaybackBitratechanged(e){this.registerPlaybackEvent("BitrateChangedPlayback",e)}registerPotentialMediaFreeze(e){this.registerPlaybackEvent("PotentialMediaFreeze",e)}registerCaptionToggle(e,t,i){const n={isEnabled:e,culture:t,playerTime:i};this.registerPlaybackEvent("CaptionsToggled",n)}registerFullScreenChange(e){this.registerPlaybackEvent("FullscreenChanged",e)}registerMute(e){this.registerPlaybackEvent("Mute",e)}registerVolumeChange(e){this.registerPlaybackEvent("Volume",e)}getExperimentalEvents(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}}getUserInitiatedSeekEvents(){return{playback_userInitiatedSeekEvents:this.prepareForTelemetry(this.userInitiatedSeekEvents)}}getSnapshotReport(e={}){const t=this.playerEvents.map((e=>e.getTelemetryEvent())),i=this.playbackEvents;let n={};return this.currentPlayerDiagnosticSnapshot&&(n=this.filterAndPrepareTelemetry()),{isFullReport:!1,configIds:e.configIds||"",playerId:e.playerId||"",correlationId:e.correlationId||"",traceId:e.correlationId?e.correlationId.replace(/-/g,""):"",eTag:e.eTag||"",isFinal:e.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:e.disableFullscreenButton??!1,threadId:e.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:"2024.14.01.41",...this.getInitializationReport(t,i),...this.getPlaybackReport(i),...this.getBitrateReport(i),...this.getSdnReport(t),...this.getSetSourceReport(t),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(t),callDropped:this.getCallDropped(i),...n}}getReport(e={}){const t=this.playerEvents.map((e=>e.getTelemetryEvent())),i=this.playbackEvents;return{callendReason:e.callendReason,isFullReport:!0,configIds:e.configIds||"",playerId:e.playerId||"",correlationId:e.correlationId||"",traceId:e.correlationId?e.correlationId.replace(/-/g,""):"",eTag:e.eTag||"",isFinal:e.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:e.disableFullscreenButton??!1,threadId:e.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:"2024.14.01.41",...this.getInitializationReport(t,i),...this.getPlaybackReport(i),...this.getBitrateReport(i),...this.getSdnReport(t),...this.getSetSourceReport(t),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(t),callDropped:this.getCallDropped(i),...this.getPlayerDiagnosticLog()}}registerExperimentalEvent(e,t,i){const n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.logTelemetryEvent(n)}registerUserInitiatedSeek(e){const t=(this.currentPlayerDiagnosticSnapshot?.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1)<e.newCurrentPlayPosition,i={...e,seekForward:t},n=this.createTelemetryEvent("UserInitiatedSeek",i);this.userInitiatedSeekEvents.push(n),this.userInitiatedSeekEvents.length>this.maxUserInitiatedSeekEventCount&&this.userInitiatedSeekEvents.splice(0,1)}createTelemetryEvent(e,t,i){const n={eventType:e,timestamp:Date.now(),currentPlayPosition:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1};return void 0!==t&&(n.payload=this.prepareForTelemetry(t)),n.message=i,n}registerPlaybackEvent(e,t,i){const n=this.createTelemetryEvent(e,t,i);"Error"===e&&"PlaybackRetried"!==t?.errorType&&(n.fatal=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)}getPlayerDiagnosticLog(){if(!this.currentPlayerDiagnosticSnapshot)return{};const e={...this.currentPlayerDiagnosticSnapshot,...this.playerDiagnosticsLog},t={};return Object.keys(e).forEach((i=>{t[`player_${i}`]=this.prepareForTelemetry(e[i])})),t}getCallSetupSucceeded(e){const t=e.find((e=>"Load"===e.name));return!!t&&!t.failReason}getCallDropped(e){return!!e.filter((e=>"Error"===e.eventType)).find((e=>e.fatal))}getInitializationReport(e,t){const i=e.find((e=>"Load"===e.name));return{init_timeLoadToStreamConnectionEstablished:(i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}}getPlaybackReport(e){const t=e.filter((e=>"StateChanged"===e.eventType)),i=t.find((e=>"Ready"===e.payload)),n=t.find((e=>"Play"===e.payload)),r=t.find((e=>"Start"===e.payload)),s=t.find((e=>"Playing"===e.payload)),a=i&&n?n.timestamp-i.timestamp:-1,o=n&&r?r.timestamp-n.timestamp:-1,c=r&&s?s.timestamp-r.timestamp:-1,l=t.filter((e=>"Seeked"===e.payload)),d=t.filter((e=>"Seeking"===e.payload)),h=t.filter((e=>"Paused"===e.payload)),u=t.filter((e=>"Resume"===e.payload)),g=t.filter((e=>"Buffering"===e.payload)),p=["BitrateChangedDownload","BitrateChangedPlayback","Error","Mute","StateChanged","Volume","StreamOptionsConfigured"],m=e.filter((e=>"Error"===e.eventType)),f=e.filter((e=>"Volume"===e.eventType||"Mute"===e.eventType)),S=e.filter((e=>"StreamOptionsConfigured"===e.eventType)),v=e.filter((e=>!p.includes(e.eventType)));return{playback_timeReadyToPlay:a,playback_timePlayToStart:o,playback_timeStartToPlaying:c,playback_bufferingEvents:this.prepareForTelemetry(g),playback_errorEvents:this.prepareForTelemetry(m),playback_pauseEvents:this.prepareForTelemetry(h),playback_resumeEvents:this.prepareForTelemetry(u),playback_otherEvents:this.prepareForTelemetry(v),playback_seekedEvents:this.prepareForTelemetry(l),playback_seekingEvents:this.prepareForTelemetry(d),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(f),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(S)}}generateCleanedStreamOption(e){return{...e,stream:{...e?.stream,decryptionToken:e?.stream?.decryptionToken?"valid":"empty",sdnContext:e?.stream?.sdnContext?"valid":"empty",keyAuthorizationToken:e?.stream?.keyAuthorizationToken?"valid":"empty"},altStream:e?.altStream?{...e?.altStream,decryptionToken:e?.altStream?.decryptionToken?"valid":"empty",sdnContext:e?.altStream?.sdnContext?"valid":"empty",keyAuthorizationToken:e?.stream?.keyAuthorizationToken?"valid":"empty"}:void 0}}getBitrateReport(e){const t=e.filter((e=>"BitrateChangedDownload"===e.eventType)),i=t.sort((e=>Number(e.payload))),n=t.length?{bitrate_downloadChanges:this.prepareForTelemetry(t),bitrate_downloadChangeCount:t.length||-1,bitrate_downloadMin:i[0].payload||-1,bitrate_downloadMax:i[i.length-1].payload||-1}:{},r=e.filter((e=>"BitrateChangedPlayback"===e.eventType)),s=r.sort((e=>Number(e.payload)));return{...n,...r.length?{bitrate_playbackChanges:this.prepareForTelemetry(r),bitrate_playbackChangeCount:r.length||-1,bitrate_playbackMin:s[0].payload||-1,bitrate_playbackMax:s[s.length-1].payload||-1}:{}}}addNetworkTypeEventListener(){window.navigator?.connection?.type&&window.navigator?.connection?.addEventListener("change",(()=>this.updateClientNetworkType()))}updateClientNetworkType(){this.clientNetworkType=void 0,this.getClientNetworkType()}getClientNetworkType(){if(void 0===this.clientNetworkType){let e="Unknown";if(window.navigator?.connection?.type){const t=window.navigator?.connection?.type;switch(t){case"cellular":e="WWAN";break;case"ethernet":e="Wired";break;case"wifi":e="Wireless";break;default:e="Unknown"}}this.clientNetworkType=e}return this.clientNetworkType}getSdnReport(e){const t=e.filter((e=>"SdnPluginLoad"===e.name)),i=t.length?t[t.length-1]:void 0;return{sdn_loaded:!(!i||void 0!==i.failReason),sdn_details:i&&i.details||"",sdn_error:i&&i.failReason||"",sdn_events:this.prepareForTelemetry(t)}}getSetSourceReport(e){const t=e.filter((e=>"SetSource"===e.name));return{set_source_events:this.prepareForTelemetry(t)}}registerScenario(e,t){const i=this.currentScenarioMap.get(e),n=new pi(e,this.stopCrash,t);gi(!i,`previous scenario:${Ve(i)} is not completed, new scenario:${Ve(n)}`,this.stopCrash),this.currentScenarioMap.set(e,n),this.playerEvents.push(n)}getScenario(e){return this.currentScenarioMap.get(e)}completeScenario(e,t,i){const n=this.currentScenarioMap.get(e);gi(n,"no scenario to complete",this.stopCrash),t?n.fail(t):("StreamConnection"!==e||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(n.detail=i),n.complete()),this.currentScenarioMap.delete(e)}logTelemetryEvent(e){this.config.debug&&(this.logger.debug(`PlayerTelemetryEvent: ${JSON.stringify(e)}`),this.logger.debug(`PlayerDiagnosticData: ${JSON.stringify(this.currentPlayerDiagnosticSnapshot)}`))}filterAndPrepareTelemetry(){const e=new Set;e.add("serviceLatencyCdg"),e.add("endToEndLatencyCdg"),e.add("videoEdgeLatencyCdg");const t={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((i=>{e.has(i)||(t[`player_${i}`]=this.prepareForTelemetry(this.currentPlayerDiagnosticSnapshot[i]))})),t}prepareForTelemetry(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?e??-1:JSON.stringify(e)}},fi=p;function Si(e){return new Promise((t=>{t(e())}))}function vi(){let e,t;return{promise:new Promise(((i,n)=>{e=i,t=n})),resolve:e,reject:t}}function yi(e){return new Promise((t=>setTimeout(t,e)))}function Ci(){const e=Ri(),t=wi();let i;return(i||(i={})).CaptionFunctionalityNotSupported="CaptionFunctionalityNotSupported",class{constructor(e,t){this.container=e,this.eventsHandler=t,this.videoElementEvents=[],this.playerEvents=[],this.maxMemoryTraceLogCount=1e4,this.videoSourceType="application/dash+xml",this.sdnPluginLoaded=!1,this.statsTimer=-1,this.statsInterval=1e3,this.videoSourceSetAttemptCount=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[]}get contextWindow(){return this.container.ownerDocument.defaultView}configure(e,t,i){this.liveStreamOptions=e,this.playerId=i,t&&(this.configProvider=t,this.statsInterval=t.config.playerTelemetryTickMs||this.statsInterval,this.maxMemoryTraceLogCount=t.config.maxPlayerMemoryTraceLogCount||this.maxMemoryTraceLogCount)}getIceCandidates(){let e=[];try{const t=this.liveStreamOptions.stream.sdnContext||this.liveStreamOptions.altStream?.sdnContext||"",i=JSON.parse(t),n=JSON.parse(i.sdnConfig);if(!n.RTCIceCandidates)throw new Error("RTCIceCandidates not present in SDN Context");e=n.RTCIceCandidates}catch(e){this.log(`getIceCandidates failed: ${JSON.stringify(e.message)}`,"error")}return this.log(`getIceCandidates: ${JSON.stringify(e)}`,"debug"),e}loadPlayerScript(){let e=Promise.resolve("");const t=this.configProvider.playerConfig.nonce,i=this.configProvider.playerConfig.css;for(let n=0;n<i.length;n++)e=e.then((()=>this.retry((()=>this.loadCss(this.container.ownerDocument,i[n],t)))));return e=e.then((()=>this.loadAmpScript())),e}loadAmpScript(){this.log("loadPlayerScript started");let e=Promise.resolve("");const t=this.configProvider.playerConfig?.nonce,i=this.configProvider.playerConfig?.src||[],n=Math.max(2,this.configProvider.config.maxRetryCountForLoadingResources);if(0===i.length)return Promise.reject("AMP Player Src is empty");for(let r=0;r<i.length;++r)e=e.then((()=>this.loadScriptPromise(i,r,t,n)));return e}loadScriptPromise(e,t,i,n,r=""){return this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,e[t],i)),n).then((i=>`${e[t]}: ${i} `.concat(r))).catch((s=>this.retry((()=>this.setScriptByBlob(this.container.ownerDocument,e[t],i)),n).then((i=>`${e[t]}: ${i}`.concat(` ${s} `,` ${r} `))).catch((a=>this.retry((()=>this.setScriptByInnerHtml(this.container.ownerDocument,e[t],i)),1).then((i=>`${e[t]}: ${i}`.concat(` ${s} `,`${a} `,` ${r} `))).catch((s=>{let o=r;return t<e.length&&(o=o.concat(`Failed to load script, nonce: ${i}, src: ${e[t]} index: ${t} `),o=o.concat(`${n} attempts LoadFailure `,`${n} attempts BlobFetchFailure: `,a,", 1 attempt InnerHtmlFailure: ",`${s} `)),Promise.reject(o)}))))))}retry(e,t=this.configProvider.config.maxRetryCountForLoadingResources,i=1,n=200){return e(t).then((e=>`${e}, succeeded on load number: ${i} `)).catch((r=>(this.log(`Error loading resource: ${r} -- ${t} retriesLeft`),0==--t?Promise.reject(`${r}`):new Promise((s=>setTimeout((()=>s(this.retry(e,t,i+1).then((e=>"string"==typeof e?`${e}, succeeded on load number: ${i}`:e)).catch((e=>Promise.reject(`${r}`.concat(", ",e)))))),n))))))}setScriptByLoad(e,t,i){const n=e.createElement("script"),r=this.getElementLoadPromise(n,t);return n.src=t,i&&(n.nonce=i),e.head.appendChild(n),r.then((()=>Promise.resolve("Success: setScriptByLoad")))}setScriptByBlob(e,t,i){return this.safeResponse(t).then((t=>t.blob().then((n=>{if(n){const t=URL.createObjectURL(n);return this.setScriptByLoad(e,t,i).then((()=>Promise.resolve("Success: setScriptByBlob")))}return Promise.reject(`${t.status}, blob is null`)}))))}setScriptByInnerHtml(e,t,i){return this.safeResponse(t).then((t=>t.text().then((n=>{if(n){const t=document.createElement("script");return t.innerHTML=n,i&&!this.configProvider.config.hlsSettings.skipNonce&&(t.nonce=i),e.head.appendChild(t),Promise.resolve("Success: setScriptByInnerHtml")}return Promise.reject(`status code:${t.status}, text is null`)}))))}safeResponse(e){return fetch(e).then((e=>e.ok?e:Promise.reject(`${e.status}`)))}tryLoadSdnPlugin(){return this.sdnPluginLoaded||!this.liveStreamOptions.sdn?Promise.resolve():this.configProvider.config.allowSdnPlugins?(this.log("tryLoadSdnPlugin started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.url,this.configProvider.playerConfig.nonce))).then((()=>{this.log("SDN script loaded"),this.sdnPluginLoaded=!0,this.log("tryLoadSdnPlugin done")}))):(this.log("Loading SDN plugins is not allowed"),Promise.reject("Loading SDN plugins is not allowed"))}createAmp(){this.log("createAmp started"),this.createVideoElement();const i=this.getAmpOptions();if(this.playerInstance=this.contextWindow.amp(this.video.id,i),!this.playerInstance)throw this.log("createAmp failed","error"),new Error("playerInstance is null");"html5"===this.playerInstance.currentTechName()?.toLowerCase()&&this.configProvider.config.ampSettings.estimateAbsoluteTime&&this.isControlsDisabled()?(this.absoluteTimeOffsetEstimator=new bi(this.log.bind(this)),this.diagnosticProvider=new e(this.playerInstance,this.contextWindow,new Date,this.configProvider,this.absoluteTimeOffsetEstimator),this.absoluteTimeOffsetEstimator.setEstimationResultCallback(this.onAbsoluteTimeOffsetEstimation.bind(this))):this.diagnosticProvider=new e(this.playerInstance,this.contextWindow,new Date,this.configProvider);const n={controlsEnabled:!this.isControlsDisabled(),logFn:this.log.bind(this),removeEmptyDefaultTextTrack:this.configProvider.config.removeEmptyDefaultTextTrack};this.diagnosticProvider.setValue("streamingEventType",this.liveStreamOptions.streamingEventType),this.diagnosticProvider.setValue("playerControlsEnabled",!this.isControlsDisabled()),this.captionsControl=new t(this.playerInstance,this,n,this.diagnosticProvider),this.registerPlayerEvents(),this.log("createAmp done")}isControlsDisabled(){return void 0!==this.liveStreamOptions.allowPlayerControls?!this.liveStreamOptions.allowPlayerControls:"Overflow"===this.liveStreamOptions.streamingEventType||"TownHall_Basic"===this.liveStreamOptions.streamingEventType||"TownHall_Premium"===this.liveStreamOptions.streamingEventType||"TownHall"===this.liveStreamOptions.streamingEventType}onAbsoluteTimeOffsetEstimation(e){if(this.diagnosticProvider.appendAbsoluteTimeOffsetEstimation(e),!e.isSuccess){const e=this.addEvent("CaptionFunctionalityNotSupported",{detail:{data:{fatal:!0,details:"absolute time offset estimation failed - captions will fail"}}});this.video.dispatchEvent(e)}}addEvent(e,t){let i={};return t?.detail&&(i={detail:t.detail}),new CustomEvent(e,i)}setSource(e){if(this.log("setSource started"),!this.playerInstance)throw this.log("setSource failed: playerInstance is null","error"),new Error("playerInstance is null");this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1);const t={src:e.url,type:this.videoSourceType,protectionInfo:e.decryptionToken?[{type:"AES",authenticationToken:e.decryptionToken}]:null};this.configureSdnSource(t,e),this.diagnosticProvider.setValue("streamUrl",e.url),this.diagnosticProvider.setValue("streamId",this.getStreamIdFromStreamUrl(e.url)),this.diagnosticProvider.setValue("streamDeliveryPipeline",e.streamDeliveryPipeline||""),this.playerInstance.src([t],this.getTextTracks()),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.setManifestFileURL(e.url+"(format=m3u8-aapl-v4)"),this.log("setSource done")}getStreamIdFromStreamUrl(e){try{const t=new URL(e).pathname;if(t){const e=t.split("/");if(e?.length>1)return e[1]}return this.log(`unable to parse stream ID from stream URL: ${e}`,"warn"),""}catch{return this.log(`cannot parse stream ID from invalid stream URL: ${e}`,"warn"),""}}setPlayTime(e){e&&(this.log(`setPlayerTime: ${e}`),this.playerInstance.currentTime(e))}dispose(){this.log("dispose started"),this.diagnosticProvider&&(this.stopStatsCollection(),this.diagnosticProvider.dispose(),this.diagnosticProvider=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.removePlayerEventListeners(),this.playerInstance.getMemoryLog(!0),this.playerInstance.dispose(),this.playerInstance=null),this.eventsHandler.ampDisposed(),this.video&&(this.removeVideoEventListeners(),this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.absoluteTimeOffsetEstimator&&(this.absoluteTimeOffsetEstimator.stopStreamAbsoluteTimeOffsetRetrieval(),this.absoluteTimeOffsetEstimator=null),this.log("dispose done"),this.eventsHandler=null}updatePlaybackDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}handlePlaybackStopped(){this.isBuffering=!1,this.isPlaying=!1,this.currentVideoPlaybackBitrate=null}showCaptions(e){this.log(`showCaptions: ${e}`),this.captionsControl.showCaptions(e)}addCues(e){e=e.filter((e=>e.text&&0!==e.text.trim().length)),this.captionsControl.addCues(e)}clearCues(){this.captionsControl.clearCues()}captionsToggled(e,t,i){this.log(`captionsToggled: ${e} for culture ${t} at ${i}`),this.eventsHandler.message("captionsToggled").send(e,t,i)}createVideoElement(){this.log("createVideoElement started"),this.video=this.container.ownerDocument.createElement("video"),this.video.id="amp-player",this.video.setAttribute("playsinline","");const e=this.configProvider.playerConfig.lang;e&&(this.video.setAttribute("lang",e),this.log(`createVideoElement: language set to ${e}`));const t=this.configProvider.playerConfig.styles;for(let e=0;e<t.length;e++)this.video.classList.add(t[e]);this.container.appendChild(this.video),this.log("createVideoElement done")}getAmpOptions(){const e=[];this.configProvider.config.debug?e.push({target:"memory",maxMemoryTraceCount:this.maxMemoryTraceLogCount}):e.push({target:"console"});const t={TraceTargets:e,maxLogLevel:this.configProvider.config.debug?3:2},i={techOrder:["azureHtml5JS","html5"],nativeControlsForTouch:!1,autoplay:!0,preload:"auto",controls:!this.isControlsDisabled(),logo:{enabled:!1},height:"100%",width:"100%",traceConfig:t,disableFullscreenButton:this.configProvider.playerConfig?.disableFullscreenButton,staleDataTimeLimitInSec:30,heuristicProfile:this.contextWindow.amp.Player.HeuristicProfile.HighQuality,customPlayerSettings:{customHeuristicSettings:{bandwidthTestWithTimeThresholdDuringLive:!1,windowSizeHeuristics:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useBrowserWindowForWindowSizeRule:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useVariableFragmentSizeMode:!0}},plugins:{}};return this.initializePluginOptions(i),i}isStreamValid(e){return e&&!!e.url&&!!e.decryptionToken}initializePluginOptions(e){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;const t=this.isStreamValid(this.liveStreamOptions.stream)?this.liveStreamOptions.stream:this.liveStreamOptions.altStream;this.log(`initializePluginOptions, receivedSDNContext: ${JSON.stringify(t?.sdnContext)}`,"info");try{switch(this.liveStreamOptions.sdn.name){case"hive":if(e.plugins={hive:{debugLevel:this.configProvider.config.debug?"debug":"notice",telemetryId:this.playerId}},t&&t.sdnContext)try{const i=JSON.parse(t.sdnContext);if(i.sdnConfig){const t=JSON.parse(i.sdnConfig);t.candidateTopicName="RequestIceCandidates",delete t.RTCIceCandidates,Object.assign(e.plugins.hive,t)}}catch(e){this.log(`initializePluginOptions, failed to parse Hive sdnConfig Json from sdnContext Json, error: ${e}`,"warn")}break;case"kollective":if(t&&t.sdnContext){let i=null,n=null,r=null;try{i=this.parseJson(t.sdnContext,"kollective sdn context")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext Json, error: ${e}`,"error")}if(i){try{n=this.parseJson(i.playbackinfo,"kollective sdn playback info")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext playbackinfo Json, error: ${e}`,"error")}try{r=this.parseJson(i.sdnConfig,"kollective sdn config")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext sdnConfig Json, error: ${e}`,"error")}}e.plugins={kollectiveSDN:{playbackInfo:n,sdnConfig:r,reportSessionId:this.playerId}}}break;case"ramp":t&&t.sdnContext&&(e.plugins={RampMOPlugin:this.parseJson(t.sdnContext,"ramp sdn context")},this.configProvider.config.debug&&(e.plugins.RampMOPlugin.verbose=!0));break;case"peer5":t.sdnContext&&(e.plugins={peer5:this.parseJson(t.sdnContext,"peer5 sdn context")})}}catch(e){this.log(`initializePluginOptions failed, error: ${e.message}`,"error")}this.log(`initializePluginOptions, configured plugin options: ${JSON.stringify(e.plugins)}`,"info")}getTextTracks(){const e=[];if(this.isControlsDisabled())e.push({id:"amp-player_default",kind:"captions",label:"default-text-track",src:"",srclang:"en"});else if(this.liveStreamOptions.supportedSubtitleLanguages){const t=this.liveStreamOptions.supportedSubtitleLanguages;for(let i=0;i<t.length;i++)e.push({id:`amp-player_${t[i].culture}`,kind:this.configProvider.config.textTrackKind,label:t[i].name||t[i].culture,src:"",srclang:t[i].culture.substr(0,2)})}return e}configureSdnSource(e,t){if(this.sdnPluginLoaded&&this.liveStreamOptions.sdn){switch(this.liveStreamOptions.sdn.name){case"hive":if(!t.sdnContext){e.sdnList=[];break}try{const i=JSON.parse(t.sdnContext);i.playbackinfo&&(e.sdnList=[{sdnName:"hive",sdnUrl:i.playbackinfo}])}catch(i){e.sdnList=[{sdnName:"hive",sdnUrl:t.sdnContext}]}break;case"kollective":if(!t.sdnContext){e.sdnList=[];break}try{const i=this.parseJson(t.sdnContext,"kollective sdn list context"),n=this.parseJson(i.playbackinfo,"kollective sdn list playback info"),r=this.parseJson(i.sdnConfig,"kollective sdn list sdn config");e.sdnList=[{sdnName:"kollectiveSDN",playbackInfo:n,sdnConfig:r}]}catch(t){return e.sdnList=[],void this.log(`configureSdnSource failed, error: ${t}`,"error")}break;case"ramp":case"peer5":e.sdnList=[];break;default:return}this.log(`configureSdnSource, configured source context: ${JSON.stringify(e)}`,"info")}}registerPlayerEvents(){this.registerPlayerEvent(this.contextWindow.amp.eventName.error,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.error)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.canplaythrough,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.canplaythrough)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.play,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.play)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playing,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playing)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.pause,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.pause)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.resume,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.resume)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.start,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.start)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.ended,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.ended)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeking,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeking)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeked,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeked)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadedmetadata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadedmetadata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.waiting,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.waiting)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playbackbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playbackbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.downloadbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.downloadbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.fullscreenchange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.fullscreenchange)})),this.registerPlayerEvent("potentialMediaFreeze",(()=>{this.onAmpEvent("potentialMediaFreeze")})),this.registerPlayerEvent(this.contextWindow.amp.eventName.mute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.mute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.unmute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.unmute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.volumechange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.volumechange)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadeddata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadeddata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadstart,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadstart)})),Object.values(i).forEach((e=>{this.registerVideoEvent(e,(t=>{this.handleUserExperienceErrorEvent(e,t.detail.data.details,t.detail.data.fatal)}))})),this.configProvider.config.ampSettings.collectUserInitiatedSeekEventsTelemetry&&(this.playerEvents.push("currentTimeChanging"),this.playerInstance.addEventListener("currentTimeChanging",((e,t)=>this.onAmpCurrentTimeChangingEvent(e,t))))}onAmpCurrentTimeChangingEvent(e,t){if("currentTimeChanging"!==e.type||!t.time)return;const i={newCurrentPlayPosition:t.time};this.eventsHandler.message("stateChanged").send("UserInitiatedSeek",i)}registerPlayerEvent(e,t){this.playerEvents.push(e),this.playerInstance.addEventListener(e,t)}registerVideoEvent(e,t){this.videoElementEvents.push({name:e,callback:t}),this.video.addEventListener(e,t)}removePlayerEventListeners(){this.playerEvents.forEach((e=>{this.playerInstance.removeEventListener(e)}))}removeVideoEventListeners(){this.videoElementEvents.forEach((e=>{this.video.removeEventListener(e.name,e.callback)}))}onAmpEvent(e){let t,i;switch(e){case this.contextWindow.amp.eventName.error:i=this.playerInstance.error(),t={currentTime:this.playerInstance.currentTime(),errorCode:i?i.code:0,message:i?i.message:""};break;case this.contextWindow.amp.eventName.canplaythrough:this.initializeStatsColletion();break;case this.contextWindow.amp.eventName.loadedmetadata:this.captionsControl.initialize(),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.restartStreamAbsoluteTimeOffsetRetrieval();break;case this.contextWindow.amp.eventName.fullscreenchange:t={isFullscreen:this.playerInstance.isFullscreen()};break;case this.contextWindow.amp.eventName.playbackbitratechanged:t={bitrate:this.playerInstance.currentPlaybackBitrate()};break;case this.contextWindow.amp.eventName.downloadbitratechanged:t={bitrate:this.playerInstance.currentDownloadBitrate()};break;case this.contextWindow.amp.eventName.seeked:t={captionsTimestamp:this.isControlsDisabled()?this.playerInstance.currentMediaTime():this.playerInstance.currentTime()};break;case this.contextWindow.amp.eventName.volumechange:t={value:this.playerInstance.volume()}}this.updatePlaybackDiagnostics(),this.updatePlayerState(e),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(e,t)}updatePlayerState(e){this.updatePlayingState(e),this.updateBufferingState(e),this.updateCurrentVideoTrackBitrate(e),e!==this.contextWindow.amp.eventName.ended&&e!==this.contextWindow.amp.eventName.error||this.handlePlaybackStopped()}handleUserExperienceErrorEvent(e,t,i){const n={currentTime:this.video?this.video.currentTime:0,message:t,type:e,errorCode:0,fatal:i};this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(this.contextWindow.amp.eventName.error,n)}updatePlayingState(e){this.isPlaying?e!==this.contextWindow.amp.eventName.pause&&e!==this.contextWindow.amp.eventName.seeking&&e!==this.contextWindow.amp.eventName.ended&&e!==this.contextWindow.amp.eventName.error&&e!==this.contextWindow.amp.eventName.waiting||(this.isPlaying=!1):e===this.contextWindow.amp.eventName.playing&&(this.isPlaying=!0)}updateBufferingState(e){this.isBuffering?(e===this.contextWindow.amp.eventName.pause&&"html5"===this.playerInstance.currentTechName()?.toLowerCase()||e===this.contextWindow.amp.eventName.seeking||e===this.contextWindow.amp.eventName.ended||e===this.contextWindow.amp.eventName.error||e===this.contextWindow.amp.eventName.playing)&&(this.isBuffering=!1):e===this.contextWindow.amp.eventName.waiting&&(this.isBuffering=!0)}updateCurrentVideoTrackBitrate(e){e===this.contextWindow.amp.eventName.playbackbitratechanged&&this.playerInstance.currentPlaybackBitrate()!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=this.playerInstance.currentPlaybackBitrate(),this.updateVideoTrackHistoryStatistic())}initializeStatsColletion(){this.diagnosticProvider.initialize(),this.statsTimer=window.setInterval((()=>{this.eventsHandler&&(this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()))}),this.statsInterval)}stopStatsCollection(){this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),-1!==this.statsTimer&&window.clearInterval(this.statsTimer),this.statsTimer=-1}updateVideoTrackHistoryStatistic(){const e=new Date;if(this.currentVideoPlaybackBitrate){const t=this.diagnosticProvider.getValue("videoTrackHistory"),i=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(t.length>0&&this.currentVideoPlaybackBitrate===t[t.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(e.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,t[t.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const n=this.videoTrackTotalDurations.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),r=i.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));n&&r&&(n.totalDurationInSeconds+=(e.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,r.totalDurationInSeconds=Number(n.totalDurationInSeconds.toFixed(0)))}}else{const n=this.playerInstance.videoBufferData();let r=null;n&&n.perceivedBandwidth&&(r=n.perceivedBandwidth),t.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:e.getTime(),trackSwitchMeasuredBandwidth:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredBandwidth():null,trackSwitchMeasuredByteSize:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredVideoDownloadSize():null,trackSwitchPerceivedBandwidth:r,durationInSeconds:0}),this.latestVideoTrackDuration=0,t.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&t.splice(0,1);const s=this.videoTrackTotalDurations.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));if(!s){const e={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},t={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(e),i.push(t)}}}this.videoTrackHistoryUpdatedTimestamp=e}updateTotalPlayingTimeStatistic(){const e=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=e.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=e,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const e=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=e.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=e;const t=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(t.toFixed(3)))}getPlayerDiagnostics(){const e=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return e.statsInterval=this.statsInterval,this.configProvider.config.debug&&(e.memoryLog=this.playerInstance.getMemoryLog(!0)),e}log(e,t="info"){const i=`[AmpPlayer${1===this.configProvider.config.loadType?"IFrame":""}]: ${e}`;this.configProvider.config.debug&&console.log(i),this.eventsHandler.message("log").send(t,i)}getElementLoadPromise(e,t){return new Promise(((i,n)=>{e.onload=()=>{i("Element Load success")},e.onerror=()=>{n(`Failed to load script: ${t}`)}}))}loadCss(e,t,i){const n=e.createElement("link"),r=this.getElementLoadPromise(n,t);return n.href=t,n.rel="stylesheet",i&&(n.nonce=i),e.head.appendChild(n),r}parseJson(e,t){try{return JSON.parse(e)}catch(e){throw this.log(`Error parsing JSON for ${t}, error: ${JSON.stringify(e)}`),e}}}}function _i(){const e=Ci();return class{constructor(t,i){this.pipe=t,this.amp=new e(i,this)}processMessage(e){"Command"===e.msgType&&Promise.resolve().then((()=>this.amp[e.cmd].apply(this.amp,e.args))).then((t=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:e.cmd,result:JSON.stringify(t)})})).catch((t=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:e.cmd,error:t})}))}message(e){return{send:this.fromMessage(((...t)=>{this.sendMessageImpl(e,t)}))}}ampDisposed(){this.pipe.dispose(),this.pipe=null,this.amp=null}fromMessage(e){return e}sendMessageImpl(e,t){this.pipe.sendMsg({msgType:"PlayerNotification",name:e,args:t})}}}Ci();var Ei=_i();function Ti(){function e(e){let t="unknown";try{t="string"==typeof e?e:"toString"in e&&0!==e.toString().indexOf("[object")?e.toString():JSON.stringify(e)}catch(t){console.error("Failed to stringify error",e)}return t}return class{constructor(){this.processMsg=this.processMsg.bind(this),window.addEventListener("message",this.processMsg)}sendMsg(t){try{let i=t;(function(e){return"CommandResult"===e.msgType})(t)&&t.error instanceof Event&&(console.debug("Stringifying error Event before trying to postMessage:",t),i={msgType:t.msgType,cmd:t.cmd,error:`Event: ${e(t.error)}`}),this.postMessage(i)}catch(i){console.error("Unexpected exception caught from postMessage.\n","message:",t,"\n","exception:",i);const n={msgType:"PlayerNotification",name:"log",args:["error",`Unexpected error with postMessage: ${e(i)}`]};throw this.postMessage(n),i}}registerObserver(e){this.observer=e}dispose(){window.removeEventListener("message",this.processMsg),this.observer=null}processMsg(e){this.observer.processMessage(e.data)}postMessage(e){window.parent.postMessage(e,"*")}}}function Ii(){const e=Ai();return class{constructor(t){this.playlistFileDownloadPromise=Promise.resolve(),this.playlistFileDownloadRetryWaitTime=250,this.playlistFileDownloadMaxRetryCount=20,this.playlistFileDownloadCancellationFlag=!1,this.logFn=(e,i)=>t(`[HlsAbsoluteTimeOffsetEstimator]: ${e}`,i),this.hlsFileParser=new e(t)}get absoluteTimeOffset(){return this.estimatedAbsoluteTimeOffset}setEstimationResultCallback(e){this.onAbsoluteTimeOffsetEstimation=e}restartStreamAbsoluteTimeOffsetRetrieval(){this.stopStreamAbsoluteTimeOffsetRetrieval().then((()=>this.startStreamAbsoluteTimeOffsetRetrieval()))}setManifestFileURL(e){this.cachedManifestUrl=e}startStreamAbsoluteTimeOffsetRetrieval(){this.playlistFileDownloadPromise=this.retryPlaylistFileDownload((()=>this.estimateStreamTimeFromPlaylist(this.currentManifestUrl))).then((()=>{this.logFn(`Succeeded in downloading playlist files to estimate\n                    absolute stream time offset as: ${this.estimatedAbsoluteTimeOffset}`)})).catch((e=>{this.logFn(`Failed to download playlist files to estimate absolute stream time offset: ${e.message}`,"error")}))}stopStreamAbsoluteTimeOffsetRetrieval(){return this.playlistFileDownloadCancellationFlag=!0,this.playlistFileDownloadPromise.then((()=>{this.playlistFileDownloadCancellationFlag=!1,this.currentManifestUrl=this.cachedManifestUrl,this.cachedManifestUrl=null}))}retryPlaylistFileDownload(e,t=0){let i=Promise.resolve();return i=e().then((()=>(this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:t,isSuccess:!0,absoluteTimeOffsetEstimation:this.absoluteTimeOffset}),Promise.resolve()))).catch((i=>(t++,this.logFn(`Error loading playlist file: ${i} -- attempt ${t}`),this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:t,isSuccess:!1,error:i.message}),t===this.playlistFileDownloadMaxRetryCount?Promise.reject(new Error(`${i} after ${t} attempts`)):this.playlistFileDownloadCancellationFlag?Promise.reject(new Error("cancelling playlist file download")):new Promise((i=>setTimeout((()=>i(this.retryPlaylistFileDownload(e,t))),this.playlistFileDownloadRetryWaitTime)))))),i}estimateStreamTimeFromPlaylist(e){return this.hlsFileParser.getStreamRenditionsUrlsFromManifest(e).then((t=>{if(0===t.audioRenditions.length&&0===t.videoRenditions.length)throw new Error(`Unable to retrieve renditions URLs from manifest: ${e}`);return Promise.all([t.videoRenditions.length>0?this.hlsFileParser.getTextFileContent(t.videoRenditions[0]):Promise.resolve(null),t.audioRenditions.length>0?this.hlsFileParser.getTextFileContent(t.audioRenditions[0]):Promise.resolve(null)])})).then((e=>{let t;for(let i=0;i<e.length;i++){const n=e[i];if(n){this.logFn("Using segment duration and sequence number to calculate absolute time offset","debug");const e=this.hlsFileParser.getHlsFieldByName("SequenceNumber",n);if(0==e.length)throw new Error("Unable to retrieve sequence number from playlist file");const i=this.hlsFileParser.getHlsFieldByName("SegmentDuration",n,10);if(0==i.length)throw new Error("Unable to retrieve segment durations from playlist file");const r=i.map(Number);r.sort(((e,t)=>e-t));const s=r[Math.floor(r.length/2)],a=Number(e[0])*Number(s);t=t?Math.max(t,a):a}}this.estimatedAbsoluteTimeOffset=t}))}}}var bi=Ii();function Ai(){return class{constructor(e){this.fieldNameRegexMap={BaseUrl:/(.*)\/.*/,AudioManifestFile:/#EXT-X-MEDIA:TYPE=AUDIO.*URI=\"(.*)\"/,SequenceNumber:/#EXT-X-MEDIA-SEQUENCE:(\d+)/,SegmentDuration:/#EXTINF:(\d+(\.\d+)?)/},this.logFn=(t,i)=>e(`[HlsFileParser]: ${t}`,i)}getHlsFieldByName(e,t,i=1){const n=[];for(let r=1;r<=i;r++){const i=this.fieldNameRegexMap[e].exec(t);if(!(i&&i.length>0))break;n.push(i[1]),t=t.substring(i.index+i[0].length)}return n}getStreamRenditionsUrlsFromManifest(e){return e?this.getTextFileContent(e).then((t=>{const i={audioRenditions:[],videoRenditions:[]},n=t.split("\n"),r=this.getHlsFieldByName("BaseUrl",e);for(let e=0;e<n.length;e++)if(n[e].includes("#EXT-X-STREAM-INF")){const t=n[e+1];t.includes("http")?i.videoRenditions.push(t):r.length>0&&i.videoRenditions.push(`${r[0]}/${t}`)}else if(n[e].includes("EXT-X-MEDIA:TYPE")){const t=this.getHlsFieldByName("AudioManifestFile",n[e]);if(t.length>0){const e=t[0];e.includes("http")?i.audioRenditions.push(e):r.length>0&&i.audioRenditions.push(`${r[0]}/${e}`)}}return i})).catch((e=>(this.logFn(`Failed to extract stream renditions from manifest, error: ${e.message}`,"error"),{audioRenditions:[],videoRenditions:[]}))):(this.logFn("No manifest URL provided to parse"),Promise.resolve({audioRenditions:[],videoRenditions:[]}))}getTextFileContent(e){return fetch(e).then((t=>{if(!t.ok)throw new Error(`http-error ${t.status} when downloading: ${e}`);return t.text()})).catch((e=>(this.logFn(`Error downloading resource: ${e}`,"error"),Promise.reject(e))))}}}function Ri(){return class{constructor(e,t,i,n,r){this.playerInstance=e,this.contextWindow=t,this.streamingStartedTimestamp=i,this.configProvider=n,this.absoluteTimeOffsetEstimator=r,this.currentDiagnosticSnapshot={playerType:0,currentPlayPosition:null,tech:null,perceivedBandwidth:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,avgVideoDownloadLatency:null,avgAudioDownloadLatency:null,avgVideoDownloadBytes:null,avgAudioDownloadBytes:null,avgAudioDownloadBandwidth:null,avgVideoDownloadBandwidth:null,maxVideoDownloadBytes:null,minVideoDownloadBytes:null,videoDownloadSuccessCount:null,audioDownloadSuccessCount:null,videoDownloadFailureCount:null,audioDownloadFailureCount:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,errorCode:null,currentMediaTime:null,currentAbsoluteTime:null,absoluteTimeOffsetEstimationResults:null,estimatedAbsoluteTimeOffset:null,videoDownloadFailures:null,audioDownloadFailures:null,heuristicProfile:null,encryption:null,retryFrequency:null,averageDownloadBitrate:null,totalDownloadedBytes:0,streamId:null,streamUrl:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,retryCount:0,totalPlayingTimeInSeconds:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],memoryLog:null,statsInterval:null},this.videoDownloadLatencies=[],this.audioDownloadLatencies=[],this.audioDownloadBytes=[],this.videoDownloadBytes=[],this.audioDownloadBandwidths=[],this.videoDownloadBandwidths=[],this.videoDownloadSuccessCount=0,this.audioDownloadSuccessCount=0,this.videoDownloadFailureCount=0,this.audioDownloadFailureCount=0,this.audioDownloadFailures=[],this.videoDownloadFailures=[],this.totalDownloadedBytes=0,this.slidingWindowLengthForLatency=5,this.slidingWindowLengthForDownloadBytes=30,this.slidingWindowLengthForDownloadBandwidth=10,this.absoluteTimeOffsetEstimationResults=[],this.downloadFailuresLimit=10,this.onAudioDownloadCompleted=this.onAudioDownloadCompleted.bind(this),this.onAudioDownloadError=this.onAudioDownloadError.bind(this),this.onVideoDownloadCompleted=this.onVideoDownloadCompleted.bind(this),this.onVideoDownloadError=this.onVideoDownloadError.bind(this)}initialize(){this.playerVideoBuffer=this.playerInstance.videoBufferData(),this.playerAudioBuffer=this.playerInstance.audioBufferData(),this.registerForPlayerBufferEvents()}setValue(e,t){this.currentDiagnosticSnapshot[e]=t}getValue(e){return this.currentDiagnosticSnapshot[e]}appendAbsoluteTimeOffsetEstimation(e){this.absoluteTimeOffsetEstimationResults.push(e),this.absoluteTimeOffsetEstimationResults.length>this.configProvider.config.ampSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount&&this.absoluteTimeOffsetEstimationResults.splice(0,1)}getPlayerDiagnosticSnapshot(){if(!this.playerInstance)return null;const e=window.screen,t=this.playerInstance.error(),i=e=>{const t=e.slice().sort();return t[Math.floor(t.length/2)]};this.currentDiagnosticSnapshot.errorCode=t&&t.code||0,this.currentDiagnosticSnapshot.currentPlayPosition=this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentMediaTime=this.playerInstance.currentMediaTime()??this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentAbsoluteTime=this.getCurrentAbsoluteTime(),this.currentDiagnosticSnapshot.absoluteTimeOffsetEstimationResults=this.absoluteTimeOffsetEstimationResults,this.currentDiagnosticSnapshot.estimatedAbsoluteTimeOffset=this.getCurrentAbsoluteTimeOffset(),this.currentDiagnosticSnapshot.playbackBitrate=this.playerInstance.currentPlaybackBitrate(),this.currentDiagnosticSnapshot.downloadBitrate=this.playerInstance.currentDownloadBitrate(),this.currentDiagnosticSnapshot.audioDownloadBitrate=this.lastAudioDownloadBitrate,this.currentDiagnosticSnapshot.perceivedBandwidth=this.playerVideoBuffer?this.playerVideoBuffer.perceivedBandwidth:0,this.currentDiagnosticSnapshot.tech=this.playerInstance.currentTechName(),this.currentDiagnosticSnapshot.playerVersion=this.playerInstance.getAmpVersion(),this.currentDiagnosticSnapshot.isP2PSdnUsed=this.isP2PSdnUsed(),this.currentDiagnosticSnapshot.sdnName=this.sdnName(),this.currentDiagnosticSnapshot.heuristicProfile=this.playerInstance.currentHeuristicProfile(),this.currentDiagnosticSnapshot.encryption=this.playerInstance.currentProtectionInfo()?this.playerInstance.currentProtectionInfo().type:"",this.currentDiagnosticSnapshot.streamType=this.getStreamType(this.currentDiagnosticSnapshot.streamType),this.currentDiagnosticSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds(),this.currentDiagnosticSnapshot.audioStream=this.getAudioStreamData(),this.currentDiagnosticSnapshot.videoStream=this.getVideoStreamData(),this.currentDiagnosticSnapshot.muted=this.playerInstance.muted(),this.currentDiagnosticSnapshot.volume=this.playerInstance.volume(),this.currentDiagnosticSnapshot.playbackRate=this.playerInstance.playbackRate();const n=this.getPlayerCachedLength(),r=this.getPlayerEdgeLatency();this.currentDiagnosticSnapshot.audioBufferLength=this.playerAudioBuffer?this.playerAudioBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.audioCachedLength=n,this.currentDiagnosticSnapshot.audioEdgeLatency=r,this.currentDiagnosticSnapshot.videoBufferLength=this.playerVideoBuffer?this.playerVideoBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.videoCachedLength=n,this.currentDiagnosticSnapshot.videoEdgeLatency=r,this.currentDiagnosticSnapshot.livePosition=this.getLivePosition(),this.currentDiagnosticSnapshot.mediaHeight=this.playerInstance.videoHeight(),this.currentDiagnosticSnapshot.mediaWidth=this.playerInstance.videoWidth(),this.currentDiagnosticSnapshot.playerHeight=this.playerInstance.height(),this.currentDiagnosticSnapshot.playerWidth=this.playerInstance.width(),this.currentDiagnosticSnapshot.windowHeight=e?e.height:0,this.currentDiagnosticSnapshot.windowWidth=e?e.width:0,this.currentDiagnosticSnapshot.isFullscreen=this.playerInstance.isFullscreen(),this.currentDiagnosticSnapshot.avgAudioDownloadLatency=i(this.audioDownloadLatencies),this.currentDiagnosticSnapshot.avgVideoDownloadLatency=i(this.videoDownloadLatencies),this.currentDiagnosticSnapshot.avgAudioDownloadBytes=i(this.audioDownloadBytes),this.currentDiagnosticSnapshot.avgVideoDownloadBytes=i(this.videoDownloadBytes),this.currentDiagnosticSnapshot.maxVideoDownloadBytes=Math.max.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.minVideoDownloadBytes=Math.min.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.avgAudioDownloadBandwidth=i(this.audioDownloadBandwidths),this.currentDiagnosticSnapshot.avgVideoDownloadBandwidth=i(this.videoDownloadBandwidths),this.currentDiagnosticSnapshot.audioDownloadFailureCount=this.audioDownloadFailureCount,this.currentDiagnosticSnapshot.audioDownloadSuccessCount=this.audioDownloadSuccessCount,this.currentDiagnosticSnapshot.videoDownloadFailureCount=this.videoDownloadFailureCount,this.currentDiagnosticSnapshot.videoDownloadSuccessCount=this.videoDownloadSuccessCount,this.currentDiagnosticSnapshot.audioDownloadFailures=this.audioDownloadFailures,this.currentDiagnosticSnapshot.videoDownloadFailures=this.videoDownloadFailures,this.currentDiagnosticSnapshot.totalDownloadedBytes=this.totalDownloadedBytes,this.currentDiagnosticSnapshot.retryFrequency=this.getRetryFrequency(),this.currentDiagnosticSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate();const s=this.getDiagnosticWritableField();return Object.keys(s).forEach((e=>{this.currentDiagnosticSnapshot[e]=s[e]})),this.currentDiagnosticSnapshot}getDiagnosticWritableField(){return{streamUrl:this.currentDiagnosticSnapshot.streamUrl,streamId:this.currentDiagnosticSnapshot.streamId,streamingEventType:this.currentDiagnosticSnapshot.streamingEventType,playerControlsEnabled:this.currentDiagnosticSnapshot.playerControlsEnabled,streamDeliveryPipeline:this.currentDiagnosticSnapshot.streamDeliveryPipeline,retryCount:this.currentDiagnosticSnapshot.retryCount,totalPlayingTimeInSeconds:this.currentDiagnosticSnapshot.totalPlayingTimeInSeconds,bufferingRate:this.currentDiagnosticSnapshot.bufferingRate,videoTrackHistory:this.currentDiagnosticSnapshot.videoTrackHistory,videoTrackTotalDurations:this.currentDiagnosticSnapshot.videoTrackTotalDurations}}dispose(){this.unsubscribeFromPlayerBufferEvents()}registerForPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}unsubscribeFromPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}isP2PSdnUsed(){return!!this.sdnName()}sdnName(){const e="options_";return this.playerInstance[e]&&this.playerInstance[e].sdn&&this.playerInstance[e].sdn.name}getStreamType(e){let t="";return this.playerInstance&&(t=this.playerInstance.isLive()?"LIVE":"DVR"),""===t||"LIVE"===e&&t!==e?e||"":t}getCurrentAbsoluteTime(){return this.absoluteTimeOffsetEstimator?this.absoluteTimeOffsetEstimator.absoluteTimeOffset?this.absoluteTimeOffsetEstimator.absoluteTimeOffset+this.playerInstance.currentTime():this.playerInstance.currentTime():this.playerInstance.currentAbsoluteTime()??this.playerInstance.currentTime()}getCurrentAbsoluteTimeOffset(){return this.getCurrentAbsoluteTime()-this.playerInstance.currentTime()}getTotalDurationInSeconds(){const e=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(e.toFixed(0))}onVideoDownloadCompleted(){this.videoDownloadSuccessCount++,this.addToList(this.videoDownloadLatencies,this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.videoDownloadBytes,this.playerVideoBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.videoDownloadBandwidths,8*this.playerVideoBuffer.downloadCompleted.totalBytes*1e3/this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerVideoBuffer.downloadCompleted.totalBytes}onAudioDownloadCompleted(){this.audioDownloadSuccessCount++,this.addToList(this.audioDownloadLatencies,this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.audioDownloadBytes,this.playerAudioBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.audioDownloadBandwidths,8*this.playerAudioBuffer.downloadCompleted.totalBytes*1e3/this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerAudioBuffer.downloadCompleted.totalBytes;const e=this.playerAudioBuffer.downloadCompleted.mediaDownload.bitrate;e!==this.lastAudioDownloadBitrate&&(this.lastAudioDownloadBitrate=e)}addToList(e,t,i){e.push(t),e.length>i&&e.shift()}onVideoDownloadError(){this.videoDownloadFailureCount++,this.addDownloadFailureInfo(this.playerVideoBuffer.downloadFailed,this.videoDownloadFailures)}onAudioDownloadError(){this.audioDownloadFailureCount++,this.addDownloadFailureInfo(this.playerAudioBuffer.downloadFailed,this.audioDownloadFailures)}addDownloadFailureInfo(e,t){const i={bitrate:e.mediaDownload.bitrate,errorCode:e.code,mediaTime:e.mediaDownload.mediaTime,message:e.message,timestamp:Date.now()};this.addToList(t,i,this.downloadFailuresLimit)}getAudioStreamData(){const e=this.playerInstance.currentAudioStreamList();if(e)try{const t=e.streams[e.enabledIndices[0]];return{bitrate:t.bitrate,codec:t.codec,enabled:t.enabled,name:t.name,language:t.language}}catch(e){return}}getVideoStreamData(){const e=this.playerInstance.currentVideoStreamList();if(e)try{const t=e.streams[e.selectedIndex],i=this.playerInstance.currentPlaybackBitrate(),n=e=>({bitrate:e.bitrate,height:e.height,id:e.id,selectable:e.selectable,width:e.width}),r=t.tracks?t.tracks.map(n).find((e=>e.bitrate===i)):null;return{codec:t.codec,name:t.name,currentTrack:r}}catch(e){return}}getLivePosition(){const e=this.playerInstance.buffered();if(0===e.length)return 0;let t=e.end(0);for(let i=1;i<e.length;i++)t=Math.max(t,e.end(i));return t}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.totalDownloadedBytes){const e=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(e>0)return 8*this.totalDownloadedBytes/e}return 0}getRetryFrequency(){const e=this.currentDiagnosticSnapshot.retryCount;if(this.streamingStartedTimestamp&&e){const t=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(t>0)return e/t}return 0}getAverageMeasuredBandwidth(){if(0===this.videoDownloadBandwidths.length)return null;let e=0;for(let t=0;t<this.videoDownloadBandwidths.length;t++)e+=this.videoDownloadBandwidths[t];return e/this.videoDownloadBandwidths.length}getAverageMeasuredVideoDownloadSize(){if(0===this.videoDownloadBytes.length)return null;let e=0;for(let t=0;t<this.videoDownloadBytes.length;t++)e+=this.videoDownloadBytes[t];return e/this.videoDownloadBytes.length}getPlayerCachedLength(){const e=this.playerInstance.buffered();let t=0;for(let i=0;i<e.length;i++)t+=e.end(i)-e.start(i);return t}getPlayerEdgeLatency(){const e=this.playerInstance.buffered();if(0===e.length)return 0;let t=e.end(0);for(let i=1;i<e.length;i++)t=Math.max(t,e.end(i));return t-this.playerInstance.currentTime()}}}function wi(){return class{constructor(e,t,i,n){this.player=e,this.toggleListener=t,this.config=i,this.diagnosticProvider=n,this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.isHtml5Tech="html5"===this.player.currentTechName()?.toLowerCase()}dispose(){this.unsubscribeFromTrackEvents(),this.player=null,this.toggleListener=null}initialize(){const e=this.getPlayerTextTracksAsArray();if(!this.config.controlsEnabled&&e.length>0)e[0].mode="showing";else for(let t=0;t<e.length;t++)e[t].mode="disabled";this.subscribeOnTrackEvents()}addCues(e){const t=this.player.getCurrentTextTrack();if(!t)return;const i=this.getCurrentAbsoluteTime()||1,n=this.getCurrentTime(),r=this.config.controlsEnabled?i-n:Math.max(i-n,0),s=this.isHtml5Tech?window.VTTCue:window.vttjs&&window.vttjs.VTTCue||window.VTTCue;for(let i=0;i<e.length;i++){const{start:n,end:a,text:o}=e[i],c=2,l=new s(Number((n-r).toFixed(c)),Number((a-r).toFixed(c)),o);l.size=100,!this.containsCue(t,l)&&t.addCue(l)}}clearCues(){const e=this.player.getCurrentTextTrack();if(e)try{if(e.activeCues&&e.removeCue)for(;e.activeCues.length>0;)e.removeCue(e.activeCues[0]);const t="setCues_";if(e.cues[t]){e.cues_&&(e.cues_.length=0),e.cues[t]([]);const i=Object.getOwnPropertyNames(e.cues);for(let t=0;t<i.length;t++)"length"!==i[t]&&"length_"!==i[t]&&"cues_"!==i[t]&&delete e.cues[i[t]]}}catch(e){this.config.logFn(`[clearCues]: ${e}`,"warn")}}showCaptions(e){this.config.logFn(`[CaptionsControl]: showCaptions(${e})`),e?this.show():this.hide()}hide(){this.previouslyVisibleTextTrack=this.player.getCurrentTextTrack(),this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="disabled"),this.player.captionToggle&&this.player.captionToggle.hide&&this.player.captionToggle.hide(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.hide&&this.player.MoreOptionscaptionSubtitleButton.hide(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.hide&&this.player.MoreOptionscaptionSettingsButton.hide()}show(){this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="showing"),this.player.captionToggle&&this.player.captionToggle.show&&this.player.captionToggle.show(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.show&&this.player.MoreOptionscaptionSubtitleButton.show(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.show&&this.player.MoreOptionscaptionSettingsButton.show()}subscribeOnTrackEvents(){const e=this.player.textTracks(),t="addEventListener";e&&e[t]&&(this.config.controlsEnabled&&e[t]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&e[t]("addtrack",this.onAddTrack.bind(this)))}unsubscribeFromTrackEvents(){const e=this.player.textTracks(),t="removeEventListener";e&&e[t]&&(this.config.controlsEnabled&&e[t]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&e[t]("addtrack",this.onAddTrack.bind(this)))}onTextTrackChanged(){const e=this.player.getCurrentTextTrack();if(!e||!this.currentTextTrack||this.currentTextTrack.label!==e.label||this.currentTextTrack.mode!==e.mode){if(e||this.currentTextTrack){const t=!!e&&"showing"===e.mode,i=this.getCulture(e||this.currentTextTrack),n=this.getCurrentTime();this.toggleListener.captionsToggled(t,i,n),this.config.logFn(`[CaptionsControl]: track changed: culture '${i}', timestamp '${n}'`)}this.currentTextTrack=e}}onAddTrack(e){const t=e?.track;"captions"===t?.kind&&!t.label&&!t.id&&(this.player?.textTracks_?.removeTrack_(t),this.config.logFn("[CaptionsControl]: removing default empty text track"))}getCurrentTime(){return this.isHtml5Tech?this.player.currentTime():(this.config.controlsEnabled?this.player.currentTime():this.player.currentMediaTime())||1}getCurrentAbsoluteTime(){return this.diagnosticProvider.getCurrentAbsoluteTime()}getCulture(e){if(!e)return"";if(e.id){const t=e.id.split("_")[1];if(t)return t}return""}getPlayerTextTracksAsArray(){const e=this.player.textTracks();return e&&e.tracks_||[]}containsCue(e,t){return Array.from(e?.cues||[]).some((e=>this.areCueEquals(e,t)))}areCueEquals(e,t){function i(e){return{start:e.start?e.start:e.startTime,end:e.end?e.end:e.endTime,text:e.text}}const n=i(e),r=i(t);return n.start===r.start&&n.end===r.end&&n.text===r.text}}}function Pi(){const e=Ti(),t=_i(),i=new e,n=new t(i,document.body);i.registerObserver(n)}function Mi(){let e=`(${Pi.toString()})();`;return e+=Ci.toString()+";",e+=Ti.toString()+";",e+=_i.toString()+";",e+=wi.toString()+";",e+=Ri.toString()+";",e+=Ii.toString()+";",e+=Ai.toString()+";",e+="//# sourceURL=TsCallingAmpPlayer.js",e}var Di=class{sendMsg(e){this.peer.onMsg(e)}registerObserver(e){this.observer=e}onMsg(e){this.observer&&this.observer.processMessage(e)}connect(e){this.peer=e}dispose(){this.peer=null,this.observer=null}},Oi=class{constructor(e){this.container=e}get contextWindow(){return this.container.ownerDocument.defaultView}sendMsg(e){this.iframe?.contentWindow?.postMessage(e,"*")}registerObserver(e){this.observer=e}dispose(){this.contextWindow&&this.contextWindow.removeEventListener("message",this.processMsg),this.iframe&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe),this.iframe=null}initializeAmpIframe(e){const t=this.initializeIframe();return this.setAmpIframeContent(e),this.finalizeIframe(t)}initializeIframe(){const e=vi();return this.iframe=this.container.ownerDocument.createElement("iframe"),this.iframe.id="player-iframe",this.iframe.sandbox.add("allow-scripts"),this.iframe.allowFullscreen=!0,this.iframe.allow="camera; microphone; autoplay",this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.border="none",this.iframe.onload=()=>{e.resolve()},this.iframe.onerror=()=>{e.reject("iframe load failed")},e}finalizeIframe(e){return this.container.appendChild(this.iframe),this.processMsg=this.processMsg.bind(this),this.contextWindow.addEventListener("message",this.processMsg),e.promise}processMsg(e){"null"===e.origin&&e.source===this.iframe.contentWindow&&this.observer&&("RequestIceCandidates"===e.data?this.observer.processMessage({msgType:"Command",cmd:"getIceCandidates",args:[]}):this.observer.processMessage(e.data))}setAmpIframeContent(e){const t=Mi(),i=`\n            <html class style='height: 100%; width: 100%; overflow: hidden'>\n            <head></head>\n            <body class style='height: 100%; width: 100%; margin: 0px'>\n                ${e?`<script nonce='${e}'> ${t}<\/script>`:`<script> ${t}<\/script>`}\n            </body>\n            </html>\n        `;this.iframe.srcdoc=i}};var ki=class extends We{constructor(e){super(e),this.logger=e,this.resultsMap=new Map,this.on("log",((e,t)=>{this.logger[e](t)}))}async initialize(e,t,i,n){const r={config:i.config,playerConfig:i.playerConfig},s=i.playerConfig?.nonce||"";this.pipe=await async function(e,t,i){if(0===t){const t=new Di,i=new Di;return t.connect(i),i.connect(t),i.registerObserver(new Ei(i,e)),t}if(1===t){const t=new Oi(e);return await t.initializeAmpIframe(i),t}throw new Error(`Unsupported communication type ${t}`)}(e,i.config.loadType,s),this.pipe.registerObserver(this),await this.message("configure").send(t,r,n)}message(e){return{send:this.fromMessage(((...t)=>this.sendMessageImpl(e,...t)))}}dispose(){super.dispose(),this.pipe.sendMsg(this.buildMsg("dispose")),this.pipe.dispose()}processMessage(e){let t;switch(e.msgType){case"CommandResult":t=this.getDeferred(e.cmd.toString()),t&&(e.error?(t.reject(e.error),this.logger.warn(`remote command failed: ${String(e.cmd)}, ${e.error}`)):e.result?t.resolve(e.result):t.resolve(),this.processCommandResult(e),this.resultsMap.delete(e.cmd.toString()));break;case"PlayerNotification":{const t=this.event(e.name);t.raise.apply(t,e.args);break}case"Command":this.processCommand(e).catch((t=>this.logger.warn(`error while processing command: ${JSON.stringify(e)}: ${t}`)));break;default:this.logger.warn(`unexpected message received: ${JSON.stringify(e)}`)}}async processCommand(e){"getIceCandidates"===e.cmd.toString()?await this.message("getIceCandidates").send():this.logger.warn(`unsupported command received: ${JSON.stringify(e)}`)}processCommandResult(e){"getIceCandidates"===e.cmd.toString()?this.pipe.sendMsg({topic:"RequestIceCandidates",candidates:e.result}):this.logger.debug(`ignoring command result for: ${JSON.stringify(e)}`)}fromMessage(e){return e}sendMessageImpl(e,...t){return this.pipe.sendMsg(this.buildMsg(e,t)),this.waitForCompletion(e.toString())}buildMsg(e,t){return{msgType:"Command",cmd:e,args:t}}getDeferred(e){return this.resultsMap.get(e)}waitForCompletion(e){const t=this.getDeferred(e);t&&t.reject(new Error(`function ${e} is invoked again, before previous call is completed`));const i=vi();return this.resultsMap.set(e,i),i.promise}},Ni=class extends We{constructor(e,t){super(),this.player=e,this.logger=t,this.playerSubs=[],this.subscribeForPlayerEvents()}get isRendering(){return!!this.player&&this.player.isRendering()}get streamSize(){return this.player?this.player.getStreamSize():{width:0,height:0}}get rendererType(){return 0}get frameType(){return-1}dispose(){this.stopPlayer(),super.dispose()}captions(){return this.player.getCaptionsControl()}getStats(){throw new Error("Method not implemented.")}setScalingMode(e,t){throw new Error("Method not implemented.")}captureFrame(e,t){throw new Error("Method not implemented.")}stopPlayer(){const e=this.player;this.player=null,e&&(this.logger.info("stopPlayer"),this.unsubscribeFromPlayerEvents(),e.stop())}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("fullscreenToggled",(e=>this.onFullScreenToggled(e)))),this.playerSubs.push(this.player.on("captionsToggled",((e,t,i)=>this.onCaptionsToggled(e,t,i))))}unsubscribeFromPlayerEvents(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onFullScreenToggled(e){this.event("fullScreenToggled").raise(e)}onCaptionsToggled(e,t,i){this.logger.info(`Turned captions ${e?"ON":"OFF"} for culture [${t}] at player time [${i}]`),this.event("captionsToggled").raise(e,t,i)}},Li=class{constructor(e,t){this.player=e,this.availableCultures=t,this.selectedCulture="",this.disposable=this.player.on("captionsToggled",((e,t,i)=>{this.selectedCulture=e?t:""}))}async addCues(e){await this.player.message("addCues").send(e)}async clearCues(){await this.player.message("clearCues").send()}async showCaptions(e){await this.player.message("showCaptions").send(e)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.disposable.dispose(),this.player=null}};function xi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var Ui=[2097152,2097552,2097556,2097557,2097564,2097652,2097654,2097655,2097656,2097752,3145728,4194305,4194306,4194307,4194308,4194309,5242880,5242881,5242882,5242884,5242885,5242886],Fi=2097753,Vi=class extends We{constructor(e,t,i){super(),this.logger=e,this.liveStreamStatistic=t,this.configProvider=i,this.playerState="Destroyed",this.retryCount=0,this.captionsTimestamp=0,this.isSwitchStreamingUrlOngoing=!1,this.streamingUrlSwitchCount=0,this.isPlaybackUnsupported=!1,this.noMediaTimeoutId=-1,this.lastPlaybackError=void 0,this.id=xi(),this.logger.info(`AmpLiveStreamPlayer created: ID: ${this.id}`)}get playerId(){return this.id}async configure(e){if(!ui(e.stream)&&!ui(e.altStream))return void this.logger.error("Invalid Live Stream configuration provided: no valid primary or alternative stream");this.logger.info("Live Stream configuration provided"),this.liveStreamOptions=e;const t=ui(e.stream)?e.stream:e.altStream;if(this.playerInstance&&!this.isPlaybackUnsupported){try{await this.playerInstance.message("configure").send(e)}catch(e){const t=Ve(e);this.logger.error(`configure failed: ${t}`)}await this.handleStreamInfoUpdate(t)}else this.selectedStreamDetails=t}async loadPlayer(e){if(this.playerInstance)return this.logger.error("playerLoadFailed: cannot load a player while current one is still active"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(!this.liveStreamOptions||!this.selectedStreamDetails||!ui(this.selectedStreamDetails))return this.logger.error("playerLoadFailed: empty/invalid primary and alternate stream info configured"),{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:"empty/invalid primary and alternate stream info configured"}};this.playerInstance=new ki(this.logger.createChild("AmpPlayerWrapper")),this.playerInstance.on("stateChanged",((e,t)=>this.ampStateChanged(e,t))),this.playerInstance.on("captionsToggled",((e,t,i)=>this.captionsToggled(e,t,i))),this.playerInstance.on("statsUpdated",(e=>this.liveStreamStatistic.registerStatsUpdated(e)));const t=this.configProvider.config.ampSettings.noMediaTimeoutMs;let i;-1!==t&&-1===this.noMediaTimeoutId&&(this.noMediaTimeoutId=self.setTimeout((()=>this.callDropDueToMediaTimeout()),t)),await this.playerInstance.initialize(e,this.liveStreamOptions,this.configProvider,this.id),this.liveStreamStatistic.registerPlayerLoadAttempt(),this.loadSucceeded=!1,this.liveStreamStatistic.registerEventLoadAttempt("LoadScript"),this.srcLoadPromise||(this.srcLoadPromise=this.playerInstance.message("loadPlayerScript").send());try{i=await this.srcLoadPromise}catch(e){const t=Ve(e);return this.logger.error(`playerLoadFailed: player scripts load failed: ${t}`),this.liveStreamStatistic.registerEventLoadFailed("LoadScript",`Load Script failed: ${e}`),this.liveStreamStatistic.registerPlayerLoadFailed(`script load failed: ${i}`),this.srcLoadPromise=null,{setupSucceeded:!1,playerSetupError:{errorType:"PlayerScriptLoadFailed",errorMessage:t}}}this.liveStreamStatistic.registerEventLoadSucceeded("LoadScript"),await this.tryLoadSdnPlugin(),this.liveStreamStatistic.registerEventLoadAttempt("CreateAmp");try{await this.playerInstance.message("createAmp").send()}catch(e){const t=Ve(e);return this.logger.error(`playerLoadFailed: createAmp failed: ${t}`),this.liveStreamStatistic.registerEventLoadFailed("CreateAmp",`createAmp failed: ${e}`),this.liveStreamStatistic.registerPlayerLoadFailed(`create amp failed ${t}, script load: ${i}`),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:t}}}this.liveStreamStatistic.registerEventLoadSucceeded("CreateAmp");try{return await this.setPlayerSource(this.selectedStreamDetails),this.loadSucceeded=!0,this.logger.info(`loadPlayer succeeded: ${this.loadSucceeded}`),this.liveStreamStatistic.registerPlayerLoadSucceeded(i),this.playerState="Initialized",{setupSucceeded:this.loadSucceeded}}catch(e){const t=Ve(e);return this.loadSucceeded=!1,this.logger.error(`loadPlayer succeeded: ${this.loadSucceeded}: setSource failed: ${t}`),this.liveStreamStatistic.registerPlayerLoadFailed(`setPlayerSource failed; script load: ${i}`),{setupSucceeded:this.loadSucceeded,playerSetupError:{errorType:"SetSourceFailed",errorMessage:t}}}}getRenderer(){return!this.renderer&&this.playerInstance&&(this.renderer=new Ni(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.destroy("PlayerStopped")}getPlaybackState(){return this.playerState}getCaptionsTimestamp(){return this.captionsTimestamp}getCaptionsControl(){if(!this.captionsControl&&this.playerInstance){const e=this.liveStreamOptions.supportedSubtitleLanguages?this.liveStreamOptions.supportedSubtitleLanguages.map((e=>e.culture)):[];this.captionsControl=new Li(this.playerInstance,e)}return this.captionsControl}getStreamSize(){const e=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return e?{width:e.mediaWidth,height:e.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}ampStateChanged(e,t){switch(e){case"error":return this.handlePlaybackError(t);case"canplaythrough":return this.onCanplaythrough();case"play":return this.onPlay();case"playing":return this.onPlaying();case"pause":return this.onPause();case"resume":return this.onResume();case"start":return this.onStart();case"ended":return this.onEnded();case"seeking":return this.onSeeking();case"seeked":return this.onSeeked(t);case"loadedmetadata":return this.onMetadataLoaded();case"waiting":return this.onWaiting();case"playbackbitratechanged":return this.onPlaybackBitrateChanged(t);case"downloadbitratechanged":return this.onDownloadBitrateChanged(t);case"fullscreenchange":return this.onFullscreenChange(t);case"potentialMediaFreeze":return this.onPotentialMediaFreeze();case"mute":return this.onMute();case"unmute":return this.onUnmute();case"volumechange":return this.onVolumeChange(t);case"loadstart":return this.onLoadStart();case"loadeddata":return this.onLoadedData();case"UserInitiatedSeek":return this.onUserInitiatedSeek(t);default:this.logger.warn(`Unknown amp event ${e}`)}}onUserInitiatedSeek(e){this.liveStreamStatistic.registerUserInitiatedSeek(e)}captionsToggled(e,t,i){this.event("captionsToggled").raise(e,t,i),this.liveStreamStatistic.registerCaptionToggle(e,t,i)}async tryLoadSdnPlugin(){if(this.sdnPluginLoadPromise)return void this.raiseSdnPluginSkippedEvent("SDN plugin already loaded");if(!this.liveStreamOptions.sdn)return void this.raiseSdnPluginSkippedEvent("No SDNs configured in liveStreamOptions");if(!this.configProvider.config.allowSdnPlugins)return void this.raiseSdnPluginSkippedEvent("Client configured to not allow SDN plugins");switch(this.liveStreamOptions.sdn.name){case"hive":case"kollective":case"ramp":case"peer5":break;default:return this.logger.warn(`unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`),void this.liveStreamStatistic.registerSdnPluginLoad(this.liveStreamOptions.sdn.name,!1,`Unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`)}let e;this.liveStreamStatistic.registerEventLoadAttempt("SdnPluginLoad");try{this.sdnPluginLoadPromise=this.playerInstance.message("tryLoadSdnPlugin").send(),await this.sdnPluginLoadPromise,this.liveStreamStatistic.registerEventLoadSucceeded("SdnPluginLoad",this.liveStreamOptions.sdn.name)}catch(t){e=Ve(t),this.sdnPluginLoadPromise=void 0,this.logger.error(`loadSdnPlugin failed: ${e}`),this.liveStreamStatistic.registerEventLoadFailed("SdnPluginLoad",e),this.event("sdnPluginLoadFailed").raise(e)}}raiseSdnPluginSkippedEvent(e){this.logger.warn(`skipping SDN plugin load: ${e}`),this.event("sdnPluginLoadSkipped").raise(e)}async setPlayerSource(e){if(!e)throw this.logger.error("setPlayerSource: streamDetails is undefined"),new Error("setPlayerSource: streamDetails is undefined");if(!this.playerInstance)throw this.logger.error("setPlayerSource: playerInstance is null"),new Error("playerInstance is null");this.logger.info(`setPlayerSource: AMP source set to: [${e.url}]`),this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;try{this.logger.info("setPlayerSource: src changed"),this.selectedStreamDetails=e,this.liveStreamStatistic.registerSetSourceAttempt(e.url),await this.playerInstance.message("setSource").send(e),this.liveStreamStatistic.registerSetSourceSucceeded()}catch(e){const t=Ve(e);throw this.logger.error(`setPlayerSource: failed with error [${t}]`),this.liveStreamStatistic.registerSetSourcedFailed(t),e}}async handleStreamInfoUpdate(e){this.loadSucceeded&&e.url!==this.selectedStreamDetails.url?await this.setPlayerSource(e):this.loadSucceeded&&this.playerInstance&&this.getCurrentTime()>0&&this.setPlaybackState("Start")}async switchStreamingUrl(e,t){if(this.streamingUrlSwitchCount>=this.configProvider.config.ampSettings.streamingUrlSwitchMaxCount||!(0,fi.includes)(this.configProvider.config.ampSettings.errorCodesEligibleForStreamingUrlSwitch,e)&&!t)return!1;const i=this.selectedStreamDetails.url===this.liveStreamOptions.stream?.url,n=i?this.liveStreamOptions.altStream:this.liveStreamOptions.stream;return ui(n)?(this.isSwitchStreamingUrlOngoing=!0,this.streamingUrlSwitchCount++,this.setPlayerSource(n).then((()=>!0)).catch((()=>!1))):(this.logger.error(`Stream to switch (${i?"alternative":"primary"}) is not valid`),!1)}destroy(e){this.srcLoadPromise=null,this.sdnPluginLoadPromise=null,this.renderer&&(this.renderer.dispose(),this.renderer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.liveStreamStatistic.registerPlayerDestroyed(e),this.playerInstance.dispose(),this.playerInstance=null,this.setPlaybackState("Destroyed"))}getCurrentTime(){const e=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return e&&e.currentPlayPosition||0}onCanplaythrough(){this.setPlaybackState("Ready")}onPlay(){(this.retryCount>0||this.lastKnownPlayTime)&&(this.logger.info(`Playing after retry count ${this.retryCount}, Setting current time to ${this.lastKnownPlayTime}`),this.playerInstance.message("setPlayTime").send(this.lastKnownPlayTime),this.retryCount=0,this.lastKnownPlayTime=void 0),this.setPlaybackState("Play")}onPlaying(){this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onResume(){this.setPlaybackState("Resume")}onStart(){this.logger.info(`Playback started, retry count: ${this.retryCount}`),this.setPlaybackState("Start"),this.event("playbackStarted").raise(),self.clearTimeout(this.noMediaTimeoutId),this.isSwitchStreamingUrlOngoing&&(this.logger.info(`Playback started, switch count: ${this.streamingUrlSwitchCount}`),this.event("urlSwitched").raise(this.selectedStreamDetails===this.liveStreamOptions.altStream),this.isSwitchStreamingUrlOngoing=!1)}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(e){this.captionsTimestamp=e.captionsTimestamp,this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(){this.setPlaybackState("Buffering")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}setPlaybackState(e){this.playerState=e,this.logger.debug(`playback state changed: ${e}`),this.liveStreamStatistic.registerPlaybackStateChanged(e),this.event("playbackStateChanged").raise()}onPlaybackBitrateChanged(e){this.liveStreamStatistic.registerPlaybackBitratechanged(e.bitrate)}onDownloadBitrateChanged(e){this.liveStreamStatistic.registerDownloadBitratechanged(e.bitrate)}onFullscreenChange(e){this.logger.debug(`fullscreenchange, isFullscreen=${e.isFullscreen}`),this.event("fullscreenToggled").raise(e.isFullscreen),this.liveStreamStatistic.registerFullScreenChange(e.isFullscreen)}onPotentialMediaFreeze(){this.logger.warn("Player detected a potential media freeze"),this.liveStreamStatistic.registerPotentialMediaFreeze()}onMute(){this.liveStreamStatistic.registerMute(!0)}onUnmute(){this.liveStreamStatistic.registerMute(!1)}onVolumeChange(e){this.liveStreamStatistic.registerVolumeChange(e.value)}stringifyPlayerError(e){return JSON.stringify(e,(function(e,t){return"errorCode"===e?t.toString(16):t}))}async handlePlaybackError(e){const t=4194307;this.playerState="Error",this.lastPlaybackError=e;const i=this.stringifyPlayerError(e);if(this.logger.info(`Playback error ${i}`),!e.errorCode&&null==e.fatal)return void this.logger.error("onError: error details are not available");if((e.errorCode&t)===t)return this.isPlaybackUnsupported=!0,this.raisePlaybackError("UnsupportedPlatform",i),void this.destroy("PlaybackError");this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;const n=e.errorCode,r=268435455&n;this.logger.error(`onError: errorCode: 0x${n.toString(16)}, errorCodeExcludingTech: 0x${r.toString(16)}, message: ${e.message}`),this.retryCount<this.configProvider.config.maxRetryCount&&(!1===e.fatal||-1!==(0,fi.indexOf)(Ui,r))?setTimeout((async()=>{this.logger.info(`Retry loading stream because of error code: 0x${n.toString(16)}`),this.retryCount++,this.raisePlaybackError("PlaybackRetried",i),this.setPlayerSource(this.selectedStreamDetails)}),this.configProvider.config.ampSettings.sourceResetTimeoutInMs):await this.switchStreamingUrl(r,e.fatal)?this.configProvider.config.ampSettings.resetStreamingUrlSwitchCount&&(this.streamingUrlSwitchCount=0):(r===Fi||e.message?.includes(Fi.toString(16))?this.raisePlaybackError("NetworkError",i):this.raisePlaybackError("PlaybackError",i),this.destroy("PlaybackError"))}raisePlaybackError(e,t){this.liveStreamStatistic.registerPlaybackError(e,t),this.event("playbackError").raise(e,t)}callDropDueToMediaTimeout(){const e={currentTime:-1,errorCode:0,message:JSON.stringify({state:this.playerState,error:this.stringifyPlayerError(this.lastPlaybackError)}),fatal:!0},t=this.stringifyPlayerError(e);this.raisePlaybackError("MediaTimeout",t),this.destroy("MediaTimeout")}},Bi=class extends We{constructor(e,t){super(),this.logger=e,this.telemetryLogger=t,this.playbackState="Destroyed",this.playerSubs=[],this.isFinalTelemetrySent=!1,this.captionsTimestamp=0}initialize(e,t,i,n){this.getTelemetryReportFn=e,this.getSnapshotTelemetryReportFn=t,this.disposePlayerFn=i,this.releaseFn=n}startTelemetryGathering(){let e,t;this.statsSub=window.setTimeout((async()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),1===this.configProvider.playerConfig.playerType?(e=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,t=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs):(e=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,t=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs),e&&(this.diagSub=window.setInterval((async()=>{this.sendSnapshotTelemetry()}),t))}stop(){this.clearPlayerEventSubscribers(),this.destroyPlayer()}destroyPlayer(){this.renderer&&(this.renderer.dispose(),this.renderer=null),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.disposePlayerFn(),this.sendFinalTelemetry(),this.releaseFn()}getPlaybackState(){return this.playbackState}getCaptionsTimestamp(){return this.captionsTimestamp}sendFinalTelemetry(){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0))}sendTelemetry(e){if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const t={...this.getTelemetryReportFn(),isFinal:e,threadId:this.threadId,tsCallingVersion:"2024.14.01.41",correlationId:this.streamOptions.correlationId};this.logger.debug("generated live stream report: ",t),this.telemetryLogger.sendEvent({eventName:"live_events",props:t})}else this.logger.info("telemetry not sent")}sendSnapshotTelemetry(){if(this.telemetryLogger){const e={...this.getSnapshotTelemetryReportFn(),isFinal:!1,threadId:this.threadId,tsCallingVersion:"2024.14.01.41",correlationId:this.streamOptions.correlationId};this.logger.debug("sending snapshot telemetry: ",e),this.telemetryLogger.sendEvent({eventName:"live_events",props:e})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set")}clearPlayerEventSubscribers(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onPlaybackSeeked(e){this.captionsTimestamp=e}onUrlSwitched(e){this.event("urlSwitched").raise(e)}onSdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}onSdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}onPlaybackStarted(){this.event("playbackStarted").raise()}},Hi=f(W());function $i(e){if(e.playbackCoordinates)return e.playbackCoordinates;if(!e.url&&!e.hlsUrls)return[];const t=[];return(e.hlsUrls?e.hlsUrls:[e.url]).forEach((i=>{t.push({url:i,ecdnProviderData:e.sdnContext})})),t}function Gi(e){return e.url?[{url:e.url,ecdnProviderData:e.sdnContext}]:[]}var ji=["https://afdhls.playerscript.prod.ml.cdn.office.net/hlsrt2024-226-1/hydra_player_hls_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/hlsrt2024-226-1/hydra_player_hls_bundle.js"],qi=class extends Bi{constructor(e,t,i){super(e,i),this.eventHandler=new Wi,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=t;const n=this.createHydraPlayerSettings(t);this.hydraPlayer=new Hi.HlsHydraPlayer(n,this.eventHandler)}async configure(e){if(this.streamOptions=e,this.threadId=e.threadId,this.playerLoaded){const t=this.createHydraStreamOptions(e);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",t)}}async loadPlayer(e){if(!await this.hydraPlayer.setup(e))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const e=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",e)}else this.logger.warn("No stream options configured before Hydra player loaded");const t=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return t.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(t)}onCaptionsToggled(e,t,i){this.captionsControl&&this.captionsControl.toggleCaptions(e,t),this.event("captionsToggled").raise(e,t,i)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){if(!this.captionsControl&&this.hydraPlayer){const e=this.streamOptions?.supportedSubtitleLanguages?this.streamOptions.supportedSubtitleLanguages.map((e=>e.culture)):["en","es"];this.captionsControl=new zi(this.hydraPlayer,e)}return this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(e=>{this.onPlaybackStateChanged(e)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(e=>{this.onPlaybackSeeked(e)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("captionsToggled",((e,t,i)=>{this.onCaptionsToggled(e,t,i)}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(e=>{this.onStatsUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("log",((e,t)=>{this.onLog(e,t)})))}createHydraPlayerSettings(e){return{hlsJsSources:e.playerConfig?.src,hydraRuntimeFetchTimeout:e.playerConfig?.hydraRuntimeFetchTimeout,capturePlayerLogs:e.config.capturePlayerLogs,allowSdnPlugins:e.config.allowSdnPlugins,debugLogging:e.config.debug??!1,muteVideo:e.playerConfig?.muteVideo??!1,videoLang:e.playerConfig?.lang,videoElementStyles:e.playerConfig?.styles,maxPlayerDiagnosticsCount:e.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:e.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:e.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:e.config.hlsSettings.maxPlayerExperimentalEvents,maxRetryCount:e.config.maxRetryCount,playerTelemetryTickMs:e.config.playerTelemetryTickMs,removeEmptyDefaultTextTrack:e.config.removeEmptyDefaultTextTrack,maxRetryCountForLoadingResources:e.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:e.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:e.config.hlsSettings.maxStreamConnectionResultsLogCount,maxAbsoluteTimeOffsetEstimationResultsLogCount:e.config.hlsSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount,skipNonce:e.config.hlsSettings.skipNonce,configIds:e.configIds,estimateAbsoluteTime:e.config.hlsSettings.estimateAbsoluteTime,playlistInitialSequenceNumber:e.config.hlsSettings.playlistInitialSequenceNumber,timeoutForSwitchingUrl:e.config.hlsSettings.timeoutForSwitchingUrl,hlsConfig:e.config.hlsSettings.hlsConfig,logHlsJsEvents:e.config.hlsSettings.logHlsJsEvents,logHlsJsEventsEveryMs:e.config.hlsSettings.logHlsJsEventsEveryMs,switchingPolicy:e.config.hydraPlayerHlsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:e.config.hlsSettings.enableUuidTrace,thaScript:e.config.hlsSettings.thaScript,enableOffsetComputeBasedOfStreamTime:e.config.hlsSettings.enableOffsetComputeBasedOfStreamTime,stopCrash:e.config.stopCrash,stopTerminating:e.config.hlsSettings.stopTerminating,stallDetectionPolicy:e.config.hydraPlayerHlsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:e.config.hydraPlayerHlsSettings?.runtimeUrls??e.playerConfig.hydraPlayerWebSdkUrls??ji,disableSandbox:e.config.hlsSettings.disableSandbox,ecsSettings:e.config.hydraPlayerHlsSettings?.ecsSettings}}createHydraStreamOptions(e){let t=Hi.HydraStreamingEventType.TLE;return t=e.streamingEventType?this.convertStreamingEventType(e.streamingEventType):e.overflow?Hi.HydraStreamingEventType.Overflow:Hi.HydraStreamingEventType.TLE,{stream:{playbackCoordinates:$i(e.stream),urls:e.stream.hlsUrls?e.stream.hlsUrls:[e.stream.url],keyAuthorizationToken:e.stream.keyAuthorizationToken,keyDeliveryUrl:e.stream.keyDeliveryUrl,sdnContext:e.stream.sdnContext,streamDeliveryPipeline:e.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.stream.streamDeliveryPipeline):void 0},altStream:e.altStream?{playbackCoordinates:$i(e.altStream),urls:e.altStream.hlsUrls?e.altStream.hlsUrls:[e.altStream.url],keyAuthorizationToken:e.altStream.keyAuthorizationToken,keyDeliveryUrl:e.altStream.keyDeliveryUrl,sdnContext:e.altStream.sdnContext,streamDeliveryPipeline:e.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.altStream.streamDeliveryPipeline):void 0}:void 0,supportedSubtitleLanguages:e.supportedSubtitleLanguages,streamingEventType:t,allowPlayerControls:e.allowPlayerControls,sdn:e.sdn?{name:e.sdn.name,url:e.sdn.url,plugin:e.sdn.plugin}:void 0,thaContext:e.thaContext?{eventId:e.thaContext.eventId,organizer:{userId:e.thaContext.organizer?.userId,tenantId:e.thaContext.organizer?.tenantId},attendee:{userId:e.thaContext.attendee?.userId,tenantId:e.thaContext.attendee?.tenantId},coOrganizers:e.thaContext.coOrganizers}:void 0,meetingMetadata:e.meetingMetadata}}convertStreamDeliveryPipeline(e){switch(e){case"AMS":return Hi.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Hi.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Hi.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${e} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(e){switch(e){case"TLE":return Hi.HydraStreamingEventType.TLE;case"Overflow":return Hi.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Hi.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Hi.HydraStreamingEventType.TownHallPremium;case"TownHall":return Hi.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${e} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(e){return{setupSucceeded:e.setupSucceeded,playerSetupError:e.playerSetupError?{errorType:this.convertHydraPlayerSetupError(e.playerSetupError.errorType),errorMessage:e.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(e){switch(e){case Hi.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Hi.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Hi.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Hi.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new Ni(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(e){this.playerStats=e}getStats(){return this.playerStats}onLog(e,t){this.logger[e](t)}onPlaybackStateChanged(e){try{this.playbackState=this.convertHydraPlaybackState(e),this.event("playbackStateChanged").raise()}catch(e){this.logger.warn(`Not handling playback state changed event: ${Ve(e)}`)}}convertHydraPlaybackState(e){switch(e){case Hi.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Hi.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Hi.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Hi.HydraPlayerPlaybackState.Start:return"Start";case Hi.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Hi.HydraPlayerPlaybackState.Play:return"Play";case Hi.HydraPlayerPlaybackState.Playing:return"Playing";case Hi.HydraPlayerPlaybackState.Pause:return"Paused";case Hi.HydraPlayerPlaybackState.Waiting:return"Buffering";case Hi.HydraPlayerPlaybackState.Seeking:return"Seeking";case Hi.HydraPlayerPlaybackState.Seeked:return"Seeked";case Hi.HydraPlayerPlaybackState.Ended:return"Ended";case Hi.HydraPlayerPlaybackState.Error:return"Error";case Hi.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Hi.HydraPlayerPlaybackState.Initialized:return"Initialized";case Hi.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${e} to PlaybackState`)}}onPlaybackError(e,t){try{const i=this.convertHydraPlaybackErrorType(e);this.event("playbackError").raise(i,t)}catch(e){this.logger.warn(`Not handling playback error event: ${Ve(e)}`)}}convertHydraPlaybackErrorType(e){switch(e){case Hi.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Hi.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Hi.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Hi.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Hi.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${e} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null)}},Wi=class extends We{constructor(){super()}playbackStateChanged(e){this.event("playbackStateChanged").raise(e)}playbackSeeked(e){this.event("playbackSeeked").raise(e)}log(e,t){this.event("log").raise(e,t)}playbackError(e,t){this.event("playbackError").raise(e,t)}captionsToggled(e,t,i){this.event("captionsToggled").raise(e,t,i)}urlSwitched(e){this.event("urlSwitched").raise(e)}sdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}sdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}statsUpdated(e){this.event("statsUpdated").raise(e)}playbackStarted(){this.event("playbackStarted").raise()}},zi=class{constructor(e,t){this.hydraPlayer=e,this.availableCultures=t,this.selectedCulture=""}async addCues(e){const t=this.convertCues(e);await this.hydraPlayer.callPlayerApi("addHydraPlayerCues",t)}convertCues(e){const t=[];return e.forEach((e=>{t.push({start:e.start,end:e.end,text:e.text})})),t}async clearCues(){await this.hydraPlayer.callPlayerApi("clearHydraPlayerCues")}async showCaptions(e){await this.hydraPlayer.callPlayerApi("showHydraPlayerCaptions",e)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.hydraPlayer=null}toggleCaptions(e,t){this.selectedCulture=e?t:""}},Ji=f(z()),Ki=class extends Bi{constructor(e,t,i){super(e,i),this.eventHandler=new Qi,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=t;const n=this.createHydraPlayerSettings(t);this.hydraPlayer=new Ji.UmsHydraPlayer(n,this.eventHandler)}get tracks(){return this.trackInfo}async configure(e){if(this.streamOptions=e,this.threadId=e.threadId,this.playerLoaded){const t=this.createHydraStreamOptions(e);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",t)}}async loadPlayer(e){if(!await this.hydraPlayer.setup(e))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const e=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",e)}else this.logger.warn("No stream options configured before Hydra player loaded");const t=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return t.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(t)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){return!this.captionsControl&&this.hydraPlayer&&(this.captionsControl=new Yi(this.hydraPlayer,this.logger.createChild("CaptionsControl"))),this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(e=>{this.onPlaybackStateChanged(e)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(e=>{this.onPlaybackSeeked(e)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(e=>{this.onStatsUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("trackListUpdated",(e=>{this.onTrackListUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("trackSelected",(e=>{this.onTrackSelected(e)}))),this.playerSubs.push(this.eventHandler.on("log",((e,t)=>{this.onLog(e,t)})))}onTrackListUpdated(e){this.trackInfo=e;const t=Ve(e);this.logger.info(`[onTrackListUpdated]: Track list updated to: ${t}`)}onTrackSelected(e){const t=Ve(e);this.logger.info(`[onTrackSelected]: Track selected: ${t}`)}createHydraPlayerSettings(e){return{hydraRuntimeFetchTimeout:e.playerConfig?.hydraRuntimeFetchTimeout,allowSdnPlugins:e.config.allowSdnPlugins,debugLogging:e.config.debug??!1,muteVideo:e.playerConfig?.muteVideo??!1,videoLang:e.playerConfig?.lang,videoElementStyles:e.playerConfig?.styles,maxPlayerDiagnosticsCount:e.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:e.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:e.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:e.config.umsSettings.maxPlayerExperimentalEvents,maxRetryCount:e.config.maxRetryCount,playerTelemetryTickMs:e.config.playerTelemetryTickMs,maxRetryCountForLoadingResources:e.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:e.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:e.config.umsSettings.maxStreamConnectionResultsLogCount,configIds:e.configIds,timeoutForSwitchingUrl:e.config.umsSettings.timeoutForSwitchingUrl,minTargetEdgeLatency:e.config.umsSettings.minTargetEdgeLatency,latencyCompensationThreshold:e.config.umsSettings.latencyCompensationThreshold,maxEdgeLatencyHistoryLength:e.config.umsSettings.maxEdgeLatencyHistoryLength,switchingPolicy:e.config.hydraPlayerUmsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:e.config.umsSettings.enableUuidTrace,thaScript:e.config.umsSettings.thaScript,stopCrash:e.config.stopCrash,stopTerminating:e.config.umsSettings.stopTerminating,stallDetectionPolicy:e.config.hydraPlayerUmsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:e.config.hydraPlayerUmsSettings?.runtimeUrls??e.playerConfig.hydraPlayerWebSdkUrls,disableSandbox:e.config.hlsSettings.disableSandbox,ecsSettings:e.config.hydraPlayerUmsSettings?.ecsSettings}}createHydraStreamOptions(e){let t=Ji.HydraStreamingEventType.TLE;return t=e.streamingEventType?this.convertStreamingEventType(e.streamingEventType):e.overflow?Ji.HydraStreamingEventType.Overflow:Ji.HydraStreamingEventType.TLE,{stream:{playbackCoordinates:Gi(e.stream),urls:[e.stream.url],decryptionKey:e.stream.decryptionKey,sdnContext:e.stream.sdnContext,streamDeliveryPipeline:e.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.stream.streamDeliveryPipeline):void 0},altStream:e.altStream?{urls:[e.altStream.url],playbackCoordinates:Gi(e.altStream),decryptionKey:e.altStream.decryptionKey,sdnContext:e.altStream.sdnContext,streamDeliveryPipeline:e.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.altStream.streamDeliveryPipeline):void 0}:void 0,streamingEventType:t,allowPlayerControls:e.allowPlayerControls,sdn:e.sdn?{name:e.sdn.name,url:e.sdn.url,plugin:e.sdn.plugin}:void 0,thaContext:e.thaContext?{eventId:e.thaContext.eventId,organizer:{userId:e.thaContext.organizer?.userId,tenantId:e.thaContext.organizer?.tenantId},attendee:{userId:e.thaContext.attendee?.userId,tenantId:e.thaContext.attendee?.tenantId},coOrganizers:e.thaContext.coOrganizers}:void 0,meetingMetadata:e.meetingMetadata}}convertStreamDeliveryPipeline(e){switch(e){case"AMS":return Ji.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Ji.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Ji.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${e} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(e){switch(e){case"TLE":return Ji.HydraStreamingEventType.TLE;case"Overflow":return Ji.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Ji.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Ji.HydraStreamingEventType.TownHallPremium;case"TownHall":return Ji.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${e} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(e){return{setupSucceeded:e.setupSucceeded,playerSetupError:e.playerSetupError?{errorType:this.convertHydraPlayerSetupError(e.playerSetupError.errorType),errorMessage:e.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(e){switch(e){case Ji.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Ji.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Ji.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Ji.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new Ni(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(e){this.playerStats=e}getStats(){return this.playerStats}onLog(e,t){this.logger[e](t)}onPlaybackStateChanged(e){try{this.playbackState=this.convertHydraPlaybackState(e),this.event("playbackStateChanged").raise()}catch(e){this.logger.warn(`Not handling playback state changed event: ${Ve(e)}`)}}convertHydraPlaybackState(e){switch(e){case Ji.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Ji.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Ji.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Ji.HydraPlayerPlaybackState.Start:return"Start";case Ji.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Ji.HydraPlayerPlaybackState.Play:return"Play";case Ji.HydraPlayerPlaybackState.Playing:return"Playing";case Ji.HydraPlayerPlaybackState.Pause:return"Paused";case Ji.HydraPlayerPlaybackState.Waiting:return"Buffering";case Ji.HydraPlayerPlaybackState.Seeking:return"Seeking";case Ji.HydraPlayerPlaybackState.Seeked:return"Seeked";case Ji.HydraPlayerPlaybackState.Ended:return"Ended";case Ji.HydraPlayerPlaybackState.Error:return"Error";case Ji.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Ji.HydraPlayerPlaybackState.Initialized:return"Initialized";case Ji.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${e} to PlaybackState`)}}onPlaybackError(e,t){try{const i=this.convertHydraPlaybackErrorType(e);this.event("playbackError").raise(i,t)}catch(e){this.logger.warn(`Not handling playback error event: ${Ve(e)}`)}}convertHydraPlaybackErrorType(e){switch(e){case Ji.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Ji.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Ji.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Ji.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Ji.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${e} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null)}},Yi=class{constructor(e,t){this.hydraPlayer=e,this.logger=t}async addCues(e){this.logger.warn("[addCues]: not implemented for UMS player")}async clearCues(){this.logger.warn("[clearCues]: not implemented for UMS player")}async showCaptions(e){await this.hydraPlayer.callPlayerApi("toggleHydraPlayerCaptions",e)}getSelectedCulture(){return this.logger.warn("[getSelectedCulture]: not implemented for UMS player"),""}getAvailableCultures(){return this.logger.warn("[getAvailableCultures]: not implemented for UMS player"),[]}dispose(){this.hydraPlayer=null}async selectTextTrack(e){await this.hydraPlayer.callPlayerApi("selectHydraPlayerTextTrack",e)}},Qi=class extends We{constructor(){super()}playbackStateChanged(e){this.event("playbackStateChanged").raise(e)}playbackSeeked(e){this.event("playbackSeeked").raise(e)}log(e,t){this.event("log").raise(e,t)}playbackError(e,t){this.event("playbackError").raise(e,t)}trackListUpdated(e){this.event("trackListUpdated").raise(e)}trackSelected(e){this.event("trackSelected").raise(e)}urlSwitched(e){this.event("urlSwitched").raise(e)}sdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}sdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}statsUpdated(e){this.event("statsUpdated").raise(e)}playbackStarted(){this.event("playbackStarted").raise()}},Xi=class extends We{constructor(e,t,i){super(),this.configProvider=e,this.logger=t,this.getTelemetryLogger=i,this.isAvailable=!0,this._isStreaming=!1,this.playerSubs=[],this.isFinalTelemetrySent=!1,this.telemetryLogger=this.getTelemetryLogger(),1===this.configProvider.playerConfig.playerType?this.player=new qi(this.logger.createChild("HlsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):2===this.configProvider.playerConfig.playerType?this.player=new Ki(this.logger.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):(this.initializeAmpTelemetry(),this.player=new Vi(this.logger.createChild("AmpLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)),this.subscribeForPlayerEvents()}get isStreaming(){return this._isStreaming}isActive(){return this.isAvailable&&this.isStreaming}async start(e,t){await this.setOptions(t),this.isFinalTelemetrySent=!1;const i=await this.player.loadPlayer(e);if(!i.setupSucceeded){this.player.stop(),this.logger.error("playerLoadFailed");const e=JSON.stringify(i.playerSetupError);throw this.sendFinalTelemetry(e),new Error(e)}return this._isStreaming=!0,this.liveStreamStatistic&&(this.statsSub=window.setTimeout((()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),this.configProvider.config.sendSnapshotTelemetry&&(this.diagSub=window.setInterval((()=>{this.sendSnapshotTelemetry()}),this.configProvider.config.sendSnapshotTelemetryEveryMs))),this.player.getRenderer()}initializeAmpTelemetry(){this.liveStreamStatistic=new mi(this.configProvider.config,this.logger.createChild("LiveStreamStatistic"),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],currentMediaTime:[],statsInterval:[]})}async stop(){}async setOptions(e){return void 0!==e.overflow&&(e.streamingEventType||(e.streamingEventType=e.overflow?"Overflow":"TLE"),delete e.overflow),this.options=e,this.player.configure(e)}getStats(){return this.liveStreamStatistic?this.liveStreamStatistic.getPlayerDiagnosticSnapshot():this.player?.getStats?.()}dispose(){this.unsubscribeFromPlayerEvents(),this.player.stop(),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.logger.debug("stopping live event"),this.sendFinalTelemetry("graceful disposed"),super.dispose()}sendFinalTelemetry(e){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0,e))}sendTelemetry(e,t){if(this.liveStreamStatistic)if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const i={configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:e,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton,callendReason:t},n=this.liveStreamStatistic?.getReport(i);this.logger.debug("generated live stream report",n),this.telemetryLogger.sendEvent({eventName:"live_events",props:n})}else this.logger.info("telemetry not sent");else this.logger.info("telemetry not tracked in ILiveStream object")}sendSnapshotTelemetry(){if(this.liveStreamStatistic)if(this.telemetryLogger){const e=this.liveStreamStatistic.getSnapshotReport({configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:!1,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton});this.logger.debug("sending snapshot telemetry: ",e),this.telemetryLogger.sendEvent({eventName:"live_events",props:e})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set");else this.logger.info("telemetry not tracked in ILiveStream object")}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("playbackStateChanged",(()=>{this.onPlaybackStateChanged()}))),this.playerSubs.push(this.player.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.player.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.player.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.player.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.player.on("playbackStarted",(()=>{this.onPlaybackStarted()})))}unsubscribeFromPlayerEvents(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onPlaybackStarted(){this.event("playbackStarted").raise()}onPlaybackStateChanged(){const e=this.player.getPlaybackState();switch(e){case"Start":this.event("playbackStarted").raise();break;case"Ended":this.event("playbackNotLive").raise(),this.sendFinalTelemetry("playback ended");break;case"Seeked":this.event("playbackSeeked").raise(this.player.getCaptionsTimestamp());break;default:this.logger.debug(`playbackStateChanged: ${e}`)}this.event("playbackStateChanged").raise(this.player.getPlaybackState())}onPlaybackError(e,t){this.event("error").raise(e,t)}onUrlSwitched(e){this.event("urlSwitched").raise(e)}onSdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}onSdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}},Zi=class{constructor(e,t,i){this.ecsConfig=e,this.logger=t,this.getTelemetryLogger=i}configure(e){this.configuration=e}async initialize(){const e="MDN_MIDDLELANE_TEAMS",t="liveStream",i=this.ecsConfig.getString(e,t);let n={};try{n=JSON.parse(i)}catch(i){this.logger.warn(`failed to parse ECS configuration for ${e}/${t}`)}const r=this.ecsConfig.getString("ConfigIDs",e);this._configProvider=new ci(n,this.configuration,r,this.logger.createChild("LiveStreamConfigProvider"))}createLiveStream(){return new Xi(this._configProvider,this.logger.createChild("LiveStream"),this.getTelemetryLogger)}dispose(){}},en=class extends We{constructor(){super(...arguments),this.isAudioOutputSelectionSupported=!1}createAudioPlayer(){return null}createAudioRenderer(){return null}getRawDeviceMediaStream(e){return null}askDevicePermission(){return Promise.resolve({audio:!1,video:!1})}getPermissionState(e){return"granted"}enumerateDevicesAsync(){return Promise.resolve([])}getPreferredCamera(){return null}selectDevices(){}getSelectedDevices(){return{}}createPreview(){return Promise.resolve(new tn)}createPreviewRenderer(){return Promise.resolve(new tn)}createScreenSharingPreviewRenderer(){return Promise.resolve(new tn)}getDeviceNameAsync(){return Promise.resolve("")}setDeviceEffectsAsync(){return Promise.resolve()}getDeviceEffectsCapabilityAsync(){return Promise.resolve(0)}setBackgroundImageAsync(){return Promise.resolve()}getImagePropertyAsync(){return Promise.resolve({width:0,height:0,uri:" "})}getMicrophoneGeometryArrayInfoAsync(e){return Promise.resolve({})}transformImageAsync(){return Promise.resolve(!1)}sendMessageDeviceVideoEffectsAsync(){return Promise.resolve({code:0})}sendMessageDeviceVideoExtensibilityAsync(){return Promise.resolve({code:0,type:"Error",response:{details:"The API has not been implemented."}})}setVideoCaptureConfigAsync(){return Promise.resolve()}captureVideoFrameWithoutEffectsAsync(){return Promise.resolve(new ImageData(0,0))}setAudioProcessingFlags(e){}getSpeakerVolume(){return Promise.resolve(0)}getSpeakerSystemVolume(){return Promise.resolve(0)}setSpeakerVolume(e){return Promise.resolve()}setSpeakerSystemVolume(e){return Promise.resolve()}unmuteMicrophone(){return Promise.resolve()}unmuteSpeaker(){return Promise.resolve()}getNrgLevelsForDeviceTuner(e){return Promise.resolve(0)}setAudioEffectsAsync(){return Promise.resolve()}getAudioFeatureCapability(e){return Promise.resolve(0)}getMicrophoneVolume(){return Promise.resolve(0)}setMicrophoneVolume(e){return Promise.resolve()}setDeviceTelemetryData(e,t,i,n=0){return Promise.resolve()}getSpeakerDeviceDomIdAsync(e,t){return Promise.reject()}getSourceFormats(e){return Promise.resolve([])}enableShellSharing(){return Promise.resolve()}disableShellSharing(){return Promise.resolve()}enableParticipantCameras(){return Promise.resolve()}registerDerivedSource(e,t){return Promise.resolve()}unregisterDerivedSource(e){return Promise.resolve()}startAudioLoopbackDevice(e){return Promise.resolve()}async dispose(e){return Promise.resolve()}},tn=class extends We{constructor(){super(...arguments),this.isRendering=!1,this.streamSize={width:0,height:0},this.rendererType=-1,this.frameType=-1}captureFrame(){return Promise.resolve(new nn)}getStats(){return Promise.resolve({framesDropped:0,framesTotal:0})}setScalingMode(){return Promise.resolve()}cameraAutoControl(e){return Promise.resolve(!1)}getCameraManualControlStates(e){return Promise.resolve([])}setCameraManualControlStates(e){return Promise.resolve([])}enumerateCameraManualControls(){return Promise.resolve([])}dispose(){}},nn=class extends We{getSize(){return{width:0,height:0}}isMirrored(){return!1}},rn="skypecosi_concore_web_ts_calling_registry",sn="*11",an="*12",on="*13",cn="*14",ln={totalParticipants:0,preheatedParticipants:0,lobbyParticipants:0,totalPresenters:0,requestingAttentionPresenters:0,totalAttendees:0,requestingAttentionAttendees:0,overflowAttendees:0},dn=g,hn=class{constructor(e,t,i,n,r){this.eventName=e,this.eventStartTime=t,this.type=i,this.causeId=n,this.status="Pending",this.eventStartTimestamp=(new Date).getTime(),this.data=[],this.causeId=n?.substring(0,8),"Event"===this.type&&delete this.status,r&&this.data.push(r)}set variant(e){this.eventVariant=e}recordSuccess(e,t){this.recordResult("Success",e,t)}recordFailure(e,t){this.recordResult("Failure",e,t)}recordTimeout(e,t){this.recordResult("Timeout",e,t)}addData(e){this.data.push(e)}isPending(){return"Pending"===this.status}getEvent(){const e={start:this.eventStartTime,duration:this.duration,status:this.status,result:this.result,causeId:this.causeId,resultCauseId:this.resultCauseId,variant:this.eventVariant,data:this.data.map((e=>this.prepareData(e,!0))).filter((e=>!!e))};return"Event"===this.type&&delete e.status,e.data.length||delete e.data,e.causeId||delete e.causeId,e.resultCauseId||delete e.resultCauseId,e.result||delete e.result,e.variant||delete e.variant,{[this.eventName]:e}}recordResult(e,t,i){this.status=e,this.result=this.prepareData(t),this.causeId!==i&&(this.resultCauseId=i),this.duration=(new Date).getTime()-this.eventStartTimestamp}prepareData(e,t=!1){if(null==e)return"";if("string"==typeof e)return we(e);if("number"==typeof e||"boolean"==typeof e)return String(e);if("function"==typeof e)return"";if(e instanceof Error)return e.toString();try{return Object.keys(e).length?t?e:Oe(e):""}catch(e){return"invalid"}}},un=class{constructor(e,t,i,n){this.logger=e,this.startTime=t,this.maxEventsExceeded=i,this.perfModule=n,this.recordedEvents=[],this.ipcStats=[],this.ongoingOperations={}}recordEvent(e,t,i=Te()){this.logger.debug("Event:",e,dn.pii.Omit(t));const n=new hn(e,this.getEventStartTime(),"Event",i,t);return this.pushToRecordedEvents(n),n}recordOperationSuccess(e,t=null,i,n,r){this.logger.info("Event success:",n,e,dn.pii.Omit(i),dn.pii.Omit(t)),this.recordOperationResult(e,t,"Success",i,n,r)}recordOperationFailure(e,t,i,n,r){this.logger.info("Event failure:",e,dn.pii.Omit(i),t),this.recordOperationResult(e,t,"Failure",i,n,r)}recordOperationTimeout(e,t,i,n,r){this.logger.info("Event timeout:",e,dn.pii.Omit(i),t),this.recordOperationResult(e,t,"Timeout",i,n,r)}maybeRecordOperationSuccess(e,t=null,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationSuccess(e,t,i,n,r)}maybeRecordOperationFailure(e,t,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationFailure(e,t,i,n,r)}maybeRecordOperationTimeout(e,t,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationTimeout(e,t,i,n,r)}recordOperationResult(e,t,i,n,r,s){this.hasOngoingEvent(e,n)||this.recordOperation(e,r,n);let a=this.ongoingOperations[e];switch(n&&(a=a[n]),s&&a.addData(s),i){case"Success":a.recordSuccess(t,r);break;case"Failure":a.recordFailure(t,r);break;case"Timeout":a.recordTimeout(t,r);break;default:this.logger.error("Unknown operation record state in record operation result.")}n?delete this.ongoingOperations[e][n]:delete this.ongoingOperations[e]}recordOperation(e,t,i,n){this.logger.debug("Event create:",t,e,dn.pii.Omit(i),n);const r=new hn(e,this.getEventStartTime(),"Operation",t,n);return this.ongoingOperations[e]||(this.ongoingOperations[e]={}),i?this.ongoingOperations[e][i]=r:this.ongoingOperations[e]=r,this.pushToRecordedEvents(r),r}setOperationVariant(e,t,i){let n;n=i?this.ongoingOperations[e][i]:this.ongoingOperations[e],n?n.variant=t:this.logger.error(`Could not find operation ${e} to set variant ${t}`)}updateOperationData(e,t,i,n){try{if(!this.ongoingOperations[e])return void this.recordEvent(e,t,i);n?this.ongoingOperations[e][n]&&this.ongoingOperations[e][n].addData(t):this.ongoingOperations[e].addData(t)}catch(t){return void this.logger.info(`Unable to update operation: ${e} data`)}}pushToRecordedEvents(e){if(this.maxEventsExceeded&&this.maxEventsExceeded()&&this.recordedEvents.shift(),this.recordedEvents.push(e),this.perfModule&&this.ipcStats.length<=30){const e=this.perfModule.getIpcStats();e&&this.ipcStats.push({ingestionTime:this.getEventStartTime(),stats:e})}}hasOngoingEvent(e,t){return this.ongoingOperations[e]?!(t&&!this.ongoingOperations[e][t]&&(this.logger.warn(`Unable to find event for name\\id ${e}\\${dn.pii.Omit(t)}`),1)):(this.logger.warn(`Unable to find event for name ${e}`),!1)}getEventStartTime(){return(new Date).getTime()-this.startTime}getEventTimestampBag(e,t){const i=t?[t.getEvent()]:this.recordedEvents.filter((t=>!e||!t.isPending())).map((e=>e.getEvent())),n=JSON.stringify({eventStart:this.startTime,events:i});return this.logger.info(`Call eventTimestampBag ${dn.pii.Omit(n)}`),n}getIPCStats(){return 0!==this.ipcStats.length?JSON.stringify(this.ipcStats):""}removeRecordedEvent(e){const t=this.recordedEvents.indexOf(e);t>-1&&this.recordedEvents.splice(t,1)}},gn=class extends un{constructor(e,t){super(e,t,(()=>this.recordedEvents.length>150)),this.getHostName=()=>{try{return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>"}catch(e){return"unknown"}},this.tsCallingVersion="2024.14.01.41",this.logger=e.createChild("CallRegistryTelemetry")}setClientType(e){this.clientType=e}setEndpointId(e){this.endpointId=e}setSkypeId(e){this.skypeId=we(e)}setApplicationType(e){this.applicationType=e}setRing(e){this.ring=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setAcsResourceId(e){this.acsResourceId=e}setRegion(e){this.region=e}setPartition(e){this.partition=e}getEvent(e,t){const i=e=>void 0===e?"":e;return{EndpointId:i(this.endpointId),SkypeId:i(this.skypeId),ApplicationType:i(this.applicationType),Ring:i(this.ring),TenantId:i(this.tenantId),userHexCID:i(this.userHexCID),AcsResourceId:i(this.acsResourceId),Region:i(this.region),Partition:i(this.partition),TsCallingVersion:i(this.tsCallingVersion),HostName:this.getHostName(),EventTimestampBag:this.getEventTimestampBag(e,t),DiagnosticInfo:this.callEndDiagnosticInfo,ClientType:i(this.clientType)}}removeNonPendingOperations(){this.recordedEvents=this.recordedEvents.filter((e=>e.isPending()))}},pn=class extends un{constructor(e,t,i){super(e,t,(()=>this.inCallMode&&this.recordedEvents.length>150),i),this.inCallMode=!1,this.tsCallingVersion="2024.14.01.41",this.logger=e.createChild("CallTelemetry")}setClientType(e){this.clientType=e}setCallId(e){this.currentCallId&&(this.previousCallId=this.currentCallId),this.currentCallId=e}setConsultativeCallId(e){this.consultativeCallId=e}setEndpointId(e){this.endpointId=e}setParticipantId(e){this.participantId=e}setPreheatFlags(e){this.preheatFlags=e}setCallOrigin(e){this.origin=e}setGroupId(e){this.groupId=e}setThreadId(e){this.threadId=e}setBackroomThreadId(e){this.backroomThreadId=e}setComplianceRecordingContentLength(e){this.complianceRecordingContentLength=e}setMesageId(e){this.messageId=e}setSkypeId(e){this.skypeId=we(e)}setApplicationType(e){this.applicationType=e}setRing(e){this.ring=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setAcsResourceId(e){this.acsResourceId=e}setRegion(e){this.region=e}setPartition(e){this.partition=e}setFailureType(e){this.failureType=e}setIsCast(e){this.isCast=e?"True":"False"}setIsHuddleGroupCall(e){this.isHuddleGroupCall=e?"True":"False"}setIsEmergency(e){this.isEmergency=e?"True":"False"}setRole(e){this.isAnonymous="admin"===e?"False":"True"}setCallType(e){this.callType=e}setConversationType(e){this.conversationType=e}setDirection(e){this.direction=e}setSelfParticipantRole(e){this.selfParticipantRole=e}setTerminationState(e){this.terminationState=e}setTerminationReason(e){this.terminationReason=e}setCallEndDiagnosticInfo(e){this.callEndDiagnosticInfo=e}setStackConfig(e){this.stackConfig=e}setJoinedFrom(e){this.joinedFrom=e}setMeetingCode(e){this.meetingCode=e}setMeetingUrl(e){this.meetingUrl=e}setHasMeetingRegistrationId(e){this.hasMeetingRegistrationId=e?"True":"False"}setHasParticipantPin(e){this.hasParticipantPin=e?"True":"False"}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.currentCallId),PreviousCorrelationId:i(this.previousCallId),ConsultativeCallId:i(this.consultativeCallId),EndpointId:i(this.endpointId),SkypeId:i(this.skypeId),ParticipantId:i(this.participantId),PreheatFlags:i(this.preheatFlags),CallType:i(this.callType),ConversationType:i(this.conversationType),Direction:i(this.direction),Origin:i(this.origin),SelfParticipantRole:i(this.selfParticipantRole),IsAnonymous:i(this.isAnonymous),GroupId:we(i(this.groupId)),ThreadId:Me(i(this.threadId)),MessageId:i(this.messageId),ApplicationType:i(this.applicationType),Ring:i(this.ring),TenantId:i(this.tenantId),userHexCID:i(this.userHexCID),AcsResourceId:i(this.acsResourceId),Region:i(this.region),Partition:i(this.partition),FailureType:i(this.failureType),IsCast:i(this.isCast),IsHuddleGroupCall:i(this.isHuddleGroupCall),IsEmergency:i(this.isEmergency),TsCallingVersion:i(this.tsCallingVersion),TerminationState:i(this.terminationState),TerminationReason:i(this.terminationReason),StackConfig:i(this.stackConfig),EventTimestampBag:this.getEventTimestampBag(e,t),HostName:this.getHostName(),DiagnosticInfo:this.callEndDiagnosticInfo,JoinedFrom:this.joinedFrom,MeetingCode:this.meetingCode,MeetingUrl:this.meetingUrl,HasMeetingRegistrationId:this.hasMeetingRegistrationId,HasParticipantPin:this.hasParticipantPin,IPCStats:this.getIPCStats(),ComplianceRecordingContentLength:i(this.complianceRecordingContentLength),BackroomThreadId:Me(i(this.backroomThreadId)),ClientType:i(this.clientType)}}switchToInCallTelemetry(){this.recordedEvents=this.recordedEvents.filter((e=>e.isPending())),this.inCallMode=!0}getHostName(){try{return location.host}catch(e){return"unknown"}}},mn=e=>Array.isArray(e)?e.map((e=>({endpointId:e.endpointId,participantId:e.participantId}))):null;function fn(e,t,i){if(!e)return i.info(`sanitizeMeetingCode[${t}] empty / undefined meeting code parameter`),e;let n=e.replace(/\s/g,"");return n=n.replace(/-/g,""),i.info(`sanitizeMeetingCode[${t}] meetingCode: ${e}, sanitizedMeetingCode: ${n}`),n}function Sn(e,t,i){if(!e)return i.info(`getMeetingCodeFromMeetingUrl[${t}] empty / undefined meeting Url parameter`),e;const n=new URL(e);let r="";if(n&&n.pathname&&n.pathname.split("/").length>=2){const e=n.pathname.split("/");"meet"===e[e.length-2]&&(r=e[e.length-1])}return i.info(`getMeetingCodeFromMeetingUrl[${t}] meetingUrl: ${e}, meetingUrlObject: ${Le(n)}, meetingCode: ${r}`),r}function vn(e,t,i,n){const r=fn(e&&e.meetingCode||"",i,n),s=fn(t&&t.meetingCode||"",i,n),a=(e,t)=>!!e&&!!t&&e===t;if(a(r,s))return!0;let o=Sn(e&&e.meetingUrl||"",i,n);o=fn(o,i,n);let c=Sn(t&&t.meetingUrl||"",i,n);if(c=fn(c,i,n),a(o,c))return!0;if(a(o,s)||a(c,r))return!0;if(e&&e.meetingUrl&&t&&t.meetingUrl){const i=new URL(e.meetingUrl),n=new URL(t.meetingUrl);if(i.hostname===n.hostname&&i.pathname===n.pathname)return!0}return!1}function yn(){}var Cn={SUCCESS:0,MEDIA_ERROR:410,CLIENT_ERROR_CODE:499,UNKNOWN_ERROR:497},_n={VDI_DISCONNECTED:3e3,ACTION_NOT_ALLOWED:3548,ABANDONED:4990,ENDED_BY_REMOTE_ENDPOINT:5028,BEACON:4521,UNKNOWN_FAILURE:3545},En=4294967294,Tn="_operationIdValue_",In="_causeIdValue_",bn="_callStartOptionsValue_",An="_clientReasonValue_";function Rn(e,t,i=!1){return kn(0,e,t,i)}function wn(e,t){return kn(1,e,t)}var Pn=(e,t,i)=>{if(e[t][Tn])throw new Error("can not specify more than one operation id");e[t][Tn]=i},Mn=(e,t,i)=>{if(e[t][In])throw new Error("can not specify more than one cause id");e[t][In]=i},Dn=(e,t,i)=>{if(e[t][bn])throw new Error("can not specify options more than once");e[t][bn]=i},On=(e,t,i)=>{if(e[t][An])throw new Error("can not specify reason more than once");e[t][An]=i},kn=(e,t,i,n=!1)=>(r,s,a)=>{const o=a.value,c=r[s]?.[Tn],l=r[s]?.[In],d=r[s]?.[bn],h=r[s]?.[An],u=i?.type||"Async";return a.value=function(...r){const s=this;let a=n?xi():Te();void 0!==l&&(r[l]&&(function(e){return new RegExp("^[a-f0-9]{8}$").test(e)&&e.length===Ee}(r[l])||function(e){return new RegExp("^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$").test(e)&&36===e.length}(r[l]))?a=r[l]:r[l]=a);let g,p=void 0!==c?r[c]:void 0;if(void 0!==p)if(Array.isArray(p))try{const e=p.map((e=>e.toString())).sort().concat().toString();p=function(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}(e).toString()}catch{const e=`[${p}]${t} failed in array parsing in operationDecorator`,i={terminatedReason:32,terminatedReasonCode:Cn.UNKNOWN_ERROR,terminatedReasonSubCode:_n.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}else if(p&&"object"==typeof p)try{let e=JSON.stringify(p);i&&i.operationIdKey&&p.hasOwnProperty(i.operationIdKey)&&(e=p[i.operationIdKey]),p=e}catch{const e=`[${p}]${t} failed in object parsing in operationDecorator`,i={terminatedReason:32,terminatedReasonCode:Cn.UNKNOWN_ERROR,terminatedReasonSubCode:_n.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}void 0!==h&&r[h]&&(g=r[h]);const m=Nn(s,e);if(m.logOperation(a,t),i&&i.singular&&m.hasPendingOperation(t))return m.logOperation(a,t,"Not allowed, pending operation exists"),Promise.reject(60);if(i&&i.idempotencyLevel&&m.getRecord(t)>0)switch(m.logOperation(a,t,`Called multiple times, handling operation according to specified policy: idempotency=${i.idempotencyLevel}`),i.idempotencyLevel){case"NoOp":return Promise.resolve();case"Error":return Promise.reject(60)}try{void 0!==d&&r[d]&&s.processCallStartOptions(r[d],a)}catch{const e=`${t} failed in processCallStartOptions`,i={terminatedReason:32,terminatedReasonCode:Cn.UNKNOWN_ERROR,terminatedReasonSubCode:_n.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}const f=!(!i||!i.convertError),S=()=>"Chained"===u?m.executeChained(o.bind(this,...r),t,p,a,f,g,i):"Sync"===u?m.executeSync(o.bind(this,...r),t,p,a,f,g):m.execute(o.bind(this,...r),t,p,a,f,g,i);if("StartCall"!==t&&"JoinCall"!==t||m.hasPendingOperation("_CallStartOrJoinInitiated")||m.createPendingOperation("_CallStartOrJoinInitiated").catch(yn),i&&i.triggerAttach&&(m.hasPendingOperation("_ElectronSlimcoreReady")||m.createPendingOperation("_ElectronSlimcoreReady").catch(yn)),i&&"Sync"!==i.type){const e=i&&i.waitFor;if(Array.isArray(e))return Promise.all(e.map((e=>e&&m.hasPendingOperation(e)&&m.waitForOperation(e,void 0,a)))).then(S,S);if(e&&m.hasPendingOperation(e))return m.waitForOperation(e,void 0,a).then(S,S)}return S()},a},Nn=(e,t)=>{if(0===t)return e._callOperationHandler;if(1===t)return e._participantOperationHandler;throw new Error("Unsupported operation handler type!")};var Ln=class{constructor(e){this._disposed=!1,this._logger=e.createChild("[ASYNC]"),this._endOperationDeferred=vi(),this._endOperationDeferred.promise.catch((e=>{this._logger.info("Rejected all operations")})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._deferredOperationsWithCauseId={},this._logger=e}registerPromise(e,t){let i=!1;const n=()=>{i=!0};t.then(n,n);const r=this._endOperationDeferred.promise.catch((t=>{if(!i)throw new Error(`Operation ${e} did not complete, reason:${t}`)}));return Promise.race([r,t])}updateOperationId(e,t){this._logger.info(`updateOperationId ${e} ${t}`),Object.keys(this._deferredOperationsWithOperationId).forEach((i=>{i&&this._deferredOperationsWithOperationId[i]&&(this._logger.info(`_deferredOperationsWithOperationId ${i}`),Object.keys(this._deferredOperationsWithOperationId[i]).forEach((n=>{n&&this._deferredOperationsWithOperationId[i][n]&&(this._logger.info(`_deferredOperationsWithOperationId ${n} ${t}`),n===e&&(this._deferredOperationsWithOperationId[i][t]=this._deferredOperationsWithOperationId[i][n],delete this._deferredOperationsWithOperationId[i][n]))})))})),Object.keys(this._deferredOperationsWithCauseId).forEach((i=>{i&&this._deferredOperationsWithCauseId[i]&&(this._logger.info(`_deferredOperationsWithCauseId ${i}`),Object.keys(this._deferredOperationsWithCauseId[i]).forEach((n=>{n&&this._deferredOperationsWithCauseId[i][n]&&(this._logger.info(`_deferredOperationsWithCauseId ${n} ${t}`),n===e&&(this._deferredOperationsWithOperationId[i][t]=this._deferredOperationsWithOperationId[i][n],delete this._deferredOperationsWithOperationId[i][n]))})))}))}createPendingOperation(e,t,i=Te(),n={}){const r=vi();r.promise.catch(yn);const s=this.getOperationInfoForLogging(i,e,t);let a;if(this._logger.info(`${s}[creating...]`),this._disposed)return this._logger.info(`${s}[create failed, call is disposed]`),Promise.reject(60);if(t){if(this._deferredOperationsWithOperationId[e]||(this._deferredOperationsWithOperationId[e]={}),this._deferredOperationsWithOperationId[e][t])return this._logger.warn(`${s} Deferred operation with given name and operation id is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${e}/${we(t)}`));this._deferredOperationsWithOperationId[e][t]={deferred:r,causeId:i},this._deferredOperationsWithCauseId[i]||(this._deferredOperationsWithCauseId[i]={}),this._deferredOperationsWithCauseId[i][t]={deferred:r,options:n,operationName:e},a=this._endOperationDeferred.promise.catch((i=>{if(this.hasPendingOperationWithOperationId(e,t))throw new Error(`Operation ${e} ${t} did not complete, reason:${i}`)}))}else{if(this._deferredOperations[e])return this._logger.warn(`${s} Deferred operation with given name is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${e}`));this._deferredOperationsWithCauseId[i]||(this._deferredOperationsWithCauseId[i]={}),this._deferredOperationsWithCauseId[i][""]={deferred:r,options:n,operationName:e},this._deferredOperations[e]={deferred:r,causeId:i},a=this._endOperationDeferred.promise.catch((t=>{if(this.hasPendingOperation(e))throw new Error(`Operation ${e} did not complete, reason:${t}`)}))}return Promise.race([a,r.promise])}hasPendingOperation(e){return!!this._deferredOperations[e]}hasAtleastOneOfPendingOperation(e){for(const t of e)if(this.hasPendingOperation(t))return!0;return!1}hasPendingOperationWithOperationId(e,t){return!(!t||!this._deferredOperationsWithOperationId[e]||!this._deferredOperationsWithOperationId[e][t])}hasPendingOperationWithCauseId(e,t){const i=t||"";return this._deferredOperationsWithCauseId[e]&&!!this._deferredOperationsWithCauseId[e][i]}getPendingOperationWithCauseId(e,t){return this.hasPendingOperationWithCauseId(e,t)?this._deferredOperationsWithCauseId[e][t].deferred.promise:Promise.reject(`[${e}][${t}]: getPendingOperationWithCauseId for given causeId, operationId`)}resolveOperationWithCauseId(e,t,i){const n=t||"";if(this.hasPendingOperationWithCauseId(e,n)){const t=this._deferredOperationsWithCauseId[e][n],r=t.deferred.promise;return t.deferred.resolve(i),this._logger.info(`[${e}][${n}] resolved, result=${Ne(i)||"void"}`),delete this._deferredOperationsWithCauseId[e][n],r}return Promise.reject(`[${e}][${n}] resolveOperationWithCauseId failed, operation not found`)}rejectOperationWithCauseId(e,t,i){const n=t||"";if(this.hasPendingOperationWithCauseId(e,n)){const t=this._deferredOperationsWithCauseId[e][n],r=t.deferred.promise;return r.catch(yn),t.deferred.reject(i),this._logger.info(`[${e}][${n}] rejected, result=${Ne(i)||"void"}`),delete this._deferredOperationsWithCauseId[e][n],r}return Promise.reject(`[${e}][${n}] rejectOperationWithCauseId failed, operation not found`)}maybeResolveOperationWithCauseId(e,t,i){this.hasPendingOperationWithCauseId(e,t)?this.resolveOperationWithCauseId(e,t,i).catch((t=>{this._logger.info(`${e}maybeResolveOperationWithCauseId failed, reason=${Ne(t)}`)})):this._logger.info(`${e}maybeResolveOperationWithCauseId ignored, operation does not exist`)}maybeRejectOperationWithCauseId(e,t,i){this.hasPendingOperationWithCauseId(e,t)?this.rejectOperationWithCauseId(e,t,i).catch(yn):this._logger.info(`${e}maybeRejectOperationWithCauseId ignored, operation does not exist`)}getPendingOperation(e,t,i=Te()){return!t&&this._deferredOperations[e]?this._deferredOperations[e].deferred.promise:t&&this._deferredOperationsWithOperationId[e]&&this._deferredOperationsWithOperationId[e][t]?this._deferredOperationsWithOperationId[e][t].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(i,e,t)}: Deferred operation with given name and operation does not exist`)}waitForOperation(e,t,i=Te()){return t&&this.hasPendingOperationWithOperationId(e,t)?this._deferredOperationsWithOperationId[e][t].deferred.promise:this.hasPendingOperation(e)?this._deferredOperations[e].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(i,e,t)}failed=wait failed, operation not found`)}resolveOperation(e,t,i,n=Te(),r=!1){if(!e)return Promise.reject("Unable to resolve deferred operation with empty name");if(i&&this.hasPendingOperationWithOperationId(e,i)){const n=this._deferredOperationsWithOperationId[e][i],s=n.deferred.promise;return n.deferred.resolve(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}resolved, result=${Ne(t)||"void"}`),r||delete this._deferredOperationsWithOperationId[e][i],s}if(this.hasPendingOperation(e)){const n=this._deferredOperations[e],s=this._deferredOperations[e].deferred.promise;return this._deferredOperations[e].deferred.resolve(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}resolved, result=${Ne(t)||"void"}`),r||delete this._deferredOperations[e],s}return Promise.reject(`${this.getOperationInfoForLogging(n,e,i)}failed=resolve failed, operation not found`)}rejectOperation(e,t,i,n=Te()){if(!e)return Promise.reject("Unable to reject deferred operation with empty name");if(i&&this.hasPendingOperationWithOperationId(e,i)){const n=this._deferredOperationsWithOperationId[e][i],r=n.deferred.promise;return r.catch(yn),n.deferred.reject(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}rejected, reason=${Ne(t)||"void"}`),delete this._deferredOperationsWithOperationId[e][i],r}if(this.hasPendingOperation(e)){const n=this._deferredOperations[e],r=n.deferred.promise;return r.catch(yn),n.deferred.reject(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}rejected, reason=${Ne(t)||"void"}`),delete this._deferredOperations[e],r}return Promise.reject(`${this.getOperationInfoForLogging(n,e,i)}failed=reject failed, operation not found`)}maybeResolveOperation(e,t,i,n=Te()){const r=this.getOperationInfoForLogging(n,e,i);i&&this.hasPendingOperationWithOperationId(e,i)||this.hasPendingOperation(e)?this.resolveOperation(e,t,i,n).catch((e=>{this._logger.info(`${r}maybeResolveOperation failed, reason=${Ne(e)}`)})):this._logger.info(`${r}maybeResolveOperation ignored, operation does not exist`)}maybeResolveOperations(e,t,i,n=Te()){for(const r of e)this.maybeResolveOperation(r,t,i,n)}maybeRejectOperation(e,t,i,n=Te()){const r=this.getOperationInfoForLogging(n,e,i);i&&this.hasPendingOperationWithOperationId(e,i)||this.hasPendingOperation(e)?this.rejectOperation(e,t,i,n).catch(yn):this._logger.info(`${r}maybeRejectOperation ignored, operation does not exist`)}maybeRejectOperations(e,t,i,n=Te()){for(const r of e)this.maybeRejectOperation(r,t,i,n)}rejectPendingOperations(e,t=Te()){this._disposed=!0,this._logger.info(`[${t}]rejectPendingOperations=${JSON.stringify(e)}`),Object.keys(this._deferredOperations).forEach((i=>{this.maybeRejectOperation(i,e,void 0,t),this._deferredOperationsWithOperationId[t]&&delete this._deferredOperationsWithOperationId[t][""]})),Object.keys(this._deferredOperationsWithOperationId).forEach((i=>{Object.keys(this._deferredOperationsWithOperationId[i]).forEach((n=>{this.maybeRejectOperation(i,e,n,t),this._deferredOperationsWithOperationId[t]&&delete this._deferredOperationsWithOperationId[t][n]}))})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._endOperationDeferred.reject(e)}maybeRejectPendingOperationsWithPredicate(e,t=Te(),i){this._logger.info(`[${t}]rejectPendingOperationsWithPredicate`),Object.keys(this._deferredOperationsWithCauseId).forEach((t=>{Object.keys(this._deferredOperationsWithCauseId[t]).forEach((n=>{const r=this._deferredOperationsWithCauseId[t][n];r&&i(r.operationName,r.options)&&(this.maybeRejectOperation(r.operationName,e,n),this.maybeRejectOperationWithCauseId(t,n,e))}))}))}getOperationInfoForLogging(e,t,i=""){const n=i?`[${we(i)}]`:"";return`[${e.substring(0,8)}][${t}]${n}`}},xn=p,Un=class{constructor(e){this._logger=e,this._promise=Promise.resolve(void 0),this._actionQueue=[]}chainPromise(e,t,i=Te(),n=!1){const r=Date.now(),s=(("function"==typeof t?t():t)||"").toString();this._actionQueue.push(s),this._logger.info(`[${i}][${s}]enqueueing, queue=[${this._actionQueue}], reset=${n}`);const a=()=>{this._actionQueue=this._actionQueue.filter((e=>e!==s))};return n&&this.reset(i),this._promise=this._promise.catch(xn.noop).then((()=>{const t=Date.now()-r;return this._logger.info(`[${i}][${s}]begin, delayMs=${t}`),e()})),this._promise.then((()=>{a();const e=Date.now()-r;this._logger.info(`[${i}][${s}]success, durationMs=${e}`)}),(e=>{a();const t=Date.now()-r;this._logger.warn(`[${i}][${s}]failed=${Le(e)}, durationMs=${t}`)})),this._promise}reset(e){this._logger.info(`[${e}] resetting`),this._promise=Promise.resolve(void 0)}};function Fn(e){return!(!e||!e.code)}function Vn(e,t){let i;return i=Fn(e)?e:{code:499,subCode:void 0!==t?t:0,phrase:"string"==typeof e?e:Ne(e)},i}var Bn=class{constructor(){this.msElapsed=0,this.isPaused=!1,this._startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this._startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this._startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this._startTime,this.durationInMinutes=()=>{const e=this.duration()/6e4;return Math.ceil(e)},this.durationInSeconds=()=>{const e=this.duration()/1e3;return Math.ceil(e)}}get startTime(){return this._startTime}};function Hn(){return new Bn}var $n=class extends Ln{constructor(e,t,i,n,r){super(e),this.callTelemetry=t,this._ecsConfig=i,this._publishCallback=n,this._preconditionFunction=r,this._record={},this.logSuccess=(e,t,i)=>{this._logger.info(`${e} execution succeeded, result=${t?this.stringifyForLogging(t):"void"}, time=${i.duration()}`)},this.logFailure=(e,t,i)=>{this._logger.info(`${e} execution failed, reason=${this.stringifyForLogging(t)}, time=${i.duration()}`)},this.logTimeout=(e,t,i)=>{this._logger.info(`${e} execution timed out, reason=${this.stringifyForLogging(t)}, time=${i.duration()}`)},this.stringifyForLogging=e=>{let t;if(e instanceof Error)t=e.toString()||"Unknown Error";else try{t=JSON.stringify(e)}catch(e){t="Unable to stringify data"}return t},this.convertToTransactionEndIfErrorOrString=(e,t,i)=>{if(this._logger.info(`ecsEnableErrorConversion in operationHandler is: ${this._ecsConfig&&this._ecsConfig.enableErrorConversion}`),t&&this._ecsConfig&&this._ecsConfig.enableErrorConversion&&("string"==typeof e||e instanceof Error)){const t=Vn(e);return this._logger.info(`${i} Error converted from ${e} to ${Ne(t)}`),t}return e},this._logger=e.createChild("[Operation]"),this._chainedPromise=new Un(this._logger.createChild("[Chained]"))}resetOperationChain(e){this._chainedPromise.reset(e)}executeSync(e,t,i,n=Te(),r,s){const a=this.getOperationInfoForLogging(n,t,i),o=Hn();this._logger.info(`${a}API calledSync`);const c=this.callTelemetry.recordOperation(t,n,i,s);let l;try{this._setRecord(t),l=e(),c.recordSuccess(l,n),this.logSuccess(a,l,o)}catch(e){const t=this.convertToTransactionEndIfErrorOrString(e,r,a);c.recordFailure(t,n),this.logFailure(a,t,o)}return l}async executeChained(e,t,i,n=Te(),r,s,a){return this.checkPendingOperationAndExecute(e,!0,t,i,n,r,s,a)}async execute(e,t,i,n=Te(),r,s,a){return this.checkPendingOperationAndExecute(e,!1,t,i,n,r,s,a)}logOperation(e,t,...i){const n=i.length&&i.map((e=>this.stringifyForLogging(we(e))));this._logger.info(`[${e.substring(0,8)}][${t}]API called, ${n?`with args=${n}`:""}`)}rejectPendingOperations(e,t=Te(),i){if(i){for(const e of Object.keys(this._deferredOperations))this.callTelemetry.maybeRecordOperationFailure(e,i,void 0,t);for(const e of Object.keys(this._deferredOperationsWithOperationId))for(const n of Object.keys(this._deferredOperationsWithOperationId[e]))this.callTelemetry.maybeRecordOperationFailure(e,i,n,t)}super.rejectPendingOperations(e,t)}maybeRejectOperations(e,t,i,n=Te(),r){if(r)for(const t of e)this.callTelemetry.maybeRecordOperationFailure(t,r,void 0,n);super.maybeRejectOperations(e,t,i,n)}checkPendingOperationAndExecute(e,t,i,n,r=Te(),s,a,o){const c=this.getOperationInfoForLogging(r,i,n);let l=null,d=null;return this.hasPendingOperationWithOperationId(i,n)||this.hasPendingOperation(i)?(this._logger.info(`${c}already pending, returning existing operation`),l=this.waitForOperation(i,n,r)):d=this.createPendingOperation(i,n,r,o),t?(this._logger.info(`${c}chained`),this._chainedPromise.chainPromise((()=>l||this.executeInternal(d,r,e,i,n,s,a,o)),i,r)):l||this.executeInternal(d,r,e,i,n,s,a,o)}_setRecord(e){this._record.hasOwnProperty(e)||(this._record[e]=0),this._record[e]+=1}getRecord(e){return this._record[e]}_recordTelemetryTimeoutAndPublish(e,t,i,n,r,s,a){const o=e||60;return window.setTimeout((()=>{if(!this._publishCallback)return void this._logger.warn(`${r} is marked to publish telemetry but no publish callback is defined.`);if(!this.hasPendingOperationWithOperationId(n,a)&&!this.hasPendingOperation(n))return;const e=new Error(`${r} execution did not complete before telemetry timeout of ${o}s.`);this.logTimeout(r,e,s),this.callTelemetry.maybeRecordOperationTimeout(n,e,a,i),this._publishCallback(t),this.callTelemetry.removeRecordedEvent(t)}),1e3*o)}_instantTelemetryPublish(e,t){this._publishCallback?(this._publishCallback(t),this.callTelemetry.removeRecordedEvent(t)):this._logger.warn(`${e} is marked to publish telemetry but no publish callback is defined.`)}parseInstantTelemetryParameters(e){let t,i=!1;return e&&(i=e.enableInstantTelemetry,t=e.telemetryTimeout),[i,t]}async executeInternal(e,t,i,n,r,s,a,o){const c=this.getOperationInfoForLogging(t,n,r);this._logger.info(`${c} executing operation...`);const l=Hn(),d=this.callTelemetry.recordOperation(n,t,r,a),[h,u]=this.parseInstantTelemetryParameters(o);try{let e;this._setRecord(n),h&&(e=this._recordTelemetryTimeoutAndPublish(u,d,t,n,c,l,r)),o?.preconditionTags?.length&&this._preconditionFunction&&this._preconditionFunction(n,o.preconditionTags);const s=await i();e&&clearTimeout(e),this.callTelemetry.maybeRecordOperationSuccess(n,s,r),this.logSuccess(c,s,l),this.maybeResolveOperation(n,s,r,t)}catch(e){const i=this.convertToTransactionEndIfErrorOrString(e,s,c);this.callTelemetry.maybeRecordOperationFailure(n,i,r),this.logFailure(c,i,l),this.maybeRejectOperation(n,i,r,t)}return h&&this._instantTelemetryPublish(c,d),e}getEcsConfig(){return this._ecsConfig}},Gn={Cancel:487,Reject:603,NoNgcEndpoint:480,Forbidden:403,PreconditionFailed:412,Success:0,CallRedirected:302,BadRequest:400,NotFound:404,NotAcceptable:406,Timeout:408,Conflict:409,MediaError:410,ConfParticipantCountLimitReached:413,CallAccepted:450,CallForwarded:451,CallForwardedToVoicemail:452,P2pRejectCall:453,P2pFallbackForScreensharing:460,P2pFallbackDueToGroupCall:461,CallLegEndedOnService:470,CallDoesNotExist:481,NotAcceptableHere:488,NetworkError:490,GlareError:491,SkypeTokenError:495,LocalHttpStackError:496,UnknownError:497,LocalError:498,InternalServerError:500,CallModalityFailure:580,ServiceUnavailable:503},jn={Success:0,CallRedirectedSuccess:3020,InsufficientCapabilities:5204,PolicyRestriction:5448,UserBlocked:10005,MaxLobbyParticipantLimitReached:5807,MaxParticipantLimitReached:5808,MaxParticipantLimitReached2:5817,SharingStolenError:10029,DowngradeToStreamingClient:3099,MediaDropDuringConnect:3100,MediaDropAfterConnect:3101,MediaAnswerProcessingError:3102,MediaFinalAnswerProcessingError:3103,MediaOfferTimeout:3104,MediaFinalAnswerTimeout:3105,MediaOfferNull:3106,MediaAudioDeviceError:3107,MediaRenegotiationError:3108,MediaPermissionError:3109,MediaUnknownError:3110,MediaOfferProcessingError:3111,MediaWhiteListingIssue:3112,MediaMuteMicrophoneError:3113,MediaMuteSpeakerError:3114,MediaUnmuteMicrophoneError:3115,MediaUnmuteSpeakerError:3115,AttachActionFailed:4103,AttachFailed:4105,PreheatedCallTimedout:4113,RemovedFromConversation:5e3,DeniedInLobby:5854,RemovedFromCall:5300,TimedOutInLobby:5855,AnonymousJoinDisabledByPolicy:5723,B2bJoinDisabledByPolicy:5724,NoLobbyForBroadcastJoin:5354,NotAllowedDueToInformationBarrier:5810,TeamParkPolicyDisabled:10193,BroadcastLimitReached:800100,Suspended:58e4},qn={[Gn.Success]:1,[Gn.Cancel]:12,[Gn.Reject]:10,[Gn.NoNgcEndpoint]:2,[Gn.Timeout]:6,[Gn.CallAccepted]:30,[Gn.CallRedirected]:75,[Gn.NotFound]:24,[Gn.CallDoesNotExist]:46,[Gn.NotAcceptable]:5,[Gn.BadRequest]:5,[Gn.MediaError]:4,[Gn.ConfParticipantCountLimitReached]:59,[Gn.CallModalityFailure]:4,[Gn.NetworkError]:3,[Gn.LocalHttpStackError]:31,[Gn.LocalError]:25,[Gn.CallForwarded]:27,[Gn.CallForwardedToVoicemail]:28,[Gn.SkypeTokenError]:29,[Gn.InternalServerError]:7,[Gn.Conflict]:7,[Gn.GlareError]:7,[Gn.CallLegEndedOnService]:7,[Gn.NotAcceptableHere]:26,[Gn.UnknownError]:32,[Gn.Forbidden]:8,[Gn.PreconditionFailed]:65},Wn={9401:33,9422:33,6102:1,6423:14,9402:14,9432:14,6519:3,9403:15,9410:36,9411:37,1e3:2,9407:17,13430:18,6009:19,10484:19,10604:19,10404:19,10420:19,10403:20,17401:20,10408:9,10486:11,10600:11,10686:11,10487:21,10500:3,10501:3,10502:3,10503:3,10504:3,10480:22,10482:22,10603:10,13406:23,13416:23},zn={500:39,403:41,404:42,480:40},Jn={INCOMING_SKYPE_NGC_CALL:107,INCOMING_SKYPE_NGC_GVC_CALL:109,INCOMING_PSTN_NGC_CALL:111,INCOMING_SCREENSHARE_WITH_CHAT:119,INCOMING_TFL_TFW_CALL:126},Kn={SHARED_LINE_CALL_RECORD:121,SHARED_LINE_V2_CALL_RECORD:123,MEETING_STARTED_NOTIFICATION:128},Yn={LOG_UPLOAD_EVENT:120},Qn="CallEndReasonUnknown",Xn="CallEndReasonMediaError",Zn="CallEndReasonMediaPermissionError",er="CallEndReasonMediaDropDuringConnectError",tr="CallEndReasonMediaDropAfterConnectError",ir="CallEndReasonMediaOfferProcessingError",nr="DowngradeToStreamingClient",rr="CallEndReasonIncompatibleOffer",sr="MediaWhitelistingIssue",ar="CallEndReasonAttachFailed",or="CallEndReasonBadNotificationPayload",cr="RetargetNotSupported",lr="CallEndReasonLocalUserInitiated",dr="EndedByRemoteEndpoint",hr="CallEndReasonRedirected",ur="CallEndReasonVDIdisconnect",gr="CallEndReasonSuspended",pr=(e=>(e.GetSignalingMediaTypes="GetSignalingMediaTypes",e.CallStart="CallStart",e.WaitForAnswer="WaitForAnswer",e.WaitForConnect="WaitForConnect",e.Accept="Accept",e))(pr||{}),mr=(e=>(e.InitializeMediaSession="InitializeMediaSession",e.UpdateMediaModalities="UpdateMediaModalities",e.CreateOffer="CreateOffer",e.CreateAnswer="CreateAnswer",e.ProcessAnswer="ProcessAnswer",e.GetSignalingMediaTypes="GetSignalingMediaTypes",e.MuteUnmute="MuteUnmute",e.MuteUnmuteSpeakers="MuteUnmuteSpeakers",e.StartVideoSafe="StartVideoSafe",e.CompleteNegotiation="CompleteNegotiation",e.MuteInput="MuteInput",e.MuteOutput="MuteOutput",e.UnmuteInput="UnmuteInput",e.UnmuteOutput="UnmuteOutput",e.evaluateEndpointStatesForAccept="evaluateEndpointStatesForAccept",e.handleEndpointStatesForAccept="handleEndpointStatesForAccept",e))(mr||{}),fr=(e=>(e.InitializeMediaSession="InitializeMediaSession",e.ProcessOffer="ProcessOffer",e.ProcessOfferedModalities="ProcessOfferedModalities",e.TrySendingProvisionalAnswer="TrySendingProvisionalAnswer",e))(fr||{}),Sr=p,vr=f(p),yr=f(p),Cr=f(le()),_r="Success",Er="ExpectedError",Tr="UnexpectedClientError",Ir="UnexpectedServerError",br={INCOMING_MESSAGE_ORIGIN:{TROUTER:"Trouter",BROKER:"Broker"},INVITATION_TYPE:{NUDGE:"nudge"},KNOWN_PAYLOAD_ENCODINGS:{GZIP:!0},WEBRTC_NOTIFICATION_TYPE:{CONTROL_VIDEO_STREAMING:"ControlVideoStreaming",DOMINANT_SPEAKER_INFO:"DominantSpeakerInfo",CSRC_INFO:"CsrcInfo"},PARTICIPANT_AUDIO_STATE:{CONNECTING:"Connecting",RINGING:"Ringing",CONNECTED:"Connected",OTHER:"Other"},HEADERS:{MESSAGE_ID:"X-Microsoft-Skype-Message-ID",ORIGINAL_MESSAGE_ID:"X-Microsoft-Skype-Original-Message-ID",CONTENT_ENCODING:"X-Microsoft-Skype-Content-Encoding",CORRELATION_ID:"X-Microsoft-Skype-Chain-ID",CONTENT_SHARING_CORRELATION_ID:"X-Microsoft-Skype-ContentSharing-Chain-ID",CLIENT_USER_AGENT:"X-Microsoft-Skype-Client",SKYPE_TOKEN:"X-Skypetoken",AUTHORIZATION:"Authorization",BEARER_KEYWORD:"Bearer",AAD_KEYWORD:"Aad",CAE_KEYWORD:"Cae",SKYPE_KEYWORD:"Skype",CACHE_SKYPE_TOKEN:"X-CacheSkypeToken",AUTHENTICATE:"www-authenticate",TOKEN_MIGRATION:"X-MS-Migration",BROKER_USE_BATCHING_HEADER_NAME:"X-UseBatching",PARTICIPANT_ID:"X-Microsoft-Skype-Participant-ID",CONTENT_TYPE:"Content-Type",RING:"MS-Teams-Ring",REGION:"MS-Teams-Region",PARTITION:"MS-Teams-Partition"},KNOWN_BOTS:{VOICEMAIL_BOT_ID:"28:14524421-25b4-403a-a0f7-e62d4379cabc"},HTTP_STACK_ERROR:{NONE:0,CANNOT_CONNECT:7,REQUEST_TIMEOUT:10,ATTEMPT_TIMEOUT:30,REQUEST_ABORTED:16,ATTEMPT_ABORTED:31,ABORTED_OTHER_ATTEMPT_SUCCESSFUL:32},HTTP_STATUS_CODES:{UNKNOWN:0,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404,FORBIDDEN:403,PRECONDITION_FAILED:412,UNPROCESSABLE_ENTITY:422,NETWORK_ERROR:490,SKYPE_TOKEN_ERROR:495,OFFLINE:496,TIMEOUT:498,ABORTED:498,OTHER:499,INTERNAL_SERVER_ERROR:500,CONFLICT:409,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504},CALL_END_SKYPE_TOKEN_ERROR:{code:495,subCode:4507,phrase:"CallEndReasonSkypeTokenFetchError",resultCategories:[Tr]},CALL_END_TOKEN_TIMEOUT_ERROR:{code:499,subCode:3119,phrase:"CallEndReasonTokenFetchTimeout",resultCategories:[Tr]},CALL_END_UNSUPPORTED_TOKEN_ERROR:{code:499,subCode:3126,phrase:"CallEndReasonUnsupportedTokenError",resultCategories:[Tr]},CALL_END_TOKEN_ERROR:{code:499,subCode:3127,phrase:"CallEndReasonTokenFetchError",resultCategories:[Tr]},CALL_END_LOCAL_HTTP_STACK_ERROR:{code:496,subCode:4520,phrase:"LocalHTTPStackError",resultCategories:[Tr]},CALL_END_UNKNOWN_ERROR:{code:497,subCode:3121,phrase:"CallEndReasonUnknownError",resultCategories:[Tr]},CALL_END_NETWORK_ERROR:{code:490,subCode:4502,phrase:"CallEndReasonNetworkError",resultCategories:[Tr]},CALL_END_LOCAL_DECLINE:{code:486,subCode:4508,phrase:"LocalDecline",resultCategories:[_r]},RESOURCE_NOT_FOUND_ERROR:{code:404,subCode:404,phrase:"ResourceNotFound",resultCategories:[Er]},CALL_STATUS:{IDLE:"Idle",RINGING:"Ringing",CONNECTING:"Connecting",CONNECTED:"Connected",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly",LOCAL_TERMINATED:"LocalTerminated",REMOTE_TERMINATED:"RemoteTerminated"},MEDIA_TYPES:{AUDIO:"Audio",VIDEO:"Video",SCREEN_SHARER:"ScreenSharer",SCREEN_VIEWER:"ScreenViewer"},MUTE_SCOPE:{MYSELF:"Myself",EVERYONE_ELSE:"EveryoneElse",SPECIFIED_PARTICIPANTS:"SpecifiedParticipants"},URL_BASE:{CALLAGENT:"callAgent"},LINKS:{HANGUP:"hangup",MEDIA_REJECTION:"mediaRejection",MEDIA_ANSWER:"mediaAnswer",MEDIA_RENEGOTIATION:"mediaRenegotiation",ACCEPT:"accept",ATTACH:"attach",REJECT:"reject",REDIRECT:"redirect",REPLACE:"replace",TRANSFER:"transfer",NEW_OFFER:"newOffer",TRANSFER_ACCEPTANCE:"transferAcceptance",TRANSFER_COMPLETION:"transferCompletion",CONVERSATION_CONTROLLER:"conversationController",ADD_PARTICIPANT:"addParticipant",ADD_PARTICIPANTS_AND_MODALITY:"addParticipantsAndModality",LEAVE:"leave",NOTIFICATION_LINKS:"notificationLinks",REMOVE_PARTICIPANT:"removeParticipant",KEEPALIVE:"keepAlive",ADD_MODALITY:"AddModality",REMOVE_MODALITY:"RemoveModality",CONTENT_SHARING_CONTROLLER:"contentSharingController",CONTENT_SHARING_TAKE_CONTROL:"contentSharingTakeControl",CONTENT_SHARING_UPDATE_SESSION_STATE:"contentSharingUpdateSessionState",CONTENT_SHARING_UPDATE_PARTICIPANT_STATE:"contentSharingUpdateParticipantState",CONTENT_SHARING_NOTIFICATION_LINKS:"contentSharingNotificationLinks",CONTENT_SHARING_LEAVE:"contentSharingLeave",MUTE:"mute",UNMUTE:"unmute",ADMIT:"admit",ADMIT_ALL:"admitAll",CONTROL_VIDEO_STREAMING:"controlVideoStreaming",APPLY_CHANNEL_PARAMETERS:"applyChannelParameters",UPDATE_ENDPOINT_STATE:"updateEndpointState",UPDATE_ENDPOINT_METADATA:"updateEndpointMetadata",LMC_NOTIFICATION_LINKS:"lmcNotificationLinks",UPDATE_PARTICIPANT_ROLE:"updateParticipantRole",PUBLISH_STATE:"publishState",REMOVE_STATE:"removeState",UPDATE_MEETING_SETTINGS:"updateMeetingSettings",SEARCH_PARTICIPANTS:"searchParticipants",GET_ALL_PARTICIPANTS:"getAllParticipants",PARK:"park",UNPARK:"unpark",UPDATE_MEETING_LIVE_STATE:"updateMeetingLiveState",UPDATE_MEETING_GROUPS:"updateMeetingGroups",SET_MEETING_LAYOUT:"setMeetingLayout",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"updateParticipantInterpretationState",JOIN_MEETING_GROUP:"joinMeetingGroup",LEAVE_MEETING_GROUP:"leaveMeetingGroup",SEND_MESSAGE:"sendMessage",UPDATE_PARTICIPANTS_PROPERTIES:"updateParticipantsProperties",UPDATE_MEDIA_DESCRIPTIONS:"updateMediaDescriptions",UPDATE_MEETING_STATES:"updateMeetingStates"},CONTENT_TYPE:{JSON:"application/json",SDP:"application/sdp"},TROUTER_EVENT_TYPE:{SKYPE_SKYPE_CALL:107,LYNC_SKYPE_CALL:105},MISC:{CONVERSATION:"conversation",LOBBY_CALL_CONTROLLER:"lobby",LOBBY_PARTICIPANT_STATE:"lobby"},SIGNALING_FSM_STATE:{IDLE:"Idle",INCOMING:"Incoming",WAITING_CALL_ACCEPTANCE_ACK:"WaitingCallAcceptanceAck",OUTGOING:"Outgoing",CONNECTED:"Connected",OUTGOING_FOR_ROSTER_ONLY:"OutgoingForRosterOnly",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly"},MEDIA_RENEGOTIATION_FSM_STATE:{IDLE:"Idle",CALL_CONNECTED:"Connected",INCOMING_RENEGOTIATION:"IncomingRenegotiation",OUTGOING_RENEGOTIATION:"OutgoingRenegotiation",RENEGOTIATION_GLARE:"RenegotiationGlare"},CONTENT_SHARING_FSM_STATE:{IDLE:"Idle",CONTENT_SHARING_START_INITIATED:"ContentSharingStartInitiated",CONTENT_SHARING_JOIN_INITIATED:"ContentSharingJoinInitiated",CONTENT_SHARING_LEAVE_INITIATED:"ContentSharingLeaveInitiated",CONTENT_SHARING_DELETE_INITIATED:"ContentSharingDeleteInitiated",CONTENT_SHARING_CONNECTED:"ContentSharingConnected"},TIMEOUT_OPERATIONS:{ADD_PARTICIPANT:"AddParticipant",NUDGE_PARTICIPANT:"NudgeParticipant",REMOVE_PARTICIPANT:"RemoveParticipant",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT:"Admit",CALL_REDIRECT:"CallRedirect",CALL_ME_BACK:"CallMeBack",INCOMING_CALL_ESTABLISHMENT:"IncomingCallEstablishment",OUTGOING_CALL_ESTABLISHMENT:"OutgoingCallEstablishment",MEDIA_ANSWER:"MediaAnswer",MEDIA_ANSWER_ACKNOWLEDGEMENT:"MediaAnswerAcknowledgement",ADD_MODALITY:"AddModality",UNMUTE:"Unmute",UPDATE_MEETING_ROLE:"UpdateMeetingRole",MAX_PREAHEATED_TIMEOUT:"MaxPreheateadTimeout",PARK_COMPLETION:"ParkCompletion",UNPARK_COMPLETION:"UnparkCompletion",UPDATE_MEETING_LIVE_STATE_COMPLETION:"UpdateMeetingLiveStateCompletion",UPDATE_MEETING_GROUPS_COMPLETION:"UpgradeMeetingGroupsCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"UpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"UpdateParticipantsPropertiesCompletion",JOIN_MEETING_GROUP_COMPLETION:"JoinMeetingGroupCompletion",LEAVE_MEETING_GROUP_COMPLETION:"LeaveMeetingGroupCompletion",SET_MEETING_LAYOUT_COMPLETION:"SetMeetingLayoutCompletion",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",DISABLE_PREHEAT_ASYNC_TIMEOUT:"DisablePreheatAsyncTimeout",UPDATE_MEETING_STATES_COMPLETION:"UpdateMeetingStatesCompletion"},TIMEOUT_VALUES_IN_SECONDS:{ADD_PARTICIPANT_TIMEOUT:130,REMOVE_PARTICIPANT_TIMEOUT:60,INCOMING_CALL_ESTABLISHMENT_TIMEOUT:75,OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:90,LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:185,MEDIA_ANSWER_TIMEOUT:35,MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT:15,ADD_MODALITY_TIMEOUT:65,UNMUTE_TIMEOUT:35,ADMIT_PARTICIPANT_TIMEOUT:120,ADMIT_TIMEOUT:60,UPDATE_MEETING_ROLE_TIMEOUT:15,NUDGE_PARTICIPANT_TIMEOUT:60,CALL_ME_BACK_TIMEOUT:120,MAX_PREAHEATED_TIMEOUT:90,PARK_COMPLETION_TIMEOUT:45,UNPARK_COMPLETION_TIMEOUT:45,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:45,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:45,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT:45,JOIN_MEETING_GROUP_COMPLETION_TIMEOUT:45,LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT:45,CONVERSATION_KEEP_ALIVE_TIMEOUT:2700,TOKEN_REQUIRED_TIMEOUT:20,SEND_MESSAGE_COMPLETION_TIMEOUT:15,DISABLE_PREHEAT_TIMEOUT:45,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:45},CALL_END_CODE:{REJECT:603,SUCCESS:0,CALL_REDIRECTED:302,CANCEL:487,TIMEOUT:408,SERVICE_UNAVAILABLE:500,BAD_REQUEST:406,NO_NGC_ENDPOINT:480,P2P_FALLBACK_FOR_SCREENSHARING:460,CONFLICT:409,MEDIA_ERROR:410,CONF_PARTICIPANT_COUNT_LIMIT_REACHED:413,CALL_DOES_NOT_EXIST:481,CALL_ACCEPTED:450,CALL_FORWARDED:451,CALL_FORWARDED_TO_VOICEMAIL:452,P2P_REJECT_CALL:453,P2P_FALLBACK_DUE_TO_GROUPCALL:461,CALL_LEG_ENDED_ON_SERVICE:470,NOT_ACCEPTABLE_HERE:488,NETWORK_ERROR:490,UNKNOWN_ERROR:497,LOCAL_ERROR:498,CALL_MODALITY_FAILURE:580,ATC_CONTROLLER_FAILURE:581,CVA_CONTROLLER_FAILURE:586,GLARE_ERROR:491,NOT_FOUND:404,SKYPE_TOKEN_ERROR:495,LOCAL_HTTP_STACK_ERROR:496,HTTP_OTHER_ERROR:499,DECODING_FAILED:407,NOT_AUTHORIZED:403,BAD_SERVICE_RESPONSE:400},CALL_END_SUB_CODE:{SUCCESS:0,CALL_REDIRECTED_SUCCESS:3020,DOWNGRADE_TO_STREAMING_CLIENT:3099,MEDIA_DROP_DURING_CONNECT:3100,MEDIA_DROP_AFTER_CONNECT:3101,MEDIA_ANSWER_PROCESSING_ERROR:3102,MEDIA_FINAL_ANSWER_PROCESSING_ERROR:3103,MEDIA_OFFER_TIMEOUT:3104,MEDIA_FINAL_ANSWER_TIMEOUT:3105,MEDIA_OFFER_NULL:3106,MEDIA_AUDIO_DEVICE_ERROR:3107,MEDIA_RENEGOTIATION_ERROR:3108,MEDIA_PERMISSION_ERROR:3109,MEDIA_UNKNOWN_ERROR:3110,MEDIA_OFFER_PROCESSING_ERROR:3111,MEDIA_WHITELISTING_ISSUE:3112,MEDIA_MUTE_MICROPHONE_ERROR:3114,MEDIA_MUTE_SPEAKER_ERROR:3115,MEDIA_UNMUTE_MICROPHONE_ERROR:3116,MEDIA_UNMUTE_SPEAKER_ERROR:3117,MEDIA_GLARE_ERROR:3118,CONVERSATION_TERMINATION_UNKNOWN_ERROR:3121,CONVERSATION_NOTIFICATION_TIMEOUT:3125,CALL_NOT_ATTEMPTED:4500,CONV_URL_NOT_SET:4501,FAILED_TO_REACH_SERVICE:4502,PLACE_CALL_FAILED:4503,ATTACH_CALL_FAILED:4504,BAD_NOTIFICATION_PAYLOAD:4505,CALL_ESTABLISHMENT_TIMEOUT:4506,SKYPE_TOKEN_ERROR:4507,CONVERSATION_RESOLUTION_CONFLICT:5704,CALL_PARTICIPANT_REMOVAL_TIMEOUT:4507,UNMUTE_REQUEST_TIMEOUT:4509,UNMUTE_REQUEST_REJECTED:4510,CONFLICT_IN_NG:4090,CONFLICT_WITH_P2P:4091,CONVERSATION_END_RECEIVED_FROM_SERVICE:4100,TRANSFER_COMPLETE_TIMEOUT:4101,ATTACH_TO_NON_EXISTENT_CALL:4102,ATTACH_ACTION_FAILED:4103,ATTACH_FAILED:4105,CONVERSATION_ESTABLISHMENT_FAILED:4106,BEFORE_CONNECT:4107,AFTER_CONNECT:4108,AFTER_ACCEPT:4109,TROUTER_CONNECTION_DROPPED:4111,DUE_TO_CALL_ASSIMILATION:4112,PREHEATED_CALL_TIMEDOUT:4113,UNPARK_COMPLETION_TIMEOUT:4114,PARK_COMPLETION_TIMEOUT:4115,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:4116,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:4117,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:4118,UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:4119,JOIN_MEETING_GROUP_TIMEOUT:4120,LEAVE_MEETING_GROUP_TIMEOUT:4121,UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:4122,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:4123,MISSING_REQUEST_URI:4511,LOCAL_HTTP_STACK_ERROR:4520,BEACON:4521,CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:5014,UNABLE_TO_GENERATE_MEETUP_ID:5015,UPDATE_MEETING_ROLE_REJECTED:5651,UPDATE_MEETING_ROLE_TIMEOUT:5652,PUBLISH_STATE_LINK_MISSING:5653,PUBLISH_STATE_INVALID_CONTENT:5654,PUBLISH_STATE_INVALID_SERVICE_RESPONSE:5655,REMOVE_STATE_LINK_MISSING:5656,REMOVE_STATE_MISSING_ARGUMENTS:5657,UPDATE_MEETING_SETTINGS_LINK_MISSING:5658,UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS:5659,ADMIT_ALL_LINK_MISSING:5660,ADMIT_TIMEOUT:5661,CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE:5670,ROSTER_HANDLING_INVALID_SERVICE_RESPONSE:5671,SEARCH_PARTICIPANTS_LINK_MISSING:5672,SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5673,GET_ALL_PARTICIPANTS_LINK_MISSING:5674,GET_ALL_PARTICIPANTS_INVALID_SCOPE:5675,GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5676,PARK_UNPARK_TYPE_MISSING:5680,PARK_UNPARK_V2_DISABLED:5682,UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING:5683,DISABLE_PREHEAT_TIMEOUT:5684,CALL_ENDED_BY_PLATFORM_AGENT:7e3},CALL_END_PHRASE:{UNKNOWN:"CallEndReasonUnknown",MEDIA_ERROR:"CallEndReasonMediaError",MEDIA_OFFER_TIMEOUT:"CallEndReasonMediaOfferTimeout",MEDIA_FINAL_ANSWER_TIMEOUT:"CallEndReasonMediaFinalAnswerTimeout",MEDIA_ANSWER_ERROR:"CallEndReasonMediaAnswerError",MEDIA_FINAL_ANSWER_ERROR:"CallEndReasonFinalAnswerError",MEDIA_PERMISSION_ERROR:"CallEndReasonMediaPermissionError",MEDIA_RENEGOTIATION_ERROR:"CallEndReasonRenegotiationError",MEDIA_DROP_DURING_CONNECT:"CallEndReasonMediaDropDuringConnectError",MEDIA_DROP_AFTER_CONNECT:"CallEndReasonMediaDropAfterConnectError",MEDIA_OFFER_PROCESSING_ERROR:"CallEndReasonMediaOfferProcessingError",MEDIA_WHITELISTING_ISSUE:"MediaWhitelistingIssue",AUDIO_ERROR:"CallEndReasonAudioDeviceError",CONVERSATION_NOTIFICATION_TIMEOUT:"ConversationNotificationTimeout",BAD_NOTIFICATION_PAYLOAD:"BadCallNotificationPayload",NETWORK_ERROR:"CallEndReasonNetworkError",LOCAL_USER_INITIATED:"CallEndReasonLocalUserInitiated",REMOTE_USER_INITIATED:"CallEndReasonRemoteUserInitiated",ESTABLISHMENT_TIMEOUT:"CallEndReasonEstablishmentTimeout",PARTICIPANT_REMOVAL_TIMEOUT:"CallParticipantRemovalTimeout",LOCAL_ERROR:"CallEndReasonLocalError",CALL_UPDATE_ERROR:"CallEndReasonCallUpdateError",CALL_REDIRECT_IS_NOT_ALLOWED:"CallRedirectisNotAllowed",P2P_FORK_CONNECTED:"CallEndReasonP2pForkConnected",P2P_FORK_FORWARDED:"CallEndReasonP2pForkForwarded",P2P_FORK_FORWARDED_TO_VOICEMAIL:"CallEndReasonP2pForkForwardedToVoiceMail",P2P_FALLBACK_FOR_SCREENSHARING:"CallEndReasonP2pFallbackForScreensharing",P2P_FALLBACK_FOR_GROUPCALL:"CallEndReasonP2pFallbackForGroupCall",P2P_FALLBACK_FOR_CALL_ASSIMILATION:"CallEndReasonP2pFallbackForCallAssimilation",P2P_FALLBACK_FOR_TRANSLATION:"CallEndReasonP2pFallbackForCallTranslation",P2P_FORK_REJECTED:"CallEndReasonP2pForkRejected",TROUTER_CONNECTION_DROPPED:"CallEndReasonTrouterConnectionDropped",REMOVED_FROM_CALL:"CallEndReasonRemovedFromCall",TRANSFER_COMPLETION_TIMEOUT:"CallEndReasonTransferCompletionTimeout",CALL_DOES_NOT_EXIST:"CallEndReasonCallDoesNotExist",ATTACH_ACTION_FAILED:"CallEndReasonAttachActionFailed",ATTACH_FAILED:"CallEndReasonAttachFailed",CONVERSATION_ESTABLISHMENT_FAILED:"CallEndReasonConversationEstablishmentFailed",CONV_END_FROM_SERVICE:"CallEndReasonConversationEndReceivedFromService",CONV_END_FROM_SERVICE_WITH_ERROR:"CallEndReasonConversationEndReceivedFromServiceWithError",SERVICE_ERROR:"CallEndReasonServiceError",CONFLICT:"CallEndReasonConflict",CALL_ALREADY_IN_P2P:"CallEndReasonCallAlreadyExistsInP2p",CONV_END_NO_MODALITY:"ConversationEndNoModalityConnected",CONV_END_FOR_ALL_INITIATED:"ConversationEndForAllInitiated",RENEGOTIATION_IN_PROGRESS:"NegotiationIsInProgress",ADD_PARTICIPANT_URL_MISSING:"AddParticipantUrlMissing",ADMIT_PARTICIPANT_URL_MISSING:"AdmitParticipantUrlMissing",ADMIT_ALL_URL_MISSING:"AdmitAllUrlMissing",UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING:"UpdateParticipantInterpretationStateUrlMissing",UPDATE_PARTICIPANTS_PROPERTIES_URL_MISSING:"UpdateParticipantsPropertiesUrlMissing",ADMIT_TIMEOUT:"AdmitTimeout",UNABLE_TO_GENERATE_MEETUP_ID:"Unable to generate GroupChat meetup id.",ENDED_BY_PMA:"Call ended by media agent.",OWNERSHIP_RESOLUTION_CONFLICT:"Conversation cannot be created due to a failure to resolve ownership.",CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:"This conversation has ended since we were unable to determine a potential host for the group call.",UNMUTE_REQUEST_TIMEOUT:"UnmuteRequestTimeout",UNMUTE_REQUEST_REJECTED:"UnmuteRequestRejected",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",UPDATE_MEETING_ROLE_REJECTED:"Update meeting role operation failed due to insufficient privileges.",PARK_REQUEST_FAILED:"Park Request Failed",PARK_COMPLETION_TIMEOUT:"ParkCompletionTimeout",PARK_COMPLETION_FAILED:"ParkCompletionFailed",UNPARK_REQUEST_FAILED:"UnparkFailed",UNPARK_COMPLETION_TIMEOUT:"UnparkCompletionTimeout",UNPARK_COMPLETION_FAILED:"UnparkCompletionFailed",BAD_SERVICE_RESPONSE:"BadServiceResponse",UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:"UpdateMeetingLiveStateCompletionTimeout",UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:"UpdateMeetingGroupsCompletionTimeout",SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:"SetMeetingLayoutCompletionTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationTimeout",JOIN_MEETING_GROUP_TIMEOUT:"JoinMeetingGroupTimeout",LEAVE_MEETING_GROUP_TIMEOUT:"LeaveMeetingGroupTimeout",DOWNGRADE_TO_STREAMING_CLIENT:"DowngradeToStreamingClient",MESSAGE_STATUS_WITH_FAILURE_COUNT:"NotZeroFailureCount",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",DISABLE_PREHEAT_TIMEOUT:"DisablePreheatTimeout",UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:"UpdateMeetingStatesCompletionTimeout"},TRANSACTION_END_CODE:{SUCCESS:0},URL_DEFAULTS:{UPLOAD_LOG_URL:"https://api.cc.skype.com/cc/v1/uploadlog/"},SUCCESS_TRANSACTION_END:{code:0,resultCategories:[_r]},VALIDATION:{VALIDATION_FAILED:6e3,NULL_OR_EMPTY:6001}},Ar={REQUEST_TIMEOUT:{status:br.HTTP_STATUS_CODES.TIMEOUT,statusText:"Request timed out",readyState:0,response:br.HTTP_STACK_ERROR.REQUEST_TIMEOUT},ATTEMPT_TIMEOUT:{status:br.HTTP_STATUS_CODES.TIMEOUT,statusText:"Attempt timed out",readyState:0,response:br.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT},REQUEST_ABORTED:{status:br.HTTP_STATUS_CODES.ABORTED,statusText:"Request Aborted",readyState:0,response:br.HTTP_STACK_ERROR.REQUEST_ABORTED},ATTEMPT_ABORTED:{status:br.HTTP_STATUS_CODES.ABORTED,statusText:"Attempt Aborted",readyState:0,response:br.HTTP_STACK_ERROR.ATTEMPT_ABORTED}},Rr={MEDIA_ACKNOWLEDGEMENT:"/call/mediaAcknowledgement/",MEDIA_REJECTION:"/call/rejection/",ACKNOWLEDGEMENT:"/call/acknowledgement/",MEDIA_RENEGOTIATION:"/call/mediaRenegotiation/",REPLACE:"/call/replacement/",PROGRESS:"/call/progress/",MEDIA_ANSWER:"/call/mediaAnswer/",NEW_MEDIA_OFFER:"/call/newMediaOffer/",REDIRECTION:"/call/redirection/",BALANCE_UPDATE:"/call/balanceUpdate/",ACCEPT:"/call/acceptance/",CONTROL_VIDEO_STREAMING:"/call/controlVideoStreaming/",DOMINANT_SPEAKER_INFO:"/call/dominantSpeakerInfo/",CSRC_INFO:"/call/csrcInfo/",END:"/call/end/",RETARGET_COMPLETION:"/call/retargetCompletion/",TRANSFER:"/call/transfer/",TRANSFER_ACCEPTANCE:"/call/transferAcceptance/",TRANSFER_COMPLETION:"/call/transferCompletion/",PARK_COMPLETION:"/call/holdCompletion/",UNPARK_COMPLETION:"/call/resumeCompletion/",UPDATE_MEDIA_DESCRIPTIONS:"/call/updateMediaDescriptions"},wr={CONV_END:"/conversation/conversationEnd/",CONV_UPDATE:"/conversation/conversationUpdate/",CONV_LOCAL_PARTICIPANT_UPDATE:"/conversation/localParticipantUpdate/",CONV_ROSTER_UPDATE:"/conversation/rosterUpdate/",CONV_ADD_PARTICIPANT_SUCCESS:"/conversation/addParticipantSuccess/",CONV_ADD_PARTICIPANT_FAILURE:"/conversation/addParticipantFailure/",CONV_NUDGE_PARTICIPANT_SUCCESS:"/conversation/nudgeParticipantSuccess/",CONV_NUDGE_PARTICIPANT_FAILURE:"/conversation/nudgeParticipantFailure/",CONV_ADMIT_PARTICIPANT_SUCCESS:"/conversation/admitParticipantSuccess/",CONV_ADMIT_PARTICIPANT_FAILURE:"/conversation/admitParticipantFailure/",CONV_ADMIT_ALL_STATUS:"/conversation/admitAllStatus/",CONV_REMOVE_PARTICIPANT_SUCCESS:"/conversation/removeParticipantSuccess/",CONV_REMOVE_PARTICIPANT_FAILURE:"/conversation/removeParticipantFailure/",CONV_ADD_MODALITY_SUCCESS:"/conversation/addModalitySuccess/",CONV_ADD_MODALITY_FAILURE:"/conversation/addModalityFailure/",CONV_CONTENT_SHARING_UPDATE:"/conversation/contentSharingUpdate/",CONV_CONTENT_SHARING_END:"/conversation/contentSharingEnd/",CONV_BROADCAST_UPDATE:"/conversation/broadcastUpdate/",CONV_CONFIRM_UNMUTE:"/conversation/confirmUnmute/",CONV_UNMUTE_SUCCESS:"/conversation/unmuteSuccess/",CONV_UNMUTE_FAILURE:"/conversation/unmuteFailure/",UPDATE_MEETING_LIVE_STATE_STATUS:"/conversation/updateMeetingLiveStateStatus/",UPDATE_MEETING_GROUPS_STATUS:"/conversation/updateMeetingGroupsStatus/",SET_MEETING_LAYOUT_STATUS:"/conversation/setMeetingLayoutStatus/",UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS:"/conversation/updateParticipantInterpretationStateStatus/",UPDATE_PARTICIPANT_PROPERTIES_STATUS:"/conversation/updateParticipantPropertiesStatus/",JOIN_MEETING_GROUP_STATUS:"/conversation/joinMeetingGroupStatus/",LEAVE_MEETING_GROUP_STATUS:"/conversation/leaveMeetingGroupStatus/",RECEIVE_MESSAGE:"/conversation/receiveMessage/",SEND_MESSAGE_STATUS:"/conversation/sendMessageStatus/",DISABLE_PREHEAT_ASYNC_STATUS:"/conversation/disablePreheatAsyncStatus/",UPDATE_MEETING_STATES_STATUS:"/conversation/updateMeetingStatesStatus/",MUTE_UNMUTE_ASYNC:"/conversation/muteUnmuteAsync/"},Pr={...Rr,...wr},Mr="callNotification",Dr="mediaAnswer",Or="mediaAcknowledgement",kr="callAcceptance",Nr="callEnd",Lr="callProgress",xr="callAcceptanceAcknowledgement",Ur="mediaNegotiation",Fr="mediaNegotiationFailure",Vr="balanceUpdate",Br="retargetCompleted",Hr="callTransfer",$r="transferCompletion",Gr="transferAcceptance",jr="holdCompletion",qr="resumeCompletion",Wr="updateMeetingLiveStateResponse",zr="updateMeetingGroupsResponse",Jr="setMeetingLayoutResponse",Kr="updateMeetingStatesResponse",Yr=br,Qr=f(p),Xr=class e{constructor(e){this.headers={},e&&Object.keys(e).forEach((t=>{this.headers[this.getLowerCaseName(t)]=e[t]}))}isEmpty(){return Qr.isEmpty(this.headers)}set(e,t){this.headers[this.getLowerCaseName(e)]=t}get(t,i){return i?e.getHeaderValue(this.headers,t)||i:e.getHeaderValue(this.headers,t)}delete(e){delete this.headers[e],delete this.headers[e.toLowerCase()]}hasOwnPropertyCaseInsensitive(e){return Object.keys(this.headers).filter((function(t){return t.toUpperCase()===e.toUpperCase()})).length>0}getAll(){return this.headers}getLowerCaseName(t){return e.useLowerCaseHeaders?t.toLowerCase():t}static getHeaderValue(e,t){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t.toLowerCase())?e[t.toLowerCase()]:void 0}};function Zr(e,t,i=rs()){return os(t,"trailingPath cannot be null"),cs(e,"signalingSession cannot be null"),cs(e.baseMessagingChannelUrl,"messaging channel url is not set"),`${e.baseMessagingChannelUrl}${Yr.URL_BASE.CALLAGENT}/${e.sessionId}/${i}${t}`}function es(e){let t=1;return e.callingServiceSupportsAADTokens&&(t|=4),e.callingServiceSupportsCAETokens&&(t|=8),t}function ts(e){const t=e.toLowerCase(),i='token_types="',n=t.indexOf(i);if(-1===n)return[];const r=t.indexOf('"',n+13);if(-1===r)return[];const s=t.substring(n+13,r).trim();return""===s?[]:s.split(" ")}function is(e){return!!e.match(/^8:/)}function ns(e){return e.replace(/^\d+:/,"")}function rs(){return ss().substr(0,8)}function ss(){const e="0123456789abcdef";let t="",i=0,n=0;for(;n<36;){const r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"[n];switch(i=n%8==0?4294967295*Math.random()|0:i>>4,r){case"x":t+=e[15&i];break;case"y":t+=e[3&i|8];break;case"4":case"-":t+=r}n++}return t}function as(e,t){if(!e)throw new Error("Assert failed"+(void 0!==t?`:${t}`:""))}function os(e,t){if(!e||e instanceof String&&""===e||e instanceof Array&&0===e.length)throw new Error("AssertNotNullOrEmpty failed. "+(void 0!==t?`: ${t}`:""))}function cs(e,t){if(!e)throw new Error("AssertNotNull failed. "+(void 0!==t?`: ${t}`:""))}function ls(e){if(os(e,"callEndReason cannot be null or empty"),void 0===e.code||void 0===e.subCode||void 0===e.phrase||e.code<0||e.subCode<0||" "===e.phrase)throw new Error(`callEndReason must specify code, subCode and phrase. Invalid reason : ${Ne(e)}`)}function ds(e){cs(e,"MediaTypes passed cannot be null");const t=[],i=Yr.MEDIA_TYPES;for(const n of Object.keys(i))gs(e,i[n])&&t.push(i[n]);return t}function hs(e,t){const i={};for(const n of Object.values(t)){const t=n.split("/");i[t[t.length-2]]=Zr(e,n)}return i}function us(e,t){return e.length>=t.length&&e.indexOf(t,e.length-t.length)>-1}function gs(e,t){const i=t.toString().toLowerCase();return e.map((e=>e.toString().toLowerCase())).indexOf(i)>-1}function ps(e,t,i){return!e.hasOwnProperty(t)&&(e[t]=i,!0)}function ms(e,t){return!!e.hasOwnProperty(t)&&(delete e[t],!0)}function fs(e){let t=null;try{return t=JSON.parse(e),"object"==typeof t?t:null}catch(e){return null}}function Ss(e,t){if(!e)return{telemetryEndSubCode:Yr.CALL_END_CODE.UNKNOWN_ERROR,error:Yr.CALL_END_UNKNOWN_ERROR};let i;if("object"==typeof e.response)i=e.response;else try{i=JSON.parse(e.response)}catch(e){}if(e.skypeTokenError)return{telemetryEndSubCode:Yr.CALL_END_CODE.SKYPE_TOKEN_ERROR,error:Yr.CALL_END_SKYPE_TOKEN_ERROR};if(e.tokenTimeoutError)return{telemetryEndSubCode:Yr.CALL_END_CODE.HTTP_OTHER_ERROR,error:Yr.CALL_END_TOKEN_TIMEOUT_ERROR};if(e.tokenError)return{telemetryEndSubCode:Yr.CALL_END_CODE.HTTP_OTHER_ERROR,error:Yr.CALL_END_TOKEN_ERROR};if(i&&(i.operationFailure||i.broadcastOperationFailure)){const e=i.operationFailure||i.broadcastOperationFailure;return{telemetryEndSubCode:e.code,error:e}}return i?.code?{telemetryEndSubCode:i.code,error:i}:isNaN(e.status)||e.status!==Yr.CALL_END_CODE.NOT_FOUND?!isNaN(e.status)&&e.status?{telemetryEndSubCode:e.status,error:{code:e.status,subCode:isNaN(e.response)?0:e.response,phrase:e.statusText,resultCategories:[Tr]}}:!isNaN(e.response)&&e.response?{telemetryEndSubCode:0,error:{code:0,subCode:e.response,phrase:e.statusText,resultCategories:[Tr]}}:{telemetryEndSubCode:Yr.CALL_END_CODE.NETWORK_ERROR,error:Yr.CALL_END_NETWORK_ERROR}:{telemetryEndSubCode:Yr.CALL_END_CODE.NOT_FOUND,error:Yr.RESOURCE_NOT_FOUND_ERROR}}function vs(e,t){if(e&&!e.isEmpty()&&t){const i=e.get(Yr.HEADERS.ORIGINAL_MESSAGE_ID),n=e.get(Yr.HEADERS.MESSAGE_ID);if(n&&gs(t,n)||i&&gs(t,i))return!0;t.length>9&&t.shift(),t.push(i||n)}return!1}function ys(e){const t="unknown";return e.headers?e.headers.get(Yr.HEADERS.ORIGINAL_MESSAGE_ID,t):t}function Cs(e){try{return e.headers.get(Yr.HEADERS.ORIGINAL_MESSAGE_ID).replace("-","").substr(0,8)}catch(e){return rs()}}function _s(e){return e&&e.hasOwnPropertyCaseInsensitive(Yr.HEADERS.CONTENT_ENCODING)}function Es(e){return e&&Yr.KNOWN_PAYLOAD_ENCODINGS.hasOwnProperty(e.get(Yr.HEADERS.CONTENT_ENCODING).toUpperCase())}function Ts(e){const t=atob(e);return Cr.inflate(t,{to:"string"})}function Is(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)}}}function bs(e){let t=!1;try{if(t=e&&2===e.state(),navigator.onLine&&t)return 3;if(!navigator.onLine&&t)return 2;if(navigator.onLine&&!t)return 1}catch{}return 0}function As(e){return[Yr.HTTP_STATUS_CODES.UNKNOWN,Yr.HTTP_STATUS_CODES.UNAUTHORIZED,Yr.HTTP_STATUS_CODES.NETWORK_ERROR,Yr.HTTP_STATUS_CODES.OFFLINE,Yr.HTTP_STATUS_CODES.TIMEOUT,Yr.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,Yr.HTTP_STATUS_CODES.BAD_GATEWAY,Yr.HTTP_STATUS_CODES.SERVICE_UNAVAILABLE,Yr.HTTP_STATUS_CODES.GATEWAY_TIMEOUT].indexOf(e)>=0}function Rs(e,t){switch(e){case Yr.HEADERS.CAE_KEYWORD.toLowerCase():return 8;case Yr.HEADERS.AAD_KEYWORD.toLowerCase():return 4;case Yr.HEADERS.SKYPE_KEYWORD.toLowerCase():return 1;default:return t?.info("unexpected: unrecognized token type ${tokenType}"),null}}function ws(e){switch(e){case 0:return"GET";case 1:return"POST";case 2:return"PUT";case 3:return"DELETE"}}function Ps(e,t,i,n,r=!1,s,a){a?.createChild("[utils.ts]");const o={verb:ws(i),path:n.url},c=JSON.stringify(o),l=function(e){let t={};if(e){const i=Xr.getHeaderValue(e,Yr.HEADERS.AUTHENTICATE);i&&(t={authenticationHeaders:[i]})}return t}(s),d=function(e,t,i,n,r){if(!t)return 1;const{callingServiceSupportsAADTokens:s,callingServiceSupportsCAETokens:a,supportMissingTokenTypesInResponse:o,useSkypeTokenWhenNoAuthenticateHeader:c}=e,l=r?.authenticationHeaders;n?.info(`[getAuthHeadersTokenTypes] UnauthorizedResponse=${i} and authHeaders=${l}`);let d=null;if(!l&&i)c?(n?.info("[getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),d=1):(n?.info("[getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),d=es(e));else if(l||i){if(l&&i)for(const t of l){const i=ts(t);if(o&&0===i.length)n?.info("[getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),d=es(e);else for(const e of i){const t=Rs(e.toLowerCase(),n);a&&8===t&&(d|=8),s&&4===t&&(d|=4),1===t&&(d|=1)}}}else n?.info("[getAuthHeadersTokenTypes] first time requesting token, request client supported token types"),d=es(e);return d}(e,t,r,a,l);return a?.info(`[getTokenMetadata] return token type=${d}, factoJson=${c}, headers=${l?.authenticationHeaders}`),{tokenType:d,factorsJson:c,requestMetadataJson:l,isUnauthorized:r}}function Ms(){return Math.floor(Date.now()/1e3)}function Ds(e){return 1e3*e}function Os(e){switch(e){case"none":return"None";case"teamPark":return"TeamPark";case"callPark":return"CallParkV2";case"serverHold":return"ServerHold";case"serverHoldV2":return"MusicOnHoldV2";case"sharedLinePark":return"SharedLinePark";case"sharedLineParkV2":return"SharedLineAppearanceV2";default:return"UnknownType"}}function ks(e){switch(e){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishType to PublishStateType."}}function Ns(e){switch(e){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishStateType to PublishType."}}var Ls=class e{static isInLobby(e,t){for(const i of e)if(i.endpointId===t&&i.isLobby)return!0;return!1}static isParticipantServerMuted(e){for(const t of e)if(t.mediaStreams&&!t.mappedTo)for(const e of t.mediaStreams)if("audio"===e.type&&!0===e.serverMuted)return!0;return!1}static fromWireParticipant(t){return cs(t,"invalid wireParticipant"),os(t.id,"participant must have valid Id"),new e({id:t.id,displayName:t.displayName,languageId:t.languageId,acceptedBy:t.acceptedBy})}static getPluginlessStateTypeFromWire(e){return ks(e)}static findOrCreateTypeState(e,t){let i=t.typeStates.findIndex((t=>t.type===e));if(-1===i){const n={participantStates:[],type:e};t.typeStates.push(n),i=t.typeStates.length-1}return i}static processPublishedStates(e,t){const i={typeStates:[]},n=e;return vr.forEach(n,(e=>{const n=this.findOrCreateTypeState(this.getPluginlessStateTypeFromWire(e.stateType),i),r={id:t,publishedState:{content:e.content,stateId:e.stateId,typeRank:e.typeRank}};i.typeStates[n].participantStates.push(r)})),i}static fromRosterEndpoints(e){let t=[],i=!1,n=!1,r=!1,s=!1;return t=Object.keys(e).map((t=>{let a,o,c=[],l=!1,d=0;if(e[t].call&&(i=!0,c=e[t].call.mediaStreams||null,d=e[t].call.serverMuteVersion||0,o=e[t].call.appliedInteractivityLevel||"unknown"),e[t].lobby&&(l=!0,n=!0,c=e[t].lobby.mediaStreams||null),e[t].broadcast?.sessionInformation&&(a=e[t].broadcast.sessionInformation.role||null),e[t].mappedParticipant&&(r=!0,c=e[t].mappedParticipant.mediaStreams||null),!e[t].capabilities&&e[t].endpointCapabilities){const i=e[t].endpointCapabilities;e[t].capabilities={implicitCallback:16&i?"enabled":"disabled",cloudAudioVideoConference:1&i?"enabled":"disabled",cloudScreenSharing:2&i?"enabled":"disabled",hostlessConference:4&i?"enabled":"disabled",autoJoinOnConflict:32&i?"enabled":"disabled",serverMuteUnmute:64&i?"enabled":"disabled",supportsCompressedServicePayload:128&i?"enabled":"disabled",cloudMerge:8&i?"enabled":"disabled"}}return s=s||!!e[t].streamLobby||!!e[t].stream,{endpointId:t,participantId:e[t].participantId||null,clientVersion:e[t].clientVersion||null,endpointMetadata:e[t].endpointMetadata||null,originalId:e[t].originalId||null,contentSharing:e[t].contentSharing||null,capabilities:e[t].capabilities||null,endpointType:e[t].endpointType||"default",deviceType:e[t].deviceType||void 0,clientEndpointCapabilities:e[t].clientEndpointCapabilities||void 0,mediaStreams:c,serverMuteVersion:d,broadcastMeetingRole:a,isLobby:l,endpointState:e[t].endpointState||null,publishedStates:e[t].publishedStates||null,callLinks:e[t].callLinks||null,appliedInteractivityLevel:o||"unknown",mappedTo:e[t].mappedTo||null,meetingGroupDetails:e[t].meetingGroupDetails,streamInformation:e[t].streamInformation,propertyBag:e[t].propertyBag,streamLobby:e[t].streamLobby,stream:e[t].stream}})),{endpointDetails:t,participantHasCallModality:i,participantIsInLobby:n,participantHasMappedEndpoint:r,participantHasStreamEndpoint:s}}static fromRoster(t,i=!1){cs(t,`invalid rosterParticipant ${JSON.stringify(t)}`),os(t.details.id,"participant must have valid Id");const n=t.endpoints||{},r=this.fromRosterEndpoints(n),s=r.endpointDetails,a=r.participantHasCallModality,o=r.participantHasMappedEndpoint,c=r.participantHasStreamEndpoint;let l=r.participantIsInLobby;return a||l||o||i||c?(a&&(l=!1),new e({id:t.details.id,displayName:t.details.displayName,version:t.version||0,propertyBag:t.details.propertyBag||null,languageId:t.details.languageId,role:t.role||"",tenantId:t.details.tenantId||"",endpointDetails:s||[],acceptedBy:t.acceptedBy||"",isLobby:l,meetingRole:t.meetingRole,advancedMeetingRole:t.advancedMeetingRole,participantType:t.details.participantType,publishedStates:t.publishedStates||null,isIdentityMasked:t.details.isIdentityMasked,nonMaskedId:t.details.nonMaskedId||"",nonMaskedObjectId:t.details.nonMaskedObjectId||"",nonMaskedDisplayName:t.details.nonMaskedDisplayName||"",maskedIdSeqNumber:t.details.maskedIdSeqNumber||0,maskedId:t.details.maskedId||"",joinAsStreamingUser:t.joinAsStreamingUser,enableCaptcha:t.enableCaptcha})):null}static fromRosterSearchResults(e){cs(e,`invalid rosterParticipant ${JSON.stringify(e)}`),os(e.details.id,"participant must have valid Id");const t=e.endpoints,{endpointDetails:i,participantHasCallModality:n,participantIsInLobby:r,participantHasMappedEndpoint:s,participantHasStreamEndpoint:a}=this.fromRosterEndpoints(t);let o=0;return n||a?o=3:r?o=10:s&&(o=3),{id:e.details.id,state:o,tenantId:e.details.tenantId||"",displayName:e.details.displayName,role:e.role||"",meetingRole:e.meetingRole,advancedMeetingRole:e.advancedMeetingRole,participantType:e.details.participantType,isServerMuted:this.isParticipantServerMuted(i),publishedStates:this.processPublishedStates(e.publishedStates,e.details.id),endpoints:i||[],isIdentityMasked:e.details.isIdentityMasked,nonMaskedId:e.details.nonMaskedId||"",nonMaskedDisplayName:e.details.nonMaskedDisplayName||"",nonMaskedObjectId:e.details.nonMaskedObjectId||"",maskedIdSeqNumber:e.details.maskedIdSeqNumber||0,maskedId:e.details.maskedId||"",joinAsStreamingUser:e.joinAsStreamingUser}}constructor(e){this.id=e.id,this.displayName=e.displayName||"",this.version=e.version,this.propertyBag=e.propertyBag,this.languageId=e.languageId||null,this.endpointDetails=e.endpointDetails||[],this.acceptedBy=e.acceptedBy,this.role=e.role,this.tenantId=e.tenantId,this.isLobby=e.isLobby,this.meetingRole=e.meetingRole,this.advancedMeetingRole=e.advancedMeetingRole,this.participantType=e.participantType,this.publishedStates=e.publishedStates,this.isIdentityMasked=e.isIdentityMasked,this.nonMaskedId=e.nonMaskedId,this.nonMaskedDisplayName=e.nonMaskedDisplayName,this.nonMaskedObjectId=e.nonMaskedObjectId,this.maskedIdSeqNumber=e.maskedIdSeqNumber,this.maskedId=e.maskedId,this.joinAsStreamingUser=e.joinAsStreamingUser,this.enableCaptcha=e.enableCaptcha}},xs="HandleMediaAcknowledgement",Us="HandleMediaNegotiationFailure",Fs="HandleMediaAnswer",Vs="HandleMediaAnswerFailed",Bs="HandleMediaOffer",Hs="RejectRenegotiation",$s="HandleRetargetCompleted",Gs="HandleMediaAnswerTimeout",js="HandleMediaAcknowledgementTimeout",qs="AcceptRenegotiation",Ws="StartRenegotiation",zs="MediaFsmStateChanged",Js="AddModalityTimeout",Ks="AddParticipant",Ys="AddParticipantTimeout",Qs="AddParticipantWithReplaces",Xs="AddParticipantWithReplacesTimeout",Zs="AddParticipantsAndModality",ea="AdmitParticipant",ta="AdmitParticipantTimeout",ia="Admit",na="AdmitTimeout",ra="AdmitFailure",sa="AdmitSuccess",aa="CallMeBack",oa="CallMeBackTimeout",ca="RemoveParticipant",la="RemoveParticipantOthers",da="RemoveParticipantSpecified",ha="RemoveParticipantTimeout",ua="HandleAddParticipantSuccess",ga="HandleAddParticipantFailure",pa="HandleAdmitParticipantSuccess",ma="HandleAdmitParticipantFailure",fa="HandleAddParticipantModalityFailure",Sa="HandleRemoveParticipantSuccess",va="HandleRemoveParticipantFailure",ya="HandleRosterUpdate",Ca="HandleRosterUpdateFail",_a="HandleConversationUpdate",Ea="HandleLocalParticipantUpdate",Ta="SetSubject",Ia="SetJoinedFrom",ba="SetDeviceType",Aa="GetEmergencyContent",Ra="SetMultiparty",wa="SetGroupId",Pa="SetThreadId",Ma="SetCallOptions",Da="SetTransferContext",Oa="StartCall",ka="JoinCall",Na="JoinConversationWithoutCallModality",La="HandleIncomingCall",xa="EndCall",Ua="EndWithBeacon",Fa="ConflictedCall",Va="SetProvisionalAnswer",Ba="SetProvisionalAnswerFailed",Ha="AcceptCall",$a="AcceptCallFailed",Ga="HandleCallAcceptanceAck",ja="HandleCallAcceptance",qa="HandleCallAcceptanceSync",Wa="HandleCallAcceptanceFailed",za="HandleCallEstablishmentTimeout",Ja="HandleCallEnd",Ka="HandleCallProgress",Ya="TrouterUrlChanged",Qa="TrouterStateChanged",Xa="TrouterUrlChangedToInvalid",Za="TrouterUrlUpdateFailed",eo="AddContentSharingModality",to="AcceptedBeforeRinging",io="DeleteContentSharing",no="TakeControlContentSharing",ro="UpdateSessionStateContentSharing",so="JoinContentSharing",ao="UpdateParticipantStateContentSharing",oo="HandleContentSharingUpdate",co="HandleContentSharingEnd",lo="ContentSharingStartFromRoster",ho="ContentSharingEndFromRoster",uo="HandleAddModalitySuccess",go="HandleAddModalityFailure",po="AddBroadcastModality",mo="UpdateBroadcastDetails",fo="WaitingForAddBroadcastModalityCompletion",So="Mute",vo="NudgeParticipantTimeout",yo="Unmute",Co="UnmuteTimeout",_o="HandleUnmuteConfirm",Eo="ApproveUnmute",To="RejectUnmute",Io="HandleControlVideoStreaming",bo="HandleDominantSpeakerChangedCount",Ao="HandleCsrcInfo",Ro="SendWebRtcMediaNotification",wo="TransferCall",Po="ParkCall",Mo="CallRedirect",Do="CallRedirectRequestFailed",Oo="TransferCompletionFailed",ko="TransferRequestReceived",No="HandleParkRequested",Lo="DuplicateMessageIgnored",xo="CorrelationIdUpdated",Uo="UnkownMessageType",Fo="FailedToHandleMessage",Vo="ConnectivityChanged",Bo="TrouterDecodePayloadFailure",Ho="UpdateEndpointState",$o="BrokerDecodePayloadFailure",Go="BrokerSubscriptionTimeout",jo="BrokerSubscriptionSuccessful",qo="BrokerSubscriptionFailed",Wo="FailedToHandleTrouterMessage",zo="FailedToHandleBrokerMessage",Jo="BrokerDisabledSubscribeUrlPresent",Ko="Connected",Yo="InLobby",Qo="Staging",Xo="MessageMissingBody",Zo="BroadcastStateChanged",ec="HandleCallNotification",tc="HandleIncomingCallReplacement",ic="HandlePstnBalanceUpdate",nc="IgnoreOldRoster",rc="HandleMediaAck",sc="HandleMediaProvisionalAck",ac="UpdateCallStatus",oc="SendAttach",cc="RequestNewOffer",lc="HandleNewOffer",dc="UpdateConversationLinks",hc="UpdateConversationLinksSuccess",uc="UpdateConversationLinksFailed",gc="ProcessInitialOffer",pc="SendProgress",mc="SendProgressFailed",fc="ProcessCallAcceptance",Sc="AcceptanceUserInLobby",vc="RejectIncomingCall",yc="SendKeepAlive",Cc="SendKeepAliveFailed",_c="StartAudio",Ec="StopAudio",Tc="UpdateMeetingRole",Ic="EnablingPreheat",bc="DisablingPreheat",Ac="PreheatDisabled",Rc="TransferRequestSent",wc="CallRedirectRequestSent",Pc="TransferRequestFailed",Mc="SendAcceptTransfer",Dc="SendAcceptTransferFail",Oc="WaitingForTransferCompletion",kc="WaitingForTransferCompletionFail",Nc="WaitingForTransferAcceptanceFail",Lc="WaitingForTransferAcceptance",xc="TransferCompleted",Uc="SendCompleteTransfer",Fc="SendCompleteTransferFailed",Vc="PickupCodeSet",Bc="AddParticipantWithPickupCode",Hc="AddParticipantWithPickupCodeTimeout",$c="PublishState",Gc="PublishStateFailure",jc="RemoveState",qc="RemoveStateFailure",Wc="UpdateMeetingSettings",zc="UpdateMeetingSettingsFailure",Jc="UpdateEndpointMetadataSuccess",Kc="UpdateEndpointMetadataFailure",Yc="SearchParticipants",Qc="GetAllParticipants",Xc="SearchParticipantsFailure",Zc="GetAllParticipantsFailure",el="ParkRequestFailed",tl="WaitingForParkCompletion",il="WaitingForParkCompletionTimeout",nl="ParkCompleted",rl="ParkFailed",sl="UnparkRequestFailed",al="WaitingForUnparkCompletion",ol="WaitingForUnparkCompletionTimeout",cl="UnparkCompleted",ll="UnparkFailed",dl="UpdateMeetingLiveState",hl="WaitingForUpdateMeetingLiveStateCompletion",ul="UpdateMeetingLiveStateRequestFailed",gl="UpdateMeetingLiveStateResponseFailure",pl="UpdateMeetingLiveStateResponseSuccess",ml="UpdateMeetingGroups",fl="UpdateParticipantInterpretationState",Sl="UpdateParticipantsProperties",vl="JoinMeetingGroup",yl="LeaveMeetingGroup",Cl="incomingProxiedMessages",_l="WaitingForUpdateMeetingGroupsCompletion",El="UpdateMeetingGroupsRequestFailed",Tl="UpdateMeetingGroupsRequestFailure",Il="UpdateMeetingGroupsResponseSuccess",bl="SetMeetingLayout",Al="WaitingForSetMeetingLayoutCompletion",Rl="SetMeetingLayoutRequestFailed",wl="SetMeetingLayoutResponseFailure",Pl="SetMeetingLayoutResponseSuccess",Ml="UpdateParticipantInterpretationStateTimeout",Dl="UpdateParticipantInterpretationStateResponseFailed",Ol="UpdateParticipantInterpretationStateResponseCompleted",kl="UpdateParticipantsPropertiesTimeout",Nl="UpdateParticipantsPropertiesResponseFailed",Ll="UpdateParticipantsPropertiesResponseCompleted",xl="WaitingForJoinMeetingGroupCompletion",Ul="JoinMeetingGroupRequestFailed",Fl="JoinMeetingGroupRequestFailed",Vl="JoinMeetingGroupRequestCompleted",Bl="WaitingForLeaveMeetingGroupCompletion",Hl="LeaveMeetingGroupRequestFailed",$l="LeaveMeetingGroupRequestFailed",Gl="LeaveMeetingGroupRequestCompleted",jl="SubscribeUrlFound",ql="SubscribeUrlMissing",Wl="SendMessageCompletion",zl="SendMessageTimeout",Jl="DiablePreheatSucceeded",Kl="AsyncDisablePreheatSucceeded",Yl="DiablePreheatFailed",Ql="AsyncDiablePreheatFailed",Xl="DisablePreheatResponseReceived",Zl="StreamInformationReceived",ed="UpdateMediaDescriptions",td="UpdateMediaDescriptionsFailed",id="NudgeToJoinAsRealtime",nd="UpdateMeetingStates",rd="WaitingForUpdateMeetingStatesCompletion",sd="UpdateMeetingStatesResponseSuccess",ad="UpdateMeetingStatesResponseFailure",od={SEND_MEDIA_ANSWER:{name:"SendMediaAnswer",controller:0},START_RENEGOTIATION:{name:"StartRenegotiation",controller:0},SEND_MEDIA_ACKNOWLEDGEMENT:{name:"SendMediaAcknowledgement",controller:0},SEND_MEDIA_REJECTION:{name:"SendMediaRejection",controller:0},ADD_PARTICIPANT:{name:"AddParticipant",controller:1},ADD_PARTICIPANT_WITH_REPLACES:{name:"AddParticipantWithReplaces",controller:1},NUDGE_PARTICIPANT:{name:"NudgeParticipant",controller:1},REMOVE_PARTICIPANT_NONE:{name:"RemoveParticipant",controller:1},REMOVE_PARTICIPANT_OTHERS:{name:"RemoveParticipantOthers",controller:1},REMOVE_PARTICIPANT_SPECIFIED:{name:"RemoveParticipantSpecified",controller:1},ADMIT_PARTICIPANT:{name:"AdmitParticipant",controller:1},ADMIT:{name:"Admit",controller:1},BROKER_SUBSCRIBE:{name:"BrokerSubscribe",controller:2},CALL_ME_BACK:{name:"CallMeBack",controller:1},SEND_ACCEPTANCE:{name:"SendAcceptance",controller:0},SEND_ACCEPTANCE_ACKNOWLEDGEMENT:{name:"SendAcceptanceAcknowledgement",controller:0},END_CALL:{name:"EndCall",controller:1},CANCEL_CALL:{name:"CancelCall",controller:1},REJECT_CALL:{name:"RejectCall",controller:0},JOIN_CONVERSATION:{name:"JoinConversation",controller:1},JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:{name:"JoinConversationWithoutCallModality",controller:1},LEAVE_CONVERSATION:{name:"LeaveConversation",controller:1},DELETE_CONVERSATION:{name:"DeleteConversation",controller:1},START_CALL:{name:"StartCall",controller:1},PLACE_NUDGE_CALL:{name:"PlaceNudgeCall",controller:5},UPDATE_CONVERSATION_LINKS:{name:"UpdateConversationLinks",controller:1},SEND_CONVERSATION_KEEP_ALIVE:{name:"SendConversationKeepAlive",controller:1},SEND_CALL_ATTACH:{name:"SendCallAttach",controller:0},SEND_CALL_PROGRESS:{name:"SendCallProgress",controller:0},SEND_KEEP_ALIVE:{name:"SendKeepAlive",controller:0},ADD_CONTENT_SHARING_MODALITY:{name:"AddContentSharingModality",controller:1},DELETE_CONTENT_SHARING:{name:"DeleteContentSharing",controller:3},TAKE_CONTROL_CONTENT_SHARING:{name:"TakeControlContentSharing",controller:3},UPDATE_SESSION_STATE_CONTENT_SHARING:{name:"UpdateSessionStateContentSharing",controller:3},JOIN_CONTENT_SHARING:{name:"JoinContentSharing",controller:3},UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:{name:"UpdateParticipantStateContentSharing",controller:3},UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS:{name:"UpdateContentSharingNotificationLinks",controller:3},MUTE_ALL:{name:"MuteAll",controller:1},MUTE_ALL_SYNC:{name:"MuteAllSync",controller:1},MUTE_SPECIFIED:{name:"MuteSpecified",controller:1},MUTE_SPECIFIED_SYNC:{name:"MuteSpecifiedSync",controller:1},MUTE_MYSELF:{name:"MuteMyself",controller:1},UNMUTE:{name:"Unmute",controller:1},UNMUTE_SYNC:{name:"UnmuteMyselfSync",controller:1},SEND_CONTROL_VIDEO_STREAMING:{name:"SendControlVideoStreaming",controller:0},SEND_APPLY_CHANNEL_PARAMETERS:{name:"SendApplyChannelParameters",controller:0},APPROVE_UNMUTE:{name:"ApproveUnmute",controller:5},REJECT_UNMUTE:{name:"RejectUnmute",controller:5},SEND_CALL_REDIRECT_REQUEST:{name:"SendCallRedirectRequest",controller:0},SEND_TRANSFER_REQUEST:{name:"SendTransferRequest",controller:0},SEND_PARK_REQUEST:{name:"SendParkRequest",controller:0},SEND_SHARED_LINE_PARK_REQUEST:{name:"SharedLinePark",controller:0},SEND_SERVER_HOLD_REQUEST:{name:"ServerHoldRequest",controller:0},PARK_REQUEST:{name:"ParkRequest",controller:0},SEND_UNPARK_REQUEST:{name:"UnparkRequest",controller:0},TRANSFER_ACCEPTANCE:{name:"TransferAcceptance",controller:0},TRANSFER_COMPLETION:{name:"TransferCompletion",controller:0},TRANSFER_COMPLETION_FAILED:{name:"TransferCompletionFailed",controller:0},UPDATE_ENDPOINT_STATE:{name:"UpdateEndpointState",controller:1},DISABLE_PREHEAT:{name:"DisablePreheat",controller:5},REQUEST_NEW_OFFER:{name:"RequestNewOffer",controller:0},UPDATE_ENDPOINT_METADATA:{name:"UpdateEndpointMetadata",controller:1},UPDATE_MEETING_ROLE_ATTENDEE:{name:"UpdateMeetingRoleToAttendee",controller:1},UPDATE_MEETING_ROLE_PRESENTER:{name:"UpdateMeetingRoleToPresenter",controller:1},UPDATE_MEETING_ROLE_ORGANIZER:{name:"UpdateMeetingRoleToOrganizer",controller:1},ADD_PARTICIPANT_WITH_PICKUP_CODE:{name:"AddParticipantWithPickupCode",controller:1},PUBLISH_STATE:{name:"PublishState",controller:1},REMOVE_STATE:{name:"RemoveState",controller:1},UPDATE_MEETING_SETTINGS:{name:"UpdateMeetingSettings",controller:1},ADD_PARTICIPANTS_AND_MODALITY:{name:"AddParticipantsAndModality",controller:1},ADD_BROADCAST_MODALITY:{name:"AddBroadcastModality",controller:1},SEARCH_PARTICIPANTS:{name:"SearchParticipants",controller:1},GET_ALL_PARTICIPANTS:{name:"GetAllParticipants",controller:1},UPDATE_MEETING_LIVE_STATE:{name:"UpdateMeetingLiveState",controller:1},UPDATE_MEETING_GROUPS:{name:"UpdateMeetingGroups",controller:1},SET_MEETING_LAYOUT:{name:"SetMeetingLayout",controller:1},UPDATE_PARTICIPANT_INTERPRETATION_STATE:{name:"UpdateParticipantInterpretationState",controller:1},JOIN_MEETING_GROUP:{name:"JoinMeetingGroup",controller:1},LEAVE_MEETING_GROUP:{name:"LeaveMeetingGroup",controller:1},SEND_PROXIED_MESSAGE:{name:"SendProxiedMessage",controller:1},UPDATE_PARTICIPANTS_PROPERTIES:{name:"UpdateParticipantsProperties",controller:1},UPDATE_MEDIA_DESCRIPTIONS:{name:"UpdateMediaDescriptions",controller:0},UPDATE_MEETING_STATES:{name:"UpdateMeetingStates",controller:1}},cd={TROUTER:"Trouter",BROKER:"Broker",UDP:"UDP",LOCAL:"Local"},ld={NGC_SOURCE:"SkypeConcore"},dd={CONVERSATION_CALL_MODALITY:"skypecosi_concore_web_csa_conversation_callmodality",CONVERSATION_CONTENT_SHARING:"skypecosi_concore_web_csa_conversation_contentsharing",CONVERSATION_HTTP_REQUEST:"skypecosi_concore_web_csa_conversation_httprequest",CONVERSATION_TOKEN:"skypecosi_concore_web_csa_conversation_token"},hd={DATA_VERSION:"DataVersion",DIRECTION:"Direction",CONTENT_SHARING_DIRECTION:"ContentSharingDirection",CONNECTED_DURATION_IN_MS:"ConnectedDurationInMsecs",PREHEATED_CALL_SETUP_DURATION_IN_S:"PreheatedCallSetupDurationInSeconds",CALL_CANCELATION_DURATION_IN_S:"CallCancelationDurationInSeconds",IS_PREHEATED:"IsPreheated",TIME_TO_RING_IN_MS:"TimeToRingInMsecs",CALL_TERMINATING_END:"CallTerminatingEnd",NETWORK_REQUESTS_PENDING:"NetworkRequestsPending",NETWORK_REQUESTS_COMPLETED:"NetworkRequestsCompleted",LOCAL_OPERATIONS_PERFORMED:"LocalOperationsPerformed",TROUTER_WAIT_OPERATIONS:"TrouterWaitOperations",CALL_START_TIME:"CallStartTime",CALL_END_TIME:"CallEndTime",IS_GROUP_CALL:"IsGroupCall",IS_HOSTLESS_CALL:"IsHostLessCall",IS_CAST_CALL:"IsCastCall",IS_HUDDLE_GROUP_CALL:"IsHuddleGroupCall",IS_MEETUP_CALL:"IsMeetupCall",IS_ON_BEHALF_OF_CALL:"IsOnBehalfOfCall",IS_SDP_IN_CALL_NOTIFICATION:"SdpInCallNotification",CALL_END_CODE:"Code",CALL_END_SUB_CODE:"SubCode",CALL_PHRASE:"Phrase",CALL_END_RESULT_CATEGORIES:"ResultCategories",CALL_END_CAUSE_ID:"CauseId",CONTENT_SHARING_END_CODE:"ContentSharingEndReasonServiceCode",CONTENT_SHARING_END_SUB_CODE:"ContentSharingEndReasonServiceSubCode",CONVERSATION_SERVICE_URL:"ConversationServiceUrl",CONTENT_SHARING_SERVICE_URL:"ContentSharingServiceUrl",MEETING_INFO:"MeetingInfo",JOINED_FROM:"JoinedFrom",RESULT_VALUE:"ResultValue",RESULT_DETAIL:"ResultDetail",RESULT_CAUSE_ID:"ResultCauseId",RESULT_CODE:"ResultCode",LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS:"LocalOfferAnswerGenerationTimestamps",SELF_PARTICIPANT_ROLE:"SelfParticipantRole",SCENARIO:"Scenario",CALLER_TYPE:"Caller_Type",CALLEE_TYPE:"Callee_Type",CALL_TYPE:"Call_Type",TEST_CONTEXT_ID:"Test_Context_Id",OUTGOING_MODALITIES:"Outgoing_Modalities",INCOMING_MODALITIES:"Incoming_Modalities",OFFERED_MODALITIES:"CallOfferredModalities",ANSWERED_MODALITIES:"CallAnsweredModalities",VBSS_OPERATIONS:"VBSS_Operations",CHANGING_CORRELATION_ID_NEW_ID:"ChangingCorrelationId_NewId",CHANGING_CORRELATION_ID_OLD_ID:"ChangingCorrelationId_OldId",MESSAGING_CHANNEL:"MessagingChannel",EVENT_TIMESTAMP_BAG:"EventTimestampBag",ROSTER_UPDATES_BAG:"RosterUpdatesBag",NETWORK_REQUESTS_BAG:"NetworkRequestBag",CLIENT_INFORMATION:"ClientInformation",ECS_ETAG:"EcsEtag",APPLICATION_TYPE:"ApplicationType",RING:"Ring",TENANT_ID:"TenantId",USER_HEX_CID:"UserHexCID",ACS_RESOURCE_ID:"AcsResourceId",REGION:"Region",PARTITION:"Partition",CALL_END_CLIENT_SUB_CODE:"CallEventCallEndClientSubCode",CALL_END_CLIENT_PHRASE:"CallEventCallEndClientPhrase",MEETING_CODE:"MeetingCode",MEETING_URL:"MeetingJoinUrl",BROADCAST_MEETING_ROLE:"BroadcastMeetingRole",MEETING_ROLE:"MeetingRole",ADVANCED_MEETING_ROLE:"AdvancedMeetingRole",PARTICIPANT_TYPE:"ParticipantType",AUDIO_ONLY_WATERMARK:"ClientSupportsAudioOnlyWatermark",CLIENT_SUPPORT_WATERMARK:"ClientSupportsWatermark",TARGET_APPLICATION_TYPE:"TargetApplicationType",IS_REINVITELESS:"IsReinviteless",CLIENT_TYPE:"ClientType",CLIENT_SUPPORTS_PREVENT_SCREEN_CAPTURE:"ClientSupportsPreventScreenCapture"},ud={TROUTER:"Trouter",BROKER:"Broker"},gd="JsCsaConfig",pd={BROKER_OUTGOING_ENABLED:"BrokerOutgoingEnabled",BROKER_INCOMING_ENABLED:"BrokerIncomingEnabled",BROKER_REQUEST_BATCHING_ENABLED:"BrokerRequestBatchingEnabled",BROKER_EXCLUSIVELY_ENABLED:"BrokerExclusivelyEnabled",SUPPORTS_COMPRESSED_PAYLOAD:"SupportsCompressedPayload",SYNC_TROUTER_RESPONSE:"SyncTrouterResponse",SERVER_MUTE_UNMUTE:"serverMuteUnmute",HANDLE_OFFER_FROM_NOTIFICATION:"handleMediaOfferFromPushNotification",HANDLE_NEW_OFFER_REQUEST:"handleNewOfferRequest",SEND_PROGRESS_FROM_CC:"sendProgressFromCC",INTERNAL_HTTP_DISPATCHER:"internalHttpDispatcher",ENABLE_TOKEN_CACHE:"enableTokenCache",ENABLE_TOKEN_PREFETCH:"enableTokenPrefetch",REQUEST_HEDGING:"requestHedging",SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION:"supportMediaRetargetWhileIncomingRenegotiation",ENABLE_ERROR_CODE_IMPROVEMENTS_FOR_NETWORK_FAILURES:"enableErrorCodeImprovementsForNetworkFailures",ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL:"enableCallEstablishmentTimeoutsForStartJoinCall",ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API:"enableTokenCacheForGenericTokenAPI",ENABLE_LONG_OUTGOING_1TO1_SETUP:"enableLongOutgoing1To1SetupTimeoutForWeb"},md={CORRELATION_ID:"CorrelationId",SHARED_CORRELATION_ID:"SharedCorrelationId",SIGNALING_SESSION_ID:"SignalingSessionId",GROUP_ID:"GroupId",THREAD_ID:"ThreadId",TEAMS_MESSAGEID:"TeamsMessageId",TEAMS_MEETINGINFO:"TeamsMeetingInfo",ENDPOINT_ID:"EndpointId",PARTICIPANT_ID:"ParticipantId",DATA_VERSION:"DataVersion",CONTENT_SHARING_ID:"ContentSharingSessionId",CONTENT_SHARING_CORRELATION_ID:"ContentSharingCorrelationId"},fd={LOCAL:"Local",REMOTE:"Remote"},Sd={SUCCESS:"Success",FAILURE:"Failure"},vd={INCOMING:"Incoming",OUTGOING:"Outgoing"},yd={CALLER:"caller",CALLEE:"callee",JOIN:"join",JOIN_FOR_ROSTER_ONLY:"joinForRosterOnly",PREHEAT:"preheat"},Cd={START:"Start",STOP:"Stop",REJECTED:"Rejected",REMOTE_START:"RemoteStart",TIMEOUT:"Timeout",CALL_END:"CallEnd"},_d={STARTED:"Started",ENDED:"Ended",FAILED:"Failed"},Ed={TOKEN_TELEMETRY:"TokenTelemetry"};function Td(e){e.cloudScreenSharingFlag="disabled"===e.cloudScreenSharingFlag?e.cloudScreenSharingFlag:"enabled",e.isWebRtcEnabled="undefined"==typeof RTCIceGatherer,e.shouldServiceSendNGCUpgradeMessages=Id(e.shouldServiceSendNGCUpgradeMessages,!0),e.isGVCOutgoingEnabled=Id(e.isGVCOutgoingEnabled,!0),e.supportsCompressedServicePayload=Id(e.supportsCompressedServicePayload,!0),e.supportsSynchronousTrouterResponse=Id(e.supportsSynchronousTrouterResponse,!0),e.supportsHostlessGroupCalls=Id(e.supportsHostlessGroupCalls,!0),e.doHostlessCalling=Id(e.doHostlessCalling,!1),e.brokerExclusively=Id(e.brokerExclusively,!1),e.brokerEnabledOutgoing=Id(e.brokerEnabledOutgoing,!0),e.brokerEnabledIncoming=Id(e.brokerEnabledIncoming,!0),e.brokerRequestBatching=Id(e.brokerRequestBatching,!0),e.handleMediaOfferFromPushNotification=Id(e.handleMediaOfferFromPushNotification,!0),e.handleNewOfferRequest=Id(e.handleNewOfferRequest,!1),e.autoJoinOnConflict=Id(e.autoJoinOnConflict,!0),e.endConflictedCall=Id(e.endConflictedCall,!1),e.autoResolveConflictedCall=Id(e.autoResolveConflictedCall,!1),e.shouldServiceSendCallEventMessages=Id(e.shouldServiceSendCallEventMessages,!1),e.forceTrouterReconnectOnNetworkOnline=Id(e.forceTrouterReconnectOnNetworkOnline,!0),e.attemptHttpRequestWithCachedSkypetoken=Id(e.attemptHttpRequestWithCachedSkypetoken,!0),e.useInternalHttpDispatcher=Id(e.useInternalHttpDispatcher,!1),e.enableTokenCache=Id(e.enableTokenCache,!1),e.enableTokenPrefetch=Id(e.enableTokenPrefetch,!1),e.hedgeDelayMs=Id(e.hedgeDelayMs,4e3),e.hedgeMaxParallelAttempts=Id(e.hedgeMaxParallelAttempts,3),e.useInternalHttpDispatcher&&(e.httpRequestDispatcher=new Be(e.logger)),e.enableQuickSendAcceptanceAck=Id(e.enableQuickSendAcceptanceAck,!1),e.supportMediaRetargetWhileIncomingRenegotiation=Id(e.supportMediaRetargetWhileIncomingRenegotiation,!1),e.callingServiceSupportsAADTokens=Id(e.callingServiceSupportsAADTokens,!1),e.callingServiceSupportsCAETokens=Id(e.callingServiceSupportsCAETokens,!1),e.aadTokenExpirationTimeInSeconds=Id(e.aadTokenExpirationTimeInSeconds,3600),e.caeTokenExpirationTimeInSeconds=Id(e.caeTokenExpirationTimeInSeconds,86400),e.disableTokenMigrationHeader=Id(e.disableTokenMigrationHeader,!1),e.enablePublishTokenTelemetry=Id(e.enablePublishTokenTelemetry,!1),e.forceClearExpiredTokens=Id(e.forceClearExpiredTokens,!1),e.enableRefreshToken=Id(e.enableRefreshToken,!0),e.refreshTimeBeforeTokenTimeoutInSeconds=Id(e.refreshTimeBeforeTokenTimeoutInSeconds,30),e.enableCallEstablishmentTimeoutsForStartJoinCall=Id(e.enableCallEstablishmentTimeoutsForStartJoinCall,!1),e.csaTimeoutConfiguration=function(e,t){return(t||e)&&{...t,...e}}(e.csaTimeoutConfiguration,{conversationKeepAliveTimeoutSec:2700,promotionUnmuteTimeoutSec:1e4}),e.reportPreviousErrorsForTimeout=Id(e.reportPreviousErrorsForTimeout,!1),e.callingTokenLogicalUrl=Id(e.callingTokenLogicalUrl,"https://calling.teams.microsoft.com"),e.enableAsyncDisablePreheat=Id(e.enableAsyncDisablePreheat,!1),e.forceLowercaseHttpHeaders=Id(e.forceLowercaseHttpHeaders,!1),e.enableResolveScreenSharingWhenNegotiationComplete=Id(e.enableResolveScreenSharingWhenNegotiationComplete,!1),e.maxReinvitelessMediaForVideoForWeb=Id(e.maxReinvitelessMediaForVideoForWeb,0),e.maxReinvitelessMediaForVBSSForWeb=Id(e.maxReinvitelessMediaForVBSSForWeb,0),e.enableRefreshTokenRetry=Id(e.enableRefreshTokenRetry,!0),e.enableRefreshTokenRetryInSeconds=Id(e.enableRefreshTokenRetryInSeconds,60),e.enableConversationTypeUpdateOnCallEnd=Id(e.enableConversationTypeUpdateOnCallEnd,!1),e.supportMissingTokenTypesInResponse=Id(e.supportMissingTokenTypesInResponse,!0),e.useSkypeTokenWhenNoAuthenticateHeader=Id(e.useSkypeTokenWhenNoAuthenticateHeader,!1),e.enableAutoPromotion=Id(e.enableAutoPromotion,!1),e.enableBatchedSendMessageStatus=Id(e.enableBatchedSendMessageStatus,!1),e.enableBatchedReceiveMessage=Id(e.enableBatchedReceiveMessage,!1),e.enableAddParticipantEnhancements=Id(e.enableAddParticipantEnhancements,!1),e.enableTokenCacheForGenericTokenAPI=Id(e.enableTokenCacheForGenericTokenAPI,!1),e.disableRealTimeModeFromRoster=Id(e.disableRealTimeModeFromRoster,!0),e.enableLongOutgoing1To1SetupTimeoutForWeb=Id(e.enableLongOutgoing1To1SetupTimeoutForWeb,!1)}function Id(e,t){return null==e?t:e}var bd=class{constructor(){this.skypeTokenContext={},this.aadTokenContext={},this.caeTokenContext={}}getTokenContext(e){return 4===e?this.aadTokenContext:8===e?this.caeTokenContext:1===e?this.skypeTokenContext:void 0}getTokenExpiry(e,t){return 4===e?this.aadTokenContext?.expiryTime:8===e?this.caeTokenContext?.expiryTime:1===e?this.skypeTokenContext?.expiryTime:(t.info("[getTokenExpiry] unrecognized token type, return Number.MAX_VALUE"),Number.MAX_VALUE)}getToken(e,t,i,n){return 8&e&&this.caeTokenContext?.token&&this.caeTokenContext.token!==n?{token:this.caeTokenContext.token,tokenType:8}:4&e&&this.aadTokenContext?.token&&this.aadTokenContext.token!==n?{token:this.aadTokenContext.token,tokenType:4}:1&e&&this.skypeTokenContext?.token&&this.skypeTokenContext.token!==n?{token:this.skypeTokenContext.token,tokenType:1}:(i.info("[getToken] no cached token found of token type: ${tokenType}"),null)}setToken(e,t,i,n){switch(e){case 4:this.aadTokenContext.factorsJson=i,this.aadTokenContext.tokenType=e,this.aadTokenContext.token=t,this.aadTokenContext.expiryTime=n;break;case 1:this.skypeTokenContext.factorsJson=i,this.skypeTokenContext.tokenType=e,this.skypeTokenContext.token=t,this.skypeTokenContext.expiryTime=n;break;case 8:this.caeTokenContext.factorsJson=i,this.caeTokenContext.tokenType=e,this.caeTokenContext.token=t,this.caeTokenContext.expiryTime=n;break;default:throw new Error(`Invalid tokenType ${e}`)}}clearExpiredTokens(e){const t=Math.round(Date.now()/1e3);this.caeTokenContext?.expiryTime<=t&&(this.resetToken(8),e?.info("[cacheTokenManager] reset expired cae token")),this.aadTokenContext?.expiryTime<=t&&(this.resetToken(4),e?.info("[cacheTokenManager] reset expired aad token")),this.skypeTokenContext?.expiryTime<=t&&(this.resetToken(1),e?.info("[cacheTokenManager] reset expired skype token"))}resetToken(e){8===e?this.caeTokenContext={}:4===e?this.aadTokenContext={}:1===e&&(this.skypeTokenContext={})}},Ad=class{constructor(e){this.timers={},this.startTimer=(e,t,i,n)=>{this.logger.info(`startTimer called for :  ${e}`);const r=window.setTimeout(t,1e3*i),s=n?`${e}${n}`:e;this.timers[s]=r},this.stopTimer=(e,t)=>{this.logger.info(`stopTimer called for : ${e}`);const i=t?`${e}${t}`:e;this.timers.hasOwnProperty(i)&&(clearTimeout(this.timers[i]),delete this.timers[i])},this.dispose=()=>{this.logger.info("timeoutManager :: dispose"),Object.keys(this.timers).forEach((e=>{this.stopTimer(e)}))},this.logger=e}},Rd=class{constructor(e,t,i,n){this.tokenProvider=t,this.tokenCachingEnabled=!1,this.enableTokenCacheForGenericTokenAPI=!1,this.cachedToken="",this.lastTokenType=1,this.lastToken="",this.clientSupportsGenericTokenAPI=!1,this.stopTimerFlag=!1,this.tokensPromiseMap={},this.logger=e.createChild("TokenManager"),i&&this.updateTokenSettings(i),this.cacheTimers=new Ad(e),this.cacheTokenManager=new bd,this.telemetryManager=n,this.nextRefreshTimePointInSeconds=Number.MAX_VALUE}deletePromisesByTriggeredByRefresh(e,t){if(this.tokensPromiseMap[e]){const i=this.tokensPromiseMap[e];for(let n=i.length-1;n>=0;n--)i[n]?.tokenRequestOptions.triggeredByRefresh===t&&this.tokensPromiseMap[e].splice(n,1)}}startTokenRefreshTimer(e){const t="startTokenRefreshTimer";if(!this.enableRefreshToken)return void this.logger.info("[startTokenRefreshTimer] token refresh is disabled");if(this.stopTimerFlag)return this.logger.info("[startTokenRefreshTimer] stopTimerFlag=true so cancel timer"),void this.cacheTimers.dispose();this.logger.info(`[startTokenRefreshTimer] starting token refresh timer timeToStartInMilliseconds=${e}`);const i=Ms(),n=function(e){return e/1e3}(e),r=i+n;this.nextRefreshTimePointInSeconds===Number.MAX_VALUE||this.nextRefreshTimePointInSeconds<i||r<this.nextRefreshTimePointInSeconds?(this.logger.info("[startTokenRefreshTimer] cancelling current refresh timer to create new one with shorter time"),this.cacheTimers.stopTimer(t),this.nextRefreshTimePointInSeconds=r,this.logger.info(`[startTokenRefreshTimer] start new timer with timeout=${n} at time=${i}`),this.cacheTimers.startTimer(t,(()=>{this.nextRefreshTimePointInSeconds=Number.MAX_VALUE,this.refreshToken()}),n)):this.logger.info("[startTokenRefreshTimer] no need to set a new refresh timer")}async refreshTokenWithContext(e){const t={triggeredByRefresh:!0},i=ss(),n={causeId:i},r=Date.now();let s,a,o,c=2;this.logger.info(`[${i}][refreshTokenWithContext] refreshing token tokenType=${e.tokenType} factorsJson=${e.factorsJson}`);try{const t=this.onTokenRequired({factorsJson:e.factorsJson,tokenType:e.tokenType,requestMetadataJson:n,invalidToken:void 0,isUnauthorized:void 0,triggeredByRefresh:!0}),r=await this.timeoutPromiseRace(t,this.enableRefreshTokenRetryInSeconds,"ActiveRefresh Token Timeout");s=Date.now(),o=r?.causeId,this.lastTokenType=r?.tokenType,c=1,s=Date.now(),this.logger.info(`[${i}][refreshTokenWithContext] refresh token success for factorsJson ${e.factorsJson} and tokenType ${e.tokenType}`)}catch(t){a=t,o=a?.causeId,t?.timeOut?(this.logger.info(`[${i}][refreshTokenWithContext] refresh token timeout, UI did not respond with token in time ${Ne(t)}`),c=5):(this.logger.info(`[${i}][refreshTokenWithContext] failed to refresh token, UI did not respond with token ${Ne(t)}`),c=2),s=Date.now(),this.deletePromisesByTriggeredByRefresh(e.factorsJson,!0)}finally{t&&(t.requestCauseId=i,t.responseCauseId=o,t.supportTokenApi=this.clientSupportsGenericTokenAPI,t.requestTokenFactors=e.factorsJson,t.tokenRequestTime=r,t.tokenResponseTime=s,t.tokenRequestStatus=c,t.requestTokenType=e.tokenType,t.foundInCache=!1,t.responseTokenType=e.tokenType,t.errorCode=a?.errorCode,t.errorSubCode=a?.errorSubCode,this.sendTokenTelemetry(t))}}refreshToken(){const e=this.cacheTokenManager.getTokenContext(4),t=this.cacheTokenManager.getTokenContext(8),i=this.cacheTokenManager.getTokenContext(1);if(!this.clientSupportsGenericTokenAPI)return void this.logger.info("[refreshToken] new Token Api is not spported");if(!e&&!t&&!i)return void this.logger.info("[refreshToken] no cached tokens available to refresh");const n=Ms()+this.refreshTimeBeforeTokenTimeoutInSeconds;let r=Number.MAX_VALUE,s=!1;if(e)if(e.expiryTime>n){const t=e?.expiryTime-n;t<r&&(r=t)}else e.expiryTime<=n&&(this.refreshTokenWithContext(e),s=!0);if(t)if(t.expiryTime>n){const e=t?.expiryTime-n;e<r&&(r=e)}else t.expiryTime<=n&&(this.refreshTokenWithContext(t),s=!0);if(i)if(i.expiryTime>n){const e=i?.expiryTime-n;e<r&&(r=e)}else i.expiryTime<=n&&(this.refreshTokenWithContext(i),s=!0);s&&this.enableRefreshTokenRetry&&this.enableRefreshTokenRetryInSeconds>0&&this.enableRefreshTokenRetryInSeconds<r&&(r=this.enableRefreshTokenRetryInSeconds),r>=0&&r!==Number.MAX_VALUE&&this.startTokenRefreshTimer(Ds(r))}async getTokenWithTokenType(e,t=!1,i,n){this.logger.info(`[${e}][getTokenWithTokenType] call with factorJson=${i?.factorsJson} and request tokenType ${i?.tokenType}`);const{factorsJson:r,requestMetadataJson:s,invalidToken:a,isUnauthorized:o}=i||{},c=Date.now(),l=i?.tokenType;let d,h,u,g=2;this.clearExpiredTokens(),this.startTokenRefreshTimer(1);try{if(t)this.invalidateCachedTokenWithTokenType(l,a,r);else if(this.enableTokenCacheForGenericTokenAPI){const t=this.cacheTokenManager.getToken(l,r,this.logger,a);if(t?.token)return this.logger.info(`[${e}][getTokenWithTokenType] returning cached token for factorsJson ${r} and request tokenType ${l}, response tokenType ${t.tokenType}`),g=3,d=Date.now(),this.lastTokenType=t.tokenType,t}this.logger.info(`[${e}][getTokenWithTokenType] fetching new token for factorsJson ${r} and tokenType ${l}`);const i=s||{};i.causeId=e;const n=this.onTokenRequired({factorsJson:r,tokenType:l,requestMetadataJson:i,invalidToken:a,isUnauthorized:o,triggeredByRefresh:!1}),c=await this.timeoutPromiseRace(n,Yr.TIMEOUT_VALUES_IN_SECONDS.TOKEN_REQUIRED_TIMEOUT,"Token not received from UI in time");return d=Date.now(),u=c?.causeId,this.lastTokenType=c?.tokenType,g=1,this.logger.info(`[${e}][getTokenWithTokenType] fetching new token success for factorsJson ${r} and tokenType ${l}`),c}catch(t){throw this.logger.info(`[${e}][getTokenWithTokenType] failed to fetch token ${Ne(t)}`),h=t,u=h?.causeId,h.timeOut&&(g=4),this.deletePromisesByTriggeredByRefresh(r,!1),t}finally{const t=!n?.tokenTelemetryData,r=t?{}:n?.tokenTelemetryData;r&&(r.requestCauseId=e,r.responseCauseId=u,r.supportTokenApi=this.clientSupportsGenericTokenAPI,r.requestTokenFactors=i?.factorsJson,r.tokenRequestTime=c,r.tokenResponseTime=d,r.tokenRequestStatus=g,r.requestTokenType=i?.tokenType,r.foundInCache=3===g,r.responseTokenType=this.lastTokenType,r.timeToResponse=d?d-c:d,r.errorCode=h?.errorCode,r.errorSubCode=h?.errorSubCode),(!n||t&&!n.signalingSession)&&(this.logger.info("[getTokenWithTokenType] TokenContext is not provided, sending token telemetry to Token table"),this.sendTokenTelemetry(r))}}async onTokenRequired(e){const{factorsJson:t,tokenType:i,requestMetadataJson:n,invalidToken:r,isUnauthorized:s,triggeredByRefresh:a}=e;if(this.logger.info(`[onTokenRequired] factorsJson=${t} tokenType=${i}`),!i)return this.logger.info(`[onTokenRequired] factorsJson=${t} with no token type`),Promise.reject({errorCode:Yr.HTTP_STATUS_CODES.UNAUTHORIZED,errorSubCode:0,causeId:n?.causeId});if(this.tokensPromiseMap[t]&&!a)for(const e of this.tokensPromiseMap[t])if(e.tokenRequestOptions.tokenType===i)return this.logger.info(`[onTokenRequired] factorsJson=${t} and tokenType ${i} has pending request`),e.defered.promise;this.tokensPromiseMap[t]||(this.tokensPromiseMap[t]=[]);const o=vi();return this.tokensPromiseMap[t].push({tokenRequestOptions:e,defered:o}),this.tokenCallback({factorsJson:t,tokenType:i,requestMetadataJson:n,invalidToken:r,isUnauthorized:s}),o.promise}setTokenCaching(e,t){this.tokenCachingEnabled!==e&&(this.logger.info(`[authTokenManager]setTokenCaching=${e}`),this.tokenCachingEnabled=e)}setTokenCachingForGenericTokenAPI(e,t){this.enableTokenCacheForGenericTokenAPI!==e&&(this.logger.info(`[authTokenManager]setTokenCachingForGenericTokenAPI=${e}`),this.enableTokenCacheForGenericTokenAPI=e)}calculateTokenExpiry(e,t,i){const{factorsJson:n,tokenType:r}=t;let s=i-Ms(),a=s,o=i;if(s&&s>0&&s>this.refreshTimeBeforeTokenTimeoutInSeconds){switch(r){case 4:s>this.aadTokenExpirationTimeInSeconds&&(s=this.aadTokenExpirationTimeInSeconds);break;case 8:s>this.caeTokenExpirationTimeInSeconds&&(s=this.caeTokenExpirationTimeInSeconds);break;default:s>3600&&(s=3600)}a=s-this.refreshTimeBeforeTokenTimeoutInSeconds,o=a+Ms()}return this.logger.info(`[${e}][calculateTokenExpiry] calculate expiry to ${o} tokenType=${r} factorsJson=${n}`),o}addToCache(e,t,i,n){this.clearExpiredTokens(),this.cacheTokenManager.setToken(e,t,i,n)}clearExpiredTokens(){this.forceClearExpiredTokens&&this.cacheTokenManager.clearExpiredTokens(this.logger)}async getToken(e,t=!1,i,n){if(this.clientSupportsGenericTokenAPI){this.logger.info(`[${e}][getToken] callingTokenAPI is enabled so using new API to fetch it`);const{token:r}=await this.getTokenWithTokenType(e,t,i,n);return r}const r=Date.now();let s,a,o=2;try{if(t&&this.invalidateCachedToken(e),this.cachedToken&&this.tokenCachingEnabled)return this.logger.info(`[${e}][getToken] returning cached token`),o=3,Promise.resolve(this.cachedToken);this.logger.info(`[${e}][getToken] fetching new token`);const i=await this.tokenProvider();return s=Date.now(),i?(this.tokenCachingEnabled&&(this.cachedToken=i),o=1,this.lastToken=i,this.lastTokenType=1,this.logger.info(`[${e}][getToken] fetching new token success`),i):(this.logger.info(`[${e}][getToken] received empty token`),Promise.reject("Received empty token"))}catch(t){throw this.logger.info(`[${e}][getToken] failed to fetch token=${Ne(t)}`),a=t,this.cachedToken="",t}finally{const t=n?.tokenTelemetryData;t&&(t.requestCauseId=e,t.supportTokenApi=this.clientSupportsGenericTokenAPI,t.requestTokenFactors=i?.factorsJson,t.tokenRequestTime=r,t.tokenResponseTime=s,t.tokenRequestStatus=o,t.requestTokenType=i?.tokenType,t.foundInCache=3===o,t.responseTokenType=this.lastTokenType,t.timeToResponse=s?s-r:s,t.errorCode=a?.errorCode,t.errorSubCode=a?.errorSubCode)}}invalidateCachedToken(e){this.cachedToken&&(this.logger.info(`[${e}][invalidateCachedToken]`),this.cachedToken="")}invalidateCachedTokenWithTokenType(e,t,i){8===e&&this.cacheTokenManager.getToken(8,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(8)),4===e&&this.cacheTokenManager.getToken(4,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(4)),1===e&&this.cacheTokenManager.getToken(1,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(1))}getLastToken(e){return this.logger.info(`[${e}][getLastToken]`),this.lastToken}getLastTokenWithTokenType(e,t,i){return this.logger.info(`[${e}][getLastTokenWithTokenType] with Token Type: ${t}`),this.cacheTokenManager.getToken(t,i,this.logger)?.token}async timeoutPromiseRace(e,t,i){let n;const r=new Promise(((e,r)=>{n=window.setTimeout((()=>{r({phrase:i,timeOut:!0})}),Ds(t))}));return Promise.race([e.then((e=>(clearTimeout(n),e))),r])}getLastTokenType(e){return this.logger.info(`[${e}][getLastTokenType] lastTokenType=${this.lastTokenType}`),this.lastTokenType}updateTokenSettings(e){const{clientSupportsGenericTokenAPI:t,aadTokenExpirationTimeInSeconds:i,caeTokenExpirationTimeInSeconds:n,refreshTimeBeforeTokenTimeoutInSeconds:r,enablePublishTokenTelemetry:s,enableRefreshToken:a,forceClearExpiredTokens:o,enableRefreshTokenRetry:c,enableRefreshTokenRetryInSeconds:l}=e;this.logger.info(`updateTokenSettings ${JSON.stringify(e)}`),this.clientSupportsGenericTokenAPI=t??this.clientSupportsGenericTokenAPI,this.aadTokenExpirationTimeInSeconds=i??this.aadTokenExpirationTimeInSeconds,this.caeTokenExpirationTimeInSeconds=n??this.caeTokenExpirationTimeInSeconds,this.refreshTimeBeforeTokenTimeoutInSeconds=r??this.refreshTimeBeforeTokenTimeoutInSeconds,this.enablePublishTokenTelemetry=s??this.enablePublishTokenTelemetry,this.forceClearExpiredTokens=o??this.forceClearExpiredTokens,this.enableRefreshToken=a??this.enableRefreshToken,this.enableRefreshTokenRetry=c??this.enableRefreshTokenRetry,this.enableRefreshTokenRetryInSeconds=l??this.enableRefreshTokenRetryInSeconds}updateToken(e,t,i,n,r){if(this.logger.info(`[${n}][updateToken] UI replies a token with factorsJson=${e} updateMetadata=${JSON.stringify(t)} tokenExpirySecSinceEpoch?=${r}`),t.error){this.logger.info(`[${n}][updateToken] UI replies with error ${t.error} for factorsJson ${e}`);for(const i of this.tokensPromiseMap[e])i.tokenRequestOptions.requestMetadataJson.causeId===n&&i.defered.reject({phrase:t.error?.phrase,errorCode:t.error?.code,errorSubCode:t.error?.subCode,causeId:n});return}if(!i){this.logger.info(`[${n}][updateToken] received empty token`);for(const t of this.tokensPromiseMap[e])t.tokenRequestOptions.requestMetadataJson.causeId===n&&t.defered.reject({phrase:"Received empty token",causeId:n});return}if(r>Ms()&&this.enableTokenCacheForGenericTokenAPI){this.logger.info(`[${n}][updateToken] caching Token with tokenType=${t.tokenType}`);const s={factorsJson:e,tokenType:t.tokenType,invalidToken:i};this.addToCache(t.tokenType,i,e,this.calculateTokenExpiry(n,s,r))}if(!this.tokensPromiseMap[e]){this.logger.warn(`[updateToken]: UI try to update token with invalid factorsJson=${e}`);const i={responseCauseId:n,supportTokenApi:this.clientSupportsGenericTokenAPI,requestTokenFactors:e,tokenResponseTime:Date.now(),tokenRequestStatus:6,responseTokenType:t.tokenType};return void this.sendTokenTelemetry(i)}if(this.tokensPromiseMap[e]){const r=this.tokensPromiseMap[e];for(let s=r.length-1;s>=0;s--)(r[s]?.tokenRequestOptions.tokenType&t.tokenType)>0&&(r[s].defered.resolve({token:i,tokenType:t.tokenType,causeId:n}),this.tokensPromiseMap[e].splice(s,1))}if(this.logger.info(`[${n}][updateToken] resolved and upateToken with factorsJson=${e} tokenType=${t.tokenType}`),0===this.tokensPromiseMap[e].length&&delete this.tokensPromiseMap[e],4!==t.tokenType&&8!==t.tokenType&&1!==t.tokenType)return;if(Object.keys(this.tokensPromiseMap).length>0)for(const r of Object.values(this.tokensPromiseMap))for(let s=r.length-1;s>=0;s--){const a=r[s];a.tokenRequestOptions.factorsJson!==e&&(a.tokenRequestOptions.tokenType&t.tokenType)>0&&!a.tokenRequestOptions.isUnauthorized&&(a.defered.resolve({token:i,tokenType:t.tokenType,causeId:n}),r.splice(s,1))}for(const e of Object.keys(this.tokensPromiseMap))0===this.tokensPromiseMap[e].length&&delete this.tokensPromiseMap[e];const s=r-Ms();this.startTokenRefreshTimer(s>=0?Ds(s):0)}setTokenRequiredCallBack(e){this.tokenCallback=e}setDisableTimerFlag(e){this.logger.info(`[setDisableTimerFlag] set disableTimerFlag to ${e}`),this.stopTimerFlag=e}sendTokenTelemetry(e){if(!this.enablePublishTokenTelemetry)return;const t={};t[Ed.TOKEN_TELEMETRY]=JSON.stringify(e),this.telemetryManager?(this.logger.info("[sendTokenTelemetry] sending token telemetry:",t),this.telemetryManager.sendEvent(dd.CONVERSATION_TOKEN,t)):this.logger.warn("[sendTokenTelemetry] telemetryManager is undefined, cannot send token telemetry")}dispose(){this.cacheTimers&&this.cacheTimers.dispose()}},wd=(e,t,i,n)=>new Rd(e,t,i,n),Pd=class{constructor(e){this.piiScrubber=this.getPiiScrubber(e)}scrubParticipantsList(e){const t=[];return Array.isArray(e)&&e.forEach((e=>t.push(this.scrubMriOrOmit(e)))),t}scrubMriOrOmit(e){return"string"==typeof e?this.piiScrubber.mri(e):this.piiScrubber.omit(e)}static scrubDisplayNamesFromResponse(e){return Le(e).replace(/"displayName": "[a-z]+"/gi,'"displayName": "(redacted)"')}getPiiScrubber(e){return e&&"function"==typeof e.omit&&"function"==typeof e.mri?e:{omit:()=>"<pii:omit/>",mri:()=>"<pii:mri/>"}}},Md=f(p);function Dd(e){switch(e){case 0:return"main-audio";case 1:return"main-video";case 2:return"applicationsharing-video";case 3:return"data"}throw new Error("Invalid media type")}function Od(e){switch(e){case"audio":return 0;case"video":return 1;case"applicationsharing-video":return 2;case"data":return 3;default:return}}function kd(e,t){return e.endpoints?.endpointDetails.find((e=>e.participantId===t))}function Nd(e,t){return e.participants.find((e=>function(e,t){return e.endpoints?.endpointDetails?.some((e=>e.participantId===t))??!1}(e,t)))}function Ld(e){return!!e?.meetingGroupDetails?.groups&&Object.keys(e.meetingGroupDetails.groups).some((e=>"stagingGroup"===e))}function xd(e,t){let i=-1;try{if(e.endpoints)e:for(const n of e.endpoints.endpointDetails)if(null!==n&&void 0!==n.mediaStreams){for(const e of n.mediaStreams)if(Od(e.type)===t){i=e.sourceId;break e}}else i=En}catch(e){return-1}return i}function Ud(e,t,i){try{if(!e.endpoints)return;for(const n of e.endpoints.endpointDetails)if(n?.mediaStreams)for(const e of n.mediaStreams)if(i===e.sourceId&&Od(e.type)===t)return n.participantId??null;return}catch(e){return}}function Fd(e){return"sendonly"===e.direction&&"applicationsharing-video"===e.label}function Vd(e){if(e.endpoints?.endpointDetails)return 1===e.endpoints.endpointDetails.length?e.endpoints.endpointDetails[0].participantId:e.endpoints.endpointDetails.find((e=>e?.mediaStreams?.some(Fd)))?.participantId}function Bd(e){let t={};if(e.stateId)t.result=e.stateId;else if(e.results){const{results:i}=e;1===i.length&&i[0].stateId&&(t.result=i[0].stateId);const n={};e.results.forEach((e=>{const{result:i}=e,r=function(e){return e.participantId||e.participant&&e.participant.id}(e);(void 0===t.code||i.code>t.code)&&(t.code=i.code,t.subCode=i.subCode),n[r]=e})),t.result=JSON.stringify(n)}else e.result&&(t={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode,resultCategories:e.result.resultCategories},e.additionalDetail&&(t.result=e.additionalDetail));return t}var Hd=class{constructor(e,t){this.broadcastContext=null,this.broadcastControllerUrl="",this.broadcastCallbackUrl="",this.broadcastState=null,this.setContext=(e=null)=>{this.logger.info("BroadcastSession :: set broadcast context",e),this.broadcastContext=e},this.getContext=()=>(this.logger.info("BroadcastSession :: get broadcast context",this.broadcastContext||null),this.broadcastContext||null),this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>"[Broadcast]"))}handleBroadcastStateChanged(e){const t=e.body;this.broadcastState=t;const i=Cs(e);this.signalingSession.telemetryHelper.recordIncomingEvent(Zo,e),this.logger.info(`[${i}] broadcast state changed=${this.broadcastState}`),this.updateBroadcastMetadata(i)}updateBroadcastCallbackUrl(e){const t=Zr(this.signalingSession,Pr.CONV_BROADCAST_UPDATE);this.broadcastCallbackUrl!==t&&(this.broadcastCallbackUrl=t,this.logger.info(`[${e}] broadcast callback url changed=${this.broadcastCallbackUrl}`),this.updateBroadcastMetadata(e))}handleBroadcastDetailsChanged(e,t){this.signalingSession.telemetryHelper.recordEvent(mo,{causeId:t}),e.activeModalities&&e.activeModalities.broadcast&&e.activeModalities.broadcast.controller!==this.broadcastControllerUrl&&(this.broadcastControllerUrl=e.activeModalities.broadcast.controller,this.broadcastAdditionalData=e.activeModalities.broadcast,this.logger.info(`[${t}] broadcast controller changed=${this.broadcastControllerUrl}`),this.signalingSessionCallback.onBroadcastMeetingConnected(Yr.SUCCESS_TRANSACTION_END,t),this.updateBroadcastMetadata(t)),!this.broadcastControllerUrl||e.activeModalities&&e.activeModalities.broadcast||(this.broadcastControllerUrl="",this.broadcastContext=null,this.logger.info(`[${t}] broadcast controller changed=${this.broadcastControllerUrl}`),this.updateBroadcastMetadata(t),this.signalingSessionCallback.onBroadcastMeetingEnded(Yr.SUCCESS_TRANSACTION_END,t))}handleAddBroadcastModalitySuccess(e,t){this.logger.info(`[${t}][handleAddBroadcastModalitySuccess]`)}handleAddBroadcastModalityFailure(e,t){this.logger.info(`[${t}][handleAddBroadcastModalityFailure]`);const i={...e.modalityFailure.broadcast};this.signalingSessionCallback.onBroadcastMeetingEnded(i,t)}updateBroadcastMetadata(e){const t={broadcastControllerUrl:this.broadcastControllerUrl,broadcastStateCallbackUrl:this.broadcastCallbackUrl,broadcastState:this.broadcastState,broadcastAdditionalData:this.broadcastAdditionalData};this.logger.info(`[${e}] update broadcast metadata=${t}`),this.signalingSessionCallback.onBroadcastMeetingUpdated&&this.signalingSessionCallback.onBroadcastMeetingUpdated(t,e)}},$d=class{static build(e,t){return new Gd(e,t)}},Gd=class{constructor(e,t){this.ontimeout=e,this.name=t}start(e){if(void 0!==this.timeoutId)throw new Error(`Timer ${this.name} already started`);return this.timeoutId=window.setTimeout((()=>this.ontimeout()),e),this}stop(){if(void 0===this.timeoutId)throw new Error(`Timer ${this.name} is not defined`);clearTimeout(this.timeoutId),this.timeoutId=void 0}},jd=class{constructor(e){this._signalingSession=e,this.baseUrl="http://broker.invalid/",this.currentSubscriptionUrl=null,this._currentSubscriptionTimeoutInSec=30,this._subscribers=[],this._disposed=!1,this._reportedResultCount=0,this._subscriptionRetryBackoffInSec=5,this._notifySubscribers=e=>{this._logger.info("_notifySubscribers"),Promise.resolve().then((()=>{e.split(",").forEach((e=>{const t=function(e){const t=e.split(/\r?\n\r?\n/),i=t[0].split(/\r?\n/),n=t[1].split(/\r?\n/),r=i.shift().split(" "),s=r[0],a=r[1]||"",o=new Xr;for(const e of i)try{const[t,i]=e.split(":").map((e=>yr.trim(e)));o.set(t,i)}catch(t){throw new Error(`Malformed header: ${e+t}`)}return{url:a,headers:o,method:s,body:n.join("")}}(Ts(e));let i=t.body;_s(t.headers)&&Es(t.headers)&&(i=Ts(i));const n={url:t.url,body:JSON.parse(i),headers:t.headers};this._logger.info("message length=",i.length,"n. of subscribers",this._subscribers.length),this._subscribers.forEach((e=>e(n)))}))})).catch((e=>{this._logger.error("_notifySubscribers, failed to decode message",e),this._signalingSession.telemetryHelper.recordEvent($o)}))},this._subscribeToBroker=(e,t)=>{if(this._disposed)return void this._logger.warn("_subscribeToBroker, disposed, ignore subscription");const i=rs();this._logger.info("_subscribeToBroker, url: ",e,",timeout in sec",t),this.currentSubscriptionUrl=e,this._currentSubscriptionTimeoutInSec=t,this._clearAllPendingTimeouts(),this._setSubscriptionTimeout(t),this._signalingSession.http.sendGetRequest({url:this.currentSubscriptionUrl,requestName:od.BROKER_SUBSCRIBE.name,customHeaders:this._getBrokerRequestHeaders(i),payload:null,skipHttpTelemetry:!this._reportSubscriptionInTelemetry(),causeId:rs(),operationType:"BrokerSubscribe"}).then(this._handleSubscriptionSuccess).catch(this._handleSubscriptionFailure)},this._clearAllPendingTimeouts=()=>{this._cancelRequestTimer&&(this._cancelRequestTimer.stop(),this._cancelRequestTimer=null),this._retryRequestTimer&&(this._retryRequestTimer.stop(),this._retryRequestTimer=null)},this._abortPendingRequest=()=>{this._signalingSession.http.cancelRequestIfPending(od.BROKER_SUBSCRIBE.name,rs())},this._setSubscriptionTimeout=e=>{this._cancelRequestTimer=$d.build((()=>{this._disposed||(this._signalingSession.http.hasPendingRequest(od.BROKER_SUBSCRIBE.name)?(this._logger.warn("timeout subscription"),this._signalingSession.telemetryHelper.recordEvent(Go),this._signalingSession.http.cancelRequestIfPending(od.BROKER_SUBSCRIBE.name,rs())):this._logger.error("Unable to resolve timeout deferred, it is not defined!"))}),"TIMEOUT").start(1e3*e)},this._handleSubscriptionSuccess=e=>{if(this._disposed)this._logger.warn("_handleSubscriptionSuccess, disposed, ignore subscription success");else if(this._reportSubscriptionInTelemetry(e)&&this._signalingSession.telemetryHelper.recordEvent(jo),e&&e.response){const t=e.response;this._logger.info("_handleSubscriptionSuccess, response",t),t.message&&this._notifySubscribers(t.message);const i=t.nextSubscribeUrl||this.currentSubscriptionUrl,n=t.expirationTimeInSec||this._currentSubscriptionTimeoutInSec;this._subscribeToBroker(i,n)}else this._logger.info("_handleSubscriptionSuccess, empty response")},this._handleSubscriptionFailure=e=>{if(this._disposed)return void this._logger.warn("_handleSubscriptionFailure, disposed, ignore subscription");if(e.status>=400&&e.status<500&&401!==e.status&&this.isNotNetworkErrors(e.status))return void this._logger.warn(`_handleSubscriptionFailure, received status ${e.status}, stop subscribing`);const t=Ne(e);this._logger.error("_handleSubscriptionFailure failed, re-subscribing",t),this._reportSubscriptionInTelemetry()&&this._signalingSession.telemetryHelper.recordEvent(qo),this._retryRequestTimer=$d.build((()=>{this._subscribeToBroker(this.currentSubscriptionUrl,this._currentSubscriptionTimeoutInSec)}),"RETRY").start(1e3*this._subscriptionRetryBackoffInSec)},this._reportSubscriptionInTelemetry=e=>(this._reportedResultCount++,this._reportedResultCount<=1),this._getBrokerRequestHeaders=e=>{const t=new Xr;return t.set(Yr.HEADERS.CONTENT_TYPE,Yr.CONTENT_TYPE.JSON),this._signalingSession.signalingAgentConfig.brokerRequestBatching&&t.set(Yr.HEADERS.BROKER_USE_BATCHING_HEADER_NAME,"1"),t},this._logger=this._signalingSession.logger.createChild("Broker"),this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration?.brokerRetryBackOffInSec&&(this._subscriptionRetryBackoffInSec=this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration.brokerRetryBackOffInSec)}subscribeToBroker(e){this._logger.info("subscribeToBroker called."),this._abortPendingRequest(),this._clearAllPendingTimeouts(),this._subscribeToBroker(e,this._currentSubscriptionTimeoutInSec)}onBrokerMessage(e){this._logger.info("onBrokerMessage callback added"),this._subscribers.push(e)}dispose(){this._disposed=!0,this._logger.info("dispose"),this._subscribers=[],this._clearAllPendingTimeouts(),this._abortPendingRequest()}isNotNetworkErrors(e){return 490!==e&&496!==e&&498!==e&&499!==e}},qd=class{constructor(e){this.requests={},this.logger=e}clear(e,t){const i=t||{code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((t=>{try{const n=parseInt(t,10);Object.keys(this.requests[n]).forEach((t=>{this.rejectOperation(n,t,e,i)}))}catch(e){this.logger.warn(`CallOperations: clear error = ${e}`)}}))}hasOperation(e,t){return this.requests.hasOwnProperty(e.valueOf())&&this.requests[e.valueOf()].hasOwnProperty(t)}getAllOperations(){return this.requests}getOperation(e,t){return this.hasOperation(e,t)?this.requests[e.valueOf()][t]:null}setOperation(e,t,i){return!this.hasOperation(e,t)&&(this.hasOwnProperty(e.valueOf())||(this.requests[e.valueOf()]={}),this.requests[e.valueOf()][t]=i,!0)}rejectOperation(e,t,i,n){if(this.hasOperation(e,t)){const i=e.valueOf(),r=this.requests[i][t].promise;delete this.requests[i][t],r.reject(n)}}resolveOperation(e,t,i,n){if(this.hasOperation(e,t)){const n=e.valueOf(),r=this.requests[n][t].promise;delete this.requests[n][t],r.resolve(i)}}},Wd=class{constructor(e){this.logger=e,this.localRequests=new qd(e)}dispose(e,t,i){this.logger.info(`[${i}][dispose]`),this.rejectAllPendingOperations(e,t)}hasPendingOperation(e,t,i){return this.logger.info(`[${i}][hasPendingOperation] ${e} ${we(t)}}`),this.localRequests.hasOperation(e,t)}rejectPendingOperation(e,t,i,n,r){this.logger.info(`[${r}][rejectPendingOperation] ${e} ${t} reason: ${i} endCode: ${n}`),this.localRequests.rejectOperation(e,t,i,n)}resolvePendingOperation(e,t,i,n){this.logger.info(`[${n}][resolvePendingOperation]: ${we(t)}`),this.localRequests.resolveOperation(e,t,i,n)}setPendingOperation(e,t,i,n){return this.logger.info(`[${n}][setPendingOperation] ${e} value: ${i}`),this.localRequests.setOperation(e,t,i)}rejectAllPendingOperations(e,t){this.logger.info("rejectLocalQueuedOperations"),this.localRequests.clear(e,t)}};function zd(e,t){return cs(e,"signalingSession cannot be null"),cs(t,"content cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[]},contentSharing:{identifier:t.contentIdentifier,subject:t.subject,sessionState:t.sessionState,sequenceNumber:t.sequenceNumber,links:{sessionUpdate:Zr(e,Pr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:Zr(e,Pr.CONV_CONTENT_SHARING_END)}},links:{addModalitySuccess:Zr(e,Pr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:Zr(e,Pr.CONV_ADD_MODALITY_FAILURE)}}}}function Jd(e){return cs(e,"signalingSession cannot be null"),{payload:{contentSharing:{links:{sessionUpdate:Zr(e,Pr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:Zr(e,Pr.CONV_CONTENT_SHARING_END)}},participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}function Kd(e,t){return cs(e,"signalingSession cannot be null"),ls(t),{payload:{contentSharingTransactionEnd:t,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}function Yd(e){return cs(e,"signalingSession cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}function Qd(e){return cs(e,"signalingSession cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},links:{sessionUpdate:Zr(e,Pr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:Zr(e,Pr.CONV_CONTENT_SHARING_END)}}}}function Xd(e){return cs(e,"signalingSession cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}function Zd(e,t,i){return cs(e,"signalingSession cannot be null"),cs(t,"sessionState cannot be null"),cs(i,"sequenceNumber cannot be null"),{payload:{sessionUpdateSequenceNumber:i,sessionState:t,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}var eh=class{constructor(){this.msElapsed=0,this.isPaused=!1,this.startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this.startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this.startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this.startTime,this.durationInMinutes=()=>{const e=this.duration()/6e4;return Math.ceil(e)},this.durationInSeconds=()=>{const e=this.duration()/1e3;return Math.ceil(e)}}};function th(){return new eh}var ih=class{constructor(e,t,i,n){this.signalingSession=e,this.correlationId=t,this.sessionId=null,this.fsmState=Yr.CONTENT_SHARING_FSM_STATE.IDLE,this.addSessionPromise=null,this.removeSessionPromise=null,this.confirmInRosterPromise=null,this.links={},this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.disposed=!1,this.isPresenter=!1,this.FSM_STATES=Yr.CONTENT_SHARING_FSM_STATE,this.logger=e.logger.createChild((()=>`[${this.fsmState}][cs=${this.sessionId}][cc=${this.correlationId}]`)),i&&(this.sessionId=i),n&&(this.links=n)}start(e,t,i,n){if(this.logger.info(`[${n}][start]`),os(e,"Correct addModality url is not provided"),!this.checkState("start",this.FSM_STATES.IDLE,this.addSessionPromise))return Promise.reject(null);this.addSessionPromise=i,this.confirmInRosterPromise=Is(),this.fsmState=this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.addTelemetryOperation(od.ADD_CONTENT_SHARING_MODALITY.name,{causeId:n});const r=new Xr;return r.set(Yr.HEADERS.CONTENT_SHARING_CORRELATION_ID,this.correlationId),this.signalingSession.http.sendPostRequest({url:e,payload:zd(this.signalingSession,t),requestName:od.ADD_CONTENT_SHARING_MODALITY.name,customHeaders:r,onceTrouterReady:()=>{this.startContentSharingTimer(n)},causeId:n}).then((()=>{this.disposed||(this.presenterMri=this.signalingSession.participantManager.localParticipant.id,this.isPresenter=!0)})).catch((e=>{const t=Ss(e,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${n}][start] error: ${Ne(t)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise(Ne(e),t.error)),Promise.reject(null)}))}delete(e,t){this.logger.info(`[${t}][delete]`);let i=!1;if(this.fsmState===this.FSM_STATES.IDLE)return this.logger.info(`[${t}][delete] skipped because state is already ${this.fsmState}`),e.resolve(),Promise.resolve();if(this.fsmState===this.FSM_STATES.CONTENT_SHARING_START_INITIATED)i=!0,this.rejectPendingPromise("Session delete called before start was finished");else if(!this.checkState("delete",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return Promise.reject(null);i||os(this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER],"Correct controller url is not set"),this.removeSessionPromise=e,this.fsmState=this.FSM_STATES.CONTENT_SHARING_DELETE_INITIATED;const n=th(),r=this.addTelemetryOperation(od.DELETE_CONTENT_SHARING.name,{causeId:t});return(i?Promise.resolve(void 0):this.signalingSession.http.sendDeleteRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER],requestName:od.DELETE_CONTENT_SHARING.name,payload:Kd(this.signalingSession,{code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED}),causeId:t})).then((()=>{if(!this.disposed){const e={success:!0,duration:n.duration()};i&&(e.skipReason="Session delete called before start was finished"),this.updateTelemetryOperation(r,e),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}})).catch((e=>{const i=Ss(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][delete] error: ${Ne(i)}`),!this.disposed){const e={success:!1,duration:n.duration()};this.updateTelemetryOperation(r,e),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}return Promise.reject(null)}))}join(e,t){if(this.logger.info(`[${t}][join]`),os(this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER],"Correct joinContentSharing url is not provided"),!this.checkState("join",this.FSM_STATES.IDLE,e))return;this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.addSessionPromise=e,this.fsmState=this.FSM_STATES.CONTENT_SHARING_JOIN_INITIATED;const i=th(),n=this.addTelemetryOperation(od.JOIN_CONTENT_SHARING.name,{causeId:t});this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER],payload:Jd(this.signalingSession),requestName:od.JOIN_CONTENT_SHARING.name,causeId:t}).then((e=>{if(!this.disposed){const t={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,t),this.processStartOrJoinSuccess(e.response),this.resolvePendingPromise(e.response)}})).catch((e=>{const r=Ss(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][join] error: ${Ne(r)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const s=r.error;this.rejectPendingPromise(Ne(e),s)}}))}takeControl(e,t){if(this.logger.info(`[${t}][takeControl]`),os(this.links[Yr.LINKS.CONTENT_SHARING_TAKE_CONTROL],"correct contentSharingTakeControl url is not provided"),!this.checkState("takeControl",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return;const i=th(),n=this.addTelemetryOperation(od.TAKE_CONTROL_CONTENT_SHARING.name,{causeId:t});this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_TAKE_CONTROL],payload:Yd(this.signalingSession),requestName:od.TAKE_CONTROL_CONTENT_SHARING.name,withoutTrouter:!0,causeId:t}).then((t=>{if(!this.disposed){const r={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,r);const s={contentIdentifier:t.response.identifier,presenter:t.response.presenter.id,subject:t.response.subject||null,sessionState:t.response.sessionState||null};e.resolve(s)}})).catch((r=>{const s=Ss(r,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][takeControl] error: ${Ne(s)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const a=new Error(Ne(r));a.endCode=s.error,e.reject(a)}}))}updateSessionState(e,t,i){if(this.logger.info(`[${i}][updateSessionState]`),os(this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],"Correct sendUpdateSessionState url is not provided"),!this.checkState("updateSessionState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,t))return;const n=th(),r=this.addTelemetryOperation(od.UPDATE_SESSION_STATE_CONTENT_SHARING.name,{causeId:i});this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],payload:Zd(this.signalingSession,e,this.nextClientSequenceNumberToUse++),requestName:od.UPDATE_SESSION_STATE_CONTENT_SHARING.name,causeId:i}).then((()=>{if(!this.disposed){const e={success:!0,duration:n.duration()};this.updateTelemetryOperation(r,e),t.resolve()}})).catch((e=>{const s=Ss(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${i}][updateSessionState] error: ${Ne(s)}`),!this.disposed){const i={success:!1,duration:n.duration()};this.updateTelemetryOperation(r,i);const a=new Error(Ne(e));a.endCode=s.error,t.reject(a)}}))}updateParticipantState(e,t){if(this.logger.info(`[${t}][updateParticipantState]`),os(this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],"correct confirmContentSharingView url is not provided"),!this.checkState("updateParticipantState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return;const i=th(),n=this.addTelemetryOperation(od.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,{causeId:t});this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],payload:Xd(this.signalingSession),requestName:od.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,withoutTrouter:!0,causeId:t}).then((()=>{if(!this.disposed){const t={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,t),e.resolve()}})).catch((r=>{const s=Ss(r,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][updateParticipantState] error: ${Ne(s)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const a=new Error(Ne(r));a.endCode=s.error,e.reject(a)}}))}updateNotificationLinks(e){if(this.logger.info(`[${e}][updateNotificationLinks]`),os(this.links[Yr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],"correct notificationLinks url is not provided"),!this.checkState("updateState",this.FSM_STATES.CONTENT_SHARING_CONNECTED))return;const t=th(),i=this.addTelemetryOperation(od.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,{causeId:e});this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],payload:Qd(this.signalingSession),requestName:od.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,withoutTrouter:!0,causeId:e}).then((()=>{if(!this.disposed){const e={success:!0,duration:t.duration()};this.updateTelemetryOperation(i,e)}})).catch((n=>{const r=Ss(n,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${e}][updateNotificationLinks] error: ${Ne(r)}`),!this.disposed){const e={success:!1,duration:t.duration()};this.updateTelemetryOperation(i,e)}}))}confirmInRoster(){this.confirmInRosterPromise&&this.confirmInRosterPromise.isPending&&(this.logger.info("Confirmed in roster"),this.confirmInRosterPromise.resolve())}handleAddModalitySuccess(e,t){return this.logger.info(`[${t}][handleAddModalitySuccess]`),this.checkState("handleAddModalitySuccess",this.FSM_STATES.CONTENT_SHARING_START_INITIATED)?e.modalitySuccess&&e.modalitySuccess.contentSharing?(this.addTelemetryOperation(uo,{causeId:t}),this.processStartOrJoinSuccess(e.modalitySuccess.contentSharing),this.confirmInRosterPromise.promise.then((()=>{delete this.confirmInRosterPromise,this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.resolvePendingPromise(e.modalitySuccess.contentSharing)})),!0):(this.addTelemetryOperation(uo,{causeId:t,skipReason:"no content sharing blob"}),this.logger.info(`[${t}][handleAddModalitySuccess] ignored because modalitySuccess was missing or did not contain content sharing blob`),!1):(this.logger.info(`[${t}][handleAddModalitySuccess] ignored because session is not waiting to start`),!1)}handleAddModalityFailure(e,t){if(this.logger.info(`[${t}][handleAddModalityFailure]`),!this.checkState("handleAddModalityFailure",[this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.FSM_STATES.CONTENT_SHARING_CONNECTED]))return!1;if(!e.modalityFailure||!e.modalityFailure.contentSharing)return this.addTelemetryOperation(go,{causeId:t,skipReason:"no content sharing blob"}),!1;const i=e.modalityFailure.contentSharing;this.addTelemetryOperation(go,{reason:i,causeId:t});const n={...i};return this.sendTelemetryData(n),this.rejectPendingPromise(n.phrase,n),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_MODALITY),!0}handleStartFromRoster(e,t){this.logger.info(`[${t}][handleStartFromRoster]`),this.addTelemetryOperation(lo,{causeId:t})}handleStopFromRoster(e,t){this.logger.info(`[${t}][handleStopFromRoster]`),this.addTelemetryOperation(ho,{causeId:t}),this.sendTelemetryData(e)}handleStop(e,t){if(this.logger.info(`[${t}][handleStop]`),this.isSelfInitiatedAction(e))return this.logger.info(`[${t}][handleStop]handleStop skipped because session was ended by self`),!1;const i={...e.contentSharingTransactionEnd};return this.addTelemetryOperation(co,{causeId:t}),this.sendTelemetryData(i),!0}handleUpdate(e,t){return this.logger.info(`[${t}][handleUpdate]`),e.sequenceNumber<=this.lastUpdateSequenceNumber?(this.logger.info(`handleUpdate skipped because of old sequence number: last received ${this.lastUpdateSequenceNumber}, update contained ${e.sequenceNumber}`),this.addTelemetryOperation(oo,{causeId:t,skipReason:"old sequence number"}),!1):(this.lastUpdateSequenceNumber=e.sequenceNumber,this.isPresenter=e.presenter.id===this.signalingSession.participantManager.localParticipant.id,this.addTelemetryOperation(oo,{causeId:t}),!0)}dispose(e,t){this.logger.info(`[${t}][dispose]`),this.disposed=!0,this.rejectPendingPromise("call ended",e||{code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED}),this.addTelemetryOperation(Ja,{causeId:t}),this.sendTelemetryData(e)}rejectPendingPromise(e,t){this.logger.info("rejectPendingPromise");const i=new Error(e);t&&(i.endCode=t),this.removeSessionPromise&&(this.removeSessionPromise.reject(i),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.reject(i),this.addSessionPromise=null)}resolvePendingPromise(e){this.logger.info("resolvePendingPromise");let t=null;e&&(t={sessionId:e.sessionId,correlationId:e.contentSharingCorrelationId,contentIdentifier:e.identifier,presenter:e.presenter.id,subject:e.subject||null,sessionState:e.sessionState||null}),this.removeSessionPromise&&(this.removeSessionPromise.resolve(t),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.resolve(t),this.addSessionPromise=null)}processStartOrJoinSuccess(e){this.logger.info("processStartOrJoinSuccess"),this.sessionId=e.sessionId,this.fsmState=this.FSM_STATES.CONTENT_SHARING_CONNECTED,this.lastUpdateSequenceNumber=-1,this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER]=e.links.contentSharingController,this.links[Yr.LINKS.CONTENT_SHARING_TAKE_CONTROL]=e.links.takeControl,this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE]=e.links.updateSessionState,this.links[Yr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE]=e.links.sync,this.links[Yr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS]=e.links.notificationLinks,this.links[Yr.LINKS.CONTENT_SHARING_LEAVE]=e.links.leave}checkState(e,t,i){let n;if(n="string"==typeof t?this.fsmState===t:t.indexOf(this.fsmState)>-1,n)return!0;{const n=`${e} requires state ${t}, but state is ${this.fsmState}`;return this.logger.error(n),i&&i.reject(n),!1}}isSelfInitiatedAction(e){return e.presenter.participantId===this.signalingSession.participantManager.localParticipant.participantId}startContentSharingTimer(e){this.logger.info("startContentSharingTimer"),this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.ADD_MODALITY,(()=>{this.addTelemetryOperation(Js,{causeId:e}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise("timed out waiting for ContentSharing to start",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT})}),Yr.TIMEOUT_VALUES_IN_SECONDS.ADD_MODALITY_TIMEOUT)}addTelemetryOperation(e,t){return this.signalingSession.telemetryHelper.addContentSharingOperation(this.correlationId,e,t)}updateTelemetryOperation(e,t){this.signalingSession.telemetryHelper.updateContentSharingOperation(this.correlationId,e,t)}sendTelemetryData(e){this.signalingSession.telemetryHelper.sendContentSharingTelemetryData(this.correlationId,this.signalingSession.sessionId,this.isPresenter,e,this.links[Yr.LINKS.CONTENT_SHARING_CONTROLLER],this.sessionId)}},nh=class{constructor(e,t){this.contentSharingToStartCallWith=null,this.contentSharingSessions={},this.DEFAULT_STOP_REASON={code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.REMOTE_USER_INITIATED},this.DEFAULT_STOP_ID="8:unknown",this.deleteContentSharingAsync=(e,t)=>{this.logger.info(`[${t}][deleteContentSharingAsync]`);const i=Is();let n=this.contentSharingSessions[e];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===e&&(n=this.pendingSessionToStart),n){const r=()=>{this.contentSharingSessions[e]&&delete this.contentSharingSessions[e]};n.delete(i,t).then(r,r)}else this.rejectBecauseOfMissingSession(e,i);return i.promise},this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>"[ContentSharingManager]")),this.lastProcessedSequenceNumber=-1,this.lastProcessedSequenceNumberForParticipant={}}startContentSharingAsync(e,t,i,n,r,s,a){if(this.logger.info(`startContentSharingAsync called for: ${e}`),this.pendingSessionToStart){const e="There is already a ContentSharing session start pending";return this.logger.error(e),Promise.reject(new Error(e))}const o={contentIdentifier:e,subject:i||null,sessionState:t||null,sequenceNumber:1},c=Is(),l=new ih(this.signalingSession,a||ss());return this.pendingSessionToStart=l,r?(this.logger.info("Call connected, send content sharing request out immediately"),l.start(n,o,c,s)):(this.logger.info("Content sharing is to be started when startOutgoingCall is called"),l.addSessionPromise=c,l.fsmState=Yr.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED,this.contentSharingToStartCallWith=o),c.promise.then((()=>{this.contentSharingSessions.hasOwnProperty(l.correlationId)||(this.contentSharingSessions[l.correlationId]=l),this.pendingSessionToStart=null})).catch((()=>{this.pendingSessionToStart=null})),c.promise}joinContentSharingAsync(e,t){this.logger.info(`[${t}][joinContentSharingAsync]`);const i=Is(),n=this.contentSharingSessions[e];return n?n.join(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingSessionStateAsync(e,t,i){this.logger.info(`[${i}][updateContentSharingSessionStateAsync][sessionState=${JSON.stringify(t)}]`);const n=Is(),r=this.contentSharingSessions[e];return r?r.updateSessionState(t,n,i):this.rejectBecauseOfMissingSession(e,n),n.promise}takeContentSharingControlAsync(e,t){this.logger.info(`[${t}][takeContentSharingControlAsync]`);const i=Is(),n=this.contentSharingSessions[e];return n?n.takeControl(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingParticipantStateAsync(e,t){this.logger.info(`[${t}][updateContentSharingParticipantStateAsync]`);const i=Is(),n=this.contentSharingSessions[e];return n?n.updateParticipantState(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingNotificationLinksAsync(e){this.logger.info(`[${e}][updateContentSharingNotificationLinksAsync]`);for(const t of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(t)){const i=this.contentSharingSessions[t];i&&i.updateNotificationLinks(e)}}getContentSharingInfoToStartSharing(){if(this.contentSharingToStartCallWith){const e=this.pendingSessionToStart,t=Yr.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED;e&&e.fsmState===t||(this.contentSharingToStartCallWith=null,this.pendingSessionToStart=null)}return this.contentSharingToStartCallWith}dispose(e,t){this.logger.info(`[${t}][dispose]`);for(const i of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(i)){const n=this.contentSharingSessions[i];n&&n.dispose(e,t)}}handleContentSharingUpdate(e){const t=e.body,i=Cs(e),n=this.contentSharingSessions[t.contentSharingCorrelationId];n?n.handleUpdate(t,i)&&this.signalingSessionCallback.onContentSharingUpdated({sessionId:t.sessionId,correlationId:t.contentSharingCorrelationId,contentIdentifier:t.identifier,presenter:t.presenter.id,subject:t.subject||null,sessionState:t.sessionState||null},i):this.logger.info(`[${i}][handleContentSharingUpdate][failed][reason=no session with correlation ID ${t.correlationId}]`)}handleAddModalitySuccess(e,t){this.logger.info(`[${t}][handleAddModalitySuccess]`);const i=this.pendingSessionToStart;i?i.handleAddModalitySuccess(e,t):this.logger.info(`[${t}][handleAddModalitySuccess]Ignoring handleAddModalitySuccess because not waiting for one`)}handleAddModalityFailure(e,t){this.logger.info(`[${t}][handleAddModalityFailure]`);const i=this.pendingSessionToStart;i?i.handleAddModalityFailure(e,t):this.logger.info(`[${t}][handleAddModalityFailure]Ignoring handleAddModalityFailure because not waiting for one`)}handleIncomingContentSharingFromRoster(e,t,i){if(this.logger.info(`[${i}] handleIncomingContentSharingFromRoster: isFullRoster ${t} content ${Ne(e)}`),("MultiPartyEndpoint"===e.type||t)&&this.lastProcessedSequenceNumber>e.sequenceNumber)return void this.logger.info(`[${i}] handleIncomingContentSharingFromRoster invalid roster current sequenceNumber ${e.sequenceNumber} lastProcessedSequenceNumber ${this.lastProcessedSequenceNumber}`);const{sessionsWithPresenters:n,sessionsWithoutPresenters:r}=this.parseContentSharingSessionsFromRoster(e);this.startSessionsFromRoster(n,i),this.stopSessionsFromRoster(r,i),this.lastProcessedSequenceNumber=e.sequenceNumber}handleContentSharingEnd(e){const t=e.body,i=Cs(e);this.logger.info("handleContentSharingEnd : ",Ne(t));const n=this.contentSharingSessions[t.contentSharingCorrelationId];if(!n)return void this.logger.info("Ignoring contentSharingEnd since there is no corresponding sharing ongoing");if(!n.handleStop(t,i))return;const r={...t.contentSharingTransactionEnd};this.raiseContentSharingStopped(t.contentSharingCorrelationId,i,t.presenter.id,r)}parseContentSharingSessionsFromRoster(e){const t={},i={},n=new Set;for(const i of Object.keys(e.participants)){const r=e.participants[i];if("Delta"===e.type&&this.lastProcessedSequenceNumberForParticipant.hasOwnProperty(i)&&r.version<=this.lastProcessedSequenceNumberForParticipant[i])continue;if(r.version=r.version||-1,this.lastProcessedSequenceNumberForParticipant[i]=r.version,n.add(r.details.id),!r.endpoints)continue;const s=this.signalingSession.participantManager.localParticipant.participantId;for(const e of Object.keys(r.endpoints)){const i=r.endpoints[e],n=i?.contentSharing?.sessionInformation;"presenter"===n?.role&&(t[n.contentSharingCorrelationId]={presenterId:r.details.id,sessionInfo:n,selfEndpointIsPresenter:i.participantId===s})}}for(const e of Object.keys(this.contentSharingSessions))!t[e]&&n.has(this.contentSharingSessions[e].presenterMri)&&(i[e]=this.contentSharingSessions[e]);return{sessionsWithPresenters:t,sessionsWithoutPresenters:i}}stopSessionsFromRoster(e,t){this.logger.info(`[${t}][stopSessionsFromRoster]`);for(const i of Object.keys(e))this.logger.info(`[${t}][stopSessionsFromRoster] stopping session with correlationId ${i}`),this.stopSession(e[i],t)}stopSession(e,t){this.logger.info(`[${t}][stopSession] Stopping session ${e.sessionId}`),e.handleStopFromRoster(this.DEFAULT_STOP_REASON,t),this.raiseContentSharingStopped(e.correlationId,t)}startSessionsFromRoster(e,t){this.logger.info(`[${t}][startSessionsFromRoster]`);for(const i of Object.keys(e)){this.logger.info(`[${t}][startSessionsFromRoster]`);const n=this.contentSharingSessions[i],r=e[i];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===i?this.pendingSessionToStart.confirmInRoster():n&&n.confirmInRoster(),n)n&&(this.contentSharingSessions[i].presenterMri=r.presenterId,this.logger.info(`[${t}][startSessionsFromRoster]Session ${i} is already present locally`));else{if(r.selfEndpointIsPresenter){this.logger.info(`[${t}][startSessionsFromRoster]This endpoint is presenting, dont fire callback`);continue}this.logger.info(`[${t}][startSessionsFromRoster]New sharing session found. Raising ContentSharingStarted`),this.raiseContentSharingStarted(r.presenterId,r.sessionInfo,t).handleStartFromRoster(r.presenterId,t)}}}raiseContentSharingStopped(e,t,i,n){this.logger.info(`[${t}][raiseContentSharingStopped]`),this.signalingSessionCallback.onContentSharingStopped({sessionId:this.contentSharingSessions[e].sessionId,correlationId:e,endedBy:i||this.DEFAULT_STOP_ID,reason:n||this.DEFAULT_STOP_REASON},t),delete this.contentSharingSessions[e]}raiseContentSharingStarted(e,t,i){this.logger.info(`[${i}][raiseContentSharingStarted]`);const n=new ih(this.signalingSession,t.contentSharingCorrelationId,t.contentSharingSessionId,{[Yr.LINKS.CONTENT_SHARING_CONTROLLER]:t.contentSharingController});n.presenterMri=e,this.contentSharingSessions[n.correlationId]=n;const r={sessionId:t.contentSharingSessionId,correlationId:t.contentSharingCorrelationId,contentIdentifier:t.identifier,presenter:e,subject:t.subject||null,sessionState:t.sessionState||null};return this.signalingSessionCallback.onContentSharingStarted(r,i),n}rejectBecauseOfMissingSession(e,t){const i=`There is no ContentSharing session with the correlation ID ${e}`;this.logger.error(i),t&&t.reject(new Error(i))}},rh={Default:{retryIntervalsMs:[200,1e3,5e3],maxRequestAttempts:4,perRequestTimeoutMs:45e3,perAttemptTimeoutMs:15e3,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4,hedgeDelayMs:4e3},BrokerSubscribe:{retryIntervalsMs:[100,200,500],maxRequestAttempts:4,perRequestTimeoutMs:3e4,perAttemptTimeoutMs:3e4,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4}},sh={CallSetup:{requestHedgingCapability:["disabled"],hedgeDelayMs:4e3},Other:{requestHedgingCapability:["disabled"]},BrokerSubscribe:{requestHedgingCapability:["disabled"]}},ah="HttpRequestDispatcherFactory";function oh(e,t,i){t?.signalingSession?t.signalingSession.telemetryHelper?.addTokenTelemetry(e,t?.tokenTelemetryData):i?.info("[reportTokenTelemetryData] signaling session is not available, cannot send token telemetry")}function ch(e,t){const{signalingSession:i,operation:n,causeId:r,data:s,customHeaders:a={},forceFetchToken:o,tokenRequestOptions:c}=e;if(i.disposed)return Promise.reject("Session already disposed");const l=e=>{const t="string"==typeof e?new Error(e):e;throw i.signalingAgent.clientSupportsGenericTokenAPI?e.timeOut?t.tokenTimeoutError=!0:t.tokenError=!0:t.skypeTokenError=!0,t};let d=!1;const h={signalingSession:i,tokenTelemetryData:{}};return i.signalingAgent.authTokenManager.getToken(r,o,c,h).catch((n=>(oh(e.requestId,h,t),!o&&function(e){const t=bs(e.signalingAgentConfig.trouterServiceProvider);return 3===t||1===t}(i)&&i.signalingAgentConfig.attemptHttpRequestWithCachedSkypetoken&&i.signalingAgent.authTokenManager.getLastToken(r)?(d=!0,Promise.resolve(i.signalingAgent.authTokenManager.getLastToken(r))):(t?.info(`[${r}] getToken failed with error ${n}`),l(n))))).then((o=>{if(i.disposed)throw new Error("token returned too late. Object is already disposed");oh(e.requestId,h,t);const c=new Xr;if(c.set(Yr.HEADERS.CORRELATION_ID,i.correlationId),c.set(Yr.HEADERS.MESSAGE_ID,function(e){return e&&/^[a-z0-9]{8}$/.test(e)?e+ss().substr(8):ss()}(r)),c.set(Yr.HEADERS.CLIENT_USER_AGENT,i.signalingAgentConfig.clientInformation),i.signalingAgent.clientSupportsGenericTokenAPI){const e=i.signalingAgent.authTokenManager.getLastTokenType(r);switch(i.signalingAgentConfig.disableTokenMigrationHeader||c.set(Yr.HEADERS.TOKEN_MIGRATION,"True"),e){case 8:case 4:c.set(Yr.HEADERS.AUTHORIZATION,`${Yr.HEADERS.BEARER_KEYWORD} ${o}`),c.delete(Yr.HEADERS.SKYPE_TOKEN);break;case 1:c.set(Yr.HEADERS.SKYPE_TOKEN,o),c.delete(Yr.HEADERS.AUTHORIZATION);break;default:throw new Error(`Error in RequestBuilder. TokenType ${e} is not supported`)}}else c.set(Yr.HEADERS.SKYPE_TOKEN,o);const l=i.participantManager.localParticipant;l&&(l.ring&&c.set(Yr.HEADERS.RING,l.ring),l.region&&c.set(Yr.HEADERS.REGION,l.region),l.partition&&c.set(Yr.HEADERS.PARTITION,l.partition));const u=s?.payload?JSON.stringify(s.payload):null,g={headers:{...c?.getAll(),...a},payload:u,usedCachedSkypetoken:d,reporting:{serviceName:n?`${ah}-${n}`:ah}};return i.telemetryHelper.addNetworkOperationStarted(n),g})).catch(l)}var lh=class{constructor(e,t,i,n,r,s,a,o,c){this.causeId=e,this.logger=t,this.dispatcher=i,this.requestType=n,this.url=r,this.request=s,this.onRequestFailed=a,this.authRequiredCallback=o,this.settings=c,this.requestsSent=0,this.otherAttemptSuccessful=!1,this.pendingAttempts=[],this.hedgeDelayMs=3e3,this.hedgeMaxParallelAttempts=3,this.stopStandardRetryTimer=()=>{this.standardRetryTimer&&(this.standardRetryTimer.stop(),this.standardRetryTimer=null)},this.stopHedgeTimer=()=>{this.hedgeTimer&&(this.hedgeTimer.stop(),this.hedgeTimer=null)},this.stopAttemptTimeoutTimer=e=>{try{e.timeoutTimer&&(e.timeoutTimer.stop(),this.logger.info("attempt timer stopped"))}catch(e){this.logger.info(`stopAttemptTimeoutTimer error ${e}`)}},this.stopRequestTimer=()=>{try{this.requestTimer&&(this.requestTimer.stop(),this.logger.info("Request timer stopped"))}catch(e){this.logger.info(`stopRequestTimer error ${e}`)}this.requestTimer=null},this.canScheduleNextAttempt=()=>{if(this.stackError===Yr.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful||this.requestsSent>=this.settings.maxRequestAttempts)return this.logger.info(`canScheduleNextAttempt stack error ${this.stackError} otherAttemptSuccessful ${this.otherAttemptSuccessful} exceeded max attempt ${this.requestsSent>=this.settings.maxRequestAttempts}`),!1;if(this.settings.enableRequestHedging){const e=this.pendingAttempts.length<this.hedgeMaxParallelAttempts;return e||this.logger.info(`canScheduleNextAttempt enableRequestHedging attempts sent: ${this.pendingAttempts.length} max attempts: ${this.hedgeMaxParallelAttempts}`),e}{const e=this.requestsSent<this.settings.retryIntervalsMs.length;return e||this.logger.info(`canScheduleNextAttempt attempts sent: ${this.requestsSent} max attempts: ${this.settings.retryIntervalsMs.length}`),e}},this.scheduleNextRequest=e=>{this.settings.enableRequestHedging?(this.logger.info("scheduleNextRequest with hedging"),this.hedgeTimer=$d.build((()=>{this.attempt(),this.canScheduleNextAttempt()&&this.scheduleNextRequest(!1)}),"HEDGE").start(this.getNextDelay(e))):(this.logger.info("scheduleNextRequest with retry"),this.standardRetryTimer=$d.build((()=>{this.attempt()}),"RETRY").start(this.getNextDelay(e)))},this.standardizeFailedRequest=(e,t)=>{let i;const n=this.logger.createChild("[standardizeFailedRequest]");try{if(this.stackError===Yr.HTTP_STACK_ERROR.REQUEST_TIMEOUT)n.info("request timed out"),i=Ar.REQUEST_TIMEOUT;else if(this.stackError===Yr.HTTP_STACK_ERROR.REQUEST_ABORTED)n.info("request aborted"),i=Ar.REQUEST_ABORTED;else if(t&&t.status===Yr.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT)n.info("request attempt timed out"),i=Ar.ATTEMPT_TIMEOUT;else if(t&&[Yr.HTTP_STACK_ERROR.ATTEMPT_ABORTED,Yr.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL].indexOf(t.status)>-1)n.info("request attempt aborted"),i=Ar.ATTEMPT_ABORTED;else if(e){if(n.info(`request ${Le(e)}`),"function"==typeof XMLHttpRequest&&e instanceof XMLHttpRequest)i=e;else if("function"==typeof XMLHttpRequest&&e&&e.request instanceof XMLHttpRequest){const t=e;i={response:{...t?.request?.response,headers:t.response?.headers},status:t.request.status,statusText:t.request.statusText,readyState:t.request.readyState}}else e.status||e.statusCode||e.response?i={response:e.response,status:[void 0,null,""].indexOf(e.status)>-1?e.statusCode:e.status,statusText:e.statusText,readyState:e.readyState}:(n.info("Local http stack error"),i={response:Yr.CALL_END_SUB_CODE.LOCAL_HTTP_STACK_ERROR,status:Yr.CALL_END_CODE.LOCAL_HTTP_STACK_ERROR,statusText:"LocalHTTPStackError",readyState:e.readyState||0});this.isBrowserOffline()&&0===i.status&&4===i.readyState&&(n.info("offline"),i={response:Yr.HTTP_STACK_ERROR.CANNOT_CONNECT,status:Yr.HTTP_STATUS_CODES.OFFLINE,statusText:"offline",readyState:i.readyState}),e.response?.message&&(e.response.message.operationFailure||e.response.message.broadcastOperationFailure)?i={response:e.response.message}:!e.response&&e.body?.operationFailure&&(i={response:e.body})}else n.info("no response"),i={response:Yr.HTTP_STACK_ERROR.NONE,status:Yr.HTTP_STATUS_CODES.OTHER,statusText:"Empty Response",readyState:0}}catch(e){n.info(`Failed to handle error ${e}`),i={response:"",status:Yr.HTTP_STATUS_CODES.OTHER,statusText:"FailedToHandleError",readyState:0}}return i},this.hasPendingAttempts=()=>this.pendingAttempts.some((e=>e.pending)),this.getRequestFromStatus=e=>e&&e.request&&e.request.status||0,this.isBrowserOffline=()=>navigator&&!1===navigator.onLine,this.logger=t.createChild(`[${this.causeId}][Dispatcher]`),this.logger.info(`created request, url=${r}`),!isNaN(this.settings.hedgeDelayMs)&&this.settings.hedgeDelayMs>=500&&this.settings.hedgeDelayMs<=1e4&&(this.hedgeDelayMs=this.settings.hedgeDelayMs),!isNaN(this.settings.hedgeMaxParallelAttempts)&&this.settings.hedgeMaxParallelAttempts>=0&&this.settings.hedgeMaxParallelAttempts<=4&&(this.hedgeMaxParallelAttempts=this.settings.hedgeMaxParallelAttempts),(isNaN(this.settings.perAttemptTimeoutMs)||this.settings.perAttemptTimeoutMs<=0)&&(this.settings.perAttemptTimeoutMs=15e3),(isNaN(this.settings.perRequestTimeoutMs)||this.settings.perRequestTimeoutMs<=0)&&(this.settings.perRequestTimeoutMs=45e3),(isNaN(this.settings.maxRequestAttempts)||this.settings.maxRequestAttempts<=0)&&(this.settings.maxRequestAttempts=4),(isNaN(this.settings.perRequestTimeoutWithHedgingMs)||this.settings.perRequestTimeoutWithHedgingMs<=0)&&(this.settings.perRequestTimeoutWithHedgingMs=45e3),(isNaN(this.settings.perAttemptTimeoutWithHedgingMs)||this.settings.perAttemptTimeoutWithHedgingMs<=0)&&(this.settings.perAttemptTimeoutWithHedgingMs=3e4)}sendRequest(){this.stackError=Yr.HTTP_STACK_ERROR.NONE;return this.logger.info("send api called"),this.requestTimer=$d.build((()=>{this.stackError=Yr.HTTP_STACK_ERROR.REQUEST_TIMEOUT,this.cancelAllAttempts(Yr.HTTP_STACK_ERROR.REQUEST_TIMEOUT)}),"REQUEST_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perRequestTimeoutWithHedgingMs:this.settings.perRequestTimeoutMs),new Promise(((e,t)=>{this.resolve=e,this.reject=t,this.scheduleNextRequest(!0)}))}cancelRequest(){this.logger.info("cancelRequest"),this.stackError=Yr.HTTP_STACK_ERROR.REQUEST_ABORTED,this.cancelAllAttempts(Yr.HTTP_STACK_ERROR.ATTEMPT_ABORTED)}cancelOtherAttempts(e){this.pendingAttempts.splice(e-1,1),this.cancelAllAttempts(Yr.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL)}cancelAllAttempts(e){this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.pendingAttempts.forEach((t=>{t.status=e,t.cancelDeferred.resolve(),this.stopAttemptTimeoutTimer(t)})),this.stopRequestTimer()}getRequestMethod(e){switch(e){case 0:return this.dispatcher.getAsync.bind(this.dispatcher);case 1:return this.dispatcher.postAsync.bind(this.dispatcher);case 2:return this.dispatcher.putAsync.bind(this.dispatcher);case 3:return this.dispatcher.removeAsync.bind(this.dispatcher);default:return null}}async queueAttempt(e){const t=e&&this.isNotRetryable(e);if(this.logger.info("queueAttempt"),t||!this.canScheduleNextAttempt())return this.logger.info(`unable to retry isNotRetryable ${t} ${JSON.stringify(e)}`),this.stopHedgeTimer(),this.stopRequestTimer(),void(this.hasPendingAttempts()||(this.settings.reportPreviousErrorsForTimeout&&e===Ar.ATTEMPT_TIMEOUT&&this.previousAttempt?this.reject(this.previousAttempt):this.reject(e)));if(this.isAuthFailedStatus(e)){this.logger.info("auth failed"),this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.stopRequestTimer();try{const t=e?.response?.headers,i=function(e){const t=Xr.getHeaderValue(e,Yr.HEADERS.SKYPE_TOKEN);if(t)return t;const i=Xr.getHeaderValue(e,Yr.HEADERS.AUTHORIZATION);if(i){const e=i.split(" ");if(2===e.length)return e[1]}}(this.request?.headers),n=await this.authRequiredCallback(t,i);this.request=n}catch(t){return void this.reject(e)}}this.previousAttempt=e,this.hedgeTimer?this.logger.info("scheduleNextRequest ignored as there's already active hedge timer"):this.scheduleNextRequest(!1)}attempt(){if(this.logger.info("attempt to send request"),this.stackError===Yr.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful)return;const e=(new Date).getTime();this.requestsSent++;const t=this.requestsSent,i=Is();this.request.timeout=i.promise;const n={cancelDeferred:i,status:Yr.HTTP_STACK_ERROR.NONE,timeoutTimer:null,pending:!0},r=$d.build((()=>{n.status=Yr.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT,n.cancelDeferred.resolve()}),"ATTEMPT_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perAttemptTimeoutWithHedgingMs:this.settings.perAttemptTimeoutMs);n.timeoutTimer=r,this.pendingAttempts.push(n),this.getRequestMethod(this.requestType)(this.url,this.request).then((i=>{if(this.logger.info(`attempt successful, request response=${Pd.scrubDisplayNamesFromResponse(i)} status=${this.getRequestFromStatus(i)}`),this.otherAttemptSuccessful)throw"Other attempt succesful";if(this.stackError===Yr.HTTP_STACK_ERROR.REQUEST_ABORTED)throw"Session disposed";if(!i)throw"Invalid response";n.pending=!1,this.otherAttemptSuccessful=!0,this.stopRequestTimer(),this.stopHedgeTimer(),this.stopAttemptTimeoutTimer(n),this.cancelOtherAttempts(t),this.resolve({success:!0,request:i.request,response:i.response,attempt:this.requestsSent,attemptStartTimestamp:e,attemptResponseTimestamp:(new Date).getTime()})})).catch((t=>{n.pending=!1,this.stopAttemptTimeoutTimer(n);const i=this.standardizeFailedRequest(t,n);this.logger.info(`attempt failed, request: ${Le(t)} status=${i.status}`),this.onRequestFailed({abandoned:this.otherAttemptSuccessful,success:!1,request:i,attempt:this.requestsSent,attemptStartTimestamp:e,attemptResponseTimestamp:(new Date).getTime()}),this.queueAttempt(i)}))}getNextDelay(e){let t;if(e)t=0;else if(this.settings.enableRequestHedging)t=this.hedgeDelayMs;else{if(!(this.requestsSent<=this.settings.retryIntervalsMs.length))throw"Unable to get next delay";t=this.settings.retryIntervalsMs[this.requestsSent-1]}return this.logger.info(`next delay= ${t} ms`),t}isRequestWithStatus(e,t){return!!e&&t.indexOf(e.status)>-1}isNotRetryable(e){return!As(e&&e.status)}isAuthFailedStatus(e){return this.isRequestWithStatus(e,[Yr.HTTP_STATUS_CODES.UNAUTHORIZED])}},dh={1:"POST",0:"GET",2:"PUT",3:"DELETE"},hh=class{constructor(e,t){this.signalingSession=e,this.callStartTime=t,this.pendingRequests={},this.sendGetRequest=e=>this.sendRequest(0,e),this.sendPostRequest=e=>this.sendRequest(1,e),this.sendPutRequest=e=>this.sendRequest(2,e),this.sendDeleteRequest=e=>this.sendRequest(3,e),this.cancelRequestIfPending=(e,t,i,n)=>{this.logger.info(`[${t}][cancelRequestIfPending]`),this.pendingRequests[e]?i?this.hasPendingRequest(e,i)&&this.cancelRequest(e,i,t,n):Object.keys(this.pendingRequests[e]).forEach((i=>this.cancelRequest(e,i,t,n))):this.logger.info(`[${t}][cancelRequestIfPending]no pending request with name=${e}`)},this.cancelAllRequests=e=>{this.logger.info(`[${e}][cancelAllRequests]`);const t=[];return Object.keys(this.pendingRequests).forEach((i=>{Object.keys(this.pendingRequests[i]).forEach((n=>{t.push(this.cancelRequest(i,n,e))}))})),Promise.all(t).catch((()=>{}))},this.hasPendingRequest=(e,t)=>!!this.pendingRequests[e]&&Boolean(t?this.pendingRequests[e][t]:this.pendingRequests[e]),this.cancelRequest=(e,t,i,n)=>{try{return this.pendingRequests[e][t].dispatcher&&this.pendingRequests[e][t].dispatcher.cancelRequest(),this.pendingRequests[e][t].aborted=!0,this.pendingRequests[e][t].errorDetails=n,this.logger.info(`[${i}][cancelRequest]Request=${e} aborted ${n?`with errorDetails ${JSON.stringify(n)}`:""}`),this.pendingRequests[e][t].requestPromise.catch((()=>{}))}catch(n){return this.logger.warn(`[${i}][cancelRequest]Unable to cancel request=${e}, requestId=${t}`),Promise.resolve()}},this.buildRequestTelemetry=(e,t,i,n)=>({name:`${dh[e]}-${t.requestName}`,url:t.url,eventStart:i-this.callStartTime,trouterReady:-1,requestReady:-1,status:-1,attempts:[],rtt:-1,uid:t.requestId,causeId:t.causeId,requestDispatcherConfig:n,enableRequestHedging:this.shouldEnableRequestHedging(n)}),this.addPendingRequest=e=>(this.pendingRequests[e.requestName]||(this.pendingRequests[e.requestName]={}),this.pendingRequests[e.requestName][e.requestId]={dispatcher:null,requestPromise:null,aborted:!1},this.pendingRequests[e.requestName][e.requestId]),this.sendRequest=(e,t)=>{if(!t.url){this.logger.error(t.requestName,"Link does not exist");const e={code:Yr.CALL_END_CODE.HTTP_OTHER_ERROR,subCode:Yr.CALL_END_SUB_CODE.MISSING_REQUEST_URI,phrase:`Link does not exist for requestName: ${t.requestName}.`};return Promise.reject(e)}t.requestId||(t.requestId=ss()),t.causeId||(t.causeId=rs());const i=this.logger.createChild(`[${t.causeId}][${t.requestName}]`);i.info("[scheduled]");const n=this.getInternalHttpDispatcherConfig(t.requestName,t.operationType);let r;t.skipHttpTelemetry||(t.skipHttpTelemetry=!1);const s=th(),a=(new Date).getTime(),o=[],c=this.buildRequestTelemetry(e,t,a,n),l=()=>{this.signalingSession.disposed?this.logger.info("Unable to record telemetry, session disposed"):this.signalingSession.telemetryHelper.updateNetworkRequest(c)},d=()=>{this.signalingSession.telemetryHelper.deleteNetworkRequest(c)};l();const h=(e,n)=>{if(!e?.request)return void this.logger.warn(t.requestName,"missing request details, unable to record for telemetry!");i.info(`[finished][status=${e.request.status}][statusText=${e.request.statusText}][retryCount=${e.attempt}]`);const r={status:e.request.status,statusSubCode:e.request.response?.operationFailure?.subCode,start:e.attemptStartTimestamp-a,end:e.attemptResponseTimestamp-a,online:bs(this.signalingSession.signalingAgentConfig.trouterServiceProvider)};e.abandoned&&(r.abandoned=!0),e.request.statusText&&(r.statusText=e.request.statusText),(n||-1===c.status)&&(c.status=e.request.status),c.attempts.push(r),l()};if(this.hasPendingRequest(t.requestName,t.requestId))return this.logger.warn(t.requestName,t.requestId,"is already pending request!!"),this.pendingRequests[t.requestName][t.requestId].requestPromise;r=this.addPendingRequest(t);const u=(e,n,r,a)=>{if(e&&t.skipHttpTelemetry)return this.logger.info("Skipping telemetry"),void d();i.info(`[steps=${o}]`),this.pendingRequests[t.requestName][t.requestId].aborted&&(c.aborted=!0),this.hasPendingRequest(t.requestName,t.requestId)?(delete this.pendingRequests[n][r],Object.keys(this.pendingRequests[n]).length||delete this.pendingRequests[n]):this.logger.warn("Unable to clean up!"),this.signalingSession.disposed||(a&&(c.error=a),c.rtt=s.duration(),this.signalingSession.telemetryHelper.addNetworkOperationCompleted(t.requestName,e,s.duration()),l(),this.signalingSession.telemetryHelper.sendHttpTelemetryData(c.uid))},g=e=>(...n)=>{if(this.signalingSession.disposed){const e=`[${t.causeId}][${t.requestName}][failed][reason=Session disposed]`;throw i.info("[failed][reason=Session disposed]"),new Error(e)}if(this.hasPendingRequest(t.requestName,t.requestId)&&this.pendingRequests[t.requestName][t.requestId].aborted){let e;const n=`[${t.causeId}][${t.requestName}][failed][reason=request already aborted]`,r=this.pendingRequests[t.requestName][t.requestId].errorDetails;throw r?(e=r,e.phrase=n):e=n,i.info(`${n}`),new Error(JSON.stringify(e))}return e(...n)},p=g((()=>(o.push("[waitForTrouter]"),t.withoutTrouter?Promise.resolve():this.signalingSession.ensureMessageChannelReady(t.requestName)))),m=g((()=>(o.push("[trouterReady]"),c.trouterReady=s.duration(),t.onceTrouterReady&&t.onceTrouterReady(),l(),Promise.resolve()))),f=g((()=>{const i=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,n=Ps(this.signalingSession.signalingAgentConfig,i,e,t,!1,void 0,this.logger);return o.push("[buildRequest]"),ch({signalingSession:this.signalingSession,operation:t.requestName,data:t.payload,customHeaders:t.customHeaders?.getAll(),causeId:t.causeId,tokenRequestOptions:n,requestId:t.requestId},this.logger)})),S=g((e=>{o.push("[failedToBuildRequestOptions]");const t={request:{status:Yr.HTTP_STATUS_CODES.OTHER,statusText:"Local error"},attempt:1,success:!1,attemptResponseTimestamp:(new Date).getTime(),attemptStartTimestamp:(new Date).getTime()};return e&&(e.skypeTokenError?t.request={status:Yr.CALL_END_SKYPE_TOKEN_ERROR.code,statusText:Yr.CALL_END_SKYPE_TOKEN_ERROR.phrase}:e.tokenError?t.request={status:Yr.CALL_END_TOKEN_ERROR.code,statusText:Yr.CALL_END_TOKEN_ERROR.phrase}:e.tokenTimeoutError&&(t.request={status:Yr.CALL_END_TOKEN_TIMEOUT_ERROR.code,statusText:Yr.CALL_END_TOKEN_TIMEOUT_ERROR.phrase})),h(t,!1),Promise.reject(e)})),v=g((e=>(o.push("[requestBuilt]"),c.requestReady=s.duration(),e.usedCachedSkypetoken&&(c.usedCachedSkypetoken=e.usedCachedSkypetoken),l(),Promise.resolve(e)))),y=(i,n)=>{o.push("[authRequired]");const r=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,s=Ps(this.signalingSession.signalingAgentConfig,r,e,t,!0,i,this.logger);return s.invalidToken=n,ch({signalingSession:this.signalingSession,operation:t.requestName,data:t.payload,customHeaders:t.customHeaders?.getAll(),causeId:t.causeId,forceFetchToken:!0,tokenRequestOptions:s,requestId:t.requestId},this.logger)},C=g((i=>{o.push("[sendRequest]");const s={...n,enableRequestHedging:this.shouldEnableRequestHedging(n),hedgeDelayMs:n.hedgeDelayMs,hedgeMaxParallelAttempts:this.signalingSession.signalingAgentConfig.hedgeMaxParallelAttempts,retryIntervalsMs:t.disableRetry||!n.retryIntervalsMs?[]:n.retryIntervalsMs,reportPreviousErrorsForTimeout:this.signalingSession.signalingAgentConfig.reportPreviousErrorsForTimeout},a=function(e){return new lh(e.causeId,e.logger,e.dispatcher,e.requestType,e.url,e.request,e.attemptFailureCallback,e.authRequiredCallback,e.settings)}({logger:this.logger,causeId:t.causeId,dispatcher:this.signalingSession.signalingAgentConfig.httpRequestDispatcher,url:t.url,request:i,requestType:e,authRequiredCallback:y,attemptFailureCallback:e=>{h(e,!1)},settings:s});return r.dispatcher=a,l(),a.sendRequest()})),_=g((async e=>(h(e,!0),i.info("[success]"),u(!0,t.requestName,t.requestId),e))),E=Promise.resolve().then(p).then(m).then(f).catch(S).then(v).then(C).then(_).catch((e=>{const n=Ne(e);return u(!1,t.requestName,t.requestId,n),!e||e.readyState||e.status?i.info(`[failed][reason=${n}]`):i.info(`[failed][offline][reason=${n}]`),Promise.reject(e)}));return r.requestPromise=E,E},this.logger=this.signalingSession.logger.createChild("[HTTP]")}getInternalHttpDispatcherConfig(e,t="Other"){let i={...rh.Default,...sh[t],...rh[e]};return this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap&&(i={...i,...this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap[t]}),this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap&&(i={...i,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap.Default,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap[e]}),this.logger.info(`getInternalHttpDispatcherConfig request type: ${e} config: ${Le(i)}`),i}shouldEnableRequestHedging(e){return!!(this.signalingSession.getMeetingInfo()&&e.requestHedgingCapability.indexOf("enabledForMeetings")>-1)||!this.signalingSession.multiParty&&e.requestHedgingCapability.indexOf("enabledForP2PCalls")>-1||!!(this.signalingSession.multiParty&&e.requestHedgingCapability.indexOf("enabledForGroupCalls")>-1)||e.requestHedgingCapability.indexOf("enabled")>-1}};function uh(e,t,i){cs(e,"signalingSession cannot be null");let n=[];i&&(n=ds(i),e.telemetryHelper.addOutgoingModalities(n));const r=rs();return{payload:{mediaNegotiation:{callModalities:n,sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},links:{mediaAnswer:Zr(e,Pr.MEDIA_ANSWER,r),rejection:Zr(e,Pr.MEDIA_REJECTION,r)},mediaContent:t}}}}function gh(e,t){return cs(e,"signalingSession cannot be null"),ls(t),{payload:{mediaNegotiationFailure:{sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},code:t.code,subCode:t.subCode,phrase:t.phrase},debugContent:{callId:e.correlationId,endpointId:e.participantManager.localParticipant.endpointId}}}}function ph(e,t,i){cs(e,"signalingSession cannot be null");let n=[];return i&&(n=ds(i),e.telemetryHelper.addOutgoingModalities(n)),{payload:{mediaAnswer:{callModalities:n,sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},links:{mediaAcknowledgement:Zr(e,Pr.MEDIA_ACKNOWLEDGEMENT)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t},debugContent:{callId:e.correlationId,endpointId:e.participantManager.localParticipant.endpointId}}}}var mh=class{constructor(e,t,i){this.telemetryHelper=i,this.vbssInitiated=!1,this.disposed=!1,this.fsmState=Yr.MEDIA_RENEGOTIATION_FSM_STATE.IDLE,this.fsmStateCauseId="",this.links={},this.renegotiationOffersSeenSoFar=[],this.isOutgoingRenegotiationInProgress=()=>this.fsmState===Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION||this.fsmState===Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.isIncomingRenegotiationInProgress=()=>this.fsmState===Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION||this.fsmState===Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.acceptRenegotiationAsync=(e,t,i)=>{this.logger.info(`[${i}][acceptRenegotiationAsync][mediaTypes=${t}]`),this.signalingSession.telemetryHelper.recordEvent(qs,{mediaTypes:t,causeId:i}),os(this.links[Yr.LINKS.MEDIA_ANSWER],"MediaAnswer link not set");const n=Is();switch(this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,i);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,i);break;default:return this.logger.info(`[${i}][acceptRenegotiationAsync]there is no incoming media renegotiation offer to accept`),n.reject(new Error("there is no incoming media renegotiation offer to accept")),n.promise}return this.signalingSession.http.sendPostRequest({url:this.links[Yr.LINKS.MEDIA_ANSWER],payload:ph(this.signalingSession,e,t),requestName:od.SEND_MEDIA_ANSWER.name,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT,this.handleMediaAnswerAcknowledgmentTimeout.bind(this,i),Yr.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT)},causeId:i}).then((e=>{n.resolve(e.response)})).catch((e=>{const t=Ss(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][acceptRenegotiationAsync] error: ${Ne(t)}`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),n.reject(new Error(`acceptRenegotiationAsync failed because : ${Ne(e)}`))})),n.promise},this.startRenegotiationAsync=(e,t,i,n)=>{this.logger.info(`[${n}][startRenegotiationAsync][mediaTypes=${i}]`),this.signalingSession.telemetryHelper.recordEvent(Ws,{causeId:n,mediaTypes:i}),os(t,"MediaRenegotiation link not set");const r=Is();switch(this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,n);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:case Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.logger.info(`[${n}][startRenegotiationAsync][failed] can only be performed with no current outstanding renegotiations, previous negotiation causeId=${this.fsmStateCauseId}`),this.signalingSessionCallback.onMediaRenegotiationRejection(this.getGlareError(),n),Promise.resolve(null);default:return this.logger.info(`[${n}][startRenegotiationAsync][failed] can only be performed on an established call`),r.reject(new Error("media renegotiation can only be performed on an established call")),r.promise}const s=i&&gs(i,Yr.MEDIA_TYPES.SCREEN_SHARER);s?(this.vbssInitiated=!0,this.signalingSession.telemetryHelper.addVbssOperations(Cd.START)):!s&&this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(Cd.STOP));return this.signalingSession.http.sendPostRequest({url:t,payload:uh(this.signalingSession,e,i),requestName:od.START_RENEGOTIATION.name,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER,this.handleMediaAnswerTimeout.bind(this),Yr.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_TIMEOUT)},causeId:n}).then((e=>{r.resolve(e.response)})).catch((e=>{const t=Ss(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${n}][startRenegotiationAsync] error: ${Ne(t)}`),!this.disposed){switch(this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,n);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,n)}this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER)}r.reject(new Error(`startRenegotiationAsync failed because : ${Ne(e)}`))})),r.promise},this.handleMediaAcknowledgment=(e,t)=>{this.signalingSession.telemetryHelper.recordEvent(xs,{causeId:t}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),this.signalingSession.saveMediaControllerLinksIfAny(e),this.signalingSession.saveUpdatedCallLinksIfAny(e),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!0,t)},this.onCallConnected=e=>{this.logger.info("onCallConnected"),this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,e)},this.handleMediaNegotiationFailure=e=>{const t=Cs(e);this.signalingSession.telemetryHelper.recordIncomingEvent(Us,e),this.handleMediaNegotiationFailureInternal(e.body.mediaNegotiationFailure,e.origin,t)},this.handleMediaAnswer=(e,t)=>{switch(this.logger.info(`[${t}][handleMediaAnswer]`),this.signalingSession.telemetryHelper.recordEvent(Fs,{causeId:t}),this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,t);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,t);break;default:return}this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER);let i=[];e.mediaAnswer.callModalities&&e.mediaAnswer.callModalities.length>0&&(i=ds(e.mediaAnswer.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(i));const n={provisional:!1,renegotiation:!0,mediaTypes:i,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(e.mediaAnswer.mediaContent),mediaContent:e.mediaAnswer.mediaContent};this.signalingSession.http.sendPostRequest({url:e.mediaAnswer.links.mediaAcknowledgement,payload:null,requestName:od.SEND_MEDIA_ACKNOWLEDGEMENT.name,causeId:t}).catch((e=>{const i=Ss(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${t}][handleMediaAnswer] error: ${Ne(i)}`),this.signalingSession.disposed||this.signalingSession.telemetryHelper.recordEvent(Vs,{causeId:t})})),this.signalingSessionCallback.onAnswer(n,t)},this.handleMediaNegotiationOffer=e=>{const t=e.body,i=e.headers,n=Cs(e);this.logger.info(`[${n}][handleMediaNegotiationOffer]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Bs,e);const r=vs(i,this.renegotiationOffersSeenSoFar);switch(this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,n),this.raiseMediaRenegotiationOffer(t,n);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,n),this.raiseMediaRenegotiationOffer(t,n);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:if(this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.supportMediaRetargetWhileIncomingRenegotiation){this.raiseMediaRenegotiationOffer(t,n);break}this.rejectAndLog(n,r,t);break;default:this.rejectAndLog(n,r,t)}},this.rejectRenegotiationAsync=(e,t)=>{this.logger.info(`[${t}][rejectRenegotiationAsync]`),this.signalingSession.telemetryHelper.recordEvent(Hs,{rejectionData:e,causeId:t}),os(this.links[Yr.LINKS.MEDIA_REJECTION],"MediaRejection link not set");const i=e||{code:Yr.CALL_END_CODE.NOT_ACCEPTABLE_HERE,subCode:Yr.CALL_END_SUB_CODE.MEDIA_ANSWER_PROCESSING_ERROR,phrase:Yr.CALL_END_PHRASE.MEDIA_ANSWER_ERROR};switch(this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:return this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,t),this.rejectMediaRenegotiation(this.links[Yr.LINKS.MEDIA_REJECTION],i,t);case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,t),this.rejectMediaRenegotiation(this.links[Yr.LINKS.MEDIA_REJECTION],i,t);default:return this.logger.error(`[${t}][rejectRenegotiationAsync][failed] There is no incoming media renegotiation offer to reject`),Promise.resolve(null)}},this.handleRetargetCompleted=e=>{const t=e.body.retargetCompleted,i=Cs(e);this.logger.info(`[${i}][handleRetargetCompleted][details=${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent($s,e,Oe(t)),0===t.code?this.signalingSessionCallback.onReTargetCompletedSuccess(i):this.signalingSessionCallback.onReTargetCompletedFailure(t,i)},this.dispose=()=>{this.logger.info("mediaRenegotiationManager :: dispose"),this.disposed=!0},this.getGlareError=()=>({code:Yr.CALL_END_CODE.GLARE_ERROR,subCode:Yr.CALL_END_SUB_CODE.MEDIA_GLARE_ERROR,phrase:Yr.CALL_END_PHRASE.RENEGOTIATION_IN_PROGRESS,previousNegotiationCauseId:this.fsmStateCauseId}),this.handleMediaNegotiationFailureInternal=(e,t,i)=>{switch(this.logger.info(`[${i}][handleMediaNegotiationFailureInternal][failureData=${Oe(e)}]`),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.fsmState){case Yr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,i);break;case Yr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Yr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,i);break;default:return}this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(Cd.REJECTED)),this.signalingSession.telemetryHelper.addIncomingModalities(["Rejected"]),this.signalingSessionCallback.onMediaRenegotiationRejection({code:e.code,subCode:e.subCode,phrase:e.phrase},i)},this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>`[RenegotiationManager][${this.fsmState}][stateCauseId=${this.fsmStateCauseId}]`))}rejectAndLog(e,t,i){this.logger.error(`[${e}][handleMediaNegotiationOffer] Cannot handle the incoming mediaRenegotiation offer in present callstate. Either call not connected or renegotiation in progress. isDuplicateOffer=${t}`),t||this.rejectMediaRenegotiation(i.mediaNegotiation.links.rejection,this.getGlareError(),e)}setFsmState(e,t){this.fsmState=e,this.fsmStateCauseId=t,this.logger.info(`[setFsmState]state=${e}`),this.telemetryHelper.recordEvent(zs,{state:e,causeId:t})}raiseMediaRenegotiationOffer(e,t){this.logger.info(`[${t}][raiseMediaRenegotiationOffer]`),this.links[Yr.LINKS.MEDIA_ANSWER]=e.mediaNegotiation.links.mediaAnswer,this.links[Yr.LINKS.MEDIA_REJECTION]=e.mediaNegotiation.links.rejection;let i=[];e.mediaNegotiation.callModalities&&e.mediaNegotiation.callModalities.length>0&&(i=ds(e.mediaNegotiation.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(i),gs(i,Yr.MEDIA_TYPES.SCREEN_SHARER)&&this.signalingSession.telemetryHelper.addVbssOperations(Cd.REMOTE_START));const n={mediaTypes:i,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(e.mediaNegotiation.mediaContent),mediaContent:e.mediaNegotiation.mediaContent,renegotiation:!0};this.signalingSessionCallback.onOffer(n,t)}rejectMediaRenegotiation(e,t,i){this.logger.info(`[${i}][rejectMediaRenegotiation][rejectionData=${Oe(t)}]`);const n=Is();return this.signalingSession.http.sendPostRequest({url:e,payload:gh(this.signalingSession,t),requestName:od.SEND_MEDIA_REJECTION.name,causeId:i}).then((e=>{n.resolve(e.response)})).catch((e=>{const t=Ss(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][rejectMediaRenegotiation] error: ${Ne(t)}`),n.reject(new Error(`rejectMediaRenegotiation failed because : ${Ne(e)}`))})),n.promise}handleMediaAnswerTimeout(e){this.logger.info(`[${e}][handleMediaAnswerTimeout]`),this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(Cd.TIMEOUT)),this.signalingSession.telemetryHelper.addIncomingModalities(["Timeout"]),this.signalingSession.telemetryHelper.recordEvent(Gs),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.handleMediaNegotiationFailureInternal({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.MEDIA_FINAL_ANSWER_TIMEOUT,phrase:Yr.CALL_END_PHRASE.MEDIA_FINAL_ANSWER_TIMEOUT},cd.LOCAL,e)}handleMediaAnswerAcknowledgmentTimeout(e){this.logger.info(`[${e}][handleMediaAnswerAcknowledgmentTimeout]`),this.signalingSession.telemetryHelper.recordEvent(js),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT);this.signalingSessionCallback.onMediaAcknowledgementFailure(!0,{reason:"timed out waiting for Media Answer Acknowledgement"},e)}},fh=class{constructor(){this.requests={}}clear(e,t){const i=t||{code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((t=>{this.rejectOperation(t,e,i)}))}hasOperation(e){return this.requests.hasOwnProperty(e)}getAllOperations(){return this.requests}getOperation(e){return this.hasOperation(e)?this.requests[e]:null}setOperation(e,t){return!this.hasOperation(e)&&(this.requests[e]=t,!0)}rejectOperation(e,t,i){const n=new Error(t);if(i&&(n.endCode=i),this.hasOperation(e)){const t=this.requests[e].promise;delete this.requests[e],t.reject(n)}}resolveOperation(e,t){if(this.hasOperation(e)){const i=this.requests[e].promise;delete this.requests[e],i.resolve(t)}}},Sh=class{constructor(e){this.logger=e,this.localAddParticipantRequests=new fh,this.localAdmitParticipantRequests=new fh,this.localCallMeBackRequests=new fh,this.localRemoveParticipantEndpointRequests=new fh,this.localRemoveParticipantRequests=new fh,this.localUpdateParticipantInterpretationStateRequest=new fh,this.participantIdMriMap=new Map}dispose(e,t,i){this.logger.info(`[${i}][dispose]`),this.rejectAllPendingOperations(e,t)}getAllPendingOperations(e,t){this.logger.info(`[${t}][getAllPendingOperations] ${e}`);const i=this.getOperationTable(e);return i?i.getAllOperations():null}getPendingOperation(e,t,i){this.logger.info(`[${i}][getPendingOperation] ${e} ${t}`);const n=this.getOperationTable(e);return n?n.getOperation(t):null}getRnlMri(e,t){this.logger.info(`[${t}][getRnlMri] ${e}`);for(const t of e)if(this.participantIdMriMap.has(t))return this.participantIdMriMap.get(t);return""}hasPendingOperation(e,t,i){this.logger.info(`[${i}][hasPendingOperation] ${e} ${we(t)}`);const n=this.getOperationTable(e);return!!n&&n.hasOperation(t)}rejectPendingOperation(e,t,i,n,r){this.logger.info(`[${r}][rejectPendingOperation] ${e} ${we(t)} reason: ${i}`);const s=this.getOperationTable(e);s&&s.rejectOperation(t,i,n)}resolvePendingOperation(e,t,i,n){this.logger.info(`[${n}][resolvePendingOperation]: ${we(t)}`);const r=this.getOperationTable(e);r&&r.resolveOperation(t,i)}setPendingOperation(e,t,i,n){this.logger.info(`[${n}][setPendingOperation] ${e} ${we(t)} value: ${i}`);const r=this.getOperationTable(e);if(!r)return!1;if(0===e){const e=i&&i.participant&&i.participant.participantId;e&&this.participantIdMriMap.set(e,t)}return r.setOperation(t,i)}setParticipantIdToMriMapping(e,t,i,n){n?(this.logger.info(`[${i}][setParticipantIdMriMap] ${Pe(e)}: ${we(t)} clear mapping.`),this.participantIdMriMap.delete(e)):e&&t&&(this.logger.info(`[${i}][setParticipantIdMriMap] ${Pe(e)}: ${we(t)}`),this.participantIdMriMap.set(e,t))}getOperationTable(e){switch(e){case 0:return this.localAddParticipantRequests;case 1:return this.localAdmitParticipantRequests;case 2:return this.localCallMeBackRequests;case 4:return this.localRemoveParticipantEndpointRequests;case 3:return this.localRemoveParticipantRequests;case 5:return this.localUpdateParticipantInterpretationStateRequest;default:return null}}rejectAllPendingOperations(e,t){this.logger.info("rejectLocalQueuedOperations"),this.localAddParticipantRequests.clear(e,t),this.localAdmitParticipantRequests.clear(e,t),this.localCallMeBackRequests.clear(e,t),this.localRemoveParticipantRequests.clear(e,t),this.localRemoveParticipantEndpointRequests.clear(e,t),this.localUpdateParticipantInterpretationStateRequest.clear(e,t)}};function vh(e,t,i,n){cs(e,"signalingSession cannot be null");const r=i.groupId?{id:i.groupId}:null,s=i.threadId?{threadId:i.threadId,messageId:i.messageId||null}:null;let a=[],o={};t&&t.length>0?(a=t.map((t=>({id:t.nonMaskedId?t.nonMaskedId:t.id,assertedId:t.assertedId,displayName:t.displayName,participantId:t.participantId,replacementDetails:3===i.replacementType?e.getReplacementDetailsByParticipantLegOfCall(i.callIdToReplace,t.id,t.replacementParticipantId):void 0}))),o={addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE)}):o={addModalitySuccess:Zr(e,Pr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:Zr(e,Pr.CONV_ADD_MODALITY_FAILURE)};const c={payload:{disableUnmute:i&&i.disableUnmute,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:a},participantInvitationData:i.additionalData,replacementDetails:3===i.replacementType?void 0:n,groupContext:r,groupChat:s,links:o}};return i&&i.alternateId&&(c.payload.participants.from.alternateId=i.alternateId),i?.clientScenario&&(c.payload.debugContent={clientScenario:i.clientScenario}),c}function yh(e,t,i){return cs(e,"signalingSession cannot be null"),cs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[{id:t.id,displayName:t.displayName}]},links:{admitFailure:Zr(e,Pr.CONV_ADMIT_PARTICIPANT_FAILURE),admitSuccess:Zr(e,Pr.CONV_ADMIT_PARTICIPANT_SUCCESS)},debugContent:{causeId:i}}}}function Ch(e,t,i){return cs(e,"signalingSession cannot be null"),cs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:i,toEndpoints:[{id:t.id,endpointId:t.endpointId}]},links:{removeParticipantSuccess:Zr(e,Pr.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:Zr(e,Pr.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function _h(e,t){return cs(e,"signalingSession cannot be null"),cs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[{id:t.id,displayName:t.displayName}]},links:{removeParticipantSuccess:Zr(e,Pr.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:Zr(e,Pr.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function Eh(e,t,i,n=""){cs(i&&"specified"===i,"Only non-null non-empty scope of 'specified' is supported."),cs(e,"signalingSession cannot be null"),cs(t,"participantsIds cannot be null");const r=[];return t.forEach((e=>{const t={id:e,meetingRole:n};r.push(t)})),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:i,to:r}}}var Th=f(p),Ih=class{constructor(e,t){this.participantManager=e,this.logger=t,this.setStaleCheckForFullRoster=e=>{this.checkStaleRosterFromFull=e},this.handleRosterUpdate=(e,t,i,n)=>{if("Delta"===e.type||"MultiPartyEndpoint"===e.type){if(void 0===e.sequenceNumber&&(e.sequenceNumber=this.lastRosterUpdateSeqNumber),this.logger.info(`[${n}][handleRosterUpdate][sequenceNumber=${e.sequenceNumber}]`),this.rostersInLifetime.add(e.sequenceNumber),"Delta"===e.type)this.logger.info(`[${n}][handleRosterUpdate], RosterType: Delta, isFullRoster: ${i}`),this.handleDeltaRoster(e,i,t,n);else{if(this.logger.info(`[${n}][handleRosterUpdate], RosterType: MultiPartyEndpoint`),this.isRosterStale(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(nc,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const i of Object.keys(e.participants)){const r=Ls.fromRoster(e.participants[i]);this.handleRosterParticipant(r,t,n)}this.checkForRemovedParticipants(t,e.participants,n),this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n)}if(e.sequenceNumber>this.lastRosterUpdateSeqNumber){this.checkStaleRosterFromFull&&this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n),this.lastRosterUpdateSeqNumber=e.sequenceNumber,this.firstRosterUpdateSeqNumber<0&&(this.firstRosterUpdateSeqNumber=this.lastRosterUpdateSeqNumber);const t=Object.keys(e.participants||0).length;this.participantCountInFirstRoster<0&&(this.participantCountInFirstRoster=t),this.maxConcurrentParticipantsDuringLeg=Math.max(this.maxConcurrentParticipantsDuringLeg,t)}this.recordTelemetry(e,i,n),this.participantManager.signalingSessionCallback.onRosterHandlingComplete()}else this.logger.warn(`[${n}][handleRosterUpdate][sequenceNumber=${e.sequenceNumber}] invalid roster type ${e.type}`)},this.isRosterStaleFromFull=(e,t)=>!!this.checkStaleRosterFromFull&&(this.logger.info(`[${t}][isRosterStale] ${e.sequenceNumber<this.lastFullRosterSeqNumber}`),e.sequenceNumber<this.lastFullRosterSeqNumber),this.isRosterStale=(e,t)=>(this.logger.info(`[${t}][isRosterStale] ${e.sequenceNumber<this.lastRosterUpdateSeqNumber}`),e.sequenceNumber<this.lastRosterUpdateSeqNumber),this.updateLocalParticipantFromSubscribe=(e,t)=>{this.logger.info(`[${t}][updateLocalParticipantFromSubscribe]`),this.updateLocalParticipant(e,t)},this.handleParticipantAcceptedBy=(e,t,i)=>{const n=t.hasOwnProperty(e.id),r=e.id===e.acceptedBy.id;this.logger.info(`[${i}][RosterManager::handleParticipantAcceptedBy] oldParticipantInRoster: ${n}`),this.participantManager.participantOperationHandler.setParticipantIdToMriMapping(e.participantId,e.id,i,!0),n&&!r&&this.handleRemovedDeltaRosterParticipant(new Ls({id:e.id}),this.lastRosterUpdateSeqNumber,t,i)},this.lastRosterUpdateSeqNumber=-1,this.lastFullRosterSeqNumber=-1,this.firstRosterUpdateSeqNumber=-1,this.tombstoneSequence=new Map,this.latestRosterVersionForActiveParticipants=new Map,this.rostersInLifetime=new Set,this.maxConcurrentParticipantsDuringLeg=-1,this.participantCountInFirstRoster=-1,this.checkStaleRosterFromFull=!1}recordTelemetry(e,t,i){const n={participantCountInLastRoster:Object.keys(e.participants||0).length,participantCountInFirstRoster:this.participantCountInFirstRoster,sequenceNumberOfLastRoster:this.lastRosterUpdateSeqNumber,sequenceNumberOfLastFullRoster:this.lastFullRosterSeqNumber,sequenceNumberOfFirstRoster:this.firstRosterUpdateSeqNumber,rosterType:e.type,isFullRoster:t,maxConcurrentParticipantsDuringLeg:this.maxConcurrentParticipantsDuringLeg,totalParticipantsDuringLifetimeOfLeg:this.tombstoneSequence.size+this.latestRosterVersionForActiveParticipants.size,countOfMissingNotifications:this.getMissingNotificiations()};this.logger.info(`[recordTelemetry] data ${JSON.stringify(n,null,4)}`),this.participantManager.signalingSession.telemetryHelper.recordRosterEvent(n,ya,i)}getMissingNotificiations(){const e=this.lastRosterUpdateSeqNumber-this.firstRosterUpdateSeqNumber+1-this.rostersInLifetime.size;return e>0?e:0}isParticipantRosterStale(e,t){if(this.logger.info(`[isParticipantRosterStale], rosterParticipantVersion ${t}`),t){if(this.tombstoneSequence.has(e))return t<=this.tombstoneSequence.get(e);if(this.latestRosterVersionForActiveParticipants.has(e))return t<=this.latestRosterVersionForActiveParticipants.get(e)}return!1}handleDeltaRoster(e,t,i,n){if(this.logger.info(`[${n}][handleDeltaRoster] isFullRoster ${t}`),this.isRosterStaleFromFull(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(nc,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,lastFullRosterSeqNumber:this.lastFullRosterSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled full roster ${this.lastFullRosterSeqNumber}`);if(t){if(!this.checkStaleRosterFromFull&&this.isRosterStale(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(nc,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const t of Object.keys(i))if(!(e.participants.hasOwnProperty(t)||this.checkStaleRosterFromFull&&this.isParticipantRosterStale(t,e.sequenceNumber))){const r=new Ls({id:t});this.logger.info(`[${n}][handleRosterUpdate] participant missing from delta, full roster`),this.handleRemovedDeltaRosterParticipant(r,e.sequenceNumber,i,n)}this.lastFullRosterSeqNumber=e.sequenceNumber}else if(!e?.participants)return void this.logger.warn(`[${n}][handleRosterUpdate] participants blob empty in delta roster`);for(const t of Object.keys(e.participants)){const r=e.participants[t];if(!this.isParticipantRosterStale(t,r.version)){let e=Ls.fromRoster(r);r.state&&"active"===r.state?(this.logger.info(`[${n}][handleDeltaRoster] participant active`),this.handleRosterParticipant(e,i,n),this.tombstoneSequence.has(t)&&this.tombstoneSequence.delete(t),this.latestRosterVersionForActiveParticipants.set(t,r.version)):r.state&&"inactive"===r.state?(e=e||new Ls({id:r.details.id}),this.logger.info(`[${n}][handleDeltaRoster] participant inactive`),this.handleRemovedDeltaRosterParticipant(e,r.version,i,n)):this.logger.info(`[${n}][handleDeltaRoster] unexpected participant state ${r.state}`)}}this.handleRemoveParticipantRequests(this.getActiveParticipants(e.participants),n),this.checkStaleRosterFromFull||this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n)}getRnlMri(e,t){const i=this.participantManager.participantOperationHandler;if(e){const n=this.getRnlParticipantIdsFromRoster(e,t);return i.getRnlMri(n,t)}return""}handleRemovedDeltaRosterParticipant(e,t,i,n){const r=e.id,s=this.getRnlMri(e,n);let a="";i.hasOwnProperty(r)?a=r:i.hasOwnProperty(s)&&(a=s),a&&this.handleRemovedParticipant(i,a,n),this.tombstoneSequence.set(r,t),this.latestRosterVersionForActiveParticipants.has(r)&&this.latestRosterVersionForActiveParticipants.delete(r)}handleRemovedParticipant(e,t,i){const n=this.participantManager.signalingSessionCallback,r=this.participantManager.signalingSession;!1!==e[t]&&(ms(this.participantManager.connectedRemoteParticipantIds,t),this.logger.info(`[${i}][handleRemovedParticipant] ${we(t)} removed from roster`),n.onParticipantRemoved({id:t},i),r.clearParticipantCallLinks(t))}getActiveParticipants(e){const t={};for(const i of Object.keys(e))"inactive"!==e[i].state&&(t[i]=e[i]);return t}handleRosterParticipant(e,t,i){if(!e)return void this.logger.info(`[handleRosterParticipant][${i}] rosterParticipant processing skipped because null.`);if(e.id===this.participantManager.localParticipant.id){this.updateLocalParticipant(e,i);const t=this.getLocalEndpoint(),n=!(!t?.stream&&!t?.streamLobby),r=0===this.participantManager.signalingSession.callMode;return this.logger.info(`[handleRosterParticipant][${i}] isStreaming:${n} isInitialMode:${r}`),void(n&&r?this.participantManager.signalingSession.configureStreamingMode(i):n||this.participantManager.signalingSession.setRealTimeState(1,i))}const n=this.participantManager.participantOperationHandler,r=this.participantManager.signalingSession,s=this.participantManager.signalingSessionCallback,a=e.id,o=this.getRnlMri(e,i),c=this.getRnlParticipantIdsFromRoster(e,i);r.remoteCaller&&-1!==c.indexOf(r.remoteCaller.participantId)&&(e.displayName=r.remoteCaller.displayName),ps(this.participantManager.connectedRemoteParticipantIds,e.id,!0);const l=t.hasOwnProperty(e.id),d=t.hasOwnProperty(o);(l||d)&&(t[e.id]=!1),n.hasPendingOperation(0,e.id,i)&&this.isParticipantInCall(e)?(this.logger.info(`participant ${we(e.id)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,e.id),n.resolvePendingOperation(0,e.id,e,i)):o&&n.hasPendingOperation(0,o,i)&&this.isParticipantInCall(e)?(this.logger.info(`RNL participant ${we(o)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,o),n.resolvePendingOperation(0,o,e,i)):n.hasPendingOperation(1,e.id,i)&&this.isParticipantInCall(e)&&(this.logger.info(`participant: ${we(e.id)} appears in roster. Resolving AdmitParticipant request`),r.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),n.resolvePendingOperation(1,e.id,e,i));for(const t of e.endpointDetails)n.hasPendingOperation(0,t.participantId,i)&&this.isParticipantInCall(e)&&(this.logger.info(`participant ${we(e.id)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,t.participantId),n.resolvePendingOperation(0,t.participantId,e,i));l?(this.logger.info(`participantIds=[${c}] updated ${we(e.id)}`),s.onParticipantUpdated(e,i),r.setParticipantCallLinks(e)):d?(this.logger.info(`RNL participant participantIds=[${c}] removed old ${we(o)} and added new ${we(a)}`),s.onParticipantRemoved({id:o},i,!0),r.clearParticipantCallLinks(o),s.onParticipantJoined(e,i),r.setParticipantCallLinks(e)):n.hasPendingOperation(3,e.id,i)?this.logger.info(`participantIds=[${c}] ignored ${we(e.id)}`):(this.logger.info(`participantIds=[${c}] joined ${we(e.id)}`),s.onParticipantJoined(e,i),r.setParticipantCallLinks(e))}getLocalEndpoint(){return Th.find(this.participantManager.localParticipant.endpointDetails,(e=>this.participantManager.localParticipant.endpointId===e.endpointId))}getRnlParticipantIdsFromRoster(e,t){const i=[];for(const t of e.endpointDetails)i.push(t.participantId);return this.logger.info(`[${t}][getRnlParticipantIdsFromRoster] ${JSON.stringify(i)}`),i}isParticipantInCall(e){return e.endpointDetails?.[0]&&!e.endpointDetails[0].isLobby}updateLocalParticipant(e,t){const i=this.participantManager.localParticipant,n=this.participantManager.signalingSession,r=this.participantManager.signalingSessionCallback;n.setParticipantCallLinks(e),this.logger.info(`[${t}][updateLocalParticipant]`);let s=!1;if(e?.endpointDetails){const a=Th.find(e.endpointDetails,(e=>i.endpointId===e.endpointId)),o=Th.find(i.endpointDetails,(e=>i.endpointId===e.endpointId));s=Ld(a),a?.isLobby&&!o?.isLobby?n.telemetryHelper.recordEvent(Yo,{causeId:t}):!a||a.isLobby||o&&!o.isLobby||(s?n.telemetryHelper.recordEvent(Qo,{causeId:t}):n.telemetryHelper.recordEvent(Ko,{causeId:t})),a?.broadcastMeetingRole&&i&&i.broadcastMeetingRole!==a.broadcastMeetingRole&&(i.broadcastMeetingRole=a.broadcastMeetingRole,n.telemetryHelper.setBroadcastMeetingRole(a.broadcastMeetingRole)),r.onMeetingGroupDetailsUpdated(a?.meetingGroupDetails,t)}if(e?.meetingRole&&n.telemetryHelper.setMeetingRole(e.meetingRole),e?.advancedMeetingRole&&n.telemetryHelper.setAdvancedMeetingRole(e.advancedMeetingRole),e?.participantType&&n.telemetryHelper.setParticipantType(e.participantType),e&&(i.endpointDetails=e.endpointDetails||[],i.acceptedBy=e.acceptedBy,i.role=e.role,i.meetingRole=e.meetingRole,i.advancedMeetingRole=e.advancedMeetingRole,i.participantType=e.participantType,i.tenantId=e.tenantId,i.isLobby=e.isLobby,i.publishedStates=e.publishedStates,i.isStaging=s,i.version=e.version,i.propertyBag=e.propertyBag,i.isIdentityMasked=e.isIdentityMasked,i.maskedIdSeqNumber=e.maskedIdSeqNumber,i.maskedId=e.maskedId,void 0!==e?.joinAsStreamingUser&&(i.joinAsStreamingUser=e.joinAsStreamingUser),void 0!==e?.enableCaptcha&&(i.enableCaptcha=e.enableCaptcha),this.participantManager.localParticipant.fromRoster=!0,r.onSelfParticipantUpdated(i,t)),this.isParticipantInCall(e)){const i=this.participantManager.participantOperationHandler,r=this.getRnlMri(e,t);r&&i.hasPendingOperation(0,r,t)&&(this.logger.info(`RNL participant ${we(r)} appears in roster. Resolving AddParticipant request`),n.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,r),i.resolvePendingOperation(0,r,e,t))}}checkForRemovedParticipants(e,t,i){const n=this.participantManager.signalingSessionCallback,r=this.participantManager.signalingSession,s=this.participantManager.participantOperationHandler;this.logger.info(`[${i}][checkForRemovedParticipants]`);for(const t of Object.keys(e))e.hasOwnProperty(t)&&!1!==e[t]&&!s.hasPendingOperation(0,t,i)&&(ms(this.participantManager.connectedRemoteParticipantIds,t),this.logger.info(`[${i}][checkForRemovedParticipants] ${we(t)} removed from roster`),n.onParticipantRemoved({id:t},i),r.clearParticipantCallLinks(t));this.handleRemoveParticipantRequests(t,i)}handleRemoveParticipantRequests(e,t){const i=this.participantManager.signalingSession,n=this.participantManager.participantOperationHandler;this.logger.info(`handleRemoveParticipantRequests [${t}] dynamicRosterParticipants`);const r=[];Object.keys(e).forEach((t=>{const i=Ls.fromRoster(e[t]);i&&i.endpointDetails&&i.endpointDetails.forEach((e=>{e.originalId&&r.push(e.originalId)}))}));const s=n.getAllPendingOperations(3,t);for(const a of Object.keys(s))-1!==r.indexOf(a)||e.hasOwnProperty(a)||(this.logger.info(`[${t}][handleRemoveParticipantRequests] ${we(a)} no longer appears in roster. Resolving RemoveParticipant request`),ms(this.participantManager.connectedRemoteParticipantIds,a),i.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,a),n.resolvePendingOperation(3,a,{id:a},t))}},bh=class{constructor(e,t,i,n){this.connectedRemoteParticipantIds={},this.disposed=!1,this.unmuteApprovalLinks={},this._asyncMuteUnmuteDefers=new Map,this.muteAsyncEnabled=!1,this.unmuteAsyncEnabled=!1,this.setLocalParticipantId=(e,t)=>{e&&(this.logger.info(`[${t}][setLocalParticipantId][participantId=${e}]`),this.localParticipant.participantId=e,this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId))},this.setStaleCheckForFullRoster=e=>{this.rosterManager.setStaleCheckForFullRoster(e)},this.setEnableMuteAsync=e=>{this.muteAsyncEnabled=e},this.setEnableUnmuteAsync=e=>{this.unmuteAsyncEnabled=e},this.admitParticipantAsync=(e,t,i)=>{const n=`[${i}][admitParticipantAsync]`;this.logger.info(`${n}${this.piiUtils.scrubMriOrOmit(e.id)}`);const r=Is();return this.participantOperationHandler.hasPendingOperation(1,e.id,i)?(this.logger.info(`${n}there is an existing pending request to admit the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),r.reject(new Error("there is an existing pending request to admit the participant"))):(this.participantOperationHandler.setPendingOperation(1,e.id,{participant:e,promise:r,causeId:i},i),this.sendNetworkRequestForAdmittingParticipant(e,t,i)),r.promise},this.addParticipantsAsync=(e,t,i,n,r)=>{const s=`[${r}][addParticipantsAsync]`,a=e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)));this.logger.info(`${s} remoteParticipantsIds: ${a}`);const o=[],c=[];return e.forEach((e=>{const t=Is(),i=3===n.replacementType?e.participantId:e.id;this.connectedRemoteParticipantIds.hasOwnProperty(e.id)?(this.logger.info(`${s}the given participant is already connected to the call ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(0,i,r)?(this.logger.info(`${s}there is an existing pending request to add the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("there is an existing pending request to add the participant"))):(e.participantId||(e.participantId=ss(),this.logger.info(`participantId created ${e.participantId}`)),this.participantOperationHandler.setPendingOperation(0,i,{participant:e,promise:t,causeId:r},r),o.push(e)),c.push(t.promise)})),i&&this.sendNetworkRequestForAddingParticipant(o,t,n,r),c},this.nudgeParticipantsAsync=(e,t,i,n,r,s,a,o)=>(this.logger.info(`[${n}][nudgeParticipantAsync] ${this.piiUtils.scrubParticipantsList(e)}`),i?this.sendNetworkRequestForNudgingParticipants(e,t,n,r,s,a,o):Promise.reject(`[${n}][nudgeParticipantAsync] Call not started`)),this.updateMeetingRolesAsync=(e,t,i,n=rs())=>{const r=Is();if(!e||e.length<1){const e=`[${n}][updateMeetingRolesAsync] participantsInfo cannot be empty or null`,t=new Error(e);t.endCode={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}else if(t)if(i){let s;"attendee"===t?s=od.UPDATE_MEETING_ROLE_ATTENDEE.name:"presenter"===t?s=od.UPDATE_MEETING_ROLE_PRESENTER.name:"organizer"===t?s=od.UPDATE_MEETING_ROLE_ORGANIZER.name:r.reject(new Error(`[${n}] Invalid meetingRole value(${t})`)),this.logger.info(`[${n}][updateMeetingRolesAsync][meetingRole=${t}]`),this.signalingSession.ensureMessageChannelReady(s).then((()=>{this.sendNetworkRequestForUpdatingMeetingRoles(e,t,i,s,n,r)})).catch((e=>{const t=Ne(e);this.logger.info(`[${n}][updateMeetingRolesAsync][failed][reason=${t}]`);const i={...Ss(e,this.signalingSession.signalingAgentConfig).error};r.reject(i)}))}else{const e=`[${n}][updateMeetingRolesAsync] updateMeetingRoleUrl cannot be empty or null`,t=new Error(e);t.endCode={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}else{const e=`[${n}][updateMeetingRolesAsync] meetingRole cannot be empty or null`,t=new Error(e);t.endCode={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}return r.promise},this.updateParticipantInterpretationStateAsync=(e,t,i)=>{const n=`[${i}][updateParticipantInterpretationStateAsync]`,r=e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)));this.logger.info(`${n} remoteParticipantsIds: ${r}`);const s=[],a=[];return e.forEach((e=>{const t=Is();this.participantOperationHandler.hasPendingOperation(5,e.id,i)?(this.logger.info(`${n}there is an existing pending request to update the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("there is an existing pending request to update the participant"))):(this.participantOperationHandler.setPendingOperation(5,e.id,{option:e,promise:t,causeId:i},i),s.push(e)),a.push(t.promise)})),this.sendNetworkRequestToUpdateParticipantInterpretationState(s,t,e,i),a},this.callMeBackAsync=(e,t,i)=>{this.logger.info(`[${i}][callMeBackAsync] ${this.piiUtils.scrubMriOrOmit(e.id)}`);const n=Is();return this.connectedRemoteParticipantIds.hasOwnProperty(e.id)?(this.logger.info(`the given participant is already connected to the call : ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(2,e.id,i)?(this.logger.info(`there is an existing pending request to call back the participant : ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("there is an existing pending request to call back the participant"))):(this.participantOperationHandler.setPendingOperation(2,e.id,{participant:e,promise:n},i),this.sendNetworkRequestForCallMeBack(e,t,i)),n.promise},this.isRosterStale=(e,t)=>this.rosterManager.isRosterStale(e,t),this.removeParticipantAsync=(e,t,i)=>{this.logger.info(`[${i}][removeParticipantAsync] ${this.piiUtils.scrubMriOrOmit(e.id)}`),os(t,"correct removeParticipantUrl is not provided");const n=Is();if(this.participantOperationHandler.hasPendingOperation(3,e.id,i))this.logger.info(`there is an existing pending request to remove the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("there is an existing pending request to remove the participant"));else{this.participantOperationHandler.setPendingOperation(3,e.id,{participant:e,promise:n},i);const r=()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession.telemetryHelper.recordEvent(ha),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(3,e.id,"timed out waiting for participant to not show up in roster",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Yr.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},i)}),Yr.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,e.id)};this.signalingSession.http.sendPostRequest({url:t,payload:_h(this.signalingSession,e),requestName:od.REMOVE_PARTICIPANT_NONE.name,onceTrouterReady:r,causeId:i}).catch((t=>{const n=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][removeParticipantAsync][failed][reason=${Ne(n)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(3,e.id,t,n.error,i))}))}return n.promise},this.removeParticipantEndpointAsync=(e,t,i,n)=>{this.logger.info(`[${n}][removeParticipantEndpointAsync] ${xe(e.endpointId)} [endPointScope] ${i}`),os(t,"correct removeParticipantUrl is not provided");const r=Is();let s="";switch(i){case"all":s=od.REMOVE_PARTICIPANT_OTHERS.name;break;case"specified":s=od.REMOVE_PARTICIPANT_SPECIFIED.name;break;default:return Promise.reject(`invalid scope ${i} removeParticipantEndpointAsync`)}this.participantOperationHandler.setPendingOperation(4,e.endpointId,{participant:e,promise:r,scope:i},n);return this.signalingSession.http.sendPostRequest({url:t,payload:Ch(this.signalingSession,e,i),requestName:s,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(ha),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.endpointId),this.participantOperationHandler.rejectPendingOperation(4,e.endpointId,"timed out waiting for participant endpoint sync response from service",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Yr.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},n))}),Yr.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,e.endpointId)},causeId:n}).then((e=>{if(e.response?.code)if(-1!==[Yr.HTTP_STATUS_CODES.OK,Yr.HTTP_STATUS_CODES.CREATED].indexOf(e.response.code))this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [passed][reason=${Ne(e.response)}]`),r.resolve(e.response);else{const t=new Error("invalid service response for removeParticipantEndpoint");t.endCode={code:e.response.code,subCode:e.response.subcode,phrase:e.response.reason},this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [failed][reason=${Ne(e.response)}]`),r.reject(t)}r.resolve()})).catch((t=>{const r=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [failed][reason=${Ne(r)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.endpointId),this.participantOperationHandler.rejectPendingOperation(4,e.endpointId,Ne(t),r.error,n))})),r.promise},this.getParticipantsToInitiateCallWith=()=>{this.logger.info("getParticipantsToInitiateCallWith");const e=[],t=this.participantOperationHandler.getAllPendingOperations(0,rs());for(const i of Object.keys(t))t.hasOwnProperty(i)&&t[i]&&e.push(t[i].participant);return e},this.initializeForIncomingCall=e=>{this.logger.info("initializeForIncomingCall"),this.participantOperationHandler.dispose("incoming calls cannot add/remove participants until call is connected",null,rs())},this.handleAddParticipantSuccess=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAddParticipantSuccess(${t.participantInfos?"new format":"old format"})]${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(ua,e),this.internalHandleCallMeBackSuccess(t,i)||this.signalingSession.telemetryHelper.recordEvent(ua),this.signalingSession.signalingAgentConfig.enableAddParticipantEnhancements&&this.internalHandleAcceptedByParticipants(t,i)},this.handleAddParticipantFailure=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAddParticipantFailure(${t.participantInfos?"new format":"old format"})][${Ne(t)}]`),t.modalityFailure?(this.logger.info(`[${i}][handleAddParticipantFailure][modalityFailure=${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(fa,e)):this.internalHandleAddParticipantFailure(e,i)},this.handleAdmitParticipantSuccess=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAdmitParticipantSuccess][${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(pa,e),t.participants&&this.internalHandleAdmitParticipantSuccess(e,i)},this.handleAdmitParticipantFailure=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAdmitParticipantFailure][${Ne(t)}]`),t.participants&&this.internalHandleAdmitParticipantFailure(e,i)},this.handleRemoveParticipantFailure=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleRemoveParticipantFailure][${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(va,e);for(const e of Object.keys(t.participants))t.participants.hasOwnProperty(e)&&this.internalHandleRemoveParticipantFailure(e,t.participants[e],i)},this.handleRemoveParticipantSuccess=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleRemoveParticipantSuccess][${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Sa,e)},this.handleUnmuteConfirmRequest=e=>{const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleUnmuteConfirmRequest][${Ne(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(_o,e),this.unmuteApprovalLinks[t.from.id]={approve:t.links.approveUnmute,reject:t.links.rejectUnmute},this.signalingSessionCallback.onUnmuteRequested(t.from.id,i)},this.approveUnmuteRequestAsync=(e,t)=>{this.logger.info(`[${t}][approveUnmuteRequestAsync]`);const i=Is();return this.unmuteApprovalLinks.hasOwnProperty(e)?(this.signalingSession.ensureMessageChannelReady(od.APPROVE_UNMUTE.name).then((()=>{this.muteUnmute(od.APPROVE_UNMUTE.name,function(e){return cs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}(this.signalingSession),i,this.unmuteApprovalLinks[e].approve,t)})).catch((e=>{const n=Ne(e);this.logger.info(`[${t}][approveUnmuteRequestAsync][failed][reason=${n}]`),i.reject(new Error(e))})),i.promise):(i.reject(new Error("no unmute links found for given participant")),i.promise)},this.rejectUnmuteRequestAsync=(e,t,i)=>{this.logger.info(`[${t}][rejectUnmuteRequestAsync]`);const n=Is();if(!this.unmuteApprovalLinks.hasOwnProperty(e))return n.reject(new Error("no unmute links found for given participant")),n.promise;const r=i||{code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UNMUTE_REQUEST_REJECTED,phrase:Yr.CALL_END_PHRASE.UNMUTE_REQUEST_REJECTED};return this.signalingSession.ensureMessageChannelReady(od.REJECT_UNMUTE.name).then((()=>{this.muteUnmute(od.REJECT_UNMUTE.name,function(e,t){return cs(e,"signalingSession cannot be null"),ls(t),{payload:{transactionEnd:t}}}(this.signalingSession,r),n,this.unmuteApprovalLinks[e].reject,t)})).catch((e=>{const i=Ne(e);this.logger.info(`[${t}][rejectUnmuteRequestAsync][failed][reason=${i}]`),n.reject(new Error(e))})),n.promise},this.handleRosterUpdate=(e,t,i)=>{const n=this.getCurrentParticipantsInCallModality(!1);this.rosterManager.handleRosterUpdate(e,n,t,i)},this.updateLocalParticipantFromSubscribe=(e,t)=>{this.localParticipant.fromRoster||this.rosterManager.updateLocalParticipantFromSubscribe(e,t)},this.muteAsync=(e,t,i,n)=>{this.logger.info(`[${n}][muteAsync][muteScope=${t}]`);let r="specified";const s=[];let a=od.MUTE_SPECIFIED;switch(t){case Yr.MUTE_SCOPE.MYSELF:a=od.MUTE_MYSELF,s.push({id:this.localParticipant.id});break;case Yr.MUTE_SCOPE.EVERYONE_ELSE:a=od.MUTE_ALL_SYNC,r="all",i.forEach((e=>{s.push({id:e})}));break;case Yr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS:os(i,`[${n}]array of participantIds must be specified for SPECIFIED_PARTICIPANTS mute scope`),a=od.MUTE_SPECIFIED_SYNC,i.forEach((e=>{s.push({id:e})}));break;default:as(!1,`[${n}]muteScope is a required param. please pass in a valid value.`)}const o=Is();if(t===Yr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS){const e=this.areParticipantsConnectedToCall(i);if(!e.result)return o.reject(new Error(`[${n}]specified participant is not connected to call yet. Id = ${e.participant}`)),o.promise}const c=this.muteAsyncEnabled&&(t===Yr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS||t===Yr.MUTE_SCOPE.EVERYONE_ELSE);return this.signalingSession.ensureMessageChannelReady(a.name).then((()=>{this.muteUnmute(a.name,function(e,t,i,n=!1,r=null){cs(e,"signalingSession cannot be null"),cs(t,"muteScope be null"),cs(i,"participantList cannot be null");const s={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:t,muteParticipants:i,mediaTypes:["audio"]};return n&&(s.links={clientCallback:Zr(e,Pr.MUTE_UNMUTE_ASYNC,r)},s.operationId=r),{payload:s}}(this.signalingSession,r,s,c,n),o,e,n,!1,c)})).catch((e=>{const t=Ne(e),i=Ss(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][muteAsync][failed][reason=${t}]`),o.reject(i)})),o.promise},this.unmuteAsync=(e,t)=>{this.logger.info(`[${t}][unmuteAsync]`);const i=Is();return this.signalingSession.ensureMessageChannelReady(od.UNMUTE_SYNC.name).then((()=>{this.muteUnmute(od.UNMUTE_SYNC.name,function(e,t=!1,i=null){cs(e,"signalingSession cannot be null");const n={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaTypes:["audio"]};return t&&(n.links={clientCallback:Zr(e,Pr.MUTE_UNMUTE_ASYNC,i)},n.operationId=i),{payload:n}}(this.signalingSession,this.unmuteAsyncEnabled,t),i,e,t,!0,this.unmuteAsyncEnabled)})).catch((e=>{const n=Ne(e);this.logger.info(`[${t}][unmuteAsync][failed][reason=${n}]`),i.reject(new Error(e))})),i.promise},this.dispose=(e,t)=>{this.logger.info(`[${t}][dispose]`),this.disposed=!0,this.participantOperationHandler.dispose("call ended",e,t),this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId)},this.handleMuteUnmuteAsyncResponse=e=>{const t=Cs(e),i=this.logger.createFnLogger("handleMuteUnmuteAsyncResponse",t);if(!e.body)return void i.error("ignored. Empty message body.");const n={info:e.body.muteUnmuteResponseAsync,operationId:e.body.operationId};if(i.info(`Received async response for mute/unmute operation, operation id = ${n.operationId}.`),this.disposed)return void i.info("ignored. Call disposed.");if(!n.operationId)return void i.error("operationId is undefined.");const r=this._asyncMuteUnmuteDefers.get(n.operationId);r?(r.resolve(n),this._asyncMuteUnmuteDefers.delete(n.operationId)):i.warn(`cannot find deferred promise for operation id [${n.operationId}].`)},this.internalHandleAcceptedByParticipants=(e,t)=>{if(e?.participantInfos){const i=e.participantInfos,n=this.getCurrentParticipantsInCallModality(!1);this.logger.info(`[${t}][internalHandleAcceptedByParticipants] handling participants with acceptedBy blob.`);for(const e of i)if(e?.acceptedBy){const i=e.id;this.participantOperationHandler.hasPendingOperation(0,i,t)&&(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,i),this.logger.info(`[${t}][internalHandleAcceptedByParticipants] ${this.piiUtils.scrubMriOrOmit(i)} added using a different MRI. Resolving operation.`),this.participantOperationHandler.resolvePendingOperation(0,i,void 0,t)),this.rosterManager.handleParticipantAcceptedBy(e,n,t)}}},this.internalHandleCallMeBackSuccess=(e,t)=>{let i=!1;if(e?.participantInfos){const n=e.participantInfos;for(const e of n){const n=e.id;this.internalHandleCallMeBackSuccessHelper(n,t)&&(i=!0)}}else if(e?.participants)for(const n of e.participants)this.internalHandleCallMeBackSuccessHelper(n,t)&&(i=!0);return i},this.signalingSession=e,this.signalingSessionCallback=t,this.localParticipant=i,this.localParticipant.endpointId||(this.localParticipant.endpointId=this.signalingSession.getEndpointId());const r=xe(this.localParticipant.endpointId);this.logger=n.createChild((()=>`[PM][${r}]`)),this.piiUtils=e.piiUtils,this.participantOperationHandler=new Sh(e.logger.createChild((()=>`[ParticipantOperationHandler][${r}]`))),this.rosterManager=new Ih(this,e.logger.createChild((()=>`[RosterManager][${r}]`))),this.localParticipant.participantId||(this.localParticipant.participantId=ss()),"string"==typeof e.signalingAgentConfig.languageCode?this.localParticipant.languageId=e.signalingAgentConfig.languageCode:"function"==typeof e.signalingAgentConfig.languageCode&&(this.localParticipant.languageId=e.signalingAgentConfig.languageCode()),e.telemetryHelper.setParticipantId(this.localParticipant.participantId),e.telemetryHelper.setEndPointId(this.localParticipant.endpointId)}handleUpdateParticipantInterpretationStateCompletion(e){const t=e.body,i=Cs(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleUpdateParticipantInterpretationStateCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleUpdateParticipantInterpretationStateCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateParticipantInterpretationStateCompletion] starts`);const r=e.body;if(r.participantInfos)for(const t of r.participantInfos)if(this.logger.info(t),this.participantOperationHandler.hasPendingOperation(5,t.participant.id,i))if(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,t.participant.id),t.transactionEnd.code===Yr.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${i}]Update participant interpretation state succeeded for: ${this.piiUtils.scrubMriOrOmit(t.participant.id)}`),this.signalingSession.telemetryHelper.recordIncomingEvent(Ol,e),this.participantOperationHandler.resolvePendingOperation(5,t.participant.id,void 0,i);else{const n=t.transactionEnd.reason;this.logger.info(`[${i}]Update participant interpretation state failed for: ${this.piiUtils.scrubMriOrOmit(t.participant.id)} reason : ${Ne(n)}`);const r=this.getCallEndGivenParticipantFailure(n);this.signalingSession.telemetryHelper.recordIncomingEvent(Dl,e,r),this.participantOperationHandler.rejectPendingOperation(5,t.participant.id,r.phrase,r,i)}}areParticipantsConnectedToCall(e){this.logger.info(`areParticipantsConnectedToCall : ${Ne(e)}`);const t=this.getCurrentParticipantsInCallModality(!0);for(const i of e)if(!t.hasOwnProperty(i))return this.logger.info(`areParticipantsConnectedToCall : returning false for :${this.piiUtils.scrubMriOrOmit(i)}`),{result:!1,participant:i};return this.logger.info("areParticipantsConnectedToCall : returning true"),{result:!0}}muteUnmute(e,t,i,n,r,s,a=!1){const o=this.logger.createFnLogger("muteUnmute",r);as(2!==this.signalingSession.callMode,"mute/unmute operations are not allowed in streaming mode"),o.info(`operation=${e}, isAsync=${a}`),n?(s&&this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UNMUTE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Co),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UNMUTE);const e=new Error("timed out waiting for response to request");e.endCode={code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UNMUTE_REQUEST_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UNMUTE_REQUEST_TIMEOUT},i.reject(e)}}),Yr.TIMEOUT_VALUES_IN_SECONDS.UNMUTE_TIMEOUT),a&&this._asyncMuteUnmuteDefers.set(r,i),this.signalingSession.http.sendPostRequest({url:n,payload:t,requestName:e,withoutTrouter:!0,causeId:r}).then((t=>{if(!this.disposed)if(a)o.info(`Inline response received for async operation, operation id: ${r}.`);else{if(t.response?.muteUnmuteResponse){const n={info:t.response.muteUnmuteResponse,operationId:t.response.operationId};switch(e){case od.UNMUTE_SYNC.name:case od.MUTE_ALL_SYNC.name:case od.MUTE_SPECIFIED_SYNC.name:i.resolve(n)}}i.resolve()}})).catch((e=>{const t=Ss(e,this.signalingSession.signalingAgentConfig);o.info(`operation failed, reason=${Ne(t)}`),this.disposed||(s&&this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UNMUTE),i.reject(t.error))}))):i.reject(new Error(`[${r}][muteUnmute] cannot be performed now, the link is not yet available`))}sendNetworkRequestForUpdatingMeetingRoles(e,t,i,n,r,s){if(!i){const e=`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed because correct updateMeetingRoleUrl is not provided`;new Error(e).endCode={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),s.reject()}if(!e){const e=`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed because participants list is empty or null`,t=new Error(e);t.endCode={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),s.reject(t)}this.signalingSession.http.sendPostRequest({url:i,payload:Eh(this.signalingSession,e,"specified",t),requestName:n,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Tc,{causeId:r}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE);const e=new Error(`[${r}] Timed out waiting for response to request`);e.endCode={code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_MEETING_ROLE_TIMEOUT},s.reject(e)}}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_ROLE_TIMEOUT)},causeId:r}).then((e=>{s.resolve(e.response)})).catch((e=>{const t=Ne(e);this.logger.info(`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed: ${t}`);const i=new Error(`[${r}][CS response] Forbidden request`),n=Ss(e,this.signalingSession.signalingAgentConfig);i.code=n.error.code,i.subCode=n.error.subCode,i.phrase=n.error.phrase,this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE),s.reject(i))}))}sendNetworkRequestForNudgingParticipants(e,t,i,n,r,s,a){if(t){const o=()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(vo),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,e?e.join():""))}),Yr.TIMEOUT_VALUES_IN_SECONDS.NUDGE_PARTICIPANT_TIMEOUT,e?e.join():"")},c=s||r?function(e,t,i,n,r,s){cs(e,"signalingSession cannot be null"),cs(t,"participantsIds cannot be null");const a=e.groupId?{id:e.groupId}:null,o=n?{threadId:n,messageId:r||null}:null,c=[];return t.forEach((e=>{const t={id:e};c.push(t)})),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},invitationType:Yr.INVITATION_TYPE.NUDGE,to:c},participantInvitationData:s,groupContext:a,groupChat:o,links:{nudgeParticipantSuccess:Zr(e,Pr.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:Zr(e,Pr.CONV_NUDGE_PARTICIPANT_FAILURE)}}}}(this.signalingSession,e,0,s,a,n):function(e,t,i){cs(e,"signalingSession cannot be null"),cs(t,"participantsIds cannot be null");const n=[];return t.forEach((e=>{const t={id:e};n.push(t)})),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},invitationType:Yr.INVITATION_TYPE.NUDGE,to:n},participantInvitationData:i,links:{nudgeParticipantSuccess:Zr(e,Pr.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:Zr(e,Pr.CONV_NUDGE_PARTICIPANT_FAILURE),addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE)}}}}(this.signalingSession,e,n);return this.signalingSession.http.sendPostRequest({url:t,payload:c,requestName:od.NUDGE_PARTICIPANT.name,onceTrouterReady:o,causeId:i}).then((()=>{})).catch((t=>{const n=Ss(t,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${i}][sendNetworkRequestForNudgingParticipant][failed][reason=${Ne(n)}]`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,e?e.join():""),Promise.reject(n.error)}))}return this.logger.info(`[${i}][sendNetworkRequestForNudgingParticipant] failed because correct nudgeParticipantUrl is not provided`),Promise.reject("Missing nudgeParticipant url")}sendNetworkRequestForAddingParticipant(e,t,i,n=rs()){if(t){let r=od.ADD_PARTICIPANT.name,s=Ys,a={};switch(i.replacementType){case 2:r=od.ADD_PARTICIPANT_WITH_PICKUP_CODE.name,s=Hc,a.unparkContent={pickupCode:i.pickupCode};break;case 1:r=od.ADD_PARTICIPANT_WITH_REPLACES.name,s=Xs,a=this.signalingSession.getCallReplacementDetailsForCall(i.callIdToReplace,n);break;case 3:r=od.ADD_PARTICIPANT_WITH_REPLACES.name,s=Xs,a=this.signalingSession.getReplacementDetailsByParticipantLegOfCall(i.callIdToReplace,e[0].id,e[0].replacementParticipantId,n);break;default:r=od.ADD_PARTICIPANT.name,s=Ys,a=null}const o=()=>{e.forEach((e=>{const t=3===i.replacementType?e.participantId:e.id;this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(s,{causeId:n}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,t),this.participantOperationHandler.rejectPendingOperation(0,t,"timed out waiting for participant to show up in roster",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},n))}),Yr.TIMEOUT_VALUES_IN_SECONDS.ADD_PARTICIPANT_TIMEOUT,t)}))},c=i.threadId||i.groupId?vh(this.signalingSession,e,i,a):function(e,t,i,n){cs(e,"signalingSession cannot be null");const r=t.map((e=>(cs(e,"remoteParticipant cannot be null"),{id:e.id,assertedId:e.assertedId,displayName:e.displayName,participantId:e.participantId})));return{payload:{disableUnmute:i&&i.disableUnmute,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,alternateId:i?i.alternateId:null},to:r},participantInvitationData:i.additionalData,replacementDetails:n,links:{addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE)},debugContent:{clientScenario:i.clientScenario}}}}(this.signalingSession,e,i,a);this.signalingSession.http.sendPostRequest({url:t,payload:c,requestName:r,onceTrouterReady:o,causeId:n}).catch((t=>{const r=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][sendNetworkRequestForAddingParticipant] failed:${Ne(t)}`),this.disposed||e.forEach((e=>{const s=3===i.replacementType?e.participantId:e.id;this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,s),this.participantOperationHandler.rejectPendingOperation(0,s,t,r.error,n)}))}))}else this.logger.info(`[${n}][sendNetworkRequestForAddingParticipants] failed because correct addParticipantUrl is not provided`),e.forEach((e=>{const t=3===i.replacementType?e.participantId:e.id;this.participantOperationHandler.rejectPendingOperation(0,t,"correct addParticipantUrl is not provided",{code:Yr.CALL_END_CODE.LOCAL_ERROR,subCode:Yr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Yr.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},n)}))}sendNetworkRequestToUpdateParticipantInterpretationState(e,t,i,n=rs()){if(t){const r=od.UPDATE_PARTICIPANT_INTERPRETATION_STATE.name,s=Ml,a=()=>{const t={code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT};e.forEach((e=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] timed out`),this.signalingSession.telemetryHelper.recordEvent(s,{causeId:n}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,e.id),this.participantOperationHandler.rejectPendingOperation(5,e.id,"timed out waiting to update particiant interpretation state",t,n))}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT,e.id)}))},o=function(e,t,i){return cs(e,"signalingSession cannot be null"),cs(t,"options cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id},to:t,links:{updateParticipantInterpretationStateStatus:Zr(e,Pr.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS)},operationId:i}}}(this.signalingSession,i,n);this.signalingSession.http.sendPostRequest({url:t,payload:o,requestName:r,onceTrouterReady:a,causeId:n}).catch((t=>{const i=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] failed:${Ne(t)}`),this.disposed||e.forEach((e=>{this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,e.id),this.participantOperationHandler.rejectPendingOperation(5,e.id,t,i.error,n)}))}))}else{this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] failed because correct updateParticipantUrl is not provided`);const t={code:Yr.CALL_END_CODE.LOCAL_ERROR,subCode:Yr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Yr.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING};e.forEach((e=>{this.participantOperationHandler.rejectPendingOperation(5,e.id,"correct updateParticipantUrl is not provided",t,n)}))}}sendNetworkRequestForCallMeBack(e,t,i){if(t){const n=()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.CALL_ME_BACK,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(oa,{causeId:i}),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e.id),this.participantOperationHandler.rejectPendingOperation(2,e.id,"timed out waiting for call me back success response",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},i))}),Yr.TIMEOUT_VALUES_IN_SECONDS.CALL_ME_BACK_TIMEOUT,e.id)},r={groupId:this.signalingSession.groupId,threadId:this.signalingSession.threadId,messageId:this.signalingSession.teamsMessageId};this.signalingSession.http.sendPostRequest({url:t,payload:vh(this.signalingSession,[e],r),requestName:od.CALL_ME_BACK.name,onceTrouterReady:n,causeId:i}).catch((t=>{const n=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][sendNetworkRequestForCallMeBack] failed: ${Ne(n)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e.id),this.participantOperationHandler.rejectPendingOperation(2,e.id,t,n.error,i))}))}else this.logger.info(`[${i}][sendNetworkRequestForCallMeBack] failed because correct addParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(2,e.id,"correct addParticipantUrl is not provided",{code:Yr.CALL_END_CODE.LOCAL_ERROR,subCode:Yr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Yr.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},i)}sendNetworkRequestForAdmittingParticipant(e,t,i){if(t){const n=()=>{this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(ta),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(1,e.id,"timed out waiting for participant to show up in roster",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},i))}),Yr.TIMEOUT_VALUES_IN_SECONDS.ADMIT_PARTICIPANT_TIMEOUT,e.id)};this.signalingSession.http.sendPostRequest({url:t,payload:yh(this.signalingSession,e,i),requestName:od.ADMIT_PARTICIPANT.name,onceTrouterReady:n,causeId:i}).catch((t=>{const n=Ss(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][sendNetworkRequestForAdmittingParticipant][failed][reason=${Ne(n)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(1,e.id,t,n.error,i))}))}else this.logger.info(`[${i}][sendNetworkRequestForAdmittingParticipant] failed because correct admitParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(1,e.id,"correct admitParticipantUrl is not provided",{code:Yr.CALL_END_CODE.LOCAL_ERROR,subCode:Yr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Yr.CALL_END_PHRASE.ADMIT_PARTICIPANT_URL_MISSING},i)}getCurrentParticipantsInCallModality(e){const t={},i=[Yr.PARTICIPANT_AUDIO_STATE.CONNECTED];return e||i.push(Yr.PARTICIPANT_AUDIO_STATE.CONNECTING,Yr.PARTICIPANT_AUDIO_STATE.RINGING),this.signalingSessionCallback.getRemoteParticipantCollection()?.forEach((e=>{i.some((t=>t===e.audioState))&&(t[e.mri]=!0)})),t}internalHandleRemoveParticipantFailure(e,t,i){if(this.participantOperationHandler.hasPendingOperation(3,e,i)){this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e),this.logger.info(`[${i}][internalHandleRemoveParticipantFailure] failed for ${this.piiUtils.scrubMriOrOmit(e)} reason ${Ne(t)}`);const n=this.getCallEndGivenParticipantFailure(t);this.participantOperationHandler.rejectPendingOperation(3,e,n.phrase,n,i)}}internalHandleCallMeBackSuccessHelper(e,t){if(this.participantOperationHandler.hasPendingOperation(2,e,t)){const i={id:e};return this.logger.info(`participant : ${this.piiUtils.scrubMriOrOmit(e)} was successfully added. Resolving CallMeBack request`),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e),this.participantOperationHandler.resolvePendingOperation(2,i.id,i,t),!0}return!1}internalHandleAddParticipantFailure(e,t=rs()){const i=e.body;if(i.participantInfos)i.participantInfos.forEach((i=>{const n=[i.participant.participantId],r=this.participantOperationHandler.getRnlMri(n,t)||i.participant.id;this.rejectAddParticipantFailure(r,i.transactionEnd,e,t)}));else if(i.participants)for(const n of Object.keys(i.participants))this.rejectAddParticipantFailure(n,i.participants[n],e,t)}rejectAddParticipantFailure(e,t,i,n){const r=this.getCallEndGivenParticipantFailure(t);this.signalingSession.telemetryHelper.recordIncomingEvent(ga,i,r),this.participantOperationHandler.hasPendingOperation(0,e,n)?(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,e),this.logger.info(`participantAdd failed for : ${this.piiUtils.scrubMriOrOmit(e)} reason : ${Ne(t)}`),this.participantOperationHandler.rejectPendingOperation(0,e,r.phrase,r,n)):this.participantOperationHandler.hasPendingOperation(2,e,n)&&(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e),this.logger.info(`callMeBack failed for : ${this.piiUtils.scrubMriOrOmit(e)} reason : ${Ne(t)}`),this.participantOperationHandler.rejectPendingOperation(2,e,r.phrase,r,n))}internalHandleAdmitParticipantSuccess(e,t){const i=e.body;for(const e of i.participants)this.participantOperationHandler.hasPendingOperation(1,e,t)&&(this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e),this.logger.info(`Admit participant success for : ${this.piiUtils.scrubMriOrOmit(e)}`),this.participantOperationHandler.resolvePendingOperation(1,e,void 0,t))}internalHandleAdmitParticipantFailure(e,t){const i=e.body;for(const n of Object.keys(i.participants))if(this.participantOperationHandler.hasPendingOperation(1,n,t)){this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,n);const r=i.participants[n];this.logger.info(`Admit participant failed for : ${this.piiUtils.scrubMriOrOmit(n)} reason : ${Ne(r)}`);const s=this.getCallEndGivenParticipantFailure(r);this.signalingSession.telemetryHelper.recordIncomingEvent(ma,e,s),this.participantOperationHandler.rejectPendingOperation(1,n,s.phrase,s,t)}}getCallEndGivenParticipantFailure(e){let t={code:e.code,subCode:e.subCode,phrase:e.phrase,resultCategories:e.resultCategories};return e.code===Yr.CALL_END_CODE.CALL_MODALITY_FAILURE&&e.callControllerTransactionEnd?t={...e.callControllerTransactionEnd}:e.code===Yr.CALL_END_CODE.ATC_CONTROLLER_FAILURE&&e.atcControllerTransactionEnd?t={...e.atcControllerTransactionEnd}:e.code===Yr.CALL_END_CODE.CVA_CONTROLLER_FAILURE&&e.cvaControllerTransactionEnd&&(t={...e.cvaControllerTransactionEnd}),t}};function Ah(e,t){return`${e}-${t}`}function Rh(e,t){return`${e}-${t}`}function wh(e,t,i){return`${e}_${t}_${i}`}var Ph=class{constructor(e){this.signalingSession=e,this.scopeAllOperations=new Map,this.mriOperations=new Map,this.legOperations=new Map,this.logger=e.logger.createChild((()=>"[ProxiedMessageNotificationManager]"))}sendProxiedMessageAsync(e,t,i){this.logger.createChild("sendProxiedMessageAsync",e).info(`Url: ${i}`);const n=[],r=[];for(const i of t)if(0!==i.scope){if(1===i.scope)for(const t in i.to)if("participant"===i.to[t].level){const s=Ah(t,i.operationId),a=Is();this.mriOperations.set(s,a),n.push(a.promise),r.push(s),this.startTimeout(e,"participant",s)}else if("endpoint"===i.to[t].level)for(const s in i.to[t].participantLegIdMap){const t=Rh(s,i.operationId),a=Is();this.legOperations.set(t,a),n.push(a.promise),r.push(t),this.startTimeout(e,"endpoint",t)}}else{const t=Is();this.scopeAllOperations.set(i.operationId,t),n.push(t.promise),r.push(i.operationId),this.startTimeout(e,"all",i.operationId)}return this.sendProxiedMessageNetworkRequest(e,t,i,r),n}sendProxiedMessageNetworkRequest(e,t,i,n){const r=function(e,t){cs(e,"signalingSession cannot be null"),os(t,"sendMessageOptions cannot be null or empty");const i=[];for(const n of t){const t=0===n.scope?"all":"specified",r=[];n.to&&Object.keys(n.to).forEach((e=>{n.to[e].participantLegIdMap?Object.keys(n.to[e].participantLegIdMap).forEach((t=>{r.push({id:e,level:n.to[e].level,endpointId:n.to[e].participantLegIdMap[t].endpointId,participantId:t})})):r.push({id:e,level:n.to[e].level})})),i.push({links:{sendMessageStatus:Zr(e,Pr.SEND_MESSAGE_STATUS)},operationId:n.operationId,payload:n.payload,scope:t,to:r,type:n.type})}return{payload:{from:{displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,id:e.participantManager.localParticipant.id,languageId:e.participantManager.localParticipant.languageId??"",participantId:e.participantManager.localParticipant.participantId},messageContent:i}}}(this.signalingSession,t),s=this.logger.createChild("sendProxiedMessageNetworkRequest",e);s.info(`Url: ${i}`),this.signalingSession.http.sendPostRequest({url:i,requestName:od.SEND_PROXIED_MESSAGE.name,payload:r,causeId:e}).catch((t=>{const i=Ss(t,this.signalingSession.signalingAgentConfig);if(s.info(`failed:${Ne(t)}`),this.signalingSession.disposed)s.info("signaling session is already disposed.");else for(const t of n){this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,t);let n=null;this.scopeAllOperations.has(t)?(n=this.scopeAllOperations.get(t),this.scopeAllOperations.delete(t)):this.mriOperations.has(t)?(n=this.mriOperations.get(t),this.mriOperations.delete(t)):this.legOperations.get(t)?(n=this.legOperations.get(t),this.legOperations.delete(t)):s.warn(`could not find resolveString:${t} to reject it.`),null!==n&&n.reject({transactionEnd:i.error,causeId:e,resolveString:t})}}))}startTimeout(e,t,i){const n=this.logger.createChild("startTimeout",e);n.info(`Creating timeout for level ${t} message with resolveString ${i}`),this.signalingSession.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,(()=>{this.signalingSession.telemetryHelper.recordEvent(zl,{causeId:e,resolveString:i}),n.info(`timed out waiting for level [${t}] message with resolveString [${i}]`),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,i);const r="all"===t?this.scopeAllOperations:"participant"===t?this.mriOperations:"endpoint"===t?this.legOperations:null;null!==r?r.has(i)?(r.get(i).reject({transactionEnd:{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.CONVERSATION_NOTIFICATION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.CONVERSATION_NOTIFICATION_TIMEOUT},causeId:e,resolveString:i}),r.delete(i)):n.warn(`Could not find resolveString [${i}] on map for ${t}. Will not reject promise.`):n.warn(`Could not find a operations map for ${t}. Will not reject promise.`)}),Yr.TIMEOUT_VALUES_IN_SECONDS.SEND_MESSAGE_COMPLETION_TIMEOUT,i)}handleProxiedMessageNotificationItem(e,t,i){if(t.info(`Message contains ${e.participantInfos?.length} participantInfos.`),0===this.scopeAllOperations.size&&0===this.mriOperations.size&&0===this.legOperations.size)return void t.info("Received statusMessage but there is no pending operation.");const n=e.operationId;if(this.scopeAllOperations.has(n)){t.info(`Scope all resolveString:${n}`),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,n);const e={transactionEnd:{code:0,subCode:0,phrase:""},causeId:i,resolveString:n};return this.scopeAllOperations.get(n).resolve(e),this.scopeAllOperations.delete(n),void this.signalingSession.telemetryHelper.recordEvent(Wl,{causeId:i,operationId:n,level:"all"})}for(const r of e.participantInfos){const e=0===r.transactionEnd?.code,s=Ah(r.participant.id,n),a=Rh(r.participant.participantId,n);if(s&&this.mriOperations.has(s)){t.info(`Scope mri resolveString:${s}`);const a={transactionEnd:r.transactionEnd,causeId:i,resolveString:s};e?this.mriOperations.get(s).resolve(a):this.mriOperations.get(s).reject(a),this.mriOperations.delete(s),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,s),this.signalingSession.telemetryHelper.recordEvent(Wl,{causeId:i,operationId:n,level:"mri"})}else if(a&&this.legOperations.has(a)){t.info(`Scope legId resolveString:${a}`);const s={transactionEnd:r.transactionEnd,causeId:i,resolveString:a};e?this.legOperations.get(a).resolve(s):this.legOperations.get(a).reject(s),this.legOperations.delete(a),this.signalingSession.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,a),this.signalingSession.telemetryHelper.recordEvent(Wl,{causeId:i,operationId:n,level:"leg"})}else t.warn(`Could not map this participantInfo to any pending operation operationId:${n}`)}}handleProxiedMessageNotification(e){const t=Cs(e),i=this.logger.createChild("handleProxiedMessageNotification",t);let n;n=Array.isArray(e.body?.statuses)?e.body.statuses:[e.body],i.info(`Received ${n.length} proxied message notification(s).`);for(const e of n)this.handleProxiedMessageNotificationItem(e,i,t)}};function Mh(e,t){return cs(e,"signalingSession cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},links:{admitAllStatus:Zr(e,Pr.CONV_ADMIT_ALL_STATUS)},operationId:t,debugContent:{causeId:t}}}}function Dh(e,t,i=!0){cs(e,"signalingSession cannot be null"),cs(t,"joinUrl cannot be null");const n={type:"Delta",rosterUpdate:Zr(e,Pr.CONV_ROSTER_UPDATE)},r=e.getEndpointCapabilities(),s={payload:{attach:{requireMediaContent:i,links:{end:Zr(e,Pr.END)},locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent()},capabilities:null,endpointCapabilities:r,additionalActions:[{input:{capabilities:null,endpointCapabilities:r,conversationRequest:{applicationType:e.participantManager.localParticipant.applicationType,roster:n,links:{conversationEnd:Zr(e,Pr.CONV_END),conversationUpdate:Zr(e,Pr.CONV_UPDATE),localParticipantUpdate:Zr(e,Pr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:Zr(e,Pr.RECEIVE_MESSAGE)}},endpointMetadata:e.endpointMetadata,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}},name:"join",url:t,waitForResponse:!0}]}};return e.signalingAgentConfig.ecsEtag&&(s.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),s.payload.additionalActions.length>0&&e.deviceType&&"default"!==e.deviceType&&(s.payload.additionalActions[0].input.conversationRequest.deviceType=e.deviceType),s}function Oh(e){return cs(e,"signalingSession cannot be null"),{payload:{callAcceptanceAcknowledgement:{links:{mediaRenegotiation:Zr(e,Pr.MEDIA_RENEGOTIATION),transfer:Zr(e,Pr.TRANSFER),replacement:Zr(e,Pr.REPLACE),balanceUpdate:Zr(e,Pr.BALANCE_UPDATE),retargetCompletion:Zr(e,Pr.RETARGET_COMPLETION),controlVideoStreaming:Zr(e,Pr.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:Zr(e,Pr.UPDATE_MEDIA_DESCRIPTIONS)}}}}}function kh(e,t,i,n){cs(e,"signalingSession cannot be null");const r=ds(i);e.telemetryHelper.addOutgoingModalities(r);const s=e.getEndpointCapabilities();return{payload:{callAcceptance:{acceptedBy:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},acceptedCallModalities:r,capabilities:null,endpointCapabilities:s,clientEndpointCapabilities:0!==n?n:null,links:{mediaRenegotiation:Zr(e,Pr.MEDIA_RENEGOTIATION),transfer:Zr(e,Pr.TRANSFER),replacement:Zr(e,Pr.REPLACE),balanceUpdate:Zr(e,Pr.BALANCE_UPDATE),retargetCompletion:Zr(e,Pr.RETARGET_COMPLETION),controlVideoStreaming:Zr(e,Pr.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:Zr(e,Pr.UPDATE_MEDIA_DESCRIPTIONS)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t,pstnContent:e.pstnContent,callKeepAliveInterval:null}}}}function Nh(e){return cs(e,"signalingSession cannot be null"),{payload:{callProgress:{sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},status:"ringing",phrase:"ringing"}}}}function Lh(e,t,i){cs(e,"signalingSession cannot be null"),ls(t);const n={payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,languageId:e.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Yr.CALL_END_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:t}};return i&&t.code===Yr.CALL_END_CODE.CANCEL&&(n.payload.callTransactionEnd.callQualityDiagnosticsInformation=i),n}function xh(e,t){return cs(e,"signalingSession cannot be null"),ls(t),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Yr.CALL_END_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED},callTransactionEnd:t}}}function Uh(e,t){return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:t}}}function Fh(e,t,i,n,r){cs(e,"signalingSession cannot be null");const s={type:"Delta",rosterUpdate:Zr(e,Pr.CONV_ROSTER_UPDATE)},a=e.getEndpointCapabilities(),o=e.groupId?{id:e.groupId}:null,c=e.threadId?{threadId:e.threadId,messageId:e.teamsMessageId||null}:null,l={payload:{conversationRequest:{conversationType:n.conversationType,subject:e.convSubject,suppressDialout:n.suppressDialout,scenario:n.scenario,applicationType:n.applicationType,roster:s,properties:{allowConversationWithoutHost:e.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:e.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:e.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration},links:{conversationEnd:Zr(e,Pr.CONV_END),conversationUpdate:Zr(e,Pr.CONV_UPDATE),localParticipantUpdate:Zr(e,Pr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:Zr(e,Pr.RECEIVE_MESSAGE)}},groupContext:o,groupChat:c,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,meetingRegistrationId:n.meetingRegistrationId,participantPin:n.participantPin}},capabilities:null,endpointCapabilities:a,clientEndpointCapabilities:n.clientEndpointCapabilities?n.clientEndpointCapabilities:null,endpointMetadata:e.endpointMetadata,meetingInfo:e.getMeetingInfo(),meetingData:n.meetingData,meetingPreferences:n.meetingPreferences,endpointState:n.endpointState}};if(n.publishedStates?.publishedStates.length>0){let t=[];t=n.publishedStates.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("joinConversationRequest getPayload() failed to parse state.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),l.payload.publishedStates=t}if(n?.applyServerMute&&(l.payload.participants.from.applyServerMute=n.applyServerMute.value,n.applyServerMute.mediaTypes&&(l.payload.participants.from.mediaTypes=n.applyServerMute.mediaTypes)),e.deviceType&&"default"!==e.deviceType&&(l.payload.conversationRequest.deviceType=e.deviceType),!n.subscribe){const r=ds(i);e.telemetryHelper.addOutgoingModalities(r),l.payload.callInvitation={callModalities:r,replaces:null,transferor:null,links:{progress:Zr(e,Pr.PROGRESS),mediaAnswer:Zr(e,Pr.MEDIA_ANSWER),acceptance:Zr(e,Pr.ACCEPT),redirection:Zr(e,Pr.REDIRECTION),end:Zr(e,Pr.END)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t,pstnContent:e.pstnContent,locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent(),sharedLineCallInvitationContent:n.sharedLineCallInvitationContent,invitationData:n.invitationData,callQueueContext:n.callQueueContext}}if(e.signalingAgentConfig.ecsEtag&&(l.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),r&&(l.payload.debugContent||(l.payload.debugContent={}),l.payload.debugContent.causeId=r),n.clientEndpointDebugContent){l.payload.debugContent||(l.payload.debugContent={});try{l.payload.debugContent.clientDebugContent=JSON.parse(n.clientEndpointDebugContent)}catch(e){as(!1,`Failed to parse ${n.clientEndpointDebugContent}`)}}if(n.captchaContentJson)try{l.payload.conversationRequest.captchaContent=JSON.parse(n.captchaContentJson)}catch(e){as(!1,`Failed to parse ${n.captchaContentJson}`)}return n.callQueueContext&&(l.payload.conversationRequest.callQueueContext=n.callQueueContext),l}function Vh(e,t,i,n){cs(e,"signalingSession cannot be null"),ls(t);const r={payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:n&&"all"!==n?void 0:n},conversationTransactionEnd:{reason:"noError",code:Yr.CALL_END_CODE.SUCCESS,phrase:Yr.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:t}};return i&&t.code===Yr.CALL_END_CODE.CANCEL&&(r.payload.callTransactionEnd.callQualityDiagnosticsInformation=i),r}function Bh(e,t,i){return cs(e,"signalingSession cannot be null"),cs(i,"newOfferLink cannot be null"),{payload:{mediaOfferRequirements:{compatibleContentTypes:t,links:{offerReady:Zr(e,Pr.NEW_MEDIA_OFFER)}}}}}function Hh(e,t){return cs(t,"signalingSession cannot be null"),{payload:{callTransfer:{target:{id:t.participantManager.localParticipant.id},transferor:{details:{id:t.participantManager.localParticipant.id,endpointId:t.participantManager.localParticipant.endpointId,participantId:t.participantManager.localParticipant.participantId,languageId:t.participantManager.localParticipant.languageId},authorizationToken:null},parkType:e,links:{transferAcceptance:Zr(t,Pr.TRANSFER_ACCEPTANCE),transferCompletion:Zr(t,Pr.TRANSFER_COMPLETION)}}}}}function $h(e,t,i){cs(e,"ParkRequestPayload: signalingSession cannot be null");const n={payload:{hold:{holdType:t,links:{holdCompletion:Zr(e,Pr.PARK_COMPLETION)}}}};return i&&(n.payload.debugContent=i),n}function Gh(e,t,i,n,r,s){const a={payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},publishedState:{content:n,level:i,stateType:t,sequenceNumber:e.getPublishStateSequenceNumber()},scope:r}};if(s&&s.length>0){const e=s.map((e=>({id:e})));a.payload.to=e}return a}function jh(e,t){return cs(e,"signalingSession cannot be null"),ls(t),{payload:{callEnd:t}}}function qh(e,t,i,n){const r={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},sequenceNumber:e.getPublishStateSequenceNumber(),scope:t};return"specified"===t?r.stateIds=i:r.stateType=n,{payload:r}}function Wh(e,t){return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},searchOptions:t}}}function zh(e,t,i,n,r){return cs(t,"signalingSession cannot be null"),os(e,"transferTarget cannot be null OR empty"),{payload:{callTransfer:{target:{id:e,endpointType:"TransferTypeVoicemail"===n?"voicemail":void 0},transferor:{details:{id:t.participantManager.localParticipant.id,endpointId:t.participantManager.localParticipant.endpointId,participantId:t.participantManager.localParticipant.participantId,languageId:t.participantManager.localParticipant.languageId},authorizationToken:null},links:{transferAcceptance:Zr(t,Pr.TRANSFER_ACCEPTANCE),transferCompletion:Zr(t,Pr.TRANSFER_COMPLETION)},replacementDetails:i,disableForwardingAndUnanswered:r&&r.disableForwardingAndUnanswered,transferContext:r&&r.clientTransferContext}}}}function Jh(e){return{payload:{transferCompletion:e}}}function Kh(e,t){cs(e,"ResumePayload: signalingSession cannot be null");const i={payload:{resume:{links:{resumeCompletion:Zr(e,Pr.UNPARK_COMPLETION)}}}};return t&&(i.payload.debugContent=t),i}function Yh(e,t){return cs(t,"clientMetadataJson cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},endpointMetadata:t}}}function Qh(e,t,i,n){cs(t,"clientStateJson cannot be null");const r={payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},endpointState:t}};if(i?.publishedStates.length>0){let t=[];t=i.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("updateEndpointState getPayload() failed to parse stateType.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),r.payload.publishedStates=t}return n&&(r.payload.links={updateEndpointStateStatus:Zr(e,Pr.DISABLE_PREHEAT_ASYNC_STATUS)}),r}function Xh(e,t){const i={};return void 0!==t.allowRaiseHands&&(i.allowRaiseHands=t.allowRaiseHands),void 0!==t.attendeeRestrictions&&(i.attendeeRestrictions=t.attendeeRestrictions),void 0!==t.lockMeeting&&(i.lockMeeting=t.lockMeeting),void 0!==t.breakoutRoomsEnabled&&(i.breakoutRoomsEnabled=t.breakoutRoomsEnabled),void 0!==t.allowPresentersToManageBreakoutRooms&&(i.allowPresentersToManageBreakoutRooms=t.allowPresentersToManageBreakoutRooms),void 0!==t.disableMdpClientAudioRecording&&(i.disableMdpClientAudioRecording=t.disableMdpClientAudioRecording),void 0!==t.refreshSettings&&(i.refreshSettings=t.refreshSettings),{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingSettings:i,sequenceNumber:e.getPublishStateSequenceNumber()}}}function Zh(e,t){return cs(e,"signalingSession cannot be null"),{payload:{mediaAnswer:{sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaContent:t,pstnContent:e.pstnContent}}}}function eu(e,t){return cs(e,"signalingSession cannot be null"),{payload:{UpdateMediaDescriptions:{mediaDescriptions:t}}}}var tu=f(p),iu=f(ge()),nu=class{constructor(e,t){this.signalingSession=e,this.logger=t,this.logConversationCallModalityEvent=e=>{const t=this.createCallModalityEvent(e);this.logger.info("sending modality telemetry:",this.getStringifiedEventData(t)),t.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(dd.CONVERSATION_CALL_MODALITY,t)},this.logConversationContentSharingEvent=e=>{e[md.CORRELATION_ID]=this.signalingSession.correlationId,e[hd.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,this.logger.info("sending content sharing telemetry:",this.getStringifiedEventData(e)),e.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(dd.CONVERSATION_CONTENT_SHARING,e)},this.logHttpTelemetryEvent=e=>{e[hd.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,e[gd]=this.getSignalingAgentConfig(),this.logger.info("sending http telemetry:",this.getStringifiedEventData(e)),e.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(dd.CONVERSATION_HTTP_REQUEST,e)},this.getHostDomainInfo=()=>"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>",this.getSignalingAgentConfig=()=>{const e=[],t=this.signalingSession.signalingAgentConfig;return t.supportsCompressedServicePayload&&e.push(pd.SUPPORTS_COMPRESSED_PAYLOAD),t.brokerEnabledOutgoing&&e.push(pd.BROKER_OUTGOING_ENABLED),t.brokerEnabledIncoming&&e.push(pd.BROKER_INCOMING_ENABLED),t.brokerRequestBatching&&e.push(pd.BROKER_REQUEST_BATCHING_ENABLED),t.brokerExclusively&&e.push(pd.BROKER_EXCLUSIVELY_ENABLED),t.supportsSynchronousTrouterResponse&&e.push(pd.SYNC_TROUTER_RESPONSE),t.handleMediaOfferFromPushNotification&&e.push(pd.HANDLE_OFFER_FROM_NOTIFICATION),t.handleNewOfferRequest&&e.push(pd.HANDLE_NEW_OFFER_REQUEST),t.sendProgressFromCC&&e.push(pd.SEND_PROGRESS_FROM_CC),t.useInternalHttpDispatcher&&e.push(pd.INTERNAL_HTTP_DISPATCHER),t.enableTokenCache&&e.push(pd.ENABLE_TOKEN_CACHE),t.enableTokenPrefetch&&e.push(pd.ENABLE_TOKEN_PREFETCH),t.supportMediaRetargetWhileIncomingRenegotiation&&e.push(pd.SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION),t.enableCallEstablishmentTimeoutsForStartJoinCall&&e.push(pd.ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL),t.enableTokenCacheForGenericTokenAPI&&e.push(pd.ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API),t.enableLongOutgoing1To1SetupTimeoutForWeb&&e.push(pd.ENABLE_LONG_OUTGOING_1TO1_SETUP),e.push(pd.SERVER_MUTE_UNMUTE),e.join(",")},this.getStringifiedEventData=e=>{try{return JSON.stringify(e)}catch(e){return"invalid data"}},this.telemetryLogger=this.signalingSession.signalingAgentConfig.oneDsTelemetryLogger??this.signalingSession.signalingAgentConfig.telemetryManager}createCallModalityEvent(e){const t={};t.Type=ld.NGC_SOURCE;const i=(i,n=!1)=>{e.hasOwnProperty(i)&&(t[i]=n?JSON.stringify(e[i]):e[i])};if(t.ResultDetail=e[hd.RESULT_DETAIL],t.ResultValue=e[hd.RESULT_VALUE],t.ResultCode=e[hd.CALL_END_CODE],t.ResultCauseId=e[hd.RESULT_CAUSE_ID],t[gd]=this.getSignalingAgentConfig(),t[md.CORRELATION_ID]=this.signalingSession.correlationId,t[md.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,t[md.ENDPOINT_ID]=e[md.ENDPOINT_ID],t[md.PARTICIPANT_ID]=e[md.PARTICIPANT_ID],t[hd.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,t[hd.CONVERSATION_SERVICE_URL]=e[hd.CONVERSATION_SERVICE_URL],t[hd.CALL_START_TIME]=JSON.stringify(e[hd.CALL_START_TIME]),t[hd.CALL_END_TIME]=JSON.stringify(e[hd.CALL_END_TIME]),t[hd.MESSAGING_CHANNEL]=JSON.stringify(e[hd.MESSAGING_CHANNEL]),t[hd.IS_GROUP_CALL]=this.signalingSession.multiParty?"true":"false",t[hd.IS_HOSTLESS_CALL]=this.signalingSession.isHostLessCall?"true":"false",t[hd.IS_CAST_CALL]=this.signalingSession.isCastCall?"true":"false",t[hd.IS_HUDDLE_GROUP_CALL]=this.signalingSession.isHuddleGroupCall?"true":"false",t[hd.IS_ON_BEHALF_OF_CALL]=this.signalingSession.onBehalfOf?"true":"false",t[hd.CLIENT_INFORMATION]=e[hd.CLIENT_INFORMATION],t[hd.IS_SDP_IN_CALL_NOTIFICATION]=e[hd.IS_SDP_IN_CALL_NOTIFICATION],t[hd.CALL_TERMINATING_END]=e[hd.CALL_TERMINATING_END],t[hd.CALL_END_CODE]=JSON.stringify(e[hd.CALL_END_CODE]),t[hd.CALL_END_SUB_CODE]=JSON.stringify(e[hd.CALL_END_SUB_CODE]),i(md.SHARED_CORRELATION_ID),i(hd.DIRECTION),i(hd.SELF_PARTICIPANT_ROLE),i(hd.CONNECTED_DURATION_IN_MS,!0),i(hd.TIME_TO_RING_IN_MS,!0),i(hd.NETWORK_REQUESTS_COMPLETED),i(hd.NETWORK_REQUESTS_PENDING),i(hd.LOCAL_OPERATIONS_PERFORMED),i(hd.EVENT_TIMESTAMP_BAG),i(hd.ROSTER_UPDATES_BAG),i(hd.NETWORK_REQUESTS_BAG),i(hd.TROUTER_WAIT_OPERATIONS),i(hd.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS),i(hd.OUTGOING_MODALITIES),i(hd.INCOMING_MODALITIES),i(hd.OFFERED_MODALITIES),i(hd.ANSWERED_MODALITIES),i(hd.VBSS_OPERATIONS),i(hd.CALLER_TYPE),i(hd.CALLEE_TYPE),i(hd.SCENARIO),i(hd.PREHEATED_CALL_SETUP_DURATION_IN_S),i(hd.CALL_CANCELATION_DURATION_IN_S),i(hd.IS_PREHEATED),i(hd.ACS_RESOURCE_ID),i(hd.CALL_END_RESULT_CATEGORIES),i(hd.APPLICATION_TYPE),i(hd.RING),i(hd.REGION),i(hd.PARTITION),i(hd.JOINED_FROM),i(hd.MEETING_URL),i(hd.MEETING_CODE),i(hd.USER_HEX_CID),i(hd.BROADCAST_MEETING_ROLE),i(hd.MEETING_ROLE),i(hd.ADVANCED_MEETING_ROLE),i(hd.PARTICIPANT_TYPE),i(hd.AUDIO_ONLY_WATERMARK),i(hd.TARGET_APPLICATION_TYPE),i(hd.IS_REINVITELESS),i(hd.CLIENT_TYPE),this.signalingSession.callType&&(t[hd.CALL_TYPE]=this.signalingSession.callType),this.signalingSession.signalingAgentConfig.testCall&&(t[hd.TEST_CONTEXT_ID]="Test"),this.signalingSession.groupId&&(t[md.GROUP_ID]=we(this.signalingSession.groupId)),this.signalingSession.threadId&&(t[md.THREAD_ID]=Me(this.signalingSession.threadId)),this.signalingSession.teamsMessageId&&(t[md.TEAMS_MESSAGEID]=this.signalingSession.teamsMessageId),this.signalingSession.getMeetingInfo()){const e={...this.signalingSession.getMeetingInfo()};e.hasOwnProperty("organizerId")&&(e.organizerId=we(e.organizerId)),t[md.TEAMS_MEETINGINFO]=JSON.stringify(e)}return this.signalingSession.multiParty&&0===this.signalingSession.numberOfOriginalInvitees&&e.hasOwnProperty(hd.SELF_PARTICIPANT_ROLE)&&e[hd.SELF_PARTICIPANT_ROLE]===yd.CALLER&&(t[hd.IS_MEETUP_CALL]="true"),t}};var ru=class{constructor(e,t,i){this.signalingSession=e,this.callStartTime=i,this.networkRequestsCompleted=[],this.networkRequestsStarted={},this.networkRequests={},this.localOperationsPerformed=[],this.recordedEvents=[],this.rosterUpdates=[],this.contentSharingOperationsPerformed={},this.outgoingModalities=[],this.incomingModalities=[],this.offeredModalities="",this.answeredModalities="",this.vbssOperations=[],this.vbssStarted=!1,this.localOfferAnswerGenerationTimestamps=[],this.trouterWaitOperations=[],this.telemetryData={},this.contentSharingBaseTelemetryData={},this.httpRequestTelemetryData={},this.connectedStopWatch=null,this.preheatedCallSetupDurationWatch=null,this.callCancelationDurationWatch=null,this.timeToRingStopWatch=null,this.isSdpInCallNotification=!1,this.isPreheated=0,this.isReinviteless=0,this.addBrokerChannel=()=>{this.setMessagingChannel(ud.BROKER)},this.addTrouterChannel=()=>{this.setMessagingChannel(ud.TROUTER)},this.addTrouterWaitOperation=e=>{this.trouterWaitOperations.push(this.recordOperation(e))},this.recordIncomingEvent=(e,t,i)=>{const n=Cs(t),r={origin:t.origin,causeId:n,data:i};i||delete r.data,this.recordEvent(e,r)},this.recordIncomingEventCount=e=>{this.localOperationsPerformed.push(this.recordOperation(e));const t=this.recordedEvents.findIndex((t=>t[e]));if(-1!==t)this.recordedEvents[t][e]+=1;else{const t={};t[e]=1,this.recordedEvents.push(t)}},this.recordEvent=(e,t)=>{this.logger.debug("Event:",e,t),this.localOperationsPerformed.push(this.recordOperation(e));const i={};i[e]=this.timeSinceCallStart(),t&&(i.data=t),this.recordedEvents.push(i)},this.recordRosterEvent=(e,t,i)=>{this.localOperationsPerformed.push(this.recordOperation(t));const n={data:e,causeId:i},r={eventName:this.timeSinceCallStart(),data:n};this.rosterUpdates.push(r)},this.addOutgoingModalities=e=>{e&&this.outgoingModalities.push(e)},this.addIncomingModalities=e=>{e&&this.incomingModalities.push(e)},this.setOfferedModalities=(e,t)=>{this.offeredModalities=this.sdpTelemetryFormat(e,t)},this.setAnsweredModalities=(e,t)=>{this.answeredModalities=this.sdpTelemetryFormat(e,t)},this.setIsSdpInCallNotification=e=>{this.isSdpInCallNotification=e},this.addVbssOperations=e=>{e&&(e===Cd.START?this.vbssStarted=!0:this.vbssStarted=!1,this.vbssOperations.push(this.recordOperation(e)))},this.addNetworkOperationStarted=e=>{ps(this.networkRequestsStarted,e,this.recordOperation(e))},this.addNetworkOperationCompleted=(e,t,i)=>{const n=t?Sd.SUCCESS:Sd.FAILURE,r=i?`${e}:${n}:${i}`:`${e}:${n}`;this.networkRequestsCompleted.push(this.recordOperation(r)),ms(this.networkRequestsStarted,e)},this.updateNetworkRequest=e=>{this.networkRequests[e.uid]?tu.assign(this.networkRequests[e.uid],e):this.networkRequests[e.uid]=e},this.deleteNetworkRequest=e=>{delete this.networkRequests[e.uid]},this.addContentSharingOperation=(e,t,i)=>{this.contentSharingOperationsPerformed[e]||(this.contentSharingOperationsPerformed[e]=[]);const n={[t]:this.timeSinceCallStart()};this.contentSharingOperationsPerformed[e].push(n);const r=this.contentSharingOperationsPerformed[e].length-1;return i&&this.updateContentSharingOperation(e,r,i),r},this.updateContentSharingOperation=(e,t,i)=>{if(!this.contentSharingOperationsPerformed[e])return;const n=this.contentSharingOperationsPerformed[e][t],r=[];for(const e of Object.keys(i))r.push(`${e}: ${i[e]}`);n.data=r.join(", ")},this.setDirection=e=>{this.telemetryData[hd.DIRECTION]=e},this.setEndPointId=e=>{this.telemetryData[md.ENDPOINT_ID]=e,this.contentSharingBaseTelemetryData[md.ENDPOINT_ID]=e,this.httpRequestTelemetryData[md.ENDPOINT_ID]=e},this.setParticipantId=e=>{this.telemetryData[md.PARTICIPANT_ID]=e,this.contentSharingBaseTelemetryData[md.PARTICIPANT_ID]=e,this.httpRequestTelemetryData[md.PARTICIPANT_ID]=e},this.addTokenTelemetry=(e,t)=>{e?this.networkRequests?.[e]?(this.networkRequests[e].tokenTelemetries||(this.networkRequests[e].tokenTelemetries=[]),this.networkRequests[e].tokenTelemetries.push(t)):this.logger.info(`[addTokenTelemtry] httprequest: ${e} is not found in networkRequests`):this.logger.error("[addTokenTelemetry] httprequest uid is undefined")},this.setConversationServiceUrl=e=>{this.telemetryData[hd.CONVERSATION_SERVICE_URL]=e},this.setMeetingInfo=e=>{e||(this.telemetryData[hd.MEETING_INFO]=e)},this.setJoinedFrom=e=>{this.telemetryData[hd.JOINED_FROM]=e},this.setMeetingCode=e=>{this.telemetryData[hd.MEETING_CODE]=e},this.setMeetingUrl=e=>{this.telemetryData[hd.MEETING_URL]=e},this.setBroadcastMeetingRole=e=>{this.telemetryData[hd.BROADCAST_MEETING_ROLE]=e},this.setMeetingRole=e=>{this.telemetryData[hd.MEETING_ROLE]=e},this.setAdvancedMeetingRole=e=>{this.telemetryData[hd.ADVANCED_MEETING_ROLE]=e},this.setParticipantType=e=>{this.telemetryData[hd.PARTICIPANT_TYPE]=e},this.setSelfParticipantRole=e=>{this.telemetryData[hd.SELF_PARTICIPANT_ROLE]=e},this.setAudioOnlyWatermark=e=>{this.telemetryData[hd.AUDIO_ONLY_WATERMARK]=e},this.setWatermarkSupport=e=>{this.telemetryData[hd.CLIENT_SUPPORT_WATERMARK]=e},this.setClientSupportsPreventScreenCapture=e=>{this.telemetryData[hd.CLIENT_SUPPORTS_PREVENT_SCREEN_CAPTURE]=e},this.setScenario=e=>{this.telemetryData[hd.SCENARIO]=e},this.setTargetApplicationType=e=>{e&&(this.telemetryData[hd.TARGET_APPLICATION_TYPE]=e)},this.setCallerType=e=>{e&&(this.telemetryData[hd.CALLER_TYPE]=e.split(":",1)[0])},this.setCalleeType=e=>{e&&(this.telemetryData[hd.CALLEE_TYPE]=e.split(":",1)[0])},this.setTerminatingData=e=>{this.telemetryData[hd.CALL_TERMINATING_END]=e.terminatingEnd,this.telemetryData[hd.CALL_END_CODE]=e.endCode||Yr.CALL_END_CODE.SUCCESS,this.telemetryData[hd.CALL_END_SUB_CODE]=e.endSubCode||Yr.CALL_END_SUB_CODE.SUCCESS,this.telemetryData[hd.CALL_PHRASE]=e.phrase||Yr.CALL_END_PHRASE.UNKNOWN,this.telemetryData[hd.RESULT_VALUE]=e.resultValue||Sd.SUCCESS,this.telemetryData[hd.RESULT_DETAIL]=e.resultDetail||"Call gracefully hungup",this.telemetryData[hd.RESULT_CAUSE_ID]=e.causeId||"unknown",this.telemetryData[hd.CALL_END_RESULT_CATEGORIES]=e.resultCategories||[],this.telemetryData[hd.CALL_END_CLIENT_SUB_CODE]=e.clientReasonSubCode,this.telemetryData[hd.CALL_END_CLIENT_PHRASE]=e.clientReasonPhrase},this.startCallInitializationWatch=e=>{this.timeToRingStopWatch=th(),e&&(this.timeToRingStopWatch.msElapsed+=e)},this.startCallConnectedWatch=()=>{this.connectedStopWatch=th()},this.setIsPreheated=()=>{this.isPreheated=1},this.startPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch=th()},this.stopPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch.pause()},this.startCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=th()},this.stopCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch&&this.callCancelationDurationWatch.pause()},this.getCallCancelationDuration=()=>this.callCancelationDurationWatch?this.callCancelationDurationWatch.durationInSeconds():0,this.resetCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=null},this.setOfferAnswerGenerationTimestamps=e=>{this.localOfferAnswerGenerationTimestamps.push(this.recordOperation(e))},this.setTimeToRingDuration=()=>{this.timeToRingStopWatch&&(this.telemetryData[hd.TIME_TO_RING_IN_MS]=this.timeToRingStopWatch.duration(),this.timeToRingStopWatch=null)},this.dispose=()=>{this.sendCallModalityTelemetryData()},this.setMessagingChannel=e=>{this.telemetryData[hd.MESSAGING_CHANNEL]||(this.telemetryData[hd.MESSAGING_CHANNEL]=[]),this.telemetryData[hd.MESSAGING_CHANNEL].some((t=>-1!==t.indexOf(e)))||this.telemetryData[hd.MESSAGING_CHANNEL].push(this.recordOperation(e))},this.sendHttpTelemetryData=e=>{const t={...this.httpRequestTelemetryData};t[md.CORRELATION_ID]=this.signalingSession.correlationId,t[md.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,t[hd.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation;const i=JSON.stringify({eventStart:this.callStartTime,events:this.networkRequests[e]});ms(this.networkRequests,e),t[hd.NETWORK_REQUESTS_BAG]=i,this.telemetryLogger.logHttpTelemetryEvent(t)},this.sdpTelemetryFormat=(e,t)=>{if(!e)return"";const i=e=>{switch(e){case"main-audio":return"Audio";case"main-video":return"Video";case"applicationsharing-video":return"AppSharing";default:return}},n=e=>{switch(e){case"inactive":return"Inactive";case"sendonly":return t?"ReceiveFromPeer":"SendToPeer";case"recvonly":return t?"SendToPeer":"ReceiveFromPeer";default:return"Bidirectional"}},r={"main-audio":0,"main-video":0,"applicationsharing-video":0},s=[],a=iu.parse(e);for(const e of a.media){const t=i(e.label);if(!t)continue;const a=r[e.label]++,o=n(e.direction);s.push(`${t}[${a}] = ${o}`)}return s.join(", ")},this.setReinviteless=e=>{this.isReinviteless=e?1:0},this.logger=e.logger,this.telemetryLogger=function(e,t){return new nu(e,t)}(e,this.logger),this.telemetryData[hd.CALL_START_TIME]=this.callStartTime,this.telemetryData[hd.CONVERSATION_SERVICE_URL]=e.signalingAgentConfig.conversationServiceUrl,this.fillCommonData(t,this.telemetryData),this.fillCommonData(t,this.httpRequestTelemetryData),this.fillCommonData(t,this.contentSharingBaseTelemetryData)}fillCommonData(e,t){t[hd.APPLICATION_TYPE]=e.applicationType,t[hd.RING]=e.ring,t[hd.TENANT_ID]=e.tenantId,t[hd.USER_HEX_CID]=e.userHexCID,t[hd.ACS_RESOURCE_ID]=e.acsResourceId,t[hd.REGION]=e.region,t[hd.PARTITION]=e.partition,t[hd.CLIENT_TYPE]=e.clientType}addChangingCorrelationId(e,t){this.telemetryData[hd.CHANGING_CORRELATION_ID_OLD_ID]=e,this.telemetryData[hd.CHANGING_CORRELATION_ID_NEW_ID]=t}addSharedCorrelationId(e){this.telemetryData[md.SHARED_CORRELATION_ID]=e}sendContentSharingTelemetryData(e,t,i,n,r,s){const a={...this.contentSharingBaseTelemetryData},o=this.contentSharingOperationsPerformed[e];o&&(a[hd.EVENT_TIMESTAMP_BAG]=JSON.stringify(o)),a[md.CONTENT_SHARING_CORRELATION_ID]=e,a[md.SIGNALING_SESSION_ID]=t,a[md.CONTENT_SHARING_ID]=s||"",a[hd.CONTENT_SHARING_SERVICE_URL]=r,a[hd.CONTENT_SHARING_DIRECTION]=i?vd.OUTGOING:vd.INCOMING,a[hd.CALL_END_CODE]=n.code,a[hd.CALL_END_SUB_CODE]=n.subCode,a[hd.CALL_PHRASE]=n.phrase,a[hd.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(n.resultCategories),a[hd.CALL_END_CAUSE_ID]=n.causeId,a[hd.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,delete this.contentSharingOperationsPerformed[e],this.telemetryLogger.logConversationContentSharingEvent(a)}recordOperation(e){return`${e}:${this.timeSinceCallStart()}`}timeSinceCallStart(){return(new Date).getTime()-this.callStartTime}sendCallModalityTelemetryData(){this.vbssStarted&&this.addVbssOperations(Cd.CALL_END);const e=e=>"number"==typeof e?e/1e3:0;if(this.telemetryData[hd.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,this.telemetryData[hd.CALL_END_TIME]=(new Date).getTime(),this.connectedStopWatch&&(this.telemetryData[hd.CONNECTED_DURATION_IN_MS]=this.connectedStopWatch.duration()),this.telemetryData[hd.IS_PREHEATED]=this.isPreheated,this.preheatedCallSetupDurationWatch&&(this.telemetryData[hd.PREHEATED_CALL_SETUP_DURATION_IN_S]=e(this.preheatedCallSetupDurationWatch.duration())),this.callCancelationDurationWatch&&(this.telemetryData[hd.CALL_CANCELATION_DURATION_IN_S]=e(this.callCancelationDurationWatch.duration())),this.networkRequestsCompleted.length&&(this.telemetryData[hd.NETWORK_REQUESTS_COMPLETED]=JSON.stringify(this.networkRequestsCompleted)),this.localOperationsPerformed.length&&(this.telemetryData[hd.LOCAL_OPERATIONS_PERFORMED]=JSON.stringify(this.localOperationsPerformed)),this.trouterWaitOperations.length&&(this.telemetryData[hd.TROUTER_WAIT_OPERATIONS]=JSON.stringify(this.trouterWaitOperations)),this.localOfferAnswerGenerationTimestamps.length&&(this.telemetryData[hd.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS]=JSON.stringify(this.localOfferAnswerGenerationTimestamps)),this.incomingModalities.length&&(this.telemetryData[hd.INCOMING_MODALITIES]=JSON.stringify(this.incomingModalities)),this.outgoingModalities.length&&(this.telemetryData[hd.OUTGOING_MODALITIES]=JSON.stringify(this.outgoingModalities)),this.offeredModalities.length&&(this.telemetryData[hd.OFFERED_MODALITIES]=this.offeredModalities),this.answeredModalities.length&&(this.telemetryData[hd.ANSWERED_MODALITIES]=this.answeredModalities),this.telemetryData[hd.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(this.telemetryData[hd.CALL_END_RESULT_CATEGORIES]),this.telemetryData[hd.IS_SDP_IN_CALL_NOTIFICATION]=this.isSdpInCallNotification.toString(),this.vbssOperations.length&&(this.telemetryData[hd.VBSS_OPERATIONS]=JSON.stringify(this.vbssOperations)),this.recordedEvents.length){const e=JSON.stringify({eventStart:this.callStartTime,events:this.recordedEvents});this.telemetryData[hd.EVENT_TIMESTAMP_BAG]=e}if(this.rosterUpdates.length){const e=JSON.stringify({eventStart:this.callStartTime,events:this.rosterUpdates});this.telemetryData[hd.ROSTER_UPDATES_BAG]=e}const t=[];for(const e of Object.keys(this.networkRequestsStarted))t.push(this.networkRequestsStarted[e]);t.length>0&&(this.telemetryData[hd.NETWORK_REQUESTS_PENDING]=JSON.stringify(t)),this.telemetryData[hd.IS_REINVITELESS]=this.isReinviteless,this.telemetryLogger.logConversationCallModalityEvent(this.telemetryData)}getResultCategoryString(e){return e&&Array.isArray(e)?e.join(","):""}},su=class{constructor(e,t){this.disposed=!1,this.lastSeenSeqNumbers={},this.isDominantSpeakerInfoLinkEnabled=!0,this.clientUrlsGenerated=!1,this.getClientUrls=()=>{this.clientUrlsGenerated=!0;let e=null;return this.isWebRtcCall&&(e={controlVideoStreaming:Zr(this.signalingSession,Pr.CONTROL_VIDEO_STREAMING),csrcInfo:Zr(this.signalingSession,Pr.CSRC_INFO)},this.isDominantSpeakerInfoLinkEnabled&&(e.dominantSpeakerInfo=Zr(this.signalingSession,Pr.DOMINANT_SPEAKER_INFO))),e},this.handleDominantSpeakerInfo=e=>{const t=e.body;this.logger.debug("handleDominantSpeakerInfo : ",Ne(t)),this.signalingSession.telemetryHelper.recordIncomingEventCount(bo),this.handleWebRtcNotification(Yr.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO,t.dominantSpeakerInformation)},this.handleControlVideoStreaming=e=>{const t=e.body;this.logger.debug("handleControlVideoStreaming: ",Ne(t)),this.signalingSession.telemetryHelper.recordIncomingEvent(Io,e),this.handleWebRtcNotification(Yr.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING,t.controlVideoStreaming,!1)},this.handleCsrcInfo=e=>{const t=e.body;this.logger.debug("handleCsrcInfo : ",Ne(t)),this.signalingSession.telemetryHelper.recordIncomingEvent(Ao,e),this.handleWebRtcNotification(Yr.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO,t.csrcInfo)},this.sendWebRtcMediaNotificationAsync=({operation:e,requestUrl:t,requestBody:i,stackRetry:n=!0},r)=>{this.logger.info("sendWebRtcMediaNotificationAsync"),as(this.isWebRtcCall,"this is not a webrtc call"),os(t,"correct media notification requestUrl is not provided"),os(i,"media notification requestBody cannot be null or empty");const s=Is(),a={url:t,payload:{payload:i},requestName:e,withoutTrouter:!0,causeId:r};return n||(a.disableRetry=!0),this.signalingSession.http.sendPostRequest(a).then((()=>{this.disposed||s.resolve()})).catch((e=>{const t=Ne(e);if(this.logger.error(`sendWebRtcMediaNotificationAsync failed because : ${t}`),!this.disposed){const t=new Error(e);t.endCode=Yr.CALL_END_NETWORK_ERROR,s.reject(t)}})),s.promise},this.dispose=()=>{this.logger.info("WebRtcSignalingManager :: dispose"),this.disposed=!0},this.signalingSession=e,this.signalingSessionCallback=t,this.isWebRtcCall=e.signalingAgentConfig.isWebRtcEnabled,this.logger=e.logger,this.lastSeenSeqNumbers[Yr.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING]=-1,this.lastSeenSeqNumbers[Yr.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO]=-1,this.lastSeenSeqNumbers[Yr.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO]=-1}areClientURLsGenerated(){return this.clientUrlsGenerated}getIsDominantSpeakerInfoLinkEnabled(){return this.isDominantSpeakerInfoLinkEnabled}setIsDominantSpeakerInfoLinkEnabled(e){this.isDominantSpeakerInfoLinkEnabled=e}handleWebRtcNotification(e,t,i=!0){as(this.isWebRtcCall,"ignoring message in non-webrtc call");const n=this.lastSeenSeqNumbers[e];i&&t.sequenceNumber<=n?this.logger.info(`ignoring ${e} . Last seen seq = ${n} current seq = ${t.sequenceNumber}`):(t.sequenceNumber<=n&&this.logger.info(`let listener to handle older ${e} . Last seen seq = ${n} current seq = ${t.sequenceNumber}`),this.lastSeenSeqNumbers[e]=Math.max(t.sequenceNumber,this.lastSeenSeqNumbers[e]),this.signalingSessionCallback.onWebRtcMediaNotification(e,t))}},au=class{constructor(e,t,i,n,r,s){this.disposed=!1,this.convSubject=null,this.groupId=null,this.threadId=null,this.incomingCallCallerId=null,this.incomingCallPayload=null,this.multiParty=!0,this.isIncomingCall=!1,this.isHostLessCall=!1,this.isCastCall=!1,this.isHuddleGroupCall=!1,this.numberOfOriginalInvitees=0,this.teamsMessageId=null,this.enableGroupCallMeetupGeneration=!1,this.meetingInfo=null,this.meetingDetails=null,this.emergencyContent=null,this.transferContext=null,this.callType="default",this.callMode=0,this.transferor=null,this.onBehalfOf=null,this.onBehalfOfUserDisplayName=null,this.callQueueContext=null,this.callPhoneLineType=null,this.endpointMetadata={},this.sessionId=ss(),this.remoteCaller=null,this.acceptedElsewhereBy=null,this.parkAdditionalContextJson=null,this.serverHoldLocation=null,this.breakoutDetails=null,this.callLimits=null,this.complianceRecordingContent=null,this.backroomThreadId=null,this.conversationStartTime=null,this.realTimeState=0,this.disposing=!1,this.links={},this.provisionalMediaAnswersSeenSoFar=[],this.incomingTrouterMessagesSeenSoFar=[],this.incomingBrokerMessagesSeenSoFar=[],this.currentCallStatus=null,this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.convJoined=!1,this.keepAliveTimer=null,this.keepAliveInterval=null,this.keepAliveCount=1,this.conversationKeepAliveTimer=null,this.conversationKeepAliveInterval=null,this.conversationKeepAliveCount=1,this.remoteUser=null,this.mediaTypesToUse=null,this.lastUsedOutgoingMediaContent=null,this.lastUsedJoinCallOptions=null,this.originalRoleBeforePreheat="",this.endpointStateSequenceNumber=0,this.publishStateSequenceNumber=0,this.requestedPublishedStatesWhileConnecting=null,this.linkUpdateRequested={conversationLinks:!1,keepAliveLinks:!1},this.incomingMessageSyncResponseCache={},this.isPreheatOnly=!1,this.callStartTime=(new Date).getTime(),this.callUsesMixer=!1,this.disablePreheatDefer=Is(),this.participantReplacementDetails={},this.meetingLiveStateSequenceNumber=0,this.meetingLayoutSequenceNumber=0,this.localParticipantUpdateSequenceNumber=0,this.isRedirectAllowed=!1,this.updateSequenceNumber=-1,this.isPromotingToRealtime=!1,this.streamInformationReceived=!1,this.startOrJoinConvResponseReceived=!1,this.updateParticipantsPromises={},this.updateEndpointState=(e,t=rs(),i)=>{this.logger.info(`[${t}][requestedEndpointState=${Ne(e,!0)}]`);const n=this.links[Yr.LINKS.UPDATE_ENDPOINT_STATE],r=this.getEndpointState();this.logger.info(`[${t}][currentEndpointState=${Ne(r,!0)}] startOrJoinConvResponseReceived=${this.startOrJoinConvResponseReceived}`);const s={...r,...e,endpointStateSequenceNumber:++this.endpointStateSequenceNumber};this.telemetryHelper.recordEvent(Ho,{newEndpointState:s,causeId:t});const a=e=>0===e?.endpointProperties?.preheatProperties;if(a(s)&&this.isPreheatOnly&&(this.telemetryHelper.recordEvent(bc,{causeId:t}),this.telemetryHelper.startPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallCancelationDurationWatch()),2===this.callMode&&a(s))return this.logger.info(`[${t}][updateEndpointState skipped as mode is streaming]`),this.handleEndpointStateUpdated(t,!0),Promise.resolve();if(!this.startOrJoinConvResponseReceived)return this.logger.info(`[${t}][updateEndpointState will be queued as we don't have a link yet]`),this.requestedEndpointStateWhileConnecting=e,a(s)?(this.requestedPublishedStatesWhileConnecting=i,this.disablePreheatDefer.promise):Promise.resolve();if(!this.shouldUpdateEndpointState(r,s)&&!this.http.hasPendingRequest(od.UPDATE_ENDPOINT_STATE.name))return this.logger.info(`[${t}][updateEndpointState will ignore current update as there is nothing new to send]`),Promise.resolve();if(!n)return this.logger.info(`[${t}][updateEndpointState operation cannot be performed now, the link is not yet available]`),Promise.reject("No link");this.latestEndpointState=s;const o=this.signalingAgentConfig.enableAsyncDisablePreheat&&a(s);o&&this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT,(()=>{const e={code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.DISABLE_PREHEAT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.DISABLE_PREHEAT_TIMEOUT};this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject({response:e})}),Yr.TIMEOUT_VALUES_IN_SECONDS.DISABLE_PREHEAT_TIMEOUT);const c=this.http.sendPostRequest({url:n,requestName:od.UPDATE_ENDPOINT_STATE.name,payload:Qh(this,s,i,o),causeId:t}).then((()=>(o&&(this.logger.info(`[${t}][updateEndpointState] asyncDisablePreheat: true`),this.telemetryHelper.recordEvent(Xl,{causeId:t})),Promise.resolve()))).catch((e=>{if(!o)throw e;this.disablePreheatDefer.reject(e)}));return(o?this.disablePreheatDefer.promise:c).then((()=>{this.logger.info(`[${t}][updateEndpointState] asyncDisablePreheat: ${o}`),this.telemetryHelper.recordEvent(o?Kl:Jl,{causeId:t}),this.disposed||this.handleEndpointStateUpdated(t,a(s))})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[${t}][updateEndpointState] error: ${Ne(i)}`),a(s)&&(this.handleDisablePreheatError(i.error,o?Ql:Yl,t),this.stopCallPreheatTimer(),this.terminateEstablishedCall({code:i.error.code,subCode:i.error.subCode,phrase:i.error.phrase},{forEveryone:!1,causeId:t})),Promise.reject(i.error)}))},this.setParticipantCallLinks=e=>{e&&e.endpointDetails&&(this.participantReplacementDetails[e.id]={},e.endpointDetails.forEach((t=>{t&&t.callLinks&&(this.participantReplacementDetails[e.id][t.participantId]=t.callLinks)})))},this.clearParticipantCallLinks=e=>{this.participantReplacementDetails?.hasOwnProperty(e)&&delete this.participantReplacementDetails[e]},this.getReplacementDetailsByParticipantLeg=(e,t,i=rs())=>(this.logger.info(`[${i}]getReplacementDetailsByParticipantLeg: participantMri ${Oe(e)} participantLegId ${t}`),this.participantReplacementDetails?.hasOwnProperty(e)&&this.participantReplacementDetails[e].hasOwnProperty(t)?{replaces:this.participantReplacementDetails[e][t].replacement,replacementTargetParticipantId:t}:(this.logger.info(`[${i}]getReplacementDetailsByParticipantLeg: unable to find replacement details for participantLegId ${t}`),{})),this.getReplacementDetailsByParticipantLegOfCall=(e,t,i,n=rs())=>{this.logger.info(`[${n}]getReplacementDetailsByParticipantLegOfCall: callId ${e} participantMri ${Oe(t)} participantLegId ${i}`);const r=this.signalingAgent.getSignalingSession(e);return r?r.getReplacementDetailsByParticipantLeg(t,i,n):{}},this.getMriByParticipantLegOfCall=(e,t,i)=>{this.logger.info(`[${i}]getMriByParticipantLegOfCall: callId: ${e} participantLegId ${t}`);const n=this.signalingAgent.getSignalingSession(e);return n?n.getMriByParticipantLeg(t,i):""},this.getMriByParticipantLeg=(e,t)=>{this.logger.info(`getMriByParticipantLeg[${t}] participantLegId ${e}`);for(const t of Object.keys(this.participantReplacementDetails))if(t&&this.participantReplacementDetails.hasOwnProperty(t)&&this.participantReplacementDetails[t]?.hasOwnProperty(e))return t;return""},this.handleEndpointStateUpdated=(e,t)=>{this.requestedEndpointStateWhileConnecting=null,this.requestedPublishedStatesWhileConnecting=null,t&&this.handlePreheatDisabled(e)},this.handlePreheatDisabled=e=>{this.isPreheatOnly=!1,this.telemetryHelper.setSelfParticipantRole(this.originalRoleBeforePreheat),this.telemetryHelper.recordEvent(Ac,{causeId:e}),this.telemetryHelper.resetCallCancelationDurationWatch(),this.telemetryHelper.stopPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallConnectedWatch(),this.stopCallPreheatTimer(),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.resolve()},this.shouldUpdateEndpointState=(e,t)=>{if(!t)return!1;const i=t.state&&t.state.isMuted?1:0,n=t.endpointProperties&&1===t.endpointProperties.preheatProperties?1:0,r=e&&e.state&&e.state.isMuted?1:0,s=e&&e.endpointProperties&&1===e.endpointProperties.preheatProperties?1:0,a=e?.endpointProperties?.additionalEndpointProperties,o=t?.endpointProperties?.additionalEndpointProperties;return!!(i^r||n^s||o!==a)},this.setInitialTelemetry=(e,t)=>{let i,n;switch(e){case"Subscribe":this.telemetryHelper.recordEvent(Na,{causeId:t.causeId,correlationId:t.correlationId}),this.telemetryHelper.setDirection(vd.INCOMING),this.telemetryHelper.setSelfParticipantRole(yd.JOIN_FOR_ROSTER_ONLY),this.telemetryHelper.setConversationServiceUrl(t.conversationServiceUrl||this.signalingAgentConfig.conversationServiceUrl),this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);break;case"Acknowledge":this.telemetryHelper.recordEvent(La,{causeId:t.causeId}),this.telemetryHelper.setDirection(vd.INCOMING),this.telemetryHelper.setSelfParticipantRole(yd.CALLEE),this.telemetryHelper.setCalleeType(this.participantManager.localParticipant.id);break;case"JoinCall":i=this.gatherTelemetryForStartOrJoin(t.joinCallOptions,t.causeId,t.offerGenerationTime),this.telemetryHelper.recordEvent(ka,i),this.telemetryHelper.setDirection(vd.INCOMING),this.telemetryHelper.setSelfParticipantRole(yd.JOIN);break;case"StartCall":case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":n=this.gatherTelemetryForStartOrJoin(t.callStartOptions,t.causeId,t.offerGenerationTime),this.telemetryHelper.recordEvent(Oa,n),this.telemetryHelper.setDirection(vd.OUTGOING),this.telemetryHelper.setSelfParticipantRole(yd.CALLER),this.telemetryHelper.startCallInitializationWatch(t.offerGenerationTime),this.telemetryHelper.setMeetingInfo(this.getMeetingInfo())}},this.getParticipantIdForOfferAnswer=e=>{cs(e,"mediaContent should be a non null value"),this.logger.info("getParticipantIdForOfferAnswer");let t=null;return!this.remoteUser||this.groupId||this.threadId||e.newOffer||e.escalationOccurring||(t=this.remoteUser.id),t},this.getMeetingInfo=()=>this.meetingInfo,this.getEmergencyContent=()=>(this.telemetryHelper.recordEvent(Aa),this.emergencyContent),this.getEndpointId=()=>this.signalingAgent.endpointId,this.getConversationUrl=()=>this.links[Yr.LINKS.CONVERSATION_CONTROLLER],this.setJoinedFrom=e=>{!this.disposed&&e&&(this.telemetryHelper.recordEvent(Ia),this.telemetryHelper.setJoinedFrom(e))},this.setMeetingCode=e=>{!this.disposed&&e&&this.telemetryHelper.setMeetingCode(e)},this.setMeetingUrl=e=>{!this.disposed&&e&&this.telemetryHelper.setMeetingUrl(e)},this.setSubject=e=>{this.disposed||(this.telemetryHelper.recordEvent(Ta),cs(e,"subject should be a non null value"),this.convSubject=e)},this.setDeviceType=e=>{this.disposed||(this.telemetryHelper.recordEvent(ba),e&&(this.deviceType=e,this.logger.info("setDeviceType",this.deviceType)))},this.setOfferAnswerGenerationTimestamps=e=>{this.disposed||this.telemetryHelper.setOfferAnswerGenerationTimestamps(e)},this.setTimeToRingDuration=()=>{this.disposed||this.telemetryHelper.setTimeToRingDuration()},this.setGroupId=e=>{this.telemetryHelper.recordEvent(wa),this.groupId!==e&&e&&(as(!this.groupId,"conversation groupId has already been set. It cannot be overwritten"),this.groupId=e)},this.setThreadId=e=>{this.telemetryHelper.recordEvent(Pa),cs(e,"threadId should be a non null value"),this.threadId!==e&&(as(!this.threadId,"conversation threadId has already been set. It cannot be overwritten"),this.threadId=e)},this.setCallOptions=e=>{if(cs(e,"callOptions should be a non null value"),this.logger.info("setCallOptions",Ne(e)),this.telemetryHelper.recordEvent(Ma),e){this.teamsMessageId=e.teamsMessageId,this.meetingInfo=e.meetingInfo||null,this.emergencyContent=e.emergencyContent||null,this.enableGroupCallMeetupGeneration=e.enableGroupCallMeetupGeneration||!1,e.broadcastContext&&(this.broadcastSession=new Hd(this,this.signalingSessionCallback),this.broadcastSession.setContext(e.broadcastContext));try{this.endpointMetadata=JSON.parse(e.endpointMetadata)}catch(e){this.logger.warn("Unable to parse endpoint metadata")}}},this.setTransferContext=e=>{cs(e,"transferContext should not be null"),this.logger.info("Transfer: setTransferContext",e),this.telemetryHelper.recordEvent(Da),this.transferContext=e},this.muteAsync=(e,t,i=rs())=>(as(2!==this.callMode||e!==Yr.MUTE_SCOPE.MYSELF,"mute self operation is not allowed in streaming mode"),this.logger.info(`[${i}][muteAsync][scope=${e}]`),this.telemetryHelper.recordEvent(So,{causeId:i}),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,`[${i}]mute operation for all or specified only allowed in a connected call`),this.participantManager.muteAsync(this.links[Yr.LINKS.MUTE],e,t,i)),this.unmuteAsync=(e=rs())=>(as(2!==this.callMode,"unmute operation is not allowed in streaming mode"),this.logger.info(`[${e}][unmuteAsync]`),this.telemetryHelper.recordEvent(yo,{causeId:e}),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"unmute operation only allowed in a connected call"),this.participantManager.unmuteAsync(this.links[Yr.LINKS.UNMUTE],e)),this.recordTelemetryForStartAudio=(e,t)=>(this.telemetryHelper.recordEvent(_c,{mediaNegotiationStatus:e,causeId:t}),Promise.resolve(null)),this.recordTelemetryForStopAudio=(e,t)=>(this.telemetryHelper.recordEvent(Ec,{mediaNegotiationStatus:e,causeId:t}),Promise.resolve(null)),this.rejectUnmuteRequestAsync=(e,t=rs(),i)=>(as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"rejectUnmute operation only allowed in a connected call"),os(e,"requestor must be specified"),this.logger.info(`[${t}][rejectUnmuteRequestAsync][rejectionReason=${i}]`),this.telemetryHelper.recordEvent(To,{causeId:t,rejectionReason:i}),this.participantManager.rejectUnmuteRequestAsync(e,t,i)),this.approveUnmuteRequestAsync=(e,t=rs())=>(as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"approveUnmute operation only allowed in a connected call"),os(e,"requestor must be specified"),this.logger.info(`[${t}][approveUnmuteRequestAsync]`),this.telemetryHelper.recordEvent(Eo,{causeId:t}),this.participantManager.approveUnmuteRequestAsync(e,t)),this.sendWebRtcMediaNotificationAsync=(e,t,i=rs())=>(as(2!==this.callMode,"sendWebRtcMediaNotification operation is not allowed in streaming mode"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"webRtc media notification can only be sent in a connected call"),this.telemetryHelper.recordEvent(Ro,{causeId:i}),0===e?this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:od.SEND_APPLY_CHANNEL_PARAMETERS.name,requestUrl:this.links[Yr.LINKS.APPLY_CHANNEL_PARAMETERS],requestBody:t,stackRetry:!1},i):this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:od.SEND_CONTROL_VIDEO_STREAMING.name,requestUrl:this.links[Yr.LINKS.CONTROL_VIDEO_STREAMING],requestBody:t},i)),this.addParticipantsAsync=(e,t,i=rs())=>{os(e,"remoteParticipants should be a non null value"),as(this.isCallOngoing()||this.isCallIdleOrRosterOnly(),"remoteParticipants can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${i}][addParticipantsAsync][addParticipantOptions=${Ne(t)}]\n            [remoteParticipantId=${e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)))}]`);let n=Ks;switch(t.replacementType){case 2:n=Bc;break;case 1:case 3:n=Qs;break;default:n=Ks}this.telemetryHelper.recordEvent(n,{causeId:i}),t.groupId=this.groupId||t.groupId,t.threadId=this.threadId||t.threadId;const r=t.threadId||t.groupId?this.links[Yr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Yr.LINKS.ADD_PARTICIPANT],s=this.participantManager.addParticipantsAsync(e,r,this.isCallConnectedOrConnectedForRoster(),t,i);return this.currentCallStatus||this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,i),s},this.addGroupModalityAsync=(e,t)=>{as(this.isCallOngoing(),"GroupModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${t}][addGroupModalityAsync][addGroupModalityOptions=${Ne(e)}]`);const i=Zs;this.telemetryHelper.recordEvent(i,{causeId:t});const n=vh(this,null,e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.ADD_PARTICIPANTS_AND_MODALITY],payload:n,requestName:od.ADD_PARTICIPANTS_AND_MODALITY.name,causeId:t}).then((()=>{Md.noop()})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);throw this.logger.info(`[${t}][sendNetworkRequestForAddingParticipant] failed:${Ne(i)}`),i.error}))},this.addBroadcastModalityAsync=(e,t)=>{if(as(this.isCallOngoing(),"BroadcastModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${t}][addBroadcastModalityAsync][addBroadcastContext=${Ne(this.addBroadcastModalityAsync)}]`),this.telemetryHelper.recordEvent(po,{causeId:t}),this.broadcastSession){const e="There is already a broadcast session";return this.logger.info(e),Promise.resolve(Yr.SUCCESS_TRANSACTION_END)}this.broadcastSession=new Hd(this,this.signalingSessionCallback),this.broadcastSession.setContext(e);const i=function(e,t){return cs(e,"signalingSession cannot be null"),cs(t,"broadcastContext cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},broadcast:t,links:{addModalitySuccess:Zr(e,Pr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:Zr(e,Pr.CONV_ADD_MODALITY_FAILURE)}}}}(this,e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.ADD_MODALITY],payload:i,requestName:od.ADD_BROADCAST_MODALITY.name,causeId:t}).then((e=>(this.logger.info(`[${t}][addBroadcastModalityAsync] response: ${Ne(e)}`),this.telemetryHelper.recordEvent(fo,{causeId:t}),Yr.SUCCESS_TRANSACTION_END))).catch((e=>{const i=Ss(e);return this.logger.info(`[${t}][sendNetworkRequestForAddBroadcastModalityAsync] failed:${Ne(i)}`),this.endBroadcastMeeting(t),Promise.reject(i.error)}))},this.nudgeParticipantsAsync=e=>{if(cs(e.participantsIds,"ParticipantsIds should be a non null value"),as(this.isCallOngoing(),"Participants can only be nudged before starting an outgoing call or to an ongoing call"),this.logger.info(`[${e.causeId}][nudgeParticipantsAsync][participantsIds=${this.piiUtils.scrubParticipantsList(e.participantsIds)}][invitationData=${e.invitationData}]`),void 0===e.participantsIds||e.participantsIds.length<1)return Promise.reject("List of participants to nudge is empty");this.telemetryHelper.recordEvent(Ks,{withNudge:Yr.INVITATION_TYPE.NUDGE,causeId:e.causeId});const t=this.groupId||e.newGroupId,i=this.threadId||e.newThreadId,n=this.teamsMessageId||e.newMessageId,r=i||t?this.links[Yr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Yr.LINKS.ADD_PARTICIPANT];return this.participantManager.nudgeParticipantsAsync(e.participantsIds,r,this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,e.causeId,e.invitationData,t,i,n)},this.callMeBackAsync=(e,t=rs())=>(cs(e,"remoteParticipant should be a non null value"),this.logger.info(`[${t}][callMeBackAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}]`),this.telemetryHelper.recordEvent(aa,{causeId:t}),this.hasGroupModality()||as(!1,"threadId/groupId must be set before using call me back"),this.participantManager.callMeBackAsync(e,this.links[Yr.LINKS.ADD_PARTICIPANTS_AND_MODALITY],t)),this.removeParticipantAsync=(e,t=rs(),i="none")=>{switch(cs(e,"remoteParticipant should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"participants can only be removed from an ongoing call"),this.logger.info(`[${t}][removeParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}] [removeEndpointScope] ${i}`),i){case"all":this.telemetryHelper.recordEvent(la,{causeId:t});break;case"specified":this.telemetryHelper.recordEvent(da,{causeId:t});break;default:this.telemetryHelper.recordEvent(ca,{causeId:t})}return"none"!==i&&e.endpointId?this.participantManager.removeParticipantEndpointAsync(e,this.links[Yr.LINKS.REMOVE_PARTICIPANT],i,t):this.participantManager.removeParticipantAsync(e,this.links[Yr.LINKS.REMOVE_PARTICIPANT],t)},this.admitParticipantAsync=(e,t=rs())=>(cs(e,"remoteParticipant should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"remoteParticipants can only be admitted to an ongoing call"),this.hasGroupModality()||as(!1,"threadId/groupId must be set before admitting more participants to connected call"),this.logger.info(`[${t}][admitParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}]`),this.telemetryHelper.recordEvent(ea,{causeId:t}),this.participantManager.admitParticipantAsync(e,this.links[Yr.LINKS.ADMIT],t)),this.admitAsync=e=>{if(this.logger.info(`[${e}][admitAsync]`),this.telemetryHelper.recordEvent(ia,{causeId:e}),!this.links[Yr.LINKS.ADMIT_ALL]){const t={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.ADMIT_ALL_LINK_MISSING,phrase:Yr.CALL_END_PHRASE.ADMIT_ALL_URL_MISSING};return this.telemetryHelper.recordEvent(ra,{causeId:e,transactionEnd:t}),this.logger.warn(`admitAsync error ${JSON.stringify(t)}`),Promise.reject(t)}const t=Is();return this.callOperationHandler.setPendingOperation(0,e,{promise:t,causeId:e},e),this.sendNetworkRequestForAdmit(e),t.promise},this.updateMeetingRolesAsync=(e,t,i=rs())=>(cs(e,"participants array should be a non null value"),cs(t,"meetingRole should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"remote participant roles can only be updated in an ongoing call"),this.logger.info(`[${i}][updateMeetingRolesAsync][participants=${this.piiUtils.scrubMriOrOmit(e)}]`),this.participantManager.updateMeetingRolesAsync(e,t,this.links[Yr.LINKS.UPDATE_PARTICIPANT_ROLE],i)),this.startContentSharingAsync=(e,t,i,n,r=rs())=>(cs(e,"contentIdentifier should be a non null value"),as(this.isCallOngoing(),"contentSharing can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${r}][startContentSharingAsync]`),this.telemetryHelper.recordEvent(eo,{causeId:r}),this.contentSharingManager.startContentSharingAsync(e,t,i,this.links[Yr.LINKS.ADD_MODALITY],this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,r,n)),this.deleteContentSharingAsync=(e,t=rs())=>(this.logger.info(`[${t}][deleteContentSharingAsync][correlationId=${e}]`),this.telemetryHelper.recordEvent(io,{causeId:t,correlationId:e}),this.contentSharingManager.deleteContentSharingAsync(e,t)),this.joinContentSharingAsync=(e,t=rs())=>(this.logger.info(`[${t}][joinContentSharingAsync][correlationId=${e}]`),this.telemetryHelper.recordEvent(so,{causeId:t,correlationId:e}),this.contentSharingManager.joinContentSharingAsync(e,t)),this.updateContentSharingSessionStateAsync=(e,t,i=rs())=>(cs(t,"sessionState should be a non null value"),this.telemetryHelper.recordEvent(ro,{causeId:i,correlationId:e}),this.logger.info(`[${i}][updateContentSharingSessionStateAsync][correlationId=${e}][sessionState=${t}]`),this.contentSharingManager.updateContentSharingSessionStateAsync(e,t,i)),this.takeContentSharingControlAsync=(e,t=rs())=>(this.telemetryHelper.recordEvent(no,{causeId:t,correlationId:e}),this.logger.info(`[${t}][takeContentSharingControlAsync][correlationId=${e}]`),this.contentSharingManager.takeContentSharingControlAsync(e,t)),this.updateContentSharingParticipantStateAsync=(e,t=rs())=>(this.telemetryHelper.recordEvent(ao,{causeId:t}),this.logger.info(`[${t}][updateContentSharingParticipantStateAsync][correlationId=${e}]`),this.contentSharingManager.updateContentSharingParticipantStateAsync(e,t)),this.configureEndpointStateForStartOrJoin=e=>{const t={endpointStateSequenceNumber:this.endpointStateSequenceNumber};let i=!1;if(e&&(e.muted&&(i=!0,Object.assign(t,{state:{isMuted:e.muted}})),e.isPreheatOnly||e.additionalEndpointProperties)){const n={};i=!0,e.isPreheatOnly&&(n.preheatProperties=1),e.additionalEndpointProperties&&(n.additionalEndpointProperties=e.additionalEndpointProperties),Object.assign(t,{endpointProperties:n})}if(i)return t},this.gatherTelemetryForStartOrJoin=(e,t,i)=>{const n={causeId:t};return e&&(e.invitationType===Yr.INVITATION_TYPE.NUDGE&&(n.withNudge=e.invitationType===Yr.INVITATION_TYPE.NUDGE),e.parkContext&&(n.unpark=!0,n.context=e.parkContext),e.isPreheatOnly&&(n.isPreheatOnly=!0),e.targetApplicationType&&(n.targetApplicationType=e.targetApplicationType,this.telemetryHelper.setTargetApplicationType(e.targetApplicationType))),n},this.startOutgoingCall=(e,t,i,n,r=rs())=>{if(cs(e,"mediaContent should be a non null value"),cs(e.blob,"outgoingSdp should be a non null value"),as(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.logger.info(`[${r}][startOutgoingCall][start] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${r}][startOutgoingCall][failed][reason=Session disposed]`);this.lastUsedJoinCallOptions={muted:i?i.muted:null,scenario:i?i.scenario:null,isPreheatOnly:i?i.isPreheatOnly:null,clientEndpointCapabilities:i?i.clientEndpointCapabilities:null,clientEndpointDebugContent:i?i.clientEndpointDebugContent:null},this.originalRoleBeforePreheat=yd.CALLER,i&&i.scenario&&this.telemetryHelper.setScenario(i.scenario),this.logger.info(`[${r}][startOutgoingCall]options=${Ne(this.gatherTelemetryForStartOrJoin(i,r,n))}`),this.isBrokerEnabledForOutgoingCall()&&this.setupBrokerChannel(),this.callUsesMixer=!(!i||!i.callUsesMixer),this.fsmState=Yr.SIGNALING_FSM_STATE.OUTGOING,this.meetingData=i?.meetingData,this.meetingPreferences=i?.meetingPreferences;const s={newCall:!0,suppressDialout:i&&i.suppressDialout||!1,conversationServiceUrl:this.signalingAgentConfig.conversationServiceUrl,onBehalfOf:i?i.onBehalfOf:null,onBehalfOfUserDisplayName:i?i.onBehalfOfUserDisplayName:null,callQueueContext:i?i.callQueueContext:null,callToVoicemail:!!i&&i.callToVoicemail,voicemailResourcePath:i?i.voicemailResourcePath:null,voicemailItemId:i?i.voicemailItemId:null,endpointState:this.configureEndpointStateForStartOrJoin(i),invitationType:i&&i.invitationType?i.invitationType:null,participantsToNudge:i&&Array.isArray(i.participantsToNudge)?i.participantsToNudge:null,routingFlags:i?i.routingFlags:null,parkContext:i?i.parkContext:null,pickupCode:i?i.pickupCode:null,scenario:i?i.scenario:null,isPreheatOnly:!!i&&i.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:i?i.clientEndpointCapabilities:0,clientEndpointDebugContent:i?i.clientEndpointDebugContent:null,invitationData:i?i.invitationData:null,conversationType:i?this.getConversationType(i.isEmergency,i.castCall,i.isHuddleGroupCall):null,meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,alternateId:i?i.alternateId:null,meetingRegistrationId:i?i.meetingRegistrationId:null,participantPin:i?i.participantPin:null,publishedStates:i?i.publishedStates:null,targetApplicationType:i?i.targetApplicationType:null,captchaContentJson:i?i.captchaContentJson:null,customHeaderContext:i?i.customHeaderContext:null};this.isCastCall=i&&i.castCall,this.isHuddleGroupCall=i&&i.isHuddleGroupCall,this.onBehalfOf=s.onBehalfOf,this.onBehalfOfUserDisplayName=s.onBehalfOfUserDisplayName,this.callQueueContext=s.callQueueContext,this.startOrJoinCall(s,od.START_CALL.name,r,e,t)},this.joinGivenConversation=(e,t,i,n,r,s={},a=rs())=>{if(cs(t,"correlationId should be a non null value"),os(e||this.getConversationUrl(),"conversationUrl should be a non null value"),cs(i,"mediaContent should be a non null value"),cs(i.blob,"outgoingSdp should be a non null value"),this.isPromotingToRealtime=2===this.callMode,as(this.isCallIdleOrRosterOnly()||this.isPromotingToRealtime,"a call is already in progress"),this.logger.info(`[${a}][joinGivenConversation][start][correlationId=${t}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${a}][joinGivenConversation][failed][reason=Session disposed]`);const o=this.gatherTelemetryForStartOrJoin(s,a,r);this.lastUsedJoinCallOptions=s,this.originalRoleBeforePreheat=yd.JOIN,this.telemetryHelper.startCallInitializationWatch(r),s&&s.scenario&&this.telemetryHelper.setScenario(s.scenario),this.logger.info(`[${a}][joinGivenConversation]options=${Ne(o)}`),this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Yr.SIGNALING_FSM_STATE.OUTGOING,this.updateCorrelationId(t,a),this.meetingData=s?.meetingData,this.meetingPreferences=s?.meetingPreferences;const c={newCall:!1,suppressDialout:!0,conversationServiceUrl:e,endpointState:this.configureEndpointStateForStartOrJoin(s),scenario:s?s.scenario:null,isPreheatOnly:!!s&&s.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:s?s.clientEndpointCapabilities:0,clientEndpointDebugContent:s?s.clientEndpointDebugContent:null,conversationType:s?this.getConversationType(s.isEmergency,!1):null,meetingPreferences:this.meetingPreferences,meetingData:this.meetingData,meetingRegistrationId:s?.meetingRegistrationId,participantPin:s?.participantPin,sharedLineCallInvitationContent:s?.sharedLineCallInvitationContent,applyServerMute:s?.applyServerMute,publishedStates:s?.publishedStates,invitationData:s?.invitationData,captchaContentJson:s?.captchaContentJson,callQueueContext:s?.callQueueContext};this.isCastCall=!1,this.startOrJoinCall(c,od.JOIN_CONVERSATION.name,a,i,n)},this.subscribeToCall=(e,t,i=0,n,r=rs())=>{cs(t,"correlationId should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.IDLE,"a call is already in progress");let s=e;return s||(s=this.signalingAgentConfig.conversationServiceUrl,this.logger.info(`conversationServiceUrl passed is empty. so it is set to ${s}`)),os(s,"conversationUrl should be a non null value"),this.logger.info(`[${r}][subscribeToCall][start][correlationId=${t}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed?(this.logger.warn(`[${r}][subscribeToCall][failed][reason=Session disposed]`),Promise.reject(Yr.CALL_END_CODE.CALL_DOES_NOT_EXIST)):(this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.lastUsedJoinCallOptions=n||{},this.lastUsedJoinCallOptions.clientEndpointCapabilities=i||this.lastUsedJoinCallOptions?.clientEndpointCapabilities,this.meetingData=n?.meetingData,this.meetingPreferences=n?.meetingPreferences,this.fsmState=Yr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY,this.updateCorrelationId(t,r),this.http.sendPostRequest({url:s,requestName:od.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,operationType:"CallSetup",payload:Fh(this,null,null,{subscribe:!0,clientEndpointCapabilities:i,...n,applicationType:this.participantManager.localParticipant.applicationType,endpointState:this.configureEndpointStateForStartOrJoin({additionalEndpointProperties:n?.additionalEndpointProperties})},r),causeId:r}).then((e=>{this.disposed||(this.fsmState=Yr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.processConversationServiceResponseHeaders(e,r),this.processConversationServiceResponse(e.response,r,1),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY,r))})).catch((e=>{if(e.stack&&!this.isFatalException(e))return Promise.resolve();const t=Ss(e,this.signalingAgentConfig);return this.logger.info(`[${r}][subscribeToCall] error: ${Ne(e)} xhrError: ${Ne(t)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,endCode:t.telemetryEndSubCode,endSubCode:t.error.subCode,resultCategories:t.error.resultCategories,resultDetail:t.error.phrase||this.getTerminatingCallResultDetail("subscribe",t.error),causeId:r}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,r,t.error),Promise.reject(t.error))})))},this.getCallReplacementDetailsForCall=(e,t=rs())=>{this.logger.info(`[${t}] getCallReplacementDetailsForCall callId ${e}`);const i=this.signalingAgent.getSignalingSession(e);return i?i.getCallReplacementDetails(t):{replaces:""}},this.getCallReplacementDetails=(e=rs())=>(this.logger.info(`[${e}] getCallReplacementDetails`),{replaces:this.links[Yr.LINKS.REPLACE]}),this.transferCallAsync=(e,t,i,n,r=rs())=>{this.logger.info(`[${r}] transferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(e)} transferType ${t} callTransferOptions: ${Le(n)}`),this.transferHelper(e,t,i,n,r)},this.redirectCall=(e,t=rs(),i)=>{const{id:n,endpointType:r,type:s}=e.redirectOptions;if(this.logger.info(`[${t}] redirectCall: targetId: ${this.piiUtils.scrubMriOrOmit(n)} targetEndpointType ${r}`),!this.isRedirectAllowed){const e={code:Yr.CALL_END_CODE.REJECT,phrase:Yr.CALL_END_PHRASE.CALL_REDIRECT_IS_NOT_ALLOWED};return Promise.reject(e)}this.telemetryHelper.recordEvent(Mo,{causeId:t});const a=function(e,t,i,n){cs(e,"signalingSession cannot be null");const r=e.participantManager.localParticipant;return{payload:{invitationRedirection:{target:{type:t,endpointType:n,id:i},sender:{id:r.id,endpointId:r.endpointId,participantId:r.participantId,languageId:r.languageId}}}}}(this,s,n,r);return this.http.sendPostRequest({url:this.links[Yr.LINKS.REDIRECT],requestName:od.SEND_CALL_REDIRECT_REQUEST.name,payload:a,causeId:t}).then((n=>(this.logger.info(`[${t}][redirectCall] succeeds. Leaving the call...`),this.telemetryHelper.recordEvent(wc,{causeId:t,targetEndpointType:r}),this.terminateEstablishedCall(i,e)))).catch((e=>{const n=Ss(e);this.logger.info(`[${t}][redirectCall] error: ${Ne(n)}`);const s=n.error;return this.telemetryHelper.recordEvent(Do,{causeId:t,transactionEnd:s,endpointType:r}),this.disposed||(this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,endCode:i.code,endSubCode:i.subCode,clientReasonSubCode:i.clientReasonSubCode,clientReasonPhrase:i.clientReasonPhrase,resultDetail:i.phrase||"RedirectCall",resultCategories:i.resultCategories,causeId:t}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,i),this.dispose(i,t)),Promise.reject(s)}))},this.transferHelper=(e,t,i,n,r=rs())=>{as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet");let s=!1;this.logger.info(`[${r}][transferHelper][replacementDetails=${Ne(i)}] disableForwardingAndUnanswered=${n&&n.disableForwardingAndUnanswered}`),this.telemetryHelper.recordEvent(wo,{causeId:r}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(r,s)}),Yr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT),this.http.sendPostRequest({url:this.links[Yr.LINKS.TRANSFER],requestName:od.SEND_TRANSFER_REQUEST.name,payload:zh(e,this,i,t,n),causeId:r}).then((()=>{this.telemetryHelper.recordEvent(Lc,{causeId:r}),s=!0})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);this.logger.info(`[${r}][transferCallAsync] error: ${Ne(t)}`),this.disposed||(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Yr.CALL_END_CODE.NETWORK_ERROR,reason:Ne(e)}},r),this.telemetryHelper.recordEvent(Pc,{causeId:r,...t.error}))})),this.telemetryHelper.recordEvent(Rc,{causeId:r,transferType:t})},this.consultTransferCallAsync=(e,t,i,n,r)=>{let s,a;if(this.logger.info(`[${n}] consultTransferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(t)} transferTargetParticipantLegId: ${i}`),i?(a=this.getMriByParticipantLegOfCall(e,i,n),s=this.getReplacementDetailsByParticipantLegOfCall(e,t,i,n)):(a=t,s=this.getCallReplacementDetailsForCall(e,n)),!a||!s){const r=s?"target mri corresponding not found":`unable to retrieve replacementDetails for transferTargetCallId: ${e}, transferTargetMri: ${t}, transferTargetParticipantLegId: ${i}`;return this.logger.info(`[${n}] consultTransferCallAsync: error: ${r}`),void this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Yr.CALL_END_CODE.BAD_REQUEST,reason:r}},n)}this.transferHelper(a,"TransferTypeStandard",s,r,n)},this.isParkByTransfer=(e,t)=>{const i=["serverHold","sharedLinePark","teamPark"].indexOf(e)>-1;return this.logger.info(`[${t}][isParkByTransfer][context=${e}] result = ${i}`),i},this.parkCallAsync=(e,t=rs())=>{if(e&&"none"===e)throw{code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"};return as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet"),this.logger.info(`[${t}][parkCallAsync][context=${e}]`),this.telemetryHelper.recordEvent(Po,{causeId:t,parkType:Os(e)}),this.isParkByTransfer(e,t)?this.parkByTransfer(e,t):this.park(e,t)},this.unparkAsync=(e,t=rs())=>{if(e&&"none"===e)throw{code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"};if(!this.links[Yr.LINKS.UNPARK])throw{code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark link not available"};this.logger.info(`[${t}][unparkAsync][context=${e}]`),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION,(()=>{this.handleUnparkError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UNPARK_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UNPARK_COMPLETION_TIMEOUT},ol,t,e)}),Yr.TIMEOUT_VALUES_IN_SECONDS.UNPARK_COMPLETION_TIMEOUT);const i={causeId:t};return this.http.sendPostRequest({url:this.links[Yr.LINKS.UNPARK],requestName:od.SEND_UNPARK_REQUEST.name,payload:Kh(this,i),causeId:t}).then((e=>(this.logger.info(`[${t}][unparkAsync] response: ${Ne(e)}`),this.telemetryHelper.recordEvent(al,{causeId:t}),Promise.resolve()))).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${t}][unparkAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUnparkError(n.error,sl,t,e),Promise.reject(n.error))}))},this.handleUpdateParticipantsPropertiesCompletion=e=>{const t=e.body,i=Cs(e),n=this.logger.createChild(`[${i}][handleUpdateParticipantsPropertiesCompletion]`,this.correlationId),r={};if(this.disposed)n.info("ignored. Call disposed.");else{if(t.operationId||n.warn("operationId is undefined."),n.info("starts"),t.participantInfos)for(const e of t.participantInfos){if(!e.participant.id){n.warn("participant id is undefined."),this.telemetryHelper.recordEvent(Nl,"participant id is undefined in response, property");continue}if(!e.participant.key){n.warn("property name (key) is undefined."),this.telemetryHelper.recordEvent(Nl,"property name (key) is undefined in response");continue}const s=wh(e.participant.id,t.operationId,e.participant.key),a={code:e.transactionEnd.code,subCode:e.transactionEnd.subCode,phrase:e.transactionEnd.phrase,resultCategories:e.transactionEnd.resultCategories};n.info(`Update participants properties completed for: ${this.piiUtils.scrubMriOrOmit(e.participant.id)} with transactionEnd ${Ne(a)}`),this.telemetryHelper.recordEvent(Ll,{causeId:i,resolveId:this.piiUtils.scrubMriOrOmit(s),property:e.participant.key,result:Ne(a)}),r[s]=a,this.updateParticipantsPromises[t.operationId].delete(s)}this.checkAndCleanupPromisesForOperationId(t.operationId),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(r,t.operationId,i)}},this.getCallStatus=()=>this.currentCallStatus,this.processIncomingCallRequest=(e,t,i=rs())=>{if(cs(e,"request should be a non null value"),os(e.body,"request should have a valid body"),os(e.body.gp||e.body.cp,"request body should have payload"),as(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.callUsesMixer=e.fromMixer,this.logger.info(`[${i}][processIncomingCallRequest][start]`),this.disposed)return void this.logger.warn("processIncomingCallRequest canceled");this.telemetryHelper.startCallInitializationWatch(),this.isIncomingCall=!0,this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Yr.SIGNALING_FSM_STATE.INCOMING,this.participantManager.initializeForIncomingCall();let n={};try{t&&(n=JSON.parse(t))}catch(e){this.logger.warn("Unable to parse endpoint metadata")}this.endpointMetadata=n;try{let t;if(e?.body?.gp&&!Fe(e.body.gp))this.logger.info(`[${i}][processIncomingCallRequest] unencoded payload, skipping decoding.`),t=e.body.gp;else{const i=e.body.gp?atob(e.body.gp):Ts(e.body.cp);t=JSON.parse(i)}if(!t.callNotification)throw this.logger.info(`[${i}][processIncomingCallRequest][failed][reason=CallNotification missing]`),new Error("CallNotification is missing");this.processIncomingCallPayload(t,i),this.incomingCallPayload=t}catch(e){this.endIncomingCallBecauseOfInvalidPayload(i)}},this.sendAttachToCall=(e=rs())=>(this.logger.info(`[${e}][sendAttachToCall]`),this.incomingCallPayload?(this.onCallStatusChanged(Yr.CALL_STATUS.IDLE,e),this.sendAttachToCallInternal(e)):(this.endIncomingCallBecauseOfInvalidPayload(e),Promise.reject(Yr.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD))),this.supportsNewOfferRequest=()=>this.signalingAgentConfig.handleNewOfferRequest,this.requestNewOffer=(e,t=rs())=>(this.telemetryHelper.recordEvent(cc,{compatibleContentTypes:e,causeId:t}),this.signalingAgentConfig.handleNewOfferRequest?(os(this.links[Yr.LINKS.NEW_OFFER],"newOffer link should be a non null value"),this.http.sendPostRequest({url:this.links[Yr.LINKS.NEW_OFFER],requestName:od.REQUEST_NEW_OFFER.name,payload:Bh(this,e,this.links[Yr.LINKS.NEW_OFFER]),causeId:t}).then((e=>this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):Promise.resolve(e))).catch((e=>{const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[requestNewOffer][${t}] error ${Ne(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,endCode:i.telemetryEndSubCode,endSubCode:i.error.subCode,resultCategories:i.error.resultCategories,resultDetail:i.error.phrase||this.getTerminatingCallResultDetail("requestNewOffer",i.error),causeId:t}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,i.error),this.dispose(i.error,t),Promise.reject(i.error))}))):Promise.reject("Disabled")),this.endAsync=(e,t={})=>{t.causeId=t.causeId||rs();const i=t.causeId;if(this.logger.info(`[${i}][endAsync][rejectionData=${e&&Ne(e)}][endCallForAll=${t.forEveryone}]`),this.disposed)return this.logger.warn(`[${i}][endAsync] canceled but session already disposed`),Promise.resolve(null);if(this.disposing=!0,this.telemetryHelper.recordEvent(xa,e?{code:e.code,subCode:e.subCode,causeId:i,callEndClientSubCode:e.clientReasonSubCode,callEndClientPhrase:e.clientReasonPhrase}:{causeId:i}),t.preventAllCallbacks){const e=Object.keys(this.signalingSessionCallback);for(const t of e)this.signalingSessionCallback[t]=Md.noop}const n=this.mediaRenegotiationManager?.isIncomingRenegotiationInProgress()||this.mediaRenegotiationManager?.isOutgoingRenegotiationInProgress();if(this.telemetryHelper.stopCallCancelationDurationWatch(),this.fsmState===Yr.SIGNALING_FSM_STATE.INCOMING)return e.code===Yr.CALL_END_CODE.CALL_REDIRECTED?this.redirectCall(t,i,e):this.rejectIncomingCall(e,i);if(this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY)return this.cancelOutgoingCall(e,i);if(this.fsmState===Yr.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK)return this.rejectIncomingCall(e,i);if((this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED||n)&&t.forEveryone)return this.deleteConversation(e,i);if(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY||n)return this.terminateEstablishedCall(e,t);{this.logger.info(`[${i}][endAsync] there is no call to cancel or end or reject in current state`);const t={code:isNaN(e?.code)?Yr.CALL_END_CODE.NOT_FOUND:e.code,subCode:isNaN(e?.subCode)?Yr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED:e.subCode,phrase:e?.phrase||Yr.CALL_END_PHRASE.CALL_DOES_NOT_EXIST,resultCategories:e?.resultCategories||[Er],clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};return this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultDetail:t.phrase||"CallDoesNotExist",endCode:t.code,endSubCode:t.subCode,resultCategories:t.resultCategories,causeId:i,clientReasonSubCode:t.clientReasonSubCode,clientReasonPhrase:t.clientReasonPhrase}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,i,t),this.dispose(t,i),Promise.resolve(null)}},this.handleIncomingMsgAsync=(e,t=Yr.INCOMING_MESSAGE_ORIGIN.TROUTER)=>{cs(e,"incoming message should be a non null value");const i=ys(e),n=Is(),r=e.body,s=e.url,a={...e,origin:t},o=Cs(a);if(this.logger.info(`[${o}][handleIncomingMsgAsync][url=${s}][messageId=${i}]`),!r)return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Xo,{origin:t,messageId:i,causeId:o}),n.reject(new Error("received message with no body")),n.promise;if(this.disposed)return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=call is disposed]`),n.reject(this.getCallNotFoundTransactionEnd()),n.promise;if(this.isDuplicatedIncomingMessage(a))return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=duplicate]`),this.telemetryHelper.recordEvent(Lo,{origin:t,messageId:i,causeId:o}),n.resolve(new Error("Message was already handled")),n.promise;this.checkCorrelationIdChange(e,o);const c={[Mr]:e=>{this.handleCallNotification(e)},[Dr]:e=>{this.handleMediaAnswer(e)},[Or]:e=>{this.handleMediaAcknowledgement(e)},[kr]:e=>{this.handleCallAcceptance(e)},[Nr]:e=>{this.handleCallEnd(e)},[Lr]:e=>{this.handleCallProgress(e)},[xr]:e=>{this.handleCallAcceptanceAck(e)},[Ur]:e=>{this.mediaRenegotiationManager?.handleMediaNegotiationOffer(e)},[Fr]:e=>{this.mediaRenegotiationManager?.handleMediaNegotiationFailure(e)},[Vr]:e=>{this.handlePSTNBalanceUpdate(e)},[Br]:e=>{this.mediaRenegotiationManager?.handleRetargetCompleted(e)},[Hr]:e=>{this.handleTransferRequested(e)},[$r]:e=>{this.handleTransferCompletion(e)},[Gr]:e=>{this.handleTransferAcceptance(e)},[jr]:e=>{this.handleParkCompletion(e)},[qr]:e=>{this.handleUnparkCompletion(e)},[Wr]:e=>{this.handleUpdateMeetingLiveStateCompletion(e)},[zr]:e=>{this.handleUpdateMeetingGroupsCompletion(e)},[Jr]:e=>{this.handleSetMeetingLayoutCompletion(e)},[Kr]:e=>{this.handleUpdateMeetingStatesCompletion(e)}},l={[Pr.CONTROL_VIDEO_STREAMING]:e=>{this.webRtcSignalingManager.handleControlVideoStreaming(e)},[Pr.DOMINANT_SPEAKER_INFO]:e=>{this.webRtcSignalingManager.handleDominantSpeakerInfo(e)},[Pr.CSRC_INFO]:e=>{this.webRtcSignalingManager.handleCsrcInfo(e)},[Pr.CONV_ROSTER_UPDATE]:e=>{this.handleRosterUpdate(e,!1)},[Pr.NEW_MEDIA_OFFER]:e=>{this.handleNewMediaOffer(e)},[Pr.CONV_ADD_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleAddParticipantSuccess(e)},[Pr.CONV_ADD_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleAddParticipantFailure(e)},[Pr.CONV_ADMIT_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleAdmitParticipantSuccess(e)},[Pr.CONV_ADMIT_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleAdmitParticipantFailure(e)},[Pr.CONV_ADMIT_ALL_STATUS]:e=>{this.handleAdmitAllStatus(e)},[Pr.CONV_REMOVE_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleRemoveParticipantSuccess(e)},[Pr.CONV_REMOVE_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleRemoveParticipantFailure(e)},[Pr.CONV_CONFIRM_UNMUTE]:e=>{this.participantManager.handleUnmuteConfirmRequest(e)},[Pr.CONV_UPDATE]:e=>{this.handleConversationUpdate(e)},[Pr.CONV_LOCAL_PARTICIPANT_UPDATE]:e=>{this.handleLocalParticipantUpdate(e)},[Pr.CONV_ADD_MODALITY_SUCCESS]:e=>{this.handleAddModalitySuccess(e)},[Pr.CONV_ADD_MODALITY_FAILURE]:e=>{this.handleAddModalityFailure(e)},[Pr.CONV_BROADCAST_UPDATE]:e=>{this.broadcastSession.handleBroadcastStateChanged(e)},[Pr.CONV_CONTENT_SHARING_UPDATE]:e=>{this.contentSharingManager?.handleContentSharingUpdate(e)},[Pr.CONV_CONTENT_SHARING_END]:e=>{this.contentSharingManager?.handleContentSharingEnd(e)},[Pr.CONV_END]:e=>{this.handleCallEnd(e)},[Pr.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS]:e=>{this.participantManager.handleUpdateParticipantInterpretationStateCompletion(e)},[Pr.UPDATE_PARTICIPANT_PROPERTIES_STATUS]:e=>{this.handleUpdateParticipantsPropertiesCompletion(e)},[Pr.JOIN_MEETING_GROUP_STATUS]:e=>{this.handleJoinMeetingGroupCompletion(e)},[Pr.LEAVE_MEETING_GROUP_STATUS]:e=>{this.handleLeaveMeetingGroupCompletion(e)},[Pr.RECEIVE_MESSAGE]:e=>{this.handleReceiveMessage(e)},[Pr.SEND_MESSAGE_STATUS]:e=>{this.proxiedMessageNotificationManager.handleProxiedMessageNotification(e)},[Pr.DISABLE_PREHEAT_ASYNC_STATUS]:e=>{this.handleDisablePreheatCompletion(e)},[Pr.MUTE_UNMUTE_ASYNC]:e=>{this.participantManager.handleMuteUnmuteAsyncResponse(e)}};try{const e=Object.keys(c).filter((e=>r.hasOwnProperty(e)))[0],t=Object.keys(l).filter((e=>a.url&&us(a.url,e)))[0];e?c[e](a):t?l[t](a):(this.telemetryHelper.recordEvent(Uo,{messageId:i}),this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=received unknown message]`)),n.resolve(!0)}catch(e){this.telemetryHelper.recordEvent(Fo,{messageId:i,error:Ne(e)}),this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=${e.message}]`),n.reject(new Error(e.message))}return n.promise},this.canHandleIncomingMsgSync=e=>{if(this.signalingAgentConfig.supportsSynchronousTrouterResponse){const t=e.body;return Boolean(t.callAcceptance)}return!1},this.handleIncomingMsgSync=e=>{const t=ys(e),i=e.body,n=e.url,r=Yr.INCOMING_MESSAGE_ORIGIN.TROUTER,s={...e,origin:r},a=Cs(s);this.logger.info(`[${a}][handleIncomingMsgSync][url=${n}][messageId=${t}]`);const o=s.headers;let c=Yr.HTTP_STATUS_CODES.OK,l="";const d=new Xr;if(vs(o,this.incomingTrouterMessagesSeenSoFar)){this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=duplicate]`);const e=function(e,t){return e&&t[e.get(Yr.HEADERS.ORIGINAL_MESSAGE_ID)||e.get(Yr.HEADERS.MESSAGE_ID)||null]||null}(o,this.incomingMessageSyncResponseCache);if(e)return this.logger.info(`[${a}][handleIncomingMsgSync][cachedResponse]`),e;this.telemetryHelper.recordEvent(Lo,{origin:r,messageId:t,causeId:a}),this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=cachedResponseNotFound]`),c=Yr.HTTP_STATUS_CODES.BAD_REQUEST}else if(i){if(i.callAcceptance)try{l=Le(this.handleCallAcceptanceSync(s))}catch(e){this.telemetryHelper.recordEvent(Fo,{messageId:t,origin:r,causeId:a,error:Ne(e)}),this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=${e?.message}]`),c=Yr.HTTP_STATUS_CODES.BAD_REQUEST}}else this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Xo,{origin:r,messageId:t,causeId:a}),c=Yr.HTTP_STATUS_CODES.BAD_REQUEST;o&&(o.get(Yr.HEADERS.CORRELATION_ID)&&d.set(Yr.HEADERS.CORRELATION_ID,o.get(Yr.HEADERS.CORRELATION_ID)),o.get(Yr.HEADERS.MESSAGE_ID)&&d.set(Yr.HEADERS.MESSAGE_ID,o.get(Yr.HEADERS.MESSAGE_ID)));const h={resultCode:c,responseBody:l,responseHeaders:d.getAll()};return function(e,t,i){if(e&&t){const n=e.get(Yr.HEADERS.ORIGINAL_MESSAGE_ID)||e.get(Yr.HEADERS.MESSAGE_ID)||null;n&&(t[n]=i)}}(o,this.incomingMessageSyncResponseCache,h),this.logger.info(`[${a}][handleIncomingMsgSync][success][resultCode=${c}]`),h},this.acceptRenegotiationAsync=(e,t,i=rs())=>(cs(e.blob,"finalSdp should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${i}][acceptRenegotiationAsync][mediaTypes=${t}]`),this.mediaRenegotiationManager.acceptRenegotiationAsync(e,t,i)),this.setProvisionalAnswerAsync=(e,t=rs())=>{cs(e.blob,"sdp should be a non null value"),this.telemetryHelper.recordEvent(Va,{causeId:t});const i=Is();return this.fsmState!==Yr.SIGNALING_FSM_STATE.INCOMING?(this.logger.info(`[setProvisionalAnswerAsync][${t}] there is no incoming call to set provisional answer on.`),i.reject(new Error("there is no incoming call to set provisional answer on.")),i.promise):(this.http.sendPostRequest({url:this.links[Yr.LINKS.MEDIA_ANSWER],requestName:od.SEND_MEDIA_ANSWER.name,payload:Zh(this,e),causeId:t}).then((e=>{this.disposed||this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTING,t),i.resolve(null),this.disposed||(this.telemetryHelper.recordEvent(xs,{causeId:t}),this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Yr.CALL_STATUS.RINGING,t),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!1,t))})).catch((e=>{const n=Ss(e,this.signalingAgentConfig);this.logger.info(`[setProvisionalAnswerAsync][${t}] error: ${Ne(n)}`),this.disposed?i.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(Ba,{causeId:t}),i.reject(n.error))})),i.promise)},this.startRenegotiationAsync=(e,t,i=rs())=>(cs(e,"mediaContent should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${i}][startRenegotiationAsync]`),this.mediaRenegotiationManager.startRenegotiationAsync(e,this.links[Yr.LINKS.MEDIA_RENEGOTIATION],t,i)),this.updateMediaDescriptionsAsync=(e=rs(),t)=>{cs(t,"mediaDescriptions should be a non null value"),as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"updateMediaDescriptions operations are only allowed when the call is connected");const i=this.links[Yr.LINKS.UPDATE_MEDIA_DESCRIPTIONS];return cs(i,"updateMediaDescriptionsUrl should be a non null value"),this.telemetryHelper.recordEvent(ed,{causeId:e}),this.http.sendPostRequest({url:i,requestName:od.UPDATE_MEDIA_DESCRIPTIONS.name,payload:eu(this,t),causeId:e}).catch((t=>{const i=Ss(t,this.signalingAgentConfig);return this.logger.info(`[updateMediaDescriptionsAsync][${e}] error: ${Ne(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(td,{causeId:e}),Promise.reject(i.error))}))},this.acceptAsync=(e,t,i,n=rs())=>{cs(e,"mediaContent should be a non null value"),cs(e.blob,"outgoingSdp should be a non null value"),this.logger.info(`[${n}][acceptAsync][mediaTypes=${t}]`),this.telemetryHelper.recordEvent(Ha,{causeId:n}),this.telemetryHelper.setAnsweredModalities(e.blob);const r=Is();return this.fsmState!==Yr.SIGNALING_FSM_STATE.INCOMING?(this.logger.warn("acceptAsync, there is no incoming call to accept"),r.reject(new Error("there is no incoming call to accept")),r.promise):(this.fsmState=Yr.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK,this.http.sendPostRequest({url:this.links[Yr.LINKS.ACCEPT],requestName:od.SEND_ACCEPTANCE.name,payload:kh(this,e,t,i),causeId:n}).then((e=>{this.disposed||(this.currentCallStatus===Yr.CALL_STATUS.IDLE&&(this.telemetryHelper.setTimeToRingDuration(),this.telemetryHelper.recordEvent(to,{causeId:n}),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTING,n)),e.response.callAcceptanceAcknowledgement&&(this.logger.info("acceptAsync, handling inlined callAcceptanceAcknowledgement"),this.internalHandleCallAcceptanceAck(e.response,n))),r.resolve(null)})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);this.logger.info(`[acceptAsync][${n}] error: ${Ne(t)}`),this.disposed?r.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Yr.SIGNALING_FSM_STATE.INCOMING,this.telemetryHelper.recordEvent($a,{causeId:n,xhrError:t}),r.reject(t.error))})),r.promise)},this.rejectRenegotiationAsync=(e,t=rs())=>(as(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${t}][rejectRenegotiationAsync][rejectionData=${e}]`),this.mediaRenegotiationManager.rejectRenegotiationAsync(e,t)),this.saveMediaControllerLinksIfAny=e=>{e.links&&(this.links[Yr.LINKS.CONTROL_VIDEO_STREAMING]=e.links.controlVideoStreaming||this.links[Yr.LINKS.CONTROL_VIDEO_STREAMING],this.links[Yr.LINKS.APPLY_CHANNEL_PARAMETERS]=e.links.applyChannelParameters||this.links[Yr.LINKS.APPLY_CHANNEL_PARAMETERS])},this.getInitialMediaOfferFromIncomingCallPayload=(e=rs())=>{if(!this.signalingAgentConfig.handleMediaOfferFromPushNotification)return null;const t=this.incomingCallPayload?.callNotification?.mediaContent?this.incomingCallPayload.callNotification.mediaContent:null;return this.telemetryHelper.setIsSdpInCallNotification(!!t),t},this.updateCorrelationId=(e,t=rs())=>{if(this.logger.info(`[${t}][updateCorrelationId][old=${this.correlationId}][new=${e}]`),this.correlationId!==e&&!this.disposed){const i=this.correlationId;this.correlationId=e,this.telemetryHelper&&this.telemetryHelper.recordEvent&&this.telemetryHelper.recordEvent(xo,{newId:this.correlationId,oldId:i,causeId:t}),this.signalingSessionCallback&&this.signalingSessionCallback.onCorrelationIdUpdated&&this.signalingSessionCallback.onCorrelationIdUpdated(this.correlationId,t)}},this.endIncomingCallBecauseOfInvalidPayload=e=>{this.logger.info(`[${e}][endIncomingCallBecauseOfInvalidPayload]`),this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE;const t={code:Yr.CALL_END_CODE.BAD_REQUEST,subCode:Yr.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD,phrase:Yr.CALL_END_PHRASE.BAD_NOTIFICATION_PAYLOAD,resultCategories:[Ir]};this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,endCode:t.code,endSubCode:t.subCode,resultDetail:t.phrase||"EndIncomingCall",resultCategories:t.resultCategories,causeId:e}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,e,t),this.dispose(t,e)},this.isDuplicatedIncomingMessage=e=>e.origin===Yr.INCOMING_MESSAGE_ORIGIN.BROKER&&vs(e.headers,this.incomingBrokerMessagesSeenSoFar)||e.origin===Yr.INCOMING_MESSAGE_ORIGIN.TROUTER&&vs(e.headers,this.incomingTrouterMessagesSeenSoFar),this.getEndpointState=()=>{let e;return e=this.startOrJoinConvResponseReceived?{...this.latestEndpointState}:{...this.requestedEndpointStateWhileConnecting},e},this.setMultiParty=(e,t)=>{const i=!!e;this.multiParty!==i&&(this.telemetryHelper.recordEvent(Ra,{isMultiparty:i,causeId:t}),this.multiParty=i)},this.setupTrouterChannel=()=>{this.logger.info(`Broker config: outgoing=${this.signalingAgentConfig.brokerEnabledOutgoing?"enabled":"disabled"}incoming=${this.signalingAgentConfig.brokerEnabledIncoming?"enabled":"disabled"}batching=${this.signalingAgentConfig.brokerRequestBatching?"enabled":"disabled"}exclusive=${this.signalingAgentConfig.brokerExclusively?"enabled":"disabled"}`);const e=e=>{e&&"string"==typeof e&&e.trim()&&(this.baseMessagingChannelUrl=this.previousTrouterUrl=this.currentTrouterUrl=e.trim(),this.telemetryHelper.addTrouterChannel())};this.brokerExclusiveEnabled()||(this.signalingAgentConfig.trouterServiceProvider?(2===this.signalingAgentConfig.trouterServiceProvider.state()&&this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync().then(e),this.signalingAgentConfig.trouterServiceProvider.onStateChanged(this.onTrouterStateChanged)):(e(this.signalingAgentConfig.trouterUrlGetter.trouterUrl()),this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed(this.onTrouterUrlChanged)))},this.isTrouterDisconnected=()=>{try{return 3===this.signalingAgentConfig.trouterServiceProvider.state()}catch(e){return!1}},this.forceTrouterConnectionCheck=()=>{try{return void this.signalingAgentConfig.trouterServiceProvider.checkConnection(!1)}catch(e){return}},this.navigatorOnlineCallback=()=>{this.disposed||(this.reportConnectivityStatus(),this.isTrouterDisconnected()&&this.signalingAgentConfig.forceTrouterReconnectOnNetworkOnline&&this.forceTrouterConnectionCheck())},this.navigatorOfflineCallback=()=>{this.reportConnectivityStatus()},this.reportConnectivityStatus=()=>{if(!this.disposed){const e=bs(this.signalingAgentConfig.trouterServiceProvider);this.logger.info(`[Connectivity] status=${e}`),this.telemetryHelper.recordEvent(Vo,{status:e})}},this.onTrouterStateChanged=(e,t)=>{const i=rs();this.logger.info(`[${i}][onTrouterStateChanged][state=${e}]`),this.disposed?this.logger.info("onTrouterStateChanged ignored"):(this.reportConnectivityStatus(),2===e&&(this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Qa,i)))},this.setupConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.addEventListener&&(window.addEventListener("online",this.navigatorOnlineCallback),window.addEventListener("offline",this.navigatorOfflineCallback))}catch(e){return}},this.tearDownConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.removeEventListener&&(window.removeEventListener("online",this.navigatorOnlineCallback),window.removeEventListener("offline",this.navigatorOfflineCallback))}catch(e){return}},this.getTrouterUrlAsync=()=>this.signalingAgentConfig.trouterServiceProvider?this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync():this.signalingAgentConfig.trouterUrlGetter.getTrouterUrlAsync(),this.brokerExclusiveEnabled=()=>this.signalingAgentConfig.brokerEnabledOutgoing&&this.signalingAgentConfig.brokerEnabledIncoming&&this.signalingAgentConfig.brokerExclusively,this.isBrokerEnabledForOutgoingCall=()=>this.signalingAgentConfig.brokerEnabledOutgoing,this.isBrokerEnabledForIncomingCall=()=>this.signalingAgentConfig.brokerEnabledIncoming,this.setupBrokerChannel=()=>{this.brokerService||(this.logger.info("setupBrokerChannel, Enable broker"),this.brokerService=new jd(this),this.brokerService.onBrokerMessage((e=>{this.logger.info("setupBrokerChannel, message from broker",e),this.handleIncomingMsgAsync(e,Yr.INCOMING_MESSAGE_ORIGIN.BROKER).catch((e=>{this.telemetryHelper.recordEvent(zo),this.logger.info("setupBrokerChannel, Failed to handle message from broker",e)}))})),this.baseMessagingChannelUrl||(this.telemetryHelper.addBrokerChannel(),this.baseMessagingChannelUrl=this.brokerService.baseUrl))},this.onTrouterUrlChanged=()=>{const e=rs();this.logger.info(`[${e}][onTrouterUrlChanged]`),this.disposed?this.logger.info("onTrouterUrlChanged ignored"):this.getTrouterUrlAsync().then((t=>{this.telemetryHelper.recordEvent(Ya,{url:t}),this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Ya,e)})).catch((e=>{this.logger.info(`Failed to update links to trouter: ${e}`)}))},this.updateLinksToTrouter=(e,t)=>{this.logger.info(`[${t}][updateLinksToTrouter][tag=${e}]`),this.ensureLatestTrouterUrl(e).then((()=>{this.previousTrouterUrl!==this.currentTrouterUrl?(this.previousTrouterUrl=this.currentTrouterUrl,this.updateConversationLinks(),this.updateKeepAliveUrl(),this.contentSharingManager?.updateContentSharingNotificationLinksAsync(t),this.broadcastSession&&this.broadcastSession.updateBroadcastCallbackUrl(t)):this.logger.info(`[${t}][updateLinksToTrouter]skip updating links, url did not change`)})).catch((e=>{this.disposed||this.telemetryHelper.recordEvent(Za,{causeId:t}),this.logger.info(`[${t}][updateLinksToTrouter][failed][reason=${Ne(e)}]`)}))},this.updateLinks=(e,t)=>{this.ensureLatestTrouterUrl(Ya).then((()=>{e(t)})).catch((e=>{this.disposed||this.telemetryHelper.recordEvent(Za,{causeId:t}),this.logger.warn("Failed to update links")}))},this.startCallPreheatTimer=e=>{this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT,(()=>{this.handleCallEstablishmentTimeout(e,Yr.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,"Preheat timed out!"),this.terminateEstablishedCall({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,phrase:"Preheat timed out!"},{forEveryone:!1,causeId:e})}),Yr.TIMEOUT_VALUES_IN_SECONDS.MAX_PREAHEATED_TIMEOUT)},this.stopCallPreheatTimer=()=>{this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT)},this.updateKeepAliveUrl=()=>{this.logger.info("updateKeepAliveUrl"),this.links.hasOwnProperty(Yr.LINKS.KEEPALIVE)?(this.linkUpdateRequested.keepAliveLinks=!1,this.logger.info("updateKeepAliveUrl, sending request"),this.sendToKeepAliveUrl(function(e){return cs(e,"signalingSession cannot be null"),{payload:{callParticipantUpdate:{links:hs(e,Rr),clientContentForMediaController:e.webRtcSignalingManager.getClientUrls()}}}}(this))):this.linkUpdateRequested.keepAliveLinks=!0},this.updateConversationLinks=(e=rs())=>{this.logger.info(`[${e}][updateConversationLinks]`),this.telemetryHelper.recordEvent(dc,{causeId:e}),this.links.hasOwnProperty(Yr.LINKS.NOTIFICATION_LINKS)?(this.linkUpdateRequested.conversationLinks=!1,this.logger.info("updateConversationLinks, sending request"),this.sendToUpdateConversationLinks(!0)):this.linkUpdateRequested.conversationLinks=!0},this.sendAttachToCallInternal=(e=rs())=>{this.telemetryHelper.recordEvent(oc,{causeId:e}),this.logger.info(`[${e}][sendAttachToCallInternal]`);const t=new Xr;return this.signalingAgentConfig.sendProgressFromCC&&t.set(Yr.HEADERS.CACHE_SKYPE_TOKEN,"1"),this.http.sendPostRequest({url:this.incomingCallPayload.callNotification.links.attach,customHeaders:t,requestName:od.SEND_CALL_ATTACH.name,payload:Dh(this,this.incomingCallPayload.conversationInvitation.conversationController,!this.getInitialMediaOfferFromIncomingCallPayload()),causeId:e}).then((t=>{if(!this.disposed){this.processAttachResponse(this.incomingCallPayload,t,e);const i=t.response.additionalActionResponses;i&&i.length>0&&this.processConversationServiceResponse(i[0].output,e,0),this.onCallStatusChanged(Yr.CALL_STATUS.RINGING,e),this.telemetryHelper.setTimeToRingDuration(),this.handleBrokerSubscription(t.response.callInvitation,e)}})).catch((t=>{const i=Ss(t,this.signalingAgentConfig);this.logger.info(`[${e}][sendAttachToCallInternal] error: ${Ne(t)} xhrError: ${Ne(i)}`),this.disposed||(this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,endCode:i.telemetryEndSubCode,endSubCode:i.error.subCode,resultCategories:i.error.resultCategories,resultDetail:i.error.phrase||this.getTerminatingCallResultDetail("attach",i.error),causeId:e}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,e,i.error),this.dispose(i.error,e))}))},this._processCallAcceptance=(e,t)=>{if(this.logger.info(`[${t}][_processCallAcceptance]`),this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING){this.processCallAcceptance(e.body,t),this.telemetryHelper.setTimeToRingDuration();try{this.multiParty||this.callUsesMixer||this.participantManager.handleRosterUpdate(this.getFakeRoster(e.body),!0,t)}catch(i){const n={code:Yr.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Yr.CALL_END_SUB_CODE.CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE,phrase:i?.toString()};throw this.logger.info(`[${t}][_processCallAcceptance] ${Le(n)}`),this.telemetryHelper.recordRosterEvent(e,Ca,t),n}}},this.restartKeepAliveInterval=(e=!1,t)=>{this.disposed||(e&&this.telemetryHelper.recordEvent(Cc,t),this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval))},this.isCallOngoing=()=>this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Yr.SIGNALING_FSM_STATE.IDLE,this.isCallIdleOrRosterOnly=()=>this.fsmState===Yr.SIGNALING_FSM_STATE.IDLE||this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.isCallConnectedOrConnectedForRoster=()=>this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,s&&(this.callStartTime=s),this.signalingSessionCallback=t,this.signalingAgentConfig=i,this.signalingAgent=r,this.urlIdentifier=n,this.piiUtils=new Pd(i.piiScrubber),this.isHostLessCall=i.doHostlessCalling||!1,this.logger=i.logger.createChild((()=>`CSA[${this.correlationId}][${this.fsmState}]`),this.correlationId,!0),this.updateCorrelationId(n),this.logger.info(`[endpointId=${xe(this.signalingAgent.endpointId)}]`),this.logger.info(`[participantId=${e.participantId}]`),this.callOperationHandler=new Wd(this.logger.createChild((()=>`[CallOperationHandler][${e.participantId}]`))),this.http=new hh(this,this.callStartTime),this.telemetryHelper=new ru(this,e,this.callStartTime),this.mediaRenegotiationManager=new mh(this,t,this.telemetryHelper),this.participantManager=new bh(this,t,e,new Qt(this.logger)),this.proxiedMessageNotificationManager=new Ph(this),this.timeoutManager=new Ad(this.logger),this.contentSharingManager=new nh(this,t),this.webRtcSignalingManager=new su(this,t),this.pstnContent={emergencyCallCountry:i.emergencyCallCountry||"",platformName:i.clientInformation,publicApiCall:!1},this.setupTrouterChannel(),this.setupConnectionCheck()}onPromotionCompleted(e,t,i){this.logger.info(`[${i}][onPromotionCompleted] isFailed=${e} error=${Ne(t)}]`),this.isPromotingToRealtime=!1,this.signalingSessionCallback.onPromotionCompleted(e,t,i)}setRealTimeState(e,t){let i=e;(2===e&&1===this.realTimeState||1===e&&2===this.realTimeState)&&(i=3),i!==this.realTimeState&&(this.logger.info(`[${t}][setRealTimeState] changed: input=${e} old=${this.realTimeState}, new=${i}`),this.realTimeState=i,3===i?this.setCallMode(1,t):0!==this.callMode||2!==i&&(this.signalingAgentConfig.disableRealTimeModeFromRoster||1!==i)||this.setCallMode(1,t))}setCallMode(e,t){this.callMode!==e&&(this.logger.info(`[${t}][setCallMode] oldMode=${this.callMode}, newMode=${e}`),this.callMode=e,this.signalingSessionCallback.onCallModeChanged(this.callMode,t))}configureStreamingMode(e){2!==this.callMode?(this.logger.info(`[${e}][configureStreamingMode]`),this.setCallMode(2,e),this.cleanUpDueToStreaming(e),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTED,e)):this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT)}updateDominantSpeakerHistoryMessageSubscription(e){this.webRtcSignalingManager.getIsDominantSpeakerInfoLinkEnabled()!==e&&(this.logger.info(`Signaling dominant speaker history subscription updated: ${e}`),this.webRtcSignalingManager.setIsDominantSpeakerInfoLinkEnabled(e),this.webRtcSignalingManager.areClientURLsGenerated()&&this.updateKeepAliveUrl())}cleanUpDueToStreaming(e){this.setRealTimeState(0,e),this.fsmState=Yr.SIGNALING_FSM_STATE.CONNECTED,this.isPromotingToRealtime=!1,this.provisionalMediaAnswersSeenSoFar=[],this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=new mh(this,this.signalingSessionCallback,this.telemetryHelper),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const t={code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.DOWNGRADE_TO_STREAMING_CLIENT,phrase:Yr.CALL_END_PHRASE.DOWNGRADE_TO_STREAMING_CLIENT},i=od;for(const n of Object.keys(i))0!==i[n].controller&&4!==i[n].controller&&3!==i[n].controller||this.http.cancelRequestIfPending(i[n].name,e,void 0,t)}updateEndpointMetadata(e,t=rs()){let i={};try{i=JSON.parse(e)}catch(e){return Promise.reject("Invalid metadata")}return this.http.sendPutRequest({url:this.links[Yr.LINKS.UPDATE_ENDPOINT_METADATA],requestName:od.UPDATE_ENDPOINT_METADATA.name,payload:Yh(this,i),causeId:t}).then((()=>{this.telemetryHelper.recordEvent(Jc,{causeId:t})})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[${t}][updateEndpointMetadata] error: ${Ne(i)}`),this.telemetryHelper.recordEvent(Kc,{...i.error}),Promise.reject(i.error)}))}isOneToOnePSTNCall(){return this.signalingSessionCallback.isOneToOnePstnCall()}getLocationContent(){return this.isOneToOnePSTNCall()?fs(this.locationInfoContent):null}getNetworkContent(){return this.isOneToOnePSTNCall()?fs(this.networkInfoContent):null}getAreaContent(){return this.isOneToOnePSTNCall()?fs(this.areaContent):null}setLocationInfo(e,t,i){this.locationInfoContent=e,this.networkInfoContent=t,this.areaContent=i}setStreamInformationReceived(){this.disposed||this.streamInformationReceived||(this.streamInformationReceived=!0,this.telemetryHelper.recordEvent(Zl))}getEndpointCapabilities(){let e=0;return this.signalingAgentConfig.brokerEnabledIncoming&&(e|=16),this.signalingAgentConfig.isGVCJoiningEnabled&&(e|=1),"disabled"!==this.signalingAgentConfig.cloudScreenSharingFlag&&(e|=2),this.signalingAgentConfig.supportsHostlessGroupCalls&&(e|=4),this.signalingAgentConfig.autoJoinOnConflict&&(e|=32),this.signalingAgentConfig.supportsCompressedServicePayload&&(e|=128),this.signalingAgentConfig.enableAutoPromotion&&(e|=65536),this.signalingAgentConfig.enableBatchedSendMessageStatus&&(e|=16384),this.signalingAgentConfig.enableBatchedReceiveMessage&&(e|=8192),e|=64,e|=1024,this.signalingAgent?.accountConfig?.clientSupportsAudioOnlyWatermark&&(e|=4096,this.telemetryHelper.setAudioOnlyWatermark(!0)),this.signalingAgent?.accountConfig?.clientSupportsWatermark&&(e|=2048,this.telemetryHelper.setWatermarkSupport(!0)),this.signalingAgent?.accountConfig?.clientSupportsPreventScreenCapture&&(e|=131072,this.telemetryHelper.setClientSupportsPreventScreenCapture(!0)),(this.getMaxReinvitelessMediaForVBSSForWeb()||this.getMaxReinvitelessMediaForVideoForWeb())&&(this.telemetryHelper.setReinviteless(this.callUsesMixer),e|=512),e}handleAdmitAllStatus(e){const t=e.body?.transactionResponse,i=Cs(e);this.logger.info(`[${i}][handleAdmitAllStatus][${Ne(t)}]`);const n=t?.operationId;if(n&&this.callOperationHandler.hasPendingOperation(0,n,i)){this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT,n);const e=t?.result?.code,r=t?.result?.subCode,s=t?.result?.resultCategories,a=t?.additionalDetail;if(0===e||e>=200&&e<300){const t={code:e,subCode:r,resultCategories:s,result:Le(a)};this.telemetryHelper.recordEvent(sa,{causeId:n,transactionEnd:t}),this.callOperationHandler.resolvePendingOperation(0,n,t,i)}else{const a={code:e||Yr.CALL_END_CODE.BAD_REQUEST,subCode:r||0,resultCategories:s,result:t,phrase:Yr.CALL_END_PHRASE.BAD_SERVICE_RESPONSE};this.telemetryHelper.recordEvent(ra,{causeId:n,transactionEnd:a}),this.callOperationHandler.rejectPendingOperation(0,n,"AdmitAllStatus response contains failure",a,i)}}else this.logger.warn(`[${i}][handleAdmitAllStatus] invalid admitAllStatus response or no pending operation. operationId=${n}`)}sendNetworkRequestForAdmit(e){this.http.sendPostRequest({url:this.links[Yr.LINKS.ADMIT_ALL],requestName:od.ADMIT.name,payload:Mh(this,e),causeId:e,onceTrouterReady:()=>{this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.ADMIT,(()=>{this.telemetryHelper.recordEvent(na,{causeId:e}),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT,e),this.callOperationHandler.rejectPendingOperation(0,e,"timed out waiting for admit operation",{code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.ADMIT_TIMEOUT,phrase:Yr.CALL_END_PHRASE.ADMIT_TIMEOUT},e)}),Yr.TIMEOUT_VALUES_IN_SECONDS.ADMIT_TIMEOUT,e)}}).catch((t=>{const i=Ss(t,this.signalingAgentConfig);this.telemetryHelper.recordEvent(ra,{causeId:e,...i.error}),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.ADMIT,e),this.callOperationHandler.rejectPendingOperation(0,e,t,i.error,e)}))}getConversationType(e,t,i){return e?"emergencyGroupCall":t?"cast":i?"huddleGroupCall":null}getMaxReinvitelessMediaForVideoForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVideoForWeb}getMaxReinvitelessMediaForVBSSForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVBSSForWeb}convertParkType(e){return"teamPark"===e?"TransferTypeTeamPark":"sharedLinePark"===e?"TransferTypeSharedLinePark":"serverHold"===e?"TransferTypeServerHold":(this.logger.info(`convertParkType, parkType: ${e} is unknown`),"none")}parkByTransfer(e,t){this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT);const i=this.getNetworkRequestName(e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.TRANSFER],requestName:i,payload:Hh(e,this),causeId:t}).catch((e=>{const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[${t}][parkByTransfer] error: ${Ne(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Yr.CALL_END_CODE.NETWORK_ERROR,reason:Ne(e)}},t),this.telemetryHelper.recordEvent(Pc,{causeId:t,...i.error}),Promise.reject(i.error))})),this.telemetryHelper.recordEvent(Rc,{causeId:t,transferType:this.convertParkType(e)}),Promise.resolve()}park(e,t){this.logger.info(`[${t}][park] context ${e}`),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.PARK_COMPLETION,(()=>{this.handleParkError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.PARK_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.PARK_COMPLETION_TIMEOUT},il,t,e)}),Yr.TIMEOUT_VALUES_IN_SECONDS.PARK_COMPLETION_TIMEOUT);const i=this.getHoldTypeInRequest(e),n={causeId:t};return this.http.sendPostRequest({url:this.links[Yr.LINKS.PARK],requestName:od.PARK_REQUEST.name,payload:$h(this,i,n),causeId:t}).then((e=>{this.logger.info(`[${t}][park] response: ${Ne(e)}`),this.telemetryHelper.recordEvent(tl,{causeId:t}),cs(e.response.holdResponse.links,"server response does not include park links"),this.links[Yr.LINKS.UNPARK]=e.response.holdResponse.links.resume})).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${t}][park] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleParkError(n.error,el,t,e),Promise.reject(n.error))})),Promise.resolve()}getHoldTypeInRequest(e){switch(e){case"serverHoldV2":return"musicOnHold";case"sharedLineParkV2":return"sharedLineAppearance";case"callPark":return"callPark";default:return null}}handleParkError(e,t,i,n){this.disposed?this.logger.info("handleParkError ignored"):(this.logger.info(`[${i}] handleParkError reject reason: ${Ne(e)}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.PARK_COMPLETION),this.signalingSessionCallback.onParkCompleted&&(this.telemetryHelper.recordEvent(t,{...e,parkContext:n,causeId:i}),this.signalingSessionCallback.onParkCompleted(e,i)),this.links[Yr.LINKS.UNPARK]=void 0)}handleParkCompletion(e){const t=e.body,i=Cs(e),n=t.holdCompletion;this.handleOperationCompletionCommon(n,i,void 0,Ne(t),"handleParkCompletion",Yr.TIMEOUT_OPERATIONS.PARK_COMPLETION,nl,rl,this.signalingSessionCallback.onParkCompleted,this.handleParkError.bind(this))}handleUnparkError(e,t,i,n){this.disposed?this.logger.info("handleUnparkError ignored"):(this.logger.info(`[${i}] handleUnparkError reject reason: ${e}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.signalingSessionCallback.onUnparkCompleted&&(this.telemetryHelper.recordEvent(t,{...e,parkContext:n,causeId:i}),this.signalingSessionCallback.onUnparkCompleted(e,i)),this.links[Yr.LINKS.UNPARK]=void 0)}handleUnparkCompletion(e){const t=e.body,i=Cs(e);if(this.disposed)return void this.logger.info(`[${i}]handleUnparkCompletion ignored`);this.logger.info(`[${i}][handleUnparkCompletion] body ${Ne(t)}`);const n=t.resumeCompletion;n.code===Yr.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.telemetryHelper.recordEvent(cl,{...n,causeId:i}),this.signalingSessionCallback.onUnparkCompleted(n,i),this.links[Yr.LINKS.UNPARK]=void 0):this.handleUnparkError(n,ll,i)}getNetworkRequestName(e){return{none:null,teamPark:od.SEND_PARK_REQUEST.name,sharedLinePark:od.SEND_SHARED_LINE_PARK_REQUEST.name,serverHold:od.SEND_SERVER_HOLD_REQUEST.name}[e]}updateMeetingsGroupsAsync(e,t){this.logger.info(`[${e}][updateMeetingsGroupsAsync] scope=${t.scope}`),this.telemetryHelper.recordEvent(ml,{causeId:e,options:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION,(()=>{this.handleUpdateMeetingGroupsError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT},_l,e,e,t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT);const i=function(e,t,i){cs(e,"signalingSession cannot be null");const{scope:n,toGroup:r,fromGroup:s,participants:a}=t;"specified"===n&&cs(a,"participantsIds cannot be null");const o={from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},scope:n,fromGroup:s,toGroup:r,links:{updateMeetingGroupsStatus:Zr(e,Pr.UPDATE_MEETING_GROUPS_STATUS)},operationId:i};return a&&(o.to=a.map((e=>({id:e.mri,endpointId:e.endpointId,participantId:e.participantId})))),{payload:o}}(this,t,e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.UPDATE_MEETING_GROUPS],requestName:od.UPDATE_MEETING_GROUPS.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][updateMeetingsGroupsAsync] response: ${Ne(t)}`),this.telemetryHelper.recordEvent(_l,{causeId:e})})).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${e}][updateMeetingsGroupsAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingGroupsError(n.error,El,e,e,t),Promise.reject(n.error))}))}updateParticipantInterpretationStateAsync(e,t){return os(t,"options should be a non null value"),this.logger.info(`[${e}][updateParticipantInterpretationStateAsync]`),this.telemetryHelper.recordEvent(fl,{causeId:e,options:t}),this.participantManager.updateParticipantInterpretationStateAsync(t,this.links[Yr.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE],e)}async sendProxiedMessageAsync(e,t){return t&&0!==t.length?this.links[Yr.LINKS.SEND_MESSAGE]?this.proxiedMessageNotificationManager.sendProxiedMessageAsync(e,t,this.links[Yr.LINKS.SEND_MESSAGE]):Promise.reject({code:Yr.VALIDATION.VALIDATION_FAILED,subCode:Yr.VALIDATION.NULL_OR_EMPTY,phrase:"missing url for CONSTANTS.LINKS.SEND_MESSAGE"}):Promise.reject({code:Yr.VALIDATION.VALIDATION_FAILED,subCode:Yr.VALIDATION.NULL_OR_EMPTY,phrase:"options should be a non empty array"})}async updateParticipantsPropertiesAsync(e,t,i,n){this.telemetryHelper.recordEvent(Sl,{causeId:n,updateParticipantsPropertiesContext:e});const r=this.links[Yr.LINKS.UPDATE_PARTICIPANTS_PROPERTIES],s=[],a=e.scope;if("self"===a){const t={id:this.participantManager.localParticipant.id,propertyBag:e.propertyBag};s.push(t)}else{if("specified"!==a)return Promise.reject("This scope is not Supported");{const t=e.participants;for(const e of t){const t={id:e.id,propertyBag:e.propertyBag};s.push(t)}}}return this.sendNetworkRequestForUpdateParticipantsProperties(s,t,r,i,n)}sendNetworkRequestForUpdateParticipantsProperties(e,t,i,n,r){const s=this.logger.createChild(`[${r}][sendNetworkRequestForUpdateParticipantsProperties]`,this.correlationId);if(i){const a=()=>{const e={code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT};this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,(()=>{this.handleUpdateParticipantsPropertiesOnTimeout(t,e,kl,n,r)}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT,n)},o=function(e,t,i){return cs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId},to:t,links:{updateParticipantPropertiesStatus:Zr(e,Pr.UPDATE_PARTICIPANT_PROPERTIES_STATUS)},operationId:i}}}(this,e,n);return this.updateParticipantsPromises[n]=t,this.http.sendPostRequest({url:i,payload:o,requestName:od.UPDATE_PARTICIPANTS_PROPERTIES.name,onceTrouterReady:a,causeId:r}).then((e=>{s.info(`response: ${Ne(e)}`)})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);s.info(`failed: ${Ne(t)}`);const i={...t.error};return this.disposed||(this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,n),delete this.updateParticipantsPromises[n]),this.telemetryHelper.recordEvent(Nl,{causeId:r,transactionEnd:i}),Promise.reject(i)}))}{const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING,phrase:"updateParticipantsProperties link is missing"};return s.warn(e),this.telemetryHelper.recordEvent(Nl,{causeId:r,error:e}),Promise.reject(e)}}checkAndCleanupPromisesForOperationId(e){this.updateParticipantsPromises[e]&&(0===this.updateParticipantsPromises[e].size?(delete this.updateParticipantsPromises[e],this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,e)):this.logger.info(`remaining promises for the operation  ${e} (count: ${this.updateParticipantsPromises[e].size}):\n                ${this.piiUtils.scrubMriOrOmit(Le(this.updateParticipantsPromises[e]))}`))}handleUpdateParticipantsPropertiesOnTimeout(e,t,i,n,r){if(this.disposed)return void this.logger.info("handleUpdateParticipantsPropertiesOnTimeout ignored");this.logger.createChild(`[${r}][handleUpdateParticipantsPropertiesOnTimeout]`,this.correlationId).info(`reason: ${t}`),this.telemetryHelper.recordEvent(i,{...t,causeId:r});const s={};e.forEach((e=>{s[e]=t,this.updateParticipantsPromises[n].delete(e)})),this.checkAndCleanupPromisesForOperationId(n),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(s,n,r)}joinMeetingGroupAsync(e,t){this.logger.info(`[${e}][joinMeetingGroupAsync]`),this.telemetryHelper.recordEvent(vl,{causeId:e,options:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION,(()=>{this.handleJoinMeetingGroupError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.JOIN_MEETING_GROUP_TIMEOUT,phrase:Yr.CALL_END_PHRASE.JOIN_MEETING_GROUP_TIMEOUT},xl,e,e,t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.JOIN_MEETING_GROUP_COMPLETION_TIMEOUT);const i=function(e,t,i){cs(e,"signalingSession cannot be null");const{meetingGroupId:n,groupPreferences:r}=t;return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingGroup:n,...r&&{groupPreferences:r},links:{joinMeetingGroupStatus:Zr(e,Pr.JOIN_MEETING_GROUP_STATUS)},operationId:i}}}(this,t,e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.JOIN_MEETING_GROUP],requestName:od.JOIN_MEETING_GROUP.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][joinMeetingGroupAsync] response: ${Ne(t)}`),this.telemetryHelper.recordEvent(xl,{causeId:e})})).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${e}][joinMeetingGroupAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleJoinMeetingGroupError(n.error,Ul,e,e,t),Promise.reject(n.error))}))}leaveMeetingGroupAsync(e,t){this.logger.info(`[${e}][leaveMeetingGroupAsync]`),this.telemetryHelper.recordEvent(yl,{causeId:e,options:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION,(()=>{this.handleLeaveMeetingGroupError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.LEAVE_MEETING_GROUP_TIMEOUT,phrase:Yr.CALL_END_PHRASE.LEAVE_MEETING_GROUP_TIMEOUT},Bl,e,e,t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT);const i=function(e,t,i){cs(e,"signalingSession cannot be null");const{meetingGroupId:n}=t;return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingGroup:n,links:{leaveMeetingGroupStatus:Zr(e,Pr.LEAVE_MEETING_GROUP_STATUS)},operationId:i}}}(this,t,e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.LEAVE_MEETING_GROUP],requestName:od.LEAVE_MEETING_GROUP.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][leaveMeetingGroupAsync] response: ${Ne(t)}`),this.telemetryHelper.recordEvent(Bl,{causeId:e})})).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${e}][leaveMeetingGroupAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleLeaveMeetingGroupError(n.error,Hl,e,e,t),Promise.reject(n.error))}))}handleUpdateMeetingGroupsError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingGroupsError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingGroupsError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(e,i,n))}handleUpdateMeetingGroupsCompletion(e){const t=e.body,i=Cs(e),n=t.updateMeetingGroupsResponse.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleUpdateMeetingGroupsCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] starts`);const{updateMeetingGroupsResponse:r}=t,s=Bd(r);s.code===Yr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] update meeting group succeeded`),this.telemetryHelper.recordEvent(Il,{...s,causeId:i})):(this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] update meeting group failed code=${s.code} subCode=${s.subCode}`),this.telemetryHelper.recordEvent(Tl,{...s,causeId:i})),this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] completes`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(s,i,n)}handleJoinMeetingGroupError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleJoinedMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleJoinedMeetingGroupError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,joinMeetingGroupOptions:r,causeId:i}),this.signalingSessionCallback.onJoinMeetingGroupCompleted(e,i,n))}handleJoinMeetingGroupCompletion(e){const t=e.body.joinMeetingGroupResponse,i=Cs(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleJoinMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] starts`);const r=Bd(t);r.code===Yr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] join meeting group succeeded`),this.telemetryHelper.recordEvent(Vl,{...r,causeId:i})):(this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] join meeting group failed code=${r.code} subCode=${r.subCode}`),this.telemetryHelper.recordEvent(Fl,{...r,causeId:i})),this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onJoinMeetingGroupCompleted(r,i,n)}handleLeaveMeetingGroupError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleLeaveMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleLeaveMeetingGroupError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,leaveMeetingGroupOptions:r,causeId:i}),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(e,i,n))}handleLeaveMeetingGroupCompletion(e){const t=e.body.leaveMeetingGroupResponse,i=Cs(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleLeaveMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] starts`);const r=Bd(t);r.code===Yr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] leave meeting group succeeded`),this.telemetryHelper.recordEvent(Gl,{...r,causeId:i})):(this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] leave meeting group failed code=${r.code} subCode=${r.subCode}`),this.telemetryHelper.recordEvent($l,{...r,causeId:i})),this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(r,i,n)}handleDisablePreheatError(e,t,i){this.disposed?this.logger.info(`[${i}][handleDisablePreheatError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleDisablePreheatError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),this.telemetryHelper.recordEvent(t,{...e,causeId:i}),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject(e))}handleDisablePreheatCompletion(e){const t=e.body,i=Cs(e),n=t.transactionEnd;if(this.disposed)this.logger.info(`[${i}][handleDisablePreheatCompletion] ignored. Call disposed.`);else if(this.disablePreheatDefer.isPending()){if(this.logger.info(`[${i}][handleDisablePreheatCompletion] starts`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),n.code===Yr.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${i}][handleDisablePreheatCompletion] update endpoint state succeeded`),this.handleEndpointStateUpdated(i,!0);else if(this.logger.info(`[${i}][handleDisablePreheatCompletion] update endpoint state failed code=${n.code} subCode=${n.subCode}`),this.disablePreheatDefer.isPending()){const e={response:n};this.disablePreheatDefer.reject(e)}}else this.logger.info(`[${i}][handleDisablePreheatCompletion] ignored. Disable preheat promise is resolved/rejected.`)}handleReceiveMessage(e){const t=Cs(e);if(this.disposed)return void this.logger.info(`[${t}][handleReceiveMessage] ignored. Call disposed.`);let i;i=Array.isArray(e.body?.messageContent)?e.body.messageContent:[e.body];let n="";const r=[];for(let e=0;e<i.length;e++){const t=i[e];n+=t?.operationId,e<i.length-1&&(n+=","),r.push({operationId:t.operationId,messageType:t.type,payload:t.payload,from:{[t.from.id]:{participantLegIdMap:{[t.from.participantId]:{...t.from.endpointId&&{endpointId:t.from.endpointId}}},level:"endpoint"}}})}this.logger.info(`[${t}][handleReceiveMessage] complete. OperationIds:${n}`),this.telemetryHelper.recordEvent(Cl,{causeId:t,operationIds:n}),this.signalingSessionCallback.onIncomingProxiedMessages(r,t)}publishStateAsync(e,t,i,n,r,s){this.logger.info(`[${i}][publishStateAsync][publishType=${e} publishLevel=${t}]`),this.telemetryHelper.recordEvent($c,{causeId:i,publishType:e,publishLevel:t});const a=this.links[Yr.LINKS.PUBLISH_STATE];if(!a){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.PUBLISH_STATE_LINK_MISSING,phrase:"publish state link is missing"};return this.logger.warn(e),Promise.reject(e)}let o={};try{o=JSON.parse(n)}catch(e){const t={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_CONTENT,phrase:"publish state content is invalid"};return this.logger.warn(t),Promise.reject(t)}return this.http.sendPostRequest({url:a,requestName:od.PUBLISH_STATE.name,payload:Gh(this,e,t,o,r,s),causeId:i,requestId:i}).then((e=>{if(e?.response?.publishStateResponse)return this.parsePublishStateResult(e,i);{const t=`Invalid CS response which does not contains publishStateResponse. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(t),{response:{code:Yr.CALL_END_CODE.DECODING_FAILED,subCode:Yr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:t}}}})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);this.logger.info(`[${i}][publishStateAsync] error: ${Ne(t)}`);const n=t.error;return this.telemetryHelper.recordEvent(Gc,{causeId:i,transactionEnd:n}),Promise.reject(n)}))}getPublishStateSequenceNumber(){return++this.publishStateSequenceNumber}parsePublishStateResult(e,t){let i={};if(e?.response?.publishStateResponse){if(e.response.publishStateResponse.stateId)return e.response.publishStateResponse.stateId;if(e.response.publishStateResponse.results){if(1===e.response.publishStateResponse.results.length){if(e.response.publishStateResponse.results[0].stateId)return e.response.publishStateResponse.results[0].stateId;this.logger.warn("invalid response format")}return e.response.publishStateResponse.results.forEach((e=>{i[e.participantId]={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode}})),JSON.stringify(i)}if(e.response.publishStateResponse.result)return i={code:e.response.publishStateResponse.result.code,phrase:e.response.publishStateResponse.result.phrase,subCode:e.response.publishStateResponse.result.subCode,result:e.response.publishStateResponse.additionalDetail},JSON.stringify(i)}const n=`Invalid CS response which does not contains publishStateResponse. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(n),{response:{code:Yr.CALL_END_CODE.DECODING_FAILED,subCode:Yr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:n}}}removeStateAsync(e,t,i,n){if(this.logger.info(`[${e}][removeStateAsync][scope=${t} publishType=${i} stateIds=${n}]`),this.telemetryHelper.recordEvent(jc,{causeId:e,scope:t,publishType:i,stateIds:n}),!i&&!n){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.REMOVE_STATE_MISSING_ARGUMENTS,phrase:"remove state operation miss arguments"};return this.logger.warn(e),Promise.reject(e)}const r=this.links[Yr.LINKS.REMOVE_STATE];if(!r){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.REMOVE_STATE_LINK_MISSING,phrase:"remove state link is missing"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:r,requestName:od.REMOVE_STATE.name,payload:qh(this,t,n,i),causeId:e,requestId:e}).then((t=>this.parseRemoveStateResult(t,e))).catch((t=>{const i=Ss(t,this.signalingAgentConfig);this.logger.info(`[${e}][removeStateAsync] error: ${Ne(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(qc,{causeId:e,transactionEnd:n}),Promise.reject(n)}))}parseRemoveStateResult(e,t){let i={};return e?.response?.removeStateResponse&&(e.response.removeStateResponse.results?e.response.removeStateResponse.results.forEach((e=>{i[e.stateId]={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode}})):e.response.removeStateResponse.result&&(i={code:e.response.removeStateResponse.result.code,phrase:e.response.removeStateResponse.result.phrase,subCode:e.response.removeStateResponse.result.subCode,result:e.response.removeStateResponse.additionalDetail})),JSON.stringify(i)}updateMeetingSettingsAsync(e,t){this.telemetryHelper.recordEvent(Wc,{causeId:t,meetingSettings:e});const i=this.links[Yr.LINKS.UPDATE_MEETING_SETTINGS];if(!i){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_LINK_MISSING,phrase:"update meeting settings link is missing"};return this.logger.warn(e),Promise.reject(e)}if(!Object.keys(e).length){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS,phrase:"update meeting settings missing arguments"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPutRequest({url:i,requestName:od.UPDATE_MEETING_SETTINGS.name,payload:Xh(this,e),causeId:t,requestId:t}).then((()=>{Md.noop()})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][updateMeetingSettingsAsync] error: ${Ne(i)}`);const n=i.error;throw this.telemetryHelper.recordEvent(zc,{causeId:t,transactionEnd:n}),n}))}searchParticipantsAsync(e,t){this.logger.info(`[${t}][searchParticipantsAsync][queryOptions=${e}]`),this.telemetryHelper.recordEvent(Yc,{causeId:t,queryOptions:e});const i=this.links[Yr.LINKS.SEARCH_PARTICIPANTS];if(!i){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_LINK_MISSING,phrase:"search participants link is missing"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:i,requestName:od.SEARCH_PARTICIPANTS.name,payload:Wh(this,e),causeId:t,requestId:t}).then((e=>{if(e?.response?.participants)return this.parseSearchParticipantsResult(e,t);{const t=`Invalid CS response which does not contain proper search results. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(t),{response:{code:Yr.CALL_END_CODE.DECODING_FAILED,subCode:Yr.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:t}}}})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][searchParticipantsAsync] error: ${Ne(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(Xc,{causeId:t,transactionEnd:n}),Promise.reject(n)}))}parseSearchParticipantsResult(e,t){const i=[];if(e?.response){const t=e.response.participants;if(t)for(const n of Object.keys(t))i.push(Ls.fromRosterSearchResults(e.response.participants[n]))}return{participants:i}}getAllParticipantsAsync(e,t){this.logger.info(`[${t}][getAllParticipantsAsync][scope=${e}]`),this.telemetryHelper.recordEvent(Qc,{causeId:t,scope:e});const i=this.links[Yr.LINKS.GET_ALL_PARTICIPANTS];if(!i){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_LINK_MISSING,phrase:"get all participants link is missing"};return this.logger.warn(e),Promise.reject(e)}if("lobby"!==e){const e={code:Yr.CALL_END_CODE.REJECT,subCode:Yr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SCOPE,phrase:"get all participants scope is invalid"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:i,requestName:od.GET_ALL_PARTICIPANTS.name,payload:Uh(this,e),causeId:t,requestId:t}).then((e=>{if(e?.response)return{participants:e.response.participants};{const e="Invalid CS response which does not contain results.";throw this.logger.warn(e),{response:{code:Yr.CALL_END_CODE.DECODING_FAILED,subCode:Yr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:e}}}})).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][getAllParticipantsAsync] error: ${Ne(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(Zc,{causeId:t,transactionEnd:n}),Promise.reject(n)}))}resetState(){this.currentCallStatus=null,this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE}saveUpdatedCallLinksIfAny(e){e.links&&(this.logger.info(`saveUpdatedCallLinksIfAny, updated call links found, update to new links ${Ne(e)}`),this.links[Yr.LINKS.MEDIA_RENEGOTIATION]=e.links.mediaRenegotiation||this.links[Yr.LINKS.MEDIA_RENEGOTIATION],this.links[Yr.LINKS.TRANSFER]=e.links.transfer||this.links[Yr.LINKS.TRANSFER],this.links[Yr.LINKS.REPLACE]=e.links.replacement||this.links[Yr.LINKS.REPLACE],this.links[Yr.LINKS.HANGUP]=e.links.callLeg||this.links[Yr.LINKS.HANGUP],this.links[Yr.LINKS.KEEPALIVE]=e.links.callLeg||this.links[Yr.LINKS.KEEPALIVE],this.links[Yr.LINKS.PARK]=e.links.hold||this.links[Yr.LINKS.PARK],this.links[Yr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.links.updateMediaDescriptions||this.links[Yr.LINKS.UPDATE_MEDIA_DESCRIPTIONS])}ensureMessageChannelReady(e){return this.disposed?(this.logger.info("ensureMessageChannelReady: error: call already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):this.brokerService?(this.telemetryHelper.addTrouterWaitOperation(`${_d.STARTED}:${e}`),this.telemetryHelper.addTrouterWaitOperation(`${_d.ENDED}:${e}`),Promise.resolve()):this.ensureLatestTrouterUrl(e)}ensureLatestTrouterUrl(e){return this.telemetryHelper.addTrouterWaitOperation(`${_d.STARTED}:${e}`),this.getTrouterUrlAsync().then((t=>!t||"string"==typeof t&&!t.trim()?(this.telemetryHelper.recordEvent(Xa),this.telemetryHelper.addTrouterWaitOperation(`${_d.ENDED}:${e}`),Promise.reject(new Error("Invalid trouter url"))):this.disposed?(this.logger.info("ensureLatestTrouterUrl, trouterUrlGetter returned too late. Object is already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):(this.telemetryHelper.addTrouterWaitOperation(`${_d.ENDED}:${e}`),this.baseMessagingChannelUrl=this.currentTrouterUrl=t,Promise.resolve()))).catch((t=>(this.disposed||this.telemetryHelper.addTrouterWaitOperation(`${_d.FAILED}:${e}`),this.logger.info(`ensureLatestTrouterUrl, failed because:${t}`),Promise.reject(t))))}signalTransferAcceptedAsync(e,t=rs()){return this.logger.info(`[signalTransferAcceptedAsync][${t}] transferType ${e}`),this.disposed?(this.logger.info(`[signalTransferAcceptedAsync][${t}] Call already ended, skip acceptance request`),Promise.reject({code:Yr.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(this.telemetryHelper.recordEvent(Mc,{causeId:t,transferType:e}),this.http.sendPostRequest({url:this.links[Yr.LINKS.TRANSFER_ACCEPTANCE],requestName:od.TRANSFER_ACCEPTANCE.name,payload:{payload:{transferAcceptance:{}}},causeId:t}).catch((e=>{const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[signalTransferAcceptedAsync][${t}] error: ${Ne(i)}`),this.telemetryHelper.recordEvent(Dc,{causeId:t}),Promise.reject(i.error)})))}signalTransferCompletedAsync(e,t=rs()){return this.logger.info(`[signalTransferCompletedAsync][${t}] rejectReason ${e}`),this.disposed?(this.logger.info(`[signalTransferCompletedAsync][${t}]  Call already ended by transferor, skip completion request`),Promise.reject({code:Yr.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(0!==e.code?this.telemetryHelper.recordEvent(Oo,{code:e.code,subcode:e.subCode,causeId:t}):this.telemetryHelper.recordEvent(xc,{causeId:t}),this.telemetryHelper.recordEvent(Uc,{causeId:t}),this.http.sendPostRequest({url:this.links[Yr.LINKS.TRANSFER_COMPLETION],requestName:od.TRANSFER_COMPLETION.name,payload:Jh(e),causeId:t}).catch((e=>{this.telemetryHelper.recordEvent(Fc,{causeId:t});const i=Ss(e,this.signalingAgentConfig);return this.logger.info(`[signalTransferCompletedAsync][${t}] error: ${Ne(i)}`),Promise.reject(i.error)})))}endWithBeacon(e){if(navigator&&navigator.sendBeacon&&!this.disposed){const t={code:Yr.CALL_END_CODE.SUCCESS,subCode:Yr.CALL_END_SUB_CODE.BEACON,phrase:Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED};this.telemetryHelper.recordEvent(Ua,{causeId:e});const i=JSON.stringify(Vh(this,t).payload),n=-1===this.links[Yr.LINKS.LEAVE].indexOf("?")?"?":"&",r=`skypeToken=${this.signalingAgent.authTokenManager.getLastToken(e)}`;return navigator.sendBeacon(`${this.links[Yr.LINKS.LEAVE]}${n}${r}`,i)}return!1}setFsmState(e){this.fsmState=e}setIsHostless(e,t){const i=!!e;this.isHostLessCall!==i&&(this.logger.info(`[${t}][setIsHostless] isHostless=${i}`),this.isHostLessCall=i)}hasGroupModality(){return this.threadId||this.groupId}processConversationServiceResponseHeaders(e,t){this.logger.info(`[${t}][processConversationServiceResponseHeaders]`);try{const i=e.request.getResponseHeader(Yr.HEADERS.CORRELATION_ID)||e.request.getResponseHeader(Yr.HEADERS.CORRELATION_ID.toLowerCase());this.updateCorrelationId(i,t)}catch(e){this.logger.info(`[${t}][processConversationServiceResponseHeaders] failed, reason=${Ne(e)}`)}}processConversationServiceResponse(e,t,i){const n=this.logger.createChild(`[${t}][processConversationServiceResponse]`);if(n.info(`responseType :${i}`),this.processConversationServiceUpdate(e,t),e.subscriptionDetails?.selfParticipant){const i=Ls.fromRoster(e.subscriptionDetails.selfParticipant,!0);n.info("converted selfParticipant to Participant type"),this.participantManager.updateLocalParticipantFromSubscribe(i,t)}this.handleBrokerSubscription(e,t),e.roster&&this.internalHandleRosterUpdate(e.roster,!0,t),0===i&&(this.startOrJoinConvResponseReceived=!0,this.handlePendingEndpointState(t))}processConversationServiceUpdate(e,t){const i=this.logger.createChild(`[${t}][processConversationServiceUpdate]`);i.info(),this.convJoined=!0;const n=e.sequenceNumber>=0?e.sequenceNumber:-1;n<this.updateSequenceNumber?i.info(`seqNum=${n} is less than latest seqNum=${this.updateSequenceNumber}`):(this.updateSequenceNumber=n,this.links[Yr.LINKS.CONVERSATION_CONTROLLER]=e.conversationController,this.links[Yr.LINKS.ADD_PARTICIPANT]=e.links.addParticipant,this.links[Yr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]=e.links.addParticipantAndModality,this.links[Yr.LINKS.LEAVE]=e.links.leave,this.links[Yr.LINKS.NOTIFICATION_LINKS]=e.links.notificationLinks,this.links[Yr.LINKS.REMOVE_PARTICIPANT]=e.links.removeParticipant,this.links[Yr.LINKS.ADD_MODALITY]=e.links.addModality,this.links[Yr.LINKS.REMOVE_MODALITY]=e.links.removeModality,this.links[Yr.LINKS.MUTE]=e.links.mute||null,this.links[Yr.LINKS.UNMUTE]=e.links.unmute||null,this.links[Yr.LINKS.ADMIT]=e.links.admit||null,this.links[Yr.LINKS.ADMIT_ALL]=e.links.admitAll||null,this.links[Yr.LINKS.UPDATE_ENDPOINT_STATE]=e.links.updateEndpointState||null,this.links[Yr.LINKS.UPDATE_ENDPOINT_METADATA]=e.links.updateEndpointMetadata||null,this.links[Yr.LINKS.UPDATE_PARTICIPANT_ROLE]=e.links.updateParticipantRole||null,this.links[Yr.LINKS.PUBLISH_STATE]=e.links.publishState||null,this.links[Yr.LINKS.REMOVE_STATE]=e.links.removeState||null,this.links[Yr.LINKS.UPDATE_MEETING_SETTINGS]=e.links.updateMeetingSettings||null,this.links[Yr.LINKS.SEARCH_PARTICIPANTS]=e.links.searchParticipants||null,this.links[Yr.LINKS.GET_ALL_PARTICIPANTS]=e.links.getAllParticipants||null,this.links[Yr.LINKS.UPDATE_MEETING_LIVE_STATE]=e.links.updateMeetingLiveState||null,this.links[Yr.LINKS.UPDATE_MEETING_GROUPS]=e.links.updateMeetingGroups||null,this.links[Yr.LINKS.SET_MEETING_LAYOUT]=e.links.setMeetingLayout||null,this.links[Yr.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE]=e.links.updateParticipantInterpretationState||null,this.links[Yr.LINKS.UPDATE_PARTICIPANTS_PROPERTIES]=e.links.updateParticipantProperties||null,this.links[Yr.LINKS.JOIN_MEETING_GROUP]=e.links.joinMeetingGroup||null,this.links[Yr.LINKS.LEAVE_MEETING_GROUP]=e.links.leaveMeetingGroup||null,this.links[Yr.LINKS.SEND_MESSAGE]=e.links.sendMessage||null,this.links[Yr.LINKS.UPDATE_MEETING_STATES]=e.links.updateMeetingStates||null,this.convSubject=e.subject,e.state&&(this.setMultiParty(e.state.isMultiParty,t),this.setIsHostless(e.state.isHostless||!1,t),this.conversationType=e.state.conversationType,this.isCastCall="cast"===e.state.conversationType,this.isHuddleGroupCall="huddleGroupCall"===e.state.conversationType),e.activeModalities&&e.activeModalities.groupChat&&this.updateGroupChatIds(e.activeModalities.groupChat,t),e.activeModalities&&e.activeModalities.broadcast&&(this.broadcastSession||(this.broadcastSession=new Hd(this,this.signalingSessionCallback)),this.broadcastSession.handleBroadcastDetailsChanged(e,t)),this.handleMeetingDetailsChanged(e,t),this.handleMeetingStatesChanged(e,t),this.linkUpdateRequested.conversationLinks?(i.info("Updating CS links as requested"),this.updateLinks(this.updateConversationLinks,t)):this.scheduleConversationKeepAlive(),e.meetingData&&(this.meetingData=e.meetingData),e.meetingInfo&&(this.meetingInfo=e.meetingInfo),e.region&&(this.region=e.region),e.callLimits&&(this.callLimits=e.callLimits),e.complianceRecordingContent&&(this.complianceRecordingContent=e.complianceRecordingContent),this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,complianceRecordingContent:this.complianceRecordingContent,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},t))}processLocalParticipantUpdateResponse(e,t){this.logger.info(`[${t}][processLocalParticipantUpdateResponse]`),e.sequenceNumber&&e.sequenceNumber<this.localParticipantUpdateSequenceNumber||(this.breakoutDetails=e.breakoutDetails||{},this.signalingSessionCallback.onBreakoutDetailsUpdated(this.breakoutDetails,t),!0===e.nudgeToJoinAsRealtime&&(this.telemetryHelper.recordEvent(id,{causeId:t}),this.signalingSessionCallback.onNudgeToJoinRealtime(t)))}handlePendingEndpointState(e){this.requestedEndpointStateWhileConnecting&&(this.logger.info(`[${e}][handlePendingEndpointState]sending pending endpoint state now that we are connected.`),this.updateEndpointState(this.requestedEndpointStateWhileConnecting,e,this.requestedPublishedStatesWhileConnecting).catch((e=>{this.isPreheatOnly&&this.disablePreheatDefer.isPending()&&(this.logger.info("handlePendingEndpointState failed"),this.disablePreheatDefer.reject(e))})))}handleMeetingDetailsChanged(e,t){this.logger.info(`[${t}][handleMeetingDetailsChanged]`),e.meetingDetails&&!Md.isEqual(e.meetingDetails,this.meetingDetails)&&this.signalingSessionCallback.onMeetingDetailsUpdated&&(this.meetingDetails=e.meetingDetails,this.meetingDetails.meetingCapability?.meetingLiveState&&(this.meetingLiveStateSequenceNumber=this.meetingDetails.meetingCapability.meetingLiveState.seqNum,this.logger.info(`[${t}][handleMeetingDetailsChanged] update meeting seqNum as ${this.meetingLiveStateSequenceNumber}`)),this.signalingSessionCallback.onMeetingDetailsUpdated(this.meetingDetails,t))}handleMeetingStatesChanged(e,t){this.logger.info(`[${t}][handleMeetingStatesChanged]`),this.signalingSessionCallback.onMeetingStatesUpdated&&this.signalingSessionCallback.onMeetingStatesUpdated(e.meetingStates,t)}handleBrokerSubscription(e,t){this.logger.info(`[${t}][handleBrokerSubscription]`),e.links.subscribe?(this.telemetryHelper.recordEvent(jl,t),this.brokerService&&!Md.isEqual(e.links.subscribe,this.brokerService.currentSubscriptionUrl)?this.brokerService.subscribeToBroker(e.links.subscribe):(this.logger.info(`[${t}][handleBrokerSubscription] broker subscribe ignored. Broker is disabled or subscribe url is same.`),this.telemetryHelper.recordEvent(Jo,t))):this.telemetryHelper.recordEvent(ql,t)}cancelOutgoingCall(e,t){const i=Is();this.logger.info(`[${t}][cancelOutgoingCall][rejectionData=${e&&Ne(e)}]`);const n={code:isNaN(e?.code)?Yr.CALL_END_CODE.CANCEL:e.code,subCode:e?.subCode||Yr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};if(n.resultCategories=n.resultCategories||[_r],this.links.hasOwnProperty(Yr.LINKS.LEAVE)){this.logger.info(`[${t}][cancelOutgoingCall] cancelling outgoing call`),this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE;const e={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()},r={terminatingEnd:fd.LOCAL,resultDetail:n.phrase||"CancelOutgoingCall",endCode:n.code,endSubCode:n.subCode,causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories};this.http.sendPostRequest({url:this.links[Yr.LINKS.LEAVE],requestName:od.CANCEL_CALL.name,payload:Lh(this,n,e),causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})).catch((e=>{const s=Ss(e,this.signalingAgentConfig);this.logger.info(`[cancelOutgoingCall][${t}] error: ${Ne(e)} xhrError: ${Ne(s)}`),this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)}))}else this.logger.info(`[${t}][cancelOutgoingCall] Conversation Service Leave Url is not yet set. Cannot leave conversation. Disposing anyways.`),n.subCode=Yr.CALL_END_SUB_CODE.CONV_URL_NOT_SET,this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultDetail:n.phrase||"CancelOutgoingCall",endCode:n.code,endSubCode:n.subCode,causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t),i.resolve(null);return i.promise}terminateEstablishedCall(e,t){const i=t.causeId||rs();this.logger.info(`[${i}][terminateEstablishedCall]`);const n=Is();this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE;const r=this.convJoined?od.LEAVE_CONVERSATION.name:od.END_CALL.name,s=th(),a={code:e?.code||Yr.CALL_END_CODE.SUCCESS,subCode:e?.subCode||Yr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};a.resultCategories=a.resultCategories||[_r];const o={terminatingEnd:fd.LOCAL,endCode:a.code,endSubCode:a.subCode,resultDetail:a.phrase||"TerminateEstablishedCall",causeId:i,clientReasonSubCode:a.clientReasonSubCode,clientReasonPhrase:a.clientReasonPhrase,resultCategories:a.resultCategories};return this.leaveConversation(a,t).then((()=>{this.logger.info(`[${i}][terminateEstablishedCall]success`),this.disposed||(this.telemetryHelper.setTerminatingData(o),this.telemetryHelper.addNetworkOperationCompleted(r,!0,s.duration()),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,i,a),this.dispose(a,i)),n.resolve(null)})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);this.logger.info(`[${i}][terminateEstablishedCall][failed] error: ${Ne(e)} xhrError: ${Ne(t)}]`),this.disposed||(this.telemetryHelper.setTerminatingData(o),this.telemetryHelper.addNetworkOperationCompleted(r,!1,s.duration()),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,i,a),this.dispose(a,i)),n.resolve(null)})),n.promise}deleteConversation(e,t){this.logger.info(`[${t}][deleteConversation]`);const i=Is();this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE;const n=od.DELETE_CONVERSATION.name,r=th(),s={code:e?.code||Yr.CALL_END_CODE.SUCCESS,subCode:e?.subCode||Yr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Yr.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED,resultCategories:e?.resultCategories||[_r],clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase},a={terminatingEnd:fd.LOCAL,endCode:s.code,endSubCode:s.subCode,resultDetail:s.phrase,causeId:t,clientReasonSubCode:s.clientReasonSubCode,clientReasonPhrase:s.clientReasonPhrase,resultCategories:s.resultCategories};return this.deleteConversationController(s,t).then((()=>{this.logger.info(`[${t}][deleteConversation]success`),this.disposed||(this.telemetryHelper.setTerminatingData(a),this.telemetryHelper.addNetworkOperationCompleted(n,!0,r.duration()),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,s),this.dispose(s,t)),i.resolve(null)})).catch((e=>{const o=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][deleteConversation][failed] error: ${Ne(e)} xhrError: ${Ne(o)}`),this.disposed||(this.telemetryHelper.setTerminatingData(a),this.telemetryHelper.addNetworkOperationCompleted(n,!1,r.duration()),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,s),this.dispose(s,t)),i.resolve(null)})),i.promise}leaveConversation(e,t){const i=t.causeId||rs();if(this.convJoined){this.logger.info(`[${i}][leaveConversation]`);const n={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()};return this.http.sendPostRequest({url:this.links[Yr.LINKS.LEAVE],requestName:od.LEAVE_CONVERSATION.name,payload:Vh(this,e,n,t.scope),withoutTrouter:!0,causeId:i})}return this.logger.info(`[${i}][leaveConversation] ignore, not joined to conversation`),Promise.resolve(void 0)}deleteConversationController(e,t){return this.convJoined?(this.logger.info(`[${t}][deleteConversationController]`),this.http.sendDeleteRequest({url:this.links[Yr.LINKS.CONVERSATION_CONTROLLER],requestName:od.DELETE_CONVERSATION.name,payload:xh(this,e),withoutTrouter:!0,causeId:t})):(this.logger.info(`[${t}][deleteConversationController]ignored, not joined to conversation`),Promise.resolve(void 0))}rejectIncomingCall(e,t){this.telemetryHelper.recordEvent(vc,t),this.logger.info(`[${t}][rejectIncomingCall]`);const i=Is();this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE;const n={code:isNaN(e?.code)?Yr.CALL_END_CODE.REJECT:e.code,subCode:e?.subCode||Yr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Yr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};n.resultCategories=n.resultCategories||[_r];const r={terminatingEnd:fd.LOCAL,endCode:n.code,endSubCode:n.subCode,resultDetail:n.phrase||"RejectCall",causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories};return this.http.sendDeleteRequest({url:this.links[Yr.LINKS.REJECT],requestName:od.REJECT_CALL.name,payload:jh(this,n),causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})).catch((e=>{const s=Ss(e,this.signalingAgentConfig);this.logger.info(`[rejectIncomingCall][${t}] error: ${Ne(e)} xhrError: ${Ne(s)}`),this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})),i.promise}onCallStatusChanged(e,t,i){const n=`[${t}][onCallStatusChanged]`;if(this.logger.info(`${n}${this.currentCallStatus}=>${e}]`),this.disposed)this.logger.info(`${n}Call is already disposed!!`);else if(i&&this.logger.info(`${n}[statusCode=${Ne(i)}]`),this.isPromotingToRealtime)e===Yr.CALL_STATUS.CONNECTED&&this.onPromotionCompleted(!1,void 0,t);else if(this.isValidStateTransitions(e)){this.currentCallStatus=e;const n={callStatus:e,statusCode:i,causeId:t};this.isPreheatOnly&&(n.isPreheatOnly=!0),this.telemetryHelper.recordEvent(ac,n),this.signalingSessionCallback.onCallStatusChanged(e,i,t),this.currentCallStatus===Yr.CALL_STATUS.CONNECTED&&(this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.telemetryHelper.resetCallCancelationDurationWatch(),this.isPreheatOnly&&this.startCallPreheatTimer(t))}}updateMeetingLiveStateAsync(e,t){this.logger.info(`[${e}][updateMeetingLiveStateAsync][options=${JSON.stringify(t)}]`),this.telemetryHelper.recordEvent(dl,{causeId:e,meetingLiveStateOptions:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,(()=>{this.handleUpdateMeetingLiveStateError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT},hl,e,e,t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT);const i=function(e,t,i){return cs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},meetingLiveState:t,links:{updateMeetingLiveStateStatus:Zr(e,Pr.UPDATE_MEETING_LIVE_STATE_STATUS)},operationId:i}}}(this,{...t,seqNum:this.meetingLiveStateSequenceNumber},e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.UPDATE_MEETING_LIVE_STATE],requestName:od.UPDATE_MEETING_LIVE_STATE.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][updateMeetingLiveStateAsync] response: ${Ne(t)}`),this.telemetryHelper.recordEvent(hl,{causeId:e})})).catch((i=>{const n=Ss(i,this.signalingAgentConfig);return this.logger.info(`[${e}][updateMeetingLiveStateAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingLiveStateError(n.error,ul,e,e,t),Promise.reject(n.error))}))}updateMeetingStatesAsync(e,t){const i=this.logger.createChild(`[${e}][updateMeetingStatesAsync]`,this.correlationId);if(i.info(`meetingStatesOptions: ${JSON.stringify(t)}`),!t)return Promise.reject({code:Yr.VALIDATION.VALIDATION_FAILED,subCode:Yr.VALIDATION.NULL_OR_EMPTY,phrase:"meetingStatesOptions should be a non empty object"});this.telemetryHelper.recordEvent(nd,{causeId:e,meetingStatesOptions:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,(()=>{for(const i in t.meetingStates)this.handleUpdateMeetingStatesError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT},rd,e,t.operationId+"_"+i)}),Yr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT);const n=function(e,t,i){return cs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},meetingStates:t,updateMeetingStatesStatus:Zr(e,Pr.UPDATE_MEETING_STATES_STATUS),operationId:i}}}(this,{...t.meetingStates},e);return this.http.sendPostRequest({url:this.links[Yr.LINKS.UPDATE_MEETING_STATES],requestName:od.UPDATE_MEETING_STATES.name,payload:n,causeId:e}).then((t=>{i.info(`response: ${Ne(t)}`),this.telemetryHelper.recordEvent(rd,{causeId:e})})).catch((n=>{const r=Ss(n,this.signalingAgentConfig);if(i.error(`error: ${Ne(r)}`),!this.disposed){for(const i in t.meetingStates)this.handleUpdateMeetingStatesError(r.error,ad,e,t.operationId+"_"+i);return Promise.reject(r.error)}return Promise.reject(this.getCallNotFoundTransactionEnd())}))}handleUpdateMeetingLiveStateError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingLiveStateError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingLiveStateError] reject reason: ${e}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted&&this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted(e,i,n))}handleUpdateMeetingLiveStateCompletion(e){const t=e.body,i=Cs(e),n=t.updateMeetingLiveStateResponse.result,r=t.updateMeetingLiveStateResponse.operationId;r||this.logger.warn(`[${i}][handleUpdateMeetingLiveStateCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateMeetingLiveStateCompletion] meetingLiveUpdate completes with operationId=${r}`),this.handleOperationCompletionCommon(n,i,r,Ne(t),"handleUpdateMeetingLiveStateCompletion",Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,pl,gl,this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted,this.handleUpdateMeetingLiveStateError.bind(this))}handleUpdateMeetingStatesError(e,t,i,n){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingStatesError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingStatesError] reject reason: ${e}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,causeId:i}),this.signalingSessionCallback.onUpdateMeetingStatesCompleted&&this.signalingSessionCallback.onUpdateMeetingStatesCompleted(e,i,n))}handleUpdateMeetingStatesCompletion(e){const t=e.body,i=Cs(e),n=t.updateMeetingStatesResponse,r=t.operationId,s=this.logger.createChild(`[${i}][handleUpdateMeetingStatesCompletion]`,this.correlationId);r||s.warn("operationId is undefined.");for(const e of n)s.info(`UpdateMeetingStates completes with operationId=${r}.`),this.handleOperationCompletionCommon(e.transactionEnd,i,r+"_"+e.meetingStateName,Ne(t),"handleUpdateMeetingStatesCompletion",Yr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,sd,ad,this.signalingSessionCallback.onUpdateMeetingStatesCompleted,this.handleUpdateMeetingStatesError.bind(this))}setMeetingLayoutAsync(e,t){this.logger.info(`[${e}][setMeetingLayoutAsync][options=${JSON.stringify(t)}]`),this.telemetryHelper.recordEvent(bl,{causeId:e,setMeetingLayoutOptions:t}),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,(()=>{this.handleSetMeetingLayoutError({code:Yr.CALL_END_CODE.TIMEOUT,subCode:Yr.CALL_END_SUB_CODE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT,phrase:Yr.CALL_END_PHRASE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT},Al,e,e,t)}),Yr.TIMEOUT_VALUES_IN_SECONDS.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT);const i=function(e,t){return cs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},...t,links:{setMeetingLayoutStatus:Zr(e,Pr.SET_MEETING_LAYOUT_STATUS)}}}}(this,{...t,sequenceNumber:this.meetingLayoutSequenceNumber});return this.http.sendPostRequest({url:this.links[Yr.LINKS.SET_MEETING_LAYOUT],requestName:od.SET_MEETING_LAYOUT.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][setMeetingLayoutAsync] response: ${Ne(t)}`),this.telemetryHelper.recordEvent(Al,{causeId:e})})).catch((i=>{const n=Ss(i);return this.logger.info(`[${e}][setMeetingLayoutAsync] error: ${Ne(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleSetMeetingLayoutError(n.error,Rl,e,e,t),Promise.reject(n.error))}))}handleSetMeetingLayoutError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleSetMeetingLayoutError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleSetMeetingLayoutError] reject reason: ${e}`),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onSetMeetingLayoutCompleted&&this.signalingSessionCallback.onSetMeetingLayoutCompleted(e,i,n))}handleSetMeetingLayoutCompletion(e){const t=e.body,i=Cs(e),n=t.setMeetingLayoutResponse.result,r=t.setMeetingLayoutResponse.operationId;r||this.logger.warn(`[${i}][handleSetMeetingLayoutCompletion] operationId is undefined.`),this.handleOperationCompletionCommon(n,i,r,Ne(t),"handleSetMeetingLayoutCompletion",Yr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,Pl,wl,this.signalingSessionCallback.onSetMeetingLayoutCompleted,this.handleSetMeetingLayoutError.bind(this))}handleOperationCompletionCommon(e,t,i,n,r,s,a,o,c,l){this.disposed?this.logger.info(`[${t}][${r}] ignored. Call disposed.`):(this.logger.info(`[${t}][${r}] body ${n}`),e.code===Yr.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(s),this.telemetryHelper.recordEvent(a,{...e,causeId:t}),c&&c(e,t,i)):l&&l(e,o,t,i))}isValidStateTransitions(e){if(this.currentCallStatus===Yr.CALL_STATUS.LOCAL_TERMINATED&&e===Yr.CALL_STATUS.CONNECTING)return!0;const t=e=>{switch(e){case Yr.CALL_STATUS.IDLE:case Yr.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY:return 0;case Yr.CALL_STATUS.CONNECTING:return 1;case Yr.CALL_STATUS.RINGING:return 2;case Yr.CALL_STATUS.CONNECTED:return 3;case Yr.CALL_STATUS.LOCAL_TERMINATED:case Yr.CALL_STATUS.REMOTE_TERMINATED:return 4;default:return-1}};return t(e)>t(this.currentCallStatus)}handlePSTNBalanceUpdate(e){const t=e.body.balanceUpdate,i=Cs(e);this.logger.info(`[${i}][handlePSTNBalanceUpdate]`),this.telemetryHelper.recordIncomingEvent(ic,e),t.updateBalance?this.signalingSessionCallback.onPSTNBalanceUpdate(t):this.logger.info(ic,"this was a pstn keepAlive message - ignore")}handleCallAcceptanceAck(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleCallAcceptanceAck]`),this.telemetryHelper.recordIncomingEvent(Ga,e),this.internalHandleCallAcceptanceAck(t,i)}internalHandleCallAcceptanceAck(e,t){this.logger.info(`[${t}][internalHandleCallAcceptanceAck] ${Ne(e)}`),this.fsmState!==Yr.SIGNALING_FSM_STATE.CONNECTED&&(this.links[Yr.LINKS.MEDIA_RENEGOTIATION]=e.callAcceptanceAcknowledgement.links.mediaRenegotiation,this.links[Yr.LINKS.TRANSFER]=e.callAcceptanceAcknowledgement.links.transfer,this.links[Yr.LINKS.REPLACE]=e.callAcceptanceAcknowledgement.links.replacement,this.links[Yr.LINKS.HANGUP]=e.callAcceptanceAcknowledgement.links.callLeg,this.links[Yr.LINKS.KEEPALIVE]=e.callAcceptanceAcknowledgement.links.callLeg,this.links[Yr.LINKS.PARK]=e.callAcceptanceAcknowledgement.links.hold,this.links[Yr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.callAcceptanceAcknowledgement.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(e.callAcceptanceAcknowledgement),this.scheduleKeepAlives(e.callAcceptanceAcknowledgement.callKeepAliveInterval),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(e.callAcceptanceAcknowledgement.callProperties?.isSharedLineAppearanceV2Activated),this.fsmState=Yr.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.INCOMING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(t),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTED,t),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${t}][internalHandleCallAcceptanceAck] updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,t)))}isFatalException(e){let t=!0;try{JSON.parse(e.message).code===Yr.CALL_END_CODE.CONFLICT&&(t=!1,this.logger.info("isFatalException: received non-fatal 409 error"))}catch(e){this.logger.error("isFatalException: failed to parse error")}return t}startOrJoinCall(e,t,i,n,r){if(this.logger.info(`[${i}]startOrJoinCall[${t}]`),this.disposed)return void this.logger.info(`[${i}][${t}] session already disposed, ignore`);this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,i);const s=this.getConversationUrl()?this.getConversationUrl():e.conversationServiceUrl;this.telemetryHelper.setConversationServiceUrl(s),this.logger.info(`options.conversationServiceUrl ${e.conversationServiceUrl} conversationServiceUrl ${s}`),e.isPreheatOnly?(this.isPreheatOnly=!0,this.telemetryHelper.recordEvent(Ic,{causeId:i}),this.telemetryHelper.setSelfParticipantRole(yd.PREHEAT),this.telemetryHelper.setIsPreheated()):this.telemetryHelper.startCallCancelationDurationWatch(),this.mediaTypesToUse=r,this.lastUsedOutgoingMediaContent=n,this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);const a=!this.multiParty&&this.signalingAgentConfig.enableLongOutgoing1To1SetupTimeoutForWeb,o=a?Yr.TIMEOUT_VALUES_IN_SECONDS.LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:Yr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT;this.logger.info(`[${i}][${t}]target endpointType = ${this.transferContext&&this.transferContext.target?this.transferContext.target.endpointType:"default"} timeout = ${o} LongerTimeout = ${a}`);const c=e.newCall?function(e,t,i,n){cs(e,"signalingSession cannot be null");let r=[];r=n.invitationType===Yr.INVITATION_TYPE.NUDGE&&Array.isArray(n.participantsToNudge)?n.participantsToNudge.map((e=>({id:e}))):e.participantManager.getParticipantsToInitiateCallWith(),e.signalingAgentConfig.doHostlessCalling||as(r.length>0,"remoteParticipants need to be set before a call can be made");const s={type:"Delta",rosterUpdate:Zr(e,Pr.CONV_ROSTER_UPDATE)},a=e.groupId?{id:e.groupId}:null,o=e.threadId?{threadId:e.threadId,messageId:e.teamsMessageId||null}:null,c=e.contentSharingManager.getContentSharingInfoToStartSharing(),l=null===c?null:{identifier:c.contentIdentifier,subject:c.subject,sessionState:c.sessionState,sessionUpdateSequenceNumber:c.sequenceNumber,links:{sessionUpdate:Zr(e,Pr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:Zr(e,Pr.CONV_CONTENT_SHARING_END)}},d=e.broadcastSession?.getContext(),h=e.getEndpointCapabilities();1===r.length&&e.telemetryHelper.setCalleeType(r[0].id),e.numberOfOriginalInvitees=r.length;const u=[];r.forEach((t=>{const i={id:t.id};t.displayName&&(i.displayName=t.displayName),t.participantId&&(i.participantId=t.participantId),(n.callToVoicemail||e.transferContext&&e.transferContext.target&&"voicemail"===e.transferContext.target.endpointType)&&(i.endpointType="voicemail"),u.push(i)}));const g=e.transferContext?e.transferContext.transferor:null,p=e.transferContext?e.transferContext.transferContext:null,m={};n.callToVoicemail&&(n.voicemailResourcePath&&(m.localResourcePath=n.voicemailResourcePath),n.voicemailItemId&&(m.voicemailItemId=n.voicemailItemId));const f={payload:{conversationRequest:{conversationType:n.conversationType,subject:e.convSubject,suppressDialout:n.suppressDialout,applicationType:n.applicationType,targetApplicationType:n.targetApplicationType,roster:s,properties:{allowConversationWithoutHost:e.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:e.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:e.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration},links:{conversationEnd:Zr(e,Pr.CONV_END),conversationUpdate:Zr(e,Pr.CONV_UPDATE),localParticipantUpdate:Zr(e,Pr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:Zr(e,Pr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:Zr(e,Pr.CONV_ADD_PARTICIPANT_FAILURE),addModalitySuccess:Zr(e,Pr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:Zr(e,Pr.CONV_ADD_MODALITY_FAILURE),confirmUnmute:Zr(e,Pr.CONV_CONFIRM_UNMUTE),receiveMessage:Zr(e,Pr.RECEIVE_MESSAGE)}},broadcast:d,contentSharing:l,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,meetingRegistrationId:n.meetingRegistrationId,participantPin:n.participantPin},to:u},capabilities:null,endpointCapabilities:h,clientEndpointCapabilities:n.clientEndpointCapabilities?n.clientEndpointCapabilities:null,endpointMetadata:e.endpointMetadata,groupContext:a,groupChat:o,meetingInfo:e.getMeetingInfo(),meetingData:n.meetingData,meetingPreferences:n.meetingPreferences,endpointState:n.endpointState}};if(n.publishedStates?.publishedStates.length>0){let t=[];t=n.publishedStates.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("createConversationRequest getPayload() failed to parse state.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),f.payload.publishedStates=t}e.deviceType&&"default"!==e.deviceType&&(f.payload.conversationRequest.deviceType=e.deviceType);const S=ds(i);if(e.telemetryHelper.addOutgoingModalities(S),f.payload.callInvitation={callModalities:S,replaces:null,transferor:g||null,clientTransferContext:p,customContext:n.customHeaderContext||null,links:{progress:Zr(e,Pr.PROGRESS),mediaAnswer:Zr(e,Pr.MEDIA_ANSWER),acceptance:Zr(e,Pr.ACCEPT),redirection:Zr(e,Pr.REDIRECTION),end:Zr(e,Pr.END)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),pstnContent:e.pstnContent,emergencyContent:e.getEmergencyContent(),mediaContent:t,voicemailSettings:m,routingFlags:n.routingFlags,invitationData:n.invitationData,locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent()},n.pickupCode&&(f.payload.callInvitation.unparkContent={pickupCode:parseInt(n.pickupCode,10)}),n.onBehalfOf&&(f.payload.callInvitation.onBehalfOf={id:n.onBehalfOf},n.onBehalfOfUserDisplayName&&(f.payload.callInvitation.onBehalfOf.displayName=n.onBehalfOfUserDisplayName)),n.callQueueContext&&(f.payload.callInvitation.callQueueContext=n.callQueueContext),n.scenario&&(f.payload.conversationRequest.scenario=n.scenario),n.alternateId&&(f.payload.participants.from.alternateId=n.alternateId),n.invitationType===Yr.INVITATION_TYPE.NUDGE&&(f.payload.participants.invitationType=n.invitationType),e.signalingAgentConfig.ecsEtag&&(f.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),n.clientEndpointDebugContent){f.payload.debugContent||(f.payload.debugContent={});try{f.payload.debugContent.clientDebugContent=JSON.parse(n.clientEndpointDebugContent)}catch(e){as(!1,`Failed to parse ${n.clientEndpointDebugContent}`)}}if(n.captchaContentJson)try{f.payload.conversationRequest.captchaContent=JSON.parse(n.captchaContentJson)}catch(e){as(!1,`Failed to parse ${n.captchaContentJson}`)}return f}(this,n,r,e):Fh(this,n,r,e,i);this.signalingAgentConfig.enableCallEstablishmentTimeoutsForStartJoinCall&&this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(i)}),o),this.signalingSessionCallback.onTransferredCallAcceptance(i),e.endpointState&&(this.latestEndpointState=e.endpointState),this.http.sendPostRequest({url:s,requestName:t,operationType:"CallSetup",payload:c,causeId:i}).then((e=>{this.disposed||(this.processConversationServiceResponseHeaders(e,i),this.processConversationServiceResponse(e.response,i,0),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTING,i))})).catch((e=>{if(e.stack&&!this.isFatalException(e))return;const n=Ss(e,this.signalingAgentConfig);if(this.logger.info(`[startOrJoinCall][${i}][${t}] error: ${Ne(e)} xhrError: ${Ne(n)}`),!this.disposed){if(this.isPromotingToRealtime)return void this.onPromotionCompleted(!0,n.error,i);this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,endCode:n.telemetryEndSubCode,endSubCode:n.error.subCode,resultCategories:n.error.resultCategories,resultDetail:n.error.phrase||this.getTerminatingCallResultDetail(t,n.error),causeId:i}),this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,i,n.error),this.dispose(n.error,i)}}))}processIncomingCallPayload(e,t){this.remoteUser=Ls.fromWireParticipant(e.callNotification.from),this.participantManager.setLocalParticipantId(e.callNotification.to.participantId,t),e?(e.conversationInvitation&&(this.links[Yr.LINKS.CONVERSATION_CONTROLLER]=e.conversationInvitation.conversationController,this.setMultiParty(e.conversationInvitation.isMultiParty,t),this.setIsHostless(!!e.conversationInvitation.isHostless,t)),e.callNotification&&(this.links[Yr.LINKS.ATTACH]=e.callNotification.links?.attach,this.links[Yr.LINKS.REDIRECT]=e.callNotification.links?.redirection,this.onBehalfOf=e.callNotification.onBehalfOf?.id,this.onBehalfOfUserDisplayName=e.callNotification.onBehalfOf?.displayName,this.callQueueContext=e.callNotification.callQueueContext,this.callPhoneLineType=e.callNotification.callPhoneLineType,this.callType=e.callNotification.callType,this.incomingCallCallerId=e.callNotification.from?.id,this.callUsesMixer=!!e.callNotification.mediaContent?.fromMixer,this.isRedirectAllowed=!!e.callNotification.redirectionProperties?.isRedirectAllowed),e.debugContent&&this.updateCorrelationId(e.debugContent.callId,t),e.callNotification.transferor&&(this.transferor=e.callNotification.transferor.details?e.callNotification.transferor.details.id:null),e.groupChat&&this.updateGroupChatIds(e.groupChat,t),e.meetingData&&(this.meetingData=e.meetingData),e.meetingInfo&&(this.meetingInfo=e.meetingInfo)):this.logger.info(`[${t}][processIncomingCallPayload] empty incoming payload content`)}processAttachResponse(e,t,i){this.telemetryHelper.recordEvent(gc,{causeId:i}),this.links[Yr.LINKS.MEDIA_ANSWER]=t.response.callInvitation.links.mediaAnswer,this.links[Yr.LINKS.ACCEPT]=t.response.callInvitation.links.acceptance,this.links[Yr.LINKS.REJECT]=t.response.callInvitation.links.callLeg,this.links[Yr.LINKS.REDIRECT]=t.response.callInvitation.links.redirection,this.links[Yr.LINKS.NEW_OFFER]=t.response.callInvitation.links.newOffer,this.signalingAgentConfig.sendProgressFromCC||this.sendProgress(t),this.remoteCaller=t.response.participants.from;const n=this.getInitialMediaOfferFromIncomingCallPayload()||t.response.callInvitation.mediaContent;this.telemetryHelper.setCallerType(this.getParticipantIdForOfferAnswer(n));const r=ds(t.response.callInvitation.callModalities);this.telemetryHelper.addIncomingModalities(r),this.telemetryHelper.setOfferedModalities(n.blob,!0),this.callUsesMixer=n.fromMixer,this.isRedirectAllowed=!(!t.response.callInvitation.redirectionProperties||!t.response.callInvitation.redirectionProperties.isRedirectAllowed),this.signalingSessionCallback.onOffer({subject:e.conversationInvitation.subject,remoteParticipantId:this.getParticipantIdForOfferAnswer(n),remoteEndpointId:t.response.participants.from.endpointId,transferor:t.response.callInvitation.transferor,clientTransferContext:e.callNotification.transferContext,customHeaderContext:t.response.callInvitation.customContext,mediaTypes:r,mediaContent:n,renegotiation:!1,invitationData:t.response.callInvitation.invitationData,riskLevel:t.response.callInvitation.spamProperties&&t.response.callInvitation.spamProperties.riskLevel,stirAttestation:t.response.callInvitation.spamProperties&&t.response.callInvitation.spamProperties.stirAttestation,isRedirectAllowed:this.isRedirectAllowed},i)}sendProgress(e,t=rs()){this.logger.info(`[${t}][sendProgress]`),this.telemetryHelper.recordEvent(pc,{causeId:t}),this.http.sendPostRequest({url:e.response.callInvitation.links.progress,requestName:od.SEND_CALL_PROGRESS.name,payload:Nh(this),causeId:t}).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][sendProgress] error: ${Ne(i)}`),this.disposed||this.telemetryHelper.recordEvent(mc,{causeId:t,...i.error})}))}handleCallNotification(e){const t=Cs(e);if(this.logger.info(`[${t}][handleCallNotification]`),this.telemetryHelper.recordIncomingEvent(ec,e),!us(e.url,Pr.REPLACE))throw new Error(`[${t}][handleCallNotification]IncomingCallNotification should not be received in handleIncomingMsg`);this.telemetryHelper.recordIncomingEvent(tc,e),this.logger.info(`[${t}][handleCallNotification]replacementCallNotification`),this.signalingSessionCallback&&this.signalingSessionCallback.onIncomingCallReplacement(e.body,t)}handleMediaAnswer(e){this.telemetryHelper.recordIncomingEvent(Fs,e);const t=e.body,i=Cs(e);if(this.logger.info(`[${i}][handleMediaAnswer]`),this.mediaRenegotiationManager.isOutgoingRenegotiationInProgress())this.mediaRenegotiationManager.handleMediaAnswer(t,i);else if(this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED);else if(this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING){if(vs(e.headers,this.provisionalMediaAnswersSeenSoFar))return void this.logger.info(`[${i}][handleMediaAnswer] ignoring provisional answer retried by service`);t.mediaAnswer.sender&&(this.remoteUser=t.mediaAnswer.sender),this.resetCallEstablishmentTimeout(i),t.mediaAnswer.noRingBack||(this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Yr.CALL_STATUS.RINGING,i));const n=t.mediaAnswer.mediaContent;this.signalingSessionCallback.onAnswer({provisional:!0,renegotiation:!1,remoteEndpointId:t.mediaAnswer.sender?t.mediaAnswer.sender.endpointId:ss(),remoteParticipantId:this.getParticipantIdForOfferAnswer(n),mediaContent:n},i)}}async _sendCallAcceptanceAcknowledgement(e,t){this.http.sendPostRequest({url:e.body.callAcceptance.links.acknowledgement,requestName:od.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:Oh(this),causeId:t}).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][_sendCallAcceptanceAcknowledgement] error: ${Ne(i)}`),this.disposed||this.telemetryHelper.recordEvent(Wa,{causeId:t,...i.error})}))}handleCallAcceptance(e){const t=Cs(e);this.telemetryHelper.recordIncomingEvent(ja,e,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:t}),this.logger.info(`[${t}][handleCallAcceptance]enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?(this._sendCallAcceptanceAcknowledgement(e,t),this._processCallAcceptance(e,t)):(this._processCallAcceptance(e,t),this.http.sendPostRequest({url:e.body.callAcceptance.links.acknowledgement,requestName:od.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:Oh(this),causeId:t}).catch((e=>{const i=Ss(e,this.signalingAgentConfig);this.logger.info(`[${t}][handleCallAcceptance] error: ${Ne(i)}`),this.disposed||this.telemetryHelper.recordEvent(Wa,{causeId:t,...i.error})})))}handleCallAcceptanceSync(e){const t=Cs(e);this.telemetryHelper.recordIncomingEvent(qa,e,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:t}),this.logger.info(`[${t}][handleCallAcceptanceSync] enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?Md.defer(this._processCallAcceptance,e,t):this._processCallAcceptance(e,t);const i=Oh(this).payload;return this.telemetryHelper.addNetworkOperationCompleted(od.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,!0),i}getFakeRoster(e){const t=this.participantManager.getParticipantsToInitiateCallWith();let i;i=1===t.length?t[0].id:e.callAcceptance.acceptedBy.id;const n={id:i,displayName:e.callAcceptance.acceptedBy.id===i?e.callAcceptance.acceptedBy.displayName:"",languageId:e.callAcceptance.acceptedBy.languageId},r=e.callAcceptance.acceptedBy.endpointId;return{type:"MultiPartyEndpoint",participants:{[i]:{acceptedBy:e.callAcceptance.acceptedBy.id,details:n,endpoints:{[r]:{call:{},contentSharing:{},capabilities:e.callAcceptance.capabilities,participantId:e.callAcceptance.acceptedBy.participantId}}}}}}processCallAcceptance(e,t){this.logger.info(`[${t}][processCallAcceptance] ${Ne(e)}`),this.telemetryHelper.recordEvent(fc,{causeId:t}),this.fsmState=Yr.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(t);let i=!1;e.callAcceptance.controllerName===Yr.MISC.LOBBY_CALL_CONTROLLER&&(this.logger.info(`[${t}][processCallAcceptance] Controller name is lobby so putting user in lobby`),this.participantManager.localParticipant.isLobby=!0,this.participantManager.localParticipant.endpointDetails.push({isLobby:!0,endpointId:this.participantManager.localParticipant.endpointId,participantId:this.participantManager.localParticipant.participantId}),i=!0,this.telemetryHelper.recordEvent(Sc,{causeId:t})),this.participantManager.localParticipant.isStaging=Ld(e.callAcceptance),this.signalingSessionCallback.onMeetingGroupDetailsUpdated(e.callAcceptance.meetingGroupDetails,t),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(e.callAcceptance.callProperties?.isSharedLineAppearanceV2Activated),this.logger.info(`[${t}][processCallAcceptance] for localParticipant, isStaging is set to ${this.participantManager.localParticipant.isStaging}`);let n=this.mediaTypesToUse,r=ss();e.callAcceptance.acceptedBy&&(this.remoteUser=Ls.fromWireParticipant(e.callAcceptance.acceptedBy),r=e.callAcceptance.acceptedBy.endpointId),e.callAcceptance.acceptedCallModalities&&e.callAcceptance.acceptedCallModalities.length>0&&(n=e.callAcceptance.acceptedCallModalities);const s=e.callAcceptance.mediaContent;this.callUsesMixer=s.fromMixer;const a=ds(n);this.telemetryHelper.addIncomingModalities(a),this.telemetryHelper.setAnsweredModalities(s.blob,!0),this.links[Yr.LINKS.MEDIA_RENEGOTIATION]=e.callAcceptance.links.mediaRenegotiation,this.links[Yr.LINKS.TRANSFER]=e.callAcceptance.links.transfer,this.links[Yr.LINKS.REPLACE]=e.callAcceptance.links.replacement,this.links[Yr.LINKS.HANGUP]=e.callAcceptance.links.callLeg,this.links[Yr.LINKS.KEEPALIVE]=e.callAcceptance.links.callLeg,this.links[Yr.LINKS.PARK]=e.callAcceptance.links.hold,this.links[Yr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.callAcceptance.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(e.callAcceptance),this.scheduleKeepAlives(e.callAcceptance.callKeepAliveInterval);const o=this.getParticipantIdForOfferAnswer(s);this.signalingSessionCallback.onAnswer({provisional:!1,renegotiation:!1,remoteEndpointId:r,remoteParticipantId:o,callAcceptedByNGCVoicemail:o===Yr.KNOWN_BOTS.VOICEMAIL_BOT_ID,mediaTypes:a,mediaContent:s},t),this.setRealTimeState(2,t),this.onCallStatusChanged(Yr.CALL_STATUS.CONNECTED,t),i&&this.signalingSessionCallback.onSelfParticipantUpdated(this.participantManager.localParticipant,t),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${t}][processCallAcceptance] Updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,t))}updateGroupChatIds(e,t){const i=this.groupId,n=this.threadId,r=this.teamsMessageId,s=this.backroomThreadId;this.groupId=e.groupId,this.threadId=e.threadId,this.teamsMessageId=e.messageId,this.backroomThreadId=e.backroomThreadId,this.groupId===i&&this.threadId===n&&this.teamsMessageId===r&&this.backroomThreadId===s||this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},t)}handleCallEnd(e){let t=e.body.callEnd||e.body;const i=Cs(e);if(this.logger.info(`[${i}][handleCallEnd][content=${Ne(t)}]`),this.telemetryHelper.recordEvent(Ja,{origin:e.origin,code:t?t.code:"unknown",subCode:t?t.subCode:"unknown",resultCategories:t?t.resultCategories:[],causeId:i}),this.signalingAgentConfig.enableConversationTypeUpdateOnCallEnd&&(this.conversationType=t?.conversationType||this.conversationType),this.fsmState!==Yr.SIGNALING_FSM_STATE.IDLE)if(t.code===Yr.CALL_END_CODE.CONFLICT&&this.multiParty&&t.conversationUrl?.Location)this.handleConversationResolutionConflict(t,i);else{this.disposing=!0,t.callControllerTransactionEnd&&(this.logger.info("handleCallEnd: using CC end details specified in CS end"),t=t.callControllerTransactionEnd),t.broadcastOperationFailure&&(this.logger.info("handleCallEnd: using broadcastOperationFailure end details specified in CS end"),t=t.broadcastOperationFailure);const e=t.code===Yr.CALL_END_CODE.SUCCESS||t.code===Yr.CALL_END_CODE.CANCEL||t.code===Yr.CALL_END_CODE.REJECT;this.telemetryHelper.setTerminatingData({terminatingEnd:fd.REMOTE,resultDetail:t.phrase,resultValue:e?Sd.SUCCESS:Sd.FAILURE,endCode:t.code,endSubCode:t.subCode,resultCategories:t?t.resultCategories:[],causeId:i});const n={code:t.code,subCode:t.subCode,phrase:t.phrase,resultCategories:t.resultCategories,pickupCode:""};this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,t.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:t.acceptedElsewhereBy.id,displayName:t.acceptedElsewhereBy.displayName}),t.unparkContent&&(t.unparkContent.CallParkAdditionalContext&&(this.parkAdditionalContextJson=JSON.stringify(t.unparkContent.CallParkAdditionalContext),this.serverHoldLocation=t.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),t.unparkContent.pickupCode&&(n.pickupCode=t.unparkContent.pickupCode)),this.onCallStatusChanged(Yr.CALL_STATUS.REMOTE_TERMINATED,i,n),this.dispose(n,i)}else this.logger.info(`[${i}][handleCallEnd] not handling incoming callEnd since fsmstate = SIGNALING_FSM_STATE.IDLE`)}handleConversationResolutionConflict(e,t){this.logger.info(`[${t}][handleConversationResolutionConflict]`);const i={...e,phrase:e.phrase||"Conflict Resolution Error"};if(this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Yr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY)this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.http.cancelRequestIfPending(od.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,t,void 0,i),this.subscribeToCall(e.conversationUrl.Location,e.correlationId,this.lastUsedJoinCallOptions?this.lastUsedJoinCallOptions.clientEndpointCapabilities:0,{meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,additionalEndpointProperties:this.lastUsedJoinCallOptions?.additionalEndpointProperties},t);else{this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const n={meetingData:this.meetingData,meetingPreferences:this.meetingPreferences};if(this.lastUsedJoinCallOptions){const e=this.lastUsedJoinCallOptions.scenario;n.muted=this.lastUsedJoinCallOptions.muted,n.scenario=`409Redirect${e||""}`,n.isPreheatOnly=this.lastUsedJoinCallOptions.isPreheatOnly,n.clientEndpointCapabilities=this.lastUsedJoinCallOptions.clientEndpointCapabilities,n.clientEndpointDebugContent=this.lastUsedJoinCallOptions.clientEndpointDebugContent,n.additionalEndpointProperties=this.lastUsedJoinCallOptions.additionalEndpointProperties}else n.scenario="409RedirectJoin";this.setInitialTelemetry("JoinCall",{correlationId:e.correlationId,causeId:t,conversationServiceUrl:e.conversationUrl.Location,joinCallOptions:n,offerGenerationTime:void 0}),this.http.cancelRequestIfPending(od.JOIN_CONVERSATION.name,t,void 0,i),this.http.cancelRequestIfPending(od.START_CALL.name,t,void 0,i),this.joinGivenConversation(e.conversationUrl.Location,e.correlationId,this.lastUsedOutgoingMediaContent,this.mediaTypesToUse,void 0,n,t)}}handleCallProgress(e){this.telemetryHelper.recordIncomingEvent(Ka,e);const t=Cs(e);this.logger.info(`[${t}][handleCallProgress]`);const i=e.body.callProgress;this.fsmState===Yr.SIGNALING_FSM_STATE.OUTGOING&&(this.telemetryHelper.setTimeToRingDuration(),this.resetCallEstablishmentTimeout(t),this.onCallStatusChanged(Yr.CALL_STATUS.RINGING,t),"forwarded"===i.status&&this.signalingSessionCallback.onCallForwarded({destinationType:i.forwardingDestinationType||"user"},t))}resetCallEstablishmentTimeout(e){this.logger.info("resetCallEstablishmentTimeout"),this.timeoutManager.stopTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.timeoutManager.startTimer(Yr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(e)}),Yr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT)}handleMediaAcknowledgement(e){this.telemetryHelper.recordIncomingEvent(rc,e);const t=e.body,i=Cs(e);this.currentCallStatus!==Yr.CALL_STATUS.CONNECTED?this.telemetryHelper.recordEvent(sc,{causeId:i}):this.mediaRenegotiationManager.handleMediaAcknowledgment(t,i)}handleConversationUpdate(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleConversationUpdate]content=${Ne(t)}`),this.telemetryHelper.recordIncomingEvent(_a,e),this.processConversationServiceResponse(t,i,2)}endBroadcastMeeting(e){this.logger.info(`[${e}][endBroadcastMeeting]`),this.broadcastSession=null}handleLocalParticipantUpdate(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleLocalParticipantUpdate]content=${Ne(t)}`),this.telemetryHelper.recordIncomingEvent(Ea,e),this.processLocalParticipantUpdateResponse(t,i)}handleAddModalityFailure(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAddModalityFailure]`),this.telemetryHelper.recordIncomingEvent(go,e),t.modalityFailure.contentSharing?this.contentSharingManager?.handleAddModalityFailure(t,i):t.modalityFailure.groupChat?this.signalingSessionCallback.onChatModalitySetupFailed({code:t.modalityFailure.groupChat.code,subCode:t.modalityFailure.groupChat.subCode,phrase:t.modalityFailure.groupChat.phrase,resultCategories:t.modalityFailure.groupChat.resultCategories},i):t.modalityFailure.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalityFailure(t,i)}handleAddModalitySuccess(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleAddModalitySuccess]`),this.telemetryHelper.recordIncomingEvent(uo,e),t.modalitySuccess.contentSharing?this.contentSharingManager?.handleAddModalitySuccess(t,i):t.modalitySuccess.groupChat?this.logger.info(`[${i}][handleAddModalitySuccess] group modality ${Ne(t.modalitySuccess.groupChat)}`):t.modalitySuccess.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalitySuccess(t,i)}handleTransferRequested(e){const t=e.body.callTransfer,i=Cs(e);this.logger.info(`[${i}][handleTransferRequested]`),t.parkType?(this.telemetryHelper.recordIncomingEvent(No,e,{type:t.parkType}),this.telemetryHelper.addSharedCorrelationId(t.sharedCorrelationId)):"voicemail"===t.target.endpointType?(this.logger.info(`[${i}][handleTransferRequested] target endpointType = ${t.target.endpointType}`),this.telemetryHelper.recordIncomingEvent(ko,e)):this.telemetryHelper.recordIncomingEvent(ko,e),this.links[Yr.LINKS.TRANSFER_ACCEPTANCE]=t.links.transferAcceptance,this.links[Yr.LINKS.TRANSFER_COMPLETION]=t.links.transferCompletion,this.signalingSessionCallback.onTransferRequested?this.signalingSessionCallback.onTransferRequested(t,i):this.logger.info(`[${i}][handleTransferRequested] failed, no callback defined`)}handleTransferAcceptance(e){const t=Cs(e);this.logger.info(`[${t}][handleTransferAcceptance]`),this.telemetryHelper.recordIncomingEvent(Oc,e),this.signalingSessionCallback.onTransferAccepted?this.signalingSessionCallback.onTransferAccepted(t):this.logger.info(`[${t}][handleTransferAcceptance]failed, no callback defined`)}handleTransferCompletion(e){const t=e.body,i=Cs(e);this.logger.info(`[${i}][handleTransferCompletion]`),t.sharedCorrelationId&&this.telemetryHelper.addSharedCorrelationId(t.sharedCorrelationId),void 0!==t.unparkContent?.pickupCode&&(t.unparkContent.pickupCode=t.unparkContent.pickupCode.toString(),this.telemetryHelper.recordIncomingEvent(Vc,e)),this.signalingSessionCallback.onTransferCompleted?(e.body.transferCompletion&&(0===e.body.transferCompletion.code?this.telemetryHelper.recordIncomingEvent(xc,e):(this.logger.info(`[${i}][handleTransferCompletion]-1-code: ${t.transferCompletion.code}, message: ${Ne(e)}`),this.telemetryHelper.recordIncomingEvent(Oo,e,{code:t.transferCompletion.code,subcode:t.transferCompletion.subCode,resultCategories:t.transferCompletion.resultCategories}))),this.signalingSessionCallback.onTransferCompleted(t,i)):(e.body.transferCompletion&&(e.body.transferCompletion.code===Yr.CALL_END_CODE.NETWORK_ERROR?this.telemetryHelper.recordIncomingEvent(kc,e):this.telemetryHelper.recordIncomingEvent(Oo,e,{code:t.transferCompletion.code,subcode:t.transferCompletion.subCode,resultCategories:t.transferCompletion.resultCategories})),this.logger.info(`[${i}][handleTransferCompletion]failed, no callback defined`))}handleRosterUpdate(e,t){const i=e.body,n=Cs(e);this.disposing||this.disposed?this.logger.info(`[${n}][handleRosterUpdate]failed=ignore call ending or ended`):this.internalHandleRosterUpdate(i,t,n)}handleNewMediaOffer(e){const t=Cs(e);this.telemetryHelper.recordIncomingEvent(lc,e);const i=e.body.mediaOfferReady.mediaContent;this.callUsesMixer=i.fromMixer,this.signalingSessionCallback.onNewOffer({mediaContent:i,renegotiation:!1},t)}internalHandleRosterUpdate(e,t,i){if(e&&"Delta"!==e.type&&"MultiPartyEndpoint"!==e.type)this.logger.warn(`[${i}][internalHandleRosterUpdate] roster.type=${e.type} is invalid`);else{this.logger.info(`[${i}][internalHandleRosterUpdate]`);try{this.participantManager.handleRosterUpdate(e,t,i),this.contentSharingManager?.handleIncomingContentSharingFromRoster(e,t,i)}catch(t){const n={code:Yr.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Yr.CALL_END_SUB_CODE.ROSTER_HANDLING_INVALID_SERVICE_RESPONSE,phrase:t?.toString()};throw this.logger.info(`[${i}][internalHandleRosterUpdate] ${Le(n)}`),this.telemetryHelper.recordRosterEvent(e,Ca,i),n}}}scheduleKeepAlives(e){const t=.9*e*1e3;this.logger.info(`scheduleKeepAlives: every ${t} milliseconds`),this.keepAliveInterval=t,this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval)}scheduleConversationKeepAlive(){if(!this.conversationKeepAliveTimer&&!this.disposed){if(!this.conversationKeepAliveInterval){const e=function(e){const t=Math.floor(11*Math.random())+10;return Math.floor(e*(1-t/100))}(1e3*this.signalingAgentConfig.csaTimeoutConfiguration.conversationKeepAliveTimeoutSec);this.logger.info(`sendConversationKeepAlive: every ${e} milliseconds`),this.conversationKeepAliveInterval=e}this.conversationKeepAliveTimer=window.setInterval(this.sendConversationKeepAlive.bind(this),this.conversationKeepAliveInterval)}}sendConversationKeepAlive(){this.logger.info("sendConversationKeepAlive"),this.disposed?this.logger.info("sendConversationKeepAlive ignored"):(this.logger.info("sendConversationKeepAlive keepAlive count = "+this.conversationKeepAliveCount++),this.sendToUpdateConversationLinks(!0))}sendKeepAlive(){this.logger.info("sendKeepAlive"),this.disposed?this.logger.info("sendKeepAlive ignored"):(this.logger.info("sendKeepAlive keepAlive count = "+this.keepAliveCount++),this.sendToKeepAliveUrl(null))}sendToUpdateConversationLinks(e,t=rs()){if(this.disposed)return;const i=this.logger.createChild(`[${t}][sendToUpdateConversationLinks]`,this.correlationId),n=e?function(e){cs(e,"signalingSession cannot be null");const t={type:"Delta",rosterUpdate:Zr(e,wr.CONV_ROSTER_UPDATE)};return{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},roster:t,links:hs(e,wr)}}}(this):{},r=e?od.UPDATE_CONVERSATION_LINKS.name:od.SEND_CONVERSATION_KEEP_ALIVE.name,s=this.links[Yr.LINKS.NOTIFICATION_LINKS];i.info(`shouldUpdateUrl: ${e}, url: ${s}, payload: ${Ne(n)}`),s&&(this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.http.sendPostRequest({url:s,payload:n,withoutTrouter:!0,requestName:r,causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.recordEvent(hc,{causeId:t}),this.processConversationServiceResponse(e.response,t,2))})).catch((e=>{const i=Ss(e,this.signalingAgentConfig),n=As(i.error.code);this.logger.info(`[${t}][updateConversationLinks] error: ${Ne(i)}, retryable: ${n}`),this.disposed||(this.telemetryHelper.recordEvent(uc,{causeId:t,...i.error}),n?this.scheduleConversationKeepAlive():this.links[Yr.LINKS.NOTIFICATION_LINKS]=null)})))}sendToKeepAliveUrl(e,t=rs()){const i=this.logger.createChild(`[${t}][sendToKeepAliveUrl]`,this.correlationId);i.info(`payload: ${Ne(e)}`),window.clearInterval(this.keepAliveTimer),this.disposed||(this.telemetryHelper.recordEvent(yc),this.http.sendPostRequest({url:this.links[Yr.LINKS.KEEPALIVE],payload:e,requestName:od.SEND_KEEP_ALIVE.name,withoutTrouter:!0,causeId:t}).then((()=>{this.restartKeepAliveInterval()})).catch((e=>{const t=Ss(e,this.signalingAgentConfig);i.info(`error: ${Ne(t)}`),this.restartKeepAliveInterval(!0,t.error)})))}handleCallEstablishmentTimeout(e,t,i){const n={code:Yr.CALL_END_CODE.TIMEOUT,subCode:t||Yr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:i||Yr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT,resultCategories:[Tr]};this.isPromotingToRealtime?this.onPromotionCompleted(!0,n,e):(this.telemetryHelper.recordEvent(za),this.telemetryHelper.setTerminatingData({terminatingEnd:fd.LOCAL,resultValue:Sd.FAILURE,resultDetail:n.phrase,endCode:n.code,endSubCode:n.subCode,causeId:e,resultCategories:n.resultCategories}),this.fsmState=Yr.SIGNALING_FSM_STATE.IDLE,this.onCallStatusChanged(Yr.CALL_STATUS.LOCAL_TERMINATED,e,n),this.dispose(n,e))}handleCallTransferTimeout(e,t){if(this.disposed)return void this.logger.info("Transfer: handleCallTransferTimeout ignored");const i={code:Yr.CALL_END_CODE.TIMEOUT,phrase:Yr.CALL_END_PHRASE.TRANSFER_COMPLETION_TIMEOUT};this.signalingSessionCallback.onTransferCompleted&&(!1===t?this.telemetryHelper.recordEvent(Oo,{code:Yr.CALL_END_CODE.TIMEOUT,subcode:Yr.CALL_END_SUB_CODE.TRANSFER_COMPLETE_TIMEOUT,causeId:e}):!0===t&&this.telemetryHelper.recordEvent(Nc,{causeId:e}),this.signalingSessionCallback.onTransferCompleted({transferCompletion:i},e))}checkCorrelationIdChange(e,t){if(e&&e.headers){const i=e.headers.get(Yr.HEADERS.CORRELATION_ID);if(i&&i.length){const n=[Pr.CONV_CONTENT_SHARING_UPDATE,Pr.CONV_CONTENT_SHARING_END].some((t=>e.url&&us(e.url,t)));this.correlationId===i||n||(this.logger.info(`[${t}]checkCorrelationIdChange:${this.correlationId} => ${i}`),this.telemetryHelper.addChangingCorrelationId(this.correlationId,i),this.updateCorrelationId(i,t))}}}getCommandUrlPresence(){let e=0;return this.links[Yr.LINKS.MUTE]&&(e|=1),this.links[Yr.LINKS.UNMUTE]&&(e|=2),e}getCallNotFoundTransactionEnd(){return{code:Yr.CALL_END_CODE.CALL_DOES_NOT_EXIST,subCode:0,phrase:Yr.CALL_END_PHRASE.CALL_DOES_NOT_EXIST}}getTerminatingCallResultDetail(e,t){return Ne({source:e,...t})}dispose(e,t){this.disposed||(this.logger.info(`[${t}][dispose] end reason ${Ne(e)}`),this.disposed=!0,this.disposing=!1,this.tearDownConnectionCheck(),this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.brokerService&&this.brokerService.dispose(),this.http.cancelAllRequests(t).then((()=>{this.signalingAgent.onCallCompleted(this.sessionId,t),this.signalingAgentConfig.trouterUrlGetter&&this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed.off(this.onTrouterUrlChanged),this.signalingAgentConfig.trouterServiceProvider&&this.signalingAgentConfig.trouterServiceProvider.offStateChanged(this.onTrouterStateChanged),this.timeoutManager.dispose(),this.timeoutManager=null,this.participantManager.dispose(e,t),this.callOperationHandler.dispose("call ended",e,t),this.participantManager=null,this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=null,this.contentSharingManager?.dispose(e,t),this.contentSharingManager=null,this.telemetryHelper.dispose(),this.telemetryHelper=null,this.webRtcSignalingManager.dispose(),this.webRtcSignalingManager=null})))}};var ou=class{constructor(e){this.endpointId=ss(),this.signalingSessions={},this.clientSupportsGenericTokenAPI=!1,this.getNewSignalingSession=(e,t,i,n)=>{const r=rs();cs(e,"selfParticipant should be a non null value"),cs(t,"signalingSessionCallback should be a non null value");const s=i||ss();os(s,"signalingSession id generated cannot be null or empty"),this.checkConfigChange(r);const a=function(e,t,i,n,r,s){return new au(e,t,i,n,r,s)}(e,t,this.signalingAgentConfig,s,this,n),o=a.sessionId;return this.signalingSessions[o]=a,this.logger.info(`[${r}]Created new signalingSession with correlation ID ${s} and session ID ${o}`),a},this.resolvePotentialCallConflict=e=>{const t=rs();let i;if(this.logger.info(`[${t}][resolvePotentialCallConflict]`),!e.multiParty)return Object.keys(this.signalingSessions).forEach((t=>{this.isSessionInConflictingState(this.signalingSessions[t],!e.isIncomingCall)&&(i=e.isIncomingCall?this.compareAndGetConflictingSession(e,this.signalingSessions[t]):this.compareAndGetConflictingSession(this.signalingSessions[t],e))})),i?(this.logger.info("Call conflict done, conflicting session callId=",i.correlationId,"urlIdentifier=",i.urlIdentifier),i.telemetryHelper.recordEvent(Fa),this.signalingAgentConfig.endConflictedCall?(this.endConflictedSession(i,t),i):void 0):void 0},this.handleIncomingNotification=e=>{if(cs(e,"request should be a non null value"),this.logger.info(`handleIncomingNotification to : ${e.url}`),!e.body&&!e.rawBody)return this.logger.error("request has no body"),this.buildNotificationResponse(Yr.HTTP_STATUS_CODES.BAD_REQUEST);let t=Yr.HTTP_STATUS_CODES.OK;const i=function(e){const t=e.match(new RegExp(`/${function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(Yr.URL_BASE.CALLAGENT)}/+([^/]+)`,"i"));return t?t[1]:null}(e.url);if(i){const n=this.signalingSessions.hasOwnProperty(i);if(this.logger.info(`Is session found:${n}`),n){const t=this.signalingSessions[i];if(e.headers=new Xr(e.headers),_s(e.headers))try{if(!Es(e.headers))throw new Error("Unsupported encoding");const t=Ts(e.rawBody),i=JSON.parse(t);e.body=i}catch(e){return t.telemetryHelper.recordEvent(Bo),this.buildNotificationResponse(Yr.HTTP_STATUS_CODES.BAD_REQUEST)}if(t.canHandleIncomingMsgSync(e))return t.handleIncomingMsgSync(e);window.setTimeout((()=>{if(this.signalingSessions.hasOwnProperty(i)){const t=this.signalingSessions[i];t.handleIncomingMsgAsync(e).catch((e=>{t&&t.telemetryHelper&&t.telemetryHelper.recordEvent(Wo),this.logger.error(`handling IncomingMsg failed with error: ${e}`)}))}}),0)}else this.logger.info(`Incoming message for session ID ${i}, but session was not found!`),t=Yr.HTTP_STATUS_CODES.NOT_FOUND}else this.logger.error(`Could not retrieve session ID from Url path. Path = ${e.url}`),t=Yr.HTTP_STATUS_CODES.BAD_REQUEST;const n=this.buildNotificationResponse(t);return this.logger.info(`Result code:${Ne(n)}`),n},this.onCallCompleted=(e,t)=>{this.signalingSessions.hasOwnProperty(e)?(delete this.signalingSessions[e],this.logger.info(`[${t}][onCallCompleted] Session ID ${e} found. Deleted from signalingSession table`)):this.logger.info(`[${t}][onCallCompleted] Session ID ${e} not found. Could not delete from signalingSession table`)},this.applyAuthTokenCacheConfig=e=>{this.signalingAgentConfig.enableTokenCache?(this.authTokenManager.setTokenCaching(!0,e),this.signalingAgentConfig.enableTokenPrefetch&&this.authTokenManager.getToken(e).then((()=>{this.logger.info(`[${e}] token prefetch success`)})).catch((t=>{this.logger.info(`[${e}] token prefetch failure, error=${Ne(t)}`)}))):this.authTokenManager.setTokenCaching(!1,e),this.signalingAgentConfig.enableTokenCacheForGenericTokenAPI?this.authTokenManager.setTokenCachingForGenericTokenAPI(!0,e):this.authTokenManager.setTokenCachingForGenericTokenAPI(!1,e)},this.endConflictedSession=(e,t)=>{this.logger.info("Call conflict, ending signalingSession with callId=",e.correlationId,"urlIdentifier=",e.urlIdentifier),e.endAsync({code:Yr.CALL_END_CODE.CONFLICT,subCode:Yr.CALL_END_SUB_CODE.CONFLICT_IN_NG,phrase:Yr.CALL_END_PHRASE.CONFLICT},{forEveryone:!1,causeId:t})},this.compareAndGetConflictingSession=(e,t)=>{if(!is(e.incomingCallCallerId)||!is(t.participantManager.localParticipant.id))return;const i=ns(e.incomingCallCallerId),n=ns(t.participantManager.getParticipantsToInitiateCallWith().length&&t.participantManager.getParticipantsToInitiateCallWith()[0].id),r=ns(t.participantManager.localParticipant.id);return n===i?r>i?e:t:void 0},this.isSessionInConflictingState=(e,t)=>{if(!e)return this.logger.info("Call conflict, ignore, session already disposed"),!1;const i=[Yr.CALL_STATUS.IDLE,Yr.CALL_STATUS.CONNECTING,Yr.CALL_STATUS.RINGING];return!e.multiParty&&i.indexOf(e.getCallStatus())>-1&&(t&&e.isIncomingCall||!t&&!e.isIncomingCall)},this.buildNotificationResponse=(e,t)=>this.signalingAgentConfig.supportsSynchronousTrouterResponse?{resultCode:e,responseBody:t}:e,Td(e),this.signalingAgentConfig=e,this.logger=e.logger.createChild("SignalingAgent"),cs(e,"signalingAgentConfig should be a non null value"),this.logger.info(e.isWebRtcEnabled?"webRTC enabled":"ORTC enabled");const t={aadTokenExpirationTimeInSeconds:e.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:e.caeTokenExpirationTimeInSeconds,disableTokenMigrationHeader:e.disableTokenMigrationHeader,enablePublishTokenTelemetry:e.enablePublishTokenTelemetry,refreshTimeBeforeTokenTimeoutInSeconds:e.refreshTimeBeforeTokenTimeoutInSeconds,forceClearExpiredTokens:e.forceClearExpiredTokens,enableRefreshToken:e.enableRefreshToken,enableRefreshTokenRetry:e.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:e.enableRefreshTokenRetryInSeconds};this.authTokenManager=wd(this.logger,e.skypeToken,t,e.telemetryManager),this.applyAuthTokenCacheConfig(rs()),Xr.useLowerCaseHeaders=e.forceLowercaseHttpHeaders}updateSignalingAgentConfig(e){const t=rs(),i=JSON.stringify(e,((e,t)=>e?String(t):t));this.logger.info(`[${t}] updateSignalingAgentConfig, SignalingAgentConfig: ${i}`),this.logger.info(`[${t}] ecsEtag=${e.ecsEtag}`),Td(e),this.updatedSignalingAgentConfig=e,this.authTokenManager?.updateTokenSettings({aadTokenExpirationTimeInSeconds:e.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:e.caeTokenExpirationTimeInSeconds,refreshTimeBeforeTokenTimeoutInSeconds:e.refreshTimeBeforeTokenTimeoutInSeconds,disableTokenMigrationHeader:e.disableTokenMigrationHeader,enablePublishTokenTelemetry:e.enablePublishTokenTelemetry,forceClearExpiredTokens:e.forceClearExpiredTokens,enableRefreshToken:e.enableRefreshToken,enableRefreshTokenRetry:e.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:e.enableRefreshTokenRetryInSeconds}),Xr.useLowerCaseHeaders=e.forceLowercaseHttpHeaders}updateUrls(e,t,i){this.logger.info(`updateUrls: conversationServiceUrl: ${e}, uploadLogRequestUrl: ${t}, enforceUrls: ${i}`),this.updatedSignalingAgentConfig=this.updatedSignalingAgentConfig||this.signalingAgentConfig,i||!this.updatedSignalingAgentConfig.isConversationServiceUrlFromEcs?this.updatedSignalingAgentConfig.conversationServiceUrl=e||this.updatedSignalingAgentConfig.conversationServiceUrl:this.updatedSignalingAgentConfig.conversationServiceUrl=this.updatedSignalingAgentConfig.conversationServiceUrl||e,i||!this.updatedSignalingAgentConfig.isUploadLogRequestUrlFromEcs?this.updatedSignalingAgentConfig.uploadLogRequestUrl=t||this.updatedSignalingAgentConfig.uploadLogRequestUrl:this.updatedSignalingAgentConfig.uploadLogRequestUrl=this.updatedSignalingAgentConfig.uploadLogRequestUrl||t}update(e){this.logger.info(`update accountConfiguration ${JSON.stringify(e)}`),e&&e.clientSupportsGenericTokenAPI!==this.clientSupportsGenericTokenAPI&&(this.clientSupportsGenericTokenAPI=e.clientSupportsGenericTokenAPI,this.authTokenManager.updateTokenSettings({clientSupportsGenericTokenAPI:this.clientSupportsGenericTokenAPI})),this.accountConfig=e}sendPushAsync(e,t,i,n,r=rs()){const s=new Pd(this.signalingAgentConfig.piiScrubber),a=`sendPush[local participant mri = ${s.scrubMriOrOmit(e)}][recipientList = ${s.scrubMriOrOmit(t)}][headers = ${i})][causeId = ${r}]`;if(!e?.id)return this.logger.info(`${a} Empty localParticipantId`),Promise.reject("invalid localParticipantId");if(!t||0===t.length||t.every((e=>e&&""===e.id)))return this.logger.info(`${a} Empty recipientList`),Promise.reject("invalid recipientList");if(!i)return this.logger.info(`${a} Empty headers`),Promise.reject("invalid headers");if(!n||null===fs(n))return this.logger.info(`${a} Invalid body.`),Promise.reject("invalid body");const o={...fs(n),To:Array.from(t,(e=>e.id)),From:e.id},c=new Xr(i);c.hasOwnPropertyCaseInsensitive(Yr.HEADERS.CORRELATION_ID)||c.set(Yr.HEADERS.CORRELATION_ID,xi()),c.hasOwnPropertyCaseInsensitive(Yr.HEADERS.MESSAGE_ID)||c.set(Yr.HEADERS.MESSAGE_ID,xi()),c.hasOwnPropertyCaseInsensitive(Yr.HEADERS.PARTICIPANT_ID)||c.set(Yr.HEADERS.PARTICIPANT_ID,xi()),c.hasOwnPropertyCaseInsensitive(Yr.HEADERS.CONTENT_TYPE)||c.set(Yr.HEADERS.CONTENT_TYPE,"application/json"),c.hasOwnPropertyCaseInsensitive(Yr.HEADERS.CLIENT_USER_AGENT)&&c.set(Yr.HEADERS.CLIENT_USER_AGENT,c.get(Yr.HEADERS.CLIENT_USER_AGENT)+"/TsCallingVersion=2024.14.01.41/Ovb=a7c1622acc37a0ab89ed93e9fad06dfff1477239");const l=this.signalingAgentConfig.httpRequestDispatcher.getRequestOptions("POST",c?.getAll(),JSON.stringify(o),3e4);return new Promise(((e,t)=>{this.signalingAgentConfig.httpRequestDispatcher.postAsync(this.signalingAgentConfig.uploadLogRequestUrl||Yr.URL_DEFAULTS.UPLOAD_LOG_URL,l).then((()=>{e()})).catch((e=>{t(e)}))}))}getSignalingSession(e){for(const t of Object.keys(this.signalingSessions)){const i=this.signalingSessions[t];if(i.correlationId===e)return i}return null}updateToken(e,t,i,n,r){this.authTokenManager.updateToken(e,t,i,n,r)}setTokenRequiredCallBack(e){this.authTokenManager.setTokenRequiredCallBack(e)}resetAuthTokenManager(){this.setTokenRequiredCallBack(null),this.authTokenManager.setDisableTimerFlag(!0),this.authTokenManager.dispose()}checkConfigChange(e){this.updatedSignalingAgentConfig&&this.updatedSignalingAgentConfig!==this.signalingAgentConfig&&(this.signalingAgentConfig=this.updatedSignalingAgentConfig,this.updatedSignalingAgentConfig=null,this.applyAuthTokenCacheConfig(e))}},cu=/;aliases=.*$/i,lu="8:";function du(e){return e?e.replace(cu,""):e}function hu(e,t){let i=e;return t&&(i+=";aliases=2:"+t),i}var uu=(e,t)=>t&&void 0!==t.phase&&!!e[t.phase],gu=(e,t)=>t&&void 0!==t.phase&&t.phase===e;function pu(e){const t={},i=e=>{t[e]={status:"Pending"}},n=(e,i)=>{t[e].t=i,delete t[e].status},r=(e,i,n)=>{t[e].status="Failed",t[e].t=i,t[e].reason=Ne(n)};return{execute:async(s,a)=>{const o=e.createChild(`[phase=${s}]`);i(s),o.info("started");const c=(new Date).getTime();try{const e=await a(),t=+new Date-c;return o.logSuccess(`done, time=${t}`),n(s,t),e}catch(e){const i=+new Date-c;throw o.logFailure(`time=${i}, error=${Ne(e)}`),r(s,i,e),{phase:s,error:e,phases:t}}},executeSync:(s,a)=>{const o=e.createChild(`[phase=${s}]`);o.info("started"),i(s);const c=(new Date).getTime();try{const e=a(),t=+new Date-c;return n(s,t),o.logSuccess(`done, time=${t}`),e}catch(e){const i=+new Date-c;throw o.logFailure(`time=${i}, error=${Ne(e)}`),r(s,i,e),{phase:s,error:e,phases:t}}},getTelemetryData:()=>t}}function mu(e,t){return-1!==t.indexOf(e)}var fu,Su,vu,yu={0:[1,2,8,6,10,11,9],1:[2,6,7,10,13],2:[1,3,6,7,9,10,13,14],3:[6,7,4,5,10,13],8:[1,11,10,2,9,6,7],4:[6,7,3,5,10,13],5:[6,7,3,4,10,13],9:[3,6,7,10,13],10:[3,6,7,9,4,5,13,15],13:[3,6,7,4,5],14:[3,6,7,10,13],15:[3,6,7,4,5,13],11:[12,1,2,6,7],12:[2,6,7],6:[7],7:[]};(e=>{let t;var i;let n;var r;let s;var a;let o;var c;(i=t=e.VideoEffectType||(e.VideoEffectType={})).Off="off",i.BackgroundBlur="blur",i.BackgroundReplacement="replacement",(r=n=e.PowerPreference||(e.PowerPreference={})).Default="default",r.HighPerformance="high-performance",r.LowPower="low-power",(a=s=e.ProcessorType||(e.ProcessorType={})).Wasm="Wasm",a.Webgl2="Webgl2",(c=o=e.EffectQualityChangeReason||(e.EffectQualityChangeReason={}))[c.ExternalParam=0]="ExternalParam",c[c.Performance=1]="Performance",c[c.RendererSize=2]="RendererSize"})(fu||(fu={})),(e=>{let t;var i;let n;var r;let s;var a;let o;var c;let l;var d;(i=t=e.CallType||(e.CallType={}))[i.P2P=0]="P2P",i[i.Conference=1]="Conference",i[i.PSTN=2]="PSTN",i[i.BroadcastingConf=3]="BroadcastingConf",(r=n=e.AudioUsageMode||(e.AudioUsageMode={}))[r.Default=0]="Default",r[r.LongRangeSpeaker=1]="LongRangeSpeaker",r[r.Auditorium=2]="Auditorium",(a=s=e.AecPerfProfile||(e.AecPerfProfile={}))[a.Normal=0]="Normal",a[a.Soc=1]="Soc",a[a.Mobile=2]="Mobile",a[a.NoisyTimestamps=3]="NoisyTimestamps",(c=o=e.VqeMode||(e.VqeMode={}))[c.Off=0]="Off",c[c.SkypeNS=1]="SkypeNS",c[c.SkypeAEC=2]="SkypeAEC",c[c.SkypeVQE=3]="SkypeVQE",c[c.DeepNS=4]="DeepNS",c[c.DeepVQE=5]="DeepVQE",(d=l=e.AudioEffectType||(e.AudioEffectType={})).Off="Off",d.NoiseSuppressionDeep="Deep NS",d.NoiseSuppressionClassic="Classic NS",d.EchoCancellationClassic="Classic AEC",d.VoiceQualityEnhancementClassic="Classic VQE",d.VoiceQualityEnhancementDeep="Deep VQE"})(Su||(Su={})),(e=>{let t;var i;let n;var r;(i=t=e.FrameType||(e.FrameType={}))[i.None=0]="None",i[i.Software=1]="Software",i[i.Hardware=2]="Hardware",(r=n=e.LogLevel||(e.LogLevel={}))[r.Default=0]="Default",r[r.Debug=1]="Debug",r[r.Info=2]="Info",r[r.Warning=3]="Warning",r[r.Error=4]="Error"})(vu||(vu={}));var Cu=p,_u=(e=>(e[e.CallStateChanged=0]="CallStateChanged",e[e.TrouterStateChanged=1]="TrouterStateChanged",e[e.MultiPartyModeSet=2]="MultiPartyModeSet",e[e.MediaRetargetSucceeded=3]="MediaRetargetSucceeded",e[e.MediaRetargetFailed=4]="MediaRetargetFailed",e))(_u||{}),Eu=(e=>(e[e.StartModality=0]="StartModality",e[e.StopModality=1]="StopModality",e[e.StreamStateChanged=2]="StreamStateChanged",e[e.NegotiationStateChanged=3]="NegotiationStateChanged",e))(Eu||{}),Tu=(e=>(e[e.SelectSource=0]="SelectSource",e[e.AttachSource=1]="AttachSource",e[e.DetachSource=2]="DetachSource",e))(Tu||{}),Iu=(e=>(e[e.Available=0]="Available",e[e.Subscribe=1]="Subscribe",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribe=3]="Unsubscribe",e[e.Unsubscribed=4]="Unsubscribed",e[e.RenderingStarted=5]="RenderingStarted",e[e.RenderingStopped=6]="RenderingStopped",e))(Iu||{}),bu=class{constructor(e,t){this.value=e,this.piiKind=t}},Au=class{};Au.agentEnvironmentId="agent_environment_id",Au.correlationId="CorrelationId",Au.participantId="participant_id",Au.tenantId="TenantId",Au.userHexCID="UserHexCID",Au.acsResourceId="AcsResourceId",Au.endpointId="endpoint_id",Au.mediaLegId="media_leg_id",Au.webMediaConfigIds="web_media_config_ids",Au.tsCallingVersion="ts_calling_version";var Ru=class{};Ru.diagnostics="MediaDiagnostic",Ru.qoeStats="QoE",Ru.webrtcSession="webrtc_session",Ru.webrtcSessionInitial="webrtc_session_initial",Ru.realtimeTelemetry="realtimetelemetry",Ru.webrtcMediaSession="webrtc_call_session",Ru.mediaSession="pluginless_modality_session",Ru.callSession="pluginless_call_session";var wu=class{constructor(e){this.eventName=e,this.ended=!1,this.events=[]}setLocalUserId(e){this.localUserId=e}start(){this.ended||(this.startTime=Date.now())}end(e=0){this.ended||(this.ended=!0,this.resultCode=e)}asStatsRecord(e={}){if((0,Cu.isEmpty)(this.events))return null;const t=(0,Cu.uniqBy)(this.events,(e=>JSON.stringify(e))).map((e=>{const t={[e.type]:e.timestamp-this.startTime};return(0,Cu.isEmpty)(e.data)||(t.data=e.data),t}));return{name:this.eventName,record:(0,Cu.assign)({LocalUser:this.localUserId,ResultCode:String(this.resultCode),EventTimestampBag:JSON.stringify({eventStart:this.startTime,events:t})},e)}}add(e){!this.ended&&e.type&&((0,Cu.isUndefined)(this.startTime)&&(this.startTime=Date.now()),(0,Cu.isUndefined)(e.timestamp)&&(e.timestamp=Date.now()),this.events.push(e))}},Pu=class e extends wu{constructor(){super(Ru.callSession)}callStateChanged(t){super.add({type:_u[0],data:e.callStateToString[t]||t})}event(e){super.add({type:_u[e]})}};Pu.callStateToString={0:"None",1:"Notified",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",6:"Disconnecting",7:"Disconnected",8:"Observing",10:"Lobby"};var Mu=Pu,Du=class e extends wu{constructor(t,i){super(Ru.mediaSession),this.mediaType=t,this.mediaDirection=i,this.streamDirection=e.mediaDirectionToStream[this.mediaDirection]}addEvent(e,t){super.add({type:e,data:t})}lifecycle(e){this.addEvent(Eu[e])}streamStateChanged(t,i=this.streamDirection){const n=Eu[2];this.addEvent(n,{state:e.streamStateToString[t],direction:e.streamDirectionToString[i]})}negotiationStateChanged(t,i,n=this.streamDirection){const r=Eu[3];this.addEvent(r,{state:e.negotiationStateToString[t],reason:i})}asStatsRecord(t={}){return super.asStatsRecord((0,Cu.assign)({MediaType:e.mediaTypeToString[this.mediaType],Role:e.mediaDirectionToRole[this.mediaDirection]},t))}};Du.negotiationStateToString={started:"NegotiationStarted",rejected:"NegotiationRejected",completed:"NegotiationCompleted"},Du.streamStateToString={created:"StreamCreated",started:"StreamStarted",active:"StreamActive",inactive:"StreamInactive",stopped:"StreamStopped",removed:"StreamRemoved",failed:"StreamFailed",cancelled:"StreamCancelled"},Du.streamDirectionToString={send:"Send",receive:"Receive"},Du.mediaTypeToString={0:"Audio",1:"Video",2:"ScreenShare",3:"Data"},Du.mediaDirectionToRole={1:"Receiver",2:"Sender",4:"Bidirectional"},Du.mediaDirectionToStream={1:"receive",2:"send"};var Ou=Du,ku=class extends Ou{constructor(){super(0,4)}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}},Nu=class extends Ou{constructor(e){super(e,2),this.mediaType=e}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}event(e){super.addEvent(Tu[e])}},Lu=class extends Ou{constructor(e,t){super(e,1),this.mediaType=e,this.remoteParticipantId=t,this.rendererCounter=0}newRendererId(){return this.rendererCounter+=1,String(this.rendererCounter)}event(e,t,i){super.addEvent(Iu[e],(0,Cu.isUndefined)(i)?{rendererId:t}:{rendererId:t,sourceId:i})}asStatsRecord(){return super.asStatsRecord({TargetUser:this.remoteParticipantId})}},xu=class{constructor(){this.allStats=[],this.ended=!1}setLocalUserId(e){this.localUserId=e}get call(){return this.callStats||this.startCall()}get audio(){return this.audioStats||this.newSession(0)}get video(){return this.videoStats||this.newSession(1)}get screenShare(){return this.sharingStats||this.newSession(2)}renderer(e,t){let i=this.renderingStats[t];return i||(i=this.renderingStats[t]=this.receive(e,t)),i}startCall(){return this.callStats?this.callStats:(this.callStats=new Mu,this.callStats.start(),this.addStats(this.callStats))}endCall(e=0){this.ended=!0,this.call.end(e),this.allStats.forEach((e=>e.end())),this.cleanUp()}cleanUp(){this.audioStats&&(this.audioStats.stop(),this.audioStats=null),this.videoStats&&(this.videoStats.stop(),this.videoStats=null),this.sharingStats&&(this.sharingStats.stop(),this.sharingStats=null)}newSession(e){let t;switch(e){case 0:t=this.audioStats=new ku;break;case 1:t=this.videoStats=new Nu(e);break;case 2:t=this.sharingStats=new Nu(e)}return this.addStats(t)}receive(e,t){const i=new Lu(e,t);return i.start(),this.addStats(i)}buildStatsRecords(){return this.allStats.map((e=>e.asStatsRecord())).filter((e=>!!e))}addStats(e){return this.ended||(this.allStats.push(e),e.setLocalUserId(this.localUserId)),e}},Uu=class e{constructor(e){this.configProvider=e,this.localStats=new xu,this.tsCallingVersion="2024.14.01.41"}setCallId(e){this.callId=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setParticipantId(e){this.participantId=e}setEndpointId(e){this.endpointId=e}setMediaLegId(e){this.mediaLegId=e}setMediaStats(e){this.mediaStats=e}setAcsResourceId(e){this.acsResourceId=e}appendDataChannelInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.DataHandlers=e)}appendSharingControlInfo(e){this.mediaStats?.data&&(this.mediaStats.data.SharingControlEnabled=e?"true":"false")}appendMediaControlPaneInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.MediaControlPlane=e)}appendTerminationInfo(e,t){this.mediaStats?.data&&(this.mediaStats.data.TerminatedReason=`${e}`,this.mediaStats.data.TerminatedState=`${t}`)}appendPictureInPictureInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.PictureInPicture=e)}appendCallDeviceManagerInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.CallDeviceManager=e)}buildFromMediaStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,Ru.webrtcSession)]:[]}buildShortBeaconEvent(){const e=this.configProvider?.config?.mediaEventDictionary??Qe.MEDIA_EVENT_FIELDS,t={};t[Au.correlationId]=this.callId||"",t[Au.participantId]=this.participantId||"",t[Au.tenantId]=this.tenantId||"",t[Au.tsCallingVersion]=this.tsCallingVersion||"",t.metrics_TerminationReason_code=new bu(Cn.SUCCESS,0),t.metrics_TerminationReason_subCode=new bu(_n.BEACON,0);const i=this.buildFromDictionary(this.mediaStats.data,e);return[{eventName:Ru.webrtcMediaSession,props:this.buildProps(i,null,t)}]}buildShortCallModalityStats(){const e={};return e[Au.correlationId]=this.callId||"",e[Au.userHexCID]=this.userHexCID||"",e[Au.participantId]=this.participantId||"",e[Au.endpointId]=this.endpointId||"",e[Au.tenantId]=this.tenantId||"",e[Au.tsCallingVersion]=this.tsCallingVersion||"",e[Au.acsResourceId]=this.acsResourceId||"",e.Code=new bu(Cn.SUCCESS,0),e.SubCode=new bu(_n.BEACON,0),[{eventName:"skypecosi_concore_web_csa_conversation_callmodality",props:e}]}buildFromDictionary(e,t){const i={};for(const n in t)e[n]&&(i[n]={},t[n].forEach((t=>{void 0!==e[n][t]&&(i[n][t]=e[n][t])})));return i}buildMediaTelemetry(){if(!this.mediaStats)return;const e=this.buildEvent(this.mediaStats.data,null).props,t={};return Object.keys(e).forEach((i=>{void 0===e[i].piiKind?t[i]=e[i]:t[i]=e[i].value})),t}buildMidCallTelemetry(e){if(!this.mediaStats)return[];const t=this.buildEvent(this.mediaStats.data,Ru.webrtcSession),i=t.props,n=e.reduce(((e,t)=>(i[t]&&(e[t]=i[t]),e)),{});return[{eventName:t.eventName,props:n}]}buildFromCallSetupStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,Ru.webrtcSessionInitial)]:[]}buildFromLocalStats(){return this.localStats.buildStatsRecords().map((e=>this.buildEvent(e.record,e.name)))}buildEvent(t,i){const n={};return n[Au.agentEnvironmentId]=e.agentEnvironmentId,n[Au.correlationId]=this.callId||"",n[Au.tenantId]=this.tenantId||"",n[Au.userHexCID]=this.userHexCID||"",n[Au.participantId]=this.participantId||"",n[Au.endpointId]=this.endpointId||"",n[Au.mediaLegId]=this.mediaLegId||"",n[Au.webMediaConfigIds]=this.webMediaConfigIds||"",n[Au.tsCallingVersion]=this.tsCallingVersion||"",n[Au.acsResourceId]=this.acsResourceId||"",{eventName:i,props:this.buildProps(t,null,n)}}normalizeKey(e){return e.replace(/[^a-zA-Z0-9._]/g,"_")}buildProps(e,t,i){return Object.keys(e).forEach((n=>{const r=this.normalizeKey(n),s=t?`${t}_${r}`:r,a=e[n];if((0,Cu.isString)(a))i[s]=this.getPiiAwareValue(n,a);else if((0,Cu.isArray)(a)){if(a.length>0){const e=a,t=e.map((e=>e.value)).toString();i[s]=new bu(t,e[0].type)}}else if((0,Cu.isObject)(a))if(a.__VALUE__){const e=a;(0,Cu.isBoolean)(e.value)&&(e.value=e.value?"true":"false"),i[s]=new bu(e.value,e.type)}else this.buildProps(a,s,i)})),i}getPiiAwareValue(t,i){return e.piiProps.hasOwnProperty(t)?new bu(i,e.piiProps[t]):i}build(){return(0,Cu.flatten)([this.buildFromMediaStats(),this.buildFromLocalStats()])}};Uu.agentEnvironmentId=xi(),Uu.piiProps={IPAddr:13,MACAddr:13,IPAddress:13,OpaqueData:0,LocalSite:13,RemoteSite:13,BaseAddress:13,LocalAddress:13,RemoteAddress:13,NetworkName:12,LocalUser:10,TargetUser:10};var Fu=Uu,Vu=p;function Bu(e){return e?$u(e.code,e.subCode):0}function Hu(e,t){const i={clientVersion:e.clientVersion,participantId:e.participantId,endpointId:e.endpointId,endpointType:e.endpointType,endpointMetadata:e.endpointMetadata,originalId:e.originalId,capabilities:e.capabilities,clientEndpointCapabilities:e.clientEndpointCapabilities,mappedTo:e.mappedTo,meetingGroupDetails:e.meetingGroupDetails};return e.mediaStreams&&(i.mediaStreams=e.mediaStreams),e.appliedInteractivityLevel&&(i.appliedInteractivityLevel=e.appliedInteractivityLevel),e.deviceType&&(i.deviceType=e.deviceType),e.streamInformation&&32&t&&(i.streamInformation=e.streamInformation),e.propertyBag&&(i.propertyBag=e.propertyBag),i}function $u(e,t=null){if(e===Gn.Success)switch(t){case jn.RemovedFromConversation:case jn.RemovedFromCall:return 44;case jn.DeniedInLobby:return 55;case jn.TimedOutInLobby:return 56;default:return 1}if(null!==t&&t>=2e5&&t<=299999){const e=t-2e5;return Wn[e]?Wn[e]:0}return null!==t&&t>=4e5&&t<=499999?zn[e]?zn[e]:43:e===Gn.Forbidden?t===jn.UserBlocked?64:t===jn.PolicyRestriction?62:t===jn.AnonymousJoinDisabledByPolicy?66:t===jn.NoLobbyForBroadcastJoin?67:t===jn.NotAllowedDueToInformationBarrier?68:t===jn.TeamParkPolicyDisabled?70:t===jn.B2bJoinDisabledByPolicy?71:t===Gn.Success?8:7:e===Gn.PreconditionFailed&&t===jn.InsufficientCapabilities?63:e===Gn.ServiceUnavailable?t===jn.BroadcastLimitReached?69:48:e===Gn.InternalServerError?7:e===Gn.ConfParticipantCountLimitReached?t===jn.MaxLobbyParticipantLimitReached?73:59:qn[e]?qn[e]:e}function Gu(e){if(1===e)return Gn.Success;const t=Object.keys(qn).filter((t=>qn[t]===e));if(t.length>=1)for(const i of t){const t=parseInt(i);if(t&&qn[t]===e)return t}return Gn.UnknownError}function ju(e,t){if(void 0!==t&&3!==t&&1!==t)return{mediaType:e,isDisabled:0===t,label:Dd(e)}}function qu(e){if(e.sendMediaModalities)return e;const t={mediaStates:[]};let i=ju(0,e.audioDirection?e.audioDirection:4);return i&&t.mediaStates.push(i),i=ju(1,e.withVideo?4:e.videoDirection),i&&t.mediaStates.push(i),i=ju(2,e.screenshareDirection?e.screenshareDirection:1),i&&t.mediaStates.push(i),e.sendMediaModalities=t,e}function Wu(e){const t=function(e){if("mri"===e)return"mri";throw"Unknown RedirectionTargetIdType"}(e.type),i=function(e){switch(e){case"voicemail":return"voicemail";case"default":return"default";default:throw"Unknown RedirectionEndpointType"}}(e.endpointType);return{type:t,id:e.id,endpointType:i}}var zu=class{constructor(e){this.mediaStateConfiguration=e}isDisabled(e){if(this.mediaStateConfiguration?.mediaStates){const t=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));return!!t&&!!t.isDisabled}return!1}isInactiveOrDisabled(e){if(this.mediaStateConfiguration?.mediaStates){const t=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));return!t||!!t.isDisabled}return!1}isSending(e){return!!this.mediaStateConfiguration?.mediaStates&&!!this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e&&!t.isDisabled))}disableModality(e){this.setModality(e,!0)}enableModality(e){this.setModality(e,!1)}removeModality(e){this.mediaStateConfiguration?.mediaStates&&(0,Vu.remove)(this.mediaStateConfiguration.mediaStates,(t=>t.mediaType===e))}setCallAcceptOptions(e){const t=this.isDisabled(1),i=this.isDisabled(2),n=this.isSending(3);if(e.sendMediaModalities)this.mediaStateConfiguration=e.sendMediaModalities;else{void 0===e.answerMediaType&&(e.answerMediaType=e.withVideo?1:0);const t={mediaStates:[]};switch(e.answerMediaType){case 0:t.mediaStates.push(ju(0,4));break;case 1:t.mediaStates.push(ju(0,4)),t.mediaStates.push(ju(1,4));break;case 2:t.mediaStates.push(ju(1,0))}this.mediaStateConfiguration=t}t&&this.setModality(1,!0),i&&this.setModality(2,!0),n&&this.setModality(3,!1),e.sendMediaModalities=this.mediaStateConfiguration}setModality(e,t){if(this.mediaStateConfiguration?.mediaStates){const i=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));i?i.isDisabled=t:this.mediaStateConfiguration.mediaStates.push({mediaType:e,isDisabled:t,label:Dd(e)})}}};function Ju(e){return e||!1===e||""===e||0===e}function Ku(e){switch(e){case 0:return"Audio";case 1:return"Video";case 2:return"ScreenShare"}throw new Error("MediaType required")}var Yu=class{constructor(){this.stateInt=0,this.promiseInt=new Promise(((e,t)=>{this.resolveInt=e,this.rejectInt=t}))}get state(){return this.stateInt}get resolve(){return e=>{this.stateInt=2,this.resolveInt(e)}}get reject(){return e=>{this.stateInt=1,this.rejectInt(e)}}get promise(){return this.promiseInt}get isPending(){return 0===this.stateInt}},Qu=class{constructor(e){this.mcpConfig=e,this.data={sourceRequestsSignaling:{},sourceRequestsMCP:{},fallback:!1,sourceRequestsResponses:{},errors:[]}}setRecord(e,t,i){const n={sequenceNumber:t,timestamp:Date.now(),sourceId:i?.sourceId,fmtp:i?.fmtParams};e.records??(e.records=[]),Tt(e.records,n,this.mcpConfig.storedSRRecordsCount)}recordSignalingOperation(e,t){var i;(i=this.data.sourceRequestsSignaling)[e]??(i[e]={counter:0}),this.data.sourceRequestsSignaling[e].counter++,this.mcpConfig.verboseTelemetry&&this.mcpConfig.sendDuplicates&&"ApplyChannelParametersSourceRequest"===e&&this.setRecord(this.data.sourceRequestsSignaling[e],t)}recordMCPOperation(e,t,i){var n;(n=this.data.sourceRequestsMCP)[e]??(n[e]={counter:0}),this.data.sourceRequestsMCP[e].counter++,this.mcpConfig.verboseTelemetry&&this.setRecord(this.data.sourceRequestsMCP[e],t,i)}recordError(e,t){const i=[Date.now(),t,e];Tt(this.data.errors,i,this.mcpConfig.storedSRRecordsCount)}recordFallback(){this.data.fallback=!0}recordSignalingOperationDuration(e,t){const i=this.data.sourceRequestsSignaling[e]?.records?.find((e=>e.sequenceNumber===t));i&&(i.duration=Date.now()-i.timestamp)}recordSrResultReceived(e,t,i){var n;if(this.mcpConfig.verboseTelemetry){const n=this.data.sourceRequestsMCP[i]?.records?.find((e=>e.sequenceNumber===t));n&&(n.duration=Date.now()-n.timestamp,n.result=e)}(n=this.data.sourceRequestsResponses)[e]??(n[e]=0),this.data.sourceRequestsResponses[e]++}getObjectRef(){return this.data}},Xu=class{constructor(e){this.mcpConfig=e,this.storage={createTime:Date.now(),startedCount:0,stoppedCount:0,clientCapabilities:[],events:[]},this.sourceRequestSenderDiagnostics=new Qu(this.mcpConfig)}get getSourceRequestSenderDiagnostics(){return this.sourceRequestSenderDiagnostics}logStarted(){if(this.storage.startedCount++,this.storage.startedCount>5)return;const e={startedTs:Zu(this.storage.createTime),mpCapabilities:{},sentMessages:{},recvMessages:{},sentFailed:0,recvFailed:0,cachedDshReceived:!1};this.storage.events.push(e),this.lastEventConnecting=!0}logStopped(){this.storage.stoppedCount++;const e=this.getCurrentDCSessionEvent();e&&(e.stoppedTs=Zu(this.storage.createTime)),this.lastEventConnecting=!1}logSentMsg(e){var t,i;const n=this.getCurrentDCSessionEvent();n&&((t=n.sentMessages)[i=e.type]??(t[i]=0),n.sentMessages[e.type]++)}logReceivedMsg(e){var t,i;this.lastEventConnecting=!1;const n=this.getCurrentDCSessionEvent();n&&((t=n.recvMessages)[i=e.type]??(t[i]=0),n.recvMessages[e.type]++,"dsh"!==e.type||n.handshakeDuration||(n.cachedDshReceived=!0))}logHandshakeStarted(e){const t=this.getCurrentDCSessionEvent();t&&(t.handshakeStartedTs=Date.now()),this.storage.clientCapabilities=e}logHandshakeCompleted(e){const t=this.getCurrentDCSessionEvent();t&&(t.handshakeDuration||(t.handshakeDuration=Zu(t.handshakeStartedTs)),t.mpCapabilities.send=e.send_capabilities,t.mpCapabilities.recv=e.receive_capabilities)}logSentFailed(e){const t=this.getCurrentDCSessionEvent();t&&(t.sentFailed++,t.lastSentFailed={ts:Zu(this.storage.createTime),error:e})}logRecvFailed(e){const t=this.getCurrentDCSessionEvent();t&&(t.recvFailed++,t.lastRecvFailed={ts:Zu(this.storage.createTime),error:e})}logTimeout(){if(this.storage.startedCount>=5&&!this.lastEventConnecting)return;const e={timeoutTs:Date.now()},t=this.getCurrentDCSessionEvent();t&&(e.handshakeStartedTs=t.handshakeStartedTs),this.lastEventConnecting&&this.storage.events.pop(),this.storage.events.push(e),this.lastEventConnecting=!1}getReport(){const e=this.sourceRequestSenderDiagnostics.getObjectRef();return this.storage.sourceRequestsReport=e,this.storage}getCurrentDCSessionEvent(){const e=this.storage.events[this.storage.events.length-1];return this.storage.startedCount<=5&&void 0!==e?.startedTs?e:null}};function Zu(e){return Date.now()-e}var eg=class extends We{constructor(e,t,i){super(),this.dcAdapter=e,this.logger=t,this.mcpConfig=i,this.dcSend=null,this.handshakePromise=new Yu,this.isStarted=!1,this.isActive=!1,this.handshakeTimeout=null,this.telemetryLogger=new Xu(this.mcpConfig),this.mcpSupportedFeautres={sourceRequestsEnabled:!1,sourceRequestsResponseEnabled:!1,sendDuplicates:this.mcpConfig?.sendDuplicates}}getTelemetryLogger(){return this.telemetryLogger}mcpFeaturesSupported(e){return this.mcpSupportedFeautres[e]}switchMcpFeauture(e,t){this.logger.warn(`Switching ${e} to ${t}`),this.mcpSupportedFeautres[e]=t}getConfig(){return this.mcpConfig}dispose(){super.dispose(),this.isStarted&&this.dcAdapter.removeHandler(18),this.handshakePromise.promise.catch((()=>{})),this.handshakePromise.reject("MediaControlPlane disposed"),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1),this.dcSend=null}getTelemetryReport(){return this.logger.debug(`Telemetry ${JSON.stringify(this.telemetryLogger.getReport())}`),this.telemetryLogger.getReport()}async sendMsg(e){return await this.handshakePromise.promise,this.sendMsgInternal(e)}start(){if(this.isStarted||!this.mcpConfig)return;this.isStarted=!0;const e={onStarted:async(e,t)=>{this.logger.info(`Data channel handler is started ${e}`),this.telemetryLogger.logStarted(),this.dcSend=t,await this.startHandshake()},onStopped:async e=>{this.logger.info(`Data channel handler is stopped ${e}`),this.telemetryLogger.logStopped(),this.dcSend=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1)},onDataReceived:async(e,t)=>{this.processIncomingData(t)}};this.dcAdapter.addHandler(18,e)}onTransportConnected(){this.isStarted&&this.mcpConfig.handshakeTimeout&&!this.isActive&&(this.handshakeTimeout&&clearTimeout(this.handshakeTimeout),this.handshakeTimeout=window.setTimeout((()=>{this.handshakeTimeout=null,this.telemetryLogger.logTimeout(),this.logger.warn(`Timeout after ${this.mcpConfig.handshakeTimeout}ms, raising onHandshakeTimeout`),this.event("onHandshakeTimeout").raise()}),this.mcpConfig.handshakeTimeout))}async startHandshake(){this.handshakePromise.isPending||(this.handshakePromise=new Yu),this.isActive=!1;try{const e=[];this.mcpConfig.enableDominantSpeakerHistory&&e.push("dsh"),this.mcpConfig.enableBweNotifications&&e.push("bwe"),this.mcpConfig.enableSourceRequests&&e.push("sr"),this.telemetryLogger.logHandshakeStarted(e),this.logger.info(`Send syn, client capabilities: ${JSON.stringify(e)}`),await this.sendMsgInternal({type:"syn",client_capabilities:e})}catch(e){this.handshakePromise.reject(e)}}async sendMsgInternal(e){const t=Array.isArray(e)?e:[e],i=(new TextEncoder).encode(JSON.stringify(t)),n=new Uint8Array(1+i.length);n[0]=1,n.set(i,1);try{await this.dcSend(n,[4294967292]);for(const e of t)this.telemetryLogger.logSentMsg(e)}catch(e){throw this.logger.error(`Send failed: ${Ve(e)}`),this.telemetryLogger.logSentFailed(Ve(e)),e}}processIncomingData(e){if(1!==e[0]){const t=`Unsupported header version ${e[0]}`;return this.logger.info(t),void this.telemetryLogger.logRecvFailed(t)}const t=new DataView(e.buffer,1);let i;try{const e=(new TextDecoder).decode(t);i=JSON.parse(e)}catch(e){return this.logger.error(`Failed to parse received data, error ${Ve(e)}`),void this.telemetryLogger.logRecvFailed(Ve(e))}for(const e of i)switch(this.telemetryLogger.logReceivedMsg(e),e.type){case"syn":break;case"ack":this.processAckMsg(e);break;case"bwe":this.processBweMsg(e);break;case"dsh":this.processDshMsg(e);break;case"sr_res":this.processSrResMsg(e);break;default:{const t=`Unsupported msg type ${e.type}`;this.logger.error(t),this.telemetryLogger.logRecvFailed(t)}}}processDshMsg(e){this.mcpConfig.enableDominantSpeakerHistory&&(this.logger.debug(`DSH received: ${JSON.stringify(e)}`),this.event("mpDshChanged").raise(e.history))}processSrResMsg(e){this.mcpConfig.enableSourceRequests&&(this.logger.debug(`SR_RES received: ${JSON.stringify(e)}`),this.event("mpSrResReceived").raise(e.sequenceNumber,e.result))}processBweMsg(e){this.mcpConfig.enableBweNotifications&&this.event("mpSendBandwidthChanged").raise(e.bw)}processAckMsg(e){this.telemetryLogger.logHandshakeCompleted(e),this.logger.info(`Ack received: ${JSON.stringify(e)}`);const t=!(!this.mcpConfig.enableDominantSpeakerHistory||!e.send_capabilities?.includes("dsh"));this.switchMcpFeauture("sourceRequestsEnabled",!(!this.mcpConfig.enableSourceRequests||!e.receive_capabilities?.includes("sr"))),this.switchMcpFeauture("sourceRequestsResponseEnabled",!(!this.mcpConfig.enableSourceRequests||!e.send_capabilities?.includes("sr_res"))),this.logger.info(`raising mpDshStatusChanged ${t}`),this.event("mpDshStatusChanged").raise(t),this.handshakePromise.resolve(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!0}},tg="NegotiationCompleted",ig={OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"InitialAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"InitialAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",ANSWER_GENERATION_STARTED:"InitialAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"InitialAnswerGenerationEnded"},ng={OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"},rg=class{constructor(e,t,i){this.mediaSession=e,this.signalingSession=t,this.sourceRequestSender=i,this.operationNames=ig,this.configureModalitiesAsync=this.mediaSession.configureModalitiesAsync.bind(this.mediaSession),this.getAllowedModalities=this.mediaSession.getAllowedModalities.bind(this.mediaSession),this.rejectNegotiationAsync=this.mediaSession.rejectNegotiationAsync.bind(this.mediaSession),this.createRemoteRenderer=this.mediaSession.createRemoteRenderer.bind(this.mediaSession),this.getStatsAsync=this.mediaSession.getStatsAsync.bind(this.mediaSession),this.getLastKnownStats=this.mediaSession.getLastKnownStats.bind(this.mediaSession),this.getCallTechnicalInfo=this.mediaSession.getCallTechnicalInfo.bind(this.mediaSession),this.muteHold=this.mediaSession.muteHold.bind(this.mediaSession),this.muteInputAsync=this.mediaSession.muteInputAsync.bind(this.mediaSession),this.unmuteInputAsync=this.mediaSession.unmuteInputAsync.bind(this.mediaSession),this.muteOutputAsync=this.mediaSession.muteOutputAsync.bind(this.mediaSession),this.unmuteOutputAsync=this.mediaSession.unmuteOutputAsync.bind(this.mediaSession),this.terminate=this.mediaSession.terminate.bind(this.mediaSession),this.createAudioElement=this.mediaSession.createAudioElement.bind(this.mediaSession),this.getSessionConfig=this.mediaSession.getSessionConfig.bind(this.mediaSession),this.getDiagnostics=this.mediaSession.getDiagnostics.bind(this.mediaSession),this.getIncomingRawAudioStream=this.mediaSession.getIncomingRawAudioStream.bind(this.mediaSession),this.getUnmixedAudioProvider=this.mediaSession.getUnmixedAudioProvider.bind(this.mediaSession),this.useNullAudioStreamClient=this.mediaSession.useNullAudioStreamClient.bind(this.mediaSession),this.getSubscriptionManager=this.mediaSession.getSubscriptionManager.bind(this.mediaSession),this.configureSpatialAudio=this.mediaSession.configureSpatialAudio.bind(this.mediaSession),this.setParticipantSpatialAudioPositions=this.mediaSession.setParticipantSpatialAudioPositions.bind(this.mediaSession),this.setCallConstraints=this.mediaSession.setCallConstraints.bind(this.mediaSession),this.startMediaDescriptionsUpdateAsync=this.mediaSession.startMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.completeMediaDescriptionsUpdateAsync=this.mediaSession.completeMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.rejectMediaDescriptionsUpdateAsync=this.mediaSession.rejectMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.getExtensionsManager()?.configureExtension("videoStreamControl",{sender:this.sourceRequestSender})}enableTeamsRealTimeTelemetry(){this.mediaSession.enableTeamsRealTimeTelemetry()}getMediaStatsReport(){return this.mediaSession.getMediaStatsReport()}processOfferAsync(e,t){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_STARTED),this.mediaSession.processOfferAsync(e,t).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_ENDED),e)))}createAnswerAsync(e,t){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_STARTED),this.mediaSession.createAnswerAsync(e,t).then((t=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_ENDED),e||(this.operationNames=ng),t)))}createOfferAsync(e){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_STARTED),this.mediaSession.createOfferAsync(e).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_ENDED),e)))}processAnswerAsync(e,t,i,n=!1){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_STARTED),this.mediaSession.processAnswerAsync(e,t,i,n).then((()=>{this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_ENDED),this.operationNames=ng}))}completeNegotiationAsync(e){return this.mediaSession.completeNegotiationAsync(e).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(tg),e)))}sendDtmf(e){return this.mediaSession.sendDtmf?this.mediaSession.sendDtmf(e):Promise.reject("Not Implemented")}getExtensionsManager(){return this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null}reconnectAsync(e,t=!1){return this.mediaSession.reconnectAsync(e,t)}completeEscalationAsync(e){return this.mediaSession.completeEscalationAsync(e)}rejectEscalationAsync(e,t){return this.mediaSession.rejectEscalationAsync(e,t)}getAcceptedTypes(){return this.mediaSession.getAcceptedTypes()}getLocalMediaTrackId(e){return this.mediaSession.getLocalMediaTrackId?this.mediaSession.getLocalMediaTrackId(e):null}processNotification(e,t){this.mediaSession.processNotification(e,t)}};function sg(e,t,i){if(void 0===t?.serverMuteVersion||void 0===i?.serverMuteVersion||i.serverMuteVersion>=t.serverMuteVersion)return;const n=i&&i.mediaStreams,r=n&&n.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type)),s=t&&t.mediaStreams,a=s&&s.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type));r&&r.length&&(i.serverMuteVersion=t.serverMuteVersion,r[0].serverMuted=a[0].serverMuted,e.info(`handleServerMutedVersion: patching server muted state in audio streams updated:${JSON.stringify(r[0])} as we encountered stale muteServerVersion. Updated to ${t.serverMuteVersion}`))}function ag(e,t,i,n){if("success"!==i.reason||void 0===t||i.serverMuteVersion<=t.serverMuteVersion)return e.info(`handleMuteUnmuteParticipantInfo: ignoring updating since we encountered invalid state: ${i.reason} serverMuteVersion: ${i.serverMuteVersion}`),!1;const r=t&&t.mediaStreams,s=r&&r.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type));return!!s&&(s[0].serverMuted=n,t.serverMuteVersion=i.serverMuteVersion,e.info(`handleMuteUnmuteParticipantInfo: updating since we encountered valid state serverMuteVersion: ${i.serverMuteVersion} to: ${n} streams: ${s[0].sourceId}`),!0)}var og=g;function cg(e,t,i,n){i?.forEach((i=>{e[i]&&(t[i]=n(e[i]))}))}function lg(e){return`id=${og.pii.Mri(e.id)}, participantId=${e.participantId}`}function dg(e){return function(e,t,i,n){const r=JSON.stringify(e),s=JSON.parse(r);return s&&(cg(e,s,t,og.pii.Omit),cg(e,s,i,og.pii.Mri),cg(e,s,n,og.pii.UserName)),JSON.stringify(s)}(e,[],["transferorMri","targetMri"])}var hg=p,ug=i.setImmediate?e=>{i.setImmediate(e)}:e=>{(0,hg.defer)(e)},gg=class e{constructor(){this.deferredOperations=new Map,this.deferredOperationsNames=[],this.isRunning=!1}setLogger(e){this._logger=e.createChild("[DeferHandler]")}setDeferToQueueMicrotask(t){t&&i.queueMicrotask?e.defer=e=>i.queueMicrotask(e):e.defer=ug}createDeferRunner(e){const t={};return i=>this.runDeferred(t,i,e)}runDeferredWithoutDedup(e,t){this.runDeferred({},e,t)}runDeferred(t,i,n){this.deferredOperations.has(t)||(this.deferredOperations.set(t,i),n&&this.deferredOperationsNames.push(" "+n),this.isRunning||(this.isRunning=!0,this._startDeferalTime=Date.now(),this.causeId=Te(),this._logger?.info(`[${this.causeId}]Deferring operations`),e.defer((()=>{this._timeToRun=Date.now()-this._startDeferalTime,this.deferredOperations.forEach((t=>{e.runWithTryCatch(t)})),this.deferredOperations.clear(),this.isRunning=!1,this._logger?.info(`[${this.causeId}]Deferred operations ran after ${this._timeToRun}ms | Completed after ${Date.now()-this._startDeferalTime}ms | Operations:${this.deferredOperationsNames}`),this.deferredOperationsNames=[]}))))}static runWithTryCatch(e){try{e&&e()}catch(e){}}};gg.defer=ug;var pg=gg,mg=class{};mg.instance=new pg;var fg=p,Sg="sendonly",vg="recvonly",yg="sendrecv",Cg="audio",_g="video",Eg="applicationsharing-video",Tg="audio-teleconferencing",Ig=class extends We{constructor(e,t,i){super(t),this.mediaSession=e,this.isAvailable=!1,this.mediaSessionInitPromise=new Yu,this.currentIsStreaming=!1,e&&this.mediaSessionInitPromise.resolve(),this.id=i,this.logger=t.createChild(`Stream[${this.id}]`)}set isStreaming(e){this.currentIsStreaming=e,this.logger.info(`isStreaming has changed to ${this.currentIsStreaming}`),this.raiseChanged()}get isStreaming(){return this.currentIsStreaming}update({sourceId:e=null,direction:t=vg,participantId:i=null,endpointId:n=null}={},r){this.logger.info(`[${r}][update before]  sourceId=${e}, direction=${t}, participantId=${i}, endpointId=${xe(n)}`),this.id=e,this.isAvailable=t===yg||t===Sg,this.mediaSession?.getSessionConfig().config.streamAvailabilityConsiderModalities&&this.getIsModalityDisabled()&&(this.logger.info(`Disabling current modality, disabled: ${JSON.stringify(this.mediaSession?.getDisabledModalities?.()||"")}`),this.isAvailable=!1),this.participantId=i,this.endpointId=n,this.logger.info(`[${r}][update after]  sourceId=${e}, direction=${t}, participantId=${i}, endpointId=${xe(n)}`),this.raiseChanged()}setMediaSession(e,t){const i=e?.getAllowedModalities?.()||{};this.logger.info(`[${t}][setMediaSession] ${JSON.stringify(i)}`),this.mediaSession=e,e?this.mediaSessionInitPromise.resolve():this.mediaSessionInitPromise.reject(new Error("MediaSession is null"))}isActive(){return this.isAvailable&&this.isStreaming}getIsModalityDisabled(){return!1}},bg=class extends Ig{},Ag=p,Rg=class extends Ig{constructor(e,t,i,n,r,s){super(void 0,e,t),this.configProvider=i,this.streamOptions=n,this.telemetryLogger=r,this.callInfo=s,this.type=2,this.finalTelemetrySent=!1,this.player=new Ki(e.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger),this.isAvailable=!0}getStreamOptions(){return this.streamOptions}getDiagnosticData(){return JSON.stringify({id:this.id,type:this.type,rank:this.rank,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const e=this.player.getSnapshotTelemetryReport(),t={isAvailable:this.isAvailable,isStreaming:this.isStreaming,...e};return(0,Ag.isEqual)(this.lastStreamStats,t)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=t),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,rank:this.rank,...this.lastStreamStats}}stop(){return Promise.resolve(void 0)}async start(e){if(this.logger.info("[start]: Starting UMS stream"),!this.renderer){if(await this.player.configure(this.streamOptions),!(await this.player.loadPlayer(e)).setupSucceeded)return this.player.stop(),this.logger.error("[start]: Failed to load UMS player"),Promise.reject("Failed to load UMS player");this.renderer=this.player.getRenderer()}return this.isStreaming=!0,this.renderer}sendSnapshotTelemetry(){const e=this.player.getSnapshotTelemetryReport();this.logger.debug(`[sendSnapshotTelemetry] sending snapshot telemetry report: ${JSON.stringify(e)}`);const t={...this.callInfo,...e};this.telemetryLogger.sendEvent({eventName:"live_events",props:t})}sendTelemetry(e){if(this.finalTelemetrySent)return;e&&(this.finalTelemetrySent=!0);const t=this.player.getTelemetryReport();this.logger.debug(`[sendTelemetry] sending telemetry report: ${JSON.stringify(t)}`);const i={...this.callInfo,...t};this.telemetryLogger.sendEvent({eventName:"live_events",props:i})}};var wg=class extends We{constructor(){super(...arguments),this.isRendering=!1,this.frameType=-1}get rendererType(){return 0}captureFrame(){if(this.renderer.captureFrame)return this.renderer.captureFrame();throw new Error("Not implemented yet")}async getStats(){if(this.renderer.getStats)return this.renderer.getStats();throw new Error("Renderer does not support stats")}async setScalingMode(e){this.renderer.setScalingMode(function(e){switch(e){case 1:return"crop";case 0:return"stretch";default:return"fit"}}(e))}async cameraAutoControl(e){throw new Error("Not implemented")}async getCameraManualControlStates(e){throw new Error("Not implemented")}async setCameraManualControlStates(e){throw new Error("Not implemented")}async enumerateCameraManualControls(){throw new Error("Not implemented")}onVideoSizeChanged(e,t){this.streamSize={width:e,height:t},this.event("videoSizeChanged").raise(e,t),this.raiseChanged()}},Pg=class extends wg{constructor(e,t){super(),this.renderer=t.createPreviewRenderer(e),this.renderer.on("onVideoSizeChanged",((e,t)=>this.onVideoSizeChanged(e,t)))}onVideoSizeChanged(e,t){this.isRendering=e>0&&t>0,super.onVideoSizeChanged(e,t)}setVideoMirroring(e){this.renderer.setVideoMirroring(e)}startVideoAsync(){return this.renderer.startVideoAsync()}dispose(){this.renderer&&(this.renderer.dispose(),this.renderer=null)}},Mg=class extends wg{constructor(e,t,i,n,r){super(),this.logger=e,this.target=t,this.rendererStats=n,this.configProvider=r,this.subscriptionActive=!1,this.firstFrameRendered=!1,this.rendererId=n.newRendererId(),this.renderer=i.createRemoteRenderer(t),this.renderer.on("onVideoSizeChanged",((e,t)=>this.onVideoSizeChanged(e,t))),this.renderer.on("onVideoStateChanged",(e=>this.onVideoStateChanged(e))),this.renderer.on("onIsRenderingChanged",(e=>this.onIsRenderingChanged(e)))}toString(){return`rvr:${this.rendererId}`}onVideoStateChanged(e){this.rendererStats.streamStateChanged(e.stream)}onVideoSizeChanged(e,t){this.configProvider.config.videoIsRenderingCheck&&this.setIsRendering(e>0&&t>0),super.onVideoSizeChanged(e,t)}setIsRendering(e){this.isRendering!==e&&(this.isRendering=e,this.logger.info(`isRendering has changed to ${this.isRendering}`),this.rendererStats.event(this.isRendering?5:6,this.rendererId),this.isRendering&&!this.firstFrameRendered&&(this.firstFrameRendered=!0,this.event("firstFrameRendered").raise()))}onIsRenderingChanged(e){this.setIsRendering(e),this.raiseChanged()}subscribeVideoAsync(e){this.currentVideoStream=e,this.rendererStats.event(1,this.rendererId,e.id);const t=this.renderer.subscribeVideoAsync(e.id,1===e.type);return this.subscriptionActive=!0,t.then((()=>{this.rendererStats.event(2,this.rendererId,e.id),this.watchStream(e)})),t}watchStream(e){this.changeSub&&this.changeSub.dispose(),this.changeSub=e.changed((()=>{e.isAvailable?this.subscriptionActive||this.subscribeVideoAsync(e):(this.subscriptionActive=!1,this.rendererStats.event(3,this.rendererId),this.renderer.unsubscribeNow(),this.rendererStats.event(4,this.rendererId))}))}dispose(){this.renderer&&(this.subscriptionActive&&(this.rendererStats.event(3,this.rendererId),this.currentVideoStream&&!this.currentVideoStream.isAvailable&&this.renderer.unsubscribeNow()),this.renderer.dispose(),this.subscriptionActive&&this.rendererStats.event(4,this.rendererId),this.renderer=null,this.currentVideoStream=null),this.changeSub&&(this.changeSub.dispose(),this.changeSub=null)}},Dg=class extends We{constructor(e,t,i,n=Te()){super(i),this.getRawStream=e,this.disposeStream=t,this.logger=i,this.causeId=n,this.isClientDisposed=!1,this.clientId=dt()}get isDisposed(){return this.isClientDisposed}notifyStreamChange(){this.logger.info(`Raw stream changed, causeId=${this.causeId}`),this.raiseChanged(),this.event("notifiedOnStreamChanged").raise(this.clientId)}async getMediaStream(){return this.checkDisposed(),this.logger.info(`Raw stream requested, causeId=${this.causeId}`),this.event("rawStreamRequested").raise(this.clientId),this.getRawStream()}dispose(){this.checkDisposed(),this.disposeStream?.(),this.isClientDisposed=!0,this.event("clientDisposed").raise(this.clientId),super.dispose(),this.logger.info(`Raw stream client disposed, causeId=${this.causeId}`)}checkDisposed(){if(this.isClientDisposed)throw new Error("Raw stream client is already disposed")}},Og=class{constructor(e,t,i){this.stream=e,this.rawBaseClient=new Dg((async()=>this.stream),(()=>this.dispose()),t,i)}client(){return this.rawBaseClient}updateAndNotifyClient(e){this.rawBaseClient&&(this.stream=e,this.rawBaseClient.notifyStreamChange())}dispose(){this.rawBaseClient=null,this.stream=null}},kg=class{constructor(e,t,i,n){this.videoStream=e,this.subscriptionManager=t,this.logger=i,this.causeId=n,this.modality=0===e.type?Qe.MODALITY.video:Qe.MODALITY.sharing,this.subscriptionClient=t.subscribeVideo(this.modality,e.mediaSourceId),this.rawBaseClient=new Dg((async()=>this.subscriptionClient?.subscribedStream),(()=>this.unsubscribeVideo()),i,n),this.setClientSubscription(),this.videoStream.changed((()=>{this.rawBaseClient?.isDisposed||(e.isAvailable?this.updateSubscription():this.unsubscribeVideo())}))}client(){return this.rawBaseClient}updateSubscription(){this.rawBaseClient?.isDisposed?this.logger.error(`updateSubscription skipped, raw stream client disposed: stream already exists, causeId=${this.causeId}`):(this.logger.info(`update subcription: Created new subscription, causeId=${this.causeId}`),this.subscriptionClient=this.subscriptionManager.subscribeVideo(this.modality,this.videoStream.mediaSourceId),this.setClientSubscription())}unsubscribeVideo(){this.logger.info(`Disposing subcription, causeId=${this.causeId}`),this.subscriptionClient?.unsubscribe(),this.subscriptionClient?.dispose(),this.subscriptionClient=null}setClientSubscription(){this.logger.info(`setting onMediaStreamChanged callback, causeId=${this.causeId}`),this.subscriptionClient.setOnMediaStreamChangedHandler((()=>this.rawBaseClient?.notifyStreamChange()))}},Ng=class{constructor(){this.handlerMap=new Map}dispose(){this.handlerMap.forEach((e=>e.client().dispose())),this.handlerMap.clear()}handlerAdded(e){const t=e.client();t.on("clientDisposed",(()=>this.deleteRawStreamManagerById(t.clientId))),this.handlerMap.set(t.clientId,e)}deleteRawStreamManagerById(e){this.handlerMap.delete(e)}},Lg=class extends Ng{constructor(e){super(),this.logger=e}streamChanged(e){this.handlerMap.forEach((t=>t.updateAndNotifyClient(e)))}createIRawStreamClient(e){const t=new Og(e,this.logger);return super.handlerAdded(t),t.client()}updateHandlers(e){e.forEach(((e,t)=>{this.handlerMap.has(t)||this.handlerMap.set(t,e)}))}},xg=class extends Ng{constructor(e){super(),this.logger=e}createIRawStreamClient(e,t){const i=new kg(e,t,this.logger);return super.handlerAdded(i),i.client()}},Ug=p,Fg=class extends Ig{constructor(e,t,i,n){super(e,i,n),this.rendererStats=t,this.rawIncomingVideoStreamManager=new xg(this.logger.createChild("rawVideoStream")),this.type=0}get mediaSourceId(){return this.id}getDiagnosticData(){return JSON.stringify({id:this.id,msi:this.mediaSourceId,rank:this.rank,type:this.type,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const e={isAvailable:this.isAvailable,isStreaming:this.isStreaming};return(0,Ug.isEqual)(this.lastStreamStats,e)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=e),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,msi:this.mediaSourceId,rank:this.rank,...this.lastStreamStats}}stop(){return this.mediaSessionInitPromise.reject(new Error("Video stream stopped")),Promise.resolve(void 0)}getRawStream(e){return this.logger.info(`[${e}] - IRawStream for incoming video stream requested`),this.rawIncomingVideoStreamManager.createIRawStreamClient(this,this.mediaSession.getSubscriptionManager())}start(e,t){return this.logger.info(`video start: target=${e}, options=${JSON.stringify(t)}`),this.mediaSessionInitPromise.promise.then((()=>new Mg(this.logger.createChild("RemoteVideoRenderer"),e,this.mediaSession,this.rendererStats,this.mediaSession?.getSessionConfig()))).then((e=>(t&&e.setScalingMode(t.scalingMode),this.logger.info(`subscribeVideoAsync: videoRenderer=${e}, id=${this.id}`),e.subscribeVideoAsync(this).catch((t=>{throw e.dispose(),t})).then((()=>(this.isStreaming=!0,e))))))}update(e,t){this.logger.info(`[${t}][update] stream=${JSON.stringify(e)}`);const i=this.isAvailable;super.update(e,t),this.isAvailable&&this.isAvailable!==i&&this.rendererStats.event(0)}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().video}},Vg=class extends Fg{constructor(e,t,i,n){super(e,t,i,n),this.type=1}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().sharing}},Bg=class e extends We{constructor(e,t,i,n){super(),this.participantId=e,this.mediaSession=t,this.localStats=i,this.audioSourceIds=[],this.streams={},this.lastUmsStreamId=1;const r=i.receive(1,e),s=i.receive(2,e);this.audio=new bg(t,n,1);const a=new Fg(t,r,n,2),o=new Vg(t,s,n,3),c=this.mediaSession?.getSessionConfig()?.config.participantStreamInitialSubscriptions;c&&(a.changed((()=>this.event("streamChanged").raise())),o.changed((()=>this.event("streamChanged").raise()))),this.streams[0]=[a],this.streams[1]=[o],this.streams[2]=[],this.logger=n.createChild("PluginlessCallStreamManager")}setMediaSession(e,t){this.logger.info(`[${t}][setMediaSession]`),this.mediaSession=e,[[this.audio],this.streams[0],this.streams[1]].forEach((i=>i.forEach((i=>i.setMediaSession(e,t)))))}updateStreams(t,i){this.logger.info(`[${i}][updateStreams]`);const n=i=>t.filter((e=>e.type===i)).sort(e.compareStreams);let r=n(Cg);0===r.length&&(r=n(Tg)),r.length>0&&(this.audioSourceIds=r.map((e=>e.sourceId)));const s=r[0];s&&this.audio.update(s,i),this.updateMediaStreams(n(_g),0,i),this.updateMediaStreams(n(Eg),1,i)}hasAudioSource(e){return this.audioSourceIds.some((t=>t===e))||this.audio.id===e}useUmsStream(t,i,n,r,s,a){this.logger.info(`[${a}][useUmsStream] Updating ums streams`);const o=this.getUmsInformation(t,r),c=this.streams[2],l=c.filter((t=>!o.some((i=>e.compareUmsStreams(t,i)))));l.forEach((e=>(0,fg.remove)(c,e))),l.length&&this.logger.info(`[${a}][useUmsStream] Removing ${l.length} ums streams`),o.forEach((t=>{let r=c.find((i=>e.compareUmsStreams(i,t)));r||(r=new Rg(this.logger.createChild("UmsStream"),this.lastUmsStreamId++,i,t,s,n),this.logger.info(`[${a}][useUmsStream] Adding ums stream with metadata: ${JSON.stringify(t)}`),c.push(r))}))}getUmsStreamMetadata(e,t){let i=null,n=null;if(i=e.find((function(e){return"MiddleLaneUltraLowLatency"===e.deliveryPipelineType&&t===e.isPrimary})),i){const e=i.urls;if(e&&e.length>0){i.identifier||this.logger.warn(`[getUmsStreamMetadata]: no ums stream identifier found, isPrimary: ${t}`);const r=i.decryptionKey?.id,s=i.decryptionKey?.value;r&&s||this.logger.warn(`[getUmsStreamMetadata]: no valid ums stream decryption key found, isPrimary: ${t}`);const a=i.deliveryPipelineType||void 0;n={url:e[0],streamDeliveryPipeline:a,decryptionKey:r&&s?{id:r,value:s}:null}}else this.logger.info(`[getUmsStreamMetadata]: no ums URLs found, isPrimary: ${t}`)}else this.logger.info(`[getUmsStreamMetadata]: no ums stream information found, isPrimary: ${t}`);return n}getUmsInformation(e,t){const i=[];let n=null,r=null;for(const t in e){const i=e[t].streams;if(i){if(n)this.logger.info(`[getUmsInformation]: primary ums stream already found, skipping finding primary stream for participant: ${t}`);else{const e=this.getUmsStreamMetadata(i,!0);e?n=e:this.logger.info(`[getUmsInformation]: no primary ums stream found for participant: ${t}`)}if(r)this.logger.info(`[getUmsInformation]: alternate ums stream already found, skipping finding alternate stream for participant: ${t}`);else{const e=this.getUmsStreamMetadata(i,!1);e?r=e:this.logger.info(`[getUmsInformation]: no alternate ums stream found for participant: ${t}`)}}else this.logger.warn(`[getUmsInformation]: no stream information found for participant: ${t}`)}return(n||r)&&i.push({stream:n,altStream:r,threadId:t}),i}static compareStreams(e,t){const i="sendonly"===e.direction||"sendrecv"===e.direction,n="sendonly"===t.direction||"sendrecv"===t.direction;return i&&!n?-1:n&&!i?1:t.sourceId-e.sourceId}static compareUmsStreams(t,i){const n=t.getStreamOptions();return e.compareUmsStreamMetadata(n.stream,i.stream)&&e.compareUmsStreamMetadata(n.altStream,i.altStream)}static compareUmsStreamMetadata(e,t){return!e&&!t||!(!e&&t||e&&!t)&&e.decryptionKey.id===t.decryptionKey.id&&e.decryptionKey.value===t.decryptionKey.value&&e.url===t.url}updateMediaStreams(e,t,i){const n=this.streams[t],r=n.filter((t=>!e.some((e=>e.sourceId===t.id))));r.forEach((e=>(0,fg.remove)(n,e))),r.length&&this.logger.info(`[${i}][updateMediaStreams] Removing ${r.length} streams of type ${t}`),e.forEach(((r,s)=>{let a=n.find((e=>e.id===r.sourceId));a||(0===t?a=new Fg(this.mediaSession,this.localStats.receive(1,this.participantId),this.logger,r.sourceId):1===t&&(a=new Vg(this.mediaSession,this.localStats.receive(2,this.participantId),this.logger,r.sourceId)),this.logger.info(`[${i}][updateMediaStreams] Adding stream ${r.sourceId} of type ${t}`),n.push(a),a.changed((()=>this.event("streamChanged").raise()))),a.update(r,i),a.rank=e.length-s}))}},Hg={0:[1],1:[2,6,3,4,5,7,8],2:[6,3,4,8],3:[1,4,5,8],7:[3,4,8],4:[],5:[3,4,8],6:[3,4],8:[3,5,4]},$g={0:"Disconnected",1:"Connecting",2:"Ringing",3:"Connected",5:"Connected",4:"Disconnected",7:"Connecting"},Gg=class extends We{constructor(e,t,i,n,r,s=Te(),a=[]){super(i),this.mri=e,this.callTelemetry=r,this.cachedMediaStreams=a,this.state=0,this.voiceLevel=0,this.isServerMuted=!1,this.endpointType="default",this.balanceUpdates={},this._raiseChangeDeferRunner=mg.instance.createDeferRunner("CallParticipant.RaiseChange"),this.filteredParticipantEndpointDetails={},this.recordTelemetryForStateChange=(e,t,i,n)=>{if(n){const n="_SetParticipantStateInvalid",r={state:t,reason:i,endpoints:[]};this.endpoints?.endpointDetails?.length&&(r.endpoints=mn(this.endpoints.endpointDetails)),this.callTelemetry.recordEvent(n,r,e)}},this.checkIfIncomingServerMutedIsUpdated=e=>{e.endpointDetails.forEach((e=>{const t=this.filteredParticipantEndpointDetails[e.participantId];void 0!==t&&sg(this.logger,t,e)}))},this.handleServerMutedInfoUpdate=e=>{let t=!1;for(const i of e){const e=this.filteredParticipantEndpointDetails[i.participantId];ag(this.logger,e,i,!0)&&(t=!0)}t&&this.updateIsServerMuted()},this.id=this.mri,this.logger=i.createChild((()=>`ICallParticipant[${we(this.id)}][${this.state}]`)),this.logger.info(`[${s}]created`),this.streamManager=new Bg(this.id,t,n,this.logger),this.streamManager.on("streamChanged",(()=>this.raiseChanged()))}get audio(){return this.streamManager.audio}get streams(){return this.streamManager.streams}getDiagnosticData(){return JSON.stringify({id:we(this.id),state:this.state,isServerMuted:this.isServerMuted})}isSameParticipantsMri(e){return this.id===e}setMediaSession(e,t=Te()){this.streamManager.setMediaSession(e,t)}applyCachedMediaStreams(e=Te()){const t=this.logger.createFnLogger("applyCachedMediaStreams",e);this.cachedMediaStreams?.length?(t.info("applying cachedMediaStreams"),this.updateStreams(this.cachedMediaStreams,e,!1)):t.info("cachedMediaStreams is empty")}updateStreams(e,t=Te(),i=!1){this.logger.createFnLogger("updateStreams",t).info(`isStreamingMode=${i} mediaStreams=${Le(e)}`),e?.length&&(this.cachedMediaStreams=e),i||(this.streamManager.updateStreams(e,t),this.raiseChangedDeferred())}hasAudioSource(e){return this.streamManager.hasAudioSource(e)}raiseChangedDeferred(){this._raiseChangeDeferRunner((()=>this.raiseChanged()))}updateIsServerMuted(){if(!Object.values(this.filteredParticipantEndpointDetails).length)return void this._updateIsServerMuted(!1);let e=!1;Object.values(this.filteredParticipantEndpointDetails).forEach((t=>{const i=e=>t.mediaStreams?.filter((t=>t.type===e)).sort(Bg.compareStreams);let n=i(Cg)?.[0];n||(n=i(Tg)?.[0]);const r=!!n?.serverMuted,s=t.endpointState?.state;!1!==r||0!=!!s?.isMuted||(e=!0)}));const t=!e;this._updateIsServerMuted(t)}_updateIsServerMuted(e){e!==this.isServerMuted&&(this.isServerMuted=e,this.logger.info(`_updateIsServerMuted updating to: ${this.isServerMuted}`),this.raiseChanged())}updateVoiceLevel(e){this.voiceLevel!==e&&(this.voiceLevel=e,this.raiseChanged())}setState(e,t,i){if(this.state===e)return;const n=this.logger.createFnLogger("setState",i);if(3===this.state&&6===e)return void n.info("Ignore Connected->EarlyMedia transition, it is a race between media and signaling");const r=Hg[this.state].indexOf(e)>=0;this.recordTelemetryForStateChange(i,e,t,!r),r?(n.info(`state=${this.state}->${e} reason=${this.stateReason}->${t}`),this.state=e,this.stateReason=t,this.raiseChangedDeferred()):n.logFailure(`Invalid state transition ${this.state}->${e} attempted`)}processParticipantDetails(e,t,i){const n=this.logger.createFnLogger("processParticipantDetails","");this.role=e.role,this.meetingRole=e.meetingRole,this.advancedMeetingRole=e.advancedMeetingRole,this.participantType=e.participantType,this.tenantId=e.tenantId,this.propertyBag=e.propertyBag,this.version=e.version,this.isIdentityMasked=!!e.isIdentityMasked,this.nonMaskedId=e.nonMaskedId,this.nonMaskedDisplayName=e.nonMaskedDisplayName,this.nonMaskedObjectId=e.nonMaskedObjectId,this.maskedIdSeqNumber=e.maskedIdSeqNumber,this.maskedId=e.maskedId,this.joinAsStreamingUser=e.joinAsStreamingUser,e.endpointDetails?.length&&(this.endpoints={endpointDetails:[]},this.participantCapabilities={canConference:!1,canShareScreen:!1,canMerge:!0},this.checkIfIncomingServerMutedIsUpdated(e),this.filteredParticipantEndpointDetails={},e.endpointDetails.forEach((e=>{const n=Hu(e,t);if(this.endpoints.endpointDetails.push(n),!n.mappedTo){if(this.filteredParticipantEndpointDetails[e.participantId]={endpointId:e.endpointId,serverMuteVersion:e.serverMuteVersion,endpointState:e.endpointState,mediaStreams:e.mediaStreams},e.capabilities&&(this.participantCapabilities.canConference||"enabled"!==e.capabilities.cloudAudioVideoConference||(this.participantCapabilities.canConference=!0),this.participantCapabilities.canShareScreen||"enabled"!==e.capabilities.cloudScreenSharing||(this.participantCapabilities.canShareScreen=!0),this.participantCapabilities.canMerge||"enabled"!==e.capabilities.cloudMerge||(this.participantCapabilities.canMerge=!0)),this.contentSharingRole=0,e.contentSharing&&e.contentSharing.sessionInformation){const t=e.contentSharing.sessionInformation;"attendee"===t.role?this.contentSharingRole=1:"presenter"===t.role&&(this.contentSharingRole=2)}n.streamInformation&&i&&i()}})),this.updateIsServerMuted(),n.info(`endpointDetails=${JSON.stringify(this.endpoints)}`),this.raiseChangedDeferred())}toCafeParticipant(){return{audioState:$g[this.state],mri:this.mri}}getSourceIdForMediaType(e){const t=xd(this,e);return-1===t&&this.logger.warn("getSourceIdForMediaType failed"),t}useUmsStream(e,t,i,n,r,s){this.streamManager.useUmsStream(e,t,i,n,r,s),this.raiseChangedDeferred()}hasSourceId(e,t){return void 0!==Ud(this,e,t)}},jg=class extends We{constructor(e,t,i,n,r,s="",a,o){super(),this.callTelemetry=e,this.signalingSession=i,this.contentSharingGuid=n,this.contentSharingIdentity=r,this.state=s,this.subject=a,this.handleOperationFailure=(e,t,i)=>{i.logFailure(e);const n=this.getTerminatedReasonFromError(e);return t.updateStatusTo&&(this.contentSharingStatus=t.updateStatusTo,this.rejectContentSharing(n)),Promise.reject(n)},this._logger=t.createChild((()=>`[ContentSharingSession][${this.contentSharingGuid}]`)),this.contentSharingStatus=0,this.contentSharingTerminationReason=null,this.contentSharingState=s,this._callOperationHandler=new $n(this._logger,this.callTelemetry),o&&(this.sessionId=o)}get contentSharingStatus(){return this.status}set contentSharingStatus(e){if(this._logger.info(`[set contentSharingStatus][currentStatus=${this.status}][newStatus=${e}]`),this.callTelemetry.recordEvent("_SetContentSharingStatus",{newStatus:e,oldStatus:this.status}),this.status!==e&&7!==this.status&&8!==this.status){if(this._logger.info(`[set contentSharingStatus] Changing content sharing status to: ${e}`),this.status=e,7===this.status){const e={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[set contentSharingStatus] Content sharing is disconnected"};this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(e)}if(2===this.status||5===this.status){const e={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Content sharing cannot be ended when not presenting"};this._callOperationHandler.maybeRejectOperation("StopContentSharing",e)}3===this.status&&(this._callOperationHandler.maybeResolveOperation("StartContentSharing"),this._callOperationHandler.maybeResolveOperation("TakeContentSharingControl")),this.raiseChanged()}}get contentSharingState(){return this.state}set contentSharingState(e){this.state!==e&&(this.state=e,this.raiseChanged())}startContentSharing(e=Te()){const t=this._logger.createFnLogger("StartContentSharing",e);if(0!==this.contentSharingStatus){const i=`[${e}][startContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.startContentSharingAsync(this.contentSharingIdentity,this.contentSharingState,this.subject,this.contentSharingGuid,e).then((e=>{this.sessionId=e.sessionId,this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"StartContentSharing",updateStatusTo:8},t))),this._callOperationHandler.waitForOperation("StartContentSharing")}joinContentSharing(e=Te()){const t=this._logger.createFnLogger("JoinContentSharing",e);if(2!==this.contentSharingStatus){const i=`[${e}][joinContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.joinContentSharingAsync(this.contentSharingGuid,e).then((e=>(this.contentSharingStatus=4,this.contentSharingState=e.sessionState,this.presenterId=e.presenter,Promise.resolve()))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"JoinContentSharing",updateStatusTo:8},t)))}updateContentSharingSessionState(e,t,i=Te()){const n=this._logger.createFnLogger("UpdateContentSharingSessionState",i);if(3!==this.contentSharingStatus){const e=`[${i}][updateContentSharingSessionState][failed][reason=InvalidState]`,t={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:e};return n.logFailure(`state=${this.contentSharingStatus}, reason=${e}`),Promise.reject(t)}return this.signalingSession.updateContentSharingSessionStateAsync(this.contentSharingGuid,t,i).then((()=>Promise.resolve())).catch((t=>this.handleOperationFailure(t,{causeId:i,operation:"UpdateContentSharingSessionState",operationId:e},n)))}takeContentSharingControl(e=Te()){const t=this._logger.createFnLogger("TakeContentSharingControl",e);if(5!==this.contentSharingStatus){const i=`[${e}][updateContentSharingSessionState][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.takeContentSharingControlAsync(this.contentSharingGuid,e).then((()=>{this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"TakeContentSharingControl"},t))),this._callOperationHandler.waitForOperation("TakeContentSharingControl")}updateContentSharingParticipantStateToViewer(e=Te()){const t=this._logger.createFnLogger("UpdateParticipantState",e);if(4!==this.contentSharingStatus){const i=`[${e}][updateContentSharingSessionState][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.updateContentSharingParticipantStateAsync(this.contentSharingGuid,e).then((()=>(this.contentSharingStatus=this.presenterId===this.signalingSession.participantManager.localParticipant.id?3:5,Promise.resolve()))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"UpdateParticipantState"},t)))}stopContentSharing(e=Te()){const t=this._logger.createFnLogger("StopContentSharing",e);if(2===this.contentSharingStatus||4===this.contentSharingStatus||5===this.contentSharingStatus){const i=`[${e}][stopContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.deleteContentSharingAsync(this.contentSharingGuid,e).then((()=>(this.contentSharingStatus=7,this._callOperationHandler.waitForOperation("StopContentSharing")))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"StopContentSharing"},t)))}dispose(e=Te()){this._callOperationHandler.rejectPendingOperations({terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Call ended"},e),this.contentSharingStatus=7,this.contentSharingState="",super.dispose()}rejectContentSharing(e={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[rejectContentSharing] Content sharing is disconnected"}){if(7!==this.status&&8!==this.status)throw new Error(`Tried to reject content sharing with status=${this.status}`);this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(e)}getTerminatedReasonFromError(e){const t=e?.endCode?.code||0,i={terminatedReason:32,terminatedReasonCode:t,terminatedReasonSubCode:e?.endCode?.subCode||0,errorMessage:e};switch(t){case Gn.NotFound:i.terminatedReason=34,i.errorMessage="Active session not found on server";break;case Gn.Forbidden:i.terminatedReason=8,i.errorMessage="Failed due to insufficient permissions"}return i}};S([Rn("StartContentSharing"),v(0,Mn)],jg.prototype,"startContentSharing",1),S([Rn("JoinContentSharing"),v(0,Mn)],jg.prototype,"joinContentSharing",1),S([Rn("UpdateContentSharingSessionState"),v(0,Pn),v(2,Mn)],jg.prototype,"updateContentSharingSessionState",1),S([Rn("TakeContentSharingControl"),v(0,Mn)],jg.prototype,"takeContentSharingControl",1),S([Rn("UpdateParticipantState"),v(0,Mn)],jg.prototype,"updateContentSharingParticipantStateToViewer",1),S([Rn("StopContentSharing",{waitFor:"StartContentSharing"}),v(0,Mn)],jg.prototype,"stopContentSharing",1);var qg,Wg=class{constructor(){this.messageCounters=new Map}recordDataChannelProtocolEvent(e){this.messageCounters.has(e.dataId)||this.messageCounters.set(e.dataId,{});const t=this.messageCounters.get(e.dataId);switch(t[e.direction]||(t[e.direction]={successful:0,failed:0,fragmented:0,dismissed:0}),e.state){case 0:t[e.direction].successful++;break;case 1:t[e.direction].failed++;break;case 2:t[e.direction].fragmented++;break;case 3:t[e.direction].dismissed++}}setSessionDataChannelState(e){this.sessionState=e.toString()}recordDataChannelError(e){this.dataChannelError=e}get protocolCounters(){if(!this.messageCounters.size)return;const e={};for(const t of this.messageCounters.keys())e[t]=this.messageCounters.get(t);return e}getReport(e){const t={};return t[e+"ProtocolCounters"]=JSON.stringify(this.protocolCounters),t[e+"SessionState"]=this.sessionState,t[e+"Error"]=this.dataChannelError,t}},zg=class{constructor(e){this.value=e,this.next=void 0}},Jg=class{constructor(){this.length=0}enqueue(e){const t=new zg(e);this.front?(this.rear.next=t,this.rear=t):(this.front=t,this.rear=t),this.length++}dequeue(){if(!this.front)return;const e=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,e.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}},Kg=p,Yg=class{constructor(e){this.comparator=e,this.heap=[]}enqueue(e){this.heap.push(e),this.bubbleUp()}dequeue(){const e=this.peek();if(void 0!==e){const e=this.heap.pop();this.size()>0&&(this.heap[0]=e,this.bubbleDown())}return e}peek(){return this.heap[0]}size(){return this.heap.length}bubbleUp(){let e=this.size()-1,t=this.getParentIndex(e);for(;!this.isRoot(e)&&this.comparator(this.heap[e],this.heap[t]);)[this.heap[t],this.heap[e]]=[this.heap[e],this.heap[t]],e=t,t=this.getParentIndex(e)}bubbleDown(){if(this.size()<=1)return;let e=this.getRootIndex(),t=this.getLeftIndex(e),i=this.getRightIndex(e);for(;this.heap[t]&&this.comparator(this.heap[t],this.heap[e])||this.heap[i]&&this.comparator(this.heap[i],this.heap[e]);)!this.heap[i]||this.comparator(this.heap[t],this.heap[i])?([this.heap[e],this.heap[t]]=[this.heap[t],this.heap[e]],e=t):([this.heap[e],this.heap[i]]=[this.heap[i],this.heap[e]],e=i),t=this.getLeftIndex(e),i=this.getRightIndex(e)}getRootIndex(){return 0}isRoot(e){return 0===e}getLeftIndex(e){return 2*e+1}getRightIndex(e){return 2*e+2}getParentIndex(e){return Math.floor((e-1)/2)}},Qg=class{constructor(e,t,i){this.maxPacketRate=t,this.rateLimiterCheckInterval=i,this.maxDataRate=0,this.packetsEndTimeForPacketRate=0,this.packetsEndTimeForBitrate=0,this.maxDataRate=e/8}canSend(e){if(0===this.maxDataRate&&0===this.maxPacketRate)return!0;const t=Pt();if(this.maxPacketRate&&this.packetsEndTimeForPacketRate>t+this.rateLimiterCheckInterval)return!1;if(this.maxDataRate&&this.packetsEndTimeForBitrate>t+this.rateLimiterCheckInterval)return!1;const i=this.maxPacketRate?1e3/this.maxPacketRate:0,n=this.maxDataRate?e.length/this.maxDataRate*1e3:0;return this.packetsEndTimeForPacketRate=Math.max(this.packetsEndTimeForPacketRate,t)+i,this.packetsEndTimeForBitrate=Math.max(this.packetsEndTimeForBitrate,t)+n,!0}},Xg=class{constructor(e){this.dataIds=new Map,this.maxBitrate=e.config.webrtcDataChannel.maxBitrate,this.maxPacketRate=e.config.webrtcDataChannel.maxPacketRate,this.maxQueueSize=e.config.webrtcDataChannel.maxQueueSize,e.config.webrtcDataChannel.dataIds.forEach((e=>{this.dataIds.set(e.dataId,e)}))}getMaxBitrate(e){return this.dataIds.get(e)?.maxBitrate??this.maxBitrate}getMaxPacketRate(e){return this.dataIds.get(e)?.maxPacketRate??this.maxPacketRate}getMaxQueueSize(e){return this.dataIds.get(e)?.maxQueueSize??this.maxQueueSize}getConfig(e){const t=this.dataIds.get(e)||{dataId:e};return t.maxBitrate=t.maxBitrate??this.maxBitrate,t.maxPacketRate=t.maxPacketRate??this.maxPacketRate,t.maxQueueSize=t.maxQueueSize??this.maxQueueSize,t.priorityWeight=t.priorityWeight??1,t}},Zg=class{constructor(e,t,i){this.dataIdConfig=t,this.rateLimiterCheckInterval=i,this.timeOffset=0,this.packets=new Jg,this.startTime=e(),this.finishTime=this.startTime,this.rateLimiter=new Qg(t.maxBitrate,t.maxPacketRate,this.rateLimiterCheckInterval),this.getCurrentTime=e,this.stats={bufferSize:t.maxQueueSize,remainingBytes:0,remainingPackets:0}}enqueue(e){if(0===e.length)return 0;const t=(0,Kg.sumBy)(e,(e=>e.length)),i=this.dataIdConfig.maxQueueSize;if(i&&this.stats.remainingBytes+t>i)throw new Error(`dataId ${this.dataIdConfig.dataId} send queue is full`);const n=this.getCurrentTime();let r=0;return 0===this.packets.size()?(this.startTime=n,this.finishTime=n,this.timeOffset=0,r=n):r=this.finishTime,e.forEach((e=>{r+=e.length*this.dataIdConfig.priorityWeight,this.packets.enqueue({finishTime:r,packet:e}),this.stats.remainingBytes+=e.length,this.stats.remainingPackets++})),this.finishTime=r,t}dequeue(){const e=this.peek();if(void 0!==e){if(!this.rateLimiter.canSend(e.packet))return;this.packets.dequeue(),this.stats.remainingBytes-=e.packet.length,this.stats.remainingPackets--}return e}updateTimeOffset(){this.packets.size()?this.timeOffset=this.getCurrentTime()-this.startTime:(this.startTime=this.getCurrentTime(),this.finishTime=this.startTime,this.timeOffset=0)}peek(){if(0===this.packets.size())return;const e=this.packets.peek();return{finishTime:e.finishTime+this.timeOffset,packet:e.packet}}getConfig(){return this.dataIdConfig}getStats(){return(0,Kg.clone)(this.stats)}},ep=class{constructor(e){this.senders=new Map,this.currentVirtualClock=0,this.dataIdConfigManager=new Xg(e),this.virtualTimeQueue=new Yg(((e,t)=>e.minTime<t.minTime)),this.sendStats={bufferSize:0,remainingBytes:0,remainingPackets:0},this.rateLimiterCheckInterval=e.config.webrtcDataChannel.rateLimiterCheckInterval}getPacketsToSend(e){if(0===this.virtualTimeQueue.size())return[];const t=[],i=[];for(;e>=0&&this.virtualTimeQueue.size();){const n=this.virtualTimeQueue.peek();if(n.size>e)break;this.virtualTimeQueue.dequeue();const r=n.dataId,s=this.senders.get(r);if(void 0!==s.peek()){const n=s.dequeue();if(void 0!==n){t.push(n.packet),this.sendStats.remainingBytes-=n.packet.length,e-=n.packet.length,this.sendStats.remainingPackets--,this.currentVirtualClock=Math.max(this.currentVirtualClock,n.finishTime);const i=s.peek();i&&this.virtualTimeQueue.enqueue({dataId:r,minTime:i.finishTime,size:i.packet.length})}else i.push(r)}}return i.forEach((e=>{const t=this.senders.get(e);t.updateTimeOffset();const i=t.peek();i&&this.virtualTimeQueue.enqueue({dataId:e,minTime:i.finishTime,size:i.packet.length})})),t}appendPackets(e,t){let i=this.senders.get(e);void 0===i&&(i=new Zg((()=>this.currentVirtualClock),this.dataIdConfigManager.getConfig(e),this.rateLimiterCheckInterval),this.senders.set(e,i));const n=i.getStats(),r=i.enqueue(t);if(this.sendStats.remainingBytes+=r,this.sendStats.remainingPackets+=t.length,0===n.remainingPackets){const t=i.peek();void 0!==t&&this.virtualTimeQueue.enqueue({dataId:e,minTime:t.finishTime,size:t.packet.length})}}getStats(e){if(void 0===e)return(0,Kg.clone)(this.sendStats);const t=this.senders.get(e);return void 0===t?{bufferSize:this.dataIdConfigManager.getMaxQueueSize(e),remainingBytes:0,remainingPackets:0}:t.getStats()}},tp=class{constructor(e,t,i){this.dataId=e,this.statsGatherer=t,this.logger=i,this.pendingFragments=[]}depacketize(e){const t=new DataView(e.buffer),i=63&t.getUint8(2);if(i!==this.dataId)throw new Error(`Invalid packet dataId: ${this.dataId} !== ${i}`);const n=((15&t.getUint8(0))<<8)+t.getUint8(1),r=128&t.getUint8(2),s=t.getUint16(3),a=t.getUint8(5),o=t.getUint32(6),c=t.getUint8(10);if(r){this.pendingFragments.length&&this.logger.warn(`Unfinished message: dataId: ${this.dataId} seqNum: ${s}`),this.remainingPackets=a,0!==a&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:2,dataId:i}),this.pendingFragments=[],this.sourceId=o,this.recipients=[];for(let e=0;e<c;e++){const i=t.getUint32(11+4*e);this.recipients.push(i)}}else{if(0===this.pendingFragments.length)return this.logger.safe.error(`No start flag dataId: ${this.dataId} seqNum: ${s}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:i}),null;if(this.nextSeqNum!==s)return this.logger.safe.error(`Invalid sequence number: dataId: ${this.dataId} seqNum: ${s}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:i}),null;this.remainingPackets-=1}if(this.nextSeqNum=s+1&65535,this.pendingFragments.push(e.slice(n)),0===this.remainingPackets){const e=this.pendingFragments.reduce(((e,t)=>e+t.length),0),t=new Uint8Array(e);let i=0;for(const e of this.pendingFragments)t.set(e,i),i+=e.length;return this.pendingFragments=[],{dataId:this.dataId,sourceId:this.sourceId,data:t,recipients:this.recipients}}return null}},ip=class{constructor(e){this.seqNum=0,this.dataId=e}packetize(e){if(e.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${e.dataId}`);const t=11+4*e.recipients.length,i=new Uint8Array(e.data.length+t),n=new DataView(i.buffer);n.setUint8(0,16+(t>>8)),n.setUint8(1,255&t),n.setUint8(2,128|63&e.dataId),n.setUint16(3,this.seqNum),n.setUint8(5,0),n.setUint32(6,e.sourceId),n.setUint8(10,e.recipients.length);for(let t=0;t<e.recipients.length;t++)n.setUint32(11+4*t,e.recipients[t]);return i.set(e.data,t),this.seqNum+=1,[i]}},np=class{constructor(e,t,i){this.statsGatherer=i,this.seqNum=0,this.dataId=e,this.fragmentationSize=t}packetize(e){if(e.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${e.dataId}`);const t=11+4*e.recipients.length,i=[],n=this.fragmentationSize-t;if(n<0)throw new Error(`message dataId: ${this.dataId} payload size: ${t} exceeds limit`);let r=e.data.length?Math.ceil(e.data.length/n):1;const s=r-1;s>0&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:2,dataId:this.dataId});let a=e.data.length,o=!0,c=0;for(;r>0;){const l=Math.min(a,n),d=new Uint8Array(l+t),h=new DataView(d.buffer);h.setUint8(0,16+(t>>8)),h.setUint8(1,255&t),o?(o=!1,h.setUint8(2,128|63&e.dataId)):h.setUint8(2,63&e.dataId),h.setUint16(3,this.seqNum),h.setUint8(5,s),h.setUint32(6,e.sourceId),h.setUint8(10,e.recipients.length);for(let t=0;t<e.recipients.length;t++)h.setUint32(11+4*t,e.recipients[t]);d.set(e.data.slice(c,c+l),t),c+=l,i.push(d),this.seqNum+=1,r-=1,a-=l}return i}},rp=class extends ze{constructor(e,t,i,n){super(),this.dataChannel=e,this.statsGatherer=t,this.stateInternal="Created",this.packetizers=new Map,this.depacketizers=new Map,this.sendScheduleTimer=0,this.pendingPackets=new Jg,this.label=e.label,this.logger=i.createChild(`[WebRtcDataChannel ${this.label}]`),this.bufferedAmountLowThreshold=n.config.webrtcDataChannel.bufferedAmountLowThreshold,this.bufferedAmountHighThreshold=n.config.webrtcDataChannel.bufferedAmountHighThreshold,this.fragmentationSize=n.config.webrtcDataChannel.enableFragmentation?n.config.webrtcDataChannel.fragmentationSize:0,n.config.webrtcDataChannel.enableSendScheduler&&(this.sendScheduler=new ep(n)),this.rateLimiterCheckInterval=n.config.webrtcDataChannel.rateLimiterCheckInterval,this.discardOnSendFailure=n.config.webrtcDataChannel.discardOnSendFailure,this.subscribeOnDataChannelEvents()}getDataIdStats(e){return this.sendScheduler?.getStats(e)}get state(){return this.stateInternal}setDataChannel(e){this.dataChannel&&(this.logger.info(`Replacing internal data channel ${this.label}:${this.dataChannel.id} with ${e.label}:${e.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close()),this.dataChannel=e,this.subscribeOnDataChannelEvents()}dispose(){this.logger.info("dispose"),this.dataChannel&&(this.logger.info(`dataChannel.close ${this.dataChannel.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close(),this.dataChannel=null,this.setState("Destroyed"),super.dispose())}sendMessage(e,t,i,n=[]){try{this.packetizers.has(e)||(this.fragmentationSize?this.packetizers.set(e,new np(e,this.fragmentationSize,this.statsGatherer)):this.packetizers.set(e,new ip(e)));const r=this.packetizers.get(e).packetize({dataId:e,sourceId:t,data:i,recipients:n});void 0!==this.sendScheduler?(this.sendScheduler.appendPackets(e,r),this.scheduleSend()):r.forEach((e=>{this.dataChannel.send(e)})),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:0,dataId:e})}catch(t){throw this.logger.unsafe.warn(`Failed to construct protocol message: ${Ve(t)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:1,dataId:e}),t}}scheduleSend(){if("Connected"!==this.state)return;const e=e=>{try{this.dataChannel.send(e)}catch(e){return this.logger.unsafe.warn(`Failed to send message: ${Ve(e)}`),!1}return!0};if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){const t=Date.now();let i=this.bufferedAmountHighThreshold-this.dataChannel.bufferedAmount;for(;this.pendingPackets.size();){const t=this.pendingPackets.peek();if(t.length>i)break;if(!e(t))break;this.pendingPackets.dequeue(),i-=t.length}if(0===this.pendingPackets.size()&&i>0){const t=this.sendScheduler.getPacketsToSend(i);for(const i of t)if(!1===e(i)&&!1===this.discardOnSendFailure){this.pendingPackets.enqueue(i);break}}if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){if(this.sendScheduleTimer)return;if(this.sendScheduler.getStats().remainingPackets>0){const e=Math.max(t+this.rateLimiterCheckInterval-Date.now(),20);this.sendScheduleTimer=window.setTimeout((()=>{this.sendScheduleTimer=0,this.scheduleSend()}),e)}}}}subscribeOnDataChannelEvents(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=e=>{const t=new Uint8Array(e.data),i=63&t[2];try{this.depacketizers.has(i)||this.depacketizers.set(i,new tp(i,this.statsGatherer,this.logger));const e=this.depacketizers.get(i).depacketize(t);e&&(this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:0,dataId:i}),this.event("onmessage").raise(i,e.sourceId,e.data))}catch(e){this.logger.unsafe.warn(`Failed to parse incoming message: ${Ve(e)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:1,dataId:i})}},this.dataChannel.onerror=e=>{const t=e?.target,i=Ve(e?.error??e);this.logger.safe.warn(`onerror: label:${t.label} id:${t.id} ${i} `),this.statsGatherer.recordDataChannelError(i)},"open"===this.dataChannel.readyState&&this.dataChannel.id%2==0&&(this.logger.safe.info(`readyState is already 'open' label:${this.dataChannel.label} id:${this.dataChannel.id}`),this.setState("Connected")),this.dataChannel.onopen=e=>{const t=e.target;this.logger.safe.info(`onopen label:${t.label} id:${t.id}`),t.id%2==0&&this.setState("Connected")},this.dataChannel.onclose=e=>{const t=e.target;this.logger.safe.info(`onclose label:${t.label} id:${t.id}`),this.setState("Closed")},this.dataChannel.onclosing=e=>{const t=e.target;this.logger.safe.debug(`onclosing label:${t.label} id:${t.id}`),this.setState("Closed")},void 0!==this.sendScheduler&&(this.dataChannel.bufferedAmountLowThreshold=this.bufferedAmountLowThreshold,this.dataChannel.onbufferedamountlow=()=>{this.scheduleSend()})}unsubscribeOnDataChannelEvents(){this.dataChannel.onmessage=null,this.dataChannel.onerror=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null,this.dataChannel.onclosing=null,this.dataChannel.onbufferedamountlow=null}setState(e){this.stateInternal=e,this.event("onStateChanged").raise(),"Connected"===e&&void 0!==this.sendScheduler&&this.scheduleSend()}},sp=class extends ze{constructor(e,t,i,n){const r=i.createChild("PluginlessDataChannel");super(r),this.pc=e,this.statsGatherer=t,this.configProvider=n,this._state="Inactive",this.logger=r,this.subscribeOnDatachannel()}get state(){return this._state}getDataChannel(e){if(!this.dataChannel){this.logger.safe.info(`[${e}] creating new dataChannel`);try{const e={};this.dataChannel=new rp(this.pc.createDataChannel("main-channel",e),this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()}catch(t){return this.logger.safe.error(`[${e}] createDataChannel failed: ${Ve(t)}`),this.statsGatherer.sessionInfo.setCreateChannelFailReason(t),this.setState("Failed"),null}}return this.dataChannel}updateDataModalityState(e){"Failed"!==this._state&&"Disabled"!==this._state&&(e===Qe.MEDIA_STATE.sendReceive?this.setState("Active"):e===Qe.MEDIA_STATE.inactive&&this.setState("Inactive"))}disable(){this.setState("Disabled")}dispose(){this.stopDataChannel(),this.pc=null,super.dispose()}subscribeOnDatachannel(){this.pc.ondatachannel=e=>{this.onDataChannel(e.channel)}}onDataChannel(e){this.logger.safe.info(`onDataChannel id=${e.id} label=${e.label}`),e.id%2==0?this.dataChannel?(this.logger.safe.info("Found existing data channel, replacing"),this.dataChannel.setDataChannel(e)):(this.dataChannel=new rp(e,this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()):this.logger.safe.info(`onDataChannel ignoring id ${e.id}`)}subscribeForDataChannelEvents(){this.dataChannel.on("onStateChanged",(()=>{"Closed"===this.dataChannel.state&&(this.stopDataChannel(),this.setState("Inactive"))}))}setState(e){if(this._state!==e){this.statsGatherer.setSessionDataChannelState(e);const t=Te();this._state=e,this.logger.safe.info(`[${t}] SessionDataChannelState changed, state=${this._state}`),"Inactive"===this._state||"Disabled"===this._state?this.stopDataChannel():"Active"===this._state&&this.getDataChannel(t),this.event("onStateChanged").raise(this._state)}}stopDataChannel(){this.dataChannel&&(this.logger.safe.info("stopDataChannel"),this.dataChannel.dispose(),this.dataChannel=null)}},ap=class extends We{constructor(e){super(),this.mainChannel=null,this.sourceId=En,this._state="Inactive",this.dataHandlers=new Map,this.dataHandlerTelemetry=new Map,this.startTime=Date.now(),this.sendMessage=async(e,t,i)=>{if(this.logger.debug(`Sending message for ${e}, from: ${this.sourceId} to: ${i} state: ${!!this.mainChannel&&this.mainChannel.state} len: ${t.length}`),!this.mainChannel||"Connected"!==this.mainChannel.state||"Active"!==this.state)throw new Error("No active data channel to send data from");this.mainChannel.sendMessage(e,this.sourceId,t,i)},this.logger=e.createChild("PluginlessDataChannel")}get state(){return this._state}registerSessionDataChannel(e,t){this.sessionDataChannel&&this.stop(t),this.sessionDataChannel=e,this.subscribeForSessionDataChannelEvents()}setDataChannelSourceId(e){this.logger.debug(`setDataChannelSourceId ${e}`),this.sourceId=e}requestDataChannelHandler(e){return this.sessionDataChannel.getDataChannel(e)}async sendUserEvents(e,t){if(!this.mainChannel)throw this.logger.info("sendUserEvents() no data channel available"),new Error("Main DataChannel is not active");{const i=t?t.map((e=>parseInt(e,10))):[];this.mainChannel.sendMessage(0,this.sourceId,(new TextEncoder).encode(e),i)}}async addHandler(e,t){if(this.logger.info(`Adding handler with dataId ${e}`),this.dataHandlers.get(e))throw new Error(`Data Id ${e} is already registered`);const i={isStarted:!1,handler:t};this.dataHandlers.set(e,i),this.recordDataHandlerEvent(e,"added"),"Connected"===this.mainChannel?.state&&this.startHandler(e,i)}async removeHandler(e){if(this.logger.info(`Removing handler with dataId ${e}`),!this.dataHandlers.has(e))throw new Error(`Handler associated with Data Id ${e} is not attached`);const t=this.dataHandlers.get(e);t.isStarted&&this.stopHandler(e,t),this.dataHandlers.delete(e)}async updateNegotiationTag(e){}getTelemetry(){if(!this.dataHandlerTelemetry.size)return"";const e={};for(const[t,i]of this.dataHandlerTelemetry)e[t]=i;return JSON.stringify(e)}start(e){this.mainChannel?this.logger.info(`[${e}] already started`):(this.logger.info(`[${e}] starting`),this.mainChannel=this.sessionDataChannel.getDataChannel(e),this.subscribeForMainDataChannelEvents())}stop(e){this.mainChannel&&(this.logger.info(`[${e}] stopping`),this.mainChannel.dispose(),this.mainChannel=null)}dispose(){this.stop(void 0),this.sessionDataChannel=null,super.dispose()}setConfigProviderView(e){this.configProviderView=e}subscribeForMainDataChannelEvents(){this.mainChannel.on("onmessage",((e,t,i)=>{this.logger.debug(`Got message for ${e}, from: ${t} state: ${!!this.mainChannel&&this.mainChannel.state}, len: ${i.length}`),this.dataHandlers.has(e)&&(this.recordDataHandlerEvent(e,"recvd"),this.dataHandlers.get(e).handler.onDataReceived(e,i,t)),this.event("remoteUserEventsReceived").raise(e.toString(),(new TextDecoder).decode(i))})),this.onMainChannelStateChanged(),this.mainChannel.on("onStateChanged",(()=>this.onMainChannelStateChanged()))}onMainChannelStateChanged(){if(this.mainChannel)switch(this.mainChannel.state){case"Connected":this.startHandlers();break;case"Closed":case"Destroyed":this.stopHandlers()}}startHandlers(){for(const[e,t]of this.dataHandlers.entries())t.isStarted||this.startHandler(e,t)}stopHandlers(){for(const[e,t]of this.dataHandlers.entries())t.isStarted&&this.stopHandler(e,t)}startHandler(e,t){this.logger.info(`Starting dataHandler id: ${e}`),t.handler.onStarted(e,((t,i)=>(this.recordDataHandlerEvent(e,"sent"),this.sendMessage(e,t,i))),(()=>{const t=this.mainChannel?.getDataIdStats(e);if(void 0!==t){const e={bufferSize:t.bufferSize,remainingBytes:t.remainingBytes,remainingPackets:t.remainingPackets};return Promise.resolve(e)}return Promise.reject(new Error(`Stats of dataId ${e} is not available`))})),t.isStarted=!0,this.recordDataHandlerEvent(e,"started")}stopHandler(e,t){this.logger.info(`Stopping dataHandler id: ${e}`),t.handler.onStopped(e),t.isStarted=!1,this.recordDataHandlerEvent(e,"removed")}subscribeForSessionDataChannelEvents(){this.sessionDataChannel.on("onStateChanged",(e=>{const t=Te();switch(e){case"Active":this.start(t),this.setState("Active");break;case"Inactive":this.stop(t),this.setState("Inactive");break;case"Failed":this.stop(t),this.setState("Failed");break;case"Disabled":this.stop(t),this.setState("Disabled");break;default:this.logger.warn(`[${t}] unhandled SessionDataChannelState ${e}`)}}))}recordDataHandlerEvent(e,t){this.dataHandlerTelemetry.has(e)||this.dataHandlerTelemetry.set(e,[{}]);const i=this.dataHandlerTelemetry.get(e);let n=i[i.length-1];if("added"===t&&void 0!==n.added){n={},i.push(n);const e=this.configProviderView?.config.maxStoredDataChannelValues??15;i.length>e&&i.shift()}switch(t){case"added":case"started":case"removed":n[t]=Date.now()-this.startTime;break;case"recvd":case"sent":n[t]=isNaN(n[t])?1:n[t]+1}}setState(e){this._state!==e&&(this._state=e,this.logger.info(`PluginlessDataChannelState changed, state=${this._state}`),this.event("onDataChannelStateUpdated").raise(this._state))}},op=f(pe());(e=>{e.encodeMouseEvent=function(e){if(!e)return new Uint8Array(0);e.buttonType||(e.buttonType=0),e.xPos||(e.xPos=0),e.yPos||(e.yPos=0),e.wheelRotation||(e.wheelRotation=0);const t=new ArrayBuffer(7),i=new DataView(t),n=3&e.type,r=(7&e.buttonType)<<2,s=(e.buttonDown?1:0)<<5,a=(e.wheelButtonDown?1:0)<<6;return i.setUint8(0,1),i.setUint8(1,n|r|s|a),i.setUint16(2,e.xPos,!0),i.setUint16(4,e.yPos,!0),i.setUint8(6,e.wheelRotation),new Uint8Array(t)},e.encodeKeyboardEvent=function(e){const t=new ArrayBuffer(3),i=new DataView(t),n=3&e.codeType,r=(e.keyUp?1:0)<<4,s=(e.repeat?1:0)<<5;return i.setUint8(0,0),i.setUint8(1,n|r|s),i.setUint8(2,e.code),new Uint8Array(t)},e.decodeEventType=function(e){return e[0]},e.decodeMouseEvent=function(e){if(1!==e[0]||7!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{type:3&i,buttonType:i>>2&7,buttonDown:!!(i>>5&1),wheelButtonDown:!!(i>>6&1),xPos:t.getUint16(2,!0),yPos:t.getUint16(4,!0),wheelRotation:t.getUint8(6)}},e.decodeKeyboardEvent=function(e){if(0!==e[0]||3!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{codeType:3&i,code:t.getUint8(2),repeat:!!(i>>5&1),keyUp:!!(i>>4&1)}}})(qg||(qg={}));var cp=p,lp=g,dp=1e4,hp="",up=class extends un{constructor(e,t,i,n,r,s){super(e,t,(()=>this.recordedEvents.length>100)),this.negotiationTag=i,this.callId=n,this.participantId=r,this.endpointId=s,this.messagesFromUnknownSender={},this.tsCallingVersion="2024.14.01.41"}recordProtocolMessage(e,t){e||(t in this.messagesFromUnknownSender||(this.messagesFromUnknownSender[t]=0),this.messagesFromUnknownSender[t]++)}setCallId(e){this.callId=e}setEndpointId(e){this.endpointId=e}setParticipantId(e){this.participantId=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}},gp=class extends up{constructor(e,t,i,n,r,s,a){super(e,t,i,n,r,s);const o=Vd(a);if(o){this.sharerParticipantId=o;const e=(0,cp.find)(a.endpoints.endpointDetails,(e=>e.participantId===o));e&&(this.sharerClientVersion=e.clientVersion)}}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.callId),ParticipantId:i(this.participantId),EndpointId:i(this.endpointId),NegotiationTag:i(this.negotiationTag),TsCallingVersion:i(this.tsCallingVersion),TenantId:i(this.tenantId),SharerParticipantId:i(this.sharerParticipantId),SharerClientVersion:i(this.sharerClientVersion),EventTimestampBag:super.getEventTimestampBag(e,t),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},pp=class extends up{constructor(e,t,i,n,r,s){super(e,t,i,n,r,s)}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.callId),ParticipantId:i(this.participantId),EndpointId:i(this.endpointId),NegotiationTag:i(this.negotiationTag),TsCallingVersion:i(this.tsCallingVersion),TenantId:i(this.tenantId),EventTimestampBag:super.getEventTimestampBag(e,t),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},mp=class extends We{constructor(e,t,i,n){super(e),this._logger=e,this._call=t,this._telemetryLoggers=i,this._config=n,this.controlState=0,this.role=0,this._enabled=!1,this._availableAckEnabled=!0,this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._controlRequest=null,this._controlRequestSubscription=null,this._controllerParticipant=null,this._controllerParticipantSubscription=null,this._controllerSourceId=null,this._screenSharingVideoRenderer=null,this._screenSharingVideoRendererSubscriptions=[],this._sharerParticipant=null,this._pendingSharer=null,this._controlCapturer=null,this._captureEventSubscription=null,this._mouseControlEventSubscription=null,this._keyboardControlEventSubscription=null,this._requestControlTimer=null,this._grantControlTimer=null,this._acceptControlTimer=null,this._terminateControlTimer=null,this._delayedSendHandshakeTimer=null,this._availableAckTimer=null,this._retryAttempt=0,this._raiseRenderedAtViewer=null,this._participantSubscriptions={},this._viewerSessionLastTerminatedReason=0,this._completedViewerSessions=[],this.giveControlEnabled=!0,this.isEscalationInProgress=!1,this._logger.info("constructor"),this._callId=this._call.callId,this._call.on("callIdChanged",(e=>{this._callId=e,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setCallId(e),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setCallId(e)})),this._participantId=this._call.participantId,this._call.on("callLegIdChanged",(e=>{this._participantId=e,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setParticipantId(e),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setParticipantId(e)})),this._endpointId=this._call.endpointId}setAdapters(e,t,i){this._controlInjector=e,this._rendererAdapter=t,this._dataChannelAdapter=i,this._dataChannelAdapter.on("stateChange",(e=>{this._onDataChannelStatusChanged(e)})),this._dataChannelAdapter.on("protocolMessage",((e,t,i,n)=>this.processProtocolMessage(e,t,i,n))),this._dataChannelAdapter.on("controlMessage",((e,t)=>this.processControlMessage(e,t)))}testSetControlInjector(e){}enableScreenSharingControl(e,t,i,n){if(this._logger.info(`enableScreenSharingControl() enabled=${e} disabledReason=${t}`),this._availableAckEnabled!==e||this._allowControlForUser!==n){if(this._allowControlForUser=n,e)this._raiseScreenSharingControlCapableEvent(!0,hp);else{if(0===t){const e={reason:2,detail:i};this.event("sharingControlError").raise(e)}this._raiseScreenSharingControlCapableEvent(!1,hp)}if(this._availableAckEnabled!==e){const t=e?"AvailableAckEnabled":"AvailableAckDisabled";this._recordSharerSessionTelemetry((e=>e.recordEvent(t)),!1)}this._availableAckEnabled=e}}setGiveControlEnabled(e){this.giveControlEnabled=e}_canEnableGiveControl(){return this._controlInjector.canBeEnabled()&&this.giveControlEnabled}setRaiseRenderedAtViewer(e){this._raiseRenderedAtViewer=e}setScreenSharingControlFeatureFlag(e){this._logger.info(`setScreenSharingControlFeatureFlag() enabled=${e}`),this._enabled=e,this._availableAckEnabled=e,this._enabled&&this._handleCallState(this._callState)}isScreenSharingControlEnabled(){return this._enabled}_disposeRenderer(e){this._disposeControlCapturer(e);for(const e of this._screenSharingVideoRendererSubscriptions)e.dispose();this._screenSharingVideoRendererSubscriptions=[],this._screenSharingVideoRenderer=null}setRenderer(e,t){this._logger.info("setRenderer");const i=Te();if(this._disposeRenderer(i),!e)return Promise.resolve();const n=t||this._rendererAdapter.getTarget(e);return Si((()=>{this._setViewingRenderer(e,n)}))}_isDataChannelActive(){return this._dataChannelAdapter.isActive()&&this._dataChannelAvailable}_raiseScreenSharingControlCapableEvent(e,t,i){if(this._enabled&&this._isDataChannelActive()){this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=true, capable=${e}, role=${this.role}`);const n={capable:e,id:t,disabledBySharer:i};this.event("sharingControlCapable").raise(n)}else{this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=false, capable=${e}, role=${this.role}`);const i={capable:!1,id:t};this.event("sharingControlCapable").raise(i)}}initControlForSharer(e){this._logger.info("initControlForSharer()"),this._isSharing()&&this._logger.warn("initControlForSharer() when already sharing"),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this._logger.info(`role is changing from=${this.role} to=1`),this.role=1,this._availableHandshakeSent=!1,this._raiseScreenSharingControlCapableEvent(this._canEnableGiveControl(),hp),this._initiateSharerSessionTelemetry(e)}enableControlInjector(e){this._logger.info(`enableControlInjector() trackId: ${e}`),this._canEnableGiveControl()?this._controlInjector.enableInjector(e).catch((e=>{const t={reason:0,detail:JSON.stringify({errorMsg:e})};this.event("sharingControlError").raise(t)})):this._logger.info("enableControlInjector() give control cannot be enabled")}shutdownControlForSharer(){if(this._logger.info("shutdownControlForSharer()"),this._isSharing()||this._logger.warn("shutdownControlForSharer() when not sharing"),this._controlRequest){this._logger.warn("Rejecting pending control requests");const e=this._getDataSourceIdForParticipantLeg(this._controlRequest),t=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(t),this._sendControlRejectRequest(5,e)}if(this._controllerParticipant){const e={inControl:!1,id:this._controllerParticipant.participant.id,terminatedReason:5};this.event("sharingControlChanged").raise(e)}this._finalizeSharerSessionTelemetry("Shutdown"),this._teardownSharerRemoteControl(),this._controlInjector.disableInjector().catch((e=>{const t={reason:0,detail:JSON.stringify({errorMsg:e})};this.event("sharingControlError").raise(t)})),this._resetControlState(),this._resetParticipantSubscriptions(),this._availableAckEnabled=this._enabled,this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}_resetParticipantSubscriptions(){this._logger.info("resetParticipantSubscriptions() Stopping tracking all participant state changes"),(0,cp.each)(this._participantSubscriptions,(e=>{e.dispose()})),this._participantSubscriptions={}}_initiateViewerSessionTelemetry(e,t,i){if(!i&&!t)return null;if(!i&&(0,cp.find)(this._completedViewerSessions,(e=>t===e)))return null;if(this._currentViewerSessionTelemetry){if(this._currentViewerSessionTelemetry.negotiationTag===t)return null;this._finalizeViewerSessionTelemetry("ShutdownByOtherSession")}return this._logger.info(`Initiating new viewer session telemetry for ${t}`),this._currentViewerSessionTelemetry=new gp(this._logger,(new Date).getTime(),t,this._callId,this._participantId,this._endpointId,e),this._currentViewerSessionTelemetry.recordEvent("CallState",{state:this._callState}),this._isDataChannelActive()&&this._currentViewerSessionTelemetry.recordEvent("DataChannelAvailable"),this._currentViewerSessionTelemetry}_recordViewerSessionTelemetry(e,t=!0){this._currentViewerSessionTelemetry?e&&e(this._currentViewerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")}_finalizeViewerSessionTelemetry(e){if(!this._currentViewerSessionTelemetry)return;this._currentViewerSessionTelemetry.recordEvent(e);const t=this._currentViewerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_viewer_session",t),this._currentViewerSessionTelemetry.negotiationTag&&this._completedViewerSessions.push(this._currentViewerSessionTelemetry.negotiationTag),this._currentViewerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentViewerSessionTelemetry.messagesFromUnknownSender).length&&lp.RootToolsManager.logExternalForDDL("ScreenSharingControl_viewer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentViewerSessionTelemetry=null}_initiateSharerSessionTelemetry(e){if(this._currentSharerSessionTelemetry){if(this._currentSharerSessionTelemetry.negotiationTag===e)return null;this._finalizeSharerSessionTelemetry("ShutdownByOtherSession")}this._logger.info(`Initiating new sharer session telemetry for ${e}`),this._currentSharerSessionTelemetry=new pp(this._logger,(new Date).getTime(),e,this._callId,this._participantId,this._endpointId),this._isDataChannelActive()&&this._currentSharerSessionTelemetry.recordEvent("DataChannelAvailable")}_recordSharerSessionTelemetry(e,t=!0){this._currentSharerSessionTelemetry?e&&e(this._currentSharerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")}_finalizeSharerSessionTelemetry(e){if(!this._currentSharerSessionTelemetry)return;this._currentSharerSessionTelemetry.recordEvent(e);const t=this._currentSharerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_sharer_session",t),this._currentSharerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentSharerSessionTelemetry.messagesFromUnknownSender).length&&lp.RootToolsManager.logExternalForDDL("ScreenSharingControl_sharer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentSharerSessionTelemetry=null}_sendTelemetryEvent(e,t){this._logger.info(`Sending event ${e}: `),Object.keys(t).forEach((e=>{this._logger.info(`     ${e} => ${t[e]}`)})),this._telemetryLoggers?.media?.sendEvent({eventName:e,props:t})}_recordProtocolMessage(e,t){this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.recordProtocolMessage(e,t),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.recordProtocolMessage(e,t)}reportSharingSessionChangeForViewer(e,t){t&&this._initiateViewerSessionTelemetry(e,t,!1)}initControlForViewer(e,t){if(this._logger.info(`initControlForViewer(${we(e?.id)}, ${t})`),!e)return void this._logger.warn("initControlForViewer: Sharer undefined, ignoring");if(this._isViewing()&&this._logger.warn("initControlForViewer: called when already viewing"),3!==this._callState)return this._logger.info(`initControlForViewer: postponed until call is connected, callState=${this._callState}`),this._pendingNegotiationTag=t,void(this._pendingSharer=e);const i=!this._sharerParticipant||this._sharerParticipant&&this._sharerParticipant.id!==e.id||t!==this._currentNegotiationTag;this._currentNegotiationTag=t,this._logger.info(`role is changing from=${this.role} to=2`),this.role=2,this._sharerParticipant?this._sharerParticipant.id!==e.id&&(this._recordViewerSessionTelemetry((e=>e.recordEvent("ShutdownByOtherSession",null,t))),this._logger.info(`initControlForViewer: sharer switched, new sharer id=${we(e.id)}`),this._availableHandshakeSent=!1,4===this.controlState&&this._terminateControl(!1)):(this._logger.info(`initControlForViewer: setting sharer to id=${we(e.id)}`),this._sharerParticipant=e,this._availableHandshakeSent=!1),this._initiateViewerSessionTelemetry(e,t,!0),i&&this._recordViewerSessionTelemetry((e=>e.recordEvent("SharingStarted"))),this._enabled&&this._isDataChannelActive()&&!this._availableHandshakeSent&&(this._resetControlState(),this._sharerParticipant=e,this._logger.info("initControlForViewer: sending Available message to sharer"),this._startAvailableHandshake())}shutdownControlForViewer(e){this._logger.info("shutdownControlForViewer()"),this._pendingSharer=null;let t=!1;if(e&&e.id!==this._sharerParticipant?.id||(this._logger.info(`shutdownControlForViewer: setting shouldShutdownControlForViewer to true, isViewing: ${this._isViewing()}`),t=!0),t&&this._isViewing()){if(1===this.controlState){if(this._sharerParticipant){const e=this._getSharerDataSourceId();this._sendRequest({action:2,terminatedReason:6},e)}else this._logger.warn("shutdownControlForViewer: sharer participant is null");const e={inControl:!1,id:hp,terminatedReason:6};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:""}))):this._logger.error("shutdownControlForViewer: Unexpected, no promise could be resolved, controlState=RequestSent")}else if(4===this.controlState){const e={inControl:!1,id:hp,terminatedReason:6};this.event("sharingControlChanged").raise(e)}this._teardownViewerRemoteControl(),this._resetControlState(),this._screenSharingVideoRenderer=null,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._availableHandshakeSent=!1,this._finalizeViewerSessionTelemetry("Shutdown"),2===this.role?(this._logger.info(`_raiseScreenSharingControlCapableEvent  with user role=${this.role}, MRI=, isCapable=false`),this._raiseScreenSharingControlCapableEvent(!1,hp)):this._logger.warn(`can't call _raiseScreenSharingControlCapableEvent, role=${this.role}`),this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}}_resetControlRequest(e){this._clearControlRequest(),this._controlRequest=e,this._registerParticipantListener(e),3===e.participantState&&(this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${e.participant.id}`),this.event("sharingIncomingControlRequest").raise(e.participant.id))}_clearControlRequest(){this._logger.info("_clearControlRequest()"),this._stopListeningToParticipantChanges(this._controlRequest),this._controlRequest=null}_stopListeningToParticipantChanges(e){this._controlRequestSubscription&&(this._logger.info(`_stopListeningToParticipantChanges: stopping tracking changes for ${e.participant.id}`),this._controlRequestSubscription.dispose(),this._controlRequestSubscription=null)}_registerParticipantListener(e){this._logger.info(`_registerParticipantListener: tracking changes for ${e.participant.id}`),this._logger.info(`request.participantState: ${e.participantState} | request.participant.state: ${e.participant.state}`),this._controlRequestSubscription=e.participant.changed((()=>{if(e.participant.state!==e.participantState)switch(this._logger.info(`request.participantState about to changed from: ${e.participantState} to: ${e.participant.state}`),e.participantState=e.participant.state,e.participantState){case 3:this.event("sharingIncomingControlRequest").raise(e.participant.id),this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${e.participant.id}`);break;case 0:case 5:case 4:this.denyControlRequest().catch((e=>{this._logger.info(`It is ok if denyControlRequest rejects here as screensharing may have just been stopped. Err: ${e}`)})),this._logger.info(`_registerParticipantListener: participant ${e.participant.id} is no longer connected. resetting`),this._clearControlRequest(),this._raiseControlRequestCanceled(e);break;case 1:case 2:case 6:case 7:this._logger.info(`participantState: ${e.participantState}, participantId: ${e.participant.id}`);break;default:this._logger.error(`_registerParticipantListener: Unexpected participantState ${e.participantState} unhandled`)}}))}_resetControllerParticipant(e){this._controllerParticipantSubscription&&(this._logger.info(`_resetControllerParticipant: stopping tracking changes for ${this._controllerParticipant.participant.id}`),this._controllerParticipantSubscription.dispose(),this._controllerParticipantSubscription=null),e&&(this._logger.info(`_resetControllerParticipant: tracking changes for ${e.participant.id}`),this._controllerParticipantSubscription=e.participant.changed((()=>{3!==e.participant.state&&this.handleParticipantRemoved(e.participant.id)}))),this._controllerParticipant=e}handleParticipantRemoved(e){if(this._participantSubscriptions[e]&&(this._logger.info(`handleParticipantRemoved(): Stopping tracking state changes for ${e}`),this._participantSubscriptions[e].dispose(),delete this._participantSubscriptions[e]),this._isSharing()){if(this._controllerParticipant&&this._controllerParticipant.participant.id===e){this._logger.info("handleParticipantRemoved: controller left call, tearing down control session"),this._teardownSharerRemoteControl(),this.controlState=0,this._resetControllerParticipant();const t={inControl:!1,id:e,terminatedReason:5};this.event("sharingControlChanged").raise(t)}this._raiseScreenSharingControlCapableEvent(!1,e)}else if(this._sharerParticipant&&this._sharerParticipant.id===e&&4===this.controlState){this._logger.info("handleParticipantRemoved: sharer left call, tearing down control session"),this._teardownViewerRemoteControl(),this.controlState=0;const e={inControl:!1,id:hp,terminatedReason:6};this.event("sharingControlChanged").raise(e)}}callStateChanged(e){this._callState=e,this._recordViewerSessionTelemetry((t=>t.recordEvent("CallState",{state:e})),!1),this._recordSharerSessionTelemetry((t=>t.recordEvent("CallState",{state:e})),!1),this.isScreenSharingControlEnabled()&&this._handleCallState(e)}setIsEscalationInProgress(e){this.isEscalationInProgress=e}_getHandshakeDelay(){if(!this._config.handshakeSendDelay?.minParticipantThreshold)return 0;let e=0;if(this._call.participants.length>=this._config.handshakeSendDelay.minParticipantThreshold)for(const t of this._call.participants)t.endpoints?.endpointDetails.some((e=>"interactive"===e.appliedInteractivityLevel))&&e++;if(e<=this._config.handshakeSendDelay.minParticipantThreshold)return 0;const t=Math.ceil((e-this._config.handshakeSendDelay.minParticipantThreshold)/this._config.handshakeSendDelay.increaseEveryN);return Math.min(this._config.handshakeSendDelay.maxDelay,t*this._config.handshakeSendDelay.delayPerN)}_handleCallState(e){switch(e){case 3:this._handleCallConnected();break;case 7:this._handleCallDisconnected();break;case 4:case 5:this.shutdownControlForViewer()}}_handleCallConnected(){this._logger.info("_handleCallConnected()"),this._pendingSharer&&(this.initControlForViewer(this._pendingSharer,this._pendingNegotiationTag),this._pendingSharer=null)}_handleCallDisconnected(){this._logger.info("_handleCallDisconnected()"),this._isSharing()?this.shutdownControlForSharer():this.shutdownControlForViewer()}_videoSizeChanged(e,t){null!==this._controlCapturer&&this._controlCapturer.updateVideoSize(e,t)}_onRenderStarted(){const e={action:11,terminatedReason:0};if(this._sharerParticipant){const t=this._getSharerDataSourceId();this._sendRequest(e,t)}else this._logger.error("Attempted to send sharing rendered message to null sharerParticipant")}_setViewingRenderer(e,t){try{this._screenSharingVideoRenderer=e,this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeVideoSizeChangedEvent(this._screenSharingVideoRenderer,((e,t)=>{this._videoSizeChanged(e,t)}))),this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeRenderStartedEvent(this._screenSharingVideoRenderer,(()=>{this._onRenderStarted()})));let i=1;e.streamSize&&e.streamSize.width>0&&e.streamSize.height>0&&(i=e.streamSize.width/e.streamSize.height),this._controlCapturer=new op.SlimCoreElectronControlCapturer(this._logger,t,!0,i),4===this.controlState?(this._logger.info("_setViewingRenderer: detected local state is controlling"),this._setupViewerRemoteControl()):this._teardownViewerRemoteControl()}catch(e){this._logger.error(`_setViewingRenderer: unable to set _screenSharingVideoRenderer error=${e}`)}}_onDataChannelStatusChanged(e){this._logger.info(`_onDataChannelStatusChanged(): Data channel status=${e}, isEscalationInProgress=${this.isEscalationInProgress}`),e?this._dataChannelAvailable||(this._dataChannelAvailable=!0,this._recordViewerSessionTelemetry((e=>e.recordEvent("DataChannelAvailable")),!1),this._recordSharerSessionTelemetry((e=>e.recordEvent("DataChannelAvailable")),!1),this._enabled&&(this._isViewing()?this._availableHandshakeSent||(this._sharerParticipant?(this._logger.info("_onDataChannelStatusChanged: sending Available message to sharer"),this._startAvailableHandshake()):this._logger.error("Unexpected null _sharerParticipant trying to send Available to sharer")):this._isSharing()&&(this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!0,hp)))):this._dataChannelAvailable&&(this._recordViewerSessionTelemetry((e=>e.recordEvent("DataChannelUnavailable")),!1),this._recordSharerSessionTelemetry((e=>e.recordEvent("DataChannelUnavailable")),!1),this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(3),this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!1,hp))}_isSharing(){return 1===this.role}_isViewing(){return 2===this.role}_handleAvailableRequest(e,t,i){let n=!1,r=0;if(this._enabled)if(this._availableAckEnabled)if(this._canEnableGiveControl())if(t?.id){if(this._allowControlForUser&&typeof this._allowControlForUser==typeof Function)return void this._allowControlForUser(t).then((s=>{s||(n=!0,r=1),this._sendResponseToAvailableRequest(e,t,i,n,r)}))}else n=!0,r=10;else this._logger.info("GiveControl is not enabled. no need to answer the available ack"),n=!0,r=9;else this._logger.info("Available ack is off. no need to answer the available ack"),n=!0,r=9;else this._logger.info("Feature flag is off. no need to answer the available ack"),n=!0,r=9;this._sendResponseToAvailableRequest(e,t,i,n,r)}_sendResponseToAvailableRequest(e,t,i,n,r){n?(this._logger.info(`Rejecting Available for handShake:${i}:${e.handshakeId}`),this.event("controlAvailableHandshake").raise(e.handshakeId,i,7,this._getAvailableHandshakeTerminatedFromControlTerminated(r)),this._sendRequest({action:10,terminatedReason:r,handshakeId:e.handshakeId},i)):(this._raiseScreenSharingControlCapableEvent(!0,t.id),this._participantSubscriptions[t.id]||(this._logger.info(`Tracking participant status for ${t.id}`),this._participantSubscriptions[t.id]=t.changed((()=>{3!==t.state&&(this._logger.info(`Participant ${t.id} is not connected. removing`),this.handleParticipantRemoved(t.id))}))),this._logger.info(`Acking Available for handShake:${i}:${e.handshakeId}`),this.event("controlAvailableHandshake").raise(e.handshakeId,i,3),this._sendRequest({action:9,terminatedReason:0,handshakeId:e.handshakeId},i))}processProtocolMessage(e,t,i,n){return Si((()=>{this._processProtocolMessage(e,t,i,n)}))}_raiseControlRequestCanceled(e){this.event("sharingIncomingControlRequestCancelled").raise(e.participant.id)}_handleControlRequest(e,t,i){this._recordSharerSessionTelemetry((e=>{e.recordOperation("ControlRequest",null,String(t))})),this._enabled?this._controlRequest?(this._logger.warn("Sharer is already processing a control request...rejecting new requests"),this._sendControlRejectRequest(3,t)):this._controllerParticipant&&this._controllerParticipant.participant===e?this._controllerParticipant.participantId&&this._controllerParticipant.participantId!==i?(this._logger.warn(`rejecting control request from second endpoint. participantId: ${i}`),this._sendControlRejectRequest(3,t)):(this._logger.warn("Got control request for someone already in control"),this._resetControllerParticipant(),this._resetControlRequest({participant:e,participantState:e.state,participantId:i})):e?(this._logger.info(`resetControlRequest for participantId: ${i}`),this._resetControlRequest({participant:e,participantState:e.state,participantId:i})):this._logger.error("Got ControlRequest message but could not find a sender participant, ignoring"):(this._logger.warn("Sharer control is disabled - rejecting request"),this._sendControlRejectRequest(9,t))}_handleAcceptRequest(e,t){if(1===this.controlState){const i=this._sendRequest({action:5,terminatedReason:0},t);this._logger.info(`_handleAcceptRequest controlMessage.action: ${fp(e.action)} _sendRequest isSent: ${i}`),i?(this._setupViewerRemoteControl(),this.controlState=4,this._requestControlPromise?this._requestControlPromise.resolve():this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${fp(e.action)}`),this._recordViewerSessionTelemetry((e=>{e.recordOperationSuccess("ControlRequest",null)}))):this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control is accepted, but failed to send ack"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Sp(this.controlState)} action=${fp(e.action)}`),this._cancelRequestControlTimer()}else this._logger.warn(`AcceptRequest message received in controlState=${Sp(this.controlState)}`)}_handleRejectRequest(e){if(1===this.controlState){this._logger.info(`_handleRejectRequest: controlState: ${Sp(this.controlState)}, about to be changed to: ${Sp(0)}`),this.controlState=0;const t={inControl:!1,id:hp,terminatedReason:e.terminatedReason};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:t,details:""}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${fp(e.action)}`),this._recordViewerSessionTelemetry((t=>{t.recordOperationFailure("ControlRequest",{reason:vp(e.terminatedReason)})})),this._cancelRequestControlTimer()}else this._logger.warn(`RejectRequest message received in controlState=${Sp(this.controlState)} reason=${e.terminatedReason}`)}_handleCancelControlRequest(e,t){if(this._logger.info(`_handleCancelControlRequest action=${fp(e.action)} sender=${t}, controlRequest participantId: ${this._controlRequest.participantId}, controlRequest participantState: ${this._controlRequest.participantState}:`),this._controlRequest){const i=this._controlRequest;this._logger.info(`_handleCancelControlRequest action=${fp(e.action)} sender=${t}, about to raise: _raiseControlRequestCanceled state: ${this._controlRequest.participantState} `),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",{participantId:t},String(t))})),this._clearControlRequest(),this._raiseControlRequestCanceled(i)}}_handleGiveControl(e,t,i){const n=this._sendRequest({action:5,terminatedReason:0},t);if(this._logger.info(`_handleGiveControl: controlMessage.action: ${fp(e.action)} _sendRequest isSent: ${n}`),n){this._setupViewerRemoteControl(),this._logger.info(`controlState: ${Sp(this.controlState)}, about to be changed to: ${Sp(4)}`),this.controlState=4,this._recordViewerSessionTelemetry((e=>{e.recordEvent("ControlGiven",{sender:t})}));const i={inControl:!0,id:hp,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(i)}}_handleAck(e,t,i){if(2===this.controlState)if(this._controllerParticipant&&this._controllerParticipant.participant===t){const t=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);i!==t&&this._logger.warn(`acknowledging source id: ${i} does not match requesting source id: ${t}`),this._logger.info(`Setting up remote control for controller source id=${t}`),this._setupSharerRemoteControl(t),this._logger.info(`controlState: ${Sp(this.controlState)}, about to be changed to: ${Sp(3)}`),this.controlState=3;const n={inControl:!0,id:this._controllerParticipant.participant.id,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(n),this._grantControlPromise?(this._grantControlPromise.resolve(),this._cancelGrantControlTimer(),this._recordSharerSessionTelemetry((e=>{e.recordOperationSuccess("GiveControl",{participantId:t})}))):this._acceptControlPromise?(this._acceptControlPromise.resolve(),this._cancelAcceptControlTimer(),this._recordSharerSessionTelemetry((e=>{e.recordOperationSuccess("ControlRequest",{participantId:t},String(t))}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForControlAck action=${fp(e.action)}`)}else t?this._logger.warn(`Ignoring ack from participant that does not match controller id=${we(t.id)}`):this._logger.warn(`Ignoring ack from null participant source id=${i}`);else 5===this.controlState?(this._logger.info(`controlState: ${Sp(this.controlState)}, about to be changed to: ${Sp(0)}`),this.controlState=0,this._resetControllerParticipant(),this._terminateControlPromise?(this._terminateControlPromise.resolve(),this._cancelTerminateControlTimer()):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck action=${fp(e.action)}`)):this._logger.warn(`Unexpected ack in control controlState=${Sp(this.controlState)}`)}_handleTerminate(e,t,i){let n;this._isViewing()?(this._teardownViewerRemoteControl(),n=hp):(this._teardownSharerRemoteControl(),t?n=t.id:this._logger.error("Got terminate message but could not find a sender participant!")),this._logger.info(`controlMessage action: ${fp(e.action)}, controllerId: ${n}`),this._logger.info(`controlState: ${Sp(this.controlState)}, about to be changed to: ${Sp(0)}`),this.controlState=0,this._resetControllerParticipant();const r={inControl:!1,id:n,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(r),8===e.action&&this._sendRequest({action:5,terminatedReason:0},i)}_handleAvailableAck(e){this._terminateAvailableHandshake&&(this._logger.info(`_handleAvailableAck: terminate available handshake reason: 1,handshakeId: ${e.handshakeId}`),this._terminateAvailableHandshake(1,e.handshakeId)),2===this.role?this._raiseScreenSharingControlCapableEvent(!0,hp):this._logger.info(`Ignoring AvailableAck as viewer session is not initialized, role: ${this.role}`)}_handleAvailableNack(e){this._logger.info(`_handleAvailableNack: action=${fp(e.action)} terminate reason: ${vp(e.terminatedReason)}`),this._viewerSessionLastTerminatedReason=e.terminatedReason,this._recordViewerSessionTelemetry((t=>{t.updateOperationData("AvailableHandshake",{nackReason:e.terminatedReason},e.handshakeId)})),10!==e.terminatedReason?(this._terminateAvailableHandshake&&(this._terminateAvailableHandshake(this._getAvailableHandshakeTerminatedFromControlTerminated(e.terminatedReason),e.handshakeId),this._logger.info(`_handleAvailableNack: terminateAvailableHandshake reason=${vp(e.terminatedReason)}`)),1===e.terminatedReason?(this._logger.warn("_handleAvailableNack: control terminate reason: SharerDenied"),this._raiseScreenSharingControlCapableEvent(!0,hp,!0)):this._raiseScreenSharingControlCapableEvent(!1,hp)):this._logger.warn("_handleAvailableNack: control terminate reason: UnknownSender")}_handleRenderedAtViewer(e,t){this._raiseRenderedAtViewer&&(t?(this._logger.info(`raiseRenderedAtViewer senderId=${t.id}, action=${fp(e.action)}`),this._raiseRenderedAtViewer(t.id)):this._logger.error("Got RenderedAtViewer message but could not find a sender participant!"))}_processProtocolMessage(e,t,i,n){let r;this._recordProtocolMessage(t,n);try{r=JSON.parse(e)}catch(e){return void this._logger.error("Error parsing controlMessage")}switch(t||this._logger.warn(`protocol message from unknown sender with sourceId=${n}`),this._logger.info(`_processProtocolMessage action=${fp(r.action)}, sourceId=${n}`),r.action){case 0:this._handleAvailableRequest(r,t,n);break;case 1:this._handleControlRequest(t,n,i);break;case 3:this._handleAcceptRequest(r,n);break;case 4:this._handleRejectRequest(r);break;case 2:this._handleCancelControlRequest(r,n);break;case 6:this._handleGiveControl(r,n,t);break;case 5:this._handleAck(r,t,n);break;case 8:case 7:this._handleTerminate(r,t,n);break;case 9:this._handleAvailableAck(r);break;case 10:this._handleAvailableNack(r);break;case 11:this._handleRenderedAtViewer(r,t);break;default:this._logger.error(`Unknown request action received on control protocol data sink, action=${fp(r.action)}`)}}_getAvailableHandshakeTerminatedFromControlTerminated(e){switch(e){case 10:return 6;case 1:return 7;default:return 0}}_sendRequest(e,t){if(t<0)return this._logger.warn(`Unexpected: invalid sourceID=${t}`),!1;this._logger.info(`_sendRequest() action=${fp(e.action)} recipient sourceid=${t}`);const i={type:0,message:JSON.stringify(e)},n=[t];return this._dataChannelAdapter.sendProtocolMessage(function(e){const t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i}(JSON.stringify(i)),n),!0}async processControlMessage(e,t){if(t===this._controllerSourceId){if(3===this.controlState)return this._processControlMessage(e,t);this._logger.debug(`Ignoring control message, wrong controlState. Expected: RemoteControlling, got: ${Sp(this.controlState)}`)}else this._logger.debug(`Ignoring control message, wrong sourceId. Expected: ${t}, got: ${this._controllerSourceId}`)}_processControlMessage(e,t){return this._controlInjector.injectRawInput(e,t)}_resetControlState(){this._logger.info("_resetControlState()"),this.controlState=0,this._resetControllerParticipant(),this._sharerParticipant=null,this._clearControlRequest(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer()}_setupSharerRemoteControl(e){this._logger.info(`_setupSharerRemoteControl() sourceId=${e}`),this._controllerSourceId=e,this._controlInjector.showVirtualCursor(e).catch((t=>{const i={reason:3,detail:JSON.stringify({sourceId:e,errorMsg:t})};this.event("sharingControlError").raise(i)}))}_teardownSharerRemoteControl(){this._logger.info("_teardownSharerRemoteControl()"),this._controllerSourceId=null,this._controlInjector.showVirtualCursor(0).catch((e=>{const t={reason:3,detail:JSON.stringify({sourceId:0,errorMsg:e})};this.event("sharingControlError").raise(t)}))}_setupViewerRemoteControl(){this._logger.info("_setupViewerRemoteControl()"),this._setCapturerMode(3)}_teardownViewerRemoteControl(){this._logger.info("_teardownViewerRemoteControl()"),this._setCapturerMode(0)}_clearCapturerEventSubscriptions(){this._logger.info("_clearCapturerEventSubscriptions()"),this._captureEventSubscription&&(this._captureEventSubscription.dispose(),this._captureEventSubscription=null),this._mouseControlEventSubscription&&(this._mouseControlEventSubscription.dispose(),this._mouseControlEventSubscription=null),this._keyboardControlEventSubscription&&(this._keyboardControlEventSubscription.dispose(),this._keyboardControlEventSubscription=null)}sendRemoteControlEvent(e,t){if(t)switch(e){case"mouseControlEvent":this._sendControlEvent(qg.encodeMouseEvent(t));break;case"keyboardControlEvent":this._sendControlEvent(qg.encodeKeyboardEvent(t));break;default:return void this._logger.error("sendRemoteControlEvent: Invalid type=",e)}else this._logger.error("sendRemoteControlEvent: Invalid argument.")}_sendControlEvent(e){if(!this._isDataChannelActive()||!this._sharerParticipant||4!==this.controlState)return void this._logger.error(`_sendControlEvent: Dropping message - No data channel or wrong controlState. dataConnected: ${this._isDataChannelActive()} controlState: ${Sp(this.controlState)})`);const t=[this._getSharerDataSourceId()];this._dataChannelAdapter.sendControlMessage(e,t)}_setCapturerMode(e){this._logger.info(`_setCapturerMode() capturerMode=${e}`),this._controlCapturer?(this._controlCapturer.setCaptureMode(e),this._clearCapturerEventSubscriptions(),1===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{0===e&&this.event("sharingRendererClicked").raise()})):2===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{1===e?this.event("sharingRendererMouseEntering").raise():2===e&&this.event("sharingRendererMouseLeaving").raise()})):3===e&&(this._mouseControlEventSubscription=this._controlCapturer.on("mouseControlEvent",(e=>{this._sendControlEvent(qg.encodeMouseEvent(e))})),this._keyboardControlEventSubscription=this._controlCapturer.on("keyboardControlEvent",(e=>{this._sendControlEvent(qg.encodeKeyboardEvent(e))})),this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{1===e?this.event("sharingRendererMouseEntering").raise():2===e&&this.event("sharingRendererMouseLeaving").raise()})))):this._logger.info("_controlCapturer not set, relying on external controlCapturer")}setPointerImage(e,t){return this._logger.warn("setPointerImage is deprecated. Use setLocalPointerImage or setRemotePointerImage"),e?this.setRemotePointerImage(e,t):this.setLocalPointerImage(t)}setLocalPointerImage(e){return 0===e.length?Promise.reject(new Error("setLocalPointerImage invalid image length")):this._setPointerImage(0,e)}async setRemotePointerImage(e,t){if(!e)throw new Error("setRemotePointerImage participant is null");if(0===t.length)throw new Error("setRemotePointerImage invalid image length");const i=this._getParticipantsDataSourceIds(e);if(0===i.length)throw new Error("setRemotePointerImage unable to map participant to sourceIds");this._logger.info(`set pointer image for ${i.length} sources`);for(const e of i)await this._setPointerImage(e,t)}_setPointerImage(e,t){return this._isSharing()||this._logger.warn("_setPointerImage called when not sharing"),this._controlInjector.setPointerImage(e,t)}startPointerMode(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`startPointerMode called in bad control controlState=${Sp(this.controlState)}`)):this._isViewing()?Si((()=>{this._setCapturerMode(2)})):Promise.reject(new Error("startPointerMode when not viewing")):Promise.reject(new Error("startPointerMode when data channel not active")):Promise.reject(new Error("startPointerMode when feature not enabled"))}stopPointerMode(){return 0!==this.controlState?Promise.reject(new Error(`stopPointerMode called in bad control controlState=${Sp(this.controlState)}`)):this._isViewing()?Si((()=>{this._setCapturerMode(1)})):Promise.reject(new Error("stopPointerMode when not viewing"))}_startAvailableHandshake(){const e=this._getSharerDataSourceId(),t=xi(),i=this._getHandshakeDelay(),n=Math.floor(Math.random()*i);if(this._logger.info(`_startAvailableHandshake() - handshakeId: ${e}:${t} ${n>0?`delay: ${n}ms maxDelay: ${i}ms`:""}}`),this._terminateAvailableHandshake&&(this._logger.warn("Replacing existing availble handshake"),this._terminateAvailableHandshake(4)),this._recordViewerSessionTelemetry((e=>e.recordOperation("AvailableHandshake",t))),e<0)this._logger.warn(`_startAvailableHandshake() - sharer: ${we(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(t);else{const r=()=>{this.event("controlAvailableHandshake").raise(t,e,1),this._sendRequest({action:0,terminatedReason:0,handshakeId:t},e)||this._logger.error("Failed to send Available message to sharer, will retry after backoff"),this._waitForAvailableAck(t)};n>0?(this._delayedSendHandshakeTimer=window.setTimeout(r,n),this._recordViewerSessionTelemetry((e=>{e.updateOperationData("AvailableHandshake",{delay:n,maxDelay:i},t)}))):r()}this._availableHandshakeSent=!0,this._terminateAvailableHandshake=(i=0,n)=>{this._logger.info(`_terminateAvailableHandshake() - handshakeId: ${e}:${t}, status: ${i}`),this._recordViewerSessionTelemetry((e=>{e.updateOperationData("AvailableHandshake",{tries:this._retryAttempt},n)})),1===i?this._recordViewerSessionTelemetry((e=>{e.recordOperationSuccess("AvailableHandshake",null,"",n)})):(this._logger.error(`GTC handshake terminated with code ${i}, last terminated reason: ${vp(this._viewerSessionLastTerminatedReason)}`),lp.RootToolsManager.logExternalForDDL(`GTC handshake terminated with code ${i},`,this._viewerSessionLastTerminatedReason.toString()),this._recordViewerSessionTelemetry((e=>{e.recordOperationFailure("AvailableHandshake",{reason:i},"",n)}))),this._terminateAvailableHandshake=null,this.event("controlAvailableHandshake").raise(t,e,1===i?5:6,i),n&&n!==t&&this._logger.warn(`AvailableSeries: Got handshake from another series - expected: ${t}, received: ${n}`),this._availableAckTimer&&(clearTimeout(this._availableAckTimer),this._availableAckTimer=null),this._delayedSendHandshakeTimer&&(clearTimeout(this._delayedSendHandshakeTimer),this._delayedSendHandshakeTimer=null),this._retryAttempt=0}}_waitForAvailableAck(e){this._logger.info("_waitForAvailableAck()"),this._availableAckTimer=window.setTimeout((()=>{this._logger.warn(`No Ack received for Available message from attempt=${this._retryAttempt}`),this._availableAckTimer=null;const t=this._getSharerDataSourceId();if(this._retryAttempt<=6)t>=0?(this._logger.info(`Re-sending Available message handshakeId: ${t}:${e}`),this.event("controlAvailableHandshake").raise(e,t,2),this._sendRequest({action:0,terminatedReason:0,handshakeId:e},t)):this._logger.warn(`_waitForAvailableAck() - sharer: ${we(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(e);else if(this._logger.error("Reached Available retry limit! Control capability will be false"),this._terminateAvailableHandshake)this._terminateAvailableHandshake(5);else{const e={reason:4,detail:JSON.stringify({sourceId:t,errorMsg:`Timed out after ${this._retryAttempt} tries`})};this.event("sharingControlError").raise(e)}}),2e3*++this._retryAttempt)}requestControl(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`requestControl called in bad controlState=${Sp(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while requesting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while requesting control")):this._requestControl():Promise.reject(new Error("requestControl unexpected null sharer")):Promise.reject(new Error("requestControl when not viewing")):Promise.reject(new Error("requestControl when data channel not active")):Promise.reject(new Error("requestControl when feature not enabled"))}_requestControl(){this._logger.info(`_requestControl(), controlState: ${this.controlState}`),this._requestControlPromise=vi();const e=()=>{this._requestControlPromise=null};this._requestControlPromise.promise.then(e,e);const t=this._getSharerDataSourceId();if(!this._sendRequest({action:1,terminatedReason:0},t)){const e={inControl:!1,id:hp,terminatedReason:7};return this._requestControlPromise.reject(new Error),this._logger.error("_requestControl(): failed to send the request."),Promise.reject(new Error(JSON.stringify({controlInfo:e,details:""})))}return this._recordViewerSessionTelemetry((e=>e.recordOperation("ControlRequest",""))),this.controlState=1,this._requestControlTimer=window.setTimeout((()=>{if(1===this.controlState){this.controlState=0,this._logger.warn("No response to control request - canceling"),this._sendRequest({action:2,terminatedReason:2},t)||this._logger.error("Failed to send the cancel control request");const e={inControl:!1,id:hp,terminatedReason:2};this._recordViewerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",null)})),this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:"we did not get any response to the control - terminating control"}))):this._logger.error("Unexpected, no promise could be resolved - controlState=RequestSent")}else this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control - times out in bad state - do nothing"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Sp(this.controlState)}`);this._requestControlTimer=null}),3e4),this._requestControlPromise.promise}_cancelRequestControlTimer(){this._requestControlTimer&&(this._requestControlPromise&&this._requestControlPromise.reject(new Error("cancelled by _cancelRequestControlTimer")),clearTimeout(this._requestControlTimer),this._requestControlTimer=null)}cancelControl(){return this._enabled?this._isDataChannelActive()?1!==this.controlState?Promise.reject(new Error(`cancelControl called in bad state=${Sp(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while cancelling control")):this._cancelControl():Promise.reject(new Error("Request control promise has been resolved while cancelling control")):Promise.reject(new Error("cancelControl unexpected null sharer")):Promise.reject(new Error("cancelControl when not viewing")):Promise.reject(new Error("cancelControl when data channel not active")):Promise.reject(new Error("cancelControl when feature not enabled"))}_cancelControl(){this._logger.info("_cancelControl()");const e=this._getSharerDataSourceId();if(1!==this.controlState)return Promise.reject(new Error("Cancel control - in bad state - do nothing"));if(this._cancelRequestControlTimer(),this.controlState=0,this._logger.info("Viewer cancels the control"),!this._sendRequest({action:2,terminatedReason:8},e))return Promise.reject(new Error("Failed to send cancel control request"));{const e={inControl:!1,id:hp,terminatedReason:8};this._recordViewerSessionTelemetry((t=>{t.recordOperationFailure("ControlRequest",{reason:vp(e.terminatedReason)})})),this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:""})))}return new Promise(((e,t)=>{e()}))}acceptControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while accepting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while accepting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while accepting control")):this._acceptControlRequest():Promise.reject(new Error("acceptControlRequest when not sharing")):Promise.reject(new Error("acceptControlRequest while no control request pending")):Promise.reject(new Error("acceptControlRequest when data channel not active")):Promise.reject(new Error("acceptControlRequest when feature not enabled"))}_acceptControlRequest(){this._logger.info("_acceptControlRequest()"),this._acceptControlPromise=vi();const e=()=>{this._acceptControlPromise=null};if(this._acceptControlPromise.promise.then(e,e),this._controllerParticipant){this._logger.warn("_acceptControlRequest called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const e=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},e)||this._logger.error("Failed to send the terminateNoAck request"),this._resetControllerParticipant()}const t=this._getDataSourceIdForParticipantLeg(this._controlRequest),i=this._controlRequest.participant.id;return this._sendControlAcceptRequest(t)?(this._resetControllerParticipant(this._controlRequest),this._clearControlRequest(),this.controlState=2,this._acceptControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",{participantId:t},String(t))})),this._logger.error("No ack received when accepting control request - terminating control"),this._sendRequest({action:7,terminatedReason:4},t)||this._logger.error("Failed to send the TerminateNoAck request");const e={inControl:!1,id:i,terminatedReason:4};this.event("sharingControlChanged").raise(e),this._acceptControlPromise?this._acceptControlPromise.reject(new Error("No ack received when accept control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._acceptControlPromise?this._acceptControlPromise.reject(new Error("accept control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Sp(this.controlState)}`);this._acceptControlTimer=null}),dp),this._acceptControlPromise.promise):(this._logger.error("Failed to send the accept control request"),this._acceptControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the accept control request!")))}_sendControlAcceptRequest(e){const t=this._sendRequest({action:3,terminatedReason:0},e);return this._recordSharerSessionTelemetry((t=>{t.updateOperationData("ControlRequest",{status:"accepting",participantId:e},null,String(e))})),t}_sendControlRejectRequest(e,t){const i=this._sendRequest({action:4,terminatedReason:e},t);return this._recordSharerSessionTelemetry((i=>{i.recordOperationFailure("ControlRequest",{participantId:t,reason:vp(e)},String(t))})),i}_cancelAcceptControlTimer(){this._acceptControlTimer&&(this._acceptControlPromise&&this._acceptControlPromise.reject(new Error("cancelled by _cancelAcceptControlTimer")),clearTimeout(this._acceptControlTimer),this._acceptControlTimer=null)}denyControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while denying control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while denying control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while denying control")):this._denyControlRequest():Promise.reject(new Error("denyControlRequest when not sharing")):Promise.reject(new Error("denyControlRequest while no control request pending")):Promise.reject(new Error("denyControlRequest when data channel not active")):Promise.reject(new Error("denyControlRequest when feature not enabled"))}_denyControlRequest(){this._logger.info("_denyControlRequest()");const e=this._getDataSourceIdForParticipantLeg(this._controlRequest);return this._clearControlRequest(),this._sendControlRejectRequest(1,e)?Promise.resolve():Promise.reject(new Error("Failed to send the deny control requst"))}grantControl(e){return this._enabled?this._isDataChannelActive()?this._controlRequest?Promise.reject(new Error("grantControl called while control request pending")):this._isSharing()?e?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while granting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while granting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while granting control")):this._grantControl(e):Promise.reject(new Error("grantControl null participant")):Promise.reject(new Error("grantControl when not sharing")):Promise.reject(new Error("grantControl when data channel not active")):Promise.reject(new Error("grantControl when feature not enabled"))}_grantControl(e){this._logger.info("_grantControl()"),this._grantControlPromise=vi();const t=()=>{this._grantControlPromise=null};if(this._grantControlPromise.promise.then(t,t),3===this.controlState){if(this._controllerParticipant.participant===e)return this._logger.warn("_grantControl called for participant who already has control"),this._grantControlPromise.resolve(),new Promise(((e,t)=>{e()}));{this._logger.warn("_grantControl called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const e=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},e)||this._logger.error("Failed to send the terminateNoAck request")}}const i=this._mapParticipantToSourceId(e),n=this._sendRequest({action:6,terminatedReason:0},i);if(this._recordSharerSessionTelemetry((e=>{e.recordOperation("GiveControl",null)})),!n)return this._logger.error("Failed to send the grant control request"),this._grantControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));const r=this._getParticipantIdForDataSourceId(e,i);return this._resetControllerParticipant({participant:e,participantState:e.state,participantId:r}),this.controlState=2,this._grantControlTimer=window.setTimeout((()=>{2===this.controlState?(this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when granting control - terminating control"),this._sendRequest({action:7,terminatedReason:4},i)||this._logger.error("Failed to send the terminateNoAck request"),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("GiveControl",null)})),this._grantControlPromise?this._grantControlPromise.reject(new Error("No ack received when granting control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")):this._grantControlPromise?this._grantControlPromise.reject(new Error("Grant control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Sp(this.controlState)}`),this._grantControlTimer=null}),dp),this._grantControlPromise.promise}_cancelGrantControlTimer(){this._grantControlTimer&&(this._grantControlPromise&&this._grantControlPromise.reject(new Error("cancelled by _cancelGrantControlTimer")),clearTimeout(this._grantControlTimer),this._grantControlTimer=null)}_mapParticipantToSourceId(e){return this._dataChannelAdapter.isActive()?xd(e,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getParticipantsDataSourceIds(e){const t=[];try{if(e?.endpoints?.endpointDetails){if(1===e.endpoints.endpointDetails.length){const i=e.endpoints.endpointDetails[0];if(!i?.mediaStreams)return t.push(En),t}for(const i of e.endpoints.endpointDetails)if(i?.mediaStreams)for(const e of i.mediaStreams)if(3===Od(e.type)){if(t.push(e.sourceId),t.length>=8)return this._logger.error("Excessive amount of data streams"),t;break}}}catch(e){this._logger.error(`_getParticipantsDataSourceIds caught exception error=${e}`)}return t}_getParticipantIdForDataSourceId(e,t){return Ud(e,3,t)}_getDataSourceIdForParticipantId(e,t){return this._dataChannelAdapter.isActive()?function(e,t,i){if(!e||!e.endpoints)return-1;const n=e.endpoints.endpointDetails.find((e=>e?.participantId===t));if(!n)return xd(e,i);if(!n.mediaStreams)return xd(e,i);const r=n.mediaStreams.find((({type:e})=>Od(e)===i));return r?r.sourceId:-1}(e,t,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getDataSourceIdForParticipantLeg(e){return this._getDataSourceIdForParticipantId(e.participant,e.participantId)}_getSharerDataSourceId(){const e=Vd(this._sharerParticipant);return e?this._getDataSourceIdForParticipantId(this._sharerParticipant,e):(this._logger.warn("Unable to identify the sharer participantId, falling back to first data channel"),this._mapParticipantToSourceId(this._sharerParticipant))}terminateControl(){if(this._isViewing()){if(4!==this.controlState)return Promise.reject(new Error("terminateControl called while not in control"));if(!this._sharerParticipant)return Promise.reject(new Error("terminateControl called but _sharerParticipant is null"))}else{if(!this._isSharing())return Promise.reject(new Error("terminateControl called but not sharing nor viewing"));if(!this._controllerParticipant)return Promise.reject(new Error("terminateControl called but controllerParticipant is null"))}return this._requestControlPromise?Promise.reject(new Error("Request control promise has not been resolved yet while terminating control")):this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while terminating control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while terminating control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while terminating control")):this._terminateControl()}_terminateControl(e=!0){this._logger.info("_terminateControl()"),this._terminateControlPromise=vi();const t=()=>{this._terminateControlPromise=null};this._terminateControlPromise.promise.then(t,t);let i=0;const n=e?8:7;let r,s;if(this._isViewing()){if(4!==this.controlState)return this._logger.error("Local viewer called terminateControl when not controlling"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local viewer called terminateControl when not controlling"));this._teardownViewerRemoteControl(),i=6,r=this._getSharerDataSourceId(),s=hp,this._logger.info(`Terminating remote control reason: ${i},  recipient: ${r}, controllerId: ${s}`)}else{if(3!==this.controlState||!this._controllerParticipant)return this._logger.error("Local sharer called terminateControl when no one is in control"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local sharer called terminateControl when no one is in control"));this._teardownSharerRemoteControl(),i=5,r=this._getDataSourceIdForParticipantLeg(this._controllerParticipant),s=this._controllerParticipant.participant.id,this._logger.info(`Terminating control on the sharer side, reason: ${i}, recipient: ${r}, controllerId: ${s}`)}if(!this._sendRequest({action:n,terminatedReason:i},r)){if(e)return this._logger.error("Failed to send the terminate control request"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));this._logger.error("Failed to send the terminateNoAck request")}this.controlState=e?5:0;const a={inControl:!1,id:s,terminatedReason:i};return this._logger.info(`raising event sharingControlChanged reason=${a.terminatedReason} controlState=${this.controlState}`),this.event("sharingControlChanged").raise(a),e?(this._terminateControlTimer=window.setTimeout((()=>{5===this.controlState?(this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when terminating control - resending terminate request"),this._sendRequest({action:7,terminatedReason:4},r)||this._logger.error("Failed to send the terminateNoAck request"),this._terminateControlPromise?this._terminateControlPromise.reject(new Error("No ack received when terminating control - resending terminate request")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck")):this._terminateControlPromise?this._terminateControlPromise.reject(new Error("terminate control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Sp(this.controlState)}`),this._terminateControlTimer=null}),dp),this._terminateControlPromise.promise):(this._terminateControlPromise.resolve(),new Promise(((e,t)=>{e()})))}_cancelTerminateControlTimer(){this._terminateControlTimer&&(this._terminateControlPromise&&this._terminateControlPromise.reject(new Error("cancelled by _cancelTerminateControlTimer")),clearTimeout(this._terminateControlTimer),this._terminateControlTimer=null,this._logger.info("_cancelTerminateControlTimer()"))}_disposeControlCapturer(e=Te()){this._logger.info(`_disposeControlCapturer causeId: ${e}`),this._clearCapturerEventSubscriptions(),this._controlCapturer&&(this._controlCapturer.dispose(e),this._controlCapturer=null)}dispose(e){this._logger.info(`dispose causeId: ${e}`),this._dataChannelAdapter.dispose(e),this._resetControlState(),this._disposeRenderer(e),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._call=null,this._resetParticipantSubscriptions(),this._finalizeViewerSessionTelemetry("Shutdown"),this._finalizeSharerSessionTelemetry("Shutdown"),super.dispose(e)}};function fp(e){switch(e){case 0:return"Available";case 1:return"ControlRequest";case 2:return"CancelControlRequest";case 3:return"AcceptRequest";case 4:return"RejectRequest";case 5:return"Ack";case 6:return"GiveControl";case 7:return"TerminateNoAck";case 8:return"Terminate";case 9:return"AvailableAck";case 10:return"AvailableNack";case 11:return"RenderedAtViewer";default:return"Unknown"}}function Sp(e){switch(e){case 0:return"None";case 1:return"RequestSent";case 2:return"WaitingForControlAck";case 3:return"RemoteControlling";case 4:return"LocalControlling";case 5:return"WaitingForTerminateAck";default:return"Unknown"}}function vp(e){switch(e){case 0:return"None";case 1:return"SharerDenied";case 2:return"SharerNoResponse";case 3:return"SharerBusy";case 4:return"AckTimeout";case 5:return"SharerTerminated";case 6:return"ViewerTerminated";case 7:return"DataChannelError";case 8:return"ViewerCancelled";case 9:return"SharerControlDisabled";case 10:return"UnknownSender";default:return"Unknown"}}var yp=(e=>(e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.MIDDLE=2]="MIDDLE",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(yp||{}),Cp=(e=>(e[e.SCAN_CODE=0]="SCAN_CODE",e[e.VIRTUAL_KEY=1]="VIRTUAL_KEY",e[e.RECOGNITION_INPUT=2]="RECOGNITION_INPUT",e))(Cp||{}),_p=class{constructor(e){this.logger=e}toEdgeControlMouseEvent(e){let t;switch(e.type){case 0:return{event:this.toMouseMoveEvent(e),apiName:"injectMouseMoveEvent"};case 1:return{event:this.toMouseWheelEvent(e),apiName:"injectMouseWheelEvent"};case 2:return{event:this.toMouseButtonPressedEvent(e),apiName:"injectMouseButtonEvent"};default:throw t=`Uncovered mouse control event type. Event: ${e}`,this.logger.error(t),Error(t)}}toEdgeControlKeyboardEvent(e){return{event:{repeat:e.repeat,keyUp:e.keyUp,codeType:Cp[e.codeType],keyCode:e.code},apiName:"injectKeyEvent"}}toMouseMoveEvent(e){return{xPos:e.xPos,yPos:e.yPos}}toMouseWheelEvent(e){return{wheelButtonDown:e.wheelButtonDown,wheelRotation:e.wheelRotation}}toMouseButtonPressedEvent(e){return{xPos:e.xPos,yPos:e.yPos,button:yp[e.buttonType],buttonDown:e.buttonDown}}};async function Ep(e,t,i){return new Promise(((n,r)=>{const s=Buffer.from(e,"base64"),a=document.createElement("canvas").getContext("2d"),o=new Blob([s],{type:"image/png"});let c=new Image;c.onload=()=>{a.drawImage(c,0,0,c.width,c.height,0,0,t,i);const e=a.getImageData(0,0,t,i);window.URL.revokeObjectURL(c.src),c=null,n(Array.from(e.data))},c.onerror=e=>{r(e)},c.src=window.URL.createObjectURL(o)}))}var Tp="ncbjelpjchkpbikbpkcchkhkblodoama",Ip=class{constructor(e){this.logger=e}async sendInjectInputEventMessage(e,t){return this.logger.info("EdgeControlInjectorApi - sendInjectInputEventMessage"),new Promise(((i,n)=>{window.top.chrome.runtime.sendMessage(Tp,{api:e,deviceId:this.virtualInputDeviceId,event:t},(e=>{e.error?n(e.error.message):i(0)}))}))}async createInputDeviceId(e,t,i){this.virtualInputDeviceId&&this.logger.warn("EdgeControlInjectorApi - createInputDeviceId virtual input already exists.");try{this.virtualInputDeviceId=await this.sendCreateInputDeviceMessage(e,i)}catch(e){this.logger.error(`EdgeControlInjectorApi - createInputDevice failed, error: ${JSON.stringify(e)}`),t()}}async sendSetLocalUserAvatarMessage(e){const t=await this.generateAvatarBitmap(e);return new Promise(((e,i)=>{const n=window.top;t&&n.chrome.runtime.sendMessage(Tp,{api:"setLocalUserAvatar",avatarBitmap:t},(t=>{t.error?i(t.error.message):e()}))}))}async sendCloseVirtualInputDeviceMessage(){const e=this.virtualInputDeviceId;return e?(this.logger.info("EdgeControlInjectorApi - sendCloseVirtualInputDeviceMessage called"),new Promise(((t,i)=>{const n=window.top;n.chrome.runtime.sendMessage(Tp,{api:"closeInputDevice",deviceId:e},(e=>{e?e.error?i(e.error.message):(this.virtualInputDeviceId=null,t(e.deviceId)):i(n.chrome.runtime.lastError.message)}))}))):(this.logger.info("EdgeControlInjectorApi - VirtualInputDevice does not exists, nothing to close."),Promise.resolve())}async sendCreateInputDeviceMessage(e,t){this.logger.info("EdgeControlInjectorApi - sendCreateInputDeviceMessage called");const i=await this.generateAvatarBitmap(t);return new Promise(((t,n)=>{const r=window.top,s=e=>{e?e.deviceId?t(e.deviceId):e.error?n(e.error.message):n("Error: Unexpected response from API"):n(r.chrome.runtime.lastError.message)};i?r.chrome.runtime.sendMessage(Tp,{api:"createInputDevice",mediaStreamTrackId:e,avatarBitmap:i},s):r.chrome.runtime.sendMessage(Tp,{api:"createInputDevice",mediaStreamTrackId:e},s)}))}async generateAvatarBitmap(e){if(!e)return null;try{const t=32;return{width:t,height:t,data:await Ep(e,t,t)}}catch(e){return this.logger.error(`EdgeControlInjectorApi - generateAvatarBitmap error: ${JSON.stringify(e)}, continue without avatar.`),null}}};var bp=class{constructor(e,t,i){this.logger=e,this.sharingTrackId=t,this.onInitErrorCallback=i,this.images=new Map,this.controlEventConverter=new _p(e),this.edgeApi=new Ip(this.logger)}showVirtualCursor(e,t){if(this.logger.info(`EdgeControlInjector - showVirtualCursor, id: ${e} sharingTrackId: ${this.sharingTrackId}`),t){this.edgeApi.createInputDeviceId(this.sharingTrackId,this.onInitErrorCallback,this.images[e]);const t=this.images[0];t?this.edgeApi.sendSetLocalUserAvatarMessage(t):this.logger.error("EdgeControllerInjector - local avatar is missing, continue without local avatar")}else this.edgeApi.sendCloseVirtualInputDeviceMessage()}setAvatar(e,t){this.logger.info(`${e} EdgeControlInjector - setAvatar, id: ${e}, data: ${JSON.stringify(t)}`),this.images[e]=t}async injectMouseEvent(e,t){this.logger.info(`${e} EdgeControlInjector - injectMouseEvent ${JSON.stringify(t)}`);const i=this.controlEventConverter.toEdgeControlMouseEvent(t);return this.edgeApi.sendInjectInputEventMessage(i.apiName,i.event)}async injectKeyboardEvent(e,t){const i=this.controlEventConverter.toEdgeControlKeyboardEvent(t);return this.edgeApi.sendInjectInputEventMessage(i.apiName,i.event)}injectClipboardText(e,t){return this.logger.info(`${e} EdgeControlInjector - injectClipboardText is unimplemented`),Promise.resolve(0)}dispose(e){this.logger.info("EdgeControlInjector - dispose"),this.edgeApi.sendCloseVirtualInputDeviceMessage()}},Ap=class{constructor(e){this.logger=e,this.activeSourceId=0,this.edgeVirtualInputSupported=!1,this.pendingPointerImages=new Map,this.logger.info("ControlInjectorAdapter"),"EdgeAnaheim"===ri().name&&async function(e){return new Promise(((t,i)=>{e.info("EdgeControlInjectorApi - sendIsVirtualInputSupportedMessage");const n=window.top;n.chrome.runtime.sendMessage(Tp,{api:"isVirtualInputSupported"},(e=>{e?e.error?t(e.error.message):t(e):i(n.chrome.runtime.lastError?.message)}))}))}(e).then((t=>{this.edgeVirtualInputSupported=t,e.info(`ControlInjectorAdapter - Edge supports virtual input device: ${JSON.stringify(this.edgeVirtualInputSupported)}`)})).catch((t=>{e.info(`ControlInjectorAdapter - Edge IsVirtualInputSupported: ${JSON.stringify(t)}`)}))}enableInjector(e){if(this.injector)return this.logger.error("Control injector already present"),Promise.reject();if("EdgeAnaheim"===ri().name){if(!this.edgeVirtualInputSupported)return this.logger.info("ControlInjectorAdapter - Edge doesn't support give control"),Promise.reject();const t=()=>(this.disableInjector(),this.logger.error("ControlInjectorAdapter - An error occured, control injector is disabled."),Promise.reject());this.injector=new bp(this.logger,e,t),this.logger.info("ControlInjectorAdapter - Edge ControlInjector created")}else window.ControlInjector&&(this.injector=window.ControlInjector(e),this.logger.info("ControlInjectorAdapter - Window ControlInjector created"));return this.pendingPointerImages.forEach(((e,t)=>{this.injector.setAvatar(t,e)})),this.pendingPointerImages.clear(),Promise.resolve()}disableInjector(){return this.injector?(this.logger.info("ControlInjectorAdapter - ControlInjector disposed"),this.injector.dispose(),this.injector=null,Promise.resolve()):(this.logger.error("Control injector not present"),Promise.reject())}setPointerImage(e,t){return this.injector?new Promise((i=>{this.injector.setAvatar(e,t),i()})):(this.pendingPointerImages.set(e,t),Promise.resolve())}showVirtualCursor(e){return this.logger.info(`ControlInjectorAdapter - showVirtualCursor ${e} ${this.activeSourceId}`),this.injector?new Promise((t=>{e?(this.activeSourceId&&this.injector.showVirtualCursor(this.activeSourceId,!1),this.injector.showVirtualCursor(e,!0),this.activeSourceId=e):this.activeSourceId&&(this.injector.showVirtualCursor(this.activeSourceId,!1),this.activeSourceId=0),t()})):(this.logger.error("Control injector not present"),Promise.reject())}injectRawInput(e,t){if(!this.injector)return this.logger.error("Control injector not present"),Promise.reject();const i=this.injector;return new Promise(((n,r)=>{let s,a;const o=qg.decodeEventType(e);switch(o){case 1:s=qg.decodeMouseEvent(e),i.injectMouseEvent(t,s).then((e=>0===e?n():r()));break;case 0:a=qg.decodeKeyboardEvent(e),i.injectKeyboardEvent(t,a).then((e=>0===e?n():r()));break;default:this.logger.error(`Invalid event type in raw input: ${o}`),r()}}))}canBeEnabled(){return"EdgeAnaheim"===ri().name?this.edgeVirtualInputSupported:!!window.ControlInjector}},Rp=class{constructor(e){this.logger=e,this.logger.info("RendererAdapter")}getTarget(e){return e.target}subscribeVideoSizeChangedEvent(e,t){const i=e;return i.streamSize&&t(i.streamSize.width,i.streamSize.height),i.renderer.on("onVideoSizeChanged",t)}subscribeRenderStartedEvent(e,t){return e.renderer.on("onVideoStarted",((e,i)=>t()))}};var wp=class extends We{constructor(e,t){super(e),this.logger=e,this._call=t}isActive(){return!(!this.protocolSendFunc||!this.controlSendFunc)}sendProtocolMessage(e,t){return this.protocolSendFunc?this.protocolSendFunc(e,t):(this.logger.error("Cannot send protocol message, ProtocolHandler hasn't started"),Promise.resolve())}sendControlMessage(e,t){return this.controlSendFunc?this.controlSendFunc(e,t):(this.logger.error("Cannot send control message, ControlHandler hasn't started"),Promise.resolve())}getProtocolHandler(){return{onStarted:async(e,t)=>{this.logger.info(`ProtocolHandler started for ${e}`),this.protocolSendFunc=t,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async e=>{this.logger.info(`ProtocolHandler stopped for ${e}`);const t=this.isActive();this.protocolSendFunc=null,t&&this.event("stateChange").raise(!1)},onDataReceived:async(e,t,i)=>{if(1===e){const e=JSON.parse(function(e){return String.fromCharCode.apply(null,e)}(t)),n=this._call.mapDataChannelSourceIdToParticipant(i);let r;return n&&(r=Ud(n,3,i)),this.event("protocolMessage").raise(e.message,n,r,i)}}}}getControlHandler(){return{onStarted:async(e,t)=>{this.logger.info(`ControlHandler started for ${e}`),this.controlSendFunc=t,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async e=>{this.logger.info(`ControlHandler stopped for ${e}`);const t=this.isActive();this.controlSendFunc=null,t&&this.event("stateChange").raise(!1)},onDataReceived:async(e,t,i)=>{if(2===e)return this.event("controlMessage").raise(t,i)}}}},Pp=class extends mp{constructor(e,t,i,n,r){const s={};try{const e=r.getEcsConfig("SkypeCalling","gtcHandshakeSendDelay");e&&(s.handshakeSendDelay=JSON.parse(e))}catch(t){e.error(`Failed to parse ecs config gtcAvailableAckDelay: ${Ve(t)}`)}super(e.createChild("ScreenSharingControl"),i,n,s),this.dataChannel=t;const a=new Ap(this._logger),o=new Rp(this._logger),c=new wp(this._logger,i);this.setAdapters(a,o,c)}setupDataHandlers(){this.dataChannel.addHandler(1,this.getProtocolHandler()),this.dataChannel.addHandler(2,this.getControlHandler())}startOrStopControlForViewer(e,t,i){e&&"nonInteractive"!==i?.appliedInteractivityLevel?t&&0===this.role&&this.initControlForViewer(t):2===this.role&&this.shutdownControlForViewer()}getProtocolHandler(){return this._dataChannelAdapter.getProtocolHandler()}getControlHandler(){return this._dataChannelAdapter.getControlHandler()}};function Mp(e){switch(e){case 1:return"specified";case 0:return"all";case 3:return"attendees";case 2:return"presenters";case 4:return"self";default:return"none"}}var Dp={};u(Dp,{addReceiveDirectionality:()=>Kp,allowDataChannel:()=>vm,allowProvisionalAnswer:()=>Tm,areNegotiatedDirectionsAcceptable:()=>Zp,areNegotiatedDirectionsFulfilled:()=>em,areSendDirectionsFulfilled:()=>tm,canUseWebrtc1_0:()=>Sm,convertToCodecInfo:()=>Em,getAllowedCodecs:()=>ym,getSendMediaModalities:()=>am,getSimulcastConfigForMediaType:()=>_m,getSrtpInfo:()=>im,hasReceiveDirectionality:()=>Jp,hasSendDirectionality:()=>zp,invertModalities:()=>qp,ipAddressConverter:()=>bm,ipV4RegExp:()=>Hp,ipV6RegExp:()=>$p,ipv4AddressConverter:()=>Rm,ipv6AddressConverter:()=>Am,isOnHold:()=>Yp,isSendModalityAdded:()=>sm,isVersionGreaterOrEqual:()=>Cm,makeReinvitelessContext:()=>wm,mediaTypeToModality:()=>lm,mergeSendModalities:()=>om,modalityToMediaType:()=>cm,negotiateDirectionality:()=>jp,negotiateModalities:()=>Qp,parseCandidateString:()=>rm,preferSdesSrtp:()=>fm,printMediaStream:()=>Im,removeChangedSendDirection:()=>nm,removeSendDirectionality:()=>Wp,scrubConstraints:()=>mm,scrubDevices:()=>pm,scrubObjectExcludingFields:()=>um,scrubObjectFields:()=>hm,scrubSelectedDevices:()=>gm,sendStreamsToModalities:()=>dm});var Op,kp,Np="undefined"!=typeof navigator&&void 0!==navigator.mediaDevices?.getUserMedia,Lp=(e=>(e.AVD="43",e.Citrix="44",e.VMware="45",e))(Lp||{});function xp(e=""){const t=e.match(new RegExp("^SkypeSpaces/(\\d+)/"));t?.length&&Object.values(Lp).includes(t[1])&&(kp=t[1]),"undefined"!=typeof window&&"undefined"!=typeof navigator&&(void 0!==navigator.webkitGetUserMedia&&"undefined"!=typeof webkitRTCPeerConnection&&Up()?(window.RTCPeerConnection=webkitRTCPeerConnection,navigator.getUserMedia=(e,t,i)=>{const n=e=>{e?.deviceId?.exact&&(e.mandatory||(e.mandatory={}),e.mandatory.sourceId=e.deviceId.exact,delete e.deviceId)};return e&&(n(e.audio),n(e.video)),navigator.webkitGetUserMedia(e,t,i)}):Np&&Fp())}function Up(){return!!kp}function Fp(){navigator.getUserMedia=function(e,t,i){return navigator.mediaDevices.getUserMedia(e).then(t).catch(i)}}"undefined"!=typeof window&&"undefined"!=typeof navigator&&(Op=window,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.MediaStream=window.MediaStream||window.webkitMediaStream||window.mozMediaStream||window.msMediaStream,window.AudioContext=window.AudioContext||window.webkitAudioContext);var Vp={window:Op},Bp=class e extends ze{constructor(e){super(),this.isAudioOutputSelectionSupportedValue=!1,e.on("configUpdated",(()=>this.updateConfig())),this.updateConfig(),this.isRollbackSupported()}get isAudioOutputSelectionSupported(){return this.isAudioOutputSelectionSupportedValue}get isBrowserRollbackSupported(){return this.isRollbackSupportedValue}static hasApplyConstraints(){return void 0!==MediaStreamTrack.prototype.applyConstraints}static hasPermissionsApi(){return void 0!==navigator.permissions&&"Firefox"!==ri().name}static get hardwareConcurrency(){return window.navigator.hardwareConcurrency}static get unmaskedGlRenderer(){if(this.renderer)return this.renderer===Qe.MEDIA_ERROR.webGlRendererError?void 0:this.renderer;try{const e=document.createElement("canvas").getContext("webgl"),t=e?.getExtension("WEBGL_debug_renderer_info"),i=t&&e.getParameter(t.UNMASKED_RENDERER_WEBGL);return this.renderer=i,i}catch{return void(this.renderer=Qe.MEDIA_ERROR.webGlRendererError)}}async isRollbackSupported(){let e;try{if(e=Vp.window.RTCPeerConnection&&new Vp.window.RTCPeerConnection({sdpSemantics:"unified-plan"}),e){const t=await e.createOffer();await e.setLocalDescription(t),await e.setLocalDescription({type:"rollback"}),this.isRollbackSupportedValue=!0}}catch(e){this.isRollbackSupportedValue=!1}finally{e?.close()}}static async isCodecsSupported(e){const t={format:"annexb"},i=["no-preference","prefer-software","prefer-hardware"],n=[];for(const r of e)for(const e of i){const i=await(window.VideoEncoder?.isConfigSupported({codec:r,hardwareAcceleration:e,hevc:t,width:1280,height:720})),s=await(window.VideoDecoder?.isConfigSupported({codec:r,hardwareAcceleration:e,hevc:t}));if(i||s){const e={name:r,mode:i?.config.hardwareAcceleration,encode:i?.supported,decode:s?.supported};n.push(e)}}return n}static async hasH264CodecSupport(e){const t="v=0\no=- 596983 0 IN IP4 127.0.0.1\ns=session\nc=IN IP4 0.0.0.0\nt=0 0\na=msid-semantic: WMS *\nm=video 3480 RTP/SAVPF 107 99\na=rtpmap:107 H264/90000\na=rtpmap:99 rtx/90000\na=fmtp:107 max-fs=240;max-mbps=3600;max-br=208;max-fps=1500;profile-level-id=42C02A;packetization-mode=1\na=fmtp:99 apt=107\na=setup:actpass\na=mid:video\na=recvonly\na=rtcp-mux\na=ice-ufrag:CvYq\na=ice-pwd:axsjsa0GOz3kz6TuGvNgJZWO\na=fingerprint:sha-256 34:DF:5C:15:60:FF:28:3E:E8:96:4B:F8:85:61:E4:C0:57:D1:60:82:21:FD:BC:D2:90:41:06:FA:03:FD:12:A2\n",i=Vp.window.RTCPeerConnection&&new Vp.window.RTCPeerConnection;if(!i)return!1;try{return await i.setRemoteDescription({sdp:"v=0\no=- 596983 0 IN IP4 127.0.0.1\ns=session\nc=IN IP4 0.0.0.0\nt=0 0\na=msid-semantic: WMS *\nm=video 3480 RTP/SAVPF 107 99\na=rtpmap:107 H264/90000\na=rtpmap:99 rtx/90000\na=fmtp:107 max-fs=240;max-mbps=3600;max-br=208;max-fps=1500;profile-level-id=42C02A;packetization-mode=1\na=fmtp:99 apt=107\na=setup:actpass\na=mid:video\na=recvonly\na=rtcp-mux\na=ice-ufrag:CvYq\na=ice-pwd:axsjsa0GOz3kz6TuGvNgJZWO\na=fingerprint:sha-256 34:DF:5C:15:60:FF:28:3E:E8:96:4B:F8:85:61:E4:C0:57:D1:60:82:21:FD:BC:D2:90:41:06:FA:03:FD:12:A2\n",type:"offer"}),!0}catch(t){return e.error("H264 not supported",t),!1}finally{try{i.close()}catch(e){}}}static hasMediaApi(){return navigator.getUserMedia&&"undefined"!=typeof RTCPeerConnection}static hasCapabilitiesApi(){return!!Vp.window.RTCRtpReceiver?.getCapabilities}static isAudioOutputSelectionSupportedByBrowser(){return!!Vp.window?.HTMLAudioElement?.prototype.setSinkId}updateConfig(){const t=e.isAudioOutputSelectionSupportedByBrowser();t!==this.isAudioOutputSelectionSupportedValue&&(this.isAudioOutputSelectionSupportedValue=t,this.event("isAudioOutputSelectionSupportedChanged").raise())}static hasUnifiedPlanSupport(){let e;try{e=Vp.window.RTCPeerConnection&&new Vp.window.RTCPeerConnection({sdpSemantics:"unified-plan"})}catch(e){return!1}let t=!1;return e&&(t=!!e.addTransceiver,e.close()),t}static hasEncodedStreamApi(){return!!RTCRtpReceiver.prototype.createEncodedStreams||e.hasScriptTransformApi()}static hasScriptTransformApi(){return!!window.RTCRtpScriptTransform}static isWakeLockSupported(){return!!window.navigator.wakeLock}},Hp=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(:[0-9]{1,5})?$/),$p=RegExp(/^\[?(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|:((:[0-9a-fA-F]{1,4}){1,5}|:)((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,5}([0-9a-fA-F]{1,4})?:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\]?(?::\d{1,5})?$/);function Gp(e){switch(e){case Qe.MEDIA_STATE.send:return Qe.MEDIA_STATE.receive;case Qe.MEDIA_STATE.receive:return Qe.MEDIA_STATE.send;default:return e}}function jp(e,t){const i=zp(e)&&zp(t),n=Jp(e)&&Jp(t);return i&&n?Qe.MEDIA_STATE.sendReceive:i?Qe.MEDIA_STATE.send:n?Qe.MEDIA_STATE.receive:e===Qe.MEDIA_STATE.inactive&&t||e&&t===Qe.MEDIA_STATE.inactive?Qe.MEDIA_STATE.inactive:void 0}function qp(e){const t={},i=Gp(e.audio);i&&(t.audio=i);const n=Gp(e.video);n&&(t.video=n);const r=Gp(e.sharing);r&&(t.sharing=r);const s=Gp(e.data);return s&&(t.data=s),t}function Wp(e){return e===Qe.MEDIA_STATE.sendReceive?Qe.MEDIA_STATE.receive:void 0}function zp(e){return e===Qe.MEDIA_STATE.send||e===Qe.MEDIA_STATE.sendReceive}function Jp(e){return e===Qe.MEDIA_STATE.receive||e===Qe.MEDIA_STATE.sendReceive}function Kp(e){return Jp(e)?e:e===Qe.MEDIA_STATE.send?Qe.MEDIA_STATE.sendReceive:Qe.MEDIA_STATE.receive}function Yp(e){return!(e.audio!==Qe.MEDIA_STATE.inactive||e.video&&e.video!==Qe.MEDIA_STATE.inactive||e.sharing&&e.sharing!==Qe.MEDIA_STATE.inactive)}function Qp(e,t){const i={},n=jp(e.audio,t.audio);n&&(i.audio=n);const r=jp(e.video,t.video);r&&(i.video=r);const s=jp(e.sharing,t.sharing);s&&(i.sharing=s);const a=jp(e.data,t.data);return a&&(i.data=a),i}function Xp(e,t,i){const n=zp(e)&&zp(t)||!zp(e)&&!zp(i),r=!i||Jp(e)&&Jp(t)||!Jp(e)&&!Jp(i);return n&&r}function Zp(e,t,i){return Xp(e.audio,t.audio,i.audio)&&Xp(e.video,t.video,i.video)&&Xp(e.sharing,t.sharing,i.sharing)&&Xp(e.data,t.data,i.data)}function em(e,t){function i(e,t){const i=zp(e)===zp(t),n=Jp(e)===Jp(t)||Jp(e)&&!t;return i&&n}return i(e.audio,t.audio)&&i(e.video,t.video)&&i(e.sharing,t.sharing)&&i(e.data,t.data)}function tm(e,t){const i=(e,t)=>zp(e)===zp(t);return i(e.audio,t.audio)&&i(e.video,t.video)&&i(e.sharing,t.sharing)&&i(e.data,t.data)}function im(e){const t={dtls:!1,sdes:!1};return t.dtls=!!e.fingerprint,e.media.forEach((e=>{t.dtls=t.dtls||!!e.fingerprint,t.sdes=t.sdes||!!e.crypto})),t}function nm(e,t){if(!t||st(t))return e;const i={};return Xe(e,((e,n)=>{n===Qe.MODALITY.data?i[n]=function(e,t){return zp(e)&&!zp(t)?t:e}(e,t[n]):i[n]=function(e,t){return zp(e)&&!zp(t)?Wp(e)||t:e}(e,t[n])})),i}function rm(e){const t=(e||"").split(" ");return{component:t[1],protocol:t[2],priority:t[3],ip:t[4],port:t[5],type:t[7]}}function sm(e,t){return!zp(e)&&zp(t)}function am(e){return{Audio:zp(e.audio),Video:zp(e.video),ScreenShare:zp(e.sharing),Data:zp(e.data)}}function om(e,t){const i=ot(e);return Xe(e,((e,n)=>{const r=cm(n);zp(e)&&!t[r]&&(i[n]=Wp(e))})),i}function cm(e){switch(e){case"audio":return"Audio";case"video":return"Video";case"sharing":return"ScreenShare";default:return null}}function lm(e){switch(e){case"Audio":return"audio";case"Video":return"video";case"ScreenShare":return"sharing";default:return null}}function dm(e){const t={};return at(e).forEach((i=>t[i]=!!e[i])),t}function hm(e,t,i){if(!e)return e;const n={...e};for(const[r,s]of Object.entries(e))"object"==typeof s?n[r]=hm(s,t):s&&t.includes(r)&&(n[r]=i?i(s):we(s));return n}function um(e,t,i){if(!e)return e;const n={...e};for(const[r,s]of Object.entries(e))"object"==typeof s?n[r]=um(s,t):s&&!t.includes(r)&&(n[r]=i?i(s):we(s));return n}function gm(e){return e?um(e,[]):e}function pm(e,t){if(!e)return e;const i=hm(e,["deviceId","groupId","guid"]);return hm(i,["label"],(e=>_t(e,t)))}function mm(e){return hm(e,["sourceId","deviceId"])}function fm(e){return!(!e.configProvider.config.webrtcForceSdesForS1||!e.configProvider.config.checkSupportForWebrtc_1_0||e.configProvider.mediaConfig.simulcastSessionEnabled)||(e.config.isPstnCall?e.configProvider.config.preferSdesSrtpPstn:e.configProvider.config.preferSdesSrtp)}function Sm(e){return!e||Bp.hasUnifiedPlanSupport()}function vm(e){return!!e.configProvider.mediaConfig.simulcastSessionEnabled&&(e.config.isPstnCall?e.configProvider.config.enableDataChannelPstn:e.configProvider.config.enableDataChannel)}function ym(e,t){switch(t){case Qe.MEDIA_TYPE.audio:return e.config.allowedAudioCodecs;case Qe.MEDIA_TYPE.video:return e.config.allowedVideoCodecs;default:return[]}}function Cm(e,t){const i=t.split(".").map((e=>parseInt(e,10))),n=e.split(".").map((e=>parseInt(e,10)));return n[0]>i[0]||n[0]===i[0]&&n[1]>=i[1]}function _m(e,t){return"Video"===e?t.config.specCompliantSimulcast?.video:"ScreenShare"===e?t.config.specCompliantSimulcast?.sharing:null}function Em(e){return e.map((e=>{const t=e.mimeType.split("/"),i={codec:t[1]||t[0],rate:e.clockRate};return e.channels&&(i.encoding=e.channels),e.sdpFmtpLine&&(i.fmtpLine=e.sdpFmtpLine),i}))}function Tm(e,t=!1){const i=!e.configProvider.config.acceptProvisionalAnswerFromPstnOnly||t;return e.config.isPstnCall?e.configProvider.config.allowProvisionalAnswerPstn&&i:e.configProvider.config.allowProvisionalAnswer}function Im(e){return`${e?.id}:${JSON.stringify(e?.getTracks().map((e=>e.id)))}}`}function bm(e){try{if(Hp.test(e))return Rm(e);if($p.test(e))return Am(e)}catch(t){return e}return e}function Am(e){let t,i=e.lastIndexOf("]")+1,n="",r="";i>0?(t=e.substring(0,i),r=e.substring(i)):(t=e,i=t.length);const s=t.lastIndexOf(":");if(t.includes(".")){const e=Rm(t.substring(s+1,i-1-s));n=t.substring(0,s+1)+e}else s<t.length-1||":"===t[s-1]&&t.match(/:/g).length<7?n=t.substring(0,s+1)+"x":7===t.match(/:/g).length&&(n=t.substring(0,s)+"0:x");return n?r?n+"]"+r:"["===e.substring(0,1)?(n=n.substring(1),n):n:e}function Rm(e){const t=e.substring(0,e.lastIndexOf(".")+1)+"x",i=e.lastIndexOf(":");return i>0?t+e.substring(i):t}function wm(e,t){const i=(t?e?.maxReinvitelessMediaForVideoMultiparty:e?.maxReinvitelessMediaForVideo1on1)||0,n=(t?e?.maxReinvitelessMediaForVBSSMultiparty:e?.maxReinvitelessMediaForVBSS1on1)||0;return{enabled:i>0||n>0,maxStreamsForModality:{video:i,sharing:n}}}var Pm=class extends We{constructor(){super(),this.subs=[]}get streams(){return this.sessionAudioProvider?.streams??[]}get comfortNoiseStream(){return this.sessionAudioProvider?.comfortNoiseStream??null}get active(){return this.sessionAudioProvider?.active??!1}setSessionStreamsProvider(e){this.unsubscribeFromStreamEvents(),this.sessionAudioProvider=e,this.subscribeForStreamEvents(),this.event("onStreamsChanged").raise(),this.event("onActiveStateChanged").raise()}dispose(){super.dispose(),this.unsubscribeFromStreamEvents()}subscribeForStreamEvents(){this.sessionAudioProvider&&this.subs.push(this.sessionAudioProvider.on("onStreamsChanged",(()=>this.event("onStreamsChanged").raise())),this.sessionAudioProvider.on("onStreamSourcesUpdated",(e=>this.event("onStreamSourcesUpdated").raise(e))),this.sessionAudioProvider.on("onActiveStateChanged",(()=>this.event("onActiveStateChanged").raise())))}unsubscribeFromStreamEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}},Mm=class extends We{constructor(e,t,i,n,r){super(),this.allowVirtualDeviceInCall=e,this.defaultDeviceManager=t,this.logger=i,this.callStats=n,this.isMediaSending=r,this.stats=[],this.selectedVirtualDevice={camera:void 0,screenshare:void 0},this.subs=[this.defaultDeviceManager.on("onVirtualDevicesChanged",(()=>this.handleRegisteredDeviceChange()))]}get isVirtualDeviceEnabled(){return this.allowVirtualDeviceInCall}selectDevices(e){const t=this.defaultDeviceManager.getRegisteredDevices(),i=t.find((t=>t.id===e.camera)),n=t.find((t=>t.id===e.screenshare));this.logger.info(`Selecting virtual devices, camera: ${i?.id}, screenshare: ${n?.id}`);const r={camera:this.selectedVirtualDevice.camera?.id,screenshare:this.selectedVirtualDevice.screenshare?.id};e.camera!==r.camera||e.screenshare!==r.screenshare?(this.selectedVirtualDevice={camera:i,screenshare:n},this.addToCallStat({type:"VirtualDeviceSelected",payload:this.selectedVirtualDevice}),this.event("onSelectedVirtualDevicesChanged").raise(e,r)):this.logger.info("Virtual Device did not change.")}getSelectedDevices(){return Object.entries(this.selectedVirtualDevice).reduce(((e,[t,i])=>(e[t]=i?.id,e)),{})}getDeviceManager(e){return this.allowVirtualDeviceInCall?this.getDeviceManagersForVirtualDevice(e)[0]:(this.logger.info(`VirtualDevice not enabled, using default DM, type: ${e}`),this.defaultDeviceManager)}getDeviceManagersForVirtualDevice(e){return"Video"===e&&this.selectedVirtualDevice.camera?(this.logger.info(`Using Virtual Device (DM), type: ${e}`),this.selectedVirtualDevice.camera.getDeviceManagers()):"ScreenShare"===e&&this.selectedVirtualDevice.screenshare?(this.logger.info(`Using Virtual Device (DM), type: ${e}`),this.selectedVirtualDevice.screenshare.getDeviceManagers()):(this.logger.info(`Using default DM, type: ${e}`),[this.defaultDeviceManager])}getDefaultDeviceManager(){return this.defaultDeviceManager}dispose(){this.stats=[],this.subs.forEach((e=>e.dispose())),super.dispose()}hasDevice(e){return this.defaultDeviceManager.id===e||[...this.selectedVirtualDevice.camera?.getDeviceManagers()??[],...this.selectedVirtualDevice.screenshare?.getDeviceManagers()??[]].some((t=>t?.id===e))}addToCallStat(e){const t=this.stats.push(e);this.callStats.appendCallDeviceManagerInfo({events:JSON.stringify(t)})}handleRegisteredDeviceChange(){const e=this.defaultDeviceManager.getRegisteredDevices(),{camera:t,screenshare:i}=this.selectedVirtualDevice;let n=!1,r=!1;t&&(n=e.some((e=>e.id===t.id)),this.logger.info(`Selected camera(${t.id}) in call, isCameraValid:${n}`)),i&&(r=e.some((e=>e.id===i.id)),this.logger.info(`Selected SS(${i.id}) in call, isScreenShareValid:${r}`)),this.selectDevices({camera:n?t.id:void 0,screenshare:r?i.id:void 0})}isModalityEnabled(e){return this.isMediaSending(function(e){switch(e){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2}throw new Error("MediaType required")}(e))}},Dm=class{constructor(e){this.ontimeout=e,this.active=!1}get isActive(){return this.active}start(e){void 0!==this.timeoutId&&this.stop(),this.timeoutId=setTimeout((()=>{this.ontimeout(),this.active=!1}),e),this.active=!0}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0,this.active=!1}};function Om(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)}}}function km(e){return new Promise((t=>setTimeout(t,e)))}var Nm=class{constructor(e,t,i,n){this.mediaControlPlane=e,this.signalingSession=t,this.logger=i,this.diagnostics=n,this.pendingSourceRequests=new Map,this.mediaControlPlane.on("mpSrResReceived",((e,t)=>this.onMsgReceived(e,t)))}mapToSignalingOperation(e){switch(e){case"ApplyChannelParametersSourceRequest":case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":return 0;case"ControlVideoStreaming":return 1;default:return this.logger.error("Unknown send operation"),null}}send(e,t,i,n){switch(e){case"ApplyChannelParametersSourceRequest":return this.sendMessages(e,t,i,n);case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":case"ControlVideoStreaming":return this.signalingSession?(this.diagnostics.recordSignalingOperation(e),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e),t)):Promise.reject(new Error("no signaling session"));default:return this.logger.warn(`Unable to send message reason: Operation unknown ${e}`),Promise.reject(new Error("Unable to send message"))}}async sendMessages(e,t,i,n){return this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")?Promise.all([this.sendMcpMessage(e,t,i,n),this.sendSignalingDupeOperation(e,t,n)]).then():this.sendMcpMessage(e,t,i,n)}setResendingMechanism(e,t,i,n){const r=window.setTimeout((()=>{this.logger.warn(`Fallback for SR: ${e}, switching to signaling`),this.mediaControlPlane.switchMcpFeauture("sourceRequestsEnabled",!1),this.resendPendingMessagesThroughSignaling()}),this.mediaControlPlane.getConfig()?.sourceRequestsMessagesTimeout);this.pendingSourceRequests.set(e,{sequenceNumber:e,timeoutId:r,deferred:t,message:i,operation:n})}async sendMcpMessage(e,t,i,n){if(this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsEnabled")&&t.applyChannelParameters?.multiChannelParameter?.mediaParameter?.includes("controlVideoStreaming")){const r=Om();this.setResendingMechanism(n,r,t,e);try{return this.diagnostics.recordMCPOperation(e,n,i.controlVideoStreaming?.controlInfo),await this.mediaControlPlane.sendMsg({type:"sr",controlVideoStreaming:i.controlVideoStreaming}),this.logger.info(`Sending to MCP sequenceNumber:${n}`),this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsResponseEnabled")?r.promise:Promise.resolve()}catch(e){const t=Ve(e);this.diagnostics.recordError(t,n),this.logger.error(`sendMsgInternal failed with error: ${t}`)}}return this.signalingSession?this.mediaControlPlane?.mcpFeaturesSupported("sendDuplicates")?void 0:(this.diagnostics.recordSignalingOperation(e),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e),t)):Promise.reject(new Error("no signaling session"))}async sendSignalingDupeOperation(e,t,i){if(this.signalingSession){const n=this.mapToSignalingOperation(e);return this.diagnostics.recordSignalingOperation(e,i),await this.signalingSession.sendWebRtcMediaNotificationAsync(n,t),this.diagnostics.recordSignalingOperationDuration(e,i),Promise.resolve()}return Promise.reject(new Error("no signaling session"))}resendPendingMessagesThroughSignaling(){this.diagnostics.recordFallback(),this.pendingSourceRequests.forEach((async(e,t)=>{try{this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")||(this.diagnostics.recordSignalingOperation(e.operation),await this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e.operation),e.message)),e.deferred.resolve()}catch{e.deferred.reject()}finally{this.logger.warn(`Deleting message from pending: ${t}`),this.pendingSourceRequests.delete(t),clearTimeout(e.timeoutId)}}))}onMsgReceived(e,t){const i=this.pendingSourceRequests.get(e);switch(this.diagnostics.recordSrResultReceived(t,e,i.operation),t){case"ok":case"duplicate":case"out_of_order":i.deferred.resolve();break;default:i.deferred.reject(`Sequence number: ${e} failed with ${t}!`)}clearTimeout(i.timeoutId),this.pendingSourceRequests.delete(e)}},Lm=[1,2,9,10,11,12,30,27,28],xm="remote",Um=class extends We{constructor(e,t){super(),this.isStreaming=e,this.mediaType=t}},Fm=class e extends We{constructor(t,i,n,r,s,a,o,c,l,d,h,u,g,p,m,f,S){super(n),this.signalingAgent=t,this.mediaAgent=i,this.logger=n,this.telemetryLoggers=r,this.currentUserSkypeIdentity=s,this.groupId=a,this.threadId=o,this.ecsProvider=d,this.trouterService=h,this.accountConfiguration=u,this.participants=[],this.isServerMuted=!1,this.isSpeakerMuted=!1,this.isVideoOn=!1,this.isScreenSharingOn=!1,this.callStartedAt=null,this.callHeldAt=null,this.callType=-1,this.failureType=2,this.isEmergency=!1,this.contentSharingSessions=[],this.endpoints={endpointDetails:[]},this.isPreheatEnabled=!1,this.localMediaStreams=[],this.enableRealtimeTelemetry=!1,this.isSharedLineAppearanceV2Activated=!1,this.enableCaptcha=!1,this.requestedHoldState=!1,this.mediaStateConfigurationHelper=new zu({mediaStates:[ju(0,4)]}),this.canToggleAudio=!0,this.canToggleVideo=!0,this.connectCallPromise=Promise.resolve(),this.canToggleScreenSharing=!0,this.callUsesMixer=!1,this.isEscalationInProgress=!1,this.retryOutgoingRenegotiation={retry:!1,causeId:""},this.isHoldInProgress=!1,this.isMuteOnHold=!1,this.callSetupFailed=!1,this.isSomeoneSharing=!1,this.isSomeoneStreamingVideo=!1,this.activeTalkersHistory=[],this.callGotConnected=!1,this.mediaRelayWhiteListingIssue=!1,this.signalingSessionCallOptions=null,this.tsCallingTelemetryReported=!1,this.isCallSetupTelemetrySent=!1,this._isAudioStreamConnected=!1,this._wasAudioStreamConnected=!1,this._callInLobby=!1,this._callIsSetupComplete=!1,this._transferState=0,this._parkState=0,this._muteState=0,this._callCreationTime=(new Date).getTime(),this._commandUrlPresence=0,this._capabilities={canMuteOthers:!1,canUnmuteSelf:!1},this._spamRiskLevel=null,this._spamStirAttestation=null,this._callMode=0,this._isUpdatePropertiesSpecifiedAllowedByEcs=!1,this._deferUsingMicrotask=!1,this._staleRosterCheckFixForPluginless=!1,this._transfereeAcceptanceWithoutWaitingForConv=!1,this._enableResolveScreenSharingWhenNegotiationComplete=!1,this._publishedStatesModified=0,this._participantPublishedStatesMap={},this._endpointPublishedStatesMap={},this._participantChangedEventSkipConfig={skipParticipantsUpdatesOnCall:!0},this._dominantSpeakerChangedEventSkipConfig={skipDominantSpeakerUpdatesOnCall:!0},this.receiveOnlyAudioOnCallStart=!1,this.lastContibutingSourceReport=Date.now(),this.instanceNumber=e.instanceCount++%1e3,this._hasDelayedReconnect=!1,this._enableMuteAsync=!1,this._enableUnmuteAsync=!1,this.startVM=(e,t,i,n,r)=>this.signalingSession.startOutgoingCall(i,n,{voicemailResourcePath:t.callVoicemailStartOptions.voicemailResourcePath,voicemailItemId:t.callVoicemailStartOptions.voicemailItemId,callToVoicemail:!0},Date.now()-r,e),this.getSignalingSessionCallOptions=e=>{const t={suppressDialout:!e.callStartOptions.ringOthers,isPreheatOnly:!(1&~e.callStartOptions.preheatFlags),onBehalfOf:this.onBehalfOfMri,onBehalfOfUserDisplayName:this.onBehalfOfUserDisplayName,callQueueContext:e.callStartOptions?.callQueueContext,muted:!(1&~e.callStartOptions.muteFlags),invitationType:e.invitationType,participantsToNudge:e.participantsToNudge,routingFlags:e.callStartOptions&&e.callStartOptions.routingFlags,parkContext:e.parkContext,pickupCode:e.pickupCode,scenario:e.callStartOptions&&e.callStartOptions.scenario,callUsesMixer:this.callUsesMixer,clientEndpointCapabilities:e.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:e.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:e.meetingPreferences,alternateId:e.callStartOptions?e.callStartOptions.alternateId:null,meetingRegistrationId:e.callStartOptions?e.callStartOptions.meetingRegistrationId:"",participantPin:e.callStartOptions?e.callStartOptions.participantPin:"",additionalEndpointProperties:e.callStartOptions?.additionalEndpointProperties||null,publishedStates:e.callStartOptions?.publishedStates||null,targetApplicationType:e.callStartOptions?.targetApplicationType,isHuddleGroupCall:e.callStartOptions?.isHuddleGroupCall,captchaContentJson:e.callStartOptions?.captchaContentJson,customHeaderContext:e.callStartOptions?.customHeaderContext},i=e.callStartOptions?.invitationDataJson;if(i)try{t.invitationData=JSON.parse(i)}catch(e){throw new Error(`Invalid JSON in invitationData: ${i}`)}return t},this.startOutgoingCall=(e,t,i,n,r)=>this.signalingSession.startOutgoingCall(i,n,this.getSignalingSessionCallOptions(t),Date.now()-r,e),this.joinGivenConversation=(e,t,i,n,r,s)=>{const a=!(1&~t.callStartOptions.muteFlags),o=!(1&~t.callStartOptions.preheatFlags),c=t.callStartOptions?.invitationDataJson,l=t.callStartOptions?.sharedLineCallInvitationContentJson;this.logger.info(`[${e}][joinGivenConversation] muted=${a}, isPreheatOnly=${o},\n            sharedLineCallInvitationContentJson=${l}, invitationDataJson=${c}`);const d={muted:a,isPreheatOnly:o,clientEndpointCapabilities:t.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:t.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:t.meetingPreferences,meetingRegistrationId:t.callStartOptions?t.callStartOptions.meetingRegistrationId:"",participantPin:t.callStartOptions?t.callStartOptions.participantPin:"",additionalEndpointProperties:t?.callStartOptions?.additionalEndpointProperties,applyServerMute:t?.applyServerMute,publishedStates:t?.callStartOptions.publishedStates,invitationData:t?.callStartOptions.invitationDataJson,captchaContentJson:t?.callStartOptions.captchaContentJson,callQueueContext:t?.callStartOptions.callQueueContext};if(l)try{d.sharedLineCallInvitationContent=JSON.parse(l)}catch(e){throw new Error(`Invalid JSON in sharedLineCallInvitationContent: ${l}`)}if(c)try{d.invitationData=JSON.parse(c)}catch(e){throw new Error(`Invalid JSON in invitationDataJson: ${c}`)}return this.signalingSession.joinGivenConversation(s,this.callId,i,n,Date.now()-r,d,e)},this.executeCallTransfer=(e,t,i,n)=>{this._setTransferState(1);const r=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return 0===i?this.signalingSession.transferCallAsync(e,"TransferTypeStandard",void 0,n,t):2===i&&this.signalingSession.transferCallAsync(e,"TransferTypeVoicemail",void 0,n,t),r},this.executeConsultCallTransfer=(e,t,i,n,r)=>{this._setTransferState(1);const s=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,n,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return this.signalingSession.consultTransferCallAsync(e,t,i,n,r),s},this.createUpdateParticipantPromise=(e,t)=>this._callOperationHandler.createPendingOperation("UpdateParticipantsProperties",e,t),this._getCallEndOperation=()=>this._callOperationHandler.hasPendingOperation("StopCall")?this._callOperationHandler.waitForOperation("StopCall"):this._callOperationHandler.hasPendingOperation("Reject")?this._callOperationHandler.waitForOperation("Reject"):this._callOperationHandler.hasPendingOperation("CallRedirect")?this._callOperationHandler.waitForOperation("CallRedirect"):Promise.resolve(),this._onAcknowledgeError=(e,t,i,n)=>{i.logFailure(e);let r,s={code:2,success:!1,fatal:!0},a=7;throw gu("SendAttach",e)&&(r={code:Gn.InternalServerError,subCode:jn.AttachFailed,phrase:ar}),gu("ProcessIncomingCallRequest",e)&&(r={code:Gn.NotAcceptable,subCode:jn.AttachActionFailed,phrase:or},s={code:0,success:!1,fatal:!0}),uu(fr,e)&&(a=47),e?.error&&e.error.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer&&(r={code:Gn.MediaError,subCode:jn.MediaOfferProcessingError,phrase:rr}),this.callTelemetry.updateOperationData("Acknowledge",{phases:n,error:Oe(e)},t),this._callOperationHandler.maybeRejectOperation("Acknowledge",s,void 0,t),this.stopInternal({rejectReason:r,causeId:t,terminatedReason:a}),s},this._onAcknowledgeSuccess=(e,t,i)=>(e.logSuccess("success"),this.callTelemetry.updateOperationData("Acknowledge",{phases:t},i),{code:1,success:!0}),this._processOfferedModalities=(e,t)=>{this.handleOfferedModalities(e,t);const i=this.callUsesMixer?void 0:{modalityOverride:e};return this.updateMediaModalities(i,t)},this._handleOfferProcessingError=(e,t,i)=>(i.logFailure(`handleOfferProcessingError=${e}`),e?.error?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer?(this.callTelemetry.recordEvent("IncompatibleOffer",void 0,t),this.signalingSession.supportsNewOfferRequest()?(this.newOfferRequestDeferred=vi(),this.attachToCallAndGetOffer.promise.then((()=>this.mediaSession.rejectNegotiationAsync(e.error,t))).then((()=>this.signalingSession.requestNewOffer(this.mediaSession.getAcceptedTypes(),t))).then((()=>this.newOfferRequestDeferred.promise)).then((e=>this.mediaSession.processOfferAsync(e,t))).catch((e=>(this.callTelemetry.recordEvent("NewOfferFailed",Ne(e),t),Promise.reject(e))))):Promise.reject(e)):Promise.reject(e)),this._trySendProvisionalMediaAnswer=e=>Promise.resolve(void 0).then((()=>this.mediaSession.createAnswerAsync(!0,e))).then((e=>e.blob?(this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",void 0,Te(),{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.signalingSession.setProvisionalAnswerAsync(e).then((()=>this.mediaAcknowledgmentOperation))):Promise.resolve(void 0))),this.checkForCallIdUpdate=(e,t)=>{if(this.callId!==e){this.logger.info(`[${t}][checkForCallIdUpdate] old=${this.callId}, new=${e}`),this.setCallId(e);try{this.event("callIdChanged").raise(this.callId)}catch(e){this.logger.error(`Error raising call ID change: ${e}`)}this.raiseChanged()}},this.handleRemoteParticipantStateInOneToOneCall=e=>{if(!this.callUsesMixer&&3===this.state){const t=this.participants[0];t&&t.setState(3,void 0,e)}},this.handleRemoteParticipantJoinedInOneToOneCall=(e,t)=>{if(!this.callUsesMixer&&3===this.state){const i=this.participants.filter((t=>t.id===e.id))[0];i?i.setState(3,void 0,t):this.logger.logFailure(`[${t}][handleRemoteParticipantJoinedInOneToOneCall]unable to find particpant ${we(e.id)}`)}},this.handleRemoteParticipantStateInObservingCall=(e,t,i)=>{const n=t.isLobby;if(8===this.state){const t=n?7:3;e.setState(t,void 0,i)}},this.getTelemetryFromPhaseExecution=e=>{const t={phase:e.phase,phases:e.phases,code:e.error&&e.error.code,subCode:e.error&&e.error.subCode,message:e.error&&e.error.message,error:e.error};return(t.code||t.message)&&delete t.error,t},this._setTransferState=e=>{this.transferState!==e&&(this.logger.info(`Transfer: state set: ${e}`),this._transferState=e,this.callTelemetry.recordEvent("_SetTransferState",{state:e}),this.raiseChanged())},this._setParkState=e=>{this.parkState!==e&&(this.logger.info(`Parking: state set: ${e}`),this._parkState=e,this.callTelemetry.recordEvent("_SetParkState",{state:e}),this.raiseChanged())},this.prepareNegotiationResultForTelemtry=e=>({isComplete:e.isComplete,activeModalities:e.activeModalities,configuredModalities:e.configuredModalities,initiator:we(e.initiator),attemptedModalities:e.attemptedModalities,offeredModalities:e.offeredModalities}),this.prepareTelemetryForOfferAnswer=e=>e&&e.mediaContent&&{isRenegotiation:!!e.renegotiation,isEscalation:!!e.mediaContent.isTwoPartyToMultiPartyEscalation,mediaTypes:e.mediaTypes,newOffer:e.mediaContent.newOffer},this.updateLocalParticipantEndpoints=e=>{const t=this.logger.createFnLogger("updateLocalParticipantEndpoints",""),i=[];(0,Sr.forEach)(e,(e=>{const t=Hu(e,this.getSelfClientEndpointCapabilities());i.push(t)})),this.endpoints.endpointDetails=i;const n=this.getDataChannelSourceId();-1!==n&&this.dataChannel&&this.dataChannel.setDataChannelSourceId(n),t.info(`selfEndpointDetails=${JSON.stringify(this.endpoints)}`)},this.handleParticipantsMutedUpdated=(e,t)=>{const i=this.logger.createFnLogger("handleParticipantsMutedUpdated",t);if(void 0!==e?.info){this.logger.info(`handleParticipantsMutedUpdated: number of infos: ${Object.keys(e.info).length}`);for(const t of Object.keys(e.info)){const n=this.getParticipant(t);n?n.handleServerMutedInfoUpdate(e.info[t]):i.info(`Cannot find local participant ${we(t)}`)}}else i.info("Ignored, no mute participant info.")},this.handleSelfUnmuteUpdatedInfo=(e,t)=>{const i=this.logger.createFnLogger("handleSelfUnmuteUpdatedInfo",t);if(void 0!==e?.info)for(const n of Object.keys(e.info)){const r=e.info[n];if(n===this.localSignalingParticipant.id){const e=(0,Sr.find)(r,(e=>e.participantId===this.localSignalingParticipant.participantId));if(void 0===e){i.info(`Cannot find local participant ${we(n)}`);continue}const s=(0,Sr.find)(this.localSignalingParticipant.endpointDetails,(t=>t.participantId===e.participantId));ag(this.logger,s,e,!1)&&this.handleSelfServerMutedState(t)}}else i.info("Ignored, no unmute participant info.")},this.state=0,this.terminatedReason=0,this.callStats=new Fu(this.mediaAgent?.getConfigProvider()),this.callDeviceManager=this.createCallDeviceManager(),this.callTelemetry=new pn(this.logger,this._callCreationTime),this.collectMediaStatsDeferred=vi(),this.setCallId(c),this.setGroupId(a),this.setThreadId(o),this.setMessageId(g),this.setSkypeId(this.currentUserSkypeIdentity.id),this.setParticipantId(l),this.setCallOrigin(0),this.logger=this.logger.createChild((()=>{const e=(this.endpointId||"").substr(0,8),t=(this.participantId||"").substr(0,8);return`Web/${this.instanceNumber}[${this.callId}][${e}][${t}][${this.state}]`})),this._staleRosterCheckFixForPluginless=this.ecsProvider.getEcsConfig("SkypeCalling","staleRosterCheckFixForPluginless"),this._transfereeAcceptanceWithoutWaitingForConv=this.ecsProvider.getEcsConfig("SkypeCalling","transfereeAcceptanceWithoutWaitingForConv"),this._enableMuteAsync=this.ecsProvider.getEcsConfig("SkypeCalling","enableAsyncMute"),this._enableUnmuteAsync=this.ecsProvider.getEcsConfig("SkypeCalling","enableAsyncUnmute"),this.initializeSignalingSession(l),this.signalingSession.setLocationInfo(p,m,S),this.streamManager=new Bg(this.participantId,null,this.callStats.localStats,this.logger),this.mediaAgent&&(this.dataChannel=new ap(this.logger),this.dataChannel.on("remoteUserEventsReceived",((e,t)=>this.event("remoteUserEventsReceived").raise(e,t))),this.dataChannel.on("onDataChannelStateUpdated",(e=>{"Failed"===e&&(this.logger.error("onDataChannelStateUpdated: datachannel creation failed, will remove data modality"),this.mediaStateConfigurationHelper.removeModality(3),this.updateSignalingDSHMessageSubscription(!0),this.updateMediaModalities())})),this.screenSharingControl=new Pp(this.logger,this.dataChannel,this,this.telemetryLoggers,this.ecsProvider),this.initializeMediaControlPlane(),this.mediaAgent.handleSendMidCallTelemetry(this.sendMidCallTelemetry.bind(this)));const v={enableErrorConversion:this.ecsProvider.getEcsConfig("SkypeCalling","enableErrorConversion")};this._deferUsingMicrotask=this.ecsProvider.getEcsConfig("SkypeCalling","deferUsingMicrotask"),mg.instance.setDeferToQueueMicrotask(this._deferUsingMicrotask),mg.instance.setLogger(n),this.logger.info(`operationHandlerEcsConfig: ${JSON.stringify(v)}`),this._preferredMpLocation=this.ecsProvider.getEcsConfig("SkypeCalling","preferredMpLocation"),this._isUpdatePropertiesSpecifiedAllowedByEcs=this.ecsProvider.getEcsConfig("SkypeCalling","enableUpdateParticipantsSpecified"),this._enableResolveScreenSharingWhenNegotiationComplete=this.ecsProvider.getEcsConfig("SkypeCalling","enableResolveScreenSharingWhenNegotiationComplete"),this._callOperationHandler=new $n(this.logger,this.callTelemetry,v,void 0,((e,t)=>{this.preconditions(e,t)})),this._participantOperationHandler=new $n(this.logger,this.callTelemetry,v),this.setMeetingData(f),this.initializeLiveStreamConfigProvider()}get callMode(){return this._callMode}get callId(){return this._callId}get endpointId(){return this._endpointId}get isHostless(){return this.signalingSession.isHostLessCall}get transferState(){return this._transferState}get parkState(){return this._parkState}get capabilities(){return this._capabilities}get publishedStates(){return this._publishedStates}get dataChannelAdapter(){return this.dataChannel}get participantId(){try{const e=this.signalingSession?.participantManager?.localParticipant?.participantId;this._participantId=e||this._participantId}catch(e){this.logger.error("Error updating participantId")}return this._participantId}get role(){return this.localSignalingParticipant.role}get meetingRole(){return this.localSignalingParticipant.meetingRole}get advancedMeetingRole(){return this.localSignalingParticipant.advancedMeetingRole}get maskedIdentityDetails(){return{isIdentityMasked:this.localSignalingParticipant.isIdentityMasked,maskedIdSeqNumber:this.localSignalingParticipant.maskedIdSeqNumber,maskedId:this.localSignalingParticipant.maskedId}}get participantType(){return this.localSignalingParticipant.participantType}get isMuted(){return 2===this._muteState||3===this._muteState}get tenantId(){return this.localSignalingParticipant.tenantId}get mediaLegId(){return this._mediaLegId}get isIncomingOneOnOneVideoCall(){return this.isOneToOneCall()&&this.isSomeoneStreamingVideo}get mediaStreams(){return this.streamManager.streams}get origin(){return this._origin}get propertyBag(){return this.localSignalingParticipant.propertyBag}get version(){return this.localSignalingParticipant.version}get isAudioStreamConnected(){return this._isAudioStreamConnected}set isAudioStreamConnected(e){this._isAudioStreamConnected!==e&&(this._isAudioStreamConnected=e,this._wasAudioStreamConnected=this._wasAudioStreamConnected||e,this.raiseChanged())}setMeetingRole(e){e!==this.localSignalingParticipant.meetingRole&&(this.logger.info(`changing self role to [${e}]`),this.localSignalingParticipant.meetingRole=e,this.event("meetingRoleUpdated").raise(e))}setAdvancedMeetingRole(e){e!==this.localSignalingParticipant.advancedMeetingRole&&(this.logger.info(`changing self advanced meeting role to [${e}]`),this.localSignalingParticipant.advancedMeetingRole=e,this.event("advancedMeetingRoleUpdated").raise(e))}setParticipantType(e){e!==this.localSignalingParticipant.participantType&&(this.logger.info(`changing self participant user type to [${e}]`),this.localSignalingParticipant.participantType=e,this.event("participantTypeUpdated").raise(e))}setPropertyBag(e){e&&!(0,Sr.isEqual)(e,this.localSignalingParticipant.propertyBag)&&(this.logger.info(`changing self participant property bag to [${e}]`),this.localSignalingParticipant.propertyBag=e,this.event("propertyBagUpdated").raise(e))}setPropertyRosterVersion(e){e!==this.localSignalingParticipant.version&&(this.logger.info(`changing self participant property version to [${e}]`),this.localSignalingParticipant.version=e,this.event("propertyRosterVersionUpdated").raise(e))}setMaskedIdentityDetails(e=!1,t,i){this.localSignalingParticipant.isIdentityMasked===e&&this.localSignalingParticipant.maskedIdSeqNumber===t&&this.localSignalingParticipant.maskedId===i||(this.localSignalingParticipant.isIdentityMasked=e,this.localSignalingParticipant.maskedIdSeqNumber=t,this.localSignalingParticipant.maskedId=i,this.logger.info(`self participant masked identity details updated to [${JSON.stringify(this.maskedIdentityDetails)}]`),this.event("maskedIdentityDetailsUpdated").raise(this.maskedIdentityDetails))}setJoinAsStreamingUser(e){e!==this.joinAsStreamingUser&&(this.logger.info(`setting self join as streaming user to [${e}]`),this.joinAsStreamingUser=e)}get spamRiskLevel(){return this._spamRiskLevel}set spamRiskLevel(e){e&&(this._spamRiskLevel=e)}get spamStirAttestation(){return this._spamStirAttestation}set spamStirAttestation(e){e&&(this._spamStirAttestation=e)}getScreenHandle(e){if(!this.sharedScreenHandle){const t=!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled,i=!!this.mediaSession&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&!this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing,n=this.mediaStateConfigurationHelper.isSending(0)&&i&&t,r=3===e?.getType()?e?.getDeviceId():void 0,s=this.callDeviceManager.getDeviceManager(Ku(2));s.setAudioSharingRequested(n),this.sharedScreenHandle=s.createDevicesHandle({audio:n,sharing:!0},"pluginlessCall:getScreenHandle()",r),this.sharedScreenHandle.on("onStreamStateChanged",((e,t)=>this.onSharingStreamStateChanged(e)))}return this.sharedScreenHandle}setCallOrigin(e){this.logger.info(`Set call origin to ${e}`),this._origin=e,this.callTelemetry.setCallOrigin(e),this.callTelemetry.recordEvent("_SetCallOrigin",{origin:e})}setMediaLegId(e){this._mediaLegId=e,this.callStats.setMediaLegId(e)}setCallId(e){this.callTelemetry.setCallId(e),this.callStats.setCallId(e),this._callId=e}setEndpointId(e){this._endpointId=e,this.logger.info(`[endpointId=${xe(this._endpointId)}]`),this.callTelemetry.setEndpointId(e),this.callStats.setEndpointId(e)}setFailureType(e){this.callTelemetry.setFailureType(e),this.failureType=e}setParticipantId(e){this._participantId=e,this.logger.info(`[participantId=${this._participantId}]`),this.callTelemetry.setParticipantId(this.participantId)}setCallerMri(e){this.callerMri=e,this.logger.info(`[callerMri=${we(this.callerMri)}]`)}setTransferorMri(e){const t=du(e);t!==this.transferorMri&&(this.transferorMri=t,this.logger.info(`transferorMri: ${we(this.transferorMri)}`),this.raiseChanged())}setGroupId(e,t=Te()){this.logger.info(`[${t}][setGroupId] groupId=${we(e)}`),this.groupId!==e&&(this.groupId=e,this.callTelemetry.setGroupId(e),this.event("groupIdChanged").raise(e))}setMeetingData(e){if(e){if(e.meetingCode&&(!this.meetingData||this.meetingData&&e.meetingCode!==this.meetingData.meetingCode)){const t=e.meetingCode;this.logger.info(`[setMeetingData] meetingCode=${t}`),this.callTelemetry.setMeetingCode(t),this.signalingSession.setMeetingCode(t)}if(e.meetingUrl&&(!this.meetingData||this.meetingData&&e.meetingUrl!==this.meetingData.meetingUrl)){const t=e.meetingUrl.split("?")[0];this.logger.info(`[setMeetingData] meetingUrl=${e.meetingUrl}`),this.callTelemetry.setMeetingUrl(t),this.signalingSession.setMeetingUrl(t)}}this.meetingData=e}setHuddleGroupCall(e){this.isHuddleGroupCall!==!!e&&(this.logger.info(`[setHuddleGroupCall] new isHuddleGroupCall=${e}`),this.isHuddleGroupCall=e,this.callTelemetry.setIsHuddleGroupCall(!0))}setComplianceRecordingContent(e,t){try{if(!(0,Sr.isEqual)(this.complianceRecordingContent,t)){this.complianceRecordingContent=t;const i=t?JSON.stringify(t):"";this.callTelemetry.setComplianceRecordingContentLength(i.length),this.logger.info(`[${e}][setComplianceRecordingContent] complianceRecordingContentLength=${i.length}`)}}catch(t){this.logger.error(`[${e}][setComplianceRecordingContent] ${t}`)}}setThreadId(e,t=Te()){this.threadId!==e&&(this.logger.info(`[${t}][setThreadId] threadId=${Me(e)}`),this.threadId=e,this.callTelemetry.setThreadId(e))}setBackroomThreadId(e,t=Te()){this.backroomThreadId!==e&&(this.logger.info(`[${t}][setBackroomThreadId] backroomThreadId=${Me(e)}`),this.backroomThreadId=e,this.callTelemetry.setBackroomThreadId(e))}setMessageId(e,t=Te()){this.messageId!==e&&(this.logger.info(`[${t}][setMessageId] messageId=${we(e)}`),this.messageId=e,this.callTelemetry.setMesageId(e))}setSkypeId(e,t=Te()){this.skypeId!==e&&(this.logger.info(`[${t}][setSkypeId]`),this.skypeId=e,this.callTelemetry.setSkypeId(e))}setCallType(e,t){const i=this.logger.createFnLogger("setCallType",t);i.info(`current=${this.callType}, newValue: ${e}`),2!==this.callType||1!==e?e!==this.callType&&(this.callType=e,this.callTelemetry.setCallType(e),2===e&&this.callStats.localStats.call.event(2),this.raiseChanged()):i.logFailure("De-escalating to P2P should not happen!")}setConversationType(e,t){this.logger.createFnLogger("setConversationType",t).info(`current=${this.conversationType}, newValue=${e}`),e!==this.conversationType&&(this.conversationType=e,this.callTelemetry.setConversationType(e),this.raiseChanged())}setCallUsesMixer(e,t){this.callUsesMixer!==!!e&&(this.logger.info(`[${t}][setCallUsesMixer] new value=${e}`),this.callUsesMixer=e,this.callTelemetry.recordEvent("_CallUsesMixer",{newValue:e},t),this.dataChannel.setConfigProviderView(this.mediaSession?.getSessionConfig())),e&&this.mediaControlPlane.start()}setIsEscalationInProgress(e,t){this.logger.info(`[${t}][setIsEscalationInProgress] currentValue=${this.isEscalationInProgress}, newValue=${e}`),this.isEscalationInProgress=e,this.allowScreenSharingControl()&&this.screenSharingControl.setIsEscalationInProgress(e),this.callTelemetry.recordEvent("_EscalationInProgress",void 0,t)}setFromApplicationType(e,t){e&&(this.fromApplicationType=e,this.callTelemetry.recordEvent("_SetFromApplicationType",{fromApplicationType:e},t))}setEnableCaptcha(e){e!==this.localSignalingParticipant.enableCaptcha&&(this.logger.info(`setting self participant to enable captcha to [${e}]`),this.localSignalingParticipant.enableCaptcha=e,this.enableCaptcha=e)}processCallStartOptions(e,t){const i=this.logger.createFnLogger("_ProcessCallStartOptions",t);try{1&e.preheatFlags&&(this.isPreheatEnabled=!0)}catch(e){i.logFailure(e)}}getlocalScreenShareStream(){return(0,Sr.find)(this.localMediaStreams,(e=>2===e.mediaType))}setMeetingLayout(e,t){throw new Error("Method not implemented.")}async selectDevices(e){this.callDeviceManager.isVirtualDeviceEnabled?this.callDeviceManager.selectDevices(e):this.logger.error("allowVirtualDeviceInCall not enabled.")}async getSelectDevices(){return this.callDeviceManager.getSelectedDevices()}createStage(e){throw new Error("Method not implemented.")}updateDisplayName(e){this.logger.info("updating displayName"),this.localSignalingParticipant.displayName=e,this.signalingSession.participantManager.localParticipant.displayName=e}init(e){if(this.logger.info(`init callInitOptions:${Le(function(e){const t={mediaPeerType:e.mediaPeerType,threadId:Me(e.threadId)};return Ue(e.messageId)&&(t.messageId=e.messageId),Ue(e.enableGroupCallMeetupGeneration)&&(t.enableGroupCallMeetupGeneration=e.enableGroupCallMeetupGeneration),Ue(e.endpointMetadata)&&(t.endpointMetadata=e.endpointMetadata),Ue(e.onBehalfOf)&&(t.onBehalfOf=we(e.onBehalfOf)),Ue(e.onBehalfOfUserDisplayName)&&(t.onBehalfOfUserDisplayName=e.onBehalfOfUserDisplayName),Ue(e.emergencyContent)&&(t.emergencyContent=e.emergencyContent),Ue(e.isEmergency)&&(t.isEmergency=e.isEmergency),Ue(e.broadcastContext)&&(t.broadcastContext=e.broadcastContext),e.meetingInfo&&(t.meetingInfo={tenantId:e.meetingInfo.tenantId,organizerId:we(e.meetingInfo.organizerId)},Ue(e.meetingInfo.meetingType)&&(t.meetingInfo.meetingType=e.meetingInfo.meetingType),Ue(e.meetingInfo.replyChainMessageId)&&(t.meetingInfo.replyChainMessageId=e.meetingInfo.replyChainMessageId)),e.transferContext&&(t.transferContext={transferorMri:we(e.transferContext.transferorMri),targetMri:we(e.transferContext.targetMri),context:e.transferContext.context},Ue(e.transferContext.transferType)&&(t.transferContext.transferType=e.transferContext.transferType)),t}(e))}`),this.signalingSessionCallOptions={teamsMessageId:e.messageId,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration,meetingInfo:e.meetingInfo,emergencyContent:e.emergencyContent?JSON.parse(e.emergencyContent):void 0,broadcastContext:e.broadcastContext,endpointMetadata:e.endpointMetadata},this.setMessageId(e.messageId),this.onBehalfOfMri=e.onBehalfOf,this.onBehalfOfUserDisplayName=e.onBehalfOfUserDisplayName,e.threadId&&(this.setThreadId(e.threadId),this.signalingSession.setThreadId(e.threadId)),this.groupId&&this.signalingSession.setGroupId(this.groupId),this.signalingSession.setCallOptions(this.signalingSessionCallOptions),e.transferContext){switch(this.logger.info("Transfer: Call.init, set transferContext",dg(e.transferContext)),this.signalingSession.setTransferContext(e.transferContext.context),e.transferContext.transferType){case 1:this.setCallOrigin(2);break;case 0:this.setCallOrigin(1);break;case 2:this.setCallOrigin(3);break;default:throw new Error(`TransferType: ${e.transferContext.transferType} doesn't have a switch option`)}e.transferContext.context.callAcceptanceCallback?this._transferredCallAcceptanceCallback=e.transferContext.context.callAcceptanceCallback:this.logger.info("[failed]Transfer: Missing transferred call acceptance callback"),e.transferContext.transferorMri&&this.setTransferorMri(e.transferContext.transferorMri)}this.setIsEmergency(!!e.isEmergency),this.raiseChanged()}getIncomingRawAudioStream(){if(!this.mediaSession)throw this.logger.error("can not execute getIncomingRawAudioStream as there is no mediaSession"),new Error("NoMediaSession");return this.mediaSession.getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.unmixedAudioProvider?Promise.resolve(this.unmixedAudioProvider):Promise.reject("No audio provider available")}setDeviceManager(e){}async startVideo(e,t=Te()){return this.startStopVideo(!0,t)}async stopVideo(e,t=Te()){return this.startStopVideo(!1,t)}async dumpVideoSourceImages(){return Promise.reject(60)}async hold(e,t=Te(),i,n){const r=this.logger.createFnLogger("Hold",t);return r.info(`[Hold][${t}] negotiationTag ${e} hold options: ${Le(i)}`),4===this.state?(r.logFailure("Trying to put a call on hold which is already held state, early resolving the promise"),Promise.resolve(void 0)):i?.isLocal?this.localHold(t,i,n):this.holdWithRenegotiate(t,i)}async holdWithRenegotiate(e,t){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,e,t):(this.logger.logFailure(`[Hold][${e}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async localHold(e,t,i){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,e,t,i):(this.logger.logFailure(`[LocalHold][${e}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async unhold(e,t=Te()){const i=this.logger.createFnLogger("Unhold",t);return 3===this.state?(i.logFailure("Trying to resume a call which is already in connected state, early resolving the promise"),Promise.resolve(void 0)):4===this.state?(i.info(`current hold state ${this.requestedHoldState}`),this.setHold(!1,t)):(i.logFailure(`Trying to resume a call in an invalid state: ${this.state}`),Promise.reject(`Trying to resume a call in an invalid state: ${this.state}`))}canMerge(e,t){const i=e.isOneToOneCall(),n=3===this.state,r=4===e.state,s=i&&n&&r;return this.logger.info(`[${t}][canMerge] Call ${e.callId} isOneToOne ${i} isCallConnected ${n} call.state ${this.state} isMergeOnHold ${r} mergeCall.state ${e.state} CanMerge result: ${s}`),s}async updateEndpointMetadata(e,t=Te()){return this.signalingSession.updateEndpointMetadata(e,t)}async sendDtmfTone(e){if(this.mediaSession){const t=this.toneToString(e);return t?(this.logger.info(`[${Mn}][sendDtmfTone]DtmfTone: <omitted>`),Promise.resolve(this.mediaSession.sendDtmf(t))):Promise.reject(new Error("Unsupported DtmfTone"))}return Promise.reject(new Error("no mediaSession"))}async setAudioUsageMode(e){return Promise.reject(60)}async setAudioMidcallConfig(e,t){return Promise.reject(60)}async setAudioMidcallConfigJson(e,t=Te()){if(!e)return Promise.reject(60);et(e.enableSpatialAudio)&&this.mediaSession?.configureSpatialAudio(e.enableSpatialAudio,t),e.noiseSuppressionMode&&await this.setNoiseSuppressionMode(e.noiseSuppressionMode,e.enableAEC)}async setParticipantSpatialAudioPositions(e,t=Te()){const i=e.map((e=>({sourceId:this.participants.find((t=>t.id===e.participantId))?.audio.id,x:e.x,y:e.y})));return this.mediaSession?.setParticipantSpatialAudioPositions(i,t)}async setNoiseSuppressionMode(e,t){return this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe||this.mediaSession.getSessionConfig().config.wasmdns.enableNoiseSuppression?"Auto"===e?this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaSession.getSessionConfig().config.wasmvqe.defaultVqeMode)):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(this.mediaSession.getSessionConfig().config.wasmdns.noiseSuppressionMode,t))):this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(e,this.mediaSession.getSessionConfig().config.wasmvqe.enableAec))):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(e,t))):Promise.resolve()}setInitialTelemetry(e,t,i,n){let r,s,a,o,c;switch(e){case"Subscribe":case"SubscribeWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("SUBSCRIBE"),i||this.callTelemetry.setOperationVariant(e,"CCWM"),this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i});break;case"Acknowledge":0!==this.state&&8!==this.state&&this.callTelemetry.maybeRecordOperationSuccess(e,{code:4}),this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("callee"),this.signalingSession.setInitialTelemetry(e,{causeId:n});break;case"JoinCall":case"JoinWithMeetingData":this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("join"),1&t.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(e,"Preheat"),r=this.telemetryDataFromCallStartOptions(t.callStartOptions),r&&this.callTelemetry.updateOperationData(e,r,n),s=!(1&~t.callStartOptions.muteFlags),a=!(1&~t.callStartOptions.preheatFlags),o={muted:s,isPreheatOnly:a},this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,joinCallOptions:o,offerGenerationTime:Date.now()-t.callStartTime});break;case"StartCall":case"StartWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),1&t.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(e,"Preheat"),r=this.telemetryDataFromCallStartOptions(t.callStartOptions),r&&this.callTelemetry.updateOperationData(e,r,n),c=t.callStartOptions,this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,callStartOptions:c,offerGenerationTime:Date.now()-t.callStartTime});break;case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,startCallOptions:t.callStartOptions,offerGenerationTime:Date.now()-t.callStartTime})}}async setHold(e,t,i,n){const r=this.logger.createFnLogger("setHold",t,`hold=${e}`);if(!this.canToggleAudio||this.callHoldResumeDeferred)return Promise.reject(new Error("can not set hold as it is already in progress"));this.callHoldResumeDeferred=vi(),this.isHoldInProgress=e,this.canToggleAudio=!1,this.canToggleVideo=!1,this.canToggleScreenSharing=!1,this.requestedHoldState=e;const s=()=>{this.canToggleAudio=!0,this.canToggleScreenSharing=!0,this.canToggleVideo=!0};r.info(`start, holdOptions: ${JSON.stringify(i)}`);const a=this.callHoldResumeDeferred.promise,o=e?"Hold":"Unhold",c={debugContent:{clientScenario:this.convertClientScenario(n)}};try{if(e?this.isMuteOnHold=i&&i.isLocal&&5!==this.state:this.prepareModalitiesForResume(t),!this.isMuteOnHold){const e=await this.updateMediaModalities(void 0,t);this.updateMediaState(e,t),this.updateScreenSharingState(e,t)}e&&(this.prepareModalitiesForHold(t),5===this.state&&this.finishCallHoldResume(),this.setCallState(4,t)),this.isMuteOnHold&&this.setMuteOnHold(e,t),s();const n={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(o,n,null,t,c)}catch(i){this.callTelemetry.recordOperationFailure(o,{error:Oe(i)},null,t,c),r.logFailure(i),s(),this.callHoldResumeDeferred?.reject(new Error(`Failed setting hold state to ${e}`)),this.callHoldResumeDeferred=null}return a}transferCall(e){return this.logger.warn("transferCall is deprecated, please use callBlindTransfer instead"),this.callBlindTransfer(e)}callBlindTransfer(e,t=Te(),i){return this.executeCallTransfer(e,t,0,i)}callSafeTransfer(e,t=Te(),i){return this.executeCallTransfer(e,t,0,i)}transferCallToVoicemail(e,t=Te()){return this.executeCallTransfer(e.transferTargetMri,t,2,void 0)}callConsultativeTransfer(e,t=Te(),i,n){const r=this.logger.createFnLogger("ConsultativeTransfer",t),s=e.participants[0],a=s&&s.acceptedBy||s&&s.id;return r.info(`transferTargetParticipantLegId: ${i} targetMri: ${we(a)}`),this.executeConsultCallTransfer(e.callId,a,i,t,n)}async consultativeTransferWithPickupCode(e,t){const i=this.logger.createFnLogger("ConsultativeTransferWithPickupCode",t);if(i.info(`pickup code: ${e}`),!e||isNaN(Number(e)))return i.info("pickup code cannot be empty"),Promise.reject(Vn("TransactionDisallowed"));const n=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),r=`4:${on}`,s={unparkContent:{pickupCode:Number(e)}};return this.signalingSession.transferCallAsync(r,"TransferTypeStandard",s,{disableForwardingAndUnanswered:!1},t),n}callRedirect(e,t=Te()){return this.logger.createFnLogger("CallRedirect",t).info(`redirectOptions: ${JSON.stringify(e)}`),this.stopInternal({terminatedReason:75,redirectOptions:e,causeId:t}).then((()=>({code:Gn.CallRedirected,subCode:jn.CallRedirectedSuccess,phrase:hr,resultCategories:["Success"]})))}convertParkContext(e){switch(e){case 1:return"sharedLinePark";case 4:return"sharedLineParkV2";case 0:return"teamPark";case 3:return"serverHoldV2";case 5:return"callPark";default:return"serverHold"}}convertClientScenario(e){switch(e){case 0:return"breakoutRoom";case 1:return"musicOnHoldV2";case 2:return"sharedLineAppearanceV2";default:return}}park(e,t=Te()){const i=this.convertParkContext(e);return this.logger.info(`[${t}] [ParkCall] start -  context ${e} parkType ${i}`),5===e?(this.callTelemetry.recordOperation(`${Os(i)}`,t),this._pendingParkPromise=this._callOperationHandler.createPendingOperation("CallParkV2",void 0,t)):this._pendingParkPromise=this._callOperationHandler.waitForOperation("ParkCall"),"serverHoldV2"!==i&&"callPark"!==i&&this._setParkState(1),this.signalingSession.parkCallAsync(i,t).catch((e=>{this.logger.info(`[${t}] [ParkCall] error in parkCallAsync (synchronous error) : ${Oe(e)}. Hold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("ParkCall",{error:Oe(e)},t)})),this._pendingParkPromise}async unpark(e,t){const i=this.convertParkContext(e);return this.logger.info(`[${t}] [UnparkCall] start -  context ${e} parkType ${i}`),this._pendingUnparkPromise=this._callOperationHandler.waitForOperation("UnparkCall"),this.signalingSession.unparkAsync(i,t).catch((e=>{this.logger.info(`[${t}] [UnparkCall] error in unparkAsync (synchronous error) : ${Oe(e)}. Unhold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UnparkCall",{error:Oe(e)},t)})),this._pendingUnparkPromise}getServerHoldLocation(){return this._pendingParkPromise.then((()=>(this.logger.info(`getServerHoldLocation ${this.serverHoldLocation}`),this.serverHoldLocation)))}getParkAdditionalContextJson(){return this._pendingParkPromise.then((()=>(this.logger.info(`getParkAdditionalContextJson ${this.parkAdditionalContextJson}`),this.parkAdditionalContextJson)))}getJoinBlob(){return Promise.resolve(JSON.stringify({conversationUrl:this.signalingSession.getConversationUrl(),conversationId:this.callId}))}getTechnicalInformationJson(){return Promise.resolve(JSON.stringify(this.mediaSession.getCallTechnicalInfo()))}isOneToOneCall(){return 1===this.callType&&1===this.participants.length}setMuteOnHold(e,t){this.mediaSession.muteHold(e,t),e||(this.computeCallState(t),this.isMuteOnHold=!1),this.finishCallHoldResume()}finishCallHoldResume(e){e?this.callHoldResumeDeferred?.reject(e):this.callHoldResumeDeferred?.resolve(),this.isHoldInProgress=!1,this.callHoldResumeDeferred=null}computeCallState(e){let t=3;this._callInLobby?t=10:this.signalingSession.participantManager.localParticipant.isStaging&&(t=13),this.logger.info(`[${e}][computeCallState] the call state will be set to ${t}`),this.setCallState(t,e)}async prepareModalitiesForResume(e){this.mediaStateConfigurationHelper.isSending(1)&&await this.turnOnLocalVideoPreview(e)}async prepareModalitiesForHold(e){await this.turnOffLocalVideoPreview(e)}updateMediaState(e,t){this.setVideoOn(e.video===this.mediaAgent.constants.MEDIA_STATE.sendReceive||e.video===this.mediaAgent.constants.MEDIA_STATE.send,t),this.setAudioOn(e.audio===this.mediaAgent.constants.MEDIA_STATE.sendReceive||e.audio===this.mediaAgent.constants.MEDIA_STATE.send,t)}updateScreenSharingState(e,t){this.setScreenSharingOn(e.sharing===this.mediaAgent.constants.MEDIA_STATE.send,t)}onSharingStreamStateChanged(t){const i=Te();this.logger.info(`[${i}] Sharing stream state moved to ${t}`);const n={mediaType:2,mediaDirection:1,mediaStreamState:e.streamingStatetoMediaStreamState(t)};this.event("mediaStreamStateChanged").raise(n),this.callStats.localStats.screenShare.streamStateChanged(t),"stopped"===t&&(this.canToggleScreenSharing=!0,this.stopScreenSharing(),"screenSharingCall"!==this.conversationType||this.participants.some((e=>3===e.state))||this.stop(!0,i))}async startScreenSharing(e,t,i,n=Te()){this.allowScreenSharingControl()&&(this.screenSharingControl.shutdownControlForViewer(),this.screenSharingControl.initControlForSharer(i));const r=this.logger.createFnLogger("StartScreenSharing",n);return r.info("started"),this.canToggleScreenSharing?this.isScreenSharingOn?(r.logSuccess("Resolving early because screen sharing is already on"),Promise.resolve()):(this.screenSharingRenegotiationDeferred&&(r.logFailure("called before the renegotiation deferred for the previous one has been closed"),this.screenSharingRenegotiationDeferred.resolve()),this.screenSharingRenegotiationDeferred=vi(),this.callStats.localStats.newSession(2),this.callStats.localStats.screenShare.start(),this.mediaStateConfigurationHelper.isDisabled(2)&&r.info("sharing modality was skipped till now. Adding it now"),this.canToggleScreenSharing=!1,this.callStats.localStats.screenShare.event(0),this.getScreenHandle(e).acquire().then((()=>(r.logSuccess("sharing stream acquired"),this.mediaStateConfigurationHelper.enableModality(2),this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.updateMediaModalities(void 0,n)))).then((()=>(r.logSuccess("updateMediaModalities done"),this.callStats.localStats.screenShare.negotiationStateChanged("started"),this.setScreenSharingOn(!0,n),this.canToggleScreenSharing=!0,this.screenSharingRenegotiationDeferred.promise))).then((()=>{this.enableControlInjector(),this.callStats.localStats.screenShare.negotiationStateChanged("completed")})).catch((e=>{this.callTelemetry.updateOperationData("StartScreenSharing",{error:Oe(e)},n),this.setScreenSharingOn(!1,n),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!0,this.disposeSharingScreenHandle();const t=e.error;throw t&&t.code===Gn.GlareError?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),r.logFailure("starting screen sharing failure with reason glare")):"ScreenSharingStopped"===e.reason?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","sharingStopped"),r.logFailure("expectedstarting screen sharing failure with reason stopped")):(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","other"),r.logFailure(e)),e}))):Promise.reject(new Error("cannot start screen sharing"))}async stopScreenSharing(e,t,i=Te()){const n=this.logger.createFnLogger("StopScreenSharing",i);if(n.info("started"),!this.canToggleScreenSharing)return n.logFailure("cannot stop screen sharing"),Promise.reject(new Error("cannot stop screen sharing"));if(!this.isScreenSharingOn&&!this._callOperationHandler.hasPendingOperation("StartScreenSharing"))return n.logFailure("screensharing is not on, ignore this operation"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(this.screenSharingRenegotiationDeferred.reject({reason:"ScreenSharingStopped"}),this.screenSharingRenegotiationDeferred=null),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!1;const r=()=>{this.canToggleScreenSharing=!0,this.callStats.localStats.screenShare.stop(),this.disposeSharingScreenHandle(),this.mediaAgent.getDeviceManager().shareSystemSound(!1),this.mediaAgent.getDeviceManager().setAudioSharingRequested(!1)};return this.allowScreenSharingControl()&&this.screenSharingControl.shutdownControlForSharer(),this.updateMediaModalities(void 0,i).then((()=>this.setScreenSharingOn(!1,i))).then(r,(e=>{throw n.logFailure(e),this.callTelemetry.updateOperationData("StopScreenSharing",{error:Oe(e)},i),r(),e}))}async startDataChannel(e,t=Te()){if(!this.allowDataChannel())throw new Error("startDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities({},t)}async stopDataChannel(e,t=Te()){if(!this.allowDataChannel())throw new Error("stopDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.removeModality(3),await this.updateMediaModalities({},t)}allowDataChannel(){return this.mediaSession?!!this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&(this.isOneToOnePSTNCall()?this.mediaSession.getSessionConfig().config.enableDataChannelPstn:this.mediaSession.getSessionConfig().config.enableDataChannel):(this.logger.warn("datachannel not allowed as there is no mediaSession"),!1)}isGiveControlEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?e.enableGiveControl:(this.logger.warn("Give take control is not enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!1)}isInitialSignalingDSHSubscriptionEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?!this.allowDataChannel()||e.enableInitialSignalingDSHSubscription:(this.logger.warn("Initial signaling dsh subscription is enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}isSignalingDSHFallbackEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?e.enableSignalingDSHFallback:(this.logger.warn("Falling back to Signaling DSH is disabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}allowScreenSharingControl(){return this.screenSharingControl?.isScreenSharingControlEnabled()&&this.allowDataChannel()}updateSignalingDSHMessageSubscription(e){this.signalingSession.updateDominantSpeakerHistoryMessageSubscription(e),e&&this.mediaSession?.getDiagnostics?.().dshDiagnostics.setCurrentActiveStrategy("signaling")}async sendUserEvents(e,t){return this.dataChannel.sendUserEvents(e,t)}async shareSystemSound(e,t=Te()){const i=this.logger.createFnLogger("ShareSystemSounds",t,`shareSystemSound=${e}`);if(!(this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing))return i.error("shareSystemSound not allowed"),Promise.reject(60);try{return void this.mediaAgent.getDeviceManager().shareSystemSound(e)}catch{return i.error("shareSystemSound failed with device error"),Promise.reject(58)}}async mute(e=xi()){return this.isMuted?Promise.reject(Vn("TransactionDisallowed")):this.muteUnmute(!0,e)}async unmute(e=xi()){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")&&await this._callOperationHandler.waitForOperation("_PromotionToRealtime"),this.muteUnmute(!1,e)}async muteSpeaker(e=Te()){return this.muteUnmuteSpeaker(!0,e)}async unmuteSpeaker(e=Te()){return this.muteUnmuteSpeaker(!1,e)}async muteParticipants(t,i,n=xi()){const r=this.logger.createFnLogger("MuteParticipants",n,`muteScope=${t}`);r.info(`callParticipants count=${i.length}`);const s=e.convertMuteScope(t);if(void 0===s)return r.logFailure(`Unrecognized ${t}`),Promise.reject(new Error("Unrecognized muteScope"));if(mu(this.state,[11,12]))return r.logFailure("Can not mute/unmute during preheat call"),Promise.reject(60);const a=[];return i.forEach((e=>{a.push(e.id)})),this.signalingSession.muteAsync(s,a,n).then((e=>this.handleParticipantsMutedUpdated(e,n))).catch((e=>(this.callTelemetry.updateOperationData("MuteParticipants",{error:Oe(e)},n),r.logFailure(e),e?.endCode?Promise.reject(e.endCode):Promise.reject(e))))}async startAudio(e,t=Te()){const i=this.logger.createFnLogger("StartAudio",t);if(this.receiveOnlyAudioOnCallStart=!1,3!==this.state)return i.logFailure("Cannot startAudio when call is not connected"),Promise.reject(60);if(this.mediaStateConfigurationHelper.enableModality(0),this.callUsesMixer&&this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.isSending(1))try{await this.turnOnLocalVideoPreview(t)}catch(e){return i.logFailure(e),Promise.reject(25)}const n=await this.startStopAudio(!0,t);return await this.signalingSession.recordTelemetryForStartAudio(n),{code:n}}async stopAudio(e,t=Te()){const i=this.logger.createFnLogger("StopAudio",t);if(3!==this.state)return i.logFailure("Cannot stopAudio when call is not connected"),Promise.reject(60);this.mediaStateConfigurationHelper.removeModality(0);const n=await this.startStopAudio(!1,t);return await this.turnOffLocalVideoPreview(t),await this.signalingSession.recordTelemetryForStopAudio(n),{code:n}}assimilate(e,t,i,n=Te()){return Promise.reject(new Error("Not implemented"))}async merge(e,t,i=Te()){const n=this.logger.createFnLogger("MergeCall",i);n.error(`merge callId ${e.callId} callMergeOptions ${JSON.stringify(t)}`);const r=this.canMerge(e,i);if(!r)return n.info(`Error. ${Ne(r)}`),Promise.reject(Vn("TransactionDisallowed"));const s=[];return e.participants.forEach((e=>{s.push(this._callOperationHandler.createPendingOperation("MergeCall",e.id,i))})),(await this.mergeCallByAddParticipantWithReplaces(t,e.participants,e,1,"MergeCall",i,s,void 0))[0]}async mergeParticipants(e,t,i,n,r){const s=this.logger.createFnLogger("MergeParticipants",n),a=[];if(!e)return Promise.reject(Vn("Invalid callToMerge"));if(0===t.length)return Promise.reject(Vn("Invalid participantIds"));const o=[];for(const i of t){let t=Nd(e,i);if(!t&&kd(e,i)&&(s.info("found self endpoint, use localSignalingParticipant"),t=this.localSignalingParticipant),t){const e=xi(),r={id:t.id,participantId:e,replacementParticipantId:i,nonMaskedId:t.nonMaskedId};a.push(r),o.push(this._callOperationHandler.createPendingOperation("MergeParticipant",e,n))}else{const e={code:406,subCode:5201,phrase:`participantLegId ${i} is invalid!`};o.push(Promise.reject(Vn(e)))}}return this.mergeCallByAddParticipantWithReplaces(i,a,e,3,"MergeParticipant",n,o,r)}async mergeWithPickupCode(e,t,i=Te()){const n=this.logger.createFnLogger("MergeWithPickupCode",i);if(n.info(`mergeWithPickupCode: pickup code: ${e}, groupId: ${we(t.groupId)}, threadId: ${Me(t.threadId)} messageId: ${t.messageId}`),!e||isNaN(Number(e)))return n.info("mergeWithPickupCode: pickup code cannot be empty"),Promise.reject(Vn("mergeWithPickupCode: pickup code cannot be empty"));const r={additionalData:t.additionalData,groupId:t.groupId,threadId:t.threadId,messageId:t.messageId,replacementType:2,pickupCode:Number(e)},s={id:`4:${on}`};return Promise.resolve().then((()=>Promise.all(this.signalingSession.addParticipantsAsync([s],r,i)))).then((e=>(e.length>0&&this.signalingNotifications.onParticipantJoined(e[0],i),Promise.resolve({code:0,subCode:0,phrase:"TransactionComplete"})))).catch((e=>{n.logFailure(`Participant was not added to call, error=${Ne(e)}`);const t=this._handleParticipantOperationFailure("MergeWithPickupCode",e,i,null,!0).reason;return Promise.reject(e?e.endCode:t||0)}))}async setMaxVideoChannels(e){return Promise.reject(60)}async setMaxVbssChannels(e){return Promise.reject(60)}async stop(e=!1,t=Te(),i,n){const r=this.logger.createFnLogger("StopAudio",t);if(6===this.state)return r.logFailure("Trying to stop a call which is already Disconnecting"),Promise.reject(new Error("cannot stop call in Disconnecting state"));if(7===this.state)return r.logFailure("Trying to stop a call which is already Disconnected"),Promise.reject(new Error("cannot stop call in Disconnected state"));if(this.disposedPromise)return Promise.reject("Call already ended");let s=0;1===this.state&&(s=10);const a=n?{clientReasonSubCode:n.clientSubCode,clientReasonPhrase:n.clientPhrase}:{};n?.clientSubCode===_n.VDI_DISCONNECTED&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.enabled&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.clientPhrases.includes(n?.clientPhrase)&&(a.code=Cn.MEDIA_ERROR,a.subCode=_n.VDI_DISCONNECTED,a.phrase=ur,a.resultCategories=["UnexpectedClientError"],s=4);const o={terminatedReason:s,forEveryone:e,causeId:t,...i,rejectReason:a};return this.stopInternal(o)}publishState(e,t){const i=Ns(e.type),n=this.getPluginlessPublishLevel(e.level),r=e.participantIds&&e.participantIds.length>0?"specified":void 0;return this.callTelemetry.setOperationVariant("PublishState","specified"===r?`${i}Specified`:`${i}None`,t),this.signalingSession.publishStateAsync(i,n,t,e.content,r,e.participantIds)}publishStatesForEveryone(e,t){const i=Ns(e.type),n=this.getPluginlessPublishLevel(e.level);return this.callTelemetry.setOperationVariant("PublishState",`${i}All`),this.signalingSession.publishStateAsync(i,n,t,e.content,"all")}removeState(e,t){return this.signalingSession.removeStateAsync(t,"specified",void 0,e.stateIds).then((e=>Promise.resolve()))}removeStatesForEveryone(e,t){const i=Ns(e.type);return this.signalingSession.removeStateAsync(t,"all",i,void 0).then((e=>Promise.resolve()))}updateMeetingSettings(e,t){return this.signalingSession.updateMeetingSettingsAsync({allowRaiseHands:e.allowRaiseHands,attendeeRestrictions:e.attendeeRestrictions,lockMeeting:e.lockMeeting,breakoutRoomsEnabled:e.breakoutRoomsEnabled,allowPresentersToManageBreakoutRooms:e.allowPresentersToManageBreakoutRooms,disableMdpClientAudioRecording:e.disableMdpClientAudioRecording,refreshSettings:e.refreshSettings},t)}updateMeetingGroups(e,t){this.logger.info(`[UpdateMeetingGroups][${e}] options ${Le(t)}`);const i=this._callOperationHandler.waitForOperation("UpdateMeetingGroups",e),n={fromGroup:t.fromGroup,toGroup:t.toGroup,scope:Mp(t.scope)};return t.participants&&(n.participants=function(e){const t=[];for(const i in e)if(e[i].participantLegIdMap)for(const n in e[i].participantLegIdMap){const r=e[i].participantLegIdMap[n].endpointId;t.push({id:i,mri:i,participantId:n,...r&&{endpointId:r}})}else t.push({id:i,mri:i});return t}(t.participants)),this.signalingSession.updateMeetingsGroupsAsync(e,n).catch((t=>{this.logger.info(`[${e}] [UpdateMeetingGroups] error in updateMeetingGroups (synchronous error) : ${Oe(t)}. updateMeetingGroupsPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingGroups",{error:Oe(t)},e)})),i}updateMeetingLiveState(e,t){return this.logger.info(`[UpdateMeetingLiveState][${e}] options ${Le(t)}`),this.signalingSession.updateMeetingLiveStateAsync(e,t).catch((t=>{this.logger.info(`[${e}] [UpdateMeetingLiveState] error in updateMeetingLiveState (synchronous error) : ${Oe(t)}. promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingLiveState",{error:Oe(t)},e)})),this._callOperationHandler.waitForOperation("UpdateMeetingLiveState",e)}updateMeetingStates(e,t=Te()){var i;this.logger.info(`[UpdateMeetingStates][${t}]`);const n={},r=[];e.operationId=e.operationId||t;for(const s of Object.keys(e.meetingStates)){const a=e.operationId+"_"+s;r.push(a);const o=this._callOperationHandler.createPendingOperation("UpdateMeetingStates",a,t);n[i=e.operationId]??(n[i]={}),n[e.operationId][s]=o,this.callTelemetry.recordOperation("UpdateMeetingStates",t,a)}return Promise.resolve().then((()=>this.signalingSession.updateMeetingStatesAsync(t,e))).then((e=>{for(const i of r)this.callTelemetry.updateOperationData("UpdateMeetingStates",{data:Oe(e)},t,i)})).catch((e=>{for(const i of r)this.callTelemetry.updateOperationData("UpdateMeetingStates",{error:Oe(e)},t,i);this.logger.logFailure(e)})).then((()=>n))}async updateParticipantInterpretationState(e,t){if(this.logger.info(`[UpdateParticipantInterpretationState][${e}] options ${Le(t)}`),0===t.length)return Promise.reject(Vn("Invalid UpdateParticipantInterpretationState options"));const i=this.signalingSession.updateParticipantInterpretationStateAsync(e,t),n=[];t.forEach((t=>{n.push(this._callOperationHandler.createPendingOperation("UpdateParticipantInterpretationState",t.id,e))}));for(let n=0;n<i.length;n++){const r=i[n],s=t[n];r.then((()=>{this.logger.logSuccess(`updateParticipantInterpretationState succeeded for [id=${we(s.id)}]`);const t={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("UpdateParticipantInterpretationState",t,s.id,e),this._callOperationHandler.maybeResolveOperation("UpdateParticipantInterpretationState",t,s.id,e)})).catch((t=>{this.logger.error(`[${e}] [UpdateParticipantInterpretationState] error in updateParticipantInterpretationState (synchronous error) : ${Oe(t)}. updateParticipantInterpretationStatePromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateParticipantInterpretationState",{error:Oe(t)},e);const i=this._handleParticipantOperationFailure("UpdateParticipantInterpretationState",t,e,s.id).reason,n=t?.endCode||i||0;this._callOperationHandler.maybeRejectOperation("UpdateParticipantInterpretationState",n,s.id,e)}))}return Promise.resolve(n)}async updateParticipantsProperties(e,t){const i=this.logger.createFnLogger("UpdateParticipantsProperties",t);if(i.info(`options ${we(Le(e))}`),!e)return Promise.reject(Vn("Invalid input: UpdateParticipantsPropertiesContext"));const n={},r=e.scope,s=e.operationId,a=new Set;if("self"===r){const i=this.signalingSession.participantManager.localParticipant.id;for(const r in e.propertyBag){const e=wh(i,s,r),o=this.createUpdateParticipantPromise(e,t);n[e]={[i]:o},a.add(e),this.callTelemetry.recordOperation("UpdateParticipantsProperties",t,we(e))}}else{if("specified"!==r||!this._isUpdatePropertiesSpecifiedAllowedByEcs)return Promise.reject("This scope is not supported.");{const i=e.participants;for(const e of i){const i=e.id;for(const r in e.propertyBag){const e=wh(i,s,r),o=this.createUpdateParticipantPromise(e,t);n[e]={[i]:o},a.add(e),this.callTelemetry.recordOperation("UpdateParticipantsProperties",t,we(e))}}}}return i.info(`promises created: ${we(Le(n))}`),this.signalingSession.updateParticipantsPropertiesAsync(e,a,s,t).catch((e=>{const r=Ne(e);i.info(`[failed][reason=${r}]`);const s={...e};this.callTelemetry.updateOperationData("UpdateParticipantsProperties",{error:Oe(r)},t);for(const e of Object.keys(n))this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",s,e,t)})),Promise.resolve().then((()=>n))}joinMeetingGroup(e,t){this.logger.info(`[JoinMeetingGroup][${e}] options ${Le(t)}`);const i=this._callOperationHandler.waitForOperation("JoinMeetingGroup",e),n={meetingGroupId:t.meetingGroupId,...t.groupPreferences&&{groupPreferences:t.groupPreferences}};return this.signalingSession.joinMeetingGroupAsync(e,n).catch((t=>{const i=Oe(t);this.logger.info(`[${e}] [JoinMeetingGroup] error in joinMeetingGroup (synchronous error) : ${i}. joinMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("JoinMeetingGroup",{error:i},e)})),i}leaveMeetingGroup(e,t){this.logger.info(`[LeaveMeetingGroup][${e}] options ${Le(t)}`);const i=this._callOperationHandler.waitForOperation("LeaveMeetingGroup",e),n={meetingGroupId:t.meetingGroupId};return this.signalingSession.leaveMeetingGroupAsync(e,n).catch((t=>{const i=Oe(t);this.logger.info(`[${e}] [LeaveMeetingGroup] error in leaveMeetingGroup (synchronous error) : ${i}. leaveMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("LeaveMeetingGroup",{error:i},e)})),i}sendMessages(e,t){var i,n;this.logger.info(`[SendMessages][${e}]`);const r={};for(const s of t)if(0===s.scope){const t=this._callOperationHandler.createPendingOperation("SendMessages",s.operationId,e);r[s.operationId]={all:t},this.callTelemetry.recordOperation("SendMessages",e,s.operationId)}else if(1===s.scope)for(const t in s.to)if("participant"===s.to[t].level){const n=Ah(t,s.operationId),a=this._callOperationHandler.createPendingOperation("SendMessages",n,e);r[i=s.operationId]??(r[i]={}),r[s.operationId][t]=a,this.callTelemetry.recordOperation("SendMessages",e,n)}else if("endpoint"===s.to[t].level)for(const i in s.to[t].participantLegIdMap){const t=Rh(i,s.operationId),a=this._callOperationHandler.createPendingOperation("SendMessages",t,e);r[n=s.operationId]??(r[n]={}),r[s.operationId][i]=a,this.callTelemetry.recordOperation("SendMessages",e,t)}return this.signalingSession.sendProxiedMessageAsync(e,t).then((e=>{for(const t of e)t.then((e=>{this._callOperationHandler.maybeResolveOperation("SendMessages",e.transactionEnd,e.resolveString,e.causeId)})).catch((e=>{this._callOperationHandler.maybeRejectOperation("SendMessages",e.transactionEnd,e.resolveString,e.causeId)}));return r}))}updateMonitorSession(e,t=Te()){return Promise.reject(new Error("Not implemented"))}async updateMeetingRoles(e,t,i=Te()){return 3===this.state&&this.signalingSession.hasOwnProperty("updateMeetingRolesAsync")?this.signalingSession.updateMeetingRolesAsync(e,t,i):Promise.reject({code:Cn.CLIENT_ERROR_CODE,subCode:_n.ACTION_NOT_ALLOWED,phrase:"ActionNotAllowed"})}stopInternal(e){const t=this.logger.createFnLogger("stopInternal",e.causeId),i=e.terminatedReason||0;let n=e.rejectReason&&(e.rejectReason.code||e.rejectReason.subCode)?e.rejectReason:this.getRejectionInfoFromTerminatedReason(i);if(e.rejectReason&&(n||(n={}),n.clientReasonSubCode=e.rejectReason.clientReasonSubCode,n.clientReasonPhrase=e.rejectReason.clientReasonPhrase),t.info(`started, terminatedReason=${i}, rejectReason=${Le(n)}`),6===this.state)return t.logFailure("Trying to stop a call which is already Disconnecting"),this.disconnectingPromise;if(7===this.state)return t.logFailure("Trying to stop a call which is already Disconnected"),this.disconnectingPromise;this.setCallState(6,e.causeId,i);const r={causeId:e.causeId,forEveryone:e.forEveryone,scope:this.mapEndpointScope(e.scope),redirectOptions:e.redirectOptions&&Wu(e.redirectOptions)};return 1===e.scope&&(n.code=Cn.SUCCESS,n.subCode=_n.ENDED_BY_REMOTE_ENDPOINT,n.phrase=dr),this.disconnectingPromise=Promise.all([this.cleanUpMedia(e.causeId,n).catch((e=>{throw t.logFailure(`cleanUpMedia failed with reason=${Ne(e)}`),e})),this.signalingSession.endAsync(n,r).catch((e=>{throw t.logFailure(`endAsync failed with reason=${Ne(e)}`),e}))]).catch((i=>{throw t.logFailure(i),this.cleanUp(e.causeId,n),i})).then((()=>this.cleanUp(e.causeId,n))).catch((t=>{throw this.callTelemetry.updateOperationData("StopCall",{error:Oe(t)},e.causeId),this.setCallState(7,e.causeId,i),t})),this.disconnectingPromise}async cleanUp(e,t){return this.logger.info(`[${e}][cleanup]start`),this.disposedPromise||(this.disposedPromise=this.cleanUpFinalize(e,t),this._getCallEndOperation().catch(yn).then((()=>{const t={code:Cn.CLIENT_ERROR_CODE,subCode:_n.ABANDONED};this._callOperationHandler.rejectPendingOperations(61,e,t),this._participantOperationHandler.rejectPendingOperations(47,e,t)}))),this.disposedPromise}async cleanUpMedia(e,t){return this.mediaDisposedPromise||(this.mediaDisposedPromise=(async()=>{this.callDeviceManager?.dispose(),this.callDeviceManager=null,this.turnOffLocalVideoPreview(e),this.localVideoContainer=null,this.disposeContentSharingSessions(),this.disposeSharingScreenHandle();const i=this.mediaSession;if(this.reportMediaStats=!!i,!i)return;this.unmixedAudioProvider.dispose(),this.mediaControlPlane.dispose(),this.dataChannel.dispose(),this.screenSharingControl.dispose(e),this.mediaSession=null,this.streamManager.setMediaSession(null,e),this.participants?.forEach((t=>{t.setMediaSession(null,e)}));const n=i.terminate(e,t);this.isVideoOn=!1,this.setMediaStream(this.isVideoOn,!1,1),this.setMediaStream(!1,!1,2),this.setMediaStream(!1,!1,0),this.isScreenSharingOn=!1,this.screenSharingRenegotiationDeferred?.reject(t),this.screenSharingRenegotiationDeferred=null,this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.removeModality(0),this.mediaStateConfigurationHelper.removeModality(3),this.mediaStateConfigurationHelper.removeModality(2),i?.getSessionConfig()?.config?.useOneDsLogger&&i.getSessionConfig().config.addTelemetryReportingCallback&&window.removeEventListener("beforeunload",this.beforeUnloadTelemetrySender);try{await n}finally{await this.collectCallStats(i)}})()),this.mediaDisposedPromise}async cleanUpFinalize(e,t){try{await this.cleanUpMedia(e,t)}catch(t){this.logger.info(`[${e}][cleanUpMedia] failure: ${Ne(t)}`)}const i=this.reportCallEndStats(this.reportMediaStats);this.mediaSession?.getSessionConfig().config.waitReportStatsAtCallStop&&await i}async createContentSharingSession(e,t,i,n,r=Te()){if("attendee"===(this.advancedMeetingRole||this.meetingRole)){const e={terminatedReason:8,terminatedReasonCode:403,terminatedReasonSubCode:0,errorMessage:"Failed due to insufficient permissions"};return Promise.reject(e)}const s=new jg(this.callTelemetry,this.logger,this.signalingSession,e,t,n,i);return this.contentSharingSessions.push(s),s.changed((()=>this.removeContentSessionIfEnded(s))),this.event("contentSharingChanged").raise(),Promise.resolve(s)}stopWithBeacon(e=Te()){return 6===this.state||7===this.state||this.signalingSession.endWithBeacon(e)}disposeContentSharingSessions(){this.contentSharingSessions.forEach((e=>{e.dispose(),this.removeContentSessionIfEnded(e)})),this.event("contentSharingChanged").raise()}isPreheatedOnly(){return!!(12===this.state||2===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall")||9===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))}removeContentSessionIfEnded(e){7!==e.contentSharingStatus&&8!==e.contentSharingStatus||(this.logger.info("stopping the content sharing session."),(0,Sr.remove)(this.contentSharingSessions,(t=>t.contentSharingGuid===e.contentSharingGuid)).length&&this.event("contentSharingChanged").raise())}getRejectionInfoFromTerminatedReason(e){switch(e){case 53:return{code:Gn.MediaError,subCode:jn.MediaWhiteListingIssue,phrase:sr};case 4:return{code:Gn.MediaError,subCode:this._wasAudioStreamConnected?jn.MediaDropAfterConnect:jn.MediaDropDuringConnect,phrase:this._wasAudioStreamConnected?tr:er};case 47:return{code:Gn.MediaError,subCode:jn.MediaOfferProcessingError,phrase:ir};case 38:return{code:Gn.MediaError,subCode:jn.MediaRenegotiationError,phrase:cr};case 10:return{code:Gn.Reject,subCode:jn.Success,phrase:lr};case 25:return{code:Gn.UnknownError,subCode:jn.MediaUnknownError,phrase:Xn};case 58:return{code:Gn.MediaError,subCode:jn.MediaPermissionError,phrase:Zn};case 7:return{code:Gn.UnknownError,subCode:jn.Success,phrase:Qn};case 0:case 1:return{code:Gn.Success,subCode:jn.Success,phrase:lr};case 75:return{code:Gn.CallRedirected,subCode:jn.CallRedirectedSuccess,phrase:hr,resultCategories:["Success"]};case 77:return{code:Gn.Success,subCode:jn.Suspended,phrase:gr}}return null}async acknowledge(e,t,i=Te()){const n=this.logger.createFnLogger("Acknowledge",i),r=Date.now();if(this.setInitialTelemetry("Acknowledge",{callStartTime:r},"",i),0!==this.state&&8!==this.state)throw new Error(`Trying to acknowledge a call that has already been acted on ${this.state}`);n.info(`isMultiParty=${e.isMultiParty}`),n.info(`fromMixer=${e.fromMixer}`),n.info(`participantId=${e.participantId}`),n.info(`callType=${e.callType}`),this.attachToCallAndGetOffer=vi(),this.setCallType(e.isMultiParty?2:1,i),this.setCallUsesMixer(!!e.fromMixer,i),this.setCallerMri(du(e.callerId)),this.setTransferorMri(e.transferorId),this.transferorType=e.transferorType,this.transferorDisplayName=e.transferorDisplayName,this.incomingCallType=e.callType,this.consultativeCallId=e.consultativeCallId,this.callQueueInfo=e.callQueueInfo,this.setFromApplicationType(e.fromApplicationType,i),this.callStats.localStats.startCall();const s=pu(n);try{if(s.executeSync("ProcessIncomingCallRequest",(()=>this.signalingSession.processIncomingCallRequest(e,t,i))),this.setParticipantId(this.participantId),s.executeSync("ResolvePotentialConflict",(()=>this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)))===this.signalingSession)return Promise.reject({code:7,success:!1});const r=async()=>{s.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(i))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled());const e=this.signalingSession.getInitialMediaOfferFromIncomingCallPayload();this.callStats.setParticipantId(this.participantId),this.onBehalfOfMri=this.signalingSession.onBehalfOf,this.onBehalfOfUserDisplayName=this.signalingSession.onBehalfOfUserDisplayName,this.callQueueContext=this.signalingSession.callQueueContext,this.callPhoneLineType=this.signalingSession.callPhoneLineType;const t=await s.execute("WaitForMediaOffer",(()=>e?Promise.resolve(e):this.attachToCallAndGetOffer.promise));let r;try{r=await s.execute("ProcessOffer",(()=>this.mediaSession.processOfferAsync(t,i)))}catch(e){r=await this._handleOfferProcessingError(e,i,n)}await s.execute("ProcessOfferedModalities",(()=>this._processOfferedModalities(r,i))),await s.execute("TrySendingProvisionalAnswer",(()=>this._trySendProvisionalMediaAnswer(i)))},a=(()=>s.execute("SendAttach",(()=>this.signalingSession.sendAttachToCall(i))).then((()=>this.setCallState(1,i))))();return await Promise.all([a,r()]).catch((async e=>{throw await a,e})),s.executeSync("OnAcknowledgeSuccess",(()=>this._onAcknowledgeSuccess(n,s.getTelemetryData(),i)))}catch(e){return this._onAcknowledgeError(e,i,n,s.getTelemetryData())}}async accept(e,t=Te()){const i=this.logger.createFnLogger("Accept",t);if(i.info(`accept, answerMediaType: ${e.answerMediaType},\n                            withVideo: ${e.withVideo},\n                            muted: ${e.muted},\n                            getSendMediaModalities: ${JSON.stringify(e.sendMediaModalities)},\n                            clientEndpointCapabilities: ${e.clientEndpointCapabilities},\n                            muteFlags: ${e.muteFlags}`),1!==this.state)throw new Error("Only calls in Notified state can be accepted");this.setCallOptions({callStartOptions:e,callStartTime:Date.now()}),this.setSessionIceTransportPolicy(e?.mediaConfiguration);const n=this._callOperationHandler.createPendingOperation("_ConnectCall",void 0,t);this.callStats.localStats.audio.start();const r=pu(i);this.mediaSession.createAudioElement(t);const s=e.muted||!(1&~e.muteFlags);this.setMuted(s?2:this.isServerMuted?1:0,t),this.setCallState(2,t),this.connectCallPromise=this._callOperationHandler.waitForOperation("Accept");try{e.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient(),this.mediaStateConfigurationHelper.setCallAcceptOptions(e),this.mediaStateConfigurationHelper.isSending(1)&&await r.execute("StartVideoSafe",(()=>this.startVideoSafe(t))),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,t);const s=await r.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,t))),a=r.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(s))),o=await r.execute("evaluateEndpointStatesForAccept",(()=>this.evaluateEndpointStatesForAccept(2===this._muteState,e?.additionalEndpointProperties,t))),c=r.execute("handleEndpointStatesForAccept",(()=>this.handleEndpointStatesForAccept(o,t)));i.info("Queued the handleEndpointStatesForAccept");const l=await r.execute("CreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,t)));await r.execute("Accept",(()=>this.signalingSession.acceptAsync(l,a,e.clientEndpointCapabilities,t))),await r.execute("WaitForConnect",(()=>n)),this.handleRemoteParticipantStateInOneToOneCall(t),await r.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(t))),await c,this.callTelemetry.updateOperationData("Accept",{phases:r.getTelemetryData()},t)}catch(e){let n=7,r={};throw this.callTelemetry.updateOperationData("Accept",this.getTelemetryFromPhaseExecution(e),t),e?.error&&(r={...e.error}),uu(mr,e)&&(n=47),this.mediaSession?.getSessionConfig().config.stopCallOnAcceptFailure&&this.stopInternal({terminatedReason:n,causeId:t,rejectReason:r}),e.terminatedReason=n,i.logFailure(e),e}}async reject(e=Te(),t){const i=t?{clientReasonSubCode:t.clientSubCode,clientReasonPhrase:t.clientPhrase}:{};return 1!==this.state?Promise.reject(60):this.stopInternal({terminatedReason:10,causeId:e,rejectReason:i})}async join(e,t={},i=Te()){const n=Date.now();return this.setInitialTelemetry("JoinCall",{callStartOptions:t,callStartTime:n},e.conversationUrl,i),this.setCallerMri(du(e.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinCall"),this.joinOrStartCall({callStartOptions:qu(t),callStartTime:n},this.joinGivenConversation,i,e.conversationUrl)}async joinPreheatedCall(e,t){const i=this.logger.createFnLogger("JoinPreheatedCall",t),n=this.isServerMuted||!(1&~e.muteFlags),r=!(2&~e.muteFlags),s=pu(i);this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinPreheatedCall");try{const i={endpointProperties:{preheatProperties:0}};this.setCallState(2,t),this.isCallModeStreaming()||(n?i.state={isMuted:!0}:(await s.execute("UnmuteInput",(()=>this.mediaSession.unmuteInputAsync(t))),this.setMuted(0,t)),r||(await s.execute("UnmuteOutput",(()=>this.mediaSession.unmuteOutputAsync(t))),this.setSpeakerMuted(!1,t))),await this.signalingSession.updateEndpointState(i,t,e.publishedStates),this.computeCallState(t)}catch(e){const n=7;let r;return i.logFailure(` error: ${n} ${Ne(e)}`),Fn(e)?r=e:gu("UnmuteInput",e)?r={code:Gn.LocalError,subCode:jn.MediaUnmuteMicrophoneError,phrase:Ne(e),causeId:t}:gu("UnmuteOutput",e)&&(r={code:Gn.LocalError,subCode:jn.MediaUnmuteSpeakerError,phrase:Ne(e),causeId:t}),this.callTelemetry.updateOperationData("JoinPreheatedCall",{phases:s.getTelemetryData(),error:Oe(e)},t),this.stopInternal({causeId:t,terminatedReason:n,rejectReason:r}),Promise.reject(r)}}async start(e={},t=Te()){const i=Date.now();return this.setCallerMri(lu+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCall",{callStartOptions:e,callStartTime:i},"",t),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCall"),this.joinOrStartCall({callStartOptions:qu(e),callStartTime:i},this.startOutgoingCall,t)}async startCallToVoicemail(e,t=Te()){const i=Date.now();return this.setCallerMri(lu+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCallToVoiceMail",{callVoicemailStartOptions:e,callStartTime:i},"",t),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallToVoiceMail"),this.joinOrStartCall({callVoicemailStartOptions:e,callStartTime:i},this.startVM,t)}async joinCallWithoutCallModality(e,t={},i=Te()){const n=Date.now();this.setCallerMri(e.groupCallInitiator),this.setCallType(2,i);const r={callStartOptions:qu(t),callStartTime:n};return this.setInitialTelemetry("Subscribe",r,e.conversationUrl,i),0!==this.state?(this.logger.info(`[${i}][joinCallWithoutCallModality]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(r),this.setCallState(8,i),this.signalingSession.subscribeToCall(e.conversationUrl,this.callId,t.clientEndpointCapabilities,{meetingRegistrationId:t.meetingRegistrationId,participantPin:t.participantPin,clientEndpointDebugContent:t.clientEndpointDebugContent,additionalEndpointProperties:t.additionalEndpointProperties},i).catch((e=>Fn(e)?(this.logger.info(`[${i}][joinCallWithoutCallModality] ${Ne(e)}`),Promise.reject(e)):Promise.reject(Bu(e)))),this._callOperationHandler.waitForOperation("Subscribe",void 0,i))}startWithMeetingData(e,t){const i=Date.now();return this.setCallerMri(lu+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartWithMeetingData",{callStartOptions:t,callStartTime:i},"",e),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartWithMeetingData"),this.joinOrStartCall({callStartOptions:qu(t),callStartTime:i,meetingPreferences:{shouldResurrect:t.shouldResurrect}},this.startOutgoingCall,e)}joinWithMeetingData(e,t,i){const n=Date.now();return this.setInitialTelemetry("JoinWithMeetingData",{callStartOptions:i,callStartTime:n},t.conversationUrl,e),this.setCallerMri(du(t.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinWithMeetingData"),this.joinOrStartCall({callStartOptions:qu(i),callStartTime:n,meetingPreferences:{shouldResurrect:i.shouldResurrect}},this.joinGivenConversation,e,t.conversationUrl)}subscribeWithMeetingData(e,t,i){const n=Date.now();this.setCallerMri(t.groupCallInitiator),this.setCallType(2,e);const r={callStartOptions:qu(i),callStartTime:n};return this.setInitialTelemetry("SubscribeWithMeetingData",r,t.conversationUrl,e),0!==this.state?(this.logger.info(`[${e}][subscribeWithMeetingData]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(r),this.setCallState(8,e),this.signalingSession.subscribeToCall(t.conversationUrl,this.callId,i.clientEndpointCapabilities,{meetingPreferences:{shouldResurrect:i.shouldResurrect},meetingData:this.meetingData,meetingRegistrationId:i.meetingRegistrationId,participantPin:i.participantPin,additionalEndpointProperties:i.additionalEndpointProperties},e).catch((t=>Fn(t)?(this.logger.info(`[${e}][subscribeWithMeetingData] ${Ne(t)}`),Promise.reject(t)):Promise.reject(Bu(t)))),this._callOperationHandler.waitForOperation("SubscribeWithMeetingData",void 0,e))}async startCallWithNudge(e,t={},i=Te()){this.setCallerMri(lu+this.currentUserSkypeIdentity.id),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallWithNudge");const n=Date.now();if(this.logger.info(`[${i}][startCallWithNudge]startCallWithNudge for participants: ${function(e){return e.forEach(we)}(e)}`),this.participants.length)return Promise.reject(48);if(t.isCast&&t.isHuddleGroupCall)return this.logger.logFailure(`isCast: ${t.isCast} isHuddleGroupCall: ${t.isHuddleGroupCall}`),Promise.reject(new Error("isCast or isHuddleGroupCall can only be set exclusively."));const r={};return r.callStartOptions=qu(t),r.invitationType=Yr.INVITATION_TYPE.NUDGE,r.participantsToNudge=e,r.callStartTime=n,this.setInitialTelemetry("StartCallWithNudge",r,"",i),this.joinOrStartCall(r,this.startOutgoingCall,i)}async startAndUnpark(e,t,i={},n=Te()){this.setCallerMri(lu+this.currentUserSkypeIdentity.id);const r=this.logger.createFnLogger("StartCallAndUnpark",n),s=Date.now();this.setInitialTelemetry("StartCallAndUnpark",{callStartTime:s},"",n),r.info(`startAndUnpark for context: ${e}, pickupCode :${t}`),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallAndUnpark");const a={};switch(a.callStartOptions=qu(i),a.pickupCode=t,a.parkContext=on,e){case 0:a.parkContext=sn;break;case 1:a.parkContext=an;break;case 5:a.parkContext=cn;break;case 2:a.parkContext=on;break;default:throw new Error(`[startAndUnpark] unsupported ParkContext name: ${e}`)}return this.addParticipant(`4:${a.parkContext}`).catch((e=>r.logFailure("Failed to add participant to unparked call"))),this.joinOrStartCall(a,this.startOutgoingCall,n)}async admitParticipant(e,t=Te()){const i=hu(e),n=this.getParticipant(i),r=this._getParticipantLegId(n),s=r?{participantLegId:r}:{};if(n&&7!==n.state){const i={code:0,subCode:3552,phrase:"Participant is not in lobby state"};return this.callTelemetry.maybeRecordOperationSuccess("AdmitParticipant",i,e,t,s),Promise.reject(i)}return this.admitParticipantToCall(i,t,r)}admit(e,t){return this.signalingSession.admitAsync(t)}async callMeBack(e,t,i=Te()){const n=hu(`${lu}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri);return this.addCallMeBackParticipant(e,t||n,i)}async addParticipant(e,t={},i=Te()){return(await this.addParticipantsImpl([e],t,i,"addParticipant"))[0]}async addParticipants(e,t={},i=Te()){return this.addParticipantsImpl(e,t,i,"addParticipants")}async addParticipantsImpl(e,t={},i=Te(),n){if(this.logger.info(`[${i}][${n}] start`),this.isEmergency&&0===this.state&&(0!==this.participants.length||1!==e.length))return Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"));if(t.participantInvitationData)try{JSON.stringify(t.participantInvitationData)}catch(e){throw this.logger.info(`[${i}][${n}] ${e}`),e}const r=[],s=[];if(e.forEach((e=>{const t=this.getOrCreateParticipant(e,i,!0);0===t.state||4===t.state?(s.push(t),r.push(this._participantOperationHandler.createPendingOperation("AddParticipant",t.id,i))):3===t.state?r.push(Promise.resolve(t)):this._participantOperationHandler.hasPendingOperationWithOperationId("AddParticipant",t.id)&&r.push(this._participantOperationHandler.waitForOperation("AddParticipant",t.id))})),0===s.length)return Promise.resolve(r);const a=!!t.disableUnmute,o=this.addParticipantsToCall(s,i,t.participantInvitationData,t.groupId,t.threadId,t.messageId,a,t.alternateId,t.customHeaderContext);return(0,Sr.zip)(o,s).forEach((async([e,t])=>{try{await e;const n=this._getParticipantLegId(this.getParticipant(t.id)),r=n?{participantLegId:n}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},t.id,i,r),this._participantOperationHandler.maybeResolveOperation("AddParticipant",t,t.id,i)}catch(e){this._participantOperationHandler.maybeRejectOperation("AddParticipant",e,t.id,i)}})),this.raiseChanged(this._participantChangedEventSkipConfig),Promise.resolve(r)}async nudgeParticipants(e,t,i={},n=Te()){return 2!==this.state&&3!==this.state?Promise.reject(48):this.signalingSession.nudgeParticipantsAsync({participantsIds:t,causeId:n,invitationData:i.participantInvitationData,newGroupId:i.groupId,newThreadId:i.threadId,newMessageId:i.messageId})}mapEndpointScope(e){let t="none";switch(e){case 0:t="specified";break;case 1:case 1:t="all";break;default:t="none"}return t}async removeParticipant(e,t=Te(),i,n){const r=this.logger.createFnLogger("removeParticipant",t);r.info("start");const s=this.mapEndpointScope(n);return this.signalingSession.removeParticipantAsync({id:e,endpointId:i},t,s).catch((i=>{r.logFailure(`Participant was not removed from call, error=${i}`);const n=this._handleParticipantOperationFailure("RemoveParticipant",i,t,e).reason;return Promise.reject(n||38)}))}async searchParticipants(e,t){return this.signalingSession.searchParticipantsAsync(e.searchQueryOptions,t)}async getAllParticipants(e,t){return this.signalingSession.getAllParticipantsAsync(e.scope,t)}set dominantSpeakerInfo(e){this.internalDominantSpeakerInfo=e}get dominantSpeakerInfo(){return this.internalDominantSpeakerInfo?this.internalDominantSpeakerInfo:this.mediaSession?.getSessionConfig().config.emptyInitialDSH?{speakerList:[],timestamp:null,noCurrentDominantSpeaker:!1}:{speakerList:this.participants.filter((e=>3===e.state)).map((e=>e.id)),timestamp:null,noCurrentDominantSpeaker:!1}}set slowedDownActiveTalkerInfo(e){(0,Sr.isEqual)(this.internalSlowedDownActiveTalkerInfo?.speakerList,e.speakerList)||(this.internalSlowedDownActiveTalkerInfo=e,this.raiseChanged())}get slowedDownActiveTalkerInfo(){return this.internalSlowedDownActiveTalkerInfo}startVideoSafe(e){return this.startVideo(e).catch((t=>{this.logger.info(JSON.stringify(t),"startVideoSafe",e)}))}async joinOrStartCall(e,t,i,n){const r=this.logger.createFnLogger("joinOrStartCall",i);if(0!==this.state&&8!==this.state&&!e.isPromotingToRealtime){const e="Trying to start a call that has already been acted on";return r.logFailure(e),Promise.reject(60)}if(this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)===this.signalingSession)return Promise.reject(57);this.callStats.localStats.startCall();const s=8===this.state||1!==this.participants.length;r.info(`isMultiparty=${s}, reason: participants.length=${this.participants.length}`),this.setCallType(s?2:1,i),this.setCallUsesMixer(s,i),this.setCallOptions(e);const a=e.callStartOptions||{};if(1&~a.preheatFlags){const e=!!a&&(a.muted||!(1&~a.muteFlags));this.setMuted(e?2:this.isServerMuted?1:0,i),this.setCallState(2,i)}else this.setMuted(2,i),this.setSpeakerMuted(!0,i),this.setCallState(11,i);const o=((e,t,i,n,r)=>{if(e){if(e.meetingUrl)return"MeetingUrl";if(e.meetingCode)return"MeetingCode"}return t||i?"ThreadContext":n?"GroupId":r?"Awareness":""})(this.meetingData,this.threadId,this.messageId,this.groupId,!!n);this.callTelemetry.setJoinedFrom(o),this.signalingSession.setJoinedFrom(o),this.setHuddleGroupCall(!!e.callStartOptions?.isHuddleGroupCall);const c=this._callOperationHandler.createPendingOperation("_ConnectCall","",i);return c.catch(yn),await this.joinOrStartWithMedia(e,t,e.callStartTime,c,i,n),e.callStartOptions?.meetingRegistrationId&&this.callTelemetry.setHasMeetingRegistrationId(!0),e.callStartOptions?.participantPin&&this.callTelemetry.setHasParticipantPin(!0),c}setSessionIceTransportPolicy(e){const t=e?.connectionType;let i=Qe.ICE_TRANSPORT_POLICY.all;switch(t){case"AllSupported":i=Qe.ICE_TRANSPORT_POLICY.all;break;case"NoDirectConnection":i=Qe.ICE_TRANSPORT_POLICY.relay}this.mediaSession?.getSessionConfig().setIceTransportPolicy?.(i)}async joinOrStartWithMedia(e,t,i,n,r,s){const a=this.logger.createFnLogger("joinOrStartWithMedia",r);this.callStats.localStats.audio.start();const o=e.callStartOptions,c=o&&1&o.preheatFlags,l=pu(a);if(e.callStartOptions?.sendMediaModalities&&(this.mediaStateConfigurationHelper=new zu(e.callStartOptions.sendMediaModalities)),this._preferredMpLocation){e.callStartOptions=e.callStartOptions||{};const t=e.callStartOptions.clientEndpointDebugContent?JSON.parse(e.callStartOptions.clientEndpointDebugContent):{};e.callStartOptions.clientEndpointDebugContent=JSON.stringify({preferredMpLocation:this._preferredMpLocation,...t})}try{o&&!c&&this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)&&this.mediaStateConfigurationHelper.isSending(2)&&(this.setCallUsesMixer(!0,r),await this.getScreenHandle().acquire()),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,r),this.callUsesMixer||this.mediaStateConfigurationHelper.disableModality(2),a.info(`skipSharingModality=${!this.callUsesMixer}`),l.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(r))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.getSessionConfig().config.alwaysNegotiateDataChannel&&this.mediaStateConfigurationHelper.enableModality(3),this.setSessionIceTransportPolicy(e?.callStartOptions?.mediaConfiguration),this.mediaSession.createAudioElement(r),this.callUsesMixer||s||this.isOneToOnePSTNCall()||e.callVoicemailStartOptions||(this.isSomeoneStreamingVideo=!0);const d=this._callOperationHandler.createPendingOperation("_WaitForAnswer","",r,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});d.catch(yn);let h=!1;e.isPromotingToRealtime?(this.isSpeakerMuted=!0,h=!0,await l.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(r))),await l.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(r)))):o&&(c?(h=!0,await l.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(r))),await l.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(r))),this.setMuted(2,r),this.setCallUsesMixer(!0,r)):this.mediaStateConfigurationHelper.isSending(1)&&await l.execute("StartVideoSafe",(()=>this.startVideoSafe(r)))),o?.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient();const u=await l.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,r))),g=await l.execute("CreateOffer",(()=>this.mediaSession.createOfferAsync(r))),p=l.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(this.calculateModalityDirections({},r))));if(this.mediaStateConfigurationHelper.isSending(2)&&this.updateScreenSharingState(u,r),h||(await l.execute("MuteUnmute",(()=>this.muteUnmute(2===this._muteState,r))),await l.execute("MuteUnmuteSpeakers",(()=>this.muteUnmuteSpeaker(this.isSpeakerMuted,r)))),l.executeSync("CallStart",(()=>t(r,e,g,p,i,s))),await l.execute("WaitForConnect",(()=>n)),!this.isCallModeStreaming()||e.isPromotingToRealtime){const e=await l.execute("WaitForAnswer",(()=>d));if(!this.mediaSession?.processAnswerAsync)throw{error:"NoMediaSession",phase:"ProcessAnswer"};await l.execute("ProcessAnswer",(()=>this.mediaSession.processAnswerAsync(e,r,!1))),await l.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(r)))}this.callTelemetry.updateOperationData("_ConnectCall",{phases:l.getTelemetryData()},r),2!==o?.screenshareDirection&&4!==o?.screenshareDirection||(this.screenSharingControl.initControlForSharer(""),this.enableControlInjector())}catch(e){this.catchJoinOrStartCallError(e,r,a,l.getTelemetryData())}}catchJoinOrStartCallError(e,t,i,n){let r,s=0;throw i.logFailure(Ne(e)),e?.error&&(r={...e.error}),gu("MuteInput",e)?(s=7,r={code:Gn.LocalError,subCode:jn.MediaMuteMicrophoneError,phrase:Ne(e),causeId:t}):gu("MuteOutput",e)?(s=7,r={code:Gn.LocalError,subCode:jn.MediaMuteSpeakerError,phrase:Ne(e),causeId:t}):e?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer||uu(mr,e)?s=47:e?.type===this.mediaAgent.constants.MEDIA_ERROR.permissionDeniedError?(s=58,r={code:Gn.MediaError,subCode:jn.MediaPermissionError,phrase:Ne(e),causeId:t}):gu("WaitForAnswer",e)||gu("WaitForConnect",e)?s=e.error:uu(pr,e)&&(s=7),this.callTelemetry.updateOperationData("_ConnectCall",this.getTelemetryFromPhaseExecution(e),t),this.callSetupFailed=!0,Promise.all([this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",s,"",t),this._callOperationHandler.maybeRejectOperation("_ConnectCall",s,"",t)]).then((()=>{this.isPromotingToRealtime()||this.stopInternal({causeId:t,terminatedReason:s,rejectReason:r})})).catch(yn),s}addCallMeBackParticipant(e,t,i){const n=this._participantOperationHandler.waitForOperation("CallMeBack",e),r=this.logger.createFnLogger("CallMeBack",i),s={id:e,assertedId:t};return this.signalingSession.callMeBackAsync(s).then((()=>{r.logSuccess(`successfully executed call me back, participantId = ${we(e)}`),this._participantOperationHandler.resolveOperation("CallMeBack",0,e)})).catch((n=>{r.logFailure(`Call me back failed, participantId = ${we(e)}, error = ${n}`),this._handleParticipantOperationFailure("CallMeBack",n,i,t,!1);const s=this._processError(n);let a={};s&&(a={...s}),a.failureReason=s.reason?s.reason:11,this._participantOperationHandler.rejectOperation("CallMeBack",a,e)})),n}addParticipantsToCall(e,t,i,n,r,s,a,o,c){const l=this.logger.createFnLogger("addParticipantsToCall",t);e.forEach((e=>{e.setState(1,void 0,t)}));const d=e.map((e=>({id:e.mri})));l.info(`participantIds=${e.map((e=>we(e.id)))}, disableUnmute=${a}`);const h={additionalData:i,groupId:n,threadId:r,messageId:s,disableUnmute:a,alternateId:o,customHeaderContext:c};try{const e=this.signalingSession.addParticipantsAsync(d,h,t);return(0,Sr.zip)(e,d).map((async([e,i])=>{try{const n=await e;this.signalingNotifications.onParticipantJoined(n,t);const r=this._getParticipantLegId(this.getParticipant(i.id)),s=r?{participantLegId:r}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},n.id,t,s)}catch(e){const n=this._handleParticipantOperationFailure("AddParticipant",e,t,i.id).reason;throw this._removeParticipant(i,t,n),n}}))}catch(e){return l.logFailure(`Participants was not added to call, error=${e}`),(0,Sr.range)(d.length).map((()=>Promise.reject(1)))}}async mergeCallByAddParticipantWithReplaces(e,t,i,n,r,s,a,o){const c=this.logger.createFnLogger("mergeCallByAddParticipantWithReplaces",s),l=this.convertClientScenario(o),d={additionalData:e.additionalData,groupId:e.groupId,threadId:e.threadId,messageId:e.messageId,callIdToReplace:i.callId,replacementType:n,clientScenario:l},h=await this.signalingSession.addParticipantsAsync(t,d,s);for(let e=0;e<h.length;e++){const i=3===n?t[e].participantId:t[e].id;try{await h[e],c.logSuccess(` [participantInfos id =${we(t[e].id)}]`);const n={debugContent:{replacementParticipantLegId:t[e].replacementParticipantId||void 0,clientScenario:l},participantLegId:t[e].participantId},a={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(r,a,i,s,n),this._callOperationHandler.maybeResolveOperation(r,a,i,s)}catch(n){c.logFailure(`Participant was not added to call, error=${Le(n)}`);const a=this._handleParticipantOperationFailure(r,n,s,i,!0,l).reason;this._removeParticipant(t[e],s,a);const o=n?n.endCode:a||0;this._callOperationHandler.maybeRejectOperation(r,o,i,s)}}return Promise.resolve(a)}admitParticipantToCall(e,t,i){const n=this.logger.createFnLogger("admitParticipantToCall",t),r={id:e};return n.info("start"),this.signalingSession.admitParticipantAsync(r,t).then((r=>{n.info(`successfully admitted participant to call, participantId = ${we(e)}`);const s=i?{participantLegId:i}:{};this.callTelemetry.recordOperationSuccess("AdmitParticipant",{code:0,subCode:0,phrase:""},e,t,s)})).catch((i=>{n.logFailure(`Participant was not admitted to call, error=${i}`);const r=this._handleParticipantOperationFailure("AdmitParticipant",i,t,e);return Promise.reject(r)}))}_processError(t){let i;const n={reason:i};if(t?.endCode){const r=$u(t.endCode.code,t.endCode.subCode);i=e.getParticipantReasonFromTerminatedReason(r),n.reason=i,n.code=t.endCode.code,n.subCode=t.endCode.subCode,n.resultCategories=t.endCode.resultCategories,n.phrase=t.endCode.phrase}else n.phrase=`${t}`;return this.logger.info(`_processError error=${t} telemetryData=${JSON.stringify(n)}`),n}_handleParticipantOperationFailure(e,t,i,n,r=!0,s){this.callTelemetry.updateOperationData(e,{error:Oe(t)},i,n);const a=this._processError(t),o=this.getParticipant(n);a.code&&o&&(o.callEndDiagnosticsInfo={callControllerCode:a.code,callControllerSubCode:a.subCode,phrase:a.phrase,resultCategories:a.resultCategories});try{if(r){const t={debugContent:{clientScenario:s},participantLegId:this._getParticipantLegId(o)||void 0};this.callTelemetry.recordOperationFailure(e,a,n,i,t)}}catch(e){this.logger.info(`_handleParticipantOperationFailure errow during recordOperationFailure ${e}`)}return a}_getParticipantLegId(e){return(0,Sr.has)(e,"endpoints.endpointDetails")&&e.endpoints.endpointDetails.length&&e.endpoints.endpointDetails[0].participantId?e.endpoints.endpointDetails[0].participantId:null}isOneToOnePSTNCall(){const e=this.signalingSession.isIncomingCall?this.callerMri:this.participants.length>0?this.participants[0].id:"";return this.isOneToOneCall()&&(0,Sr.startsWith)(e,"4:")&&(!this.incomingCallType||!this.callUsesMixer)}isParkedCall(){return this.isOneToOnePSTNCall()&&!!this.callOptions?.parkContext}async updateMediaModalities(e={},t=Te()){let i;const n=this.logger.createFnLogger("updateMediaModalities",t);return n.info(`callUsesMixer=${this.callUsesMixer},isSomeoneSharing=${this.isSomeoneSharing},isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),n.info(`options=${Le(e)},requestHoldState=${this.requestedHoldState},requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}`),i=e.modalityOverride?e.modalityOverride:this.requestedHoldState&&!this.isMuteOnHold?this.getMediaModalitiesForHold(t):this.calculateModalityDirections(e?.offered,t),n.info(`modalities=${Le(i)}`),await this.mediaSession.configureModalitiesAsync(i,t),i}calculateModalityDirections(e={},t){const i=this.logger.createFnLogger("calculateModalityDirections",t);i.info(`callUsesMixer=${this.callUsesMixer}, isEscalationInProgress=${this.isEscalationInProgress}`);const n={audio:this.calculateAudioDirection(e.audio,i),video:this.calculateVideoDirection(e.video,i),sharing:this.calculateSharingDirection(e.sharing,i),data:this.calculateDataDirection(e.data,i)};return i.info(`done, modalities=${Le(n)}`),this.deleteExtraneousModalities(n,t),n}calculateAudioDirection(e,t){return t.info(`calculateAudioDirection, offer=${e}, requestedAudioState=${this.mediaStateConfigurationHelper.isSending(0)}`),this.receiveOnlyAudioOnCallStart?(t.info("calculateAudioDirection, direction=recvonly, receiveOnlyAudioOnCallStart=true"),"recvonly"):this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)||"inactive"===e?"inactive":this.mediaSession.getAllowedModalities().audio.some((e=>e===Sg||e===yg))?"sendrecv":"sendonly"===e?"inactive":"recvonly"}calculateVideoDirection(e,t){const i=this.mediaStateConfigurationHelper.isSending(1);if(t.info(`calculateVideoDirection, offer=${e}, requestedVideoState=${i}, isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),this.mediaStateConfigurationHelper.isInactiveOrDisabled(0))return"inactive";let n=i,r=this.isSomeoneStreamingVideo||this.callUsesMixer||this.isEscalationInProgress;return e&&(n=n&&("sendrecv"===e||"sendonly"===e),r=r&&("sendrecv"===e||"recvonly"===e)),n?"sendrecv":r?"recvonly":"inactive"}calculateSharingDirection(e,t){return t.info(`calculateSharingDirection, offer=${e}, requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}, isSomeoneSharing=${this.isSomeoneSharing}`),"inactive"===e?"inactive":this.mediaStateConfigurationHelper.isSending(2)?"sendonly":this.isSomeoneSharing||this.callUsesMixer||this.isEscalationInProgress?"recvonly":void 0}calculateDataDirection(e,t){const i=this.mediaStateConfigurationHelper.isSending(3);if(t.info(`calculateDataDirection, offer=${e}, dataEnabled=${i}`),this.allowDataChannel())return i?"inactive"===e?"inactive":"sendrecv":void 0;t.info("calculateDataDirection, disabling data since ECS flag prohibits it")}getMediaModalitiesForHold(e){this.logger.info(`[${e}][getMediaModalitiesForHold]`);const t="inactive",i={audio:t,video:t,data:this.allowDataChannel()?t:void 0,sharing:t};return this.deleteExtraneousModalities(i,e),i}deleteExtraneousModalities(e,t){!zp(e.video)&&this.mediaStateConfigurationHelper.isDisabled(1)&&(this.logger.info(`[${t}][deleteExtraneousModalities] skipping videoModality`),delete e.video),!zp(e.sharing)&&this.mediaStateConfigurationHelper.isDisabled(2)&&(this.logger.info(`[${t}][deleteExtraneousModalities] skipping sharingModality`),delete e.sharing)}getSignalingMediaTypes(e){const t=[];return e.audio&&e.audio!==this.mediaAgent.constants.MEDIA_STATE.inactive&&t.push("Audio"),(e=>e===this.mediaAgent.constants.MEDIA_STATE.send||e===this.mediaAgent.constants.MEDIA_STATE.sendReceive)(e.video)&&t.push("Video"),e.sharing===this.mediaAgent.constants.MEDIA_STATE.send?t.push("ScreenSharer"):e.sharing===this.mediaAgent.constants.MEDIA_STATE.receive&&t.push("ScreenViewer"),t}enableControlInjector(){if(this.allowScreenSharingControl())if(this.getlocalScreenShareStream()){const e=this.mediaSession?.getLocalMediaTrackId("ScreenShare")??"";this.screenSharingControl.enableControlInjector(e)}else this.logger.warn("enableControlInjector: no local screenshare stream found")}createCallDeviceManager(){return new Mm(this.mediaAgent.getConfigProvider().config.allowVirtualDeviceInCall,this.mediaAgent.getDeviceManager(),this.logger.createChild("CallDeviceManager"),this.callStats,(e=>this.isMediaSending(e)))}initializeSignalingSession(t){if(this.signalingSession)return void this.logger.info("Session already exists!");const i=Yr.CALL_STATUS;if(this.localSignalingParticipant={id:hu(`${lu}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri),displayName:this.currentUserSkypeIdentity.displayName,endpointDetails:[],languageId:null,participantId:t,endpointId:null},this.accountConfiguration){if(this.localSignalingParticipant.applicationType=this.accountConfiguration.applicationType,this.callTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.localSignalingParticipant.ring=this.accountConfiguration.ring,this.callTelemetry.setRing(this.accountConfiguration.ring),this.localSignalingParticipant.region=this.accountConfiguration.region,this.callTelemetry.setRegion(this.accountConfiguration.region),this.localSignalingParticipant.userHexCID=this.accountConfiguration.userHexCID,this.callTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.localSignalingParticipant.partition=this.accountConfiguration.partition,this.callTelemetry.setPartition(this.accountConfiguration.partition),this.localSignalingParticipant.acsResourceId=this.accountConfiguration.acsResourceId,this.callTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.callStats.setAcsResourceId(this.accountConfiguration.acsResourceId),this.accountConfiguration.serviceUrls){const e=this.accountConfiguration.serviceUrls.calling_conversationServiceUrl,t=this.accountConfiguration.serviceUrls.calling_uploadLogRequestUrl;this.signalingAgent.updateUrls(e,t,this.accountConfiguration.enforceUrls)}this.localSignalingParticipant.clientType=this.accountConfiguration.clientType,this.callTelemetry.setClientType(this.accountConfiguration.clientType)}this.callStats.localStats.setLocalUserId(this.localSignalingParticipant.id),this._callOperationHandler&&this._callOperationHandler.resetOperationChain(),this.signalingNotifications={onPromotionCompleted:(e,t,i)=>{this.logger.info(`[${i}][onPromotionCompleted] isFailed=${e} reason=${Le(t)} callMode=${this.callMode}`);const n=e?t:{code:0,subCode:0};if(this.callTelemetry.recordEvent("PromotionCompleted",{reason:n},i),e){const e=Bu(t);this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",e,"",i),this._callOperationHandler.maybeRejectOperation("_CallStartOrJoinInitiated",e,"",i),this._callOperationHandler.maybeRejectOperation("_ConnectCall",e,"",i),this.promotionCompletedDeferred?.reject(e)}else this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,i),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,i);this.participants.forEach((e=>{e.applyCachedMediaStreams(i)}))},onCallStatusChanged:(e,t,n=Te())=>{const r=this.logger.createFnLogger("onCallStatusChanged",n);let s=`[status=${e}]`;if(t&&(s+=`[reason=${Le(t)}]`,void 0!==t.code&&(this.callEndDiagnosticsInfo={callControllerCode:t.code,callControllerSubCode:t.subCode,phrase:t.phrase,resultCategories:t.resultCategories},(t.overflowJoinInformation||t.registrationInformation)&&(this.callEndDiagnosticsInfo.additionalDiagnostics={overflowInformation:t.overflowJoinInformation,registrationInformation:t.registrationInformation}))),r.info(s),this.callTelemetry.recordEvent("_SignalingStateChanged",{status:e,reason:t},n),e===i.CONNECTING)!this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(r.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback()),this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,n);else if(e===i.RINGING)2===this.audioStreamState?(this.setCallState(9,n),this.participants.forEach((e=>e.setState(6,void 0,n)))):this.participants.forEach((e=>e.setState(2,void 0,n))),this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,n);else if(e===i.CONNECTED_FOR_ROSTER_ONLY)this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,n),this._callOperationHandler.maybeResolveOperation("SubscribeWithMeetingData",void 0,void 0,n);else if(e===i.CONNECTED){this._callIsSetupComplete=!0;const e=this.getLocalSignalingEndpointDetails();(e?.isLobby||e?.streamLobby)&&(this._callInLobby=!0,this.updateCapabilities(n,!0));const t=this.signalingSession.participantManager.localParticipant.isStaging;if(11===this.state)this.setCallState(12,n);else if(this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))r.info("wait for joinPreheatedCall to resolved");else if(this._callInLobby)r.info("[inLobby] Override Connected state from signaling agent"),this.setCallState(10,n);else if(t)this.setCallState(13,n);else{if(3===this.state&&!this._callOperationHandler.hasPendingOperation("_CallStartOrJoinInitiated")&&!this._callOperationHandler.hasPendingOperation("_ConnectCall"))return void r.info("Return: Don't re-send setup telemetry if call was already connected and operations are completed");this.setCallState(3,n),this.handleRemoteParticipantStateInOneToOneCall(n)}this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,n),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,n),this.reportTsCallingTelemetry(!0)}else if(e===i.LOCAL_TERMINATED||e===i.REMOTE_TERMINATED){let s=this.callSetupFailed?7:Bu(t);if(8===this.state&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData"]))return this.signalingSession.resetState(),this._callOperationHandler.maybeRejectOperation("Subscribe",s,void 0,n),this._callOperationHandler.maybeRejectOperation("SubscribeWithMeetingData",s,void 0,n),void r.info("Subscribe failed, there is pending start/join operation, ignore call end message");if(1!==s&&t?.code===Gn.MediaError&&t?.subCode===jn.MediaPermissionError&&(s=58,r.info(`[terminated][reason=${Le(t)}]`)),(2===this.state||6===this.state||8===this.state)&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData","Subscribe","SubscribeWithMeetingData"])){const e={code:this.callEndDiagnosticsInfo.callControllerCode,subCode:this.callEndDiagnosticsInfo.callControllerSubCode,phrase:this.callEndDiagnosticsInfo.phrase,reason:s};this._callOperationHandler.maybeRejectOperations(["Accept","JoinCall","JoinWithMeetingData","JoinPreheatedCall","StartCall","StartCallAndUnpark","StartCallToVoiceMail","StartCallWithNudge","StartWithMeetingData","Subscribe","SubscribeWithMeetingData"],s,void 0,n,e)}this.signalingSession.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:this.signalingSession.acceptedElsewhereBy.id,displayName:this.signalingSession.acceptedElsewhereBy.displayName}),this.signalingSession.parkAdditionalContextJson&&(this.parkAdditionalContextJson=this.signalingSession.parkAdditionalContextJson),this.signalingSession.serverHoldLocation&&(this.serverHoldLocation=this.signalingSession.serverHoldLocation),this._callOperationHandler.hasPendingOperation("CallParkV2")&&t.pickupCode&&0===t.code&&this._callOperationHandler.resolveOperation("CallParkV2",""+t.pickupCode,void 0,n),1!==s&&this.mediaRelayWhiteListingIssue&&(s=53,r.info(`[terminated][reason=${Le(t)}]`)),this._callOperationHandler.maybeRejectOperation("CallParkV2",s,"",n),this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",s,"",n),this._callOperationHandler.maybeRejectOperation("_ConnectCall",s,"",n);const a=this.mediaSession?.getSessionConfig().config.setDisconnectAfterCleanUp;if(a?this.setTerminatedReason(s):this.setCallState(7,n,s),this.participants.forEach((e=>e.setState(4,void 0,n))),!this.disconnectingPromise){const s={...t,remoteTerminated:e===i.REMOTE_TERMINATED};this.disconnectingPromise=this.cleanUp(n,s).catch((e=>{r.logFailure(`Error when cleaning up the call, callId = ${this.callId}, error = ${e}`)}))}a&&this.disconnectingPromise.finally((()=>{7!==this.state&&this.setCallState(7,n,s)}))}},onOffer:(e,t=Te())=>{const i=this.logger.createFnLogger("onOffer",t);i.info(`${Le((0,Sr.omit)(e,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(e.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnOffer",this.prepareTelemetryForOfferAnswer(e),t),e.transferor?.details?.id&&this.setTransferorMri(e.transferor.details.id),e.transferor?.transferorType&&(this.transferorType=e.transferor.transferorType),e.transferor?.details?.displayName&&(this.transferorDisplayName=e.transferor.details.displayName),this.clientTransferContext=e.clientTransferContext,this.customHeaderContext=e.customHeaderContext,this.invitationData=e.invitationData,this.spamRiskLevel=e.riskLevel,this.spamStirAttestation=e.stirAttestation,e.mediaContent.isTwoPartyToMultiPartyEscalation&&this.setIsEscalationInProgress(!0,t),e.renegotiation?this.requestedHoldState&&this._pendingParkPromise?this.renegotiateIncoming(e.mediaContent,t):this._callOperationHandler.executeChained((()=>this.renegotiateIncoming(e.mediaContent,t)),"_RenegotiateIncoming",t,t,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}):(i.info("resolving attach / offer promise"),this.attachToCallAndGetOffer.resolve(e.mediaContent))},onNewOffer:(e,t=Te())=>{const i=this.logger.createFnLogger("onNewOffer",t);this.newOfferRequestDeferred?(i.info("onNewOffer"),this.newOfferRequestDeferred.resolve(e.mediaContent)):i.info("callback received but new offer was not requested")},onAnswer:(e,t=Te())=>{const i=this.logger.createFnLogger("onAnswer",t);if(i.info(`${Le((0,Sr.omit)(e,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(e.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnAnswer",this.prepareTelemetryForOfferAnswer(e),t),e.renegotiation)i.info("resolving previous renegotiation promise"),this.renegotiationAnswerDeferred.resolve(e.mediaContent);else if(i.info("resolving final answer promise"),e.provisional){const i=this.isOneToOnePSTNCall()&&(0,Sr.startsWith)(e.remoteParticipantId,"4:");this.mediaSession.processAnswerAsync(e.mediaContent,t,!0,i)}else this._callOperationHandler.maybeResolveOperation("_WaitForAnswer",e.mediaContent,void 0,t),this.handleRemoteParticipantStateInOneToOneCall(t);e.provisional||!e.mediaContent.fromMixer||this.callUsesMixer||this._callOperationHandler.executeChained((async()=>{this.setCallUsesMixer(!0,t),this.mediaStateConfigurationHelper.isDisabled(2)&&this.mediaStateConfigurationHelper.removeModality(2),await this.updateMediaModalities(void 0,t);const e=!(this.isSomeoneSharing||this.isScreenSharingOn||this.isVideoOn);return this.mediaSession.getSessionConfig().config.disableImmidiateEscalationReconnect&&e?(i.info("Delaying reconnect"),this._hasDelayedReconnect=!0,Promise.resolve()):this.mediaSession.reconnectAsync(t,!0)}),"_CallEscalatedToConference",t,t,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})},onMediaAcknowledgementSuccess:(e,t=Te())=>{this.logger.info(`isRenegotiation: ${e}`,"onMediaAcknowledgementSuccess",t),this._callOperationHandler.resolveOperation("_MediaAcknowledgment",void 0,void 0,t)},onMediaAcknowledgementFailure:(e,t,i=Te())=>{this.logger.createFnLogger("onMediaAcknowledgementFailure",i).logFailure(Le(t)),this._callOperationHandler.rejectOperation("_MediaAcknowledgment",t,i)},onMediaRenegotiationRejection:(e,t=Te())=>{this.logger.createFnLogger("onMediaRenegotiationRejection",t).logFailure(Le(e)),this.renegotiationAnswerDeferred.reject(e)},onRosterHandlingComplete:()=>{this.logger.info(`[onRosterHandlingComplete] ${this._publishedStatesModified}`),0!==this._publishedStatesModified&&(this.processPublishedStates(),this._publishedStatesModified=0)},onMeetingGroupDetailsUpdated:(e,t=Te())=>{this.meetingGroupDetails!==e&&(this.callTelemetry.recordEvent("_UpdateMeetingGroupDetails",e,t),this.logger.info(`[${t}][onMeetingGroupDetailsUpdated] update meetingGroupDetails from ${JSON.stringify(this.meetingGroupDetails)} to ${JSON.stringify(e)}`),this.meetingGroupDetails=e,this.raiseChanged())},onSelfParticipantUpdated:(e,t=Te())=>{this.logger.info(`[${t}][onSelfParticipantUpdated]`),this.updateLocalParticipant(e,t),this.raiseChanged()},onParticipantMriUpdated:(e,t,i=Te())=>{this.logger.info(`[${i}][onParticipantMriUpdated]`);const n=this.getParticipant(e);n&&(n.id=t,this.raiseChangedDeferred())},onParticipantUpdated:(t,i=Te())=>{this.logger.info(`[${i}][onParticipantUpdated]: ${lg(t)}`);const n=this.getOrCreateParticipant(t.id,i,!0);n.displayName=t.displayName;const r=e.getStreamsFromEndpoints(t.endpointDetails),s=(0,Sr.some)(t.endpointDetails,(e=>e?.streamInformation));this.callUsesMixer||r.length>0||s?(this.updateParticipantStreams(n,t,r,i),this.updateCallParticipantFromSignalingParticipant(n,t,i)):n.setState(3,void 0,i),n.processParticipantDetails(t,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(t),this.calculateIsSomeoneStreaming(i),this.raiseChangedDeferred()},onParticipantRemoved:(e,t=Te(),i=!1)=>{if(this.logger.info(`[${t}][onParticipantRemoved]`),i){const i=this.getParticipant(e.id);this.callTelemetry.recordOperationSuccess("_ParticipantJoined",null,i?.id,t,{participantJoinedButReplaced:"Participant joined with original MRI and replaced with participant of RNL MRI"})}else this.callTelemetry.recordOperationSuccess("RemoveParticipant",null,e.id,t),this._participantOperationHandler.maybeRejectOperation("AddParticipant",1,e.id,t);this._removeParticipant(e,t),this.removePublishedStatesByParticipant(e.id),this.calculateIsSomeoneStreaming(t)},onParticipantJoined:(t,i=Te())=>{this.logger.info(`[${i}][onParticipantJoined]`);const n=!this.getParticipant(t.id),r=this.getOrCreateParticipant(t.id,i,!1);r.displayName=t.displayName,0===r.state&&r.setState(1,void 0,i);const s=e.filterVirtualEndpoints(t.endpointDetails),a=e.getStreamsFromEndpoints(s),o=(0,Sr.some)(t.endpointDetails,(e=>e?.streamInformation));this.callUsesMixer||a.length>0||o?(this.updateParticipantStreams(r,t,a,i),this.updateCallParticipantFromSignalingParticipant(r,t,i),this.calculateIsSomeoneStreaming(i)):(this.handleRemoteParticipantJoinedInOneToOneCall(t,i),this.handleRemoteParticipantStateInObservingCall(r,t,i),t.acceptedBy&&t.acceptedBy!==t.id&&(r.acceptedBy=t.acceptedBy)),this.callTelemetry.recordOperationSuccess("_ParticipantJoined",mn(t.endpointDetails),r.id,i),r.processParticipantDetails(t,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(t),n&&this.event("participantAdded").raise(r),this.raiseChangedDeferred()},onCallModeChanged:(e,t)=>{this.callTelemetry.recordEvent("_CallModeChanged",{newCallMode:e,oldCallMode:this._callMode},t),this.logger.info(`onCallModeChanged[${t}]: new=${e} old=${this._callMode} `),e&&this._callMode!==e&&(this._callMode=e,this.isCallModeStreaming()&&this.cleanUpDueToStreaming(t),1===this._callMode&&(this.participants.forEach((e=>{e.applyCachedMediaStreams(t)})),this.promotionCompletedDeferred?.resolve()),this.monitorCallStart(),this.updateCapabilities(t),this.raiseChanged())},getRemoteParticipantCollection:()=>this.participants.map((e=>e.toCafeParticipant())),onReTargetCompletedSuccess:e=>{const t=this.logger.createFnLogger("onReTargetCompletedSuccess",e);t.info(`started, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetSuccess",void 0,e),this.callStats.localStats.call.event(3);const i=this.isEscalationInProgress;this.screenSharingControl&&this.screenSharingControl.shutdownControlForViewer(),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.completeEscalationAsync(e).then((()=>(t.logSuccess("completeEscalationAsync"),this.callTelemetry.recordEvent("_WebOnEscalationSuccess",void 0,e),this.handleCallEscalation(i,e),this.updateMediaStatus(e)))).catch((i=>{t.logFailure(`completeEscalationAsync, error=${Ne(i)}`),this.setIsEscalationInProgress(!1,e),this.callTelemetry.recordEvent("_WebOnEscalationFailure",Oe(i),e),this.stopInternal({causeId:e,terminatedReason:47})}))},onReTargetCompletedFailure:(e,t)=>{this.logger.createFnLogger("onReTargetCompletedFailure",t).logFailure(`reason=${Ne(e)}, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetFailure",Oe(e),t),this.isEscalationInProgress&&(this.setIsEscalationInProgress(!1,t),this.setCallUsesMixer(!1,t),this.updateMediaStatus(t)),this.callStats.localStats.call.event(4),this.mediaSession.rejectEscalationAsync(e,t)},onChatModalitySetupFailed:e=>{this.logger.debug(`onChatModalitySetupFailed: ${e}`)},onConversationUpdated:(e,t)=>{this.logger.info(`onConversationUpdated[${t}]: ${Le(e)}`),this.setConversationType(e.conversationType,t),this.setMessageId(e.teamsMessageId,t),this.setGroupId(e.groupId,t),this.setThreadId(e.threadId,t),this.setBackroomThreadId(e.backroomThreadId,t),this.setCallType(e.isMultiParty?2:1,t),this._commandUrlPresence=e.commandUrlPresence,this.updateCapabilities(t),this.region=e.region,this.setMeetingData(e.meetingData),this.meetingInfo=e.meetingInfo,this.callLimits=e.callLimits,this.setComplianceRecordingContent(t,e.complianceRecordingContent),this.setHuddleGroupCall(e.isHuddleGroupCall),this.raiseChanged()},onMeetingDetailsUpdated:e=>{this.meetingDetails=e,this.mediaSession&&!this.enableRealtimeTelemetry&&this.meetingDetails.meetingCapability?.enableRealtimeTelemetry&&(this.mediaSession.enableTeamsRealTimeTelemetry(),this.enableRealtimeTelemetry=!0),this.raiseChanged()},onMeetingStatesUpdated:e=>{(0,Sr.isEqual)(e,this.meetingStates)||(this.meetingStates=e,this.logger.info(`[onMeetingStatesUpdated] meetingStates updated to ${JSON.stringify(this.meetingStates)}`),this.raiseChanged())},onParticipantCountsUpdated:e=>{(0,Sr.isEqual)(e,this.participantCounts)||(this.participantCounts={...ln,...e},this.event("participantCountsUpdated").raise(this.participantCounts),this.mediaSession?.processNotification("ParticipantCountChanged",{count:e.totalParticipants}))},updateIsSharedLineAppearanceV2Activated:e=>{this.isSharedLineAppearanceV2Activated!==e&&(this.logger.info(`_updateIsSharedLineAppearanceV2Activated: new value is ${e}`),this.isSharedLineAppearanceV2Activated=e,this.event("sharedLineAppearanceV2ActivatedChanged").raise(this.isSharedLineAppearanceV2Activated))},onBroadcastMeetingUpdated:e=>{e&&(this.broadcastMeeting&&this.broadcastMeeting.metadataChanged(JSON.stringify(e)),this.broadcastMetadata=e,this.raiseChanged())},onBroadcastMeetingConnected:(e,t)=>{this.logger.info(`[${t}][onBroadcastMeetingConnected]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&(0===e.code?this._callOperationHandler.resolveOperation("AddBroadcastModality",e,t):this._callOperationHandler.rejectOperation("AddBroadcastModality",e,t))},onBroadcastMeetingEnded:(e,t)=>{this.logger.info(`[${t}][onBroadcastMeetingEnded]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&this._callOperationHandler.rejectOperation("AddBroadcastModality",e,t),this.signalingSession.endBroadcastMeeting(t)},onTransferRequested:(e,t)=>{const i=this.logger.createFnLogger("onTransferRequested",t);i.info("Transfer: onTransferRequested, target participant",lg(e.target));let n="",r="",s=0;"voicemail"===e.target.endpointType&&(s=2);try{n=e.target.id,r=e.transferor.details.id,e&&e.parkType&&"none"!==e.parkType&&(s=1)}catch(e){return i.logFailure(e),this.callTelemetry.recordEvent("_OnTransferRequestedInvalid"),void this.signalingSession.signalTransferCompletedAsync({code:Gu(7)})}const a=this.convertToTransferType(s,e.parkType),o={transferContext:{transferorMri:r,targetMri:n,transferType:s,context:{target:e.target,transferor:e.transferor,transferContext:e.transferContext,newCallModalities:e.newCallModalities,links:e.links,replacementDetails:e.replacementDetails,isConsultative:e.isConsultative,callAcceptanceCallback:()=>{i.logSuccess("Transfer: callAcceptanceCallback called"),this.signalingSession.signalTransferAcceptedAsync(a)}}},onCompleted:e=>{i.logSuccess("Transfer: onCompleted called"),this.signalingSession.signalTransferCompletedAsync({code:Gu(e)})}};this.callTelemetry.recordEvent("_OnTransferRequested",{transferType:s}),this.event("transferRequested").raise(o)},onTransferredCallAcceptance:e=>{const t=this.logger.createFnLogger("onTransferredCallAcceptance",e);this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(t.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback())},onTransferAccepted:e=>{this.logger.info("Transfer: onTransferAccepted"),this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&this._setTransferState(2),this._callOperationHandler.hasPendingOperation("BlindTransfer")&&this._callOperationHandler.maybeResolveOperation("_CallTransferInProgress",void 0,void 0,e),this._callOperationHandler.hasPendingOperation("ParkCall")&&this._setParkState(2)},onTransferCompleted:(e,t)=>{const i=this.logger.createFnLogger("onTransferCompleted",t);i.info("Transfer: onTransferCompleted");const n=e.transferCompletion,r=Bu(n);if(n&&(i.info(`Transfer: Call Transfer Code: ${n.code}`),0===n.code)){if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.resolveOperation("_CallTransferInProgress",void 0,void 0,t),this._setTransferState(3)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const e={code:0,subCode:0,phrase:"TransactionComplete"};this._callOperationHandler.resolveOperation("ConsultativeTransferWithPickupCode",e,void 0,t),this._setTransferState(3)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(e.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation&&(this.serverHoldLocation=e.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),void 0!==e.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("ParkCall",e.unparkContent.pickupCode,void 0,t),i.logSuccess(`pickupCode=${e.unparkContent.pickupCode}`),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",32,t),i.logFailure(`terminatedReason=${r}`),this._setParkState(4)))}else{if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.rejectOperation("_CallTransferInProgress",r,void 0,t),i.logFailure(`terminatedReason=${r}`),this.transferDiagnosticsInfo={callControllerCode:n.code,callControllerSubCode:n.subCode,phrase:n.phrase,resultCategories:n.resultCategories},this._setTransferState(4)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const e={code:n.code,subCode:n.subCode,resultCategories:n.resultCategories};this._callOperationHandler.rejectOperation("ConsultativeTransferWithPickupCode",e,void 0,t)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(this._callOperationHandler.rejectOperation("ParkCall",r,void 0,t),i.logFailure(`terminatedReason=${r}`),this.transferDiagnosticsInfo={callControllerCode:n.code,callControllerSubCode:n.subCode,phrase:n.phrase,resultCategories:n.resultCategories},this._setParkState(4))}},onParkCompleted:(e,t)=>{this.logger.createFnLogger("onParkCompleted",t).info(`transactionEnd ${Ne(e)}`),this._callOperationHandler.hasPendingOperation("CallParkV2")?0===e.code&&void 0!==e.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("CallParkV2",""+e.unparkContent?.pickupCode,void 0,t),this.callTelemetry.maybeRecordOperationSuccess("CallParkV2"),this.serverHoldLocation=e.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation,this.parkAdditionalContextJson=JSON.stringify(e.unparkContent.CallParkAdditionalContext)):this._callOperationHandler.rejectOperation("CallParkV2",e,t):this._callOperationHandler.hasPendingOperation("ParkCall")&&(0===e.code?(this._callOperationHandler.resolveOperation("ParkCall","",void 0,t),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",e,t),this._setParkState(4)))},onUnparkCompleted:(e,t)=>{this.logger.createFnLogger("onUnparkCompleted",t).info(`transactionEnd ${Ne(e)}`),this._callOperationHandler.hasPendingOperation("UnparkCall")&&(0===e.code?this._callOperationHandler.resolveOperation("UnparkCall",e,void 0,t):this._callOperationHandler.rejectOperation("UnparkCall",e,t))},onIncomingCallReplacement:(e,t)=>{const i=this.logger.createFnLogger("onIncomingCallReplacement",t);this.callTelemetry.recordEvent("_onIncomingCallReplacement",{},t),e.callNotification.callType="replaces",e.callNotification.consultativeCallId=this.callId,i.info(`consultativeCallId=${this.callId}`),e.body={gp:e,evt:Jn.INCOMING_SKYPE_NGC_CALL,nsp:void 0},this.event("replacementRequested").raise(e)},onContentSharingStopped:e=>{this.logger.debug("ScreenSharing: onContentSharingStopped");for(const t of this.contentSharingSessions)t.contentSharingGuid===e.correlationId&&(t.contentSharingStatus=7)},onContentSharingStarted:e=>{this.logger.debug("ScreenSharing: onContentSharingStarted");const t=new jg(this.callTelemetry,this.logger.createChild("ContentSharingSession"),this.signalingSession,e.correlationId||xi(),e.contentIdentifier,e.sessionState,e.subject,e.sessionId);t.contentSharingStatus=2,this.contentSharingSessions.push(t),t.changed((()=>this.removeContentSessionIfEnded(t))),this.event("contentSharingChanged").raise()},onContentSharingUpdated:e=>{this.logger.debug("ScreenSharing: onContentSharingUpdated");const t=(0,Sr.find)(this.contentSharingSessions,(t=>t.contentSharingGuid===e.correlationId));t?(e.presenter&&(t.presenterId=e.presenter),e.subject&&t.subject!==e.subject&&(t.subject=e.subject),e.sessionState&&t.contentSharingState!==e.sessionState&&(t.contentSharingState=e.sessionState),3===t.contentSharingStatus&&this.localSignalingParticipant.id!==e.presenter?t.contentSharingStatus=5:5===t.contentSharingStatus&&this.localSignalingParticipant.id===e.presenter&&(t.contentSharingStatus=3)):this.logger.warn("onContentSharingUpdated: session not found")},onWebRtcMediaNotification:(e,t)=>{this.mediaSession?.processNotification(e,t);const i=this.mediaSession&&this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null;i&&i.processNotification(e,t)},onCorrelationIdUpdated:(e,t)=>this.checkForCallIdUpdate(e,t),onUnmuteRequested:e=>{},onCallForwarded:e=>{e&&e.destinationType!==this.forwardingDestinationType&&(this.forwardingDestinationType=e.destinationType,this.raiseChanged())},onPSTNBalanceUpdate:e=>{},isOneToOnePstnCall:()=>this.isOneToOnePSTNCall(),onUpdateMeetingLiveStateCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingLiveStateCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingLiveState",i)},onUpdateMeetingStatesCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingStatesCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingStates",i)},onUpdateMeetingGroupsCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingGroupsCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingGroups",i)},onSetMeetingLayoutCompleted:(e,t,i)=>{this.logger.info(`[onSetMeetingLayoutCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"SetMeetingLayout",i)},onJoinMeetingGroupCompleted:(e,t,i)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"JoinMeetingGroup",i)},onLeaveMeetingGroupCompleted:(e,t,i)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${t}] transactionEnd ${Ne(e)}`),this.onOperationCompleteCommonHandler(e,t,"LeaveMeetingGroup",i)},onBreakoutDetailsUpdated:(e,t)=>{this.logger.info(`[onBreakoutDetailsUpdated] [${t}]`),this.breakoutDetails=e,this.raiseChanged()},onIncomingProxiedMessages:(e,t)=>{this.logger.info(`[onIncomingProxiedMessages] [${t}] payload ${Ne(e,!0)}`),this.event("incomingProxiedMessages").raise(e)},onUpdateParticipantsPropertiesCompleted:(e,t,i)=>{this.logger.createFnLogger("onUpdateParticipantsPropertiesCompleted",i).info(`promisesToResolve ${we(Le(e))}`);for(const t of Object.keys(e))e[t].code===Cn.SUCCESS?this._callOperationHandler.maybeResolveOperation("UpdateParticipantsProperties",e[t],t,i):this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",e[t],t,i)},onNudgeToJoinRealtime:e=>{this.logger.info("[onNudgeToJoinRealtime]",e),this.callTelemetry.recordEvent("NudgeToJoinRealTime",e),this.canPromoteToRealTime(1)&&this.promoteToRealtime(1,e).then((()=>this.logger.info(`[onNudgeToJoinRealtime][${e}] completed`))).catch((t=>this.logger.info(`[onNudgeToJoinRealtime][${e}] failed to auto promote: ${Ne(t)}`)))}};const n=Object.create(this.localSignalingParticipant);this.signalingSession=this.signalingAgent.getNewSignalingSession(n,this.signalingNotifications,this.callId,this._callCreationTime),this.signalingSession.participantManager.setStaleCheckForFullRoster(this._staleRosterCheckFixForPluginless),this.signalingSession.participantManager.setEnableMuteAsync(this._enableMuteAsync),this.signalingSession.participantManager.setEnableUnmuteAsync(this._enableUnmuteAsync),this.accountConfiguration&&this.accountConfiguration.deviceType&&this.signalingSession.setDeviceType(this.accountConfiguration.deviceType),this.setCallId(this.callId||this.signalingSession.correlationId),this.signalingSession.participantManager&&this.signalingSession.participantManager.localParticipant&&(this.setEndpointId(this.signalingSession.participantManager.localParticipant.endpointId),this.setParticipantId(this.signalingSession.participantManager.localParticipant.participantId),this.callStats.setParticipantId(this.participantId))}updateParticipantStreams(e,t,i,n){e.updateStreams(i,n,this.isCallModeStreaming());const r=this.getStreamInformationMap(t);this.logger.info(`[updateParticipantStreams]: streaming mode with new streamInfoMap: ${Le(r)}`);const s={callId:this.callId,participantId:this.participantId,endpointId:this.endpointId};this.meetingData&&(s.meetingId=this.meetingData.meetingCode);const a=this.telemetryLoggers?this.telemetryLoggers.tlePlayer:null;e.useUmsStream(r,this._liveStreamConfigProvider,s,this.threadId,a,n)}cleanUpDueToStreaming(e){this.logger.info(`cleanUpDueToStreaming[${e}]: cleaning streams and media and canceling cc operations`),this.cancelAllCallingOperationsDueToStreaming(e);const t={code:Gn.Success,subCode:jn.DowngradeToStreamingClient,phrase:nr};this.participants.forEach((t=>t.updateStreams([],e))),this.cleanUpMedia(e,t).finally((()=>{this.mediaDisposedPromise=null})),this.finishCallHoldResume(t),this.renegotiationAnswerDeferred?.reject(t),this.newOfferRequestDeferred?.reject(t),this._parkState=0,this._transferState=0,this.isServerMuted||(this._muteState=0),this.isSpeakerMuted=!1,this.requestedHoldState=!1,this.isMuteOnHold=!1}cancelAllCallingOperationsDueToStreaming(e){this._callOperationHandler.maybeRejectPendingOperationsWithPredicate(74,e,((e,t)=>(0,Sr.some)(t?.preconditionTags,(e=>"NOT_SUPPORTED_IN_STREAMING_MODE"===e))))}onOperationCompleteCommonHandler(e,t,i,n){0===e.code?this._callOperationHandler.maybeResolveOperation(i,e,n,t):this._callOperationHandler.maybeRejectOperation(i,e,n,t)}convertToTransferType(e,t){let i="none";return 1===e&&t&&"none"!==t?"teamPark"===t?i="TransferTypeTeamPark":"sharedLinePark"===t?i="TransferTypeSharedLinePark":"serverHold"===t&&(i="TransferTypeServerHold"):0===e?i="TransferTypeStandard":2===e?i="TransferTypeVoicemail":this.logger.info(`Irrelevant combination of transferTye: ${e} and parkType: ${t}`),i}raiseChangedDeferred(e){(!this.raiseChangedDefer||this.raiseChangedDefer.isSkippable&&!e)&&(mg.instance.runDeferredWithoutDedup((()=>{delete this.raiseChangedDefer,this.raiseChanged(e)}),"Call.raiseChanged"),this.raiseChangedDefer={isSkippable:!!e})}static getStreamsFromEndpoints(t){if(!t)return[];const i=e.filterVirtualEndpoints(t);return i.forEach((e=>(0,Sr.forEach)(e.mediaStreams,(t=>{t.participantId=e.participantId,t.endpointId=e.endpointId})))),(0,Sr.flatMap)(i,(e=>e&&e.mediaStreams||[]))}preconditions(e,t){this.logger.info(`check call mode currentMode is ${this.callMode} operationName is ${e}`),(0,Sr.some)(t,(e=>"NOT_SUPPORTED_IN_STREAMING_MODE"===e))&&this.isCallModeStreaming(!0)}mapCallSetupIntent(e){switch(e){case 0:return"None";case 1:return"AutoPromotion";case 2:return"PromotionWithAudio";case 3:return"PromotionWithVideo";default:return"Unknown"}}async promoteToRealtime(e,t){this.logger.info(`[${t}][promoteToRealtime] started with intent=${e}`);const i=this.getPromoteToRealtimeCallOptions(e,this.callOptions);this.callTelemetry.updateOperationData("_PromotionToRealtime",{intent:e},t),this.callTelemetry.recordEvent("StartPromotion",{intent:this.mapCallSetupIntent(e)},t);try{this.promotionCompletedDeferred=vi(),await Promise.all([this.joinOrStartCall(i,this.joinGivenConversation,t,void 0),this.promotionCompletedDeferred.promise])}catch(e){throw this.logger.logFailure(`[${t}][promoteToRealtime] failed with reason=${Ne(e)}`),this.cleanUpDueToStreaming(t),this.signalingSession.cleanUpDueToStreaming(t),e}}async promoteToRealtimeAndUnmute(e){return this.logger.info(`[${e}][promoteToRealtimeAndUnmute]`),this.isPromotingToRealtime()?(this.logger.info(`[${e}][promoteToRealtimeAndUnmute] already promoting to realtime.`),this._callOperationHandler.waitForOperation("_PromotionToRealtime").then((()=>this.muteUnmute(!1,e)))):this.canPromoteToRealTime(2)?(this.unmutePendingPromise=vi(),setTimeout((()=>{this.unmutePendingPromise?.reject("promoteToRealtime unmute timed out")}),1e3*this.signalingSession.signalingAgentConfig.csaTimeoutConfiguration.promotionUnmuteTimeoutSec),Promise.all([this.promoteToRealtime(2,e),this.unmutePendingPromise.promise]).then((()=>{})).finally((()=>this.unmutePendingPromise=null))):Promise.reject("manual promotion with audio is not allowed")}isPromotingToRealtime(){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")}getPromoteToRealtimeCallOptions(e,t){let i,n=1;1===e?i={value:!0,mediaTypes:["audio"]}:3===e?(i={value:!0,mediaTypes:["audio"]},n=4):2===e&&(i={value:!1});const r={...t.callStartOptions,sendMediaModalities:{mediaStates:[ju(0,4),ju(1,n)].filter((e=>null!=e))},preheatFlags:0};return{...t,callStartOptions:r,applyServerMute:i,isPromotingToRealtime:!0,callStartTime:Date.now()}}canPromoteToRealTime(e){const t=this.logger.createChild("[canPromoteToRealTime]");return t.info(`[promoteType:${e}]`),this.isCallModeStreaming()?this.isPromotingToRealtime()?(t.info("already promoting to realtime"),!1):1===e||2===e:(t.info("cant promote since call mode is not streaming"),!1)}isCallModeStreaming(e=!1){if(2===this.callMode){if(!e)return!0;throw this.logger.info("reject check callmode"),{code:499,subCode:3551,phrase:"TransactionNotAllowedForStreamMode"}}return!1}setCallOptions(e){this.receiveOnlyAudioOnCallStart=!!e.callStartOptions?.receiveOnlyAudioOnCallStart,this.callOptions=e,this.logger.info(`callOptions: ${Le(function(e){const t={};Ju(e.callStartTime)&&(t.callStartTime=e.callStartTime),Ju(e.callVoicemailStartOptions)&&(t.callVoicemailStartOptions=e.callVoicemailStartOptions),Ju(e.invitationType)&&(t.invitationType=e.invitationType),Ju(e.meetingPreferences)&&(t.meetingPreferences=e.meetingPreferences),Ju(e.parkContext)&&(t.parkContext=e.parkContext),Ju(e.pickupCode)&&(t.pickupCode=e.pickupCode),Ju(e.participantsToNudge)&&(t.participantsToNudgeSize=e.participantsToNudge.length);const i=e.callStartOptions;if(i){const e={};Ju(i.additionalEndpointProperties)&&(e.additionalEndpointProperties=i.additionalEndpointProperties),Ju(i.clientEndpointCapabilities)&&(e.clientEndpointCapabilities=i.clientEndpointCapabilities),Ju(i.connectionType)&&(e.connectionType=i.connectionType),Ju(i.invitationDataJson)&&(e.invitationDataJson=i.invitationDataJson),Ju(i.isCast)&&(e.isCast=i.isCast),Ju(i.isHuddleGroupCall)&&(e.isHuddleGroupCall=i.isHuddleGroupCall),Ju(i.label)&&(e.label=i.label),Ju(i.maxVideoChannels)&&(e.maxVideoChannels=i.maxVideoChannels),Ju(i.maxVbssChannels)&&(e.maxVbssChannels=i.maxVbssChannels),Ju(i.mediaConfiguration)&&(e.mediaConfiguration=i.mediaConfiguration),Ju(i.muteFlags)&&(e.muteFlags=i.muteFlags),Ju(i.muted)&&(e.muted=i.muted),Ju(i.negotiationTag)&&(e.negotiationTag=i.negotiationTag),Ju(i.preheatFlags)&&(e.preheatFlags=i.preheatFlags),Ju(i.ringOthers)&&(e.ringOthers=i.ringOthers),Ju(i.routingFlags)&&(e.routingFlags=i.routingFlags),Ju(i.scenario)&&(e.scenario=i.scenario),Ju(i.screenshareDirection)&&(e.screenshareDirection=i.screenshareDirection),Ju(i.sendMediaModalities)&&(e.sendMediaModalities=i.sendMediaModalities),Ju(i.sharedLineCallInvitationContentJson)&&(e.sharedLineCallInvitationContentJson=i.sharedLineCallInvitationContentJson),Ju(i.targetApplicationType)&&(e.targetApplicationType=i.targetApplicationType),Ju(i.captchaContentJson)&&(e.captchaContentJson=i.captchaContentJson),Ju(i.callQueueContext)&&(e.callQueueContext=i.callQueueContext),Ju(i.clientEndpointDebugContent)&&(e.clientEndpointDebugContentSize=i.clientEndpointDebugContent.length),Ju(i.alternateId)&&(e.alternateId=we(i.alternateId)),Ju(i.callKey)&&(e.callKeySize=i.callKey.length),Ju(i.encryptedKey)&&(e.encryptedKeySize=i.encryptedKey.length),t.callStartOptions=e}return t}(e))}`)}getSelfClientEndpointCapabilities(){return this.callOptions?.callStartOptions?.clientEndpointCapabilities}getLocalSignalingEndpointDetails(){return(0,Sr.find)(this.localSignalingParticipant.endpointDetails,(e=>e?.endpointId===this._endpointId))}getStreamInformationMap(e){const t={};return e&&this.accountConfiguration?.clientSupportsUms&&(0,Sr.forEach)(e.endpointDetails,(e=>{e?.streamInformation&&e.participantId&&e.participantId!==this._participantId&&(t[e.participantId]=e.streamInformation)})),t}updateSATInfo(e=[]){const t=this.mediaSession?.getSessionConfig().config.slowedDownTalkerInfoAggregationTime;if(!t||t<0)return;const i=Date.now(),n=i-1e3*t;this.activeTalkersHistory=this.activeTalkersHistory.filter((({timestamp:e})=>e>n)).concat({speakers:e.map((e=>e.id)),timestamp:i});const r=Object.entries(this.activeTalkersHistory.reduce(((e,{speakers:t})=>{for(const i of t)e[i]??(e[i]=0),e[i]++;return e}),{})).sort((([,e],[,t])=>t-e)).map((([e])=>e));this.slowedDownActiveTalkerInfo={speakerList:r,timestamp:new Date(i)}}setPlatformCallConstraints(e){this.setCallConstraints(e).catch((e=>{this.logger.error(e)}))}setCallConstraints(e){return this.mediaSession?(this.logger.info(`Applying platform constraints to current call ${JSON.stringify(e)}`),this.mediaSession.setCallConstraints(e,Te())):(this.logger.info("Saving platform constraints until media session is created"),this.temporaryCallConstraints=e,new Promise(((e,t)=>{this.resolveTemporaryCallConstraints=e,this.rejectTemporaryCallConstraints=t})))}initializeMediaSession(t){if(this.mediaSession)return;const i=this.logger.createFnLogger("initializeMediaSession",t),n=((e,t)=>{const i={};return Object.keys(t).forEach((n=>{i[n]=(...i)=>t[n]&&e()&&t[n](...i)})),i})((()=>!this.isCallModeStreaming()||this.isPromotingToRealtime()),{onSessionErrorOccurred:(e,t=Te())=>{i.error(`[${t}][onSessionErrorOccurred]: ${Le(e)}`);const n=[this.mediaAgent.constants.MEDIA_ERROR.iceConnectionError,this.mediaAgent.constants.MEDIA_ERROR.internalError];(0,Sr.includes)(n,e.type)&&this.event("mediaConnectionFailed").raise(),this.callTelemetry.recordEvent("SessionError",{type:e.type},t)},onNegotiationRequired:(e=Te())=>{this.executeNegotiation(e,"onNegotiationRequired",!0)},onContributingSourcesChanged:e=>{const t=this.mediaSession?.getSessionConfig().config.contributingSourcesLogInterval,n=t&&Date.now()>=this.lastContibutingSourceReport+t,r=n?new Map(e.map((e=>[e,"<unknown>"]))):new Map,s=[];for(const t of this.participants){const i=e.some((e=>t.hasAudioSource(e))),a=i?1:0;t.updateVoiceLevel(a),i&&(s.push(t),n&&r.set(t.audio.id,we(t.id)))}this.updateSATInfo(s),n&&(i.info(`[onContributingSourcesChanged], ${e.length?Array.from(r).join(";"):"none"}`),this.lastContibutingSourceReport=Date.now())},onDominantSpeakerChanged:(e,t)=>{const n=Te(),r=[],s=[];e.forEach((e=>{const t=(0,Sr.find)(this.participants,(t=>t.hasAudioSource(e)));t?(r.push(t.id),s.push(we(t.id))):s.push(this.streamManager.audio.id===e?"<self>":"<unknown>")})),i.info(`[${n}][onDominantSpeakerChanged], msidList = ${e} => speakerList = ${s}, timestamp = ${t}`),this.dominantSpeakerInfo={speakerList:r,timestamp:t,noCurrentDominantSpeaker:!1},this.event("dominantSpeakerChanged").raise(),this.raiseChanged(this._dominantSpeakerChangedEventSkipConfig)},onAudioStateChanged:(t,i)=>{const n=Te(),r=this.logger.createFnLogger("onAudioStateChanged",n);r.info(Le(t)),this.callStats.localStats.audio.streamStateChanged(t.stream,t.direction);const s=e.streamingStatetoMediaStreamState(t.stream);if(this.audioStreamState=s,!s)return;this.callTelemetry.recordEvent("AudioStateChanged",{state:t,reason:i},n),2===s&&2===this.state&&(this.setCallState(9,n),this.participants.forEach((e=>e.setState(6,void 0,n))));const a={mediaType:0,mediaDirection:e.streamingDirectionToMediaDirectionMapping(t.direction),mediaStreamState:s};if(this.event("mediaStreamStateChanged").raise(a),!this.isCallSetupTelemetrySent&&this.mediaSession?.getSessionConfig().config.sendCallStartupTelemetry&&this.sendCallSetupTelemetry(),0===a.mediaDirection&&(this.isAudioStreamConnected=(0,Sr.includes)([2,1],a.mediaStreamState)),(0,Sr.includes)([3,4],a.mediaStreamState)&&(r.logFailure(`audio stream state changed to ${t.stream} with reason ${i}`),!i||["timeout","connection-dropped","connectivity-check-failure","suspended"].indexOf(i)>=0)){this.event("mediaConnectionFailed").raise();const e="suspended"===i?77:this.mediaRelayWhiteListingIssue?53:4;this.mediaRelayWhiteListingIssue&&this.callTelemetry.recordEvent("_MediaWhiteListingIssueDetected"),this.stopInternal({causeId:n,terminatedReason:e})}},onQualityChanged:t=>{const i={type:e.convertQualityEventType(t.type),value:e.convertQualityLevel(t.value),isLocalSource:t.isLocalSource,mediaType:e.convertMediaType(t.mediaType)};this.muteUnmuteWorkaround(i),32===i.type&&(this.mediaRelayWhiteListingIssue=3===i.value,this.mediaRelayWhiteListingIssue&&this.event("mediaConnectionWhitelistingWarning").raise()),5===i.type&&3===i.value&&this.trouterService.checkConnection(!0),this.callTelemetry.recordEvent("AudioQualityChanged",i),this.event("callQualityChanged").raise(i)},onOptimalVideoReceiversCountChanged:e=>{i.debug(`onOptimalVideoReceiversCountChanged: ${e}`),this.optimalVideoCount!==e&&(this.optimalVideoCount=e,this.raiseChanged())},onDataChannelUpdated:e=>{const t=Te();i.debug(`[${t}] onDataChannelUpdated`),this.dataChannel.registerSessionDataChannel(e,t)},onUpdateMediaDescriptionsRequired:e=>{this.executeNegotiation(e,"onUpdateMediaDescriptionsRequired",!1)},onRealtimeTelemetryReport:()=>{this.reportTelemetryEvents([{eventName:"realtimetelemetry",props:{user_object_id:{value:lu+this.currentUserSkypeIdentity.id,piiKind:10},call_context_id:{value:this.signalingSession.correlationId,piiKind:0},participant_id:{value:this.participantId,piiKind:0},media_leg_id:{value:this.mediaLegId,piiKind:0},DiagnosticLevel:{value:255,piiKind:0},eventpdclevel:{value:2,piiKind:0},eventpriority:{value:5,piiKind:0},call_technical_info:{value:JSON.stringify(this.mediaSession.getCallTechnicalInfo()),piiKind:0}}}],"realtimeMedia","mdsc")},onTransportConnected:()=>{this.mediaStateConfigurationHelper.isSending(3)&&this.allowDataChannel()?this.mediaControlPlane.onTransportConnected():!this.isInitialSignalingDSHSubscriptionEnabled()&&this.callUsesMixer&&this.updateSignalingDSHMessageSubscription(!0),this.unmixedAudioProvider.setSessionStreamsProvider(this.mediaSession.getUnmixedAudioProvider())}});this.callTelemetry.recordEvent("CreatingConference","",t),this.callDeviceManager||(i.info(`[${t}][initializeMediaSession] Creating new callDeviceManager`),this.callDeviceManager=this.createCallDeviceManager());const r=new Nm(this.mediaControlPlane,this.signalingSession,i.createChild("SourceRequestSender"),this.mediaControlPlane.getTelemetryLogger().getSourceRequestSenderDiagnostics),s={maxReinvitelessMediaForVBSSMultiparty:this.signalingSession.getMaxReinvitelessMediaForVBSSForWeb(),maxReinvitelessMediaForVideoMultiparty:this.signalingSession.getMaxReinvitelessMediaForVideoForWeb()};this.callTelemetry.recordEvent("_ReinvitelessConfig",{reinvitelessConfig:s},t),this.mediaSession=new rg(this.mediaAgent.createSession(n,this.signalingSession.correlationId,{isConference:this.callUsesMixer,isPstnCall:this.isOneToOnePSTNCall(),isParkedCall:this.isParkedCall(),reinvitelessConfig:s},this.callDeviceManager),this.signalingSession,r),this.temporaryCallConstraints&&(i.info(`Applying saved call constraints to current call ${JSON.stringify(this.temporaryCallConstraints)}`),this.mediaSession.setCallConstraints(this.temporaryCallConstraints,Te()).then(this.resolveTemporaryCallConstraints).catch(this.rejectTemporaryCallConstraints).finally((()=>{this.temporaryCallConstraints=void 0,this.rejectTemporaryCallConstraints=void 0,this.resolveTemporaryCallConstraints=void 0}))),this.dataChannel.setConfigProviderView(this.mediaSession.getSessionConfig()),this.callTelemetry.recordEvent("CreatedConference","",t),this.streamManager.setMediaSession(this.mediaSession,t),this.participants.forEach((e=>{e.setMediaSession(this.mediaSession,t)}));const a=this.mediaSession.getSessionConfig()?.config;a?.useOneDsLogger&&a?.addTelemetryReportingCallback&&(this.beforeUnloadTelemetrySender=()=>{this.sendLastKnownStats()},window.addEventListener("beforeunload",this.beforeUnloadTelemetrySender)),this.screenSharingControl&&this.allowDataChannel()&&(this.screenSharingControl.setGiveControlEnabled(this.isGiveControlEnabled()),this.screenSharingControl.setupDataHandlers()),this.unmixedAudioProvider=new Pm}executeNegotiation(e,t,i){const n=this.logger.createFnLogger(t,e);if(this.isCallModeStreaming()||this.isEscalationInProgress)return void n.info(`ignored due to being in streaming=${this.isCallModeStreaming()},\n                isEscalationInProgress=${this.isEscalationInProgress}`);const r=Te();3===this.state||4===this.state||5===this.state||10===this.state||this.isPreheatedOnly()?(n.info(`started, state: ${this.state}, runNegotiation: ${i}`),i?(this.callTelemetry.recordEvent("NegotiationRequired","",e),this._callOperationHandler.executeChained((()=>this.renegotiateOutgoing(e)),"_RenegotiateOutgoing",r,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})):(this.callTelemetry.recordEvent("UpdateMediaDescriptions","",e),this._callOperationHandler.executeChained((()=>this.updateMediaDescriptions(e)),"_UpdateMediaDescriptions",void 0,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}))):n.info(`not started, state: ${this.state}`)}async muteUnmuteWorkaround(e){if(this.mediaSession?.getSessionConfig().config.enableMuteSpeakerUnmuteSpeakerWorkaround&&!this.isSpeakerMuted&&25===e.type&&3===e.value&&0===e.mediaType){this.logger.log("Performing muteSpeaker->unmuteSpeaker workaround");const e=Te();await this.muteSpeaker(e),await this.unmuteSpeaker(e)}}sendLastKnownStats(){if(!this.tsCallingTelemetryReported){const e=this.mediaSession.getLastKnownStats(!0);this.callStats.setMediaStats(e),this.reportTelemetryEvents(this.callStats.buildShortBeaconEvent(),"media","mdsc"),this.reportTelemetryEvents(this.callStats.buildShortCallModalityStats(),"signaling"),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo);const t="in_call_session";this.reportTelemetryEvents([{eventName:t,props:this.callTelemetry.getEvent(!0)}],"signaling","skypecosi_concore_web_ts_calling")}}invertDirectionality(e){switch(e){case this.mediaAgent.constants.MEDIA_STATE.sendReceive:return yg;case this.mediaAgent.constants.MEDIA_STATE.send:return vg;case this.mediaAgent.constants.MEDIA_STATE.receive:return Sg;default:return null}}completeNegotiationAsync(e){const t=this.logger.createFnLogger("completeNegotiationAsync",e),i=this.mediaSession.completeNegotiationAsync(e).then((i=>{t.info(`activeModalities=${i&&Object.keys(i.activeModalities)}`);const n=this.participants[0],r=n?.endpoints?.endpointDetails.length&&n.endpoints.endpointDetails[0].mediaStreams?.length,s=this.mediaSession.getSessionConfig().config.avoidFakeStreamsDuringEscalation&&this.isEscalationInProgress;if(n&&!this.callUsesMixer&&!s&&!r){const t=(e,t,i)=>({participantId:xm,endpointId:"remote",type:e,direction:this.invertDirectionality(t),sourceId:i,serverMuted:!1}),r=[];r.push(t(Cg,i.activeModalities.audio,1)),i.activeModalities.video&&r.push(t(_g,i.activeModalities.video,2)),i.activeModalities.sharing&&r.push(t(Eg,i.activeModalities.sharing,3)),n.updateStreams(r,e)}return t.logSuccess(Le(i)),i}));return i.catch((i=>{t.logFailure(i),this.callTelemetry.recordEvent("_CompleteNegotiationFailed",{e:i},e)})),i}async renegotiateOutgoing(e){let t;this.renegotiationAnswerDeferred=vi();const i=this.logger.createFnLogger("renegotiateOutgoing",e);if(this._hasDelayedReconnect)return i.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,void await this.mediaSession.reconnectAsync(e,!0);i.info("start");const n=pu(i);try{try{t=this.inLocalHold()?this.getMediaModalitiesForHold(e):this.calculateModalityDirections({},e);const i=await n.execute("MediaCreateOffer",(()=>this.mediaSession.createOfferAsync(e))),r=this.getSignalingMediaTypes(t);await n.execute("SignalingStartNegotiation",(()=>this.signalingSession.startRenegotiationAsync(i,r,e)));const s=await n.execute("SignalingRenegotiationAnswer",(()=>this.renegotiationAnswerDeferred.promise));await n.execute("MediaProcessAnswer",(()=>this.mediaSession.processAnswerAsync(s,e,!1)));const a=await n.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(e)));this.onNegotiationCompletion(a,!0,t,e,n.getTelemetryData())}catch(n){if(i.logFailure(n),!n.phase)throw this.callTelemetry.recordEvent("OutgoingNegotiationFailure",n,e),n;let r="unknown";const s=this.mediaAgent.constants.RENEGOTIATION_ERROR;if(r=s.local,"SignalingRenegotiationAnswer"===n.phase||"SignalingStartNegotiation"===n.phase){const e=415;r=n.error.code===Gn.GlareError?s.glare:n.error.code===e?s.media:s.signaling}else"MediaCreateOffer"===n.phase&&n.error.type===this.mediaAgent.constants.MEDIA_ERROR.noNetworkError&&(r=s.media);if(this.callTelemetry.recordEvent("OutgoingNegotiationFailure",this.getTelemetryFromPhaseExecution(n),e),n.error.message?.includes("The requested call does not exist"))throw new Error("Call drop due to remote replying with call not found");i.logFailure(r);const a={type:r,detail:n.error};await this.mediaSession.rejectNegotiationAsync(a,e),this.onNegotiationFailure(n,r,e,t)}}catch(t){i.logFailure(t),this.callTelemetry.recordEvent("NegotiationFatalError",Oe(t),e),this.stopInternal({causeId:e,terminatedReason:47})}}async renegotiateIncoming(e,t){this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",null,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.mediaAcknowledgmentOperation.catch(yn);const i=this.logger.createFnLogger("renegotiateIncoming",t);if(i.info("start"),e.newOffer&&!this.mediaAgent.getCapabilities().retargeting)return i.logFailure("Retarget offer received, but pluginless has no support for retarget"),void this.stopInternal({causeId:t,terminatedReason:38});const n=pu(i);try{const i=await n.execute("MediaProcessOffer",(()=>this.mediaSession.processOfferAsync(e,t)));this.handleOfferedModalities(i,t),2===this.getRenegotiationOfferType(i)&&await this.prepareModalitiesForResume(t);const r=await this.updateMediaModalities({offered:i},t);1===this.getRenegotiationOfferType(i)&&await this.prepareModalitiesForHold(t),this.updateMediaState(r,t),this.isRenegotiationHoldOrResume(r)&&this.updateScreenSharingState(r,t);const s=await n.execute("MediaCreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,t))),a=this.getSignalingMediaTypes(r);await n.execute("SignalingAcceptRenegotiation",(()=>this.signalingSession.acceptRenegotiationAsync(s,a,t))),await n.execute("SignalingMediaAcknowledgement",(()=>this.mediaAcknowledgmentOperation));const o=await n.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(t)));this.onNegotiationCompletion(o,!1,i,t,n.getTelemetryData())}catch(e){try{if(!e.phase||"CompleteNegotiation"===e.phase)throw this.callTelemetry.recordEvent("IncomingNegotiationFailure",e,t),e;const n=e;this.callTelemetry.recordEvent("IncomingNegotiationFailure",this.getTelemetryFromPhaseExecution(e),t);const r={type:this.mediaAgent.constants.RENEGOTIATION_ERROR.local,detail:e.error};if("SignalingAcceptRenegotiation"===n.phase||"SignalingMediaAcknowledgement"===n.phase)return i.logFailure("Error in renegotiateIncoming() -> rejecting media negotiation"),r.type=this.mediaAgent.constants.RENEGOTIATION_ERROR.signaling,this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",r,void 0,t),void await this.mediaSession.rejectNegotiationAsync(r,t);this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",r,void 0,t),await this.mediaSession.rejectNegotiationAsync(r,t),await this.signalingSession.rejectRenegotiationAsync(void 0,t)}catch(e){i.logFailure(e),this.callTelemetry.recordEvent("NegotiationFatalError",Oe(e),t),this.stopInternal({causeId:t,terminatedReason:47})}}}async updateMediaDescriptions(e){const t=this.logger.createFnLogger("updateMediaDescriptions",e);t.info("start");try{const i=await this.mediaSession.startMediaDescriptionsUpdateAsync(e);t.info(`send updateMediaDesriptions, descriptions=${Le(i)}`),await this.signalingSession.updateMediaDescriptionsAsync(e,i);const n=await this.mediaSession.completeMediaDescriptionsUpdateAsync(e);this.onUpdateMediaDescriptionsCompletion(n,e)}catch(i){t.logFailure(i),this.callTelemetry.recordEvent("UpdateMediaDescriptionsFailure",i,e);const n=await this.mediaSession.rejectMediaDescriptionsUpdateAsync(e,!0);this.onUpdateMediaDescriptionsFailure(i,n,e)}}handleCallEscalation(e,t){const i=this.logger.createFnLogger("handleCallEscalation",t);if(i.info(`current callType=${this.callType}, escalationInProgress=${e}, isEscalationInProgress=${this.isEscalationInProgress}`),e){const e=this.participants[0];e&&e.audio.participantId===xm?e.updateStreams([{type:Cg,direction:"inactive",sourceId:null,serverMuted:!1},{type:_g,direction:"inactive",sourceId:null,serverMuted:!1},{type:Eg,direction:"inactive",sourceId:null,serverMuted:!1}],t):i.info("no 1-1 participant found, stream update ignored"),this.setCallType(2,t),this.setCallUsesMixer(!0,t),this.setIsEscalationInProgress(!1,t),this.callTelemetry.recordEvent("_EscalationCompleted",void 0,t),this.raiseChanged()}}async reportTsCallingTelemetry(e){if(this.tsCallingTelemetryReported)return;await this.connectCallPromise.catch(yn);const t=e?"call_setup_session":"in_call_session";this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo),this.reportTelemetryEvents([{eventName:t,props:this.callTelemetry.getEvent(e)}],"signaling","skypecosi_concore_web_ts_calling"),e?this.callTelemetry.switchToInCallTelemetry():this.tsCallingTelemetryReported=!0}async sendMidCallTelemetry(e){this.mediaSession&&e?.length&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(!0)),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildMidCallTelemetry(e),"media","mdsc_mid_call_telemetry"))}sendCallSetupTelemetry(){this.mediaSession&&(this.collectCallStats(this.mediaSession),this.reportCallSetupStats(),this.isCallSetupTelemetrySent=!0)}collectCallStats(e){const t=()=>this.collectMediaStatsDeferred.resolve();return e.getStatsAsync(!1).then((e=>this.callStats.setMediaStats(e))).then(t,t)}reportCallSetupStats(){this.collectMediaStatsDeferred.promise.then((()=>{this.reportTelemetryEvents(this.callStats.buildFromCallSetupStats(),"media","mdsc"),this.event("statsReported").raise(),this.collectMediaStatsDeferred=vi()}))}async reportCallEndStats(e){this.callTelemetry.setTerminationState(this.state),this.callTelemetry.setTerminationReason(this.terminatedReason),this.callStats.localStats.endCall(this.terminatedReason),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.reportTsCallingTelemetry(!this._callIsSetupComplete),e&&(await this.collectMediaStatsDeferred.promise,this.callStats.appendTerminationInfo(this.terminatedReason,this.state),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildFromMediaStats(),"media","mdsc")),this.event("statsReported").raise(),this.collectMediaStatsDeferred=vi()}reportTelemetryEvents(e,t,i){const n=this.telemetryLoggers?this.telemetryLoggers[t]:null;n?e.forEach((e=>n.sendEvent({eventName:`${i?`${i}_`:""}${e.eventName}`,props:e.props}))):this.logger.debug(`reportTelemetryEvents no logger for tenant ${t}`)}onLocalPreviewSizeChanged(e,t){this.logger.debug(`onLocalPreviewSizeChanged: ${e}x${t}`)}onLocalPreviewStateChanged(e){this.logger.debug(`onLocalPreviewStateChanged: ${e}`),this.callStats.localStats.video.streamStateChanged(e.stream)}async configureVideoModalitiesAsync(e,t){if(!this.mediaSession)return this.logger.warn("Tried to configure modalities after call end"),Promise.resolve();await this.updateMediaModalities(void 0,t),e||this.turnOffLocalVideoPreview(t),this.setVideoOn(e,t)}turnOffLocalVideoPreview(e){return this.localVideoRenderer&&(this.localVideoRenderer.dispose(),this.localVideoRenderer=null),this.disposeLocalVideoHandle(),Promise.resolve(void 0)}turnOnLocalVideoPreview(e){return this.mediaSession?.getSessionConfig().config.useDeviceHandleForLocalVideo?this.acquireLocalVideo(e):(this.localVideoContainer||(this.localVideoContainer=document.createElement("div")),this.turnOnLocalVideoPreviewUsingRenderer(e))}acquireLocalVideo(e){const t=this.logger.createFnLogger("_StartPreviewVideo",e);if(!this.mediaStateConfigurationHelper.isSending(1))return Promise.reject("could not start video preview, not configured to send");try{this.disposeLocalVideoHandle();const e=this.callDeviceManager.getDeviceManager(Ku(1));return this.localVideoHandle=e.createDevicesHandle({video:!0},"pluginlessCall:acquireLocalVideo()"),this.localVideoHandle.on("onStreamStateChanged",(e=>this.onLocalPreviewStateChanged({stream:e}))),this.localVideoHandle.acquire()}catch(e){return t.logFailure(e),void this.disposeLocalVideoHandle()}}turnOnLocalVideoPreviewUsingRenderer(e){const t=this.logger.createFnLogger("_StartPreviewVideo",e),i=this.mediaStateConfigurationHelper.isSending(1);if(!i||!this.localVideoContainer)return Promise.reject(`could not start video preview: requestedVideoState=${i}, localVideoContainer=${this.localVideoContainer}`);this.turnOffLocalVideoPreview(e);const n=Si((()=>{this.localVideoRenderer=this.callDeviceManager.getDeviceManager(Ku(1)).createPreviewRenderer(this.localVideoContainer),this.localVideoRenderer.on("onVideoSizeChanged",((e,t)=>this.onLocalPreviewSizeChanged(e,t))),this.localVideoRenderer.on("onVideoStateChanged",(e=>this.onLocalPreviewStateChanged(e)))})).then((()=>this.localVideoRenderer.startVideoAsync(e)));return n.catch((e=>t.logFailure(e))),n}async startStopVideo(e,t){const i=this.logger.createFnLogger(e?"startVideo":"stopVideo",t);return i.info("start"),this.canToggleVideo?(e?(this.callStats.localStats.newSession(1),this.callStats.localStats.video.start()):this.callStats.localStats.video.stop(),e&&this.mediaStateConfigurationHelper.isDisabled(1)&&i.info("Video modality was skipped till now. Adding it now."),e?this.mediaStateConfigurationHelper.enableModality(1):this.mediaStateConfigurationHelper.removeModality(1),this.canToggleVideo=!1,this.videoTogglePromise=(async()=>{try{let i=!1;e&&(await this.turnOnLocalVideoPreview(t),i=!0),await this.configureVideoModalitiesAsync(i,t)}catch(e){throw i.logFailure(e),this.mediaStateConfigurationHelper.removeModality(1),await this.configureVideoModalitiesAsync(!1,t),e}finally{this.canToggleVideo=!0}})(),this.videoTogglePromise):e===this.mediaStateConfigurationHelper.isSending(1)?(await this.videoTogglePromise,void this.turnOnLocalVideoPreview(t)):(i.logFailure(`video switching is in progress ${e}]`),Promise.reject({reason:1}))}async startStopAudio(e,t){const i=this.logger.createFnLogger(e?"startAudio":"stopAudio",t);try{const e=await this.updateMediaModalities(void 0,t);this.updateMediaState(e,t)}catch(e){return i.logFailure(e),9}return 0}updateEndpointStateForMute(e,t){try{this.signalingSession.updateEndpointState({state:{isMuted:e}},t).catch((e=>{this.logger.logFailure(`updateEndpointStateForMute failure: ${e}`)}))}catch(e){this.logger.logFailure(`updateEndpointStateForMute failure: ${e}`)}}async handleServerMutedState(e){const t=this.logger.createFnLogger(`handleServerMutedState, isServerMuted=${!!this.isServerMuted}`,e);if(!this.isServerMuted){const i=3===this._muteState;if(1===this._muteState||i)try{t.info("is unmuting, as we are no longer server muted"),await this.handleMuteUnmuteOnMediaSession(!1,e),this.setMuted(0,e),this.unmutePendingPromise?.resolve(),i&&this.updateEndpointStateForMute(!1,e)}catch(e){throw t.logFailure(e),e}}if(this.isServerMuted&&0===this._muteState){t.info("is muting, as we are unmuted");try{await this.handleMuteUnmuteOnMediaSession(!0,e),this.setMuted(1,e)}catch(e){throw t.logFailure(e),e}}}async handleMuteUnmuteOnMediaSession(e,t){const i=this.logger.createFnLogger(`handleMuteUnmuteOnMediaSession, value=${!!e}`,t);if(this.mediaSession&&this.mediaSession.getAllowedModalities&&!this.isServerMuted){const n=this.isMuted||this.isServerMuted,r=this.mediaSession.getAllowedModalities().audio.some((e=>e===Sg||e===yg));(n&&r||!n&&!r)&&(i.info(`updating audio modalities: Muted ${n} -> ${e}; audioAllowed = ${r}`),await this.updateMediaModalities(void 0,t))}return e?(i.info("mediaSession.muteInputAsync"),await this.mediaSession.muteInputAsync(t)):e||(i.info("mediaSession.unmuteInputAsync"),await this.mediaSession.unmuteInputAsync(t)),Promise.resolve()}updateCapabilities(e,t=!1){let i=!1,n=!1;if(!mu(this.state,[11,12])){const e="attendee"===(this.advancedMeetingRole||this.meetingRole);this.isServerMuted&&!this._callInLobby?2&this._commandUrlPresence&&(i=!0):this.isMuted&&(i=!0),n=!!(1&this._commandUrlPresence)&&!e}this._capabilities.canUnmuteSelf===i&&this._capabilities.canMuteOthers===n||(this._capabilities.canUnmuteSelf=i,this._capabilities.canMuteOthers=n,this.logger.info(`[${e}][updateCapabilities] Computed self capabilities: ${JSON.stringify(this._capabilities)}`),t&&this.raiseChanged())}async evaluateEndpointStatesForAccept(e,t,i){const n=this.logger.createFnLogger(`evaluateEndpointStatesForAccept, isMuted=${!!e}`,i),r={};try{await this.handleMuteUnmuteOnMediaSession(e,i),Object.assign(r,{state:{isMuted:e}}),n.info("is updating endpointState for mute"),t&&(Object.assign(r,{endpointProperties:{additionalEndpointProperties:t}}),n.info("is updating endpointState for additionalEndpointProperties"))}catch(e){throw n.logFailure(e),Vn(e)}return r}async handleEndpointStatesForAccept(e,t){const i=this.logger.createFnLogger("handleEndpointStatesForAccept",t);try{await this.signalingSession.updateEndpointState(e,t)}catch(e){throw i.logFailure(e),Vn(e)}}async muteUnmute(e,t){const i=this.logger.createFnLogger(`muteUnmute, value=${!!e} isServerMuted=${this.isServerMuted} inLobby=${this._callInLobby}`,t);if(mu(this.state,[11,12]))return i.logFailure("Can not mute/unmute during preheat call"),Promise.reject(Vn("TransactionDisallowed"));const n=!e&&(!this.isServerMuted||this._callInLobby);try{if((e||n)&&await this.handleMuteUnmuteOnMediaSession(e,t),e)this.setMuted(2,t),i.info("is updating endpointState for mute"),this.updateEndpointStateForMute(!0,t);else{if(!n)return i.info("is unmuting on server"),2===this._muteState&&this.setMuted(3,t),this.isCallModeStreaming()?this.promoteToRealtimeAndUnmute(t):this.signalingSession.unmuteAsync(t).then((e=>{this.handleSelfUnmuteUpdatedInfo(e,t)}));i.info("is updating endpointState for unmute"),this.setMuted(0,t),this.updateEndpointStateForMute(!1,t)}}catch(e){throw i.logFailure(e),Vn(e)}}async muteUnmuteSpeaker(e,t){this.setSpeakerMuted(e,t),this.mediaSession&&(e?await this.mediaSession.muteOutputAsync(t):await this.mediaSession.unmuteOutputAsync(t))}getParticipant(e){return this.participants.filter((t=>t.isSameParticipantsMri(e)))[0]}getOrCreateParticipant(e,t,i){let n=this.getParticipant(e);return n||(n=new Gg(e,this.mediaSession,this.logger,this.callStats.localStats,this.callTelemetry,t),n.changed((()=>this.onParticipantChanged(n))),this.participants.push(n),i&&this.event("participantAdded").raise(n),this.monitorCallStart(),n)}onParticipantChanged(e){this.event("participantUpdated").raise(e),this.raiseChangedDeferred(this._participantChangedEventSkipConfig)}setCallState(e,t,i=0){if(this.state===e)return;const n=this.logger.createFnLogger("setCallState",t);n.info(`currentState=${this.state}, newState=${e}, terminatedReason=${this.terminatedReason}`),(yu[this.state].indexOf(e)>=0||(n.logFailure("invalid state transition"),7===e))&&(this.callTelemetry.recordEvent("_SetCallState",{state:e,reason:i},t),this.state=e,this.callStats.localStats.call.callStateChanged(e),7===e&&this.setTerminatedReason(i),3===e&&(this.callGotConnected=!0,this.callHeldAt=null),this.callIsHeld()&&!this.callHeldAt&&(this.callHeldAt=new Date),n.logSuccess(`changed to ${e}, terminatedReason: ${this.terminatedReason}, failureType=${this.failureType}`),this.screenSharingControl.callStateChanged(this.state),this.monitorCallStart(),this.event("callStateChanged").raise(),this.updateCapabilities(t),this.raiseChanged(),this.callTelemetry.recordEvent("_RaiseCallStateChangeEvent",{state:e,reason:i},t))}setTerminatedReason(e){if(this.terminatedReason=e,!(0,Sr.includes)(Lm,e)){const e=44===this.terminatedReason,t=55===this.terminatedReason,i=56===this.terminatedReason;this.setFailureType(!this.callGotConnected||!this._wasAudioStreamConnected||e||t||i?0:1)}}setMediaStream(e,t,i){if(e){if(!(0,Sr.find)(this.localMediaStreams,(e=>e.mediaType===i))){const e=new Um(t,i);this.logger.info(`setMediaStream ${JSON.stringify(e)}`),this.localMediaStreams.push(e)}}else this.logger.info(`setMediaStream removing ${i}`),(0,Sr.remove)(this.localMediaStreams,(e=>e.mediaType===i))}setVideoOn(e,t){this.logger.info(`[${t}]videoOn=${e}`),this.isVideoOn=e,this.setMediaStream(this.isVideoOn,!0,1),this.callTelemetry.recordEvent("_SetLocalVideo",{value:e},t),this.raiseChanged()}setAudioOn(e,t){this.logger.info(`[${t}]audioOn=${e}`),this.setMediaStream(e,!0,0),this.callTelemetry.recordEvent("_SetLocalAudio",{value:e},t)}setScreenSharingOn(e,t){this.logger.info(`[${t}]screenSharingOn=${e}`),this.isScreenSharingOn=e,this.setMediaStream(this.isScreenSharingOn,this.isScreenSharingOn,2),this.callTelemetry.recordEvent("_SetScreenSharing",{screenSharingOn:e},t),this.event("userActivityChanged").raise(),this.raiseChanged()}disposeSharingScreenHandle(){this.sharedScreenHandle&&(this.sharedScreenHandle.dispose(),this.sharedScreenHandle=null)}disposeLocalVideoHandle(){this.localVideoHandle?.dispose(),this.localVideoHandle=null}setMuted(e,t){this._muteState!==e&&(this._muteState=e,this.callTelemetry.recordEvent("_SetMuted",{isMuted:e},t),this.logger.info(`[${t}]participantMuteState:${e}, isMuted: ${this.isMuted}`),this.updateCapabilities(t),this.raiseChanged(),this.event("muteStateChanged").raise(this.isMuted,t))}setSpeakerMuted(e,t){this.logger.info(`[${t}]speakerMute=${e}]`),this.isSpeakerMuted=e,this.raiseChanged()}monitorCallStart(){3!==this.state||!this.participants.length&&2!==this.callMode||this.callStartedAt||(this.callStartedAt=new Date)}_removeParticipant(e,t,i=0){const n=this.logger.createFnLogger("removeParticipant",t);n.info(`mri=${lg(e)}`);const r=(0,Sr.remove)(this.participants,(t=>t.isSameParticipantsMri(e.id)))[0];r?(r.setState(4,i,t),this.event("participantRemoved").raise(r)):n.logFailure(`unable to remove participant ${we(e.id)}`),this.raiseChanged(this._participantChangedEventSkipConfig)}setIsSomeoneSharing(e,t){const i=this.isSomeoneSharing!==e&&!(e&&this.screenSharingRenegotiationDeferred&&this.callUsesMixer);i&&(this.isSomeoneSharing=e);let n=i;if(this.callUsesMixer&&this.mediaSession?.getSessionConfig().config.enableStopSharingWithIncomingOffer&&(n||(n=t)),n&&this.isSomeoneSharing&&this.isScreenSharingOn&&(this.stopScreenSharing(),this.logger.info("sharingStolen: Cleaning up local screenshare because remote screenshare is running"),this.event("sharingStolen").raise()),this.allowScreenSharingControl()){const e=this.localSignalingParticipant.endpointDetails.find((e=>this._endpointId===e.endpointId)),t=this.participants.find((e=>e.streams[1].some((e=>e.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,t,e)}}handleOfferedModalities(e,t){const i=this.mediaAgent.constants.MEDIA_STATE,n=this.logger.createFnLogger("handleOfferedModalities",t);try{n.info(`offeredModalities=${Le(e)}`)}catch(e){n.logFailure(e)}e.hasOwnProperty("video")||this.mediaStateConfigurationHelper.isSending(1)?e.hasOwnProperty("video")&&!this.mediaStateConfigurationHelper.isSending(1)&&this.mediaStateConfigurationHelper.removeModality(1):this.mediaStateConfigurationHelper.disableModality(1),e.hasOwnProperty("sharing")||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.disableModality(2),e.sharing!==i.receive||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.removeModality(2),e.data===i.sendReceive&&this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.setIsSomeoneSharing(e.sharing===i.receive,!0),this.isSomeoneStreamingVideo=e.video===i.receive||e.video===i.sendReceive}getRenegotiationOfferType(e){if(e)if(5===this.state){if("sendrecv"===e.audio)return 2}else if(this.modalitiesAreHold(e))return 1;return 0}isRenegotiationHoldOrResume(e){return 1===this.getRenegotiationOfferType(e)||2===this.getRenegotiationOfferType(e)}isValidHoldResumeCallState(e){return[3,5,10,13].includes(e)}onNegotiationCompletion(e,t,i={},n,r){const s=this.logger.createFnLogger("onNegotiationCompletion",n);s.info(`byLocal=${t}, result=${Le(e)}`),this.callTelemetry.recordEvent("NegotiationCompletion",{phaseTelemetryBag:r,...this.prepareNegotiationResultForTelemtry(e)},n);const a=this.isOneToOneCall();if(a){const t=this.modalitiesAreHold(e.activeModalities)?5:3;this.participants[0].setState(t,void 0,n),s.info(`isOneToOneCall: participant[0] state set to ${t}`)}const o=this.modalitiesAreHold(e.configuredModalities),c=this.modalitiesAreHold(e.activeModalities);let l;const d=this.signalingSession.participantManager.localParticipant.isStaging;s.info(`isStaging= ${d}`),this.requestedHoldState?(o&&c||s.info(`Not expected modalities when processing local hold: ${o} ${c}`),4!==this.state&&s.info(`Not expected state when processing local hold: ${this.state}, switching back to LocalHold`)):t||this.callHoldResumeDeferred?!o&&c?l=5:o||c||this._callInLobby||this.isPreheatedOnly()||(l=d?13:3):4===this.state||this._callInLobby||this.isPreheatedOnly()||(l=a&&5===this.participants[0].state?5:d?13:3),l&&this.setCallState(l,n),this.callHoldResumeDeferred&&(s.info(`isHoldInProgress=${this.isHoldInProgress}, state=${this.state}, completed=${c}`),this.isHoldInProgress?c&&this.finishCallHoldResume():this.inLocalHold()||this.finishCallHoldResume(this.isValidHoldResumeCallState(l)?void 0:new Error(`Call state changed to ${l} instead of Connected, Lobby, Staging or RemoteHold`))),this.requestedHoldState||(this.setIsSomeoneSharing((0,Sr.some)(this.participants,(e=>(0,Sr.some)(e.streams[1],(e=>e.isAvailable))))),this.isSomeoneStreamingVideo=(0,Sr.some)(this.participants,(e=>(0,Sr.some)(e.streams[0],(e=>e.isAvailable)))));const h=i&&i.sharing===this.mediaAgent.constants.MEDIA_STATE.send,u=e?.activeModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(this.resolveScreenSharingRenegotiation(n,h,u,e.isComplete),this.retryOutgoingRenegotiation.retry){const e=this.retryOutgoingRenegotiation.causeId;this._callOperationHandler.executeChained((()=>this.updateMediaModalities(void 0,e)),"_Renegotiate",e,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.retryOutgoingRenegotiation.retry=!1}}onUpdateMediaDescriptionsFailure(e,t,i){const n=t?.requestedModalities.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.screenSharingRenegotiationDeferred&&n&&(this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null)}onUpdateMediaDescriptionsCompletion(e,t){this.logger.createFnLogger("onUpdateMediaDescriptionsCompletion",t).info(`result=${Le(e)}`),this.callTelemetry.recordEvent("UpdateMediaDescriptionsCompletion",e,t);const i=e?.requestedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send,n=e?.appliedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.resolveScreenSharingRenegotiation(t,i,n,!0)}resolveScreenSharingRenegotiation(e,t,i,n){const r=this.logger.createFnLogger("resolveScreenShareRenegotiation",e);if(r.info(`invoked with wasSharingOfferred: ${t}, isSharingActive: ${i}, isComplete: ${n}`),this.screenSharingRenegotiationDeferred)if(t&&i)r.info("resolving screenSharingRenegotiationDeferred"),this.screenSharingRenegotiationDeferred.resolve(),this.screenSharingRenegotiationDeferred=null;else if(this._enableResolveScreenSharingWhenNegotiationComplete&&n&&!this.retryOutgoingRenegotiation.retry&&this.canToggleScreenSharing){const e=new Error(`screenSharing error: wasSharingOfferred: ${t}, isSharingActive: ${i}`);r.info(`reject screenSharingRenegotiationDeferred ${e}`),this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null}}async updateMediaStatus(e){if(this.calculateIsSomeoneStreaming(e),this.mediaSession){const t=await this.updateMediaModalities(void 0,e);this.callTelemetry.updateOperationData("_UpdateLocalMediaStatus",t,e)}}calculateIsSomeoneStreaming(e){let t=!1,i=!1;for(const e of this.participants)if(t||(t=(0,Sr.some)(e.streams[1],(e=>e.isAvailable))),i||(i=(0,Sr.some)(e.streams[0],(e=>e.isAvailable))),t&&i)break;this._hasDelayedReconnect&&(t||i)&&(this.logger.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,this._callOperationHandler.executeChained((()=>this.mediaSession.reconnectAsync(e,!0)),"_RenegotiateOutgoing",e,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})),this.setIsSomeoneSharing(t),this.isSomeoneStreamingVideo=i}onNegotiationFailure(e,t,i,n){const r=n&&n.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(t===this.mediaAgent.constants.RENEGOTIATION_ERROR.glare)return this.screenSharingRenegotiationDeferred&&r&&this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),void(this.retryOutgoingRenegotiation={retry:!0,causeId:i});const s=new Error(`Error in renegotiateOutgoing() -> rejecting hold for callId = ${this.callId}, reason=${t}`);s.innerError=e,this.finishCallHoldResume(s),this.screenSharingRenegotiationDeferred&&r&&(this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null)}static getParticipantReasonFromTerminatedReason(e){switch(e){case 1:return 0;case 9:return 2;case 10:return 3;case 2:return 4;case 24:return 8;case 3:return 9;case 4:return 10;case 14:return 12;case 0:default:return 11;case 15:return 13;case 16:return 14;case 17:return 15;case 18:return 16;case 19:return 17;case 20:return 18;case 11:return 19;case 21:return 20;case 22:return 21;case 23:return 22;case 33:return 25;case 36:return 26;case 37:return 27;case 41:return 30;case 39:return 28;case 42:return 31;case 40:return 29;case 43:return 32;case 44:return 33;case 45:return 34;case 46:return 35;case 47:return 36;case 48:return 37;case 49:return 38;case 50:return 39;case 51:return 40;case 52:return 41;case 54:return 42;case 55:return 44;case 56:return 45;case 12:return 23;case 59:return 46;case 73:return 59;case 61:return 47;case 60:return 48;case 62:return 49;case 63:return 50;case 64:return 5;case 65:return 51;case 8:return 52}}isRemoteParticipantInStaging(e){if(!e.endpointDetails)return!1;for(const t of e.endpointDetails)if(!Ld(t))return!1;return!0}updateCallParticipantFromSignalingParticipant(t,i,n){if((0,Sr.every)(i.endpointDetails,(e=>e?.isLobby||e?.streamLobby)))return void t.setState(7,void 0,n);const r=(0,Sr.some)(i.endpointDetails,(e=>e?.streamInformation)),s=i.endpointDetails&&(0,Sr.some)(i.endpointDetails,(e=>e.mappedTo)),a=e.filterVirtualEndpoints(i.endpointDetails),o=a&&a[0].mediaStreams,c=this.isRemoteParticipantInStaging(i);if(o&&o.length>0){const e=o.every((e=>"inactive"===e.direction));let i=e?5:c?8:3;1!==this.state||e||this.callUsesMixer||(i=2),this.logger.info(`[updateCallParticipantFromSignalingParticipant]: with mediaStreams is not empty, ParticipantState is set to ${i}`),t.setState(i,void 0,n)}else if(o||s||r){const e=c?8:3;this.logger.info(`[updateCallParticipantFromSignalingParticipant]: ParticipantState is set to ${e}, mediaStreams=${!!o}, hasMappedEndpoints=${s}, hasPlayerStreams=${r}`),t.setState(e,void 0,n)}}handleSelfServerMutedState(t){const i=e.filterVirtualEndpoints(this.localSignalingParticipant.endpointDetails),n=(0,Sr.find)(i,(e=>this._endpointId===e.endpointId)),r=n&&n.mediaStreams,s=r&&r.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type)),a=n&&(n.stream||n.streamLobby);if(a){const e=a.serverMuted??!1;n.serverMuteVersion=0,e!==this.isServerMuted&&(this.isServerMuted=e,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${e}`),this.event("serverMutedChanged").raise(e,t),this.updateCapabilities(t,!0),this.isServerMuted&&this.setMuted(1,t))}else if(s&&s.length>0){const e=s.some((e=>e.serverMuted));e!==this.isServerMuted&&(this.isServerMuted=e,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${e}`),this.event("serverMutedChanged").raise(e,t),this.updateCapabilities(t,!0),this.handleServerMutedState(t))}}checkIfIncomingServerMutedIsUpdated(e){const t=(0,Sr.find)(this.localSignalingParticipant.endpointDetails,(e=>e.participantId===this.localSignalingParticipant.participantId));if(void 0===t)return;const i=(0,Sr.find)(e.endpointDetails,(e=>e.participantId===this.localSignalingParticipant.participantId));sg(this.logger,t,i)}convertWiredPublishedState(e){if(!e)return;const t=ks(e.stateType);return{content:e.content,stateType:t,typeRank:e.typeRank,stateId:e.stateId}}updatePublishedStateModified(e,t){e!==this.currentUserSkypeIdentity.id||t&&t!==this.participantId?this._publishedStatesModified=2|this._publishedStatesModified:this._publishedStatesModified=1|this._publishedStatesModified}updatePublishedStates(e){try{let t=[];(0,Sr.forEach)(e.publishedStates,(e=>{t.push(this.convertWiredPublishedState(e))})),(0,Sr.isEqual)(this._participantPublishedStatesMap[e.id],t)||(0!==t.length||void 0!==this._participantPublishedStatesMap[e.id]&&null!==this._participantPublishedStatesMap[e.id])&&(this._participantPublishedStatesMap[e.id]=t,this.updatePublishedStateModified(e.id));const i=[];(0,Sr.forEach)(e.endpointDetails,(n=>{i.push(n.participantId),t=[],(0,Sr.forEach)(n.publishedStates,(i=>{const r=this.convertWiredPublishedState(i);this._endpointPublishedStatesMap[e.id]||(this._endpointPublishedStatesMap[e.id]={},this._endpointPublishedStatesMap[e.id][n.participantId]=[]),t.push(r)})),this._endpointPublishedStatesMap[e.id]&&!(0,Sr.isEqual)(this._endpointPublishedStatesMap[e.id][n.participantId],t)&&(0!==t.length||null!==this._endpointPublishedStatesMap[e.id][n.participantId]&&void 0!==this._endpointPublishedStatesMap[e.id][n.participantId])&&(this._endpointPublishedStatesMap[e.id][n.participantId]=t,this.updatePublishedStateModified(e.id,n.participantId))})),this._endpointPublishedStatesMap[e.id]&&Object.keys(this._endpointPublishedStatesMap[e.id]).forEach((t=>{i.some((e=>e===t))||(delete this._endpointPublishedStatesMap[e.id][t],this.updatePublishedStateModified(e.id,t))}))}catch(e){this.logger.error(`updatePublishedStates ${JSON.stringify(e)}`)}this.logger.info(`updatePublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`updatePublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`)}removePublishedStatesByParticipant(e){this._endpointPublishedStatesMap[e]&&delete this._endpointPublishedStatesMap[e],this._participantPublishedStatesMap[e]&&delete this._participantPublishedStatesMap[e],this.updatePublishedStateModified(e)}findOrCreateTypeState(e){let t=this._publishedStates.typeStates.findIndex((t=>t.type===e));if(-1===t){const i={participantStates:[],type:e};this._publishedStates.typeStates.push(i),t=this._publishedStates.typeStates.length-1}return t}processPublishedStates(){this.logger.info(`processPublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`processPublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`);try{this._publishedStates||(this._publishedStates={typeStates:[]}),this._publishedStates.typeStates=[];for(const e of Object.keys(this._participantPublishedStatesMap)){const t=this._participantPublishedStatesMap[e];(0,Sr.forEach)(t,(t=>{const i=this.findOrCreateTypeState(t.stateType),n={id:e,publishedState:{content:t.content,stateId:t.stateId,typeRank:t.typeRank}};this._publishedStates.typeStates[i].participantStates.push(n)}))}for(const e of Object.keys(this._endpointPublishedStatesMap))for(const t of Object.keys(this._endpointPublishedStatesMap[e]))this._endpointPublishedStatesMap[e][t].forEach((i=>{const n=this.findOrCreateTypeState(i.stateType),r={id:t,publishedState:{content:i.content,stateId:i.stateId,typeRank:i.typeRank}},s={id:e,endpoints:[r]},a=this._publishedStates.typeStates[n].participantStates.filter((t=>t.id===e));a&&a.length>0?(a[0].endpoints||(a[0].endpoints=[]),a[0].endpoints.push(r)):this._publishedStates.typeStates[n].participantStates.push(s)}));this.event("publishedStatesChanged").raise(this._publishedStates),this.raiseChanged()}catch(e){this.logger.error(`processPublishedStates ${e}}`)}}updateLocalParticipant(t,i){const n=this.logger.createFnLogger("updateLocalParticipant",i);this.checkIfIncomingServerMutedIsUpdated(t),this.localSignalingParticipant.endpointDetails=t.endpointDetails,this.localSignalingParticipant.role=t.role,this.setMeetingRole(t.meetingRole),this.setAdvancedMeetingRole(t.advancedMeetingRole),this.setParticipantType(t.participantType),this.setPropertyBag(t.propertyBag),this.setPropertyRosterVersion(t.version),this.setMaskedIdentityDetails(t.isIdentityMasked,t.maskedIdSeqNumber,t.maskedId),this.localSignalingParticipant.tenantId=t.tenantId,this.localSignalingParticipant.isLobby=t.isLobby,t.joinAsStreamingUser&&(this.localSignalingParticipant.joinAsStreamingUser=t.joinAsStreamingUser,this.setJoinAsStreamingUser(t.joinAsStreamingUser)),void 0!==t.enableCaptcha&&this.setEnableCaptcha(t.enableCaptcha),this.callTelemetry.setTenantId(t.tenantId),this.callStats.setTenantId(t.tenantId);const r=this.localSignalingParticipant.isLobby;t.endpointDetails&&this.updateLocalParticipantEndpoints(t.endpointDetails),this.updatePublishedStates(t),this.handleSelfServerMutedState(i);const s=this.getLocalSignalingEndpointDetails();this._callInLobby=r||!!s?.streamLobby,this.signalingSession.participantManager.localParticipant.isStaging=t.isStaging;const a=this.signalingSession.participantManager.localParticipant.isStaging;n.info(`callInLobby = ${r}, callSetupComplete = ${this._callIsSetupComplete}, callIsHeld = ${this.callIsHeld()}, isStaging = ${a}`),!this._callIsSetupComplete||this.callIsHeld()||mu(this.state,[11,12])||(r?this.setCallState(10,i):a&&mu(this.state,[3,13,10,9,2])?this.setCallState(13,i):this.setCallState(3,i));const o=e.getStreamsFromEndpoints(t.endpointDetails);if(this.callTelemetry.recordEvent("_UpdateLocalParticipantStream",function(e){let t=[];return e.forEach((e=>{try{let i=t.find((t=>t.participantId===e.participantId&&t.endpointId===e.endpointId));i||(i={participantId:e.participantId,endpointId:e.endpointId},t.push(i)),"audio"!==e.type&&"audioteleconference"!==e.type||(i.serverMuted=e.serverMuted),i[e.type]=e.direction}catch(e){t=[]}})),t}(o),i),this.streamManager.updateStreams(o,i),this.updateCapabilities(i,!0),this.allowScreenSharingControl()){const e=t.endpointDetails.find((e=>this._endpointId===e.endpointId)),i=this.participants.find((e=>e.streams[1].some((e=>e.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,i,e)}}modalitiesAreHold(e){return!(e.audio&&"inactive"!==e.audio||e.video&&"inactive"!==e.video||e.sharing&&"inactive"!==e.sharing)}toneToString(e){switch(e){case 0:return"0";case 1:return"1";case 2:return"2";case 3:return"3";case 4:return"4";case 5:return"5";case 6:return"6";case 7:return"7";case 8:return"8";case 9:return"9";case 10:return"*";case 11:return"#";default:return null}}static streamingStatetoMediaStreamState(e){switch(e){case"started":return 0;case"active":return 2;case"inactive":return 1;case"stopped":return 3;default:return 4}}static streamingDirectionToMediaDirectionMapping(e){switch(e){case"send":return 1;case"receive":return 0;default:return}}static convertMuteScope(e){switch(e){case 0:return"EveryoneElse";case 1:return"SpecifiedParticipants";default:return}}callIsHeld(){return 4===this.state||5===this.state}inLocalHold(){return this.isHoldInProgress||4===this.state}telemetryDataFromCallStartOptions(e){const t={};return e.muteFlags&&(t.muteMicrophone=!!(1&e.muteFlags),t.muteSpeaker=!!(2&e.muteFlags)),Object.keys(t).length?t:void 0}reconnect(){const e=Te();return this.mediaSession.reconnectAsync(e)}async provideCallQualityFeedback(e,t,i,n){}async showCQFInfo(e,t){throw new Error("Not implemented")}async isCqfRendered(e){}async provideCallQualityFeedbackEx(e,t,i,n,r,s){}testTriggerMediaRelayWhiteListingIssue(){this.logger.info("Simulating media relay whitelisting issue for test purposes");const e=this.mediaSession.mediaSession.callback;e.onQualityChanged({type:"NetworkRelaysNotReachable",value:"Bad",isLocalSource:!0,mediaType:"Audio"});e.onAudioStateChanged({direction:"send",stream:"failed",content:"audio"})}async getMediaTelemetry(e=!1){return this.mediaSession&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(e)),this.appendInfoToCallStats()),this.callStats.buildMediaTelemetry()}getMediaSessionStats(){return this.mediaSession?.getMediaStatsReport()}getDiagnosticsForE2E(){return this.mediaSession?.getDiagnostics().e2eDiagnostics}appendInfoToCallStats(){this.callStats.appendDataChannelInfo(this.dataChannel.getTelemetry()),this.callStats.appendSharingControlInfo(this.screenSharingControl?.isScreenSharingControlEnabled()),this.callStats.appendMediaControlPaneInfo(JSON.stringify(this.mediaControlPlane.getTelemetryReport()))}getMediaLogs(){return this.mediaAgent.getMediaLogs()}testSetCallState(e){this.logger.info(`Overwriting call state for test purposes: ${this.state} -> ${e} `),this.state=e}testSetCallType(e){this.logger.info(`Overwriting call state for test purposes: ${this.callType} -> ${e} `),this.callType=e}addGroupModality(e,t=Te()){const i=this.logger.createFnLogger("AddGroupModality",t);if(!e.threadId&&!e.groupId)return Promise.reject(Vn("No threadId/groupId was provided."));if(6===this.state||7===this.state)return i.info(`Not adding modality because CallState is ${this.state} groupId=${we(e.groupId)}, threadId = ${Me(e.threadId)} messageId = ${e.messageId}`),Promise.reject(Vn("TransactionDisallowed"));let n;if(e.additionalData)try{n=JSON.stringify(e.additionalData)}catch(t){i.logFailure(`additionalData: ${e.additionalData} is not valid Json, error: ${t}`);const n={code:Gn.BadRequest,subCode:0,phrase:`additionalData is not valid Json, error: ${t}`};return Promise.reject(n)}i.info(`groupId=${we(e.groupId)}, threadId = ${Me(e.threadId)} messageId = ${e.messageId} additionalData = ${we(n)}`);const r={groupId:e.groupId,threadId:e.threadId,messageId:e.messageId,additionalData:n};return this.signalingSession.addGroupModalityAsync(r,t).catch((e=>(i.logFailure(Ne(e)),Promise.reject(e))))}addBroadcastModality(e,t){const i=this.logger.createFnLogger("AddBroadcastModality",t);return Promise.resolve().then((()=>{this.signalingSession.addBroadcastModalityAsync(e,t)})).catch((e=>(i.logFailure(Ne(e)),Promise.reject(Vn(e))))).then((()=>this._callOperationHandler.waitForOperation("AddBroadcastModality"))).catch((e=>{throw this.callTelemetry.updateOperationData("AddBroadcastModality",{error:Oe(e)},t),i.logFailure(e),e}))}static convertQualityEventType(e){switch(e){case"NetworkSendQuality":return 1;case"NetworkRecvQuality":return 2;case"NetworkDelay":return 3;case"NetworkBandwidthLow":return 4;case"NetworkReconnect":return 5;case"NetworkPacketLoss":return 6;case"NetworkJitter":return 7;case"NetworkRateMatching":return 8;case"DeviceCaptureNotFunctioning":return 9;case"DeviceRenderNotFunctioning":return 10;case"DeviceRenderGlitches":return 11;case"DeviceLowSNR":return 12;case"DeviceLowSpeechLevel":return 13;case"DeviceClipping":return 14;case"DeviceEcho":return 15;case"DeviceNearEndToEchoRatio":return 16;case"DeviceHalfDuplexAec":return 17;case"DeviceMultipleEndpoints":return 18;case"DeviceHowling":return 19;case"DeviceRenderZeroVolume":return 20;case"DeviceRenderMute":return 21;case"NetworkSendCatastrophic":return 22;case"NetworkRecvCatastrophic":return 23;case"CpuInsufficient":return 24;case"DeviceCaptureMute":return 25;case"DeviceCaptureNotMuteButSilent":return 26;case"DeviceSpeakWhileMuted":return 27;case"VideoVbssRendered":return 28;case"NetworkEthernetInterfaceUsed":return 29;case"NetworkWlanInterfaceUsed":return 30;case"NetworkWwanInterfaceUsed":return 31;case"NetworkRelaysNotReachable":return 32;case"VideoCapturerDeviceStartFailed":return 33;case"VideoCapturerDeviceStartTimedOut":return 34;case"VideoCapturerDeviceStartFailureLackSystemRes":return 35;case"VideoCapturerDeviceStartFailureMFResConflict":return 36;case"NoNetwork":return 37;case"NetworkNotWorking":return 38;case"DeviceCaptureNotFunctioningDeviceInUse":return 39;case"DeviceRenderNotFunctioningDeviceInUse":return 40;case"VideoCaptureDeviceFreeze":return 45;case"ZeroCaptureDevicesEnumerated":return 43;case"ZeroRenderDevicesEnumerated":return 44;case"VideoCapturePermissionDenied":return 47;case"ScreenshareRecordingDisabled":return 55;case"AudioCapturePermissionDenied":return 46;case"VideoCaptureFreezeRecovered":return 48;case"DeviceRenderHowling":return 49;case"PresentationAudioLoopbackDeviceState":return 53;case"RemoteNetworkConnectivityIssue":return 52;case"AudioCaptureUltrasoundDetected":return 54;case"MusicModeNotAvailable":return 57;case"CameraLighting":return 61;case"AudioLoopbackDeviceReady":return 63;case"NoRequiredVideoCodecs":return 64;case"SpatialAudioMUCHUnavailable":return 65;default:return}}static convertQualityLevel(e){switch(e){case"Unknown":return 0;case"Good":return 1;case"Poor":return 2;case"Bad":return 3;default:return}}static convertMediaType(e){switch(e){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2;case"Data":return 3;default:return}}getPluginlessPublishLevel(e){switch(e){case"user":return"user";case"endpoint":return"endpoint";default:throw"Invalid level type."}}setIsEmergency(e){this.logger.info(`Set isEmergency:${e}`),this.isEmergency=e,this.callTelemetry.setIsEmergency(e)}static filterVirtualEndpoints(e){return e&&(0,Sr.filter)(e,(e=>!e.mappedTo))}mapDataChannelSourceIdToParticipant(e){let t=null;return t=1===this.callType?this.participants[0]:(0,Sr.find)(this.participants,(t=>t.hasSourceId(3,e))),t?.id?this.logger.info(`ParticipantId: ${we(t.id)} to SourceId: ${e}`):this.logger.warn(`No Participant found for SourceId: ${e}`),t}getDataChannelSourceId(){const e=(0,Sr.find)(this.endpoints.endpointDetails,(e=>null!==e&&e.participantId===this._participantId));if(!e)return this.logger.warn(`No participantLeg found for participantId: ${this._participantId}`),-1;if(!e.mediaStreams)return this.logger.warn(`ParticipantLeg ${this._participantId} does not have valid mediaStreams`),-1;const t=(0,Sr.find)(e.mediaStreams,(e=>3===Od(e.type)));return t?t.sourceId:(this.logger.warn(`participantLeg ${this._participantId} has no data channel`),-1)}initializeMediaControlPlane(){this.mediaControlPlane=new eg(this.dataChannel,this.logger.createChild("MediaControlPlane"),this.mediaAgent.getConfigProvider().config.mediaControlPlaneConfig),this.mediaControlPlane.on("mpSendBandwidthChanged",(e=>{this.mediaSession?.processNotification("BandwithNotification",{bw:e});const t=this.mediaSession?.getExtensionsManager();t?.processNotification("BandwithNotification",{bw:e})})),this.mediaControlPlane.on("mpDshStatusChanged",(e=>{this.updateSignalingDSHMessageSubscription(!e),e&&this.mediaSession?.getDiagnostics()?.dshDiagnostics.setCurrentActiveStrategy("server")})),this.mediaControlPlane.on("onHandshakeTimeout",(()=>{this.isSignalingDSHFallbackEnabled()&&this.updateSignalingDSHMessageSubscription(!0)})),this.mediaControlPlane.on("mpDshChanged",(e=>{const t=this.mediaSession?.getExtensionsManager();t?.processNotification("McpDominantSpeakerInfo",{history:e})}))}initializeLiveStreamConfigProvider(){const e="MDN_MIDDLELANE_TEAMS",t=this.ecsProvider.getEcsConfig(e,"liveStream"),i=this.ecsProvider.getEcsConfig("ConfigIDs",e);this._liveStreamConfigProvider=new ci(t,null,i,this.logger.createChild("LiveStreamConfigProvider"))}isMediaSending(e){return this.mediaStateConfigurationHelper.isSending(e)}};Fm.instanceCount=0,S([Rn("Initialize",{type:"Sync",convertError:!0,idempotencyLevel:"NoOp"})],Fm.prototype,"init",1),S([Rn("StartVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"startVideo",1),S([Rn("StopVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"stopVideo",1),S([Rn("DumpVideoSourceImages")],Fm.prototype,"dumpVideoSourceImages",1),S([v(1,Mn)],Fm.prototype,"hold",1),S([Rn("Hold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(0,Mn)],Fm.prototype,"holdWithRenegotiate",1),S([Rn("LocalHold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(0,Mn)],Fm.prototype,"localHold",1),S([Rn("Unhold",{waitFor:["Hold","LocalHold"],preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"unhold",1),S([Rn("UpdateEndpointMetadata"),v(1,Mn)],Fm.prototype,"updateEndpointMetadata",1),S([Rn("SendDtmfTone",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Fm.prototype,"sendDtmfTone",1),S([Rn("SetAudioUsage")],Fm.prototype,"setAudioUsageMode",1),S([Rn("SetAudioMidcallConfig")],Fm.prototype,"setAudioMidcallConfig",1),S([Rn("SetAudioMidcallConfigJon",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"setAudioMidcallConfigJson",1),S([Rn("SetParticipantSpatialAudioPositions",{waitFor:"_ElectronSlimcoreReady",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"setParticipantSpatialAudioPositions",1),S([Rn("BlindTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"callBlindTransfer",1),S([Rn("SafeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"callSafeTransfer",1),S([Rn("TransferToVoicemail",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"transferCallToVoicemail",1),S([Rn("ConsultativeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"callConsultativeTransfer",1),S([Rn("ConsultativeTransferWithPickupCode",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Fm.prototype,"consultativeTransferWithPickupCode",1),S([Rn("CallRedirect",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"callRedirect",1),S([Rn("ParkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"park",1),S([Rn("UnparkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"unpark",1),S([Rn("getTechnicalInformationJson",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Fm.prototype,"getTechnicalInformationJson",1),S([Rn("StartScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(3,Mn)],Fm.prototype,"startScreenSharing",1),S([Rn("StopScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(2,Mn)],Fm.prototype,"stopScreenSharing",1),S([Rn("StartDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"startDataChannel",1),S([Rn("StopDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"stopDataChannel",1),S([Rn("ShareSystemSounds",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"shareSystemSound",1),S([Rn("Mute",{waitFor:"JoinPreheatedCall",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]},!0),v(0,Mn)],Fm.prototype,"mute",1),S([Rn("Unmute",{waitFor:["JoinPreheatedCall"]},!0),v(0,Mn)],Fm.prototype,"unmute",1),S([Rn("MuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(0,Mn)],Fm.prototype,"muteSpeaker",1),S([Rn("UnmuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(0,Mn)],Fm.prototype,"unmuteSpeaker",1),S([Rn("MuteParticipants",void 0,!0),v(2,Mn)],Fm.prototype,"muteParticipants",1),S([Rn("StartAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"startAudio",1),S([Rn("StopAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"stopAudio",1),S([Rn("Assimilate"),v(3,Mn)],Fm.prototype,"assimilate",1),S([v(2,Mn)],Fm.prototype,"merge",1),S([Rn("MergeParticipants"),v(1,Pn),v(3,Mn)],Fm.prototype,"mergeParticipants",1),S([Rn("MergeWithPickupCode"),v(0,Pn),v(2,Mn)],Fm.prototype,"mergeWithPickupCode",1),S([Rn("SetMaxVideoChannels")],Fm.prototype,"setMaxVideoChannels",1),S([Rn("SetMaxVbssChannels")],Fm.prototype,"setMaxVbssChannels",1),S([Rn("StopCall"),v(1,Mn),v(3,On)],Fm.prototype,"stop",1),S([Rn("PublishState"),v(1,Pn)],Fm.prototype,"publishState",1),S([Rn("PublishState"),v(1,Pn)],Fm.prototype,"publishStatesForEveryone",1),S([Rn("RemoveState"),v(1,Pn)],Fm.prototype,"removeState",1),S([Rn("RemoveState"),v(1,Pn)],Fm.prototype,"removeStatesForEveryone",1),S([Rn("UpdateMeetingSettings"),v(1,Pn)],Fm.prototype,"updateMeetingSettings",1),S([Rn("UpdateMeetingGroups"),v(0,Pn)],Fm.prototype,"updateMeetingGroups",1),S([Rn("UpdateMeetingLiveState"),v(0,Pn)],Fm.prototype,"updateMeetingLiveState",1),S([Rn("UpdateMeetingStates"),v(1,Pn)],Fm.prototype,"updateMeetingStates",1),S([Rn("UpdateParticipantInterpretationState"),v(0,Pn)],Fm.prototype,"updateParticipantInterpretationState",1),S([Rn("UpdateParticipantsProperties")],Fm.prototype,"updateParticipantsProperties",1),S([Rn("JoinMeetingGroup"),v(0,Pn)],Fm.prototype,"joinMeetingGroup",1),S([Rn("LeaveMeetingGroup"),v(0,Pn)],Fm.prototype,"leaveMeetingGroup",1),S([Rn("SendMessages"),v(0,Pn)],Fm.prototype,"sendMessages",1),S([Rn("UpdateMonitorSession"),v(1,Mn)],Fm.prototype,"updateMonitorSession",1),S([Rn("UpdateMeetingRole")],Fm.prototype,"updateMeetingRoles",1),S([Rn("CreateContentSharingSession"),v(4,Mn)],Fm.prototype,"createContentSharingSession",1),S([Rn("StopCallWithBeacon",{type:"Sync"}),v(0,Mn)],Fm.prototype,"stopWithBeacon",1),S([Rn("Acknowledge",{type:"Chained",convertError:!0,idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(2,Mn)],Fm.prototype,"acknowledge",1),S([Rn("Accept",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(1,Mn)],Fm.prototype,"accept",1),S([Rn("Reject",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(0,Mn),v(1,On)],Fm.prototype,"reject",1),S([Rn("JoinCall",{type:"Chained",idempotencyLevel:"Error"}),v(1,Dn),v(2,Mn)],Fm.prototype,"join",1),S([Rn("JoinPreheatedCall",{waitFor:"_CallStartOrJoinInitiated"})],Fm.prototype,"joinPreheatedCall",1),S([Rn("StartCall",{type:"Chained",idempotencyLevel:"Error"}),v(0,Dn),v(1,Mn)],Fm.prototype,"start",1),S([Rn("StartCallToVoiceMail",{type:"Chained",idempotencyLevel:"Error"}),v(1,Mn)],Fm.prototype,"startCallToVoicemail",1),S([Rn("Subscribe",{type:"Chained",idempotencyLevel:"Error"}),v(2,Mn)],Fm.prototype,"joinCallWithoutCallModality",1),S([Rn("StartWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Fm.prototype,"startWithMeetingData",1),S([Rn("JoinWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Fm.prototype,"joinWithMeetingData",1),S([Rn("SubscribeWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Fm.prototype,"subscribeWithMeetingData",1),S([Rn("StartCallWithNudge",{type:"Chained",idempotencyLevel:"Error"}),v(1,Dn),v(2,Mn)],Fm.prototype,"startCallWithNudge",1),S([Rn("StartCallAndUnpark",{type:"Chained",idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v(2,Dn),v(3,Mn)],Fm.prototype,"startAndUnpark",1),S([wn("AdmitParticipant"),v(0,Pn),v(1,Mn)],Fm.prototype,"admitParticipant",1),S([Rn("Admit")],Fm.prototype,"admit",1),S([wn("CallMeBack"),v(0,Pn),v(2,Mn)],Fm.prototype,"callMeBack",1),S([v(0,Pn),v(2,Mn)],Fm.prototype,"addParticipant",1),S([wn("AddParticipants"),v(0,Pn),v(2,Mn)],Fm.prototype,"addParticipants",1),S([v(0,Pn),v(2,Mn)],Fm.prototype,"addParticipantsImpl",1),S([wn("NudgeParticipants"),v(0,Pn),v(3,Mn)],Fm.prototype,"nudgeParticipants",1),S([wn("RemoveParticipant"),v(0,Pn),v(1,Mn)],Fm.prototype,"removeParticipant",1),S([Rn("SearchParticipants"),v(1,Pn),v(1,Mn)],Fm.prototype,"searchParticipants",1),S([Rn("GetAllParticipants"),v(1,Pn),v(1,Mn)],Fm.prototype,"getAllParticipants",1),S([Rn("_PromotionToRealtime"),v(1,Mn)],Fm.prototype,"promoteToRealtime",1),S([v(0,Mn)],Fm.prototype,"turnOffLocalVideoPreview",1),S([Rn("_StartPreviewVideo"),v(0,Mn)],Fm.prototype,"turnOnLocalVideoPreview",1),S([v(0,Mn)],Fm.prototype,"acquireLocalVideo",1),S([v(0,Mn)],Fm.prototype,"turnOnLocalVideoPreviewUsingRenderer",1),S([Rn("_UpdateLocalMediaStatus",{type:"Chained"}),v(0,Mn)],Fm.prototype,"updateMediaStatus",1),S([v(0,Mn)],Fm.prototype,"calculateIsSomeoneStreaming",1),S([Rn("_Reconnect")],Fm.prototype,"reconnect",1),S([Rn("AddGroupModality"),v(1,Mn)],Fm.prototype,"addGroupModality",1),S([Rn("AddBroadcastModality")],Fm.prototype,"addBroadcastModality",1);var Vm=Fm;function Bm(e){const t=new TextDecoder("utf-8"),i=atob(e),n=Uint8Array.from(i,(e=>e.charCodeAt(0)));return t.decode(n)}var Hm=f(le()),$m=new RegExp("/callAgent/","i"),Gm=class{constructor(e,t){this.signalingAgentProvider=e,this.callRegistry=t}handleMessage(e){if(!e.eventId){if(e.url.search($m)>-1){const t=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(e);return"number"==typeof t?{isHandled:!0,resultCode:t}:{isHandled:!0,resultCode:t.resultCode,responseBody:t.responseBody,responseHeaders:t.responseHeaders}}return{isHandled:!1}}if(e.eventId in Yn){this.callRegistry.logUploadNotification(e);const t=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(e);return"number"==typeof t?{isHandled:!0,resultCode:t}:{isHandled:!0,resultCode:t.resultCode,responseBody:t.responseBody,responseHeaders:t.responseHeaders}}return{isHandled:!1}}},jm=class{constructor(e,t,i){this.callRegistry=e,this.recentInvitations=[],this.logger=t.createChild("IncomingCallMessageHandler"),this.ecsProvider=i,this.useExperimentalDecode=this.ecsProvider?.getEcsConfig("SkypeCalling","useExperimentalDecode")}handleMessage(e){const t=this.handleIncomingCall(e);return t?{isHandled:t,resultCode:200}:{isHandled:t}}handleIncomingCall(e){const t=Te(),i=this.logger.createFnLogger("handleIncomingCall",t);if(this.isProxiableNotification(e))return this.callRegistry.proxyPushNotification(e),!0;if(!this.isIncomingCallMessage(e))return!1;let n;try{if(e?.body?.gp&&!Fe(e.body.gp))i.info("unencoded payload, skipping decoding."),n=e.body.gp;else{const t=Wm(e,i,this.useExperimentalDecode);n=JSON.parse(t)}n.body=e.body}catch(e){return i.logFailure(`Error parsing notification payload: ${e}`),!1}const r=this.isCallTransferNotification(e)?this.buildTransferCallPayload(n):this.buildNGCCallPayload(n);if(!r)return!1;if(this.callRegistry.calls.some((e=>e.callId===r.convoCallId&&e.participantId===r.participantId)))return i.logFailure(`Duplicate call filtered because it was in the call registry, callId = ${r.convoCallId}, participantId = ${r.participantId}`),!1;const s=this.isCallReplacementNotification(e);if(i.log(`replacementCall=${s}`),!s&&this.recentInvitations.some((e=>e.convoCallId===r.convoCallId&&e.participantId===r.participantId)))return i.logFailure(`Duplicate call filtered because it was in the recent calls list, callId = ${r.convoCallId}, participantId = ${r.participantId}`),!1;5===this.recentInvitations.length&&this.recentInvitations.shift(),this.recentInvitations.push({convoCallId:r.convoCallId,participantId:r.participantId});let a=this.callRegistry.calls.find((e=>e.callId===r.convoCallId&&8===e.state));return a||(a=r.groupId?this.callRegistry.createCallWithGroupId(r.groupId,r.convoCallId,r.participantId,t):this.callRegistry.createCall(r.conversationId,r.convoCallId,r.participantId,void 0,t)),a.init({threadId:r.conversationId,messageId:r.messageId,mediaPeerType:2}),this.callRegistry.testEndpointMetadata?a.acknowledge(r,this.callRegistry.testEndpointMetadata,t):a.acknowledge(r,void 0,t),!0}isIncomingCallMessage(e){return Object.keys(Jn).some((t=>Jn[t]===e.eventId))?e.eventId!==Jn.INCOMING_TFL_TFW_CALL||this.ecsProvider?.getEcsConfig("SkypeCalling","enableTFWTFLOneToOneCall"):this.isCallTransferNotification(e)}isCallTransferNotification(e){return e.callNotification&&("transfer"===e.callNotification.callType||"replaces"===e.callNotification.callType)}isCallReplacementNotification(e){return e.callNotification&&"replaces"===e.callNotification.callType}isProxiableNotification(e){return Object.keys(Kn).some((t=>Kn[t]===e.eventId))}buildTransferCallPayload(e){const t={body:e.body,callerId:e.callNotification.from.id,groupId:null,conversationId:null,convoCallId:e.debugContent.callId,isMultiParty:e.conversationInvitation?.isMultiParty,fromMixer:e.callNotification.fromMixer,ngcCall:!0,participantId:e.callNotification.to.participantId,transferorId:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.id,transferorType:e.callNotification.transferor&&e.callNotification.transferor.transferorType,transferorDisplayName:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.displayName,callType:e.callNotification.callType,consultativeCallId:e.callNotification.consultativeCallId,messageId:null,callQueueInfo:e.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0};return this.logger.info("Incoming transfer paylod",t),t}buildNGCCallPayload(e){if(!e.callNotification)return this.logger.error("Missing callNotification in parsed incoming NGC call payload"),null;const t={groupId:e.groupContext?.id,conversationId:e.groupChat?.threadId,messageId:e.groupChat?.messageId,callerId:e.callNotification.from.id,isMultiParty:e.conversationInvitation.isMultiParty,fromMixer:e.callNotification.fromMixer,convoCallId:e.debugContent.callId,participantId:e.debugContent.participantId,ngcCall:!0,body:e.body,transferorId:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.id,transferorType:e.callNotification.transferor&&e.callNotification.transferor.transferorType,transferorDisplayName:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.displayName,callType:e.callNotification.callType,callQueueInfo:e.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0,fromApplicationType:e.callNotification.fromApplicationType};return this.logger.info("Incoming NGC payload",t),t}},qm=class extends We{constructor(e,t,i,n,r,s=null,a,o){super(),this.trouterService=e,this.signalingAgentProvider=t,this.mediaAgent=i,this.callingLogger=n,this.telemetryLoggers=r,this.ecsProvider=s,this.skypeIdentity=a,this.oneDsTelemetryLoggers=o,this.calls=[],this.isDisposing=!1,this._disposedPromise=vi(),this.testEndpointMetadata=null,this._disconnectingPromiseDefers=new Map,this.skypeIdentity&&(this.identity=this.skypeIdentity.id),this.callSubscriptionsMap=new Map,this.logger=new Qt(this.callingLogger).createChild(`CallRegistry/${Te()}`),this.registryTelemetry=new gn(this.logger,(new Date).getTime()),this._callOperationHandler||(this._callOperationHandler=new $n(this.logger,this.registryTelemetry,{},(e=>{this._publishTelemetry(e)})));const c=this.mediaAgent.getConfig().disconnectOnPageHide;this._windowUninitEvent=c?"pagehide":"beforeunload",this.signalingAgentProvider.getSignalingAgent().setTokenRequiredCallBack(this.onTokenRequired.bind(this)),this._createNewCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","createNewCallInDisconnectedState"),this._invokeDeleteCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","invokeDeleteCallInDisconnectedState"),this._useExperimentalDecode=this.ecsProvider.getEcsConfig("SkypeCalling","useExperimentalDecode")}init(e,t,i=Te()){return this.logger.createFnLogger("init",i).info("init"),this.login(e)}uninit(){return this.logout()}login(e,t=Te()){return this.logger.createFnLogger("login",t).info("login"),this.skypeIdentity=e,this.identity=this.skypeIdentity.id,this.initialize(t)}initialize(e=Te(),t){const i=this.logger.createFnLogger("initialize",e),n=t&&t.applicationType?t.applicationType:"null";i.info(`initialize with applicationType: ${n}`),this.accountConfiguration=t,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(t),this.incomingCallMessageHandler=new jm(this,this.logger,this.ecsProvider),this.trouterService.registerMessageHandler(new Gm(this.signalingAgentProvider,this)),this.trouterService.registerMessageHandler(this.incomingCallMessageHandler),i.info("Call registry init, endpointMetadata",this.testEndpointMetadata);try{this.windowUninitListener=()=>{this._disregardWindowUninitEvents||this.stopCallsWithBeacon()},window.addEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(e){i.logFailure(`Not adding beforeunload listener: ${e}`)}return Promise.resolve(void 0)}logout(e=Te()){const t=this.logger.createFnLogger("logout",e);t.info("logout");try{this.trouterService.clearMessageHandlers(),window.removeEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(e){t.info(`Not removing beforeunload listener: ${e}`)}return Promise.resolve(void 0)}_publishTelemetry(e){if(!this.telemetryLoggers?.signaling)return;this.registryTelemetry.setSkypeId(this.identity);try{const e=this.signalingAgentProvider.getSignalingAgent();this.registryTelemetry.setEndpointId(e.endpointId)}catch(e){this.logger.warn("Could not get end point ID from signaling agent for call registry telemetry.")}this.accountConfiguration&&(this.registryTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.registryTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.registryTelemetry.setPartition(this.accountConfiguration.partition),this.registryTelemetry.setRegion(this.accountConfiguration.region),this.registryTelemetry.setRing(this.accountConfiguration.ring),this.registryTelemetry.setTenantId(this.accountConfiguration.tenantId),this.registryTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.registryTelemetry.setClientType(this.accountConfiguration.clientType));const t=rn;this.telemetryLoggers.signaling.sendEvent({eventName:t,props:this.registryTelemetry.getEvent(null,e)})}async dispose(e=Te()){const t=this.logger.createFnLogger("dispose",e);if(t.info("dispose"),this.isDisposing)return t.warn("call registry is already in disposing stage!"),this._disposedPromise.promise;this.isDisposing=!0;const i=()=>{this.calls=[],this.event("disposed").raise(),super.dispose(),this._disposedPromise.resolve()},n=this.calls.map((e=>e.stop())),r=()=>this.logout();return this.clearCallSubscription(),this.signalingAgentProvider.getSignalingAgent().resetAuthTokenManager(),Promise.all(n).then(r,r).then(i,i),this._disposedPromise.promise}get disposePromise(){return this._disposedPromise.promise}createCallAsync(e){const t=this.logger.createFnLogger("createCallAsync",e.causeId),i=`callId:${e.callId}, localParticipantId: ${we(e.localParticipantId)},\n            causeId:${e.causeId}, type:${e.type}, `;switch(e.type){case"MeetingData":i.concat(`meetingUrl:${!!e.meetingData?.meetingUrl}, meetingCode:${!!e.meetingData?.meetingCode}`);break;case"GroupId":i.concat(`groupId:${we(e.groupId)}`);break;case"ThreadId":i.concat(`threadId:${Me(e.threadId)}, messageId:${e.messageId}`);break;default:throw new Error("Invalid type in passing parameter.")}t.info(i);const n=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers,r=this._getCurrentCall(e,t);if(r){if(6===r.state){const e=vi();return this._disconnectingPromiseDefers.set(r.callId,e),e.promise}return Promise.resolve(r)}return Promise.resolve(this._createNewCall(e,n,t))}createCallWithMeetingData(e,t,i,n){const r=this.logger.createFnLogger("createCallWithMeetingData",n);if(r.info(`meetingData:${Le(e)}, callId:${t}, localParticipantId: ${we(i)}`),!e)return r.info("meetingData cannot be null"),null;const s=this._generateCreateCallOptions(n,t,i,null,null,null,e),a=this._getCurrentCall(s,r);if(a)return a;const o=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(s,o,r)}createCall(e,t,i,n,r=Te()){return this._createCall(e,t,i,n,r)}createCallWithGroupId(e,t,i,n){return this._createCall("",t,i,void 0,n,e)}_createNewCall(e,t,i){let n=null,r=null,s=null,a=null;switch(e.type){case"MeetingData":a=e.meetingData;break;case"GroupId":n=e.groupId;break;case"ThreadId":r=e.threadId,s=e.messageId}const o=new Vm(this.signalingAgentProvider.getSignalingAgent(),this.mediaAgent,new Qt(this.callingLogger),t,this.skypeIdentity,n,r,e.callId,e.localParticipantId,this.ecsProvider,this.trouterService,this.accountConfiguration,s,this.locationInfoContent,this.networkInfoContent,a,this.areaContent);o.on("callStateChanged",(async()=>{if(7===o.state&&this._createNewCallInDisconnectedState){const n=this._disconnectingPromiseDefers.get(o.callId);n&&(this._disconnectingPromiseDefers.delete(o.callId),n.resolve(this._createNewCall(e,t,i))),this._invokeDeleteCallInDisconnectedState&&setTimeout((()=>{this.deleteCall(o)}),0)}})),this.calls.push(o),this.event("callAdded").raise(o),this.raiseChanged(),i.info(`creating new call, ${o.callId}, ${Le(a)}, ${Le(o.meetingData)}`);const c=o.on("replacementRequested",(e=>{this.incomingCallMessageHandler.handleMessage(e)}));return this.addCallSubscriptionToMap(o,c),o}_getCurrentCall(e,t){let i=null;return"MeetingData"===e.type&&(i=this.getCallUsingMeetingData(e.meetingData,e.callId,e.localParticipantId,void 0,void 0,e.causeId),i)?(t.info("Call Registry has an entry for this call's meeting data"),i):(i=this.getCall(e.callId,e.localParticipantId,e.causeId),i?(t.info("Call Registry has an entry for this callId, participantId"),i):"ThreadId"===e.type&&(i=this.getCallUsingThreadIdMessageId(e.threadId,e.callId,e.messageId,e.causeId),i)?(t.info("Call Registry has an entry for this threadId, messageId"),i):"GroupId"===e.type&&(i=this.calls.find((t=>t.groupId===e.groupId)),i)?(t.info("Call Registry has an entry for this groupId"),i):i)}_generateCreateCallOptions(e,t,i,n,r,s,a){let o=null;return o=n?{type:"GroupId",callId:t,localParticipantId:i,causeId:e,groupId:n}:r?{type:"ThreadId",callId:t,localParticipantId:i,causeId:e,threadId:r,messageId:s}:{type:"MeetingData",callId:t,localParticipantId:i,causeId:e,meetingData:a},o}_createCall(e,t,i,n,r=Te(),s){const a=this.logger.createFnLogger("createCall",r);a.info(`threadId:${Me(e)}, callId:${t}, localParticipantId: ${we(i)}, messageId:${n}, groupId:${we(s)}`);const o=this._generateCreateCallOptions(r,t,i,s,e,n,null),c=this._getCurrentCall(o,a);if(c)return c;const l=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(o,l,a)}getCall(e,t,i=Te()){const n=this.logger.createFnLogger(`getCall[callId=${e}][participantId=${we(t)}]`,i);if(!e)return n.logFailure("callId is undefined"),null;const r=this.calls.find((t=>t.callId===e));return r&&n.info("Call Registry already has an entry for this call"),r}async deleteCallAsync(e){return Si((()=>this.deleteCall(e)))}deleteCall(e){const t=this.calls.indexOf(e);return-1!==t&&(this.callSubscriptionsMap.get(e).forEach((e=>{e.dispose()})),this.callSubscriptionsMap.delete(e),this.calls.splice(t,1),this.event("callRemoved").raise(e),this.raiseChanged(),!0)}async setConfiguration(e){this.accountConfiguration=e,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(e)}updateDisplayName(e){return this.skypeIdentity.displayName=e,this.calls.forEach((t=>{t.updateDisplayName(e)})),Promise.resolve()}fireIntent(e,t){return Promise.resolve()}getCallState(e,t){return Promise.reject("Not implemented")}getSetup(){}getEcsConfig(){return Promise.reject()}updateSkypeToken(e){this.logger.debug("CallRegistry.updateSkypeToken() called but not supported in the current set up.")}updateToken(e,t,i,n,r){this.logger.info(`[updateToken], causeId = ${n} tokenType = ${t.tokenType}, factorsJson = ${e}, tokenExpiredTime = ${r}`);try{return this.signalingAgentProvider.getSignalingAgent().updateToken(e,t,i,n,r),Promise.resolve({code:0})}catch(t){return this.logger.info(`Failed to update token with ${e}, error is ${t}`),Promise.reject(Vn(`Failed to update token with ${e}, error is ${t}`))}}onTokenRequired(e){const{requestMetadataJson:t,factorsJson:i,tokenType:n,invalidToken:r}=e;this.logger.info(`[onTokenRequired], tokenType ${n}, factorsJson ${i}, requestMetadataJson ${JSON.stringify(t)}`),this.event("tokenRequired").raise(i,n,t,r)}debugInformation(e){const t=e?`CallInformation\n * CallId=${e.callId}`:void 0;return Promise.resolve(t)}setLocationInfo(e,t,i=Te()){if(this.logger.info(`setLocationInfo, ${i}, infoType:${e}, contentJson ${t?"is set":"is undefined"}`),t)try{JSON.parse(t)}catch(e){return Promise.reject(`invalid contentJson: ${e}`)}return this.locationInfoType=e,1===this.locationInfoType&&(this.locationInfoContent=t,this.logger.info(`locationInfoContent set to ${this.locationInfoContent}`)),2===this.locationInfoType&&(this.networkInfoContent=t,this.logger.info(`networkInfoContent set to ${this.networkInfoContent}`)),3===this.locationInfoType&&(this.areaContent=t,this.logger.info(`areaContent set to ${this.areaContent}`)),this.event("locationInfoSet").raise(e,t),Promise.resolve()}createDownloader(){return null}async getUnassembledLocalRecordingSessions(e=Te()){return Promise.reject("Not implemented")}extendBrbFeedback(e,t){return Promise.reject("Not implemented")}proxyPushNotification(e){this.logger.info(`Proxying push notification with event ID ${e.eventId}`);try{const t={eventId:e.eventId,payload:Wm(e,this.logger,this._useExperimentalDecode)};this.event("proxiedPushNotification").raise(t)}catch(e){this.logger.error(`Error proxying push notification: ${e}`)}}logUploadNotification(e){this.logger.info(`Log upload notification with event ID ${e.eventId}`);try{const t={eventId:e.eventId,payload:Wm(e,this.logger,this._useExperimentalDecode)};this.event("logUploadNotification").raise(t)}catch(e){this.logger.error(`Error raising log upload notification: ${e}`)}}sendPush(e,t,i,n){const r={id:e},s=[];return t.forEach((e=>{s.push({id:e})})),this.signalingAgentProvider.getSignalingAgent().sendPushAsync(r,s,i,n)}enableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!1}disableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!0}getCallUsingThreadIdMessageId(e,t,i,n){this.logger.info(`[getCallUsingThreadIdMessageId][${n}] threadID: ${Me(e)} callId: ${t} messageId: ${i}`);let r=null;return e&&(r=this.calls.find((n=>n.threadId===e&&(t&&n.callId===t||i&&n.messageId===i))),r)?(this.logger.logFailure(`[getCallUsingThreadIdMessageId][${n}]Call Registry already has an entry for threadId: ${Me(r.threadId)}, callId: ${r.callId}, messageId: ${r.messageId}`),r):r}getCallUsingMeetingData(e,t,i,n,r,s=Te()){const a=this.logger.createFnLogger("getCallUsingMeetingData",s);if(a.info(`[callId=${t}][participantId=${we(i)}] meetingData: ${Le(e)} threadId: ${Me(n)} messageId: ${r}`),!t)return a.logFailure("callId is undefined"),null;let o;for(const i of this.calls){if(i.callId===t){o=i;break}if(vn(i.meetingData,e,s,this.logger)){o=i;break}}return o}stopCallsWithBeacon(){for(const e of this.calls)e.stopWithBeacon()}addCallSubscriptionToMap(e,t){this.callSubscriptionsMap.set(e,(this.callSubscriptionsMap.get(e)||[]).concat(t))}clearCallSubscription(){this.callSubscriptionsMap.forEach((e=>{e.forEach((e=>{e.dispose()}))})),this.callSubscriptionsMap.clear()}};function Wm(e,t,i=!1){const n=t.createFnLogger("decodeNotificationPayload");n.info(`useExperimentalDecode:${i}`);const r=i?Bm:atob;let s="{}";if(e?.body?.gp)n.info("using notification.body.gp"),s=r(e.body.gp);else if(e?.body?.cp){n.info("using notification.body.cp");const t=atob(e.body.cp);s=Hm.inflate(t,{to:"string"})}return s}S([Rn("Initialize",{enableInstantTelemetry:!0})],qm.prototype,"initialize",1),S([Rn("Logout",{enableInstantTelemetry:!0})],qm.prototype,"logout",1);var zm=p,Jm=class{constructor(e){this.deviceManager=e}get childDeviceManagers(){return this.deviceManager.getRegisteredDevices()}createPreview(e,t,i,n){return this.executeOnVirtualDeviceManager((n=>i(e,t,n)),n)}getRawDeviceMediaStream(e,t,i){return this.executeOnVirtualDeviceManager((i=>i.getRawDeviceMediaStream(e,t)),i)}setDeviceEffectsAsync(e,t){return this.executeOnVirtualDeviceManager((e=>e.setVideoEffects(t)),e)}setRawMediaStream(e,t,i){this.executeOnVirtualDeviceManager((i=>i.setRawMediaStream(e,t)),i)}unsetRawMediaStream(e,t){this.executeOnVirtualDeviceManager((t=>t.unsetRawMediaStream(e)),t)}getVirtualDevice(e){return this.childDeviceManagers.find((t=>t.id===e))}executeOnVirtualDeviceManager(e,t){return this.getVirtualDevice(t).getDeviceManagers().map((t=>e(t)))}},Km=class e extends We{constructor(e){super(),this._deviceManager=e,this.virtualDeviceAdapter=new Jm(this._deviceManager),e.on("onDevicesChanged",(e=>{const t=this._deviceManager.getDeviceDescriptions(e),i=this._mapDevices(t);this._raiseDevicesChanged(i)})),e.on("onSelectedDevicesChanged",(e=>this._raiseDevicesChanged())),e.on("onPermissionStateChanged",(()=>this.event("onPermissionStateChanged").raise())),e.on("onVideoEffectsEvent",((e,t)=>this.event("videoEffectsEvent").raise(e,t))),e.on("onVideoEffectApplied",(()=>this.event("videoEffectApplied").raise()))}get isAudioOutputSelectionSupported(){return this._deviceManager.isAudioOutputSelectionSupported}getPermissionState(e){return"camera"===e?this.getPermissionStateHelper(this._deviceManager.getPermissionState("camera")):"microphone"===e?this.getPermissionStateHelper(this._deviceManager.getPermissionState("microphone")):"unknown"}askDevicePermission(e){return this._deviceManager.askDevicePermission?this._deviceManager.askDevicePermission(e):Promise.resolve({audio:!0,video:!0})}enumerateDevicesAsync(){return this._deviceManager.enumerateDevicesAsync().then((e=>this._mapDevices(e)))}getPreferredCamera(){throw new Error("Not implemented")}selectDevices(e){if(Object.keys(e).some((e=>this.isVirtualDevice(e))))throw new Error("Virtual Device selection on DM is not supported");const t=(0,zm.assign)({},this._deviceManager.getSelectedDevices(),e);this._deviceManager.selectDevices(t)}selectDevicesAsync(e){return Si((()=>this.selectDevices(e)))}getSelectedDevices(){return this._deviceManager.getSelectedDevices()}getSelectedDevicesAsync(){return Si((()=>this.getSelectedDevices()))}getDeviceNameAsync(e){return this._deviceManager.getDeviceNameAsync(e)}getSpeakerDeviceDomIdAsync(e,t){return this._deviceManager.getSpeakerDeviceDomIdAsync(e)}async setDeviceEffectsAsync(e,t){if(!this.isVirtualDevice(e))return this._deviceManager.setVideoEffects(t);Promise.all(this.virtualDeviceAdapter.setDeviceEffectsAsync(e,t))}getDeviceEffectsCapabilityAsync(e,t){return this._deviceManager.effectsManager.getEffectsCapability("Video")}setBackgroundImageAsync(e,t,i){return this._deviceManager.effectsManager.configure("Video",{imagePath:t,headers:i})}getImagePropertyAsync(e){return Promise.reject(new Error("Not implemented"))}getMicrophoneGeometryArrayInfoAsync(e){return Promise.reject(new Error("Not implemented"))}transformImageAsync(e,t,i,n){return Promise.reject(new Error("Not implemented"))}setAudioProcessingFlags(e){return this._deviceManager.setAudioProcessingFlags(e)}sendMessageDeviceVideoEffectsAsync(e,t){return Promise.reject(new Error("Not implemented"))}sendMessageDeviceVideoExtensibilityAsync(e,t){return Promise.reject(new Error("Not implemented"))}setVideoCaptureConfigAsync(e,t){return Promise.reject(new Error("Not implemented"))}captureVideoFrameWithoutEffectsAsync(e,t,i){return Promise.reject(new Error("Not implemented"))}getSpeakerVolume(){return Promise.reject(new Error("Not implemented"))}getSpeakerSystemVolume(){return Promise.reject(new Error("Not implemented"))}setSpeakerVolume(e){return Promise.reject(new Error("Not implemented"))}setSpeakerSystemVolume(e){return Promise.reject(new Error("Not implemented"))}unmuteMicrophone(){return Promise.reject(new Error("Not implemented"))}unmuteSpeaker(){return Promise.reject(new Error("Not implemented"))}getNrgLevelsForDeviceTuner(e){return Promise.reject(new Error("Not implemented"))}setAudioEffectsAsync(e,t){return this._deviceManager.setAudioEffects(t)}getAudioFeatureCapability(e){return this._deviceManager.effectsManager.getEffectsCapability("Audio")}getMicrophoneVolume(){return Promise.reject(new Error("Not implemented"))}setMicrophoneVolume(e){return Promise.reject(new Error("Not implemented"))}setDeviceTelemetryData(e,t,i,n=0){return Promise.reject(new Error("Not implemented"))}getSourceFormats(e){return Promise.reject(new Error("Not implemented"))}enableShellSharing(){return Promise.reject(new Error("Not implemented"))}disableShellSharing(){return Promise.reject(new Error("Not implemeted"))}enableParticipantCameras(){return Promise.reject(new Error("Not implemeted"))}registerDerivedSource(e,t){return Promise.reject(new Error("Not implemeted"))}unregisterDerivedSource(e){return Promise.reject(new Error("Not implemeted"))}async createPreview(e,t,i){return"camera"===t.kind&&this.isVirtualDevice(t.device)?this.virtualDeviceAdapter.createPreview(e,i,this.getRenderer,t.device)[0]:"camera"===t.kind&&(0,zm.isUndefined)(t.device)?this.createPreviewRenderer(e,i):Promise.reject(new Error("Not yet supported"))}async createPreviewRenderer(e,t){return this.getRenderer(e,t,this._deviceManager)}createScreenSharingPreviewRenderer(e,t){return Promise.reject(new Error("Not yet supported"))}getRawDeviceMediaStream(e,t,i){const n=Ku(e);return this.isVirtualDevice(i)?this.virtualDeviceAdapter.getRawDeviceMediaStream(n,t,i)[0]:this._deviceManager.getRawDeviceMediaStream(n,t)}setRawMediaStream(e,t,i){const n=Ku(t);return this.isVirtualDevice(i)?this.virtualDeviceAdapter.setRawMediaStream(e,n,i):this._deviceManager.setRawMediaStream(e,n)}unsetRawMediaStream(e,t){const i=Ku(e);return this.isVirtualDevice(t)?this.virtualDeviceAdapter.unsetRawMediaStream(i,t):this._deviceManager.unsetRawMediaStream(i)}createAudioRenderer(){return this._deviceManager.createAudioRenderer()}startAudioLoopbackDevice(e){return Promise.reject(new Error("Not implemented"))}async dispose(e){return this._deviceManager.dispose(e)}async registerCompositeVideoDevice(e,t,i){return this._deviceManager.registerVirtualDevice(e,t,i)}async unregisterCompositeVideoDevice(e){return this._deviceManager.unregisterVirtualDevice(e)}async createAudioPlayer(){return Promise.reject(new Error("Not implemented"))}_raiseDevicesChanged(e){(e?Promise.resolve(e):this.enumerateDevicesAsync()).then((e=>{this.raiseChanged(),this.event("devicesChanged").raise(e)}))}getPermissionStateHelper(e){switch(e){case"granted":return"granted";case"denied":return"denied";case"prompt":return"prompt";default:return"unknown"}}_mapDevices(e){return e?.map((e=>this._mapDeviceDesc(e)))}_mapDeviceDesc(t){const i=e._mapDeviceType(t.kind);return 6===i?{id:t.id,label:t.label,kind:i,position:0,defaultVideoId:t.id,devicesIds:[]}:1===i?{id:t.id,browserId:t.browserId,label:t.label,kind:i,position:e._mapCameraPosition(t.position)}:4===i?{id:null,browserId:null,label:t.label,kind:i,formFactor:t.formFactor,isPcInternalDevice:t.isPcInternalDevice,microphoneId:t.microphoneId,speakerId:t.speakerId}:{id:t.id,browserId:"default_output_device"===t.browserId?"default":t.browserId,label:t.label,kind:i,isSystemDefault:!!t.isSystemDefault}}static _mapDeviceType(e){switch(e){case"camera":return 1;case"microphone":return 2;case"speaker":return 3;case"compositeAudio":return 4;case"virtualDevice":return 6;default:throw new Error(`Invalid device type '${e}'`)}}static _mapCameraPosition(e){switch(e){case"front":return 1;case"back":return 2;case"external":return 3;default:return 0}}isVirtualDevice(e){return e&&this._deviceManager.getRegisteredDevices().some((t=>t.id===e))}async getRenderer(e,t,i){const n=new Pg(e,i);try{await n.startVideoAsync(),t&&(n.setScalingMode(t.scalingMode),n.setVideoMirroring(!t.ignoreMirroring))}catch(e){throw n.dispose(),e}return n}},Ym=g,Qm=g,Xm=class extends Qm.AbstractLogAppender{constructor(e){super(new Qm.StandardLogFormatter(Qm.SLF_Flags.Component)),this._logger=e}log(e,t,i,n){if(!this._logger)return;const r=e.level<=Qm.LogLevel.Debug4?this._logger.debug:e.level<=Qm.LogLevel.Debug2?this._logger.log:e.level<=Qm.LogLevel.Debug1?this._logger.info:e.level<=Qm.LogLevel.Warning?this._logger.warn:this._logger.error;r&&r.apply(this._logger,[this.formatter().format(e,t,i,n)])}},Zm=g,ef=f(me()),tf=["CorrelationId","agent_environment_id","UserInfo_TenantId","participant_id","endpoint_id","mediaLegId","metrics_ConfigIds","ts_calling_version","uiVersion"],nf={video:[...tf,"Extensions_WebRTCStats_ssrc_video_recv_framesDecoded","Extensions_WebRTCStats_ssrc_video_recv_packetsReceived","Extensions_WebRTCStats_ssrc_video_recv_ssrc","Extensions_WebRTCStats_ssrc_video_recv_bytesReceived","Extensions_WebRTCStats_ssrc_video_recv_googFrameRateDecoded","Extensions_Video_SubscriptionEvents","Extensions_Video_recv_ResolutionDurations","Extensions_Video_recv_StreamsMax","Extensions_Video_recv_frameRateAvg","Extensions_Video_recv_DurationSeconds","Extensions_Video_recv_FreezeHistogram","Extensions_Video_recv_FreezeTimestamps","Extensions_WebRTCStats_ssrc_video_recv_keyFramesDecoded","Extensions_Video_recv_TotalFreezeDurationMs","Extensions_Video_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"],sharing:[...tf,"Extensions_WebRTCStats_ssrc_sharing_recv_framesDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_packetsReceived","Extensions_WebRTCStats_ssrc_sharing_recv_ssrc","Extensions_WebRTCStats_ssrc_sharing_recv_bytesReceived","Extensions_WebRTCStats_ssrc_sharing_recv_googFrameRateDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_keyFramesDecoded","Extensions_Sharing_SubscriptionEvents","Extensions_Sharing_recv_ResolutionDurations","Extensions_Sharing_recv_StreamsMax","Extensions_Sharing_recv_frameRateAvg","Extensions_Sharing_recv_DurationSeconds","Extensions_Sharing_recv_FreezeHistogram","Extensions_Sharing_recv_FreezeTimestamps","Extensions_Sharing_recv_TotalFreezeDurationMs","Extensions_Sharing_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"]},rf=class extends We{constructor(){super(...arguments),this.stabilizationTimeInAvg=2e4}send(e){e&&setTimeout((()=>{this.event("sendMidCallTelemetry").raise(nf[e])}),this.stabilizationTimeInAvg)}},sf=class extends We{constructor(e,t){super(),this._telemetryService=e,this._ecsProvider=t,this._ecsProvider.on("OnECSChanged",(()=>Zm.RootToolsManager.OnEcsChange()))}fetchEcsConfig(e,t){return ef.Resolved().then((()=>this._ecsProvider.getEcsConfig(e,t)))}sendTelemetry(e,t){this._telemetryService.getGenericTelemetryLogger&&e?this._telemetryService.getGenericTelemetryLogger(e).sendEvent({eventName:"rt_log",props:t}):this._telemetryService.sendEvents([{eventName:"rt_log",props:t}])}sendMidCallTelemetry(e){Object.keys(nf).includes(e)&&this.event("onMidCallTelemetry").raise(e)}};var af=p,of=class e{constructor(t){this._prefix=t,this._children=[],this._useConsoleLogger=!1,this.createChild=(t,i)=>{const n="function"==typeof t?"":t,r=new e((this._prefix||"")+n);return this._children.push(r),this._useConsoleLogger&&r.useConsoleLogger(),r},this.createFnLogger=(t,i,...n)=>{const r=`[${i}][${t}]`,s=new e((this._prefix||"")+r);return this._children.push(s),this._useConsoleLogger&&s.useConsoleLogger(),s}}logInfo(){}logFailure(){}logSuccess(){}log(...e){}debug(...e){}info(...e){}warn(...e){}error(...e){}useConsoleLogger(){this._useConsoleLogger=!0;const e=(...e)=>{console.info(this._prefix||"",...e)};this.log=e,this.debug=e,this.info=e,this.warn=e,this.error=e,(0,af.each)(this._children,(e=>e.useConsoleLogger()))}},cf=class{constructor(e){this.configProvider=e,this.window=Vp.window,this.updateCapabilityOverrides(),this.configProviderSub=e.on("configUpdated",(()=>this.updateCapabilityOverrides()))}get audio(){return this.getCapability("audio")}get video(){return this.getCapability("video")}get screensharing(){return this.getCapability("screensharing")}get retargeting(){return this.getCapability("retargeting")}dispose(){this.configProviderSub&&this.configProviderSub.dispose()}updateCapabilityOverrides(){let e;this.configProvider.config.capabilities&&(e=this.configProvider.config.capabilities),this.overrides=e||{}}hasMediaCapture(){return!!this.window.navigator.getUserMedia}getCapability(e){return void 0!==this.overrides[e]?!!this.overrides[e]:this.hasMediaCapture()&&this.hasWebRtc()}hasWebRtc(){return void 0!==this.window.RTCPeerConnection}},lf=class e extends ze{constructor(e,t){super(e),this.logger=e,this.configProvider=t,this.eventStates=new Map,this.swMuted=!1,this.logger.safe.info("Initialized")}signalEvent(e,t,i="Audio",n=!0,r=Te(),s,a){const o={type:e,value:t,isLocalSource:n,mediaType:i,deviceManagerId:s,diagnosticData:a},c=this.getEventKey(o),l=this.eventStates.get(c);(!l||l.value!==t||this.configProvider.config.alwaysRaiseBadDeviceEvents&&"Good"!==t)&&(l||"Good"!==t)&&(this.eventStates.set(c,o),this.shouldRaiseEvent(o,l)&&(this.logger.safe.info(`[${r}] Raising UFD ${e} for ${i}: ${t}`),this.event("onQualityChanged").raise(o)))}signalDeviceEvent(t,i,n,r){const s=e.getQualityEventType(t,n,this.configProvider);s?this.signalEvent(s,i,n,void 0,Te(),r):this.logger.warn(`Unknown device quality event type: ${t}`)}raisePendingWhitelistingUFD(){this.lastWhitelistingUFD&&(this.logger.safe.debug(`Raising whitelisting UFD ${this.lastWhitelistingUFD.type}: ${this.lastWhitelistingUFD.value}`),this.event("onQualityChanged").raise(this.lastWhitelistingUFD),this.cancelPendingWhitelistingUFD())}cancelPendingWhitelistingUFD(){if(this.lastWhitelistingUFD){const e=this.getEventKey(this.lastWhitelistingUFD);this.eventStates.delete(e)}this.lastWhitelistingUFD=void 0}setSwMute(e){if(this.swMuted=e,e){const e=this.eventStates.get(this.getEventKey({type:"DeviceSpeakWhileMuted",mediaType:"Audio"}));e&&"Good"!==e.value&&this.event("onQualityChanged").raise(e)}}applyCurrentState(e){this.cancelPendingWhitelistingUFD();let t=0;for(const i of this.eventStates.values())"Good"!==i.value&&(e(i),t++);t>0&&this.logger.safe.info(`Applied ${t} UFDs`)}reset(){this.logger.safe.info("Resetting UFD states");for(const[t,i]of this.eventStates.entries())e.persistent.has(i.type)||this.eventStates.delete(t);this.lastWhitelistingUFD=void 0,this.swMuted=!1}getEventKey(e){return`${e.type}:${e.mediaType}`}shouldRaiseEvent(t,i){return"NetworkRelaysNotReachable"===t.type?(this.lastWhitelistingUFD=t,!1):!(!("DeviceSpeakWhileMuted"!==t.type||this.swMuted||"Good"===t.value&&"Good"!==i?.value)||"NetworkRecvQuality"===t.type&&!this.configProvider.config.webrtcStatNetworkDetectionEnabled||this.configProvider.config.alwaysRaiseBadDeviceEvents&&!e.deviceQualityEvents.has(t.type)&&t.value===i?.value)}static getQualityEventType(e,t,i){switch(e){case 0:return"Audio"===t?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartFailed";case 1:return"Audio"===t?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartTimedOut";case 2:return"DeviceCaptureMute";case 3:switch(t){case"ScreenShare":return"ScreenshareRecordingDisabled";case"Audio":return i.config.enableSignalingAudioPermissionDeniedUFD?"AudioCapturePermissionDenied":"DeviceCaptureNotMuteButSilent";case"Video":return"VideoCapturePermissionDenied";default:return}default:return}}};lf.persistent=new Set(["ZeroCaptureDevicesEnumerated","ZeroRenderDevicesEnumerated"]),lf.deviceQualityEvents=new Set(["DeviceCaptureNotFunctioning","VideoCapturerDeviceStartFailed","DeviceCaptureNotFunctioning","VideoCapturerDeviceStartTimedOut","DeviceCaptureMute","ScreenshareRecordingDisabled","DeviceCaptureNotMuteButSilent","VideoCapturePermissionDenied"]);var df=lf,hf=p,uf=p,gf=p,pf={maxOutgoingResolution:({settings:e})=>vf(e),maxParticipantResolutions:({settings:e})=>Sf(e),maxIncomingStreams:({settings:e})=>Cf(e),maxSimulcastLayers:({settings:e})=>_f(e),outgoingVideoLimit:({settings:e,constraints:t})=>yf(e,t)},mf=(e,t,i)=>(e.info(`Converting settings to constraints and mapping, [requestedConstraints=${JSON.stringify(i)}], [settings=${JSON.stringify(t)}]`),ff((0,gf.cloneDeep)(i),(0,gf.cloneDeep)(t))),ff=(e,t)=>Object.keys(e).reduce(((i,n)=>{const r=pf[n]?pf[n]({constraints:e,settings:t}):void 0;return r&&(i[n]=r),i}),{}),Sf=e=>e.multiviewResolutionLimits,vf=e=>e.outgoingVideoLimit?.maxResolution,yf=(e,t)=>{const i=t?.outgoingVideoLimit;if(!i)return;const{outgoingVideoLimit:n={}}=ct(e);if("number"==typeof i)return n?.maxResolution;const r=Object.keys(i).reduce(((e,t)=>{const i=n?.[t];return i&&(e[t]=i),e}),{});return Object.keys(r).length?r:void 0},Cf=e=>e.numVideoChannelsGvc,_f=e=>{const t=e.specCompliantSimulcast,i=t.video?.layerScaleFactors,n=t.sharing?.layerScaleFactors,r=i?.length?Math.max(...i):1,s=n?.length?Math.max(...i):1;return Math.min(r,s)},Ef=p,Tf=e=>!!(0,Ef.isNumber)(e)||!!(e=>{const t=["maxResolution","maxBitrate","maxFramerate"],i=e=>t.includes(e),n=Object.entries(e);return 0!==n.length&&n.every((([e,t])=>(0,Ef.isNumber)(t)&&i(e)))})(e)&&!st(e),If={maxIncomingStreams:Ef.isNumber,maxSimulcastLayers:Ef.isNumber,maxOutgoingResolution:Ef.isNumber,maxParticipantResolutions:e=>!!et(e)&&(!!(0,Ef.isNumber)(e)||"more"in e&&Object.values(e).every((e=>(0,Ef.isNumber)(e)))),outgoingVideoLimit:e=>!!et(e)&&Tf(e),incomingVideoLimit:e=>!!et(e)&&(!!Tf(e)||"more"in e&&Object.values(e).every((e=>Tf(e))))},bf=(e,t)=>{for(const i in t){const n=e[i],r=t[i];e[i]="object"==typeof r?bf({...n},r):tt(n,r)}return e},Af=class{constructor(e,t,i,n,r,s,a){this.logger=e,this.defaultSettings=t,this._mediaConfig=i,this._userAgentConfig=n,this._countryCode=r,this.platformCallConstraintsProvider=s,this.currentCallConstraints=a,this.mergedConstraints={},this.callConstraintsTelemetry=[],this.iceTransportPolicy=Qe.ICE_TRANSPORT_POLICY.all,this.validIceTransportPolicies=[Qe.ICE_TRANSPORT_POLICY.all,Qe.ICE_TRANSPORT_POLICY.relay],this.mergeConstraintsTelemetryWithGlobal(),this.mergedConstraints=this.mergeConstraintsWithGlobal(this.currentCallConstraints),this.settings=this.mergeSettings((0,uf.cloneDeep)(this.defaultSettings))}get config(){return this.settings}get mediaConfig(){return this._mediaConfig}get userAgentConfig(){return this._userAgentConfig}get countryCode(){return this._countryCode}addCallConstraintsTelemetryEvent(e,t){const i={timestamp:(new Date).getTime(),type:t,value:e};Tt(this.callConstraintsTelemetry,i,this.config.numCallConstraintsEvents)}getCallConstraintsTelemetry(){return this.callConstraintsTelemetry}getCallConstraints(){return this.mergedConstraints}setCallConstraints(e={}){this.addCallConstraintsTelemetryEvent(e,"requested"),this.logger.safe.debug("Saving new call constraints",JSON.stringify(e));const t=this.transformConstraints((e=>(e=JSON.parse(JSON.stringify(e)),Object.entries(If).reduce(((t,[i,n])=>(n(e[i])&&(t[i]=e[i]),t)),{})))(e));return this.logger.safe.debug("Validated call constraints",JSON.stringify(t)),this.mergedConstraints=this.mergeConstraintsWithGlobal(t),this.settings=this.mergeSettings((0,uf.cloneDeep)(this.defaultSettings)),mf(this.logger,this.settings,t)}getIceTransportPolicy(){return this.settings.iceTransportPolicyForced||this.iceTransportPolicy}setIceTransportPolicy(e){this.validIceTransportPolicies.includes(e)?(this.logger.info(`Setting transport policy to ${this.iceTransportPolicy}`),this.iceTransportPolicy=e):this.logger.debug(`Unknown incoming transport policy, using ${this.iceTransportPolicy}`)}transformConstraints(e){const t=(0,uf.cloneDeep)(e);return"maxOutgoingResolution"in t&&(t.outgoingVideoLimit={maxResolution:t.maxOutgoingResolution},delete t.maxOutgoingResolution),"number"==typeof t.outgoingVideoLimit&&(t.outgoingVideoLimit={maxResolution:t.outgoingVideoLimit}),t}mergeConstraintsTelemetryWithGlobal(){this.platformCallConstraintsProvider.callConstraintsTelemetry.forEach((e=>Tt(this.callConstraintsTelemetry,e,this.defaultSettings.numCallConstraintsEvents)))}mergeConstraintsWithGlobal(e={}){const t=this.transformConstraints(this.platformCallConstraintsProvider.constraints);if(!Object.keys(t).length)return e;const i=(0,uf.cloneDeep)(e);return bf(i,t),this.logger.safe.debug(`Merging call constraints ${JSON.stringify(e)} and global constraints ${JSON.stringify(t)}. Result: ${JSON.stringify(i)}`),i}mergeSettings(e){if(!e.enablePlatformCallConstraints||!e.enablePlatformCallConstraintsPerCall)return e;const t=$t(this.logger,e,this.mergedConstraints);return this.logger.safe.info(`Merging settings with platform call constraints: ${Ve(t)}`),(0,uf.assign)({},e,t,UA)}},Rf="function",wf="object",Pf="undefined",Mf="prototype",Df="hasOwnProperty",Of=Object,kf=Of[Mf],Nf=Of.assign,Lf=Of.create,xf=Of.defineProperty,Uf=kf[Df],Ff=null;function Vf(e){void 0===e&&(e=!0);var t=!1===e?null:Ff;return t||(typeof globalThis!==Pf&&(t=globalThis),t||typeof self===Pf||(t=self),t||typeof window===Pf||(t=window),t||typeof i===Pf||(t=i),Ff=t),t}function Bf(e){throw new TypeError(e)}function Hf(e){if(Lf)return Lf(e);if(null==e)return{};var t=typeof e;function i(){}return t!==wf&&t!==Rf&&Bf("Object prototype may only be an Object:"+e),i[Mf]=e,new i}(Vf()||{}).Symbol,(Vf()||{}).Reflect;var $f,Gf=Nf||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])kf[Df].call(t,r)&&(e[r]=t[r]);return e},jf=function(e,t){return(jf=Of.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t[Df](i)&&(e[i]=t[i])})(e,t)};function qf(e,t){function i(){this.constructor=e}typeof t!==Rf&&null!==t&&Bf("Class extends value "+String(t)+" is not a constructor or null"),jf(e,t),e[Mf]=null===t?Hf(t):(i[Mf]=t[Mf],new i)}function Wf(e,t){for(var i=0,n=t.length,r=e.length;i<n;i++,r++)e[r]=t[i];return e}var zf="undefined",Jf="constructor",Kf="prototype",Yf="function",Qf="_dynInstFuncs",Xf="_isDynProxy",Zf="_dynClass",eS="_dynInstChk",tS=eS,iS="_dfOpts",nS="_unknown_",rS="__proto__",sS="_dyn"+rS,aS="__dynProto$Gbl",oS="_dynInstProto",cS="useBaseInst",lS="setInstFuncs",dS=Object,hS=dS.getPrototypeOf,uS=dS.getOwnPropertyNames;var gS=function(){var e;return typeof globalThis!==zf&&(e=globalThis),e||typeof self===zf||(e=self),e||typeof window===zf||(e=window),e||typeof i===zf||(e=i),e||{}}(),pS=gS[aS]||(gS[aS]={o:($f={},$f[lS]=!0,$f[cS]=!0,$f),n:1e3});function mS(e,t){return e&&dS[Kf].hasOwnProperty.call(e,t)}function fS(e){return e&&(e===dS[Kf]||e===Array[Kf])}function SS(e){return fS(e)||e===Function[Kf]}function vS(e){var t;if(e){if(hS)return hS(e);var i=e[rS]||e[Kf]||(e[Jf]?e[Jf][Kf]:null);t=e[sS]||i,mS(e,sS)||(delete e[oS],t=e[sS]=e[oS]||e[sS],e[oS]=i)}return t}function yS(e,t){var i=[];if(uS)i=uS(e);else for(var n in e)"string"==typeof n&&mS(e,n)&&i.push(n);if(i&&i.length>0)for(var r=0;r<i.length;r++)t(i[r])}function CS(e,t,i){return t!==Jf&&typeof e[t]===Yf&&(i||mS(e,t))}function _S(e){throw new TypeError("DynamicProto: "+e)}function ES(e,t){for(var i=e.length-1;i>=0;i--)if(e[i]===t)return!0;return!1}function TS(e,t,i,n,r){function s(e,t){var i=function(){return(function(e,t,i,n){var r=null;if(e&&mS(i,Zf)){var s=e[Qf]||{};if((r=(s[i[Zf]]||{})[t])||_S("Missing ["+t+"] "+Yf),!r[eS]&&!1!==s[tS]){for(var a=!mS(e,t),o=vS(e),c=[];a&&o&&!SS(o)&&!ES(c,o);){var l=o[t];if(l){a=l===n;break}c.push(o),o=vS(o)}try{a&&(e[t]=r),r[eS]=1}catch(e){s[tS]=!1}}}return r}(this,t,e,i)||function(e,t,i){var n=t[e];return n===i&&(n=vS(t)[e]),typeof n!==Yf&&_S("["+e+"] is not a "+Yf),n}(t,e,i)).apply(this,arguments)};return i[Xf]=1,i}if(!fS(e)){var a=i[Qf]=i[Qf]||{},o=a[t]=a[t]||{};!1!==a[tS]&&(a[tS]=!!r),yS(i,(function(t){CS(i,t,!1)&&i[t]!==n[t]&&(o[t]=i[t],delete i[t],(!mS(e,t)||e[t]&&!e[t][Xf])&&(e[t]=s(e,t)))}))}}function IS(e,t){return mS(e,Kf)?e.name||t||nS:((e||{})[Jf]||{}).name||t||nS}function bS(e,t,i,n){mS(e,Kf)||_S("theClass is an invalid class definition.");var r=e[Kf];(function(e,t){if(hS){for(var i=[],n=vS(t);n&&!SS(n)&&!ES(i,n);){if(n===e)return!0;i.push(n),n=vS(n)}return!1}return!0})(r,t)||_S("["+IS(e)+"] not in hierarchy of ["+IS(t)+"]");var s=null;mS(r,Zf)?s=r[Zf]:(s="_dynCls$"+IS(e,"_")+"$"+pS.n,pS.n++,r[Zf]=s);var a=bS[iS],o=!!a[cS];o&&n&&void 0!==n[cS]&&(o=!!n[cS]);var c=function(e){var t={};return yS(e,(function(i){!t[i]&&CS(e,i,!1)&&(t[i]=e[i])})),t}(t);i(t,function(e,t,i,n){function r(e,t,i){var r=t[i];if(r[Xf]&&n){var s=e[Qf]||{};!1!==s[tS]&&(r=(s[t[Zf]]||{})[i]||r)}return function(){return r.apply(e,arguments)}}var s={};yS(i,(function(e){s[e]=r(t,i,e)}));for(var a=vS(e),o=[];a&&!SS(a)&&!ES(o,a);)yS(a,(function(e){!s[e]&&CS(a,e,!hS)&&(s[e]=r(t,a,e))})),o.push(a),a=vS(a);return s}(r,t,c,o));var l=!!hS&&!!a[lS];l&&n&&(l=!!n[lS]),TS(r,s,t,c,!1!==l)}bS[iS]=pS.o;var AS="initialize",RS="name",wS="getNotifyMgr",PS="identifier",MS="push",DS="isInitialized",OS="config",kS="instrumentationKey",NS="logger",LS="length",xS="time",US="processNext",FS="getProcessTelContext",VS="addNotificationListener",BS="removeNotificationListener",HS="stopPollingInternalLogs",$S="onComplete",GS="getPlugin",jS="flush",qS="_extensions",WS="splice",zS="teardown",JS="messageId",KS="message",YS="isAsync",QS="_doTeardown",XS="update",ZS="getNext",ev="diagLog",tv="setNextPlugin",iv="createNew",nv="cookieCfg",rv="indexOf",sv="substring",av="userAgent",ov="split",cv="setEnabled",lv="substr",dv="nodeType",hv="apply",uv="replace",gv="enableDebugExceptions",pv="toLowerCase",mv="call",fv="type",Sv="handler",vv="listeners",yv="isChildEvt",Cv="getCtx",_v="setCtx",Ev="complete",Tv="traceId",Iv="spanId",bv="traceFlags",Av="",Rv="channels",wv="core",Pv="createPerfMgr",Mv="disabled",Dv="extensionConfig",Ov="processTelemetry",kv="priority",Nv="eventsSent",Lv="eventsDiscarded",xv="eventsSendRequest",Uv="perfEvent",Fv="errorToConsole",Vv="warnToConsole",Bv="getPerfMgr",Hv="toISOString",$v="endsWith",Gv="startsWith",jv="indexOf",qv="trim",Wv="toString",zv="__proto__",Jv="constructor",Kv=xf,Yv=Of.freeze,Qv=Of.keys,Xv=String[Mf],Zv=Xv[qv],ey=Xv[$v],ty=Xv[Gv],iy=Date[Mf][Hv],ny=Array.isArray,ry=kf[Wv],sy=Uf[Wv],ay=sy[mv](Of),oy=/-([a-z])/g,cy=/([^\w\d_$])/g,ly=/^(\d+[\w\d_$])/,dy=Object.getPrototypeOf;function hy(e){return void 0===e||typeof e===Pf}function uy(e){return null===e||hy(e)}function gy(e){return!uy(e)}function py(e,t){return!(!e||!Uf[mv](e,t))}function my(e){return!(!e||typeof e!==wf)}function fy(e){return!(!e||typeof e!==Rf)}function Sy(e){var t=e;return t&&Ty(t)&&(t=(t=(t=t[uv](oy,(function(e,t){return t.toUpperCase()})))[uv](cy,"_"))[uv](ly,(function(e,t){return"_"+t}))),t}function vy(e,t){if(e)for(var i in e)Uf[mv](e,i)&&t[mv](e,i,e[i])}function yy(e,t){var i=!1;return e&&t&&!(i=e===t)&&(i=ey?e[$v](t):function(e,t){var i=!1,n=t?t[LS]:0,r=e?e[LS]:0;if(n&&r&&r>=n&&!(i=e===t)){for(var s=r-1,a=n-1;a>=0;a--){if(e[s]!=t[a])return!1;s--}i=!0}return i}(e,t)),i}function Cy(e,t){var i=!1;return e&&t&&!(i=e===t)&&(i=ty?e[Gv](t):function(e,t){var i=!1,n=t?t[LS]:0;if(e&&n&&e[LS]>=n&&!(i=e===t)){for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;i=!0}return i}(e,t)),i}function _y(e,t){return!(!e||!t)&&-1!==e[rv](t)}var Ey=ny||function(e){return!(!e||"[object Array]"!==ry[mv](e))};function Ty(e){return"string"==typeof e}function Iy(e){return"number"==typeof e}function by(e){return"boolean"==typeof e}function Ay(e){var t=!1;if(e&&"object"==typeof e){var i=dy?dy(e):function(e){if(e){if(dy)return dy(e);var t=e[zv]||e[Mf]||e[Jv];if(t)return t}return null}(e);i?(i[Jv]&&Uf[mv](i,Jv)&&(i=i[Jv]),t=typeof i===Rf&&sy[mv](i)===ay):t=!0}return t}function Ry(e){if(e)return iy?e[Hv]():function(e){if(e&&e.getUTCFullYear){var t=function(e){var t=String(e);return 1===t[LS]&&(t="0"+t),t};return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}(e)}function wy(e,t,i){var n=e[LS];try{for(var r=0;r<n&&(!(r in e)||-1!==t[mv](i||e,e[r],r,e));r++);}catch(e){}}function Py(e,t,i){if(e){if(e[jv])return e[jv](t,i);var n=e[LS],r=i||0;try{for(var s=Math.max(r>=0?r:n-Math.abs(r),0);s<n;s++)if(s in e&&e[s]===t)return s}catch(e){}}return-1}function My(e){return e&&(e=Zv&&e[qv]?e[qv]():e[uv]?e[uv](/^\s+|(?=\s)\s+$/g,Av):e),e}var Dy=!{toString:null}.propertyIsEnumerable("toString"),Oy=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function ky(e){var t=typeof e;if(t===Rf||t===wf&&null!==e||Bf("objKeys called on non-object"),!Dy&&Qv)return Qv(e);var i=[];for(var n in e)e&&Uf[mv](e,n)&&i[MS](n);if(Dy)for(var r=Oy[LS],s=0;s<r;s++)e&&Uf[mv](e,Oy[s])&&i[MS](Oy[s]);return i}function Ny(e,t,i,n){if(Kv)try{var r={enumerable:!0,configurable:!0};return i&&(r.get=i),n&&(r.set=n),Kv(e,t,r),!0}catch(e){}return!1}function Ly(e){return Yv&&vy(e,(function(e,t){(Ey(t)||my(t))&&Yv(t)})),xy(e)}var xy=Yv||function(e){return e};function Uy(){var e=Date;return e.now?e.now():(new e).getTime()}function Fy(e){return function(e){return!(!e||"[object Error]"!==ry[mv](e))}(e)?e[RS]:Av}function Vy(e,t,i,n,r){var s=i;return e&&((s=e[t])===i||r&&!r(s)||n&&!n(i)||(s=i,e[t]=s)),s}function By(e,t,i){var n;return e?!(n=e[t])&&uy(n)&&(n=hy(i)?{}:i,e[t]=n):n=hy(i)?{}:i,n}function Hy(e,t){return uy(e)?t:e}function $y(e){return!!e}function Gy(e){throw new Error(e)}function jy(e,t,i,n,r){e&&t&&i&&(!1!==r||hy(e[t]))&&(e[t]=function(e,t){var i=null,n=null;return fy(e)?i=e:n=e,function(){var e=arguments;if(i&&(n=i()),n)return n[t][hv](n,e)}}(i,n))}function qy(e,t,i,n){return e&&t&&my(e)&&Ey(i)&&wy(i,(function(i){Ty(i)&&jy(e,i,t,i,n)})),e}function Wy(e){return e&&Nf&&(e=Of(Nf({},e))),e}function zy(e,t,i,n,r,s){var a=arguments,o=a[0]||{},c=a[LS],l=!1,d=1;for(c>0&&by(o)&&(l=o,o=a[d]||{},d++),my(o)||(o={});d<c;d++){var h=a[d],u=Ey(h),g=my(h);for(var p in h)if(u&&p in h||g&&Uf[mv](h,p)){var m=h[p],f=void 0;if(l&&m&&((f=Ey(m))||Ay(m))){var S=o[p];f?Ey(S)||(S=[]):Ay(S)||(S={}),m=zy(l,S,m)}void 0!==m&&(o[p]=m)}}return o}function Jy(e){var t={};return vy(e,(function(e,i){t[e]=i,t[i]=e})),Ly(t)}function Ky(e){var t={};return vy(e,(function(e,i){t[e]=i[1],t[i[0]]=i[1]})),Ly(t)}var Yy=Jy({Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5}),Qy="window",Xy="document",Zy="navigator",eC="location",tC="console",iC="performance",nC="JSON",rC="crypto",sC="msCrypto",aC="msie",oC="trident/",cC="XMLHttpRequest",lC=null,dC=null,hC=!1,uC=null,gC=null;function pC(e,t){var i=!1;if(e){try{if(!(i=t in e)){var n=e[Mf];n&&(i=t in n)}}catch(e){}if(!i)try{i=!hy((new e)[t])}catch(e){}}return i}function mC(e){var t=Vf();return t&&t[e]?t[e]:e===Qy&&fC()?window:null}function fC(){return Boolean(typeof window===wf&&window)}function SC(){return fC()?window:mC(Qy)}function vC(){return Boolean(typeof document===wf&&document)}function yC(){return vC()?document:mC(Xy)}function CC(){return Boolean(typeof navigator===wf&&navigator)}function _C(){return CC()?navigator:mC(Zy)}function EC(e){if(e&&hC){var t=mC("__mockLocation");if(t)return t}return typeof location===wf&&location?location:mC(eC)}function TC(){return Boolean(typeof JSON===wf&&JSON||null!==mC(nC))}function IC(){return TC()?JSON||mC(nC):null}function bC(){var e=_C();return!(!e||!e.product)&&"ReactNative"===e.product}function AC(){var e=_C();if(e&&(e[av]!==dC||null===lC)){var t=((dC=e[av])||Av)[pv]();lC=_y(t,aC)||_y(t,oC)}return lC}function RC(e){var t=Object[Mf].toString[mv](e),i=Av;return"[object Error]"===t?i="{ stack: '"+e.stack+"', message: '"+e.message+"', name: '"+e[RS]+"'":TC()&&(i=IC().stringify(e)),t+i}function wC(){return null===gC&&(gC=CC()&&Boolean(_C().sendBeacon)),gC}function PC(e){var t=!1;try{t=!!mC("fetch");var i=mC("Request");t&&e&&i&&(t=pC(i,"keepalive"))}catch(e){}return t}function MC(){var e=!1;try{e=!!mC(cC)}catch(e){}return e}var DC,OC=["eventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],kC=null;function NC(e,t){return function(){var i=arguments,n=LC(t);if(n){var r=n.listener;r&&r[e]&&r[e][hv](r,i)}}}function LC(e){var t=kC;return t||!0===e.disableDbgExt||(t=kC||function(){var e=mC("Microsoft");return e&&(kC=e.ApplicationInsights),kC}()),t?t.ChromeDbgExt:null}function xC(e){return e?'"'+e[uv](/\"/g,Av)+'"':Av}function UC(e,t){var i=typeof console!==Pf?console:mC(tC);if(i){var n="log";i[e]&&(n=e),fy(i[n])&&i[n](t)}}var FC=function(){function e(e,t,i,n){void 0===i&&(i=!1);var r=this;r[JS]=e,r[KS]=(i?"AI: ":"AI (Internal): ")+e;var s=Av;TC()&&(s=IC().stringify(n));var a=(t?" message:"+xC(t):Av)+(n?" props:"+xC(s):Av);r[KS]+=a}return e.dataType="MessageData",e}();function VC(e,t){return(e||{})[NS]||new BC(t)}var BC=function(){function e(t){this.identifier="DiagnosticLogger",this.queue=[];var i,n,r,s,a=0,o={};bS(e,this,(function(e){function c(t,i){if(!(a>=r)){var s=!0,c="AITR_"+i[JS];if(o[c]?s=!1:o[c]=!0,s&&(t<=n&&(e.queue[MS](i),a++,l(1===t?"error":"warn",i)),a===r)){var d="Internal events throttle limit per PageView reached for this app.",h=new FC(23,d,!1);e.queue[MS](h),1===t?e[Fv](d):e[Vv](d)}}}function l(e,i){var n=LC(t||{});n&&n[ev]&&n[ev](e,i)}(function(e){i=Hy(e.loggingLevelConsole,0),n=Hy(e.loggingLevelTelemetry,1),r=Hy(e.maxMessageLimit,25),s=Hy(e[gv],!1)})(t||{}),e.consoleLoggingLevel=function(){return i},e.telemetryLoggingLevel=function(){return n},e.maxInternalMessageLimit=function(){return r},e[gv]=function(){return s},e.throwInternal=function(t,n,r,a,d){void 0===d&&(d=!1);var h=new FC(n,r,d,a);if(s)throw RC(h);var u=1===t?Fv:Vv;if(hy(h[KS]))l("throw"+(1===t?"Critical":"Warning"),h);else{if(d){var g=+h[JS];!o[g]&&i>=t&&(e[u](h[KS]),o[g]=!0)}else i>=t&&e[u](h[KS]);c(t,h)}},e[Vv]=function(e){UC("warn",e),l("warning",e)},e[Fv]=function(e){UC("error",e),l("error",e)},e.resetInternalMessageCount=function(){a=0,o={}},e.logInternalMessage=c}))}return e.__ieDyn=1,e}();function HC(e){return e||new BC}function $C(e,t,i,n,r,s){void 0===s&&(s=!1),HC(e).throwInternal(t,i,n,r,s)}function GC(e,t){HC(e)[Vv](t)}var jC="ctx",qC="ParentContextKey",WC="ChildrenContextKey",zC=function(){function e(t,i,n){var r,s=this,a=!1;s.start=Uy(),s[RS]=t,s[YS]=n,s[yv]=function(){return!1},fy(i)&&(a=Ny(s,"payload",(function(){return!r&&fy(i)&&(r=i(),i=null),r}))),s[Cv]=function(t){return t?t===e[qC]||t===e[WC]?s[t]:(s[jC]||{})[t]:null},s[_v]=function(t,i){t&&(t===e[qC]?(s[t]||(s[yv]=function(){return!0}),s[t]=i):t===e[WC]?s[t]=i:(s[jC]=s[jC]||{})[t]=i)},s[Ev]=function(){var t=0,n=s[Cv](e[WC]);if(Ey(n))for(var r=0;r<n[LS];r++){var o=n[r];o&&(t+=o[xS])}s[xS]=Uy()-s.start,s.exTime=s[xS]-t,s[Ev]=function(){},!a&&fy(i)&&(s.payload=i())}}return e.ParentContextKey="parent",e.ChildrenContextKey="childEvts",e}(),JC=function(){function e(t){this.ctx={},bS(e,this,(function(e){e.create=function(e,t,i){return new zC(e,t,i)},e.fire=function(e){e&&(e[Ev](),t&&fy(t[Uv])&&t[Uv](e))},e[_v]=function(t,i){t&&((e[jC]=e[jC]||{})[t]=i)},e[Cv]=function(t){return(e[jC]||{})[t]}}))}return e.__ieDyn=1,e}(),KC="CoreUtils.doPerf";function YC(e,t,i,n,r){if(e){var s=e;if(s[Bv]&&(s=s[Bv]()),s){var a=void 0,o=s[Cv](KC);try{if(a=s.create(t(),n,r)){if(o&&a[_v]&&(a[_v](zC[qC],o),o[Cv]&&o[_v])){var c=o[Cv](zC[WC]);c||(c=[],o[_v](zC[WC],c)),c[MS](a)}return s[_v](KC,a),i(a)}}catch(e){a&&a[_v]&&a[_v]("exception",e)}finally{a&&s.fire(a),s[_v](KC,o)}}}return i()}var QC=4294967296,XC=4294967295,ZC=!1,e_=123456789,t_=987654321;function i_(){try{var e=2147483647&Uy();!function(e){e<0&&(e>>>=0),e_=123456789+e&XC,t_=987654321-e&XC,ZC=!0}((Math.random()*QC^e)+e)}catch(e){}}function n_(e){var t=0,i=mC(rC)||mC(sC);return i&&i.getRandomValues&&(t=i.getRandomValues(new Uint32Array(1))[0]&XC),0===t&&AC()&&(ZC||i_(),t=function(e){var t=((t_=36969*(65535&t_)+(t_>>16)&XC)<<16)+(65535&(e_=18e3*(65535&e_)+(e_>>16)&XC))>>>0&XC;return e||(t>>>=0),t}()&XC),0===t&&(t=Math.floor(QC*Math.random()|0)),e||(t>>>=0),t}function r_(e){void 0===e&&(e=22);for(var t=n_()>>>0,i=0,n=Av;n[LS]<e;)i++,n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&t),t>>>=6,5===i&&(t=(n_()<<2&4294967295|3&t)>>>0,i=0);return n}var s_=xf,a_="2.8.10",o_="."+r_(6),c_=0;function l_(e){return 1===e[dv]||9===e[dv]||!+e[dv]}function d_(e,t){var i=t[e.id];if(!i){i={};try{l_(t)&&(function(e,t,i){if(s_)try{return s_(e,t,{value:i,enumerable:!1,configurable:!0}),!0}catch(e){}return!1}(t,e.id,i)||(t[e.id]=i))}catch(e){}}return i}function h_(e,t){return void 0===t&&(t=!1),Sy(e+c_+++(t?"."+a_:Av)+o_)}function u_(e){var t={id:h_("_aiData-"+(e||Av)+"."+a_),accept:function(e){return l_(e)},get:function(e,i,n,r){var s=e[t.id];return s?s[Sy(i)]:(r&&((s=d_(t,e))[Sy(i)]=n),n)},kill:function(e,t){if(e&&e[t])try{delete e[t]}catch(e){}}};return t}var g_="toGMTString",p_="toUTCString",m_="cookie",f_="expires",S_="enabled",v_="isCookieUseDisabled",y_="disableCookiesUsage",C_="_ckMgr",__=null,E_=null,T_=null,I_=yC(),b_={},A_={};function R_(e){return!e||e.isEnabled()}function w_(e,t){return!!(t&&e&&Ey(e.ignoreCookies))&&-1!==e.ignoreCookies[rv](t)}function P_(e,t){var i;if(e)i=e.getCookieMgr();else if(t){var n=t[nv];i=n[C_]?n[C_]:M_(t)}return i||(i=function(e,t){var i=M_[C_]||A_[C_];return i||(i=M_[C_]=M_(e,t),A_[C_]=i),i}(t,(e||{})[NS])),i}function M_(e,t){var i,n=function(e){var t=e[nv]=e[nv]||{};if(Vy(t,"domain",e.cookieDomain,gy,uy),Vy(t,"path",e.cookiePath||"/",null,uy),uy(t[S_])){var i=void 0;hy(e[v_])||(i=!e[v_]),hy(e[y_])||(i=!e[y_]),t[S_]=i}return t}(e||A_),r=n.path||"/",s=n.domain,a=!1!==n[S_],o=((i={isEnabled:function(){var e=a&&D_(t),i=A_[C_];return e&&i&&o!==i&&(e=R_(i)),e}})[cv]=function(e){a=!1!==e},i.set=function(e,t,i,a,c){var l=!1;if(R_(o)&&!function(e,t){return!!(t&&e&&Ey(e.blockedCookies)&&-1!==e.blockedCookies[rv](t))||w_(e,t)}(n,e)){var d={},h=My(t||Av),u=h[rv](";");if(-1!==u&&(h=My(t[sv](0,u)),d=O_(t[sv](u+1))),Vy(d,"domain",a||s,$y,hy),!uy(i)){var g=AC();if(hy(d[f_])){var p=Uy()+1e3*i;if(p>0){var m=new Date;m.setTime(p),Vy(d,f_,k_(m,g?g_:p_)||k_(m,g?g_:p_)||Av,$y)}}g||Vy(d,"max-age",Av+i,null,hy)}var f=EC();f&&"https:"===f.protocol&&(Vy(d,"secure",null,null,hy),null===E_&&(E_=!function(e){return!(!Ty(e)||!_y(e,"CPU iPhone OS 12")&&!_y(e,"iPad; CPU OS 12")&&!(_y(e,"Macintosh; Intel Mac OS X 10_14")&&_y(e,"Version/")&&_y(e,"Safari"))&&(!_y(e,"Macintosh; Intel Mac OS X 10_14")||!yy(e,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))&&!_y(e,"Chrome/5")&&!_y(e,"Chrome/6")&&(!_y(e,"UnrealEngine")||_y(e,"Chrome"))&&!_y(e,"UCBrowser/12")&&!_y(e,"UCBrowser/11"))}((_C()||{})[av])),E_&&Vy(d,"SameSite","None",null,hy)),Vy(d,"path",c||r,null,hy),(n.setCookie||x_)(e,N_(h,d)),l=!0}return l},i.get=function(e){var t=Av;return R_(o)&&!w_(n,e)&&(t=(n.getCookie||L_)(e)),t},i.del=function(e,t){var i=!1;return R_(o)&&(i=o.purge(e,t)),i},i.purge=function(e,i){var r,s=!1;if(D_(t)){var a=((r={}).path=i||"/",r[f_]="Thu, 01 Jan 1970 00:00:01 GMT",r);AC()||(a["max-age"]="0"),(n.delCookie||x_)(e,N_(Av,a)),s=!0}return s},i);return o[C_]=o,o}function D_(e){if(null===__){__=!1;try{__=void 0!==(I_||{})[m_]}catch(t){$C(e,2,68,"Cannot access document.cookie - "+Fy(t),{exception:RC(t)})}}return __}function O_(e){var t={};return e&&e[LS]&&wy(My(e)[ov](";"),(function(e){if(e=My(e||Av)){var i=e[rv]("=");-1===i?t[e]=null:t[My(e[sv](0,i))]=My(e[sv](i+1))}})),t}function k_(e,t){return fy(e[t])?e[t]():null}function N_(e,t){var i=e||Av;return vy(t,(function(e,t){i+="; "+e+(uy(t)?Av:"="+t)})),i}function L_(e){var t=Av;if(I_){var i=I_[m_]||Av;T_!==i&&(b_=O_(i),T_=i),t=My(b_[e]||Av)}return t}function x_(e,t){I_&&(I_[m_]=e+"="+t)}var U_="on",F_="attachEvent",V_="addEventListener",B_="detachEvent",H_="removeEventListener",$_="events",G_="visibilitychange",j_="pagehide",q_="pageshow",W_="unload",z_="beforeunload",J_=h_("aiEvtPageHide"),K_=h_("aiEvtPageShow"),Y_=/\.[\.]+/g,Q_=/[\.]+$/,X_=1,Z_=u_("events"),eE=/^([^.]*)(?:\.(.+)|)/;function tE(e){return e&&e[uv]?e[uv](/^[\s\.]+|(?=[\s\.])[\.\s]+$/g,Av):e}function iE(e,t){var i;if(t){var n=Av;Ey(t)?(n=Av,wy(t,(function(e){(e=tE(e))&&("."!==e[0]&&(e="."+e),n+=e)}))):n=tE(t),n&&("."!==n[0]&&(n="."+n),e=(e||Av)+n)}var r=eE.exec(e||Av)||[];return(i={})[fv]=r[1],i.ns=(r[2]||Av).replace(Y_,".").replace(Q_,Av)[ov](".").sort().join("."),i}function nE(e,t,i){void 0===i&&(i=!0);var n=Z_.get(e,$_,{},i),r=n[t];return r||(r=n[t]=[]),r}function rE(e,t,i,n){e&&t&&t[fv]&&(e[H_]?e[H_](t[fv],i,n):e[B_]&&e[B_](U_+t[fv],i))}function sE(e,t,i,n){for(var r=t[LS];r--;){var s=t[r];s&&(i.ns&&i.ns!==s.evtName.ns||n&&!n(s)||(rE(e,s.evtName,s[Sv],s.capture),t[WS](r,1)))}}function aE(e,t){return t?iE("xx",Ey(t)?[e].concat(t):[e,t]).ns[ov]("."):e}function oE(e,t,i,n,r){var s;void 0===r&&(r=!1);var a=!1;if(e)try{var o=iE(t,n);if((a=function(e,t,i,n){var r=!1;return e&&t&&t[fv]&&i&&(e[V_]?(e[V_](t[fv],i,n),r=!0):e[F_]&&(e[F_](U_+t[fv],i),r=!0)),r}(e,o,i,r))&&Z_.accept(e)){var c=((s={guid:X_++,evtName:o})[Sv]=i,s.capture=r,s);nE(e,o.type)[MS](c)}}catch(e){}return a}function cE(e,t,i,n,r){if(void 0===r&&(r=!1),e)try{var s=iE(t,n),a=!1;(function(e,t,i){if(t[fv])sE(e,nE(e,t[fv]),t,i);else{var n=Z_.get(e,$_,{});vy(n,(function(n,r){sE(e,r,t,i)})),0===ky(n)[LS]&&Z_.kill(e,$_)}})(e,s,(function(e){return!((!s.ns||i)&&e[Sv]!==i||(a=!0,0))})),a||rE(e,s,i,r)}catch(e){}}function lE(e,t,i,n){var r=!1;return t&&e&&e[LS]>0&&wy(e,(function(e){e&&(i&&-1!==Py(i,e)||(r=function(e,t,i){var n=!1,r=SC();r&&(n=oE(r,e,t,i),n=oE(r.body,e,t,i)||n);var s=yC();return s&&(n=oE(s,e,t,i)||n),n}(e,t,n)||r))})),r}function dE(e,t,i){e&&Ey(e)&&wy(e,(function(e){e&&function(e,t,i){var n=SC();n&&(cE(n,e,t,i),cE(n.body,e,t,i));var r=yC();r&&cE(r,e,t,i)}(e,t,i)}))}function hE(e,t,i){return function(e,t,i,n){var r=!1;return t&&e&&Ey(e)&&!(r=lE(e,t,i,n))&&i&&i[LS]>0&&(r=lE(e,t,null,n)),r}([z_,W_,j_],e,t,i)}function uE(e,t,i){var n=aE(J_,i),r=lE([j_],e,t,n);return t&&-1!==Py(t,G_)||(r=lE([G_],(function(t){var i=yC();e&&i&&"hidden"===i.visibilityState&&e(t)}),t,n)||r),!r&&t&&(r=uE(e,null,i)),r}function gE(e,t,i){var n=aE(K_,i),r=lE([q_],e,t,n);return!(r=lE([G_],(function(t){var i=yC();e&&i&&"visible"===i.visibilityState&&e(t)}),t,n)||r)&&t&&(r=gE(e,null,i)),r}function pE(){var e=mE();return e[sv](0,8)+"-"+e[sv](8,12)+"-"+e[sv](12,16)+"-"+e[sv](16,20)+"-"+e[sv](20)}function mE(){for(var e,t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i=Av,n=0;n<4;n++)i+=t[15&(e=n_())]+t[e>>4&15]+t[e>>8&15]+t[e>>12&15]+t[e>>16&15]+t[e>>20&15]+t[e>>24&15]+t[e>>28&15];var r=t[8+(3&n_())|0];return i[lv](0,8)+i[lv](9,4)+"4"+i[lv](13,3)+r+i[lv](16,3)+i[lv](19,12)}var fE="00000000000000000000000000000000",SE="0000000000000000";function vE(e,t,i){return!(!e||e[LS]!==t||e===i||!e.match(/^[\da-f]*$/))}function yE(e){return vE(e,32,fE)}function CE(e){return vE(e,16,SE)}var _E=u_("plugin");function EE(e){return _E.get(e,"state",{},!0)}function TE(e,t){for(var i,n=[],r=null,s=e[ZS]();s;){var a=s[GS]();a&&(r&&fy(r[tv])&&fy(a[Ov])&&r[tv](a),(fy(a[DS])?a[DS]():(i=EE(a))[DS])||n[MS](a),r=a,s=s[ZS]())}wy(n,(function(n){var r=e[wv]();n[AS](e.getCfg(),r,t,e[ZS]()),i=EE(n),n[wv]||i[wv]||(i[wv]=r),i[DS]=!0,delete i[zS]}))}function IE(e){return e.sort((function(e,t){var i=0;if(t){var n=fy(t[Ov]);fy(e[Ov])?i=n?e[kv]-t[kv]:1:n&&(i=-1)}else i=e?1:-1;return i}))}var bE="TelemetryPluginChain",AE="_hasRun",RE="_getTelCtx",wE=0;function PE(e,t,i,n){var r=null,s=[];null!==n&&(r=n?function(e,t,i){for(;e;){if(e[GS]()===i)return e;e=e[ZS]()}return kE([i],t[OS]||{},t)}(e,i,n):e);var a={_next:function(){var e=r;if(r=e?e[ZS]():null,!e){var t=s;t&&t[LS]>0&&(wy(t,(function(e){try{e.func[mv](e.self,e.args)}catch(e){$C(i[NS],2,73,"Unexpected Exception during onComplete - "+RC(e))}})),s=[])}return e},ctx:{core:function(){return i},diagLog:function(){return VC(i,t)},getCfg:function(){return t},getExtCfg:o,getConfig:function(e,i,n){var r;void 0===n&&(n=!1);var s=o(e,null);return s&&!uy(s[i])?r=s[i]:t&&!uy(t[i])&&(r=t[i]),uy(r)?n:r},hasNext:function(){return!!r},getNext:function(){return r},setNext:function(e){r=e},iterate:function(e){for(var t;t=a._next();){var i=t[GS]();i&&e(i)}},onComplete:function(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];e&&s[MS]({func:e,self:hy(t)?a.ctx:t,args:i})}}};function o(e,i,n){var r;if(void 0===i&&(i={}),void 0===n&&(n=0),t){var s=t[Dv];s&&e&&(r=s[e])}if(r){if(my(i)&&0!==n){var a=zy(!0,i,r);t&&2===n&&vy(i,(function(e){if(uy(a[e])){var i=t[e];uy(i)||(a[e]=i)}})),r=a}}else r=i;return r}return a}function ME(e,t,i,n){var r=PE(e,t,i,n),s=r.ctx;return s[US]=function(e){var t=r._next();return t&&t[Ov](e,s),!t},s[iv]=function(e,n){return void 0===e&&(e=null),Ey(e)&&(e=kE(e,t,i,n)),ME(e||s[ZS](),t,i,n)},s}function DE(e,t,i){var n=t[OS]||{},r=PE(e,n,t,i),s=r.ctx;return s[US]=function(e){var t=r._next();return t&&t.unload(s,e),!t},s[iv]=function(e,i){return void 0===e&&(e=null),Ey(e)&&(e=kE(e,n,t,i)),DE(e||s[ZS](),t,i)},s}function OE(e,t,i){var n=t[OS]||{},r=PE(e,n,t,i).ctx;return r[US]=function(e){return r.iterate((function(t){fy(t[XS])&&t[XS](r,e)}))},r[iv]=function(e,i){return void 0===e&&(e=null),Ey(e)&&(e=kE(e,n,t,i)),OE(e||r[ZS](),t,i)},r}function kE(e,t,i,n){var r=null,s=!n;if(Ey(e)&&e[LS]>0){var a=null;wy(e,(function(e){if(s||n!==e||(s=!0),s&&e&&fy(e[Ov])){var o=function(e,t,i){var n,r=null,s=fy(e[Ov]),a=fy(e[tv]),o={getPlugin:function(){return e},getNext:function(){return r},processTelemetry:d,unload:h,update:u,_id:n=e?e[PS]+"-"+e[kv]+"-"+wE++:"Unknown-0-"+wE++,_setNext:function(e){r=e}};function c(){var n;return e&&fy(e[RE])&&(n=e[RE]()),n||(n=ME(o,t,i)),n}function l(t,i,s,a,o){var c=!1,l=e?e[PS]:bE,d=t[AE];return d||(d=t[AE]={}),t.setNext(r),e&&YC(t[wv](),(function(){return l+":"+s}),(function(){d[n]=!0;try{var e=r?r._id:Av;e&&(d[e]=!1),c=i(t)}catch(e){var a=!r||d[r._id];a&&(c=!0),r&&a||$C(t[ev](),1,73,"Plugin ["+l+"] failed during "+s+" - "+RC(e)+", run flags: "+RC(d))}}),a,o),c}function d(t,i){function n(i){if(!e||!s)return!1;var n=EE(e);return!n[zS]&&!n[Mv]&&(a&&e[tv](r),e[Ov](t,i),!0)}l(i=i||c(),n,"processTelemetry",(function(){return{item:t}}),!t.sync)||i[US](t)}function h(t,i){function n(){var n=!1;if(e){var r=EE(e),s=e[wv]||r[wv];!e||s&&s!==t.core()||r[zS]||(r[wv]=null,r[zS]=!0,r[DS]=!1,e[zS]&&!0===e[zS](t,i)&&(n=!0))}return n}l(t,n,"unload",(function(){}),i[YS])||t[US](i)}function u(t,i){function n(){var n=!1;if(e){var r=EE(e),s=e[wv]||r[wv];!e||s&&s!==t.core()||r[zS]||e[XS]&&!0===e[XS](t,i)&&(n=!0)}return n}l(t,n,"update",(function(){}),!1)||t[US](i)}return xy(o)}(e,t,i);r||(r=o),a&&a._setNext(o),a=o}}))}return n&&!r?kE([n],t,i):r}var NE=function(e,t,i,n){var r=ME(e,t,i,n);qy(this,r,ky(r))},LE=500,xE="Channel has invalid priority - ";function UE(e,t,i){t&&Ey(t)&&t[LS]>0&&(wy(t=t.sort((function(e,t){return e[kv]-t[kv]})),(function(e){e[kv]<LE&&Gy(xE+e[PS])})),e[MS]({queue:xy(t),chain:kE(t,i[OS],i)}))}function FE(){var e=[];return{add:function(t){t&&e[MS](t)},run:function(t,i){wy(e,(function(e){try{e(t,i)}catch(e){$C(t[ev](),2,73,"Unexpected error calling unload handler - "+RC(e))}})),e=[]}}}var VE="getPlugin",BE=function(){function e(){var t,i,n,r,s,a=this;function o(e){void 0===e&&(e=null);var t=e;if(!t){var r=i||ME(null,{},a[wv]);t=n&&n[VE]?r[iv](null,n[VE]):r[iv](null,n)}return t}function c(e,t,r){e&&Vy(e,Dv,[],null,uy),!r&&t&&(r=t[FS]()[ZS]());var s=n;n&&n[VE]&&(s=n[VE]()),a[wv]=t,i=ME(r,e,t,s)}function l(){t=!1,a[wv]=null,i=null,n=null,s=[],r=FE()}l(),bS(e,a,(function(e){e[AS]=function(e,i,n,r){c(e,i,r),t=!0},e[zS]=function(t,i){var a,o=e[wv];if(o&&(!t||o===t[wv]())){var c,d=!1,h=t||DE(null,o,n&&n[VE]?n[VE]():n),u=i||((a={reason:0})[YS]=!1,a);return e[QS]&&!0===e[QS](h,u,g)?c=!0:g(),c}function g(){if(!d){d=!0,r.run(h,i);var e=s;s=[],wy(e,(function(e){e.rm()})),!0===c&&h[US](u),l()}}},e[XS]=function(t,i){var r=e[wv];if(r&&(!t||r===t[wv]())){var s,a=!1,o=t||OE(null,r,n&&n[VE]?n[VE]():n),l=i||{reason:0};return e._doUpdate&&!0===e._doUpdate(o,l,d)?s=!0:d(),s}function d(){a||(a=!0,c(o.getCfg(),o.core(),o[ZS]()))}},e._addHook=function(e){e&&(Ey(e)?s=s.concat(e):s[MS](e))},jy(e,"_addUnloadCb",(function(){return r}),"add")})),a[ev]=function(e){return o(e)[ev]()},a[DS]=function(){return t},a.setInitialized=function(e){t=e},a[tv]=function(e){n=e},a[US]=function(e,t){t?t[US](e):n&&fy(n[Ov])&&n[Ov](e,null)},a._getTelCtx=o}return e.__ieDyn=1,e}(),HE=function(e){function t(){var i,n,r=e.call(this)||this;function s(){i=0,n=[]}return r.identifier="TelemetryInitializerPlugin",r.priority=199,s(),bS(t,r,(function(e,t){e.addTelemetryInitializer=function(e){var t={id:i++,fn:e};return n[MS](t),{remove:function(){wy(n,(function(e,i){if(e.id===t.id)return n[WS](i,1),-1}))}}},e[Ov]=function(t,i){for(var r=!1,s=n[LS],a=0;a<s;++a){var o=n[a];if(o)try{if(!1===o.fn[hv](null,[t])){r=!0;break}}catch(e){$C(i[ev](),1,64,"One of telemetry initializers failed, telemetry item will not be sent: "+Fy(e),{exception:RC(e)},!0)}}r||e[US](t,i)},e[QS]=function(){s()}})),r}return qf(t,e),t.__ieDyn=1,t}(BE),$E="Plugins must provide initialize method",GE="_notificationManager",jE="SDK is still unloading...",qE={loggingLevelConsole:1};function WE(e,t){return new JC(t)}function zE(e,t){var i=!1;return wy(t,(function(t){if(t===e)return i=!0,-1})),i}var JE=function(){function e(){var t,i,n,r,s,a,o,c,l,d,h,u,g,p,m,f,S,v,y,C,_=0;bS(e,this,(function(e){function E(){i=!1,t=zy(!0,{},qE),e[OS]=t,e[NS]=new BC(t),e[qS]=[],m=new HE,n=[],r=null,s=null,a=null,o=null,c=null,d=null,l=[],h=null,u=null,g=null,p=!1,f=null,S=h_("AIBaseCore",!0),v=FE(),C=null}function T(){return ME(A(),t,e)}function I(i){var n=function(e,t,i){var n,r=[],s={};return wy(i,(function(i){(uy(i)||uy(i[AS]))&&Gy($E);var n=i[kv],a=i[PS];i&&n&&(uy(s[n])?s[n]=a:GC(e,"Two extensions have same priority #"+n+" - "+s[n]+", "+a)),(!n||n<t)&&r[MS](i)})),(n={all:i})[wv]=r,n}(e[NS],LE,l);d=n[wv],c=null;var r=n.all;if(g=xy(function(e,t,i){var n=[];if(e&&wy(e,(function(e){return UE(n,e,i)})),t){var r=[];wy(t,(function(e){e[kv]>LE&&r[MS](e)})),UE(n,r,i)}return n}(u,r,e)),h){var s=Py(r,h);-1!==s&&r[WS](s,1),-1!==(s=Py(d,h))&&d[WS](s,1),h._setQueue(g)}else h=function(e,t){function i(){return ME(null,t[OS],t,null)}function n(e,t,i,n){var r=e?e[LS]+1:1;function s(){0==--r&&(n&&n(),n=null)}r>0&&wy(e,(function(e){if(e&&e.queue[LS]>0){var n=e.chain,a=t[iv](n);a[$S](s),i(a)}else r--})),s()}var r=!1;return{identifier:"ChannelControllerPlugin",priority:LE,initialize:function(t,i,n,s){r=!0,wy(e,(function(e){e&&e.queue[LS]>0&&TE(ME(e.chain,t,i),n)}))},isInitialized:function(){return r},processTelemetry:function(t,r){n(e,r||i(),(function(e){e[US](t)}),(function(){r[US](t)}))},update:function(t,i){var r=i||{reason:0};return n(e,t,(function(e){e[US](r)}),(function(){t[US](r)})),!0},pause:function(){n(e,i(),(function(e){e.iterate((function(e){e.pause&&e.pause()}))}),null)},resume:function(){n(e,i(),(function(e){e.iterate((function(e){e.resume&&e.resume()}))}),null)},teardown:function(t,i){var s=i||{reason:0,isAsync:!1};return n(e,t,(function(e){e[US](s)}),(function(){t[US](s),r=!1})),!0},getChannel:function(t){var i=null;return e&&e[LS]>0&&wy(e,(function(e){if(e&&e.queue[LS]>0&&(wy(e.queue,(function(e){if(e[PS]===t)return i=e,-1})),i))return-1})),i},flush:function(t,r,s,a){var o=1,c=!1,l=null;function d(){o--,c&&0===o&&(l&&(clearTimeout(l),l=null),r&&r(c),r=null)}return a=a||5e3,n(e,i(),(function(e){e.iterate((function(e){if(e[jS]){o++;var i=!1;e[jS](t,(function(){i=!0,d()}),s)||i||(t&&null==l?l=setTimeout((function(){l=null,d()}),a):d())}}))}),(function(){c=!0,d()})),!0},_setQueue:function(t){e=t}}}(g,e);r[MS](h),d[MS](h),e[qS]=IE(r),h[AS](t,e,r),TE(T(),r),e[qS]=xy(IE(d||[])).slice(),i&&function(t){var i=OE(A(),e);e._updateHook&&!0===e._updateHook(i,t)||i[US](t)}(i)}function b(t){var i,n=null,r=null;return wy(e[qS],(function(e){if(e[PS]===t&&e!==h&&e!==m)return r=e,-1})),!r&&h&&(r=h.getChannel(t)),r&&((i={plugin:r})[cv]=function(e){EE(r)[Mv]=!e},i.isEnabled=function(){var e=EE(r);return!e[zS]&&!e[Mv]},i.remove=function(e,t){var i;void 0===e&&(e=!0);var n=[r],s=((i={reason:1})[YS]=e,i);R(n,s,(function(e){e&&I({reason:32,removed:n}),t&&t(e)}))},n=i),n}function A(){if(!c){var i=(d||[]).slice();-1===Py(i,m)&&i[MS](m),c=kE(IE(i),t,e)}return c}function R(i,n,r){if(i&&i[LS]>0){var s=DE(kE(i,t,e),e);s[$S]((function(){var e=!1,t=[];wy(l,(function(n,r){zE(n,i)?e=!0:t[MS](n)})),l=t;var n=[];u&&(wy(u,(function(t,r){var s=[];wy(t,(function(t){zE(t,i)?e=!0:s[MS](t)})),n[MS](s)})),u=n),r&&r(e)})),s[US](n)}else r(!1)}function w(){var i=e[NS]?e[NS].queue:[];i&&(wy(i,(function(i){var n,r=((n={})[RS]=f||"InternalMessageId: "+i[JS],n.iKey=Hy(t[kS]),n.time=Ry(new Date),n.baseType=FC.dataType,n.baseData={message:i[KS]},n);e.track(r)})),i[LS]=0)}function P(e,t,i,n){return h?h[jS](e,t,i||6,n):(t&&t(!1),!0)}function M(){var e=Hy(t.disableDbgExt);!0===e&&y&&(r[BS](y),y=null),r&&!y&&!0!==e&&(y=function(e){if(!DC){DC={};for(var t=0;t<OC[LS];t++)DC[OC[t]]=NC(OC[t],e)}return DC}(t),r[VS](y))}function D(){var e=Hy(t.enablePerfMgr);!e&&a&&(a=null),e&&By(t,Pv,WE)}function O(t){var i=e[NS];i?$C(i,2,73,t):Gy(t)}E(),e[DS]=function(){return i},e[AS]=function(n,s,a,o){p&&Gy(jE),e[DS]()&&Gy("Core should not be initialized more than once"),t=n||{},e[OS]=t,uy(n[kS])&&Gy("Please provide instrumentation key"),r=o,e[GE]=o,M(),D(),By(t,Dv,{}).NotificationManager=r,a&&(e[NS]=a);var c=By(t,"extensions",[]);(l=[])[MS].apply(l,Wf(Wf([],s),c)),u=By(t,Rv,[]),I(null),g&&0!==g[LS]||Gy("No "+Rv+" available"),i=!0,e.releaseQueue()},e.getTransmissionControls=function(){var e=[];return g&&wy(g,(function(t){e[MS](t.queue)})),xy(e)},e.track=function(i){i.iKey=i.iKey||t[kS],i[xS]=i[xS]||Ry(new Date),i.ver=i.ver||"4.0",!p&&e[DS]()?T()[US](i):n[MS](i)},e[FS]=T,e[wS]=function(){return r||(r=function(){var e;return Hf(((e={})[VS]=function(e){},e[BS]=function(e){},e[Nv]=function(e){},e[Lv]=function(e,t){},e[xv]=function(e,t){},e))}(),e[GE]=r),r},e[VS]=function(e){r&&r[VS](e)},e[BS]=function(e){r&&r[BS](e)},e.getCookieMgr=function(){return o||(o=M_(t,e[NS])),o},e.setCookieMgr=function(e){o=e},e[Bv]=function(){if(!s&&!a&&Hy(t.enablePerfMgr)){var i=Hy(t[Pv]);fy(i)&&(a=i(e,e[wS]()))}return s||a||null},e.setPerfMgr=function(e){s=e},e.eventCnt=function(){return n[LS]},e.releaseQueue=function(){if(i&&n[LS]>0){var e=n;n=[],wy(e,(function(e){T()[US](e)}))}},e.pollInternalLogs=function(e){f=e||null;var i=Hy(t.diagnosticLogInterval);return i&&i>0||(i=1e4),_&&clearInterval(_),_=setInterval((function(){w()}),i)},e[HS]=function(){_&&(clearInterval(_),_=0,w())},qy(e,(function(){return m}),["addTelemetryInitializer"]),e.unload=function(t,n,r){var s;void 0===t&&(t=!0),i||Gy("SDK is not initialized"),p&&Gy(jE);var a=((s={reason:50})[YS]=t,s.flushComplete=!1,s),o=DE(A(),e);function c(t){a.flushComplete=t,p=!0,v.run(o,a),e[HS](),o[US](a)}o[$S]((function(){E(),n&&n(a)}),e),P(t,c,6,r)||c(!1)},e[GS]=b,e.addPlugin=function(e,t,i,n){if(!e)return n&&n(!1),void O($E);var r=b(e[PS]);if(r&&!t)return n&&n(!1),void O("Plugin ["+e[PS]+"] is already loaded!");var s={reason:16};function a(t){l[MS](e),s.added=[e],I(s),n&&n(!0)}if(r){var o=[r.plugin];R(o,{reason:2,isAsync:!!i},(function(e){e?(s.removed=o,s.reason|=32,a()):n&&n(!1)}))}else a()},e.evtNamespace=function(){return S},e[jS]=P,e.getTraceCtx=function(e){return C||(C=function(e){var t={};return{getName:function(){return t[RS]},setName:function(i){e&&e.setName(i),t[RS]=i},getTraceId:function(){return t[Tv]},setTraceId:function(i){e&&e.setTraceId(i),yE(i)&&(t[Tv]=i)},getSpanId:function(){return t[Iv]},setSpanId:function(i){e&&e.setSpanId(i),CE(i)&&(t[Iv]=i)},getTraceFlags:function(){return t[bv]},setTraceFlags:function(i){e&&e.setTraceFlags(i),t[bv]=i}}}()),C},e.setTraceCtx=function(e){C=e||null},jy(e,"addUnloadCb",(function(){return v}),"add")}))}return e.__ieDyn=1,e}();function KE(e,t,i,n){wy(e,(function(e){if(e&&e[t])if(i)setTimeout((function(){return n(e)}),0);else try{n(e)}catch(e){}}))}var YE,QE,XE=function(){function e(t){this.listeners=[];var i=!!(t||{}).perfEvtsSendAll;bS(e,this,(function(e){e[VS]=function(t){e.listeners[MS](t)},e[BS]=function(t){for(var i=Py(e[vv],t);i>-1;)e.listeners[WS](i,1),i=Py(e[vv],t)},e[Nv]=function(t){KE(e[vv],Nv,!0,(function(e){e[Nv](t)}))},e[Lv]=function(t,i){KE(e[vv],Lv,!0,(function(e){e[Lv](t,i)}))},e[xv]=function(t,i){KE(e[vv],xv,i,(function(e){e[xv](t,i)}))},e[Uv]=function(t){t&&(!i&&t[yv]()||KE(e[vv],Uv,!1,(function(e){t[YS]?setTimeout((function(){return e[Uv](t)}),0):e[Uv](t)})))}}))}return e.__ieDyn=1,e}(),ZE=function(e){function t(){var i=e.call(this)||this;return bS(t,i,(function(e,t){function i(t){var i=e[wS]();i&&i[Lv]([t],2)}e[AS]=function(e,i,n,r){t[AS](e,i,n||new BC(e),r||new XE(e))},e.track=function(n){YC(e[Bv](),(function(){return"AppInsightsCore:track"}),(function(){null===n&&(i(n),Gy("Invalid telemetry item")),function(e){uy(e[RS])&&(i(e),Gy("telemetry name required"))}(n),t.track(n)}),(function(){return{item:n}}),!n.sync)}})),i}return qf(t,e),t.__ieDyn=1,t}(JE),eT="Failed",tT=eT+"MonitorAjax",iT="Track",nT="Start",rT="Stop",sT="Event",aT="AuthContext",oT="Exception",cT="Local",lT="Session",dT="Storage",hT="Browser",uT="Cannot",gT="Buffer",pT="InstrumentationKey",mT=(Jy({CRITICAL:1,WARNING:2}),Jy(((YE={})[hT+"DoesNotSupport"+cT+dT]=0,YE[hT+uT+"Read"+cT+dT]=1,YE[hT+uT+"Read"+lT+dT]=2,YE[hT+uT+"Write"+cT+dT]=3,YE[hT+uT+"Write"+lT+dT]=4,YE[hT+eT+"RemovalFrom"+cT+dT]=5,YE[hT+eT+"RemovalFrom"+lT+dT]=6,YE[uT+"SendEmptyTelemetry"]=7,YE.ClientPerformanceMathError=8,YE["ErrorParsingAI"+lT+"Cookie"]=9,YE.ErrorPVCalc=10,YE[oT+"WhileLoggingError"]=11,YE[eT+"AddingTelemetryTo"+gT]=12,YE[tT+"Abort"]=13,YE[tT+"Dur"]=14,YE[tT+"Open"]=15,YE[tT+"RSC"]=16,YE[tT+"Send"]=17,YE[tT+"GetCorrelationHeader"]=18,YE[eT+"ToAddHandlerForOnBeforeUnload"]=19,YE[eT+"ToSendQueuedTelemetry"]=20,YE[eT+"ToReportDataLoss"]=21,YE["Flush"+eT]=22,YE.MessageLimitPerPVExceeded=23,YE.MissingRequiredFieldSpecification=24,YE.NavigationTimingNotSupported=25,YE.OnError=26,YE[lT+"RenewalDateIsZero"]=27,YE.SenderNotInitialized=28,YE[nT+iT+sT+eT]=29,YE[rT+iT+sT+eT]=30,YE[nT+iT+eT]=31,YE[rT+iT+eT]=32,YE.TelemetrySampledAndNotSent=33,YE[iT+sT+eT]=34,YE[iT+oT+eT]=35,YE[iT+"Metric"+eT]=36,YE[iT+"PV"+eT]=37,YE[iT+"PV"+eT+"Calc"]=38,YE[iT+"Trace"+eT]=39,YE["Transmission"+eT]=40,YE[eT+"ToSet"+dT+gT]=41,YE[eT+"ToRestore"+dT+gT]=42,YE.InvalidBackendResponse=43,YE[eT+"ToFixDepricatedValues"]=44,YE.InvalidDurationValue=45,YE.TelemetryEnvelopeInvalid=46,YE.CreateEnvelopeError=47,YE[uT+"SerializeObject"]=48,YE[uT+"SerializeObjectNonSerializable"]=49,YE.CircularReferenceDetected=50,YE["Clear"+aT+eT]=51,YE[oT+"Truncated"]=52,YE.IllegalCharsInName=53,YE.ItemNotInArray=54,YE.MaxAjaxPerPVExceeded=55,YE.MessageTruncated=56,YE.NameTooLong=57,YE.SampleRateOutOfRange=58,YE["Set"+aT+eT]=59,YE["Set"+aT+eT+"AccountName"]=60,YE.StringValueTooLong=61,YE.StartCalledMoreThanOnce=62,YE.StopCalledWithoutStart=63,YE["TelemetryInitializer"+eT]=64,YE.TrackArgumentsNotSpecified=65,YE.UrlTooLong=66,YE[lT+dT+gT+"Full"]=67,YE[uT+"AccessCookie"]=68,YE.IdTooLong=69,YE.InvalidEvent=70,YE[tT+"SetRequestHeader"]=71,YE["Send"+hT+"InfoOnUserInit"]=72,YE["Plugin"+oT]=73,YE["Notification"+oT]=74,YE.SnippetScriptLoadFailure=99,YE["Invalid"+pT]=100,YE[uT+"ParseAiBlobValue"]=101,YE.InvalidContentBlob=102,YE[iT+"PageAction"+sT+eT]=103,YE[eT+"AddingCustomDefinedRequestContext"]=104,YE["InMemory"+dT+gT+"Full"]=105,YE[pT+"Deprecation"]=106,YE))),fT=(Jy({NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32}),Jy({Normal:1,CostDeferred:2,RealTime:3,Immediate:4})),ST=(Jy({Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9}),Jy({Normal:1,Critical:2})),vT=(Jy({NONE:0,ERROR:1,WARNING:2,INFORMATION:3}),xy(Gf(Gf({},mT),Jy({AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}))),""),yT="version",CT="properties",_T="1DS-Web-JS-3.2.9",ET="withCredentials",TT=((QE={})[0]=0,QE[2]=6,QE[1]=1,QE[3]=7,QE[4098]=6,QE[4097]=1,QE[4099]=7,QE);function IT(e){return!(e===vT||uy(e))}function bT(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return vT}function AT(e,t,i){var n=-1;if(!hy(e))if(t>0&&(32===t?n=8192:t<=13&&(n=t<<5)),function(e){return e>=0&&e<=9}(i))-1===n&&(n=0),n|=i;else{var r=TT[OT(e)]||-1;-1!==n&&-1!==r?n|=r:6===r&&(n=r)}return n}function RT(e,t,i){var n;return void 0===i&&(i=!0),e&&(n=e.get(t),i&&n&&decodeURIComponent&&(n=decodeURIComponent(n))),n||vT}function wT(e){void 0===e&&(e="D");var t=pE();return"B"===e?t="{"+t+"}":"P"===e?t="("+t+")":"N"===e&&(t=t.replace(/-/g,vT)),t}function PT(e,t,i,n,r){var s={},a=!1,o=0,c=arguments.length,l=arguments;for("[object Boolean]"===Object[Mf].toString.call(l[0])&&(a=l[0],o++);o<c;o++)vy(l[o],(function(e,t){a&&t&&my(t)?Ey(t)?(s[e]=s[e]||[],wy(t,(function(t,i){t&&my(t)?s[e][i]=PT(!0,s[e][i],t):s[e][i]=t}))):s[e]=PT(!0,s[e],t):s[e]=t}));return s}Boolean(yC()),Boolean(SC());var MT=function(){var e=mC(iC);return e&&e.now?e.now():Uy()};function DT(e,t){var i=e;i.timings=i.timings||{},i.timings.processTelemetryStart=i.timings.processTelemetryStart||{},i.timings.processTelemetryStart[t]=MT()}function OT(e){var t=0;if(null!=e){var i=typeof e;"string"===i?t=1:"number"===i?t=2:"boolean"===i?t=3:i===wf&&(t=4,Ey(e)?(t=4096,e.length>0&&(t|=OT(e[0]))):Uf.call(e,"value")&&(t=8192|OT(e.value)))}return t}var kT=function(e){function t(){var i=e.call(this)||this;return i.pluginVersionStringArr=[],bS(t,i,(function(e,t){e.logger&&e.logger.queue||(e.logger=new BC({loggingLevelConsole:1})),e.initialize=function(i,n,r,s){YC(e,(function(){return"AppInsightsCore.initialize"}),(function(){var a=e.pluginVersionStringArr;if(i){i.endpointUrl||(i.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var o=i.propertyStorageOverride;!o||o.getProperty&&o.setProperty||Gy("Invalid property storage override passed."),i.channels&&wy(i.channels,(function(e){e&&wy(e,(function(e){if(e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}}))}))}e.getWParam=function(){return"undefined"!=typeof document||i.enableWParam?0:-1},n&&wy(n,(function(e){if(e&&e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}})),e.pluginVersionString=a.join(";"),e.pluginVersionStringArr=a;try{t.initialize(i,n,r,s),e.pollInternalLogs("InternalLog")}catch(t){var c=e.logger,l=RC(t);-1!==l.indexOf("channels")&&(l+="\n - Channels must be provided through config.channels only!"),$C(c,1,514,"SDK Initialization Failed - no telemetry will be sent: "+l)}}),(function(){return{config:i,extensions:n,logger:r,notificationManager:s}}))},e.track=function(i){YC(e,(function(){return"AppInsightsCore.track"}),(function(){var n=i;if(n){n.timings=n.timings||{},n.timings.trackStart=MT(),function(e){return!!(e&&Iy(e)&&e>=1&&e<=4)}(n.latency)||(n.latency=1);var r=n.ext=n.ext||{};r.sdk=r.sdk||{},r.sdk.ver=_T;var s=n.baseData=n.baseData||{};s[CT]=s[CT]||{};var a=s[CT];a[yT]=a[yT]||e.pluginVersionString||vT}t.track(n)}),(function(){return{item:i}}),!i.sync)}})),i}return qf(t,e),t.__ieDyn=1,t}(ZE),NT=kT,LT=fy;function xT(e,t,i){return function(n){e[t]=n,i()}}var UT=function(){function e(t){var i=0,n=null,r=[];function s(t,s,o,c){r.push((function(){var r;try{(r=1===i?LT(t)?t(n):n:LT(s)?s(n):n)instanceof e?r.then(o,c):2!==i||LT(s)?o(r):c(r)}catch(e){return void c(e)}})),0!==i&&a()}function a(){if(r.length>0){var e=r.slice();r=[],setTimeout((function(){for(var t=0,i=e.length;t<i;++t)try{e[t]()}catch(e){}}),0)}}function o(e){0===i&&(n=e,i=1,a())}function c(e){0===i&&(n=e,i=2,a())}bS(e,this,(function(t){t.then=function(t,i){return new e((function(e,n){s(t,i,e,n)}))},t.catch=function(e){return t.then(null,e)}})),function(){if(!LT(t))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{t(o,c)}catch(e){c(e)}}()}return e.resolve=function(t){return t instanceof e?t:t&&LT(t.then)?new e((function(e,i){try{t.then(e,i)}catch(e){i(e)}})):new e((function(e){e(t)}))},e.reject=function(t){return new e((function(e,i){i(t)}))},e.all=function(t){if(t&&t.length)return new e((function(e,i){try{for(var n=[],r=0,s=0;s<t.length;s++){var a=t[s];a&&LT(a.then)?(r++,a.then(xT(n,s,(function(){0==--r&&e(n)})),i)):n[s]=a}0===r&&setTimeout((function(){e(n)}),0)}catch(e){i(e)}}))},e.race=function(t){return new e((function(e,i){if(t&&t.length)try{for(var n=function(n){var r=t[n];r&&LT(r.then)?r.then(e,i):setTimeout((function(){e(r)}),0)},r=0;r<t.length;r++)n(r)}catch(e){i(e)}}))},e}(),FT=UT,VT=0,BT=[],HT=[],$T=[];function GT(){return(new Date).getTime()}var jT,qT=function(){function e(t,i){var n=0,r=(t||"<unnamed>")+"."+VT;function s(e){var t=Vf();t&&t.QUnit&&console&&console.log("ESPromiseScheduler["+r+"] "+e)}function a(e){GC(i,"ESPromiseScheduler["+r+"] "+e)}VT++,bS(e,this,(function(e){var t=null,i=0;function o(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return e.splice(i,1)[0];return null}e.scheduleEvent=function(e,c,l){var d=r+"."+i;i++,c&&(d+="-("+c+")");var h=d+"{"+n+"}";n++;var u={evt:null,tm:GT(),id:h,isRunning:!1,isAborted:!1};return u.evt=t?function(e,t){var i=new FT((function(i,n){var r=GT()-t.tm,a=t.id;s("["+d+"] is waiting for ["+a+":"+r+" ms] to complete before starting -- ["+HT.length+"] waiting and ["+BT.length+"] running"),e.abort=function(t){e.abort=null,o(HT,d),e.isAborted=!0,n(new Error(t))},t.evt.then((function(t){o(HT,d),v(e).then(i,n)}),(function(t){o(HT,d),v(e).then(i,n)}))}));return HT.push(e),i}(u,t):v(u),(t=u).evt._schId=h,u.evt;function g(e){for(var t=GT(),i=t-6e5,n=e.length,r=0;r<n;){var s=e[r];if(s&&s.tm<i){var o=null;s.abort?(o="Aborting ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",s.abort(o)):o="Removing ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",a(o),e.splice(r,1),n--}else r++}}function p(e,i){var n=!1,r=o(BT,e);if(r||(r=o($T,e),n=!0),r){r.to&&(clearTimeout(r.to),r.to=null);var c=GT()-r.tm;i?n?a("Timed out event ["+e+"] finally complete -- "+c+" ms"):s("Promise ["+e+"] Complete -- "+c+" ms"):($T.push(r),a("Event ["+e+"] Timed out and removed -- "+c+" ms"))}else s("Failed to remove ["+e+"] from running queue");t&&t.id===e&&(t=null),g(BT),g(HT),g($T)}function m(e,t){return function(i){return p(e,!0),t&&t(i),i}}function f(e,t,i,n){t.then((function(t){return t instanceof FT?(s("Event ["+e+"] returned a promise -- waiting"),f(e,t,i,n),t):m(e,i)(t)}),m(e,n))}function S(e,t){var i=e.id;return new FT((function(n,r){s("Event ["+i+"] Starting -- waited for "+(e.wTm||"--")+" ms"),e.isRunning=!0,e.abort=function(t){e.abort=null,e.isAborted=!0,p(i,!1),r(new Error(t))};var a=t(i);a instanceof FT?(l&&(e.to=setTimeout((function(){p(i,!1),r(new Error("Timed out after ["+l+"] ms"))}),l)),f(i,a,(function(t){s("Event ["+i+"] Resolving after "+(GT()-e.tm)+" ms"),n(t)}),r)):(s("Promise ["+i+"] Auto completed as the start action did not return a promise"),n())}))}function v(t){var i=GT();return t.wTm=i-t.tm,t.tm=i,t.isAborted?FT.reject(new Error("["+d+"] was aborted")):(BT.push(t),S(t,e))}}}))}return e.incomplete=function(){return BT},e.waitingToStart=function(){return HT},e}(),WT="locale",zT="ver",JT="name",KT=Ky({UserExt:[0,"user"],DeviceExt:[1,"device"],TraceExt:[2,"trace"],WebExt:[3,"web"],AppExt:[4,"app"],OSExt:[5,"os"],SdkExt:[6,"sdk"],IntWebExt:[7,"intweb"],UtcExt:[8,"utc"],LocExt:[9,"loc"],CloudExt:[10,"cloud"],DtExt:[11,"dt"]}),YT=Ky({id:[0,"id"],ver:[1,zT],appName:[2,JT],locale:[3,WT],expId:[4,"expId"],env:[5,"env"]}),QT=Ky({domain:[0,"domain"],browser:[1,"browser"],browserVer:[2,"browserVer"],screenRes:[3,"screenRes"],userConsent:[4,"userConsent"],consentDetails:[5,"consentDetails"]}),XT=Ky({locale:[0,WT],localId:[1,"localId"],id:[2,"id"]}),ZT=Ky({osName:[0,JT],ver:[1,zT]}),eI=Ky({ver:[0,zT],seq:[1,"seq"],installId:[2,"installId"],epoch:[3,"epoch"]}),tI=Ky({msfpc:[0,"msfpc"],anid:[1,"anid"],serviceName:[2,"serviceName"]}),iI=Ky({popSample:[0,"popSample"],eventFlags:[1,"eventFlags"]}),nI=Ky({tz:[0,"tz"]}),rI=Ky({sessionId:[0,"sesId"]}),sI=Ky({localId:[0,"localId"],deviceClass:[1,"deviceClass"],make:[2,"make"],model:[3,"model"]}),aI=Ky({role:[0,"role"],roleInstance:[1,"roleInstance"],roleVer:[2,"roleVer"]}),oI=Ky({traceId:[0,"traceID"],traceName:[1,JT],parentId:[2,"parentID"]}),cI=Ky({traceId:[0,"traceId"],spanId:[1,"spanId"],traceFlags:[2,"traceFlags"]});function lI(){return void 0===jT&&(jT=!!hI(0)),jT}function dI(){return lI()?hI(0):null}function hI(e){var t,i,n=null;try{var r=Vf();if(!r)return null;i=new Date,(n=0===e?r.localStorage:r.sessionStorage)&&fy(n.setItem)&&(n.setItem(i,i),t=n.getItem(i)!==i,n.removeItem(i),t&&(n=null))}catch(e){n=null}return n}function uI(){return this.getId()}function gI(e){this.setId(e)}var pI=function(){function e(){bS(e,this,(function(e){e.setId=function(t){e.customId=t},e.getId=function(){return Ty(e.customId)?e.customId:e.automaticId}}))}return e._staticInit=void Ny(e.prototype,"id",uI,gI),e}(),mI="ai_session",fI=function(){function e(t,i){var n,r,s=VC(t),a=P_(t);bS(e,this,(function(t){var o=function(e){return{sessionRenewalMs:e.sessionRenewalMs&&function(){return e.sessionRenewalMs},sessionExpirationMs:e.sessionExpirationMs&&function(){return e.sessionExpirationMs},cookieDomain:e.cookieDomain&&function(){return e.cookieDomain},namePrefix:e.namePrefix&&function(){return e.namePrefix},sessionAsGuid:function(){return e.sessionAsGuid},idLength:function(){return e.idLength?e.idLength:22}}}(i);function c(){var e=a.get(r());if(e&&fy(e.split))l(e);else{var i=function(e,t){var i=dI();if(null!==i)try{return i.getItem(t)}catch(t){jT=!1,$C(e,1,503,"Browser failed read of local storage. "+t)}return null}(s,r());i&&l(i)}t.automaticSession.getId()||d()}function l(e){var i=t.automaticSession,n=e.split("|");n.length>0&&i.setId(n[0]);try{if(n.length>1){var r=+n[1];i.acquisitionDate=+new Date(r),i.acquisitionDate=i.acquisitionDate>0?i.acquisitionDate:0}if(n.length>2){var a=+n[2];i.renewalDate=+new Date(a),i.renewalDate=i.renewalDate>0?i.renewalDate:0}}catch(e){$C(s,1,510,"Error parsing ai_session cookie, session will be reset: "+e)}0===i.renewalDate&&$C(s,2,517,"AI session renewal date is 0, session will be reset.")}function d(){var e=t.automaticSession,i=(new Date).getTime(),n=t.config.sessionAsGuid();!hy(n)&&n?by(n)?e.setId(wT()):e.setId(wT(n)):e.setId(r_(o&&o.idLength?o.idLength():22)),e.acquisitionDate=i,e.renewalDate=i,h(e.getId(),e.acquisitionDate,e.renewalDate),lI()||$C(s,2,505,"Browser does not support local storage. Session durations will be inaccurate.")}function h(e,i,s){var o=i+t.config.sessionExpirationMs(),c=s+t.config.sessionRenewalMs(),l=new Date,d=[e,i,s];o<c?l.setTime(o):l.setTime(c);var h=t.config.cookieDomain?t.config.cookieDomain():null;a.set(r(),d.join("|")+";expires="+l.toUTCString(),null,h),n=(new Date).getTime()}function u(e,t,i){!function(e,t,i){var n=dI();if(null!==n)try{return n.setItem(t,i),!0}catch(t){jT=!1,$C(e,1,504,"Browser failed write to local storage. "+t)}}(s,r(),[e,t,i].join("|"))}fy(i.sessionExpirationMs)||(o.sessionExpirationMs=function(){return e.acquisitionSpan}),fy(i.sessionRenewalMs)||(o.sessionRenewalMs=function(){return e.renewalSpan}),t.config=o,r=function(){return t.config.namePrefix&&t.config.namePrefix()?mI+t.config.namePrefix():mI},t.automaticSession=new pI,t.update=function(){t.automaticSession.getId()||c();var i=t.automaticSession,r=t.config,s=(new Date).getTime(),a=s-i.acquisitionDate>r.sessionExpirationMs(),o=s-i.renewalDate>r.sessionRenewalMs();a||o?d():(!n||s-n>e.cookieUpdateInterval)&&(i.renewalDate=s,h(i.getId(),i.acquisitionDate,i.renewalDate))},t.backup=function(){var e=t.automaticSession;u(e.getId(),e.acquisitionDate,e.renewalDate)}}))}return e.acquisitionSpan=864e5,e.renewalSpan=18e5,e.cookieUpdateInterval=6e4,e}(),SI=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function vI(e,t){void 0===t&&(t=SI);var i=null;if(e)for(var n=e.split(","),r=0;r<n.length;r++)yI(n[r],t)&&(i?i+=","+n[r]:i=n[r]);return i}function yI(e,t){if(void 0===t&&(t=SI),!e||e.length<4)return!1;for(var i=!1,n=e.substring(0,3).toString().toUpperCase(),r=0;r<t.length;r++)if(t[r]+":"===n&&e.length<=256){i=!0;break}return i}function CI(){return this.getExpId()}var _I=function(){function e(t,i){var n=null,r=SI.slice(0),s=P_(i),a=t;bS(e,this,(function(e){if(vC()){var i=yC().documentElement;i&&(e.locale=i.lang)}function o(e){e!==n&&(n=vI(e,r))}e.env=t.env?t.env:function(e){var t,i={},n=yC();if(n){t=n&&n.querySelectorAll("meta");for(var r=0;r<t.length;r++){var s=t[r];s.name&&0===s.name.toLowerCase().indexOf(e)&&(i[s.name.replace(e,"")]=s.content)}}return i}("awa-").env,e.getExpId=function(){return a.expId?function(e){return o(e),n}(a.expId):(o(RT(s,"Treatments")),n)}}))}return e.validateAppExpId=vI,e._staticInit=void Ny(e.prototype,"expId",CI),e}(),EI=function(){},TI=function(){};function II(){return this.getMsfpc()}function bI(){return this.getAnid()}var AI=function(){function e(t,i){var n=P_(i);bS(e,this,(function(e){t.serviceName&&(e.serviceName=t.serviceName),e.getMsfpc=function(){return RT(n,"MSFPC")},e.getAnid=function(){return RT(n,"ANON").slice(0,34)}}))}var t;return e._staticInit=(Ny(t=e.prototype,"msfpc",II),void Ny(t,"anid",bI)),e}(),RI=function(){var e=(new Date).getTimezoneOffset(),t=e%60,i=(e-t)/60,n="+";i>0&&(n="-"),i=Math.abs(i),t=Math.abs(t),this.tz=n+(i<10?"0"+i:i.toString())+":"+(t<10?"0"+t:t.toString())},wI={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},PI={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},MI="([\\d,.]+)",DI="([\\d,_,.]+)",OI="Unknown",kI=[{r:wI.WINPHONE,os:"Windows Phone"},{r:wI.WINRT,os:"Windows RT"},{r:wI.WIN,os:"Windows"},{r:wI.IOS,os:"iOS"},{r:wI.ANDROID,os:"Android"},{r:wI.LINUX,os:"Linux"},{r:wI.CROS,os:"Chrome OS"},{s:"x11",os:"Unix"},{s:"blackberry",os:"BlackBerry"},{s:"symbian",os:"Symbian"},{s:"nokia",os:"Nokia"},{r:wI.OSX,os:"Mac OS X"}];function NI(e,t){return"Windows"===t?LI(e,"Windows NT"):"Android"===t?LI(e,t):"Mac OS X"===t?function(e){var t=e.match(new RegExp("Mac OS X "+DI));if(t){var i=t[1].replace(/_/g,".");if(i){var n=xI(i);return n?i.split(n)[0]:i}}return OI}(e):"iOS"===t?function(e){var t=e.match(new RegExp("OS "+DI));if(t){var i=t[1].replace(/_/g,".");if(i){var n=xI(i);return n?i.split(n)[0]:i}}return OI}(e):OI}function LI(e,t){var i=e.match(new RegExp(t+" "+MI));return i?PI[i[1]]?PI[i[1]]:i[1]:OI}function xI(e){return e.indexOf(".")>-1?".":e.indexOf("_")>-1?"_":null}var UI=function(e){if(e.populateOperatingSystemInfo){var t=this,i=_C()||{},n=e.userAgent||i.userAgent||"",r=e.userAgentData||i.userAgentData||{};if(n){var s=function(e){for(var t=0;t<kI.length;t++){var i=kI[t];if(i.r&&e.match(i.r))return i.os;if(i.s&&-1!==e.indexOf(i.s))return i.os}return OI}(n.toLowerCase());t.name=s,t.ver=NI(n,s)}t.name&&t.name!==OI||!Ty(r.platform)||(t.name=r.platform)}},FI="MicrosoftApplicationsTelemetryDeviceId";var VI=function(){function e(t,i){var n=0;bS(e,this,(function(e){var r=t.propertyStorageOverride;e.seq=n,e.epoch=n_(!1).toString();var s=P_(i,t);if(s.isEnabled()||r){var a=function(e,t,i){return t?t.getProperty(i)||"":RT(e,i)}(s,r,FI);a||(a=pE()),function(e,t,i,n){t?t.setProperty(i,n):e.set(i,n,31536e3)}(s,r,FI,a),e.installId=a}else s.purge(FI);e.getSequenceId=function(){return++n}}))}return e.__ieDyn=1,e}(),BI=function(e,t,i,n){var r=this;if(r.traceId=t||mE(),e.enableDistributedTracing&&!i&&(i=mE().substring(0,16)),r.parentId=i,e.enableApplicationInsightsTrace){r.name=n;var s=EC();s&&s.pathname&&(r.name=s.pathname)}},HI="setLocalId";function $I(){return this.getLocalId()}function GI(e){this[HI](e)}var jI=function(){function e(t,i,n){var r,s=i,a=P_(n,t);bS(e,this,(function(i){if(a&&a.isEnabled()&&(u(),s.enableApplicationInsightsUser)){var n=RT(a,e.userCookieName);if(n){var o=n.split(e.cookieSeparator);o.length>0&&(i.id=o[0])}if(!i.id){i.id=r_(t&&!hy(t.idLength)?t.idLength:22);var c=Ry(new Date);i.accountAcquisitionDate=c;var l=[i.id,c],d=s.cookieDomain?s.cookieDomain:void 0;a.set(e.userCookieName,l.join(e.cookieSeparator),31536e3,d)}}if("undefined"!=typeof navigator){var h=navigator;i.locale=h.userLanguage||h.language}function u(){if(!s.hashIdentifiers&&!s.dropIdentifiers){var e=RT(a,"MUID");e&&(r="t:"+e)}return r}i.getLocalId=function(){return r||u()},i[HI]=function(e){r=e}}))}return e.cookieSeparator="|",e.userCookieName="ai_user",e._staticInit=void Ny(e.prototype,"localId",$I,GI),e}(),qI=function(e){var t=this;t.popSample=100,t.eventFlags=0,e.hashIdentifiers&&(t.eventFlags=1048576|t.eventFlags),e.dropIdentifiers&&(t.eventFlags=2097152|t.eventFlags)},WI="([\\d,.]+)",zI="Unknown",JI="Edg/",KI=[{ua:"OPR/",b:"Opera"},{ua:"PhantomJS",b:"PhantomJS"},{ua:"Edge",b:"Edge"},{ua:JI,b:"Edge"},{ua:"Electron",b:"Electron"},{ua:"Chrome",b:"Chrome"},{ua:"Trident",b:"MSIE"},{ua:"MSIE ",b:"MSIE"},{ua:"Firefox",b:"Firefox"},{ua:"Safari",b:"Safari"},{ua:"SkypeShell",b:"SkypeShell"}],YI=[{br:"Microsoft Edge",b:"Edge"},{br:"Google Chrome",b:"Chrome"},{br:"Opera",b:"Opera"}];function QI(e,t){return t.indexOf(e)>-1}function XI(e,t){for(var i=0;i<t.length;i++)if(e==t[i].brand)return t[i].version;return null}function ZI(e,t){return"MSIE"===t?function(e){var t=e.match(new RegExp("MSIE "+WI));if(t)return t[1];var i=e.match(new RegExp("rv:"+WI));return i?i[1]:void 0}(e):function(e,t){"Safari"===e?e="Version":"Edge"===e&&QI(JI,t)&&(e="Edg");var i=t.match(new RegExp(e+"/"+WI));return i||"Opera"===e&&(i=t.match(new RegExp("OPR/"+WI)))?i[1]:zI}(t,e)}function eb(){return this.getUserConsent()}var tb=function(){function e(t,i){var n=P_(i),r=t||{};bS(e,this,(function(e){var t=EC();if(t){var i=t.hostname;i&&(e.domain="file:"===t.protocol?"local":i)}if(r.populateBrowserInfo){var s=r.userAgent,a=(r.userAgentData||{}).brands,o=_C();o&&(s=s||o.userAgent||"",a=a||(o.userAgentData||{}).brands),function(t,i){if(Ey(i))try{for(var n=0;n<YI.length;n++){var r=XI(YI[n].br,i);if(r)return e.browser=YI[n].b,void(e.browserVer=r)}}catch(e){}if(t){var s=function(e){if(e)for(var t=0;t<KI.length;t++)if(QI(KI[t].ua,e))return KI[t].b;return zI}(t);e.browser=s,e.browserVer=ZI(t,s)}}(s,a);var c=function(){var e={h:0,w:0},t=SC();return t&&t.screen&&(e.h=screen.height,e.w=screen.width),e}();e.screenRes=c.w+"X"+c.h}e.getUserConsent=function(){return r.userConsented||!!RT(n,r.userConsentCookieName||"MSCC")},e.getUserConsentDetails=function(){try{var e=r.callback;if(e&&e.userConsentDetails){var t=e.userConsentDetails();if(t)return JSON.stringify({Required:t.Required||!1,Analytics:t.Analytics||!1,SocialMedia:t.SocialMedia||!1,Advertising:t.Advertising||!1})}}catch(e){}return null},Ny(e,"userConsent",e.getUserConsent)}))}return e._staticInit=void Ny(e.prototype,"userConsent",eb),e}();function ib(e,t,i,n,r){var s=t.ext[KT[e]];return s&&vy(n,(function(e,t){if(Ty(t)||Iy(t)||by(t)){var n=s[i[e]];!r&&(n||Ty(n)||Iy(n)||by(n))&&(t=n),s[i[e]]=t}})),s}var nb=function(){function e(t,i,n){bS(e,this,(function(e){e.app=new _I(i,n),e.cloud=new EI,e.user=new jI(t,i,n),e.os=new UI(i),e.web=new tb(i,n);var r=new VI(t,n),s=new AI(i,n),a=new qI(i);e.loc=new RI,e.device=new TI;var o=new fI(n,i);e.session=new pI;var c=function(e,t){var i=e||{};return{getName:function(){return i.name},setName:function(e){t&&t.setName(e),i.name=e},getTraceId:function(){return i.traceId},setTraceId:function(e){t&&t.setTraceId(e),yE(e)&&(i.traceId=e)},getSpanId:function(){return i.parentId},setSpanId:function(e){t&&t.setSpanId(e),CE(e)&&(i.parentId=e)},getTraceFlags:function(){return i.traceFlags},setTraceFlags:function(e){t&&t.setTraceFlags(e),i.traceFlags=e}}}(new BI(i),h()),l=!(i||{}).eventContainExtFields;function d(){var t=e.session;if(t&&Ty(t.customId))return t.customId;o.update();var i=o.automaticSession;if(i){var n=i.getId();n&&Ty(n)&&(t.automaticId=n)}return t.automaticId}function h(){var e=c;return n&&n.getTraceCtx&&(e=n.getTraceCtx(!1)||c),e}e.getTraceCtx=function(){return c},e.getSessionId=d,e.applyApplicationContext=function(t){var i,n=e.app;ib(4,t,YT,((i={})[0]=n.id,i[1]=n.ver,i[2]=n.name,i[3]=n.locale,i[4]=n.getExpId(),i[5]=n.env,i),l)},e.applyUserContext=function(t){var i,n=e.user;ib(0,t,XT,((i={})[1]=n.getLocalId(),i[0]=n.locale,i[2]=n.id,i),l)},e.applyWebContext=function(t){var i,n=e.web;ib(3,t,QT,((i={})[0]=n.domain,i[1]=n.browser,i[2]=n.browserVer,i[3]=n.screenRes,i[5]=n.getUserConsentDetails(),i[4]=n.getUserConsent(),i),l)},e.applyOsContext=function(t){var i,n=e.os;ib(5,t,ZT,((i={})[0]=n.name,i[1]=n.ver,i),l)},e.applySdkContext=function(e){var t;ib(6,e,eI,((t={})[2]=r.installId,t[1]=r.getSequenceId(),t[3]=r.epoch,t),l)},e.applyIntWebContext=function(e){var t;ib(7,e,tI,((t={})[0]=s.getMsfpc(),t[1]=s.getAnid(),t[2]=s.serviceName,t),l)},e.applyUtcContext=function(e){var t,i=((t={})[0]=a.popSample,t);a.eventFlags>0&&(i[1]=a.eventFlags),ib(8,e,iI,i,l)},e.applyLocContext=function(t){var i;ib(9,t,nI,((i={})[0]=e.loc.tz,i),l)},e.applySessionContext=function(e){var t;ib(4,e,rI,((t={})[0]=d(),t),l)},e.applyDeviceContext=function(t){var i,n=e.device;ib(1,t,sI,((i={})[0]=n.localId,i[2]=n.make,i[3]=n.model,i[1]=n.deviceClass,i),l)},e.applyCloudContext=function(t){var i,n=e.cloud;ib(10,t,aI,((i={})[0]=n.role,i[1]=n.roleInstance,i[2]=n.roleVer,i),l)},e.applyAITraceContext=function(e){var t;if(i.enableApplicationInsightsTrace){var n=h();n&&ib(2,e,oI,((t={})[0]=n.getTraceId(),t[1]=n.getName(),t[2]=n.getSpanId(),t),!1)}},e.applyDistributedTraceContext=function(e){var t,i=h();if(i){var n=((t={})[0]=i.getTraceId(),t[1]=i.getSpanId(),t),r=i.getTraceFlags();uy(r)||(n[2]=r),ib(11,e,cI,n,!1)}}}))}return e.__ieDyn=1,e}();var rb=[KT[4],KT[0],KT[3],KT[5],KT[6],KT[7],KT[8],KT[9],KT[1],KT[2],KT[11],KT[10]],sb=function(e){function t(){var i,n,r,s=e.call(this)||this;return s.identifier="SystemPropertiesCollector",s.priority=3,s.version="3.2.9",bS(t,s,(function(e,t){function s(){i=null,n={}}s(),e.initialize=function(n,s,a){t.initialize(n,s,a),r=e._getTelCtx().getExtCfg(e.identifier),i=new nb(n,r,s),s&&s.setTraceCtx&&s.setTraceCtx(i.getTraceCtx())},e.processTelemetry=function(t,s){DT(t,e.identifier),s=e._getTelCtx(s);var a=t.ext=t.ext?t.ext:{};t.data=t.data?t.data:{},wy(rb,(function(e){a[e]=a[e]||{}})),i&&(i.applyApplicationContext(t),i.applyUserContext(t),i.applyWebContext(t),i.applyOsContext(t),i.applySdkContext(t),i.applyIntWebContext(t),i.applyUtcContext(t),i.applyLocContext(t),i.applySessionContext(t),i.applyDeviceContext(t),r.enableApplicationInsightsTrace&&i.applyAITraceContext(t),r.enableDistributedTracing&&i.applyDistributedTraceContext(t),i.applyCloudContext(t)),wy(ky(a),(function(e){0===ky(a[e]).length&&delete a[e]})),function(e,t){e&&vy(e,(function(e,i){t[e]||(t[e]=i)}))}(n,t.data),e.processNext(t,s)},e.getPropertiesContext=function(){return i},e.setProperty=function(e,t){n[e]=t},e._doTeardown=function(e,t){var n=(e||{}).core();if(n&&n.getTraceCtx&&i){var r=n.getTraceCtx(!1);r&&r===i.getTraceCtx()&&n.setTraceCtx(null)}s()}})),s}return qf(t,e),t.__ieDyn=1,t}(BE),ab=function(e){this._setOverride=function(t,i){e.setOverride(t,i)},this._getOverride=function(t){return e.getOverride(t)}},ob=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;return r.setId=function(e){r._setOverride(YT.id,e)},r.getId=function(){return r._getOverride(YT.id)},r.setVer=function(e){r._setOverride(YT.ver,e)},r.getVer=function(){return r._getOverride(YT.ver)},r.setName=function(e){r._setOverride(YT.appName,e)},r.getName=function(){return r._getOverride(YT.appName)},r.setLocale=function(e){r._setOverride(YT.locale,e)},r.getLocale=function(){return r._getOverride(YT.locale)},r.setEnv=function(e){r._setOverride(YT.env,e)},r.getEnv=function(){return r._getOverride(YT.env)},r.setExpId=function(e){r._setOverride(YT.expId,_I.validateAppExpId(e))},r.getExpId=function(){return r._getOverride(YT.expId)},i&&(hy(i.env)||r.setEnv(i.env),uy(i.expId)||r.setExpId(i.expId)),n}return qf(t,e),t}(ab),cb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setRole=function(e){n._setOverride(aI.role,e)},n.getRole=function(){return n._getOverride(aI.role)},n.setRoleInstance=function(e){n._setOverride(aI.roleInstance,e)},n.getRoleInstance=function(){return n._getOverride(aI.roleInstance)},n.setRoleVer=function(e){n._setOverride(aI.roleVer,e)},n.getRoleVer=function(){return n._getOverride(aI.roleVer)},i}return qf(t,e),t}(ab),lb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setProperty=function(e,t){n._setOverride(e,t)},n.getProperty=function(e){return n._getOverride(e)},i}return qf(t,e),t}(ab),db=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setLocalId=function(e){n._setOverride(sI.localId,e)},n.getLocalId=function(){return n._getOverride(sI.localId)},n.setDeviceClass=function(e){n._setOverride(sI.deviceClass,e)},n.getDeviceClass=function(){return n._getOverride(sI.deviceClass)},n.setMake=function(e){n._setOverride(sI.make,e)},n.getMake=function(){return n._getOverride(sI.make)},n.setModel=function(e){n._setOverride(sI.model,e)},n.getModel=function(){return n._getOverride(sI.model)},i}return qf(t,e),t}(ab),hb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setTz=function(e){n._setOverride(nI.tz,e)},n.getTz=function(){return n._getOverride(nI.tz)},i}return qf(t,e),t}(ab),ub=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;if(r.setOsName=function(e){r._setOverride(ZT.osName,e)},r.getOsName=function(){return r._getOverride(ZT.osName)},r.setVer=function(e){r._setOverride(ZT.ver,e)},r.getVer=function(){return r._getOverride(ZT.ver)},i&&i.userAgent&&i.populateOperatingSystemInfo){var s=new UI(i);r.setOsName(s.name),r.setVer(s.ver)}return n}return qf(t,e),t}(ab);function gb(e,t){if(e)for(var i=0;i<t.length;i++){var n=t[i];uy(e[n])&&(e[n]={}),e=e[n]}return e}var pb=function(e){var t=this,i=[];t.setOverride=function(e,t){e&&i.push({key:e,value:t})},t.hasOverride=function(e){var t=!1;return wy(i,(function(i){i.key===e&&(t=!0)})),t},t.getOverride=function(e){var t;return wy(i,(function(i){i.key===e&&(t=i.value)})),t},t.applyOverrides=function(t,n){if(i.length>0)try{var r=gb(t,e);wy(i,(function(e){!function(e,t,i){if(e&&t){var n=t.split("."),r=n[n.length-1];n.length>1&&(e=gb(e,n.slice(0,-1))),uy(i)?hy(e[r])||delete e[r]:e[r]=i}}(r,e.key,e.value)}))}catch(e){}}},mb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setLocalId=function(e){n._setOverride(XT.localId,e)},n.getLocalId=function(){return n._getOverride(XT.localId)},n.setLocale=function(e){n._setOverride(XT.locale,e)},n.getLocale=function(){return n._getOverride(XT.locale)},n.setId=function(e){n._setOverride(XT.id,e)},n.getId=function(){return n._getOverride(XT.id)},i}return qf(t,e),t}(ab),fb=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;return r.setDomain=function(e){r._setOverride(QT.domain,e)},r.getDomain=function(){return r._getOverride(QT.domain)},r.setBrowser=function(e){r._setOverride(QT.browser,e)},r.getBrowser=function(){return r._getOverride(QT.browser)},r.setBrowserVer=function(e){r._setOverride(QT.browserVer,e)},r.getBrowserVer=function(){return r._getOverride(QT.browserVer)},r.setScreenRes=function(e){r._setOverride(QT.screenRes,e)},r.getScreenRes=function(){return r._getOverride(QT.screenRes)},r.setUserConsent=function(e){r._setOverride(QT.userConsent,e)},r.getUserContext=function(){return r._getOverride(QT.userConsent)},i&&(hy(i.userConsented)||r.setUserConsent(i.userConsented)),n}return qf(t,e),t}(ab),Sb="ext",vb=function(e,t,i){var n=this,r={};function s(e){for(var t="",i=0;i<e.length;i++)t&&(t+="_"),t+=e[i];return hy(r[t])&&(r[t]=new pb(e)),t?r[t]:null}n.data=new lb(s(["data"])),n.app=new ob(s([Sb,KT.AppExt]),t),n.user=new mb(s([Sb,KT.UserExt])),n.os=new ub(s([Sb,KT.OSExt]),t),n.web=new fb(s([Sb,KT.WebExt]),t),n.device=new db(s([Sb,KT.DeviceExt])),n.loc=new hb(s([Sb,KT.LocExt])),n.cloud=new cb(s([Sb,KT.CloudExt])),n.applyOverrides=function(e,t){var i=ky(r);i&&i.length>0&&wy(i,(function(i){r[i].applyOverrides(e,t)}))}},yb=function(e){function t(){var i=e.call(this)||this;i.identifier="OverridePropertiesPlugin",i.priority=4,i.version="3.2.9";var n=null;return bS(t,i,(function(e,t){e.initialize=function(i,n,r){t.initialize(i,n,r),e._baseInit(i,n,r)},e.processTelemetry=function(t,n){DT(t,i.identifier),n=e._getTelCtx(n);var r=e.getOverrideContext();r&&r.applyOverrides(t,n),e.processNext(t,n)},e._baseInit=function(e,t,r){n=new vb(e,i._getTelCtx().getExtCfg(i.identifier),t)},e.setProperty=function(e,t){n&&n.data.setProperty(e,t)},e.getOverrideContext=function(){return n}})),i}return qf(t,e),t.__ieDyn=1,t}(BE),Cb="REAL_TIME",_b="",Eb="POST",Tb="drop",Ib="send",bb="requeue",Ab="rspFail",Rb="application/x-json-stream",wb="cache-control",Pb="content-type",Mb="kill-duration",Db="time-delta-millis",Ob="client-version",kb="client-id",Nb="time-delta-to-apply-millis",Lb="upload-time",xb="apikey",Ub="AuthMsaDeviceTicket",Fb="AuthXToken",Vb="msfpc",Bb="trace",Hb="user";function $b(e){var t=(e.ext||{}).intweb;return t&&IT(t[Vb])?t[Vb]:null}function Gb(e){for(var t=null,i=0;null===t&&i<e.length;i++)t=$b(e[i]);return t}var jb=function(){function e(t,i){var n=i?[].concat(i):[],r=this,s=Gb(n);r.iKey=function(){return t},r.Msfpc=function(){return s||_b},r.count=function(){return n.length},r.events=function(){return n},r.addEvent=function(e){return!!e&&(n.push(e),s||(s=$b(e)),!0)},r.split=function(i,r){var a;if(i<n.length){var o=n.length-i;uy(r)||(o=r<o?r:o),a=n.splice(i,o),s=Gb(n)}return new e(t,a)}}return e.create=function(t,i){return new e(t,i)},e}(),qb=function(){function e(){var t=!0,i=!0,n=!0,r="use-collector-delta",s=!1;bS(e,this,(function(e){e.allowRequestSending=function(){return t},e.firstRequestSent=function(){n&&(n=!1,s||(t=!1))},e.shouldAddClockSkewHeaders=function(){return i},e.getClockSkewHeaderValue=function(){return r},e.setClockSkew=function(e){s||(e?(r=e,i=!0,s=!0):i=!1,t=!0)}}))}return e.__ieDyn=1,e}(),Wb=function(){function e(){var t={};bS(e,this,(function(e){e.setKillSwitchTenants=function(e,i){if(e&&i)try{var n=function(e){var t=[];return e&&wy(e,(function(e){t.push(My(e))})),t}(e.split(","));if("this-request-only"===i)return n;for(var r=1e3*parseInt(i,10),s=0;s<n.length;++s)t[n[s]]=Uy()+r}catch(e){return[]}return[]},e.isTenantKilled=function(e){var i=t,n=My(e);return void 0!==i[n]&&i[n]>Uy()||(delete i[n],!1)}}))}return e.__ieDyn=1,e}(),zb=Wb;function Jb(e){var t,i=Math.floor(1200*Math.random())+2400;return t=Math.pow(2,e)*i,Math.min(t,6e5)}var Kb,Yb=2e6,Qb=Math.min(Yb,65e3),Xb="metadata",Zb="f",eA=/\./,tA=function(){function e(t,i,n,r){var s="data",a="baseData",o=!!r,c=!0,l=i,d={};bS(e,this,(function(e){function i(e,t){var i=d[e];return void 0===i&&(e.length>=7&&(i=Cy(e,"ext.metadata")||Cy(e,"ext.web")),d[e]=i),i}function r(e,t,s,a,c,d,h){vy(e,(function(e,u){var g=null;if(u||IT(u)){var p=s,m=e,f=c,S=t;if(o&&!a&&eA.test(e)){var v=e.split("."),y=v.length;if(y>1){f&&(f=f.slice());for(var C=0;C<y-1;C++){var _=v[C];S=S[_]=S[_]||{},p+="."+_,f&&f.push(_)}m=v[y-1]}}if(g=a&&i(p)||!l||!l.handleField(p,m)?function(e,t,i){if(!t&&!IT(t)||"string"!=typeof e)return null;var n=typeof t;if("string"===n||"number"===n||"boolean"===n||Ey(t))t={value:t};else if("object"!==n||Uf.call(t,"value")){if(uy(t.value)||t.value===vT||!Ty(t.value)&&!Iy(t.value)&&!by(t.value)&&!Ey(t.value))return null}else t={value:i?JSON.stringify(t):t};if(Ey(t.value)&&!function(e){return e.length>0}(t.value))return null;if(!uy(t.kind)){if(Ey(t.value)||!function(e){return 0===e||e>0&&e<=13||32===e}(t.kind))return null;t.value=t.value.toString()}return t}(m,u,n):l.value(p,m,u,n)){var E=g.value;if(S[m]=E,d&&d(f,m,g),h&&"object"==typeof E&&!Ey(E)){var T=f;T&&(T=T.slice()).push(m),r(u,E,p+"."+m,a,T,d,h)}}}}))}e.createPayload=function(e,t,i,n,r,s){return{apiKeys:[],payloadBlob:_b,overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:e,isTeardown:t,isSync:i,isBeacon:n,sendType:s,sendReason:r}},e.appendPayload=function(i,n,r){var s=i&&n&&!i.overflow;return s&&YC(t,(function(){return"Serializer:appendPayload"}),(function(){for(var t=n.events(),s=i.payloadBlob,a=i.numEvents,o=!1,c=[],l=[],d=i.isBeacon,h=d?65e3:3984588,u=d?Qb:Yb,g=0,p=0;g<t.length;){var m=t[g];if(m){if(a>=r){i.overflow=n.split(g);break}var f=e.getEventBlob(m);if(f&&f.length<=u){var S=f.length;if(s.length+S>h){i.overflow=n.split(g);break}s&&(s+="\n"),s+=f,++p>20&&(s.substr(0,1),p=0),o=!0,a++}else f?c.push(m):l.push(m),t.splice(g,1),g--}g++}if(c&&c.length>0&&i.sizeExceed.push(jb.create(n.iKey(),c)),l&&l.length>0&&i.failedEvts.push(jb.create(n.iKey(),l)),o){i.batches.push(n),i.payloadBlob=s,i.numEvents=a;var v=n.iKey();-1===Py(i.apiKeys,v)&&i.apiKeys.push(v)}}),(function(){return{payload:i,theBatch:{iKey:n.iKey(),evts:n.events()},max:r}})),s},e.getEventBlob=function(e){try{return YC(t,(function(){return"Serializer.getEventBlob"}),(function(){var t={};t.name=e.name,t.time=e.time,t.ver=e.ver,t.iKey="o:"+bT(e.iKey);var i={},n=e.ext;n&&(t.ext=i,vy(n,(function(e,t){r(t,i[e]={},"ext."+e,!0,null,null,!0)})));var o=t[s]={};o.baseType=e.baseType;var l=o[a]={};return r(e.baseData,l,a,!1,[a],(function(e,t,n){iA(i,e,t,n)}),c),r(e.data,o,s,!1,[],(function(e,t,n){iA(i,e,t,n)}),c),JSON.stringify(t)}),(function(){return{item:e}}))}catch(e){return null}}}))}return e.__ieDyn=1,e}();function iA(e,t,i,n){if(n&&e){var r=AT(n.value,n.kind,n.propertyType);if(r>-1){var s=e[Xb];s||(s=e[Xb]={f:{}});var a=s[Zb];if(a||(a=s[Zb]={}),t)for(var o=0;o<t.length;o++){var c=t[o];a[c]||(a[c]={f:{}});var l=a[c][Zb];l||(l=a[c][Zb]={}),a=l}a=a[i]={},Ey(n.value)?a.a={t:r}:a.t=r}}}var nA="sendAttempt",rA="&NoResponseBody=true",sA=((Kb={})[1]=bb,Kb[100]=bb,Kb[200]="sent",Kb[8004]=Tb,Kb[8003]=Tb,Kb),aA={},oA={};function cA(e,t,i){aA[e]=t,!1!==i&&(oA[t]=e)}function lA(e){try{return e.responseText}catch(e){}return _b}function dA(e,t){var i=!1;if(e&&t){var n=ky(e);if(n&&n.length>0)for(var r=t.toLowerCase(),s=0;s<n.length;s++){var a=n[s];if(a&&py(t,a)&&a.toLowerCase()===r){i=!0;break}}}return i}function hA(e,t,i,n){t&&i&&i.length>0&&(n&&aA[t]?(e.hdrs[aA[t]]=i,e.useHdrs=!0):e.url+="&"+t+"="+i)}function uA(e,t){return t&&(Iy(t)?e=[t].concat(e):Ey(t)&&(e=t.concat(e))),e}cA(Ub,Ub,!1),cA(Ob,Ob),cA(kb,"Client-Id"),cA(xb,xb),cA(Nb,Nb),cA(Lb,Lb),cA(Fb,Fb);var gA=function(){function e(t,i,n,r,s){this._responseHandlers=[];var a,o,c,l,d,h,u,g,p,m,f="?cors=true&"+Pb.toLowerCase()+"="+Rb,S=new zb,v=!1,y=new qb,C=!1,_=0,E=!0,T=[],I={},b=[],A=null,R=!1,w=!1,P=!1;bS(e,this,(function(e){var M=!0;function D(e,t){for(var i=0,n=null,r=0;null==n&&r<e.length;)1===(i=e[r])?(null===uC&&(uC=typeof XDomainRequest!==Pf)&&MC()&&(uC=uC&&!pC(mC(cC),"withCredentials")),uC?n=O:MC()&&(n=N)):2===i&&PC(t)&&(!t||t&&!g)?n=k:C&&3===i&&wC()&&(n=x),r++;return n?{_transport:i,_isSync:t,sendPOST:n}:null}function O(e,t,i){var n=new XDomainRequest;n.open(Eb,e.urlString),e.timeout&&(n.timeout=e.timeout),n.onload=function(){var e=lA(n);L(t,200,{},e),Y(e)},n.onerror=function(){L(t,400,{})},n.ontimeout=function(){L(t,500,{})},n.onprogress=function(){},i?n.send(e.data):s.set((function(){n.send(e.data)}),0)}function k(e,t,i){var n,r=e.urlString,a=!1,o=!1,c=((n={body:e.data,method:Eb}).Microsoft_ApplicationInsights_BypassAjaxInstrumentation=!0,n);i&&(c.keepalive=!0,2===e._sendReason&&(a=!0,m&&(r+=rA))),M&&(c.credentials="include"),e.headers&&ky(e.headers).length>0&&(c.headers=e.headers),fetch(r,c).then((function(e){var i={},n=_b,r=e.headers;r&&r.forEach((function(e,t){i[t]=e})),e.body&&e.text().then((function(e){n=e})),o||(o=!0,L(t,e.status,i,n),Y(n))})).catch((function(e){o||(o=!0,L(t,0,{}))})),a&&!o&&(o=!0,L(t,200,{})),!o&&e.timeout>0&&s.set((function(){o||(o=!0,L(t,500,{}))}),e.timeout)}function N(e,t,i){var n=e.urlString;function r(e,t,i){if(!e[i]&&t&&t.getResponseHeader){var n=t.getResponseHeader(i);n&&(e[i]=My(n))}return e}function s(e){var t={};return e.getAllResponseHeaders?t=function(e){var t={};return Ty(e)&&wy(My(e).split(/[\r\n]+/),(function(e){if(e){var i=e.indexOf(": ");if(-1!==i){var n=My(e.substring(0,i)).toLowerCase(),r=My(e.substring(i+1));t[n]=r}else t[My(e)]=1}})),t}(e.getAllResponseHeaders()):(t=r(t,e,Db),t=r(t,e,Mb),t=r(t,e,"kill-duration-seconds")),t}function a(e,i){L(t,e.status,s(e),i)}i&&e.disableXhrSync&&(i=!1);var o=function(e,t,i,n,r,s){function a(e,t,i){try{e[t]=i}catch(e){}}void 0===n&&(n=!1),void 0===r&&(r=!1);var o=new XMLHttpRequest;return n&&a(o,"Microsoft_ApplicationInsights_BypassAjaxInstrumentation",n),i&&a(o,ET,i),o.open(e,t,!r),i&&a(o,ET,i),!r&&s&&a(o,"timeout",s),o}(Eb,n,M,!0,i,e.timeout);vy(e.headers,(function(e,t){o.setRequestHeader(e,t)})),o.onload=function(){var e=lA(o);a(o,e),Y(e)},o.onerror=function(){a(o)},o.ontimeout=function(){a(o)},o.send(e.data)}function L(e,t,i,n){try{e(t,i,n)}catch(e){$C(o,2,518,RC(e))}}function x(e,t,i){var n=200,r=e._thePayload,s=e.urlString+(m?rA:_b);try{var a=_C();if(!a.sendBeacon(s,e.data))if(r){var c=[];wy(r.batches,(function(e){if(c&&e&&e.count()>0){for(var t=e.events(),i=0;i<t.length;i++)if(!a.sendBeacon(s,A.getEventBlob(t[i]))){c.push(e.split(i));break}}else c.push(e.split(0))})),Q(c,8003,r.sendType,!0)}else n=0}catch(e){GC(o,"Failed to send telemetry using sendBeacon API. Ex:"+RC(e)),n=0}finally{L(t,n,{},_b)}}function U(e){return 2===e||3===e}function F(e){return w&&U(e)&&(e=2),e}function V(){return!v&&_<i}function B(){var e=b;return b=[],e}function H(e,t,i){var n=!1;return e&&e.length>0&&!v&&c[t]&&A&&(n=0!==t||V()&&(i>0||y.allowRequestSending())),n}function $(e){var t={};return e&&wy(e,(function(e,i){t[i]={iKey:e.iKey(),evts:e.events()}})),t}function G(e,i,n,r,s){if(e&&0!==e.length)if(v)Q(e,1,r);else{r=F(r);try{var a=e,d=0!==r;YC(l,(function(){return"HttpManager:_sendBatches"}),(function(a){a&&(e=e.slice(0));for(var o=[],l=null,h=MT(),u=c[r]||(d?c[1]:c[0]),g=u&&u._transport,m=p&&(w||U(r)||3===g||u._isSync&&2===g);H(e,r,i);){var f=e.shift();f&&f.count()>0&&(S.isTenantKilled(f.iKey())?o.push(f):(l=l||A.createPayload(i,n,d,m,s,r),A.appendPayload(l,f,t)?null!==l.overflow&&(e=[l.overflow].concat(e),l.overflow=null,W(l,h,MT(),s),h=MT(),l=null):(W(l,h,MT(),s),h=MT(),e=[f].concat(e),l=null)))}l&&W(l,h,MT(),s),e.length>0&&(b=e.concat(b)),Q(o,8004,r)}),(function(){return{batches:$(a),retryCount:i,isTeardown:n,isSynchronous:d,sendReason:s,useSendBeacon:U(r),sendType:r}}),!d)}catch(e){$C(o,2,48,"Unexpected Exception sending batch: "+RC(e))}}}function j(e,t){var i={url:f,hdrs:{},useHdrs:!1};t?(i.hdrs=PT(i.hdrs,I),i.useHdrs=ky(i.hdrs).length>0):vy(I,(function(e,t){oA[e]?hA(i,oA[e],t,!1):(i.hdrs[e]=t,i.useHdrs=!0)})),hA(i,kb,"NO_AUTH",t),hA(i,Ob,_T,t);var n=_b;wy(e.apiKeys,(function(e){n.length>0&&(n+=","),n+=e})),hA(i,xb,n,t),hA(i,Lb,Uy().toString(),t);var r=function(e){for(var t=0;t<e.batches.length;t++){var i=e.batches[t].Msfpc();if(i)return encodeURIComponent(i)}return _b}(e);if(IT(r)&&(i.url+="&ext.intweb.msfpc="+r),y.shouldAddClockSkewHeaders()&&hA(i,Nb,y.getClockSkewHeaderValue(),t),l.getWParam){var s=l.getWParam();s>=0&&(i.url+="&w="+s)}for(var a=0;a<T.length;a++)i.url+="&"+T[a].name+"="+T[a].value;return i}function q(e,t,i){e[t]=e[t]||{},e[t][a.identifier]=i}function W(t,i,n,r){if(t&&t.payloadBlob&&t.payloadBlob.length>0){var s=!!e.sendHook,a=c[t.sendType];!U(t.sendType)&&t.isBeacon&&2===t.sendReason&&(a=c[2]||c[3]||a);var d=P;(t.isBeacon||3===a._transport)&&(d=!1);var p=j(t,d);d=d||p.useHdrs;var m=MT();YC(l,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var c=0;c<t.batches.length;c++)for(var f=t.batches[c].events(),S=0;S<f.length;S++){var v=f[S];if(R){var C=v.timings=v.timings||{};q(C,"sendEventStart",m),q(C,"serializationStart",i),q(C,"serializationCompleted",n)}v[nA]>0?v[nA]++:v[nA]=1}Q(t.batches,1e3+(r||0),t.sendType,!0);var T={data:t.payloadBlob,urlString:p.url,headers:p.hdrs,_thePayload:t,_sendReason:r,timeout:h,disableXhrSync:u,disableFetchKeepAlive:g};d&&(dA(T.headers,wb)||(T.headers[wb]="no-cache, no-store"),dA(T.headers,Pb)||(T.headers[Pb]=Rb));var I=null;a&&(I=function(i){y.firstRequestSent();var n=function(e,i){z(e,i,t,r)},s=t.isTeardown||t.isSync;try{a.sendPOST(i,n,s),e.sendListener&&e.sendListener(T,i,s,t.isBeacon)}catch(e){GC(o,"Unexpected exception sending payload. Ex:"+RC(e)),L(n,0,{})}}),YC(l,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(I)if(0===t.sendType&&_++,s&&!t.isBeacon&&3!==a._transport){var i={data:T.data,urlString:T.urlString,headers:PT({},T.headers),timeout:T.timeout,disableXhrSync:T.disableXhrSync,disableFetchKeepAlive:T.disableFetchKeepAlive},n=!1;YC(l,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{e.sendHook(i,(function(e){n=!0,E||e._thePayload||(e._thePayload=e._thePayload||T._thePayload,e._sendReason=e._sendReason||T._sendReason),I(e)}),t.isSync||t.isTeardown)}catch(e){n||I(T)}}))}else I(T)}))}),(function(){return{thePayload:t,serializationStart:i,serializationCompleted:n,sendReason:r}}),t.isSync)}t.sizeExceed&&t.sizeExceed.length>0&&Q(t.sizeExceed,8003,t.sendType),t.failedEvts&&t.failedEvts.length>0&&Q(t.failedEvts,8002,t.sendType)}function z(e,t,i,r){var s=9e3,a=null,o=!1,c=!1;try{var l=!0;if(typeof e!==Pf){if(t){y.setClockSkew(t[Db]);var d=t[Mb]||t["kill-duration-seconds"];wy(S.setKillSwitchTenants(t["kill-tokens"],d),(function(e){wy(i.batches,(function(t){if(t.iKey()===e){a=a||[];var n=t.split(0);i.numEvents-=n.count(),a.push(n)}}))}))}if(200==e||204==e)return void(s=200);(!function(e){return!(e>=300&&e<500&&408!=e&&429!=e||501==e||505==e)}(e)||i.numEvents<=0)&&(l=!1),s=9e3+e%1e3}if(l){s=100;var h=i.retryCnt;0===i.sendType&&(h<n?(o=!0,K((function(){0===i.sendType&&_--,G(i.batches,h+1,i.isTeardown,w?2:i.sendType,5)}),w,Jb(h))):(c=!0,w&&(s=8001)))}}finally{o||(y.setClockSkew(),J(i,s,r,c)),Q(a,8004,i.sendType)}}function J(t,i,n,r){try{r&&a._backOffTransmission(),200===i&&(r||t.isSync||a._clearBackOff(),function(e){if(R){var t=MT();wy(e,(function(e){e&&e.count()>0&&function(e,t){R&&wy(e,(function(e){q(e.timings=e.timings||{},"sendEventCompleted",t)}))}(e.events(),t)}))}}(t.batches)),Q(t.batches,i,t.sendType,!0)}finally{0===t.sendType&&(_--,5!==n&&e.sendQueuedRequests(t.sendType,n))}}function K(e,t,i){t?e():s.set(e,i)}function Y(t){var i=e._responseHandlers;try{for(var n=0;n<i.length;n++)try{i[n](t)}catch(t){$C(o,1,519,"Response handler failed: "+t)}if(t){var r=JSON.parse(t);IT(r.webResult)&&IT(r.webResult[Vb])&&d.set("MSFPC",r.webResult[Vb],31536e3)}}catch(t){}}function Q(e,t,i,n){if(e&&e.length>0&&r){var s=r[function(e){var t=sA[e];return IT(t)||(t="oth",e>=9e3&&e<=9999?t=Ab:e>=8e3&&e<=8999?t=Tb:e>=1e3&&e<=1999&&(t=Ib)),t}(t)];if(s){var a=0!==i;YC(l,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){K((function(){try{s.call(r,e,t,a,i)}catch(e){$C(o,1,74,"send request notification failed: "+e)}}),n||a,0)}),(function(){return{batches:$(e),reason:t,isSync:a,sendSync:n,sendType:i}}),!a)}}}e.initialize=function(e,t,i,n,r){var s;r||(r={}),f=e+f,P=!!hy(r.avoidOptions)||!r.avoidOptions,l=t,d=t.getCookieMgr(),R=!l.config.disableEventTimings;var S=!!l.config.enableCompoundKey;o=(a=i).diagLog();var v=r.valueSanitizer,y=r.stringifyObjects;hy(r.enableCompoundKey)||(S=!!r.enableCompoundKey),h=r.xhrTimeout,u=!!r.disableXhrSync,g=!!r.disableFetchKeepAlive,m=!1!==r.addNoResponse,C=!bC(),A=new tA(l,v,y,S),uy(r.useSendBeacon)||(C=!!r.useSendBeacon);var _=n,T=r.alwaysUseXhrOverride?n:null,I=r.alwaysUseXhrOverride?n:null,b=[3,2];if(!n){E=!1;var w=EC();w&&w.protocol&&"file:"===w.protocol.toLowerCase()&&(M=!1);var O=[];bC()?(O=[2,1],b=[2,1,3]):O=[1,2,3],(n=D(O=uA(O,r.transports),!1))||GC(o,"No available transport to send events"),_=D(O,!0)}T||(T=D(b=uA(b,r.unloadTransports),!0)),p=!E&&(C&&wC()||!g&&PC(!0)),(s={})[0]=n,s[1]=_||D([1,2,3],!0),s[2]=T||_||D([1],!0),s[3]=I||D([2,3],!0)||_||D([1],!0),c=s},e._getDbgPlgTargets=function(){return[c[0],S,A,c]},e.addQueryStringParameter=function(e,t){for(var i=0;i<T.length;i++)if(T[i].name===e)return void(T[i].value=t);T.push({name:e,value:t})},e.addHeader=function(e,t){I[e]=t},e.canSendRequest=function(){return V()&&y.allowRequestSending()},e.sendQueuedRequests=function(e,t){hy(e)&&(e=0),w&&(e=F(e),t=2),H(b,e,0)&&G(B(),0,!1,e,t||0)},e.isCompletelyIdle=function(){return!v&&0===_&&0===b.length},e.setUnloading=function(e){w=e},e.addBatch=function(e){if(e&&e.count()>0){if(S.isTenantKilled(e.iKey()))return!1;b.push(e)}return!0},e.teardown=function(){b.length>0&&G(B(),0,!0,2,2)},e.pause=function(){v=!0},e.resume=function(){v=!1,e.sendQueuedRequests(0,4)},e.sendSynchronousBatch=function(e,t,i){e&&e.count()>0&&(uy(t)&&(t=1),w&&(t=F(t),i=2),G([e],0,!1,t,i||0))}}))}return e.__ieDyn=1,e}();function pA(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];return setTimeout(e,t,i)}function mA(e){clearTimeout(e)}function fA(e,t){return{set:e||pA,clear:t||mA}}var SA="eventsDiscarded",vA="overrideInstrumentationKey",yA="maxEventRetryAttempts",CA="maxUnloadEventRetryAttempts",_A=function(e){function t(){var i,n=e.call(this)||this;n.identifier="PostChannel",n.priority=1011,n.version="3.2.9";var r,s,a,o,c,l,d,h=!1,u=[],g=null,p=!1,m=0,f=500,S=0,v=1e4,y={},C=Cb,_=null,E=null,T=0,I=0,b={},A=-1,R=!0,w=!1,P=6,M=2;return bS(t,n,(function(e,t){function n(e){"beforeunload"!==(e||SC().event).type&&(w=!0,s.setUnloading(w)),V(2,2)}function D(e){w=!1,s.setUnloading(w)}function O(e,t){if(e.sendAttempt||(e.sendAttempt=0),e.latency||(e.latency=1),e.ext&&e.ext[Bb]&&delete e.ext[Bb],e.ext&&e.ext[Hb]&&e.ext[Hb].id&&delete e.ext[Hb].id,R&&(e.ext=Wy(e.ext),e.baseData&&(e.baseData=Wy(e.baseData)),e.data&&(e.data=Wy(e.data))),e.sync)if(T||p)e.latency=3,e.sync=!1;else if(s)return R&&(e=Wy(e)),void s.sendSynchronousBatch(jb.create(e.iKey,[e]),!0===e.sync?1:e.sync,3);var i=e.latency,n=S,r=v;4===i&&(n=m,r=f);var a=!1;if(n<r)a=!$(e,t);else{var o=1,c=20;4===i&&(o=4,c=1),a=!0,function(e,t,i,n){for(;i<=t;){var r=B(e,t,!0);if(r&&r.count()>0){var s=r.split(0,n),a=s.count();if(a>0)return 4===i?m-=a:S-=a,Q(SA,[s],Yy.QueueFull),!0}i++}return G(),!1}(e.iKey,e.latency,o,c)&&(a=!$(e,t))}a&&Y(SA,[e],Yy.QueueFull)}function k(e,t,i){var n=j(e,t,i);return s.sendQueuedRequests(t,i),n}function N(){return S>0}function L(){if(A>=0&&j(A,0,c)&&s.sendQueuedRequests(0,c),m>0&&!E&&!p){var e=y[C][2];e>=0&&(E=U((function(){E=null,k(4,0,1),L()}),e))}var t=y[C][1];!_&&!g&&t>=0&&!p&&(N()?_=U((function(){_=null,k(0===I?3:1,0,1),I++,I%=2,L()}),t):I=0)}function x(){i=null,h=!1,u=[],g=null,p=!1,m=0,f=500,S=0,v=1e4,y={},C=Cb,_=null,E=null,T=0,I=0,r=null,b={},a=void 0,o=0,A=-1,c=null,R=!0,w=!1,P=6,M=2,l=null,d=fA(),s=new gA(500,2,1,{requeue:J,send:X,sent:Z,drop:ee,rspFail:te,oth:ie},d),z(),b[4]={batches:[],iKeyMap:{}},b[3]={batches:[],iKeyMap:{}},b[2]={batches:[],iKeyMap:{}},b[1]={batches:[],iKeyMap:{}},ne()}function U(e,t){0===t&&T&&(t=1);var i=1e3;return T&&(i=Jb(T-1)),d.set(e,t*i)}function F(){return null!==_&&(d.clear(_),_=null,I=0,!0)}function V(e,t){F(),g&&(d.clear(g),g=null),p||k(1,e,t)}function B(e,t,i){var n=b[t];n||(n=b[t=1]);var r=n.iKeyMap[e];return!r&&i&&(r=jb.create(e),n.batches.push(r),n.iKeyMap[e]=r),r}function H(t,i){s.canSendRequest()&&!T&&(a>0&&S>a&&(i=!0),i&&null==g&&e.flush(t,null,20))}function $(e,t){R&&(e=Wy(e));var i=e.latency,n=B(e.iKey,i,!0);return!!n.addEvent(e)&&(4!==i?(S++,t&&0===e.sendAttempt&&H(!e.sync,o>0&&n.count()>=o)):m++,!0)}function G(){for(var e=0,t=0,i=function(i){var n=b[i];n&&n.batches&&wy(n.batches,(function(n){4===i?e+=n.count():t+=n.count()}))},n=1;n<=4;n++)i(n);S=t,m=e}function j(t,i,n){var r=!1,a=0===i;return!a||s.canSendRequest()?YC(e.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var e=[],i=4;i>=t;){var n=b[i];n&&n.batches&&n.batches.length>0&&(wy(n.batches,(function(t){s.addBatch(t)?r=r||t&&t.count()>0:e=e.concat(t.events()),4===i?m-=t.count():S-=t.count()})),n.batches=[],n.iKeyMap={}),i--}e.length>0&&Y(SA,e,Yy.KillSwitch),r&&A>=t&&(A=-1,c=0)}),(function(){return{latency:t,sendType:i,sendReason:n}}),!a):(A=A>=0?Math.min(A,t):t,c=Math.max(c,n)),r}function q(e,t){k(1,0,t),G(),W((function(){e&&e(),u.length>0?g=U((function(){g=null,q(u.shift(),t)}),0):(g=null,L())}))}function W(e){s.isCompletelyIdle()?e():g=U((function(){g=null,W(e)}),.25)}function z(){(y={})[Cb]=[2,1,0],y.NEAR_REAL_TIME=[6,3,0],y.BEST_EFFORT=[18,9,0]}function J(t,i){var n=[],r=P;w&&(r=M),wy(t,(function(t){t&&t.count()>0&&wy(t.events(),(function(t){t&&(t.sync&&(t.latency=4,t.sync=!1),t.sendAttempt<r?(DT(t,e.identifier),O(t,!1)):n.push(t))}))})),n.length>0&&Y(SA,n,Yy.NonRetryableStatus),w&&V(2,2)}function K(t,i){var n=e._notificationManager||{},r=n[t];if(r)try{r.apply(n,i)}catch(i){$C(e.diagLog(),1,74,t+" notification failed: "+i)}}function Y(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&K(e,[t].concat(i))}function Q(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&wy(t,(function(t){t&&t.count()>0&&K(e,[t.events()].concat(i))}))}function X(e,t,i){e&&e.length>0&&K("eventsSendRequest",[t>=1e3&&t<=1999?t-1e3:0,!0!==i])}function Z(e,t){Q("eventsSent",e,t),L()}function ee(e,t){Q(SA,e,t>=8e3&&t<=8999?t-8e3:Yy.Unknown)}function te(e){Q(SA,e,Yy.NonRetryableStatus),L()}function ie(e,t){Q(SA,e,Yy.Unknown),L()}function ne(){o=i&&i.disableAutoBatchFlushLimit?0:Math.max(1500,v/6)}x(),e._getDbgPlgTargets=function(){return[s]},e.initialize=function(o,c,h){YC(c,(function(){return"PostChannel:initialize"}),(function(){var u=c;t.initialize(o,c,h);try{c.addUnloadCb,l=aE(h_(e.identifier),c.evtNamespace&&c.evtNamespace());var g=e._getTelCtx();o.extensionConfig[e.identifier]=o.extensionConfig[e.identifier]||{},i=g.getExtCfg(e.identifier),d=fA(i.setTimeoutOverride,i.clearTimeoutOverride),R=!i.disableOptimizeObj&&!!mC("chrome"),function(e){var t=e.getWParam;e.getWParam=function(){var e=0;return i.ignoreMc1Ms0CookieProcessing&&(e|=2),e|t()}}(u),i.eventsLimitInMem>0&&(v=i.eventsLimitInMem),i.immediateEventLimit>0&&(f=i.immediateEventLimit),i.autoFlushEventsLimit>0&&(a=i.autoFlushEventsLimit),Iy(i[yA])&&(P=i[yA]),Iy(i[CA])&&(M=i[CA]),ne(),i.httpXHROverride&&i.httpXHROverride.sendPOST&&(r=i.httpXHROverride),IT(o.anonCookieName)&&s.addQueryStringParameter("anoncknm",o.anonCookieName),s.sendHook=i.payloadPreprocessor,s.sendListener=i.payloadListener;var p=i.overrideEndpointUrl?i.overrideEndpointUrl:o.endpointUrl;e._notificationManager=c.getNotifyMgr(),s.initialize(p,e.core,e,r,i);var m=o.disablePageUnloadEvents||[];hE(n,m,l),uE(n,m,l),gE(D,o.disablePageShowEvents,l)}catch(t){throw e.setInitialized(!1),t}}),(function(){return{coreConfig:o,core:c,extensions:h}}))},e.processTelemetry=function(t,n){DT(t,e.identifier);var r=(n=e._getTelCtx(n)).getExtCfg(e.identifier),s=!!i.disableTelemetry;r&&(s=s||!!r.disableTelemetry);var a=t;s||h||(i[vA]&&(a.iKey=i[vA]),r&&r[vA]&&(a.iKey=r[vA]),O(a,!0),w?V(2,2):L()),e.processNext(a,n)},e._doTeardown=function(e,t){V(2,2),h=!0,s.teardown(),function(e,t){dE([z_,W_,j_],e,t)}(null,l),function(e,t){var i=aE(J_,t);dE([j_],e,i),dE([G_],null,i)}(null,l),function(e,t){var i=aE(K_,t);dE([q_],e,i),dE([G_],null,i)}(null,l),x()},e.setEventQueueLimits=function(e,t){v=e>0?e:1e4,a=t>0?t:0,ne();var i=S>e;if(!i&&o>0)for(var n=1;!i&&n<=3;n++){var r=b[n];r&&r.batches&&wy(r.batches,(function(e){e&&e.count()>=o&&(i=!0)}))}H(!0,i)},e.pause=function(){F(),p=!0,s.pause()},e.resume=function(){p=!1,s.resume(),L()},e.addResponseHandler=function(e){s._responseHandlers.push(e)},e._loadTransmitProfiles=function(e){F(),z(),C=Cb,L(),vy(e,(function(e,t){var i=t.length;if(i>=2){var n=i>2?t[2]:0;if(t.splice(0,i-2),t[1]<0&&(t[0]=-1),t[1]>0&&t[0]>0){var r=t[0]/t[1];t[0]=Math.ceil(r)*t[1]}n>=0&&t[1]>=0&&n>t[1]&&(n=t[1]),t.push(n),y[e]=t}}))},e.flush=function(e,t,i){if(void 0===e&&(e=!0),!p)if(i=i||1,e)null==g?(F(),j(1,0,i),g=U((function(){g=null,q(t,i)}),0)):u.push(t);else{var n=F();k(1,1,i),null!=t&&t(),n&&L()}},e.setMsaAuthTicket=function(e){s.addHeader(Ub,e)},e.hasEvents=N,e._setTransmitProfile=function(e){C!==e&&void 0!==y[e]&&(F(),C=e,L())},e._backOffTransmission=function(){T<4&&(T++,F(),L())},e._clearBackOff=function(){T&&(T=0,F(),L())},Ny(e,"_setTimeoutOverride",(function(){return d.set}),(function(e){d=fA(e,d.clear)})),Ny(e,"_clearTimeoutOverride",(function(){return d.clear}),(function(e){d=fA(d.set,e)}))})),n}return qf(t,e),t.__ieDyn=1,t}(BE),EA=_A,TA="_dropInst";function IA(e,t){if(t)for(var i=ky(t),n=0;n<i.length;n++){var r=i[n];py(e,r)||(e[r]=t[r])}}function bA(e,t){var i=null;if(t){t.endpointUrl&&(i=t.endpointUrl);var n=(t.extensionConfig||{})[e]||{};n.overrideEndpointUrl&&(i=n.overrideEndpointUrl)}return i}var AA=function(e){function t(i,n){var r=e.call(this)||this;return bS(t,r,(function(e,t){function r(e){var t=[];return e&&wy(e,(function(e){e.iKey===i&&t.push(e)})),t}function s(t){if(e[t]&&e.listeners)for(var i=0;i<e.listeners.length;i++){var n=e.listeners[i];if(n&&n[t])return!0}return!1}var a={eventsSent:function(t){if(s("eventsSent")){var i=r(t);i.length>0&&e.eventsSent(i)}},eventsDiscarded:function(t,i){if(s("eventsDiscarded")){var n=r(t);n.length>0&&e.eventsDiscarded(n,i)}},eventsSendRequest:function(t,i){s("eventsSendRequest")&&e.eventsSendRequest(t,i)},perfEvent:function(t){s("perfEvent")&&e.perfEvent(t)}};n.addNotificationListener(a)})),r}return qf(t,e),t.__ieDyn=1,t}(XE),RA=function(){function e(){var t,i,n,r,s,a,o,c,l,d,h,u,g,p,m=null,f=null;bS(e,this,(function(e){function S(){t={},i=[],n=null,r=null,s=[],a=[],o={},c=null,l=null,d=null,h=null,u=null,g=null,p=!1}function v(e,i){if(void 0===i&&(i=null),e){(!function(e){return e.pause&&e.teardown&&e.flush}(e)?s:a).push(e);var n=e.identifier;t.extensionConfig[n]=t.extensionConfig[n]||{},IA(t.extensionConfig[n],i)}return e}function y(e){i=[],c=v(new sb,t.propertyConfiguration),i.push(c),t.extensions&&wy(t.extensions,(function(e){fy(e)||v(e)})),e&&wy(e,(function(e){e&&!fy(e)&&i.push(v(e))}))}function C(s){if(!n){p||$C(e.diagLog(),2,520,"The Shared Manager is not yet created, the returned shared instance will be overwritten");var a=_(s||t.instrumentationKey||"_not_defined_",{});r=new XE,(n=new wA(e,e.diagLog(),r)).initialize(a,i),n.isInitialized()&&l&&(d=bA(l.identifier,a)),m&&n.setCookieMgr(m)}}function _(e,i){var n={};return n.instrumentationKey=e,n.channels=function(e){var i=[[]];return t.channels&&wy(t.channels,(function(e,t){fy(e)||(i[t]=i[t]||[],i[t]=i[t].concat(e))})),e&&e.channels&&wy(e.channels,(function(e,t){fy(e)||(i[t]=i[t]||[],i[t]=i[t].concat(e))})),i}(i),function(e){var i=[];t.extensions&&t.extensions.length>0&&(i=i.concat(t.extensions)),e&&e.extensions&&e.extensions.length>0&&(i=i.concat(e.extensions)),i.length>0&&(e.extensions=i),e.extensionConfig=e.extensionConfig||{},IA(e.extensionConfig,t.extensionConfig)}(n),IA(n,i),IA(n,t),n}function E(e){var t=[];return i&&i.length>0&&(t=t.concat(i)),e&&e.length>0&&(t=t.concat(e)),t}S(),e.diagLog=function(){return h||(h=new BC(t)),h},e.getCookieMgr=function(){return C(),m||n.getCookieMgr()},e.setCookieMgr=function(e){m=e,n&&n.setCookieMgr(e)},e.getPerfMgr=function(){return g||t&&t.enablePerfMgr&&(g=f||new JC(e.getNotifyMgr())),g},e.setPerfMgr=function(e){f=e,g=e},e.create=function(i,r){p?$C(e.diagLog(),2,514,"Shared Manager has already been initialized."):(t=i||{},n=null,function(){var e=t.channels||[[]],i=new EA,n=i.identifier,r=!1;l=null,d=null,wy(e,(function(e){wy(e,(function(e){fy(e)||(v(e),e.identifier===n&&(r=!0,l=e))}))})),r||(e[0].push(i),l=v(i,t.channelConfiguration)),t.channels=e}(),y(r))},e.getInst=function(e){return(o[e]||{}).inst},e.newInst=function(t,i,s){var a=e.getInst(t);if(a)return $C(e.diagLog(),2,514,"Instance already exists for ["+t+"]"),a;if(C(t),n.isInitialized()){var c=_(t,i);if(l){var h=bA(l.identifier,c);d&&h&&d!==h&&$C(e.diagLog(),2,511,"The endpointUrl mismatch, shared Url ["+d+"] is different from configured ["+h+"] shared will be used!")}var u=new AA(t,r);a=new wA(e,e.diagLog(),u),o[t]={iKey:t,inst:a,notifyMgr:u},a.setPerfMgr(e.getPerfMgr()),a.initialize(c,E(s)),a.isInitialized()||($C(e.diagLog(),2,520,"Failed to initialize new instance!"),a=null,delete o[t])}return a},e.getSharedPlugin=function(e){C();var t=null,i=n.getPlugin(e);return i&&(t=i.plugin),t},e.getPropertyManager=function(){return C(),c},e.getPostChannel=function(){return C(),l},e.getNotifyMgr=function(){return u||(u=new XE),u},e.unload=function(e,t,i){var r=ky(o),s=r.length+1,a={reason:50,isAsync:e,flushComplete:!1};function c(e,i){0==--s&&(S(),t&&t(i))}n&&(wy(r,(function(t){!function(e,t,i,n){var r=o[e];r&&(r.inst&&r.inst.isInitialized()?r.inst.unload(t,(function(t){i&&i(e,t)}),n):i&&i(e,{reason:50,isAsync:t,flushComplete:!1}))}(t,e,(function(e,t){c(0,t)}),i)})),n.isInitialized()&&(n.unload(e,(function(e){c(0,a=e)}),i),n=null)),c(0,a)},e[TA]=function(e){e&&o.iKey&&delete o[e]}}))}return e.__ieDyn=1,e}(),wA=function(e){function t(i,n,r){var s,a=e.call(this)||this,o=i;return bS(t,a,(function(e,t){e.getSharedPropertyManager=function(){return o.getPropertyManager()},e.getSharedPostChannel=function(){return o.getPostChannel()},e.getOverridePropertyManager=function(){return s},e.initialize=function(i,a){YC(e,(function(){return"ApplicationInsights:initialize"}),(function(){var o=[s=new yb];a&&(o=o.concat(a)),i.extensionConfig=i.extensionConfig||[];var c=i.propertyConfiguration||{};i.propertyConfiguration&&delete i.propertyConfiguration,i.extensionConfig[s.identifier]=c;try{t.initialize(i,o,n,r)}catch(t){$C(e.logger,1,514,"Failed to initialize SDK."+RC(t))}}),(function(){return{config:i,extensions:a}}))},e.unload=function(i,n,r){o[TA]&&o[TA]((e.config||{}).instrumentationKey),t.unload(i,n,r)}})),a}return qf(t,e),t.__ieDyn=1,t}(NT);var PA=class{getInitialSettings(){return{resizeModeForSharing:"none",enableAudioProcessingFallback:!1,allowVirtualDeviceInCall:!1,activeSpeaker:{timeToPromote:1e4},dtmf:{toneDuration:200,toneGap:100},mediaStreamHoldInterval:5e3,webrtcContributingSourcesPollingInterval:1e3,webrtcIceGatheringTimeoutMs:2e4,webrtcAllowedMediaContentType:Qe.ALLOWED_CONTENT_TYPES.SDP_NGC,webrtcMediaContentType:Qe.CONTENT_TYPE.SDP,webrtcScreensharingCapabilityMaxFS:8160,webrtcScreensharingCapabilityMaxFPS:1500,webrtcStatHwSilentDetectionDuration:5,webrtcStatHwSilentDetectionLevel:14,webrtcStatPollInterval:1e3,webrtcStatStoredRecordsNumber:60,webrtcStatNetworkDetectionDuration:10,webrtcHealedRatioWindowSize:5,webrtcHealedRatioExtendedWindowSize:20,webrtcStatNetworkDetectionHysteresis:.01,webrtcStatNetworkDetectionBadLevel:.17,webrtcStatNetworkDetectionGoodLevel:.15,webrtcMinAudioSamplesRecvForNetworkRecvQuality:48e4,webrtcVideoCapabilityCheckIntervalMin:2e4,webrtcVideoCapabilityCheckIntervalMinMultiparty:5e3,webrtcVideoCapabilityCheckIntervalMax:3e4,webrtcVideoCapabilityCheckIntervalMaxMultiparty:5500,webrtcScreensharingCapabilityCheckIntervalMin:0,webrtcScreensharingCapabilityCheckIntervalMax:0,webrtcVideoCapabilityMaxFS:3600,webrtcVideoCapabilityMaxFPS:3e3,webrtcMultiPartyRecvVideoMaxFS:3600,webrtcRecvVideoMaxFS:8160,webrtcCameraOpenFs:3600,minCameraOpenFps:15,maxCameraOpenFps:30,webrtcMultipartyMaxScalingFs:3600,webrtcMaxScalingFs:8160,webrtcVideoScaling:!1,webrtcVideoScalingMultiparty:!0,enableOptimalVideoCount:!1,ovcBandwidthPerVideoReceiver:2e5,ovcSlidingWindowPercentile:.3,ovcSlidingWindowSamples:20,nonEstimatedDefaultVideoReceiversCount:4,ovcMaxCount:4,ovcMaxCountXL:4,ovcXLParticipantsCount:100,ovcIgnoreFirstSamples:10,ovcAvailableConcurrencyForBiggerGrid:4,ovcMemoryForBiggerGrid:2,ovcRampUpCooldown:15e3,ovcRampDownCooldown:1e4,webrtcStatNetworkDetectionEnabled:!0,webrtcUseNewStatsApi:!0,useAudioAnalyzer:!0,webrtcVideoSubscriptionDisposeTimeout:2e3,webrtcCompareContentTypeInOffer:!0,iceServerTransport:"udp,tcp,tls",iceHostCandidateOnly:!0,iceUdpAddressType:"ip",iceTcpAddressType:"ip",renegotiationAttempts:3,reconnectTimeLimit:9e4,initialReconnectTimeLimit:0,maxReconnectDelayTime:5,waitForRelayOnReconnect:!0,relayWaitSaneTimeoutMs:25e3,reconnectOnDisconnect:!1,reconnectWithNoRelays:!1,reconnectWithProbes:!1,reconnectWaitTimeAfterProbe:1e3,reconnectOnPcClose:!0,reconnectWakeupTimeLimit:18e4,webrtcSpeakingWhileMutedDetectionWindow:3,webrtcSpeakingWhileMutedBadDuration:3,webrtcSpeakingWhileMutedDetectionLevel:4e3,webrtcNegotiateDisabledDataModality:!1,recoverableMediaErrors:[Qe.MEDIA_ERROR.iceConnectionError,Qe.MEDIA_ERROR.noNetworkError,Qe.MEDIA_ERROR.srtpError,Qe.MEDIA_ERROR.incompatibleOffer,Qe.MEDIA_ERROR.internalError].join(","),forceReconnectErrors:[Qe.MEDIA_ERROR.audioPlaybackError].join(","),sendCallStartupTelemetry:!0,webrtcMultiPartyRecvVideoSignaling:!0,webrtcVideoDelayThreshold:10,webrtcEndOfCallFreezeThreshold:3,webrtcSubscriptionEventLimit:300,webrtcHandleRollback:!0,webrtcHandleRemoteRollback:!1,losingConnectivityTimeoutMs:-1,iceCandidateFilterMDns:!0,webrtcInjectTransportCCAudio:!1,webrtcInjectTransportCCAudioMultiparty:!0,webrtcRejectedFeatures:"byPass",webrtcRequiredFeatures:"nonByPass",webrtcSimulcastSessionEnabled:!1,webrtcSimulcastStreamsCountForVideo:1,webrtcSimulcastStreamsCountForSharing:1,webrtcFmtParamListSupported:!0,webrtcNegotiatedSsrcRangeForVideo:0,webrtcNegotiatedSsrcRangeForSharing:0,webrtcNegotiatedSsrcRangeForVideoOneToOne:0,webrtcNegotiatedSsrcRangeForSharingOneToOne:0,webrtcAllowRestoreKeyframe:!1,webrtcEnabledCustomBwEstimationForVideo:!1,webrtcDisabledSenderBitrate:1e3,maxStoredPreferredResolutionCount:4,maxStoredQualityLimitationReasonEvents:30,maxStoredUFDCount:50,simulcastTelemetryLayoutsPerSession:5,simulcastTelemetryNumModalitySessions:3,simulcastTelemetryNumFMTP:10,maxSendVideoCapabilitiesReportingForVideoEnabled:!1,maxSendVideoCapabilitiesReportingForSharingEnabled:!1,maxSendVideoCapabilitiesReportingUseMaximumWidthHeight:!0,maxSendVideoCapabilitiesReportingSendMaxFs:!1,maxSendVideoCapabilitiesReportingSendMaxMbps:!1,maxReportedOvershootingEvents:20,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!0,adpRequestAVLast:!0,rememberNegative:!1,persistOnDeniedError:!0,disableOnPermissionDeniedOnly:!1},devices:{blacklist:{microphone:"stereo mix \\(",camera:"(ir camera|avstream media device)",speaker:"stereo mix \\("},overrideDefault:!1,compositeLabelMatchingThreshold:.5,piiSafeWords:["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"],pollingIntervalActive:3e3,enumerateDevicesTimeout:25e3,enumerateDevicesAfterADP:!1},useGoogPrefixAudioConstraints:!0,multiviewResolutionLimits:{1:720,2:720,3:540,4:360,more:360},maxSpotlightResolution:720,multiviewResolutionLimitUpdateThrottleDelay:300,useMultiviewLimitsOnInitialRequest:!0,useApplyChannelParametersForSourceRequests:!0,maxVideoFreezeTimestampsInBucket:5,webrtcSendBandwidthNotificationsEnabled:!1,webrtcSendBandwidthIgnoredUpdateLimit:6,webrtcSendBandwidthThreshold:.1,checkSupportForWebrtc_1_0:!1,webrtcLastAppliedVideoCapabilitiesCount:5,webrtcLastAppliedVideoCapabilitiesSequenceCount:5,gumRequestTimeout:2e4,overrideGumFromWebkit:!1,setMinFpsForWebkit:!1,videoCaptureFreezeTimeout:5e3,webrtcCloseAfterIceFailure:!0,audioBandwidthInKbps:90,videoBandwidthAllocation:.3,enableQosSupport:!1,forceUnbundledTransport:!1,allowedAudioCodecs:[],allowedVideoCodecs:[],allowedVideoCodecsMultiparty:[{clockRate:9e4,mimeType:"video/H264"},{clockRate:9e4,mimeType:"video/rtx"}],filterCodecsInSdp:!1,filterCodecsInSdpMultiparty:!0,filterCodecsInSdpV2:!1,reduceRtcpFbInSdp:[],reduceRtcpFbInSdpMultiparty:["goog-remb","transport-cc","ccm/fir","nack","nack/pli"],subscribeToSsrcForVideo:!1,audioRendererUsePauseOnDetach:!0,audioRendererRestartOnPause:!1,audioRendererRestartOnDeviceError:!0,disableAudioOutputSelection:!1,preferSdesSrtp:!1,preferSdesSrtpPstn:!1,useLocalStorageForOneDs:!0,useOneDsLogger:!1,useSendBeaconSync:!1,addTelemetryReportingCallback:!0,eventsLimitInMem:200,eventLatency:fT.Normal,eventLatencyRealTime:fT.RealTime,enableCompoundKey:!1,telemetryTenants:{signaling:"53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",media:"1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",realtimeMedia:"5aea257f81424f5d8574e57a50974ead-d3a768ce-590c-4595-ab85-3dd046114290-6701",tlePlayer:"2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326"},transmitProfileName:"REAL_TIME",transmitProfileTimings:[],waitReportStatsAtCallStop:!1,oneStreamPerDeviceType:!1,enableWebRtcInternalsLogs:!1,enableMultiViewStats:!0,webrtcBWJumpLowerLimit:1e5,webrtcBWJumpUpperLimit:3e5,uplinkBWStabilizationSlidingWindowSize:10,uplinkBWStabilizationMaxDeviation:.1,uplinkBWStabilizationMinBandwidth:1e5,downlinkBWStabilizationSlidingWindowSize:10,downlinkBWStabilizationMaxDeviation:.1,downlinkBWStabilizationMinBandwidth:1e5,maxKeyFrameTimestampsInBucket:5,enableAudioSharing:!1,enableStopSharingWithIncomingOffer:!0,enableDevtoolsAPI:!1,enableDataChannel:!1,enableDataChannelMultiparty:!0,enableDataChannelPstn:!1,alwaysNegotiateDataChannel:!0,webrtcDataChannel:{enableFragmentation:!1,fragmentationSize:0,enableSendScheduler:!1,rateLimiterCheckInterval:250,discardOnSendFailure:!1,bufferedAmountLowThreshold:65535,bufferedAmountHighThreshold:262144,maxBitrate:0,maxPacketRate:0,maxQueueSize:524288,dataIds:[]},acceptDisabledDataModality:!0,rejectUnbundledDataModality:!0,sctpPort:5e3,enableGiveControl:!1,maxStoredDataChannelValues:15,mediaControlPlaneConfig:{enableBweNotifications:!0,enableDominantSpeakerHistory:!0,enableSourceRequests:!1,sourceRequestsMessagesTimeout:1e4,storedSRRecordsCount:60,verboseTelemetry:!1,sendDuplicates:!1},localPreviewMirroringSupported:!1,enableVideoEffects:!0,useRawMediaApiForVideoEffects:!1,forceKeyFrameV2ScaleFactor:1.1,effectsTelemetryBufferSize:20,useGenericWorkerLoader:!1,applyAudioEffectOnDemand:!1,wasmdns:{pTime:10,goodPerfThreshold:8,poorPerfThreshold:10,badPerfThreshold:12,perfWindowLength:10,enableNoiseSuppression:!1,noiseSuppressionMode:"Off",backgroundMode:!1},wasmvqe:{enableAec:!1,enableVqe:!1,backgroundMode:!1,performanceThresholdMs:8,performanceWindowDurationSecs:10,defaultVqeMode:Su.VqeMode.Off,callType:Su.CallType.Conference,audioUsageMode:Su.AudioUsageMode.Default,performanceProfile:Su.AecPerfProfile.Normal},webcv:{qualityConfig:{outputFps:{min:15,max:30},outputResolution:720,preserveResolution:!0,degradationLadder:[{resolution:{width:1920,height:1080},fps:{min:15,max:30}},{resolution:{width:1280,height:720},fps:{min:15,max:30}},{resolution:{width:960,height:540},fps:{min:15,max:30}},{resolution:{width:640,height:360},fps:{min:13,max:30}},{resolution:{width:416,height:234},fps:{min:10,max:20}},{resolution:{width:320,height:180},fps:{min:10,max:20}}],initialLadderResolution:720,improvementFpsThresholdPercent:20,statsIntervalSec:5,enableMaskPropagation:!1,maskPropagationFramesInterval:30},powerPreference:fu.PowerPreference.HighPerformance,useInsertableStreams:!1,webGLUnsupportedRenderers:["Google SwiftShader"],webGLRequiredExtensions:["EXT_color_buffer_float","WEBGL_debug_renderer_info","OES_texture_float_linear"],usePreheat:!1,useSharedArrayBuffer:!0,useWasmEffects:!1,processorType:fu.ProcessorType.Webgl2},insertFakeCandidateIfNeeded:!0,useSdpCapabilitiesLegacySession:!0,useSdpCapabilities:!0,enableH264SpsPpsIdrKeyframe:!0,disableMsSdp:!1,disableSdes:!1,disableIceReinvite:!1,iceDisconnectedTimeoutMs:3e4,enableLocalVideoConstraints:!0,webrtcAudioChannelSignalingFeedback:"app recv:dsh",webrtcVideoChannelSignalingFeedback:"app send:src recv:src,vc",webrtcResolutionManagerCooldownTimeout:15e3,webrtcResolutionManagerRetryDelay:5e3,webrtcNativeCpuOveruseDisabled:!1,webrtcDisplayStreamContentHint:"text",h264SendProfileOverride:"42C02A",addFmtpToInitialSubscription:!0,h264SubscribeProfile:"64001f",notRenderingTimeInterval:{video:3,sharing:10},notRenderingLowBitrateThreshold:6,notRenderingLowFramerateThreshold:3,isBytesRecvUsedInIsRenderingCalculation:!0,useConnectionState:!0,useDtlsTrasportConnectionCheck:!1,enableNetworkRecvQualityUFD:!0,enableNetworkSendQualityUFD:!0,enableSignalingAudioPermissionDeniedUFD:!1,webrtcJitterLowThreshold:.2,webrtcJitterHighThreshold:.35,webrtcJitterSticknessTime:5e3,webrtcLossRateLowThreshold:.2,webrtcLossRateHighThreshold:.3,webrtcLossRateSticknessTime:5e3,webrtcMinPacketsSentForNetworkSendQuality:200,webrtcLossRateWindowSize:3,webrtcJitterWindowSize:3,networkSendQualityDiagnostics:!1,networkRecvQualityDiagnostics:!1,webrtcJitterExtendedWindowSize:6,webrtcLossRateExtendedWindowSize:6,freezeMinDuration:128,freezeIntervalFrequency:1e3,minPacketsReceivedToCalculatePacketLossRate:100,healedRatioPrecision:8,jitterPrecision:3,requestNewStreamOnUnmute:!0,raiseVideoMuteUfd:!1,useMediaQualityController:!1,useMediaQualityControllerForceKeyFrame:!1,layoutControlTimeout:1e4,extmapAllowMixed:!1,enableVla:!1,allowRemoteVla:!1,enableNonAdvVla:!1,specCompliantSimulcast:{},specCompliantSimulcastMultiparty:{video:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1],minFsForSimulcast:920,useApplyConstraints:!1},sharing:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1]},allowOverride:!1,constraintsDisableVla:!0,collectResolutionInfo:!0,maxBrControlEnabled:!1,allowedBweOvershootRatio:1,allowResLimit:!1},enforceOpusFmtpMultiparty:{usedtx:1},videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!1,mapSsrcToTrackForStats:!1,enableVideoOrientationExtension:!1,speakerGainLevel:0,ignoreClosedDtlsTransportState:!1,disconnectOnPageHide:!0,renderThroughCanvas:!1,isRenderingBasedOnRawStatistics:!1,enableDevicePixelRatio:!0,useSetParametersToApplyCapabilities:!1,enablePlatformCallConstraints:!1,enablePlatformCallConstraintsPerCall:!1,enableDynamicCallConstraints:!0,numCallConstraintsEvents:6,setParametersMaxBitrateUndefined:!1,onAddTrackRemoveOtherTracks:!0,avoidFakeStreamsDuringEscalation:!0,navConnectionPollingInterval:1e3,navConnectionNumSamplesToCollect:60,allowProvisionalAnswer:!1,allowProvisionalAnswerPstn:!0,acceptProvisionalAnswerFromPstnOnly:!0,disableIncomingDtlsRoleOverride:!1,disableOutgoingDtlsRoleOverride:!1,statsAllowAnyVideoSendTrack:!1,pictureInPicture:{enablePictureInPicture:!1,aspectRatioHorizontal:16,aspectRatioVertical:9,maxActiveStreams:1,minStreamGridCellWidth:160,dominantStreamChangeDebounce:3e3,statisticsBufferSize:20,multiStreamWorkerURL:""},showStatsInCall:!1,useSetStreamsForSender:!0,addPrefixForMsidInSdp:!1,enableMuteSpeakerUnmuteSpeakerWorkaround:!1,alwaysRaiseBadDeviceEvents:!1,removeRecvStreamOnEnded:!0,requiredVideoCodecs:["h264"],primaryVideoCodecs:["h264","vp8","vp9"],removeUnsupportedVideoModality:!1,enableActiveSpeakerBasedDSH:!0,enableInitialSignalingDSHSubscription:!0,enableSignalingDSHFallback:!1,emptyInitialDSH:!0,bwPercentiles:[5,50,95],enableTimerTracker:!1,diagnostics:{sideBySide:!0,useForTelemetry:!1,collectWhileNotConnected:!1,collectionLimits:{numDeviceEvents:200,numVideoEffectsEvents:100,numAudioEffectsEvents:100,numOvershootEvents:100,numIsRenderingEvents:100,numStatsReports:600,numStatsErrors:100,numSubscriptionEvents:100,numUFDs:100,numNativeSessions:3,numSessions:3,numNetworkEvents:50,numReconnects:50,numCapabilitiesRequested:60,numCapabilitiesApplied:60,maxVideoStatsAfterSubscription:30,numResolutionSwitches:10,numSamplesForE2E:4},telemetryLimits:{numDeviceEvents:50,numVideoEffectsEvents:50,numAudioEffectsEvents:50,numOvershootEvents:20,numIsRenderingEvents:4,numPreferredResolutions:3,numSubscriptionEvents:100,numUFDs:50,numAggregatedSamples:60,numStatsErrors:20,numCapabilitiesRequested:5,numCapabilitiesApplied:3,maxVideoStatsAfterSubscription:30,numNetworkEvents:20,numReconnects:10,numRendererStateChangedEvents:10},teamsRealtimeTelemetry:{pollingInterval:15},performanceMonitoring:{useComputePressure:!1,fluctuationSamplesNum:5,enableRemoteVideoCalculator:!1,enableLowerResolution:!1,monitoringStrategy:"decodeTime",decodeThresholds:{1080:{fps:30,maxDecodeTime:20},720:{fps:30,maxDecodeTime:15},540:{fps:30,maxDecodeTime:11},360:{fps:30,maxDecodeTime:9},234:{fps:15,maxDecodeTime:10},180:{fps:15,maxDecodeTime:10}},defaultThrehold:{fps:30,maxDecodeTime:60},fpsDiffThresholds:{1080:{fps:30,fpsDiff:4},720:{fps:30,fpsDiff:4},540:{fps:30,fpsDiff:4},360:{fps:30,fpsDiff:4},234:{fps:15,fpsDiff:2},180:{fps:15,fpsDiff:2}},defaultFpsDiffThreshold:{fps:30,fpsDiff:10},volatilityThresholds:{1080:10,720:10,540:10,360:10,234:5,180:5},defaultVolatilityThreshold:10,remoteVideoTrackInterval:10,telemetryResolutionRequestSpanMs:5e3,cpuMetricCollector:3},features:{takeFreezeTelemetryFromGathererV2:!0,useLastSampleDeltaPerSecondConverter:!1,useNewerStatisticsMetrics:!1,useNewNetworkUFD:!1,useNewSpeakingWhileMutedUFD:!1,useNewSendBandwidthCalculation:!1,useNewStatsForLocalVideoStreamWatcher:!1}},requireUserActionForAudioSharing:!1,postponeAudioMixerForAudioSharing:!1,reassignMediaStreamAudioTrackAfterCreation:!1,deactiveAudioSender:!1,webrtcForceSdesForS1:!1,webrtcPranswerWaitForMediaPollingInterval:1e3,webrctRemoveVideoModalitiesForPstn:!1,removeSendersOnConfigureModalities:!0,streamAvailabilityConsiderModalities:!0,setBWSeed:!1,bwSeedOptions:{mids:["*"],aggregation:"const",aggregateLastN:null,constValue:-1,minValue:-1,cappingValue:-1,useLocalStorage:!1,localStorageKey:"bwSeed"},stopCallOnAcceptFailure:!0,allowMediaBypass:!0,enablePermissionsWorkaround:!1,disposeSendersSync:!1,disposeStreamsSync:!1,maxVideoStatsAfterSubscription:30,ecsConfigTimeout:2e4,contributingSourcesLogInterval:1e4,useNewTokenApi:!1,audioRendererFailedReconnectTimes:0,audioRendererFailedRetryCodes:[3],effectsApplyConstraintsRetryMs:1e3,isSpotlightEnabled:!0,addAudioStreamBeforeConnection:!1,redReceiveEnabled:!1,mediaEventDictionary:Qe.MEDIA_EVENT_FIELDS,useSenderV2:!0,applySenderParamsBeforeStart:!0,reuseLastSetParameters:!1,hevcCodecs:["hev1.1.6.L120.90","hev1.1.4.L93.B0","hev1.1.6.L93.B0"],useInactiveAudioTrack:!1,enableRollbackHandler:!1,disableImmidiateEscalationReconnect:!1,enableCachingFMTP:!0,setDisconnectAfterCleanUp:!1,sendResolutionTableOverride:Qe.RES_TABLE.SEND,recvResolutionTableOverride:Qe.RES_TABLE.RECV,maxSendVideoCapabilitiesReportingForVideoEnabledMultiparty:!0,participantStreamInitialSubscriptions:!0,holdRetryActivationDelay:-1,holdSkipActivation:!0,recoverOnStreamUnmute:!1,isAv1Allowed:!1,audioSharingMemoryLeakFix:!0,h264SdpProfileMultiparty:"64001f",rejectIncompatibleOriginator:!1,coeffOfValidTimeDelayBetweenFramesArrival:2,invalidFPSAboveMax:40,useWakeLockApi:!1,noRequiredCodecsWorkaround:!1,vdiDisconnectedTracking:{enabled:!0,clientPhrases:["failure"]},multiStreamSupported:!1,nonMultiStreamChannels:9,useTokenMigrationHeader:!1,clientSupportsAadToken:!1,clientSupportsCaeToken:!1,clientSupportsSkypeToken:!0,supportMissingTokenTypesInResponse:!0,useSkypeTokenWhenNoAuthenticateHeader:!1,useKeyFrameApi:!1,useDeviceHandleForLocalVideo:!0,enablePlayVideoOnStreamUnmuteWorkaround:!1}}getEnforcedSettings(){return{}}},MA=class extends PA{getInitialSettings(){const e=super.getInitialSettings();return e.oneStreamPerDeviceType=!0,e.removeUnsupportedVideoModality=!0,e}},DA=class extends PA{constructor(){super()}getEnforcedSettings(){return{useAudioAnalyzer:!1,enableAudioSharing:!1}}},OA=class extends MA{constructor(e){super(),this.browserInfo=e}getEnforcedSettings(){const e={webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!1,adpRequestAVLast:!1,rememberNegative:!1},devices:{pollingIntervalIdle:1e4},audioRendererRestartOnPause:!0,subscribeToSsrcForVideo:!0,noRequiredCodecsWorkaround:!0};return Cm(this.browserInfo.version,"15.0")||(e.statsAllowAnyVideoSendTrack=!0),Cm(this.browserInfo.version,"16.0")&&"Mobile"===this.browserInfo.formFactor&&(e.enablePermissionsWorkaround=!0),Cm(this.browserInfo.version,"17.0")&&"Mobile"===this.browserInfo.formFactor&&(e.recoverOnStreamUnmute=!0),e}},kA=class extends MA{getEnforcedSettings(){return{webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useDtlsTrasportConnectionCheck:!0,videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!0,mapSsrcToTrackForStats:!0,ignoreClosedDtlsTransportState1on1:!0,subscribeToSsrcForVideo1on1:!0,devices:{enumerateDevicesTimeout:0,pollingIntervalIdle:1e4,idlePollingOnStart:!0},webrtcInjectTransportCCAudioMultiparty:!1,videoCaptureFreezeTimeout:0,filterCodecsInSdp:!0,useSetParametersToApplyCapabilities:!0,removeRecvStreamOnEnded:!0,webrtcDisabledSenderBitrate:0,disableAudioOutputSelection:!0}}},NA=class extends PA{constructor(){super()}getEnforcedSettings(){return{checkSupportForWebrtc_1_0:!0,requireUserActionForAudioSharing:!0,webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useAudioAnalyzer:!1,enablePlatformCallConstraints:!0,specCompliantSimulcastMultiparty:{video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!1,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0,allowOverride:!0},extmapAllowMixedMultiparty:!0,enableVlaMultiparty:!0,allowRemoteVlaMultiparty:!0,enableNonAdvVlaMultiparty:!0,useMediaQualityControllerMultiparty:!0,useSdpCapabilities:!1}}},LA=class extends MA{constructor(e){super(),this.browserInfo=e}getEnforcedSettings(){const e={};return Cm(this.browserInfo.version,"74.0")&&(e.webrtcSimulcastSessionEnabled=!0,e.webrtcAllowRestoreKeyframe=!0,e.enableAudioSharing=!0),"RoomAudioProcessing"===this.browserInfo.formFactor&&(e.defaultAudioProcessingFlags=0,e.wasmvqe={enableAec:!1,enableVqe:!1,backgroundMode:!1},e.wasmdns={enableNoiseSuppression:!1,backgroundMode:!1}),"CiscoOS"===this.browserInfo.name&&(e.waitReportStatsAtCallStop=!0),"Mobile"===this.browserInfo.formFactor&&(e.enableAudioSharing=!1,e.audioRendererFailedReconnectTimes=3,e.devices={pollingIntervalIdle:1e4}),"SamsungTV"===this.browserInfo.name&&(e.useSetParametersToApplyCapabilities=!0),Cm(this.browserInfo.version,"98.0")&&"Desktop"===this.browserInfo.formFactor&&(e.specCompliantSimulcastMultiparty={video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!0,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0},e.extmapAllowMixedMultiparty=!0,e.enableVlaMultiparty=!0,e.allowRemoteVlaMultiparty=!0,e.enableNonAdvVlaMultiparty=!0,e.useMediaQualityControllerMultiparty=!0),Cm(this.browserInfo.version,"100.0")&&(e.redReceiveEnabledMultiparty=!0),e.webcv={useWasmEffects:!0,processorType:fu.ProcessorType.Wasm},e}},xA=class{constructor(e){this.settings=e,this.isTransportUnbundled=!1,this.webrtcRejectedFeatures="",this.webrtcRequiredFeatures="",this.spatialAudioEnabled=!1,this._maxBandwidthInKbps=0,this._noiseSuppressionMode="Auto",this._enableMediaBypass=!1,this.audioContext={enabledLocally:!1,disabledRemotely:!1,enabledForSend:!1,initFailed:!1,initSendFailed:!1,codec:"None",lastUsedCodec:"None"}}setMediaConfiguration(e,t){this.maxBandwidthInKbps=Math.floor((e.maxBandwidthInBps||0)/1e3),this.isTransportUnbundled=this.settings.forceUnbundledTransport||this.settings.enableQosSupport&&(e.enableMediaQoS||!!e.mediaPortRanges),this._mediaPortRanges=e.mediaPortRanges,this.simulcastSessionEnabled=this.settings.webrtcSimulcastSessionEnabled&&Sm(this.settings.checkSupportForWebrtc_1_0),this._noiseSuppressionMode=e.noiseSuppressionMode||"Auto",this._enableMediaBypass=this.settings.allowMediaBypass&&e.enableMediaBypass,this.webrtcRejectedFeatures=this._enableMediaBypass?"":this.settings.webrtcRejectedFeatures,this.webrtcRequiredFeatures=this._enableMediaBypass?"":this.settings.webrtcRequiredFeatures,this.spatialAudioEnabled=t?t.spatialAudioEnabled:e.enableSpatialAudio}get mediaBypassEnabled(){return this._enableMediaBypass}get noiseSuppressionMode(){return this._noiseSuppressionMode}get maxBandwidthInKbps(){return this._maxBandwidthInKbps}set maxBandwidthInKbps(e){this._maxBandwidthInKbps=e,this.settings.maxBandwidthInKbps&&(this._maxBandwidthInKbps=Math.min(this.settings.maxBandwidthInKbps,this._maxBandwidthInKbps||Number.MAX_SAFE_INTEGER))}get audioPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.audioMin&&this._mediaPortRanges.audioMax)return{min:this._mediaPortRanges.audioMin,max:this._mediaPortRanges.audioMax}}get videoPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.videoMin&&this._mediaPortRanges.videoMax)return{min:this._mediaPortRanges.videoMin,max:this._mediaPortRanges.videoMax}}get audioCodecContext(){return this.settings.useInsertableStreams?.audioWasmCodec?.enable?this.audioContext:void 0}};function UA(e,t){if(Array.isArray(e))return t.slice()}var FA=class extends ze{constructor(e,t,i={}){super(e),this.logger=e,this.platformCallConstraintsProvider=t,this.platformConfig=function(){const e=ri();return"ChromiumAVD"===e.engine?new DA:"Safari"===e.engine?new OA(e):"Firefox"===e.name?new kA:Up()?new NA:"Chromium"===e.engine?new LA(e):new PA}(),this.sessionCount=0,this._consoleOverrides={},this.uaConfig=new Bp(this),this.mediaConfiguration={},this.configReceivedDefer=Om(),this.initialSettings=(0,hf.mergeWith)({},(0,hf.cloneDeep)(this.platformConfig.getInitialSettings()),(0,hf.cloneDeep)(i),this.platformConfig.getEnforcedSettings(),UA),this.settings=this.initialSettings,this.settingsWithoutOverrides=this.initialSettings,this.stackSettings=(0,hf.cloneDeep)(i),this.mediaSettings=new xA(this.settings),this.platformCallConstraintsProvider.changed((()=>{this.updateSettings();const e=this.platformCallConstraintsProvider.constraints,t=this.logger.createChild("SettingsToCallConstraintsConverter"),i=mf(t,this.settings,e);this.platformCallConstraintsProvider.addCallConstraintsTelemetryEvent(i,"applied")})),this.configReceivedTimeout=window.setTimeout((()=>{this.configReceivedTimeout=void 0,this.configReceivedDefer.resolve()}),this.settings.ecsConfigTimeout),this.logger.safe.info("Initialized")}getCallConstraints(){return this.platformCallConstraintsProvider.constraints}setCallConstraints(e){return this.platformCallConstraintsProvider.setConstraints(e),e}getCallConstraintsTelemetry(){return this.logger.error("Not supported globally, returning empty array"),[]}addCallConstraintsTelemetryEvent(e,t){this.logger.error("Not supported globally")}getIceTransportPolicy(){return this.logger.warn(`Not supported globally, returning default ${Qe.ICE_TRANSPORT_POLICY.all}`),Qe.ICE_TRANSPORT_POLICY.all}setIceTransportPolicy(e){this.logger.error("Not supported globally")}getConfigReceivedOrTimeout(){return this.configReceivedDefer.promise}getConfigView(e,t){const i=e?"Multiparty":"1on1",n=Object.entries((0,hf.cloneDeep)(this.settings)).reduce(((e,[t,n])=>(e[t]=n,t.endsWith(i)&&(e[t.replace(i,"")]=n),e)),{}),r=new xA(n);return r.setMediaConfiguration(this.mediaConfiguration,t?.mediaConfig),new Af(this.logger.createChild("ConfigProviderView"),n,r,this.userAgentConfig,this.countryCode,this.platformCallConstraintsProvider,t?.getCallConstraints())}updateConfig(e,t,i,n){this.etag=t||this.etag,this.configIds=i||this.configIds,this.country=n||this.country,this.event("newConfigReceived").raise(e,t,i),this.settingsWithoutOverrides=(0,hf.mergeWith)({},this.settingsWithoutOverrides,e,UA),this.updateSettings(),this.configReceivedTimeout&&(window.clearTimeout(this.configReceivedTimeout),this.configReceivedTimeout=void 0),this.configReceivedDefer.resolve()}updateSessionCount(e){this.sessionCount=e,0===e&&this.pendingSettings&&(this.logSettings("Applying pending configuration",this.pendingSettings),this.updateSettings(this.pendingSettings),this.pendingSettings=null),e>0&&this.configReceivedTimeout&&this.configReceivedDefer.resolve()}get config(){return this.settings}get stackConfig(){return this.stackSettings}get consoleOverrides(){return this._consoleOverrides}get defaultConfig(){return this.initialSettings}get userAgentConfig(){return this.uaConfig}get countryCode(){return this.country}setMediaConfiguration(e){this.mediaConfiguration=e,this.mediaSettings.setMediaConfiguration(e)}get mediaConfig(){return this.mediaSettings}get ETag(){return this.etag}get ecsConfigIds(){return this.configIds}setConsoleOverrides(e){this._consoleOverrides=(0,hf.mergeWith)({},this._consoleOverrides,e,UA),this.updateSettings()}setConsoleOverride(e,t){this._consoleOverrides[e]=t,this.updateSettings()}clearConsoleOverride(e){delete this._consoleOverrides[e],this.updateSettings()}clearAllConsoleOverrides(){this._consoleOverrides={},this.updateSettings()}updateSettings(e=this.settingsWithoutOverrides){if(this.sessionCount>0)return this.pendingSettings=e,void this.logSettings("pendingSettings updated",e);this.settings=this.mergeSettings(e),this.event("configUpdated").raise(),this.logSettings("Settings updated",this.settings)}logSettings(e,t){const i=Object.entries(t).reduce(((e,[t,i])=>(i!==this.initialSettings[t]&&(e[t]=i),e)),{});this.logger.safe.info(`${e}: ${JSON.stringify(i)}`)}mergeSettings(e){if(!e.enablePlatformCallConstraints&&!this._consoleOverrides.enablePlatformCallConstraints)return this.mergeSettingsWithConsoleOverrides(e);let t=e;const{setConsoleOverridesBeforeCallConstraints:i}=this._consoleOverrides;return i&&(t=this.mergeSettingsWithConsoleOverrides(t)),t=this.mergeSettingsWithPlatformConstraints(t),i||(t=this.mergeSettingsWithConsoleOverrides(t)),t}mergeSettingsWithConsoleOverrides(e){return this.logger.safe.info(`Merging settings with console overrides: ${Ve(this._consoleOverrides)}`),(0,hf.mergeWith)({},e,this._consoleOverrides,UA)}mergeSettingsWithPlatformConstraints(e){const t=this.platformCallConstraintsProvider.getSettings(e);return this.logger.safe.info(`Merging settings with platform call constraints: ${Ve(t)}`),(0,hf.assign)({},e,t,UA)}},VA=class{constructor(e,t){this.streamClient=e,this.logger=t,this.rawBaseClient=new Dg((()=>this.getStream()),(()=>this.activeRawInputMediaStreamClient?.dispose()),t)}client(){return this.rawBaseClient}disposeActiveMediaStreamClient(){this.logger.info("Disposing active media stream client"),this.activeRawInputMediaStreamClient?.dispose("Disposed by RawDeviceStreamManager"),this.activeRawInputMediaStreamClient=null}async getStream(){return this.activeRawInputMediaStreamClient?.originalMediaStream?.active?(this.logger.info("Returning stream from active mediaStreamClient"),this.activeRawInputMediaStreamClient.originalMediaStream):(this.activeRawInputMediaStreamClient=await this.streamClient(),await this.activeRawInputMediaStreamClient.start(),this.activeRawInputMediaStreamClient.originalMediaStream)}},BA=class{constructor(e,t){this.logger=e,this.raiseTelemetryEvent=t,this.handlerMap=new Map([["Audio",new Map],["Video",new Map],["ScreenShare",new Map]])}dispose(e){this.logger.info(`disposing IRawStream ${e}`),this.handlerMap.get(e).forEach((e=>e.client().dispose()))}disposeAll(){this.logger.info("Dispose All clients"),this.handlerMap.forEach((e=>e.forEach((e=>e.client().dispose()))))}notifyChange(e){this.handlerMap.get(e).forEach((e=>{e.disposeActiveMediaStreamClient(),e.client().notifyStreamChange()}))}createIRawStreamClient(e,t){this.logger.info(`Create new IRawStream client for ${t}`);const i=new VA(e,this.logger);return this.handlerAdded(i,t),i.client()}handlerAdded(e,t){const i=e.client();this.setClientSubscription(i,t),this.handlerMap.get(t).set(i.clientId,e)}deleteRawStreamManagerById(e,t){this.logger.info(`Deleting from map: ${t}`),this.handlerMap.get(t).delete(e)}setClientSubscription(e,t){this.logger.info(`Setting subscription on IRawStream client for ${t}`),e.on("clientDisposed",(i=>{this.deleteRawStreamManagerById(e.clientId,t),this.raiseTelemetryEvent("IRawStream_client_disposed",{mediaType:t,clientId:i})})),e.on("rawStreamRequested",(e=>{this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:t,clientId:e})})),e.on("notifiedOnStreamChanged",(e=>this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:t,clientId:e})))}},HA=class extends ze{constructor(e,t){super(e),this.logger=e,this.configProvider=t,this.window=Vp.window,this.isMuted=!1,this.isPlayingAllowed=!1,this.hadPlaybackError=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.onAudioError=e=>{const t=e&&e.target||this.audio;if(this.hadPlaybackError=!0,t?.error){const e=t.error.code,i=`error with rendering audio code: ${e}, message: ${t.error.message}`;this.event("onAudioPlaybackError").raise(e,Qe.MEDIA_ERROR.audioPlaybackError,i),this.logger.safe.error(i)}else this.logger.safe.error("error with audio rendering")},this.onAudioPaused=async()=>{if(this.configProvider.config.audioRendererRestartOnPause&&this.canPlay&&!this.isMuted){const e=Te();this.logger.safe.info(`[${e}] audio playback is paused by OS, resuming it`),await this.startStream(e)}}}get muted(){return this.isMuted}async setMuted(e,t){return this.isMuted=e,e?this.stopStream(t):this.startStream(t)}get canPlay(){return this.stream&&this.isPlayingAllowed}getStream(){return this.stream}getDeviceId(){return this.deviceId}async play(e){if(this.stream=e,this.isPlayingAllowed=!0,!this.isMuted)return this.startStream()}stop(){this.stopStream(),this.isPlayingAllowed=!1}async setOutputDevice(e,t=Te()){if(this.audio)if(this.configProvider.config.disableAudioOutputSelection)this.logger.safe.warn(`[${t}] audio-output selction is disabled, disableAudioOutputSelection: true`);else if(this.audio.setSinkId){if(e){this.logger.safe.info(`[${t}] setting audio output device ID to ${we(e)}`),this.deviceId=e;try{await this.audio.setSinkId(e)}catch(e){this.logger.safe.warn(`[${t}] setSinkId operation was aborted with error ${Ve(e)}`)}this.configProvider.config.audioRendererRestartOnDeviceError&&this.hadPlaybackError&&!this.isMuted&&(this.logger.safe.info(`[${t}] audio playback error happened, restarting audio stream on new device`),await this.startStream(t),this.hadPlaybackError=!1)}}else this.logger.safe.warn(`[${t}] setting output device is not supported`);else this.deviceId=e}dispose(){this.logger.safe.info("dispose"),super.dispose(),this.audio&&(this.stop(),this.stream=null,this.audio.removeEventListener("error",this.onAudioError),this.audio.removeEventListener("pause",this.onAudioPaused),this.window.document.body.removeChild(this.audio),this.event("onAudioElementRemoved").raise(this.audio),this.audio=null),this.detachGainNode()}async startStream(e=Te()){if(this.canPlay)try{await this.assureAudioElement(e),this.logger.safe.info(`[${e}] attaching stream to renderer: ${this.stream?.id}`),this.configProvider.config.speakerGainLevel&&this.reattachToGainNode(this.stream,this.configProvider.config.speakerGainLevel),this.audio.srcObject=this.stream,await this.audio.play()}catch(t){this.logger.safe.warn(`[${e}] play operation was aborted with error ${Ve(t)}`)}}async assureAudioElement(e=Te()){if(!this.audio)return this.logger.safe.info(`[${e}] creating audio element`),this.audio=this.window.document.createElement("audio"),this.audio.addEventListener("error",this.onAudioError),this.audio.addEventListener("pause",this.onAudioPaused),this.window.document.body.appendChild(this.audio),this.audio.autoplay=!0,this.event("onAudioElementAdded").raise(this.audio),this.setOutputDevice(this.deviceId,e)}stopStream(e=Te()){this.audio&&this.canPlay&&(this.detachGainNode(),this.logger.safe.info(`[${e}] detaching stream from renderer: ${this.stream?.id}`),this.configProvider.config.audioRendererUsePauseOnDetach?this.audio.pause():this.audio.srcObject=null)}attachToGainNode(e,t){this.audioContext=new Vp.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(e),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=t,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination)}detachGainNode(){this.sourceNode?.disconnect(),this.sourceNode=null,this.gainNode?.disconnect(),this.gainNode=null,this.audioContext?.close(),this.audioContext=null}reattachToGainNode(e,t){this.detachGainNode(),this.attachToGainNode(e,t)}},$A=class{constructor(e){this.logger=e,this.queue=Promise.resolve()}add(e,t=Te()){let i;i=e instanceof Yu?()=>e.promise:e;const n=this.queue.then(i);return this.queue=n.catch((e=>{if(this.queue){let i="";e instanceof TypeError&&(i=e.stack),this.logger.safe.error(`[${t}] Error from promiseQueue! ${Ve(e)} ${i}`)}})),n}dispose(){this.queue=null}},GA=p,jA=class{constructor(e){this.container=e,this.formatRegexPattern=new RegExp(/{(\d+)}/g),this.elements={},this.previousSamples={},this.overlayToggled=!0,this.createTableCell=(e,t,i)=>{this.elements[e]=document.createElement("td"),this.elements[e].title=e,this.addElementStyle(e,i),this.elements[t].appendChild(this.elements[e])},this.topElement=e.ownerDocument.createElement("div"),this.topElement.classList.add("vdi-occlusion"),this.topElement.style.position="absolute",this.topElement.style.top="0px",this.topElement.style.left="0px",this.topElement.style.zIndex="100",this.topElement.style.transform="inherit",this.topElement.style.backgroundColor="rgba(0, 0, 0, 0.25)",this.topElement.style.pointerEvents="all",this.topElement.style.minWidth="15px",this.topElement.style.minHeight="15px",this.topElement.style.cursor="pointer",this.topElement.onclick=()=>{this.overlayToggled=!this.overlayToggled},this.container.appendChild(this.topElement),this.table=document.createElement("table"),this.table.style.borderCollapse="collapse",this.table.style.fontSize="smaller",this.topElement.appendChild(this.table)}dispose(){this.topElement.removeChild(this.table),this.container.removeChild(this.topElement),this.table=null,this.topElement=null,this.container=null}createTableColumn(e,t){if(this.overlayToggled)for(const i of Object.keys(e)){const n=e[i];n.hideUndefined&&n.values.every((e=>!e))||this.createTableRow(i,n,t)}}createTableRow(e,t,i){this.elements[e]||(this.elements[e]=document.createElement("tr"),this.table.appendChild(this.elements[e]));const n=`${e}-title`,r=`${e}-${i}`,s=this.formatValue(t),a=this.previousSamples[r]!==s;this.previousSamples[r]=s;const o=function(e){const{values:t,lowerThreshold:i,upperThreshold:n,highlightUndefined:r,fixedValueThreshold:s,allowedDeviationThreshold:a}=e;for(const e of t){if(void 0===e&&null===e&&r)return!0;if(s&&s!==e)return!0;if(null==e||!(0,GA.isNumber)(e))return!1;if(i&&Number(e)<=i)return!0;if(n&&Number(e)>=n)return!0;if(a){const i=(0,GA.mean)(t),n=i*a;if(Math.abs(Number(e)-i)>n)return!0}}return!1}(t)||!(!t.highlightChange||!a);this.elements[n]||(this.createTableCell(n,e,!1),this.elements[n].innerText=t.text?t.text:e),this.createTableCell(r,e,o),this.elements[r].innerText=s}clearTable(){for(;this.table.hasChildNodes();)this.table.removeChild(this.table.lastChild);this.elements={}}addElementStyle(e,t){this.elements[e].style.color=t?"#F72F35":"#FBF719",this.elements[e].style.fontSize="smaller",this.elements[e].style.lineHeight="1",this.elements[e].style.padding="0px 1px 0px 1px",this.elements[e].style.maxWidth="60px",this.elements[e].style.overflow="hidden",this.elements[e].style.whiteSpace="nowrap",this.elements[e].style.textOverflow="ellipsis"}formatValue(e){const{values:t,format:i,undefinedFallback:n="N/A"}=e;return i?i.replace(this.formatRegexPattern,((e,i)=>t[i]?t[i].toString():n.toString())):t?.length&&t[0]?t[0].toString():n.toString()}},qA=class{constructor(e,t,i){this.container=t,this.renderer=i,this.subs=[],e&&!this.overlay&&(this.overlay=new jA(this.container),this.subs.push(this.renderer.on("onVideoSizeChanged",((e,t)=>this.streamSize={width:e,height:t}))),this.subs.push(this.renderer.on("onRendererSizeChanged",((e,t)=>this.rendererSize={width:Math.ceil(t.width),height:Math.ceil(t.height)}))))}setStats(e){if(!this.overlay)return;const{id:t,ssrc:i,keyFramesDecoded:n,nackCount:r,firCount:s,pliCount:a,decoderImplementation:o,packetsLost:c}=e.inboundRTP,{frameRateReceived:l,frameRateDecoded:d,bitrate:h,decodeTime:u}=e.extensions??{},g=this.renderer?.getMsi(),p=this.renderer?.getLocalMsi(),m={streamSize:{format:"{0}x{1}",values:[this.streamSize?.width,this.streamSize?.height],undefinedFallback:0},rendererSize:{format:"{0}x{1}",values:[this.rendererSize?.width,this.rendererSize?.height],undefinedFallback:0},ssrc:{values:[i]},msid:{text:"sourceId/msid",format:"{0}/{1}",values:[g,p]},fps:{text:"FPS(r/d)",format:"{0}/{1}",values:[l,d],highlightUndefined:!0,lowerThreshold:1,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[zA(h)],lowerThreshold:24},decodeTime:{format:"{0} ms",values:[u],upperThreshold:15,highlightUndefined:!0},keyFramesDecoded:{text:"KFs",values:[n]},nacksFirsPlisSent:{text:"N/F/P",format:"{0}/{1}/{2}",values:[r,s,a],undefinedFallback:0,highlightChange:!0},packetsLost:{text:"lost",values:[c],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"decoder",values:[o],highlightUndefined:!0}};this.overlay.clearTable(),this.overlay.createTableColumn(m,t)}dispose(){this.subs.forEach((e=>e.dispose())),this.subs=[],this.overlay?.dispose(),this.overlay=null,this.container=null,this.renderer=null}},WA=class{constructor(e,t){this.container=t,e&&!this.overlay&&(this.overlay=new jA(this.container))}setStats(e){if(!this.overlay)return;const t=e=>{const{rid:t,ssrc:i,frameWidth:n,frameHeight:r,framesPerSecond:s,keyFramesEncoded:a,nackCount:o,firCount:c,pliCount:l,encoderImplementation:d,qualityLimitationReason:h}=e.outboundRTP,{cameraOpenResolution:u,bitrate:g,encodeTime:p,frameRateEncoded:m,frameRateSent:f,qp:S}=e.extensions??{};return{rid:{values:[t],hideUndefined:!0},cameraSize:{format:"{0}x{1}",values:[u?.width,u?.height]},inputSize:{format:"{0}x{1}",values:[e.mediaSource?.width,e.mediaSource?.height]},sentSize:{format:"{0}x{1}",values:[n,r]},ssrc:{values:[i]},fps:{text:"FPS(i/e/s)",format:"{0}/{1}/{2}",values:[s,m,f],lowerThreshold:7,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[zA(g)],lowerThreshold:24},encodeTime:{format:"{0} ms",values:[p],upperThreshold:15},keyFramesEncoded:{text:"KFs",values:[a]},qp:{values:[S]},nacksFirsPlisRecv:{text:"N/F/P",format:"{0}/{1}/{2}",values:[o,c,l],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"encoder",values:[d],highlightUndefined:!0},qualityLimitationReason:{text:"limited",values:[h],fixedValueThreshold:"none"},bwe:{format:"{0} kbps",values:[zA(e.transport?.selectedCandidatePair?.availableOutgoingBitrate)],lowerThreshold:100}}};this.overlay.clearTable();const i=[e,...e.altLayouts??[]];for(const e of i)this.overlay.createTableColumn(t(e),e.outboundRTP.id)}dispose(){this.overlay?.dispose(),this.overlay=null,this.container=null}};function zA(e){return e&&Math.floor((e||0)/1e3)}var JA=class e extends ze{constructor(t,i,n){const r=i.createChild(""+e.rendererId++);super(r),this.container=t,this.configProvider=n,this.video=this.container.ownerDocument.createElement("video"),this.lastNotifiedVideoWidth=0,this.lastNotifiedVideoHeight=0,this.isVideoAttached=!1,this.onVideoDataUpdated=()=>{let e=this.video.videoWidth,t=this.video.videoHeight;(e<32||t<32)&&(e=t=0),this.lastNotifiedVideoWidth===e&&this.lastNotifiedVideoHeight===t||(this.lastNotifiedVideoWidth=e,this.lastNotifiedVideoHeight=t,this.event("onVideoSizeChanged").raise(e,t)),this.playVideo()},this.onVideoError=()=>{this.logger.safe.info(`onVideoError: error with video rendering: ${JSON.stringify(this.video.error)||"no video"}`),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onError",payload:JSON.stringify(this.video.error)||"no video"})},this.onVideoPaused=()=>{this.logger.safe.info("onVideoPaused: video playback is paused"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPaused"}),this.playVideo()},this.onVideoPlayed=()=>{this.logger.safe.info("onVideoPlayed"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPlayed"})},this.onContextMenu=e=>{e.preventDefault()},this.logger=r,this.video.style.width="100%",this.video.style.height="100%",this.video.setAttribute("playsinline","true"),this.video.disablePictureInPicture=!0,this.video.autoplay=!0,this.video.muted=!0,this.attachEventListeners(),this.logger.safe.info("created")}getVideoElement(){return this.video}dispose(){super.dispose(),this.isVideoAttached&&(this.container.removeChild(this.video),this.isVideoAttached=!1),this.sizeTracker?.dispose(),this.detachEventListeners(),this.attachMediaStream(null),this.video=null,this.stream=null,this.canvas=null,this.context=null}attachMediaStream(e){this.stream!==e&&(this.stream&&(this.video.srcObject=null),e&&(this.video.hidden=0===e.getVideoTracks().length,this.video.srcObject=e,this.isVideoAttached||(this.container.appendChild(this.video),this.isVideoAttached=!0)),this.stream=e)}setScalingMode(e){this.video.style.objectFit=function(e){switch(e){case"crop":return"cover";case"stretch":return"fill";default:return"contain"}}(e)}getMediaStream(){return this.stream}getTrackId(){return this.stream?.getTracks()[0]?.id??void 0}async captureFrame(){const e=this.stream;if(!e)throw this.logger.safe.error("Mediastream not found"),new Error("Mediastream not found");const t=e.getVideoTracks?.()?.[0]?.getSettings(),i=t?.width,n=t?.height;if(!i||!n)throw this.logger.safe.error("Failed to get video track width/height"),new Error("Failed to get video track width/height");const r=this.getImageData(i,n);return{getSize:()=>({width:i,height:n}),isMirrored:()=>!1,getImageData:()=>r}}playVideo(){this.video?.paused&&this.video.play().catch((e=>{this.logger.safe.error(`Play video error: ${e}`)}))}getImageData(e,t){if(this.canvas??(this.canvas=this.container.ownerDocument.createElement("canvas")),this.context??(this.context=this.canvas.getContext("2d")),!this.context)throw this.logger.safe.error("Failed to get canvas 2d context"),new Error("Failed to get canvas 2d context");return this.canvas.width=e,this.canvas.height=t,this.context.drawImage(this.video,0,0,e,t),this.context.getImageData(0,0,e,t)}attachEventListeners(){this.video.addEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.addEventListener("timeupdate",this.onVideoDataUpdated),this.video.addEventListener("error",this.onVideoError),this.video.addEventListener("pause",this.onVideoPaused),this.video.addEventListener("contextmenu",this.onContextMenu),this.video.addEventListener("play",this.onVideoPlayed)}detachEventListeners(){this.video.removeEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.removeEventListener("timeupdate",this.onVideoDataUpdated),this.video.removeEventListener("error",this.onVideoError),this.video.removeEventListener("pause",this.onVideoPaused),this.video.removeEventListener("contextmenu",this.onContextMenu),this.video.removeEventListener("play",this.onVideoPlayed)}};JA.rendererId=0;var KA=JA;function YA(e){return e.map((e=>new QA(e.w,e.h,e.minBr,e.maxBr)))}var QA=class{constructor(e,t,i=0,n=0){this.width=e,this.height=t,this.minBitrate=i,this.maxBitrate=n,this.fs=Math.ceil(e/Qe.MACROBLOCK_SIZE)*Math.ceil(t/Qe.MACROBLOCK_SIZE)}toString(){return this.height?`${this.height}p`:`${this.fs}fs`}},XA=class e{constructor(e){e||(this.resolutions=YA(Qe.RES_TABLE.SEND)),this.resolutions=YA(e)}static initialize(t){e.Send=new e(t.config.sendResolutionTableOverride),e.Recv=new e(t.config.recvResolutionTableOverride),t.on("configUpdated",(()=>{e.Send=new e(t.config.sendResolutionTableOverride),e.Recv=new e(t.config.recvResolutionTableOverride)}))}get initialResolution(){return this.resolutions[this.resolutions.length-1]}getResolutionByFs(e){for(let t=this.resolutions.length-1;t>=0;t--)if(this.resolutions[t].fs<=e)return this.resolutions[t];return this.resolutions[0]}getMaxFS(e,t){return this.getResolutionRecord(e,t).fs}getResolutionForBitrate(e){let t=this.resolutions.filter((t=>t.maxBitrate&&t.maxBitrate>=e)).shift(),i=this.resolutions.filter((t=>t.minBitrate&&t.minBitrate<=e)).pop();return t=t??i,i=i??t,{lowRes:t,highRes:i}}getBitrateForResolution(e,t){const i=this.getResolutionRecord(e,t);return{minBitrate:i.minBitrate,maxBitrate:i.maxBitrate}}getResolutionForHeight(e){for(let t=this.resolutions.length-1;t>=0;t--)if(this.resolutions[t].height<=e)return this.resolutions[t];return this.resolutions[0]}getResolutionRecord(e,t){const i=Math.max(e,t),n=Math.min(e,t);for(const e of this.resolutions)if(e.width>=i&&e.height>=n)return e;return this.resolutions[this.resolutions.length-1]}getNextLowerResolution(e,t){const i=Math.min(e,t),n=this.getResolutionForHeight(i),r=this.resolutions.indexOf(n);return this.resolutions[r-1]}getNextHigherResolution(e,t){const i=Math.min(e,t),n=this.getResolutionForHeight(i),r=this.resolutions.indexOf(n);return this.resolutions[r+1]}getResolutions(){return this.resolutions}};XA.Recv=new XA(Qe.RES_TABLE.RECV),XA.Send=new XA(Qe.RES_TABLE.SEND);var ZA=XA,eR=class extends ze{constructor(e,t,i,n){super(),this.videoElement=e,this.minInterval=t,this.maxInterval=i,this.window=Vp.window,this.devicePixelRatio=n&&window.devicePixelRatio||1,this.originalVideoElementSize={width:e.offsetWidth,height:e.offsetHeight},this.initializeSizeTracking()}get width(){return this.originalVideoElementSize.width*this.devicePixelRatio}get height(){return this.originalVideoElementSize.height*this.devicePixelRatio}initializeSizeTracking(){const e=Math.floor(Math.random()*Math.abs(this.maxInterval-this.minInterval))+this.minInterval;this.elementSizeTrackingRef=this.window.setInterval((()=>{this.videoElementSizeChanged()&&(this.saveCurrentVideoElementSize(),this.raiseChanged())}),e)}triggerVideoElementSizeChange(){this.originalVideoElementSize.height&&this.originalVideoElementSize.width&&this.raiseChanged()}dispose(){this.elementSizeTrackingRef&&this.window.clearInterval(this.elementSizeTrackingRef)}videoElementSizeChanged(){return this.originalVideoElementSize.width!==this.videoElement.offsetWidth||this.originalVideoElementSize.height!==this.videoElement.offsetHeight}saveCurrentVideoElementSize(){this.originalVideoElementSize.width=this.videoElement.offsetWidth,this.originalVideoElementSize.height=this.videoElement.offsetHeight}},tR=class extends KA{constructor(e,t,i,n){super(e,i.createChild("local"),n),this.mediaStreamProvider=t,this.isDisposed=!1,this.serialQueue=new $A(this.logger.createChild("rendererQueue")),this.lastNotifiedRendererResolution={width:0,height:0},this.logger.safe.info("ctor"),this.overlayStats=new WA(this.configProvider.config.showStatsInCall,e)}getResolution(){return this.lastNotifiedRendererResolution}dispose(){this.logger.safe.info("dispose"),this.isDisposed=!0,this.event("onRendererDisposed").raise(this),super.dispose(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),this.statsSub?.dispose(),this.overlayStats.dispose()}setVideoMirroring(e){this.configProvider.config.localPreviewMirroringSupported&&(this.getVideoElement().style.transform=e?"scaleX(-1)":void 0)}startVideoAsync(e=Te()){return this.logger.safe.info(`[${e}] starting local video`),this.event("onRendererStarted").raise(this),this.sizeTracker=new eR(this.getVideoElement(),this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged())),this.serialQueue.add((()=>this.restartVideo()),e)}updateStreamAsync(e=Te()){return this.logger.safe.info(`[${e}] updating local video`),this.serialQueue.add((()=>this.restartVideo()),e)}setStatsProvider(e){this.statsSub?.dispose(),this.statsSub=e.on("onDiagnosticUpdated",(e=>{e.video?.send?.length&&this.overlayStats.setStats(e.video?.send[0])}))}onSizeTrackerChanged(){const e=this.sizeTracker.width,t=this.sizeTracker.height,i=ZA.Send.getResolutionForHeight(Math.min(t,e));this.lastNotifiedRendererResolution.width===i.width&&this.lastNotifiedRendererResolution.height===i.height||(this.lastNotifiedRendererResolution.width=i.width,this.lastNotifiedRendererResolution.height=i.height,this.event("onRendererSizeChanged").raise(this,{height:i.height,width:i.width}))}async restartVideo(){const e=await this.mediaStreamProvider.getVideoStream(!1,"localVideoRenderer");try{if(await e.start(),this.isDisposed)throw e.dispose(),new Error("local video renderer is disposed");this.attachStream(e)}catch(e){throw this.mediaStreamProvider.raiseTelemetryEvent("video_preview_error",{mediaType:"Video",error:Ve(e)}),e}}attachStream(e){if(this.mediaStream!==e)if(this.mediaStream?.parentId!==e?.parentId){this.logger.safe.info(`attach media stream ${e?.id}`);try{this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),e&&super.attachMediaStream(e.rawStream),this.mediaStream=e}catch(t){throw e&&e.dispose(),t}}else e.dispose()}},iR=p;function nR(e,t){const i=e.width/e.height,n=(0,iR.clone)(e);return i>t?n.width=Math.floor(e.height*t):i<t&&(n.height=Math.floor(e.width/t)),n}var rR=class e{constructor(e,t,i=!0,n=!1,r){this.audio=e,this.video=t,this.withTimeout=i,this.withEffect=n,this.withOverridenStream=r}clone(){const t=ct(this.video),i=ct(this.audio);return new e(i,t,this.withTimeout,this.withEffect,this.withOverridenStream)}},sR=class{constructor(e){this.logger=e}dispose(){}updateVideoConstraints(e,t,i){const n=this.calculateConstraints(t,i);this.logger.safe.info(`Calculated constraints: ${JSON.stringify(n)} from capabilities: ${JSON.stringify(t)}`);const r=n.resolution,s=n.fps,a=r&&(!mt(r.width,e.video.minWidth,e.video.maxWidth)||!mt(r.height,e.video.minHeight,e.video.maxHeight)),o=e.video.fps!==s;if(!a&&!o)return e;const c=e.clone();return a&&this.setResolution(c,r),o&&(c.video.fps=s),c}updateResolution(e,t){const i=e.clone();return this.setResolution(i,t),i}setResolution(e,t){e.video.maxWidth=t.width,e.video.minWidth=t.width,e.video.maxHeight=t.height,e.video.minHeight=t.height}getKey(e){return e.video?st(e.video)?"video":e.video.deviceId&&e.video.minWidth&&e.video.minHeight?`${e.video.deviceId}x${e.video.minWidth}x${e.video.minHeight}`:e.video.minWidth&&e.video.minHeight?`${e.video.minWidth}x${e.video.minHeight}`:e.video.deviceId?`${e.video.deviceId}`:(this.logger.safe.error(`Cannot create key for constraints: ${mm(e)}`),""):"audio"}convertConstraints(e,t={}){if(!e)return null;const i=ct(t);return e?.deviceId&&(i.deviceId=e.deviceId),i}},aR=class{constructor(){this.MAX_SHARING_WIDTH=1920,this.MAX_SHARING_HEIGHT=1080}getResolutionTable(e,t){const i=this.constraintToMaxResolution(e,t);return this.generateResolutionTable(i)}constraintToMaxResolution(e,t){const i=this.getPortraitOrLandscapeMaxResolution(e),n=nR({width:e.width,height:e.height},t),r=i.width/n.width,s=i.height/n.height,a=Math.min(r,s);return this.resizeResolution(n,a)}resizeResolution(e,t){return{width:Math.round(e.width*t),height:Math.round(e.height*t)}}getPortraitOrLandscapeMaxResolution(e){return e.width>e.height?{width:this.MAX_SHARING_WIDTH,height:this.MAX_SHARING_HEIGHT}:{width:this.MAX_SHARING_HEIGHT,height:this.MAX_SHARING_WIDTH}}ceilToMackroblockSize(e){const t=e.width,i=e.height;return{width:Math.ceil(t/Qe.MACROBLOCK_SIZE)*Qe.MACROBLOCK_SIZE,height:Math.ceil(i/Qe.MACROBLOCK_SIZE)*Qe.MACROBLOCK_SIZE}}generateResolutionTable(e){return[1,2/3,1/3,1/6].map((t=>this.resizeResolution(e,t))).map((e=>this.ceilToMackroblockSize(e)))}},oR=class{constructor(e){this.logger=e,this.FPS_TABLE=[15,7.5,3.75,1.875],this.resolutionTableCalculator=new aR,this.initialAspectRatio=null}calculateConstraints(e,t){this.initialAspectRatio||(this.initialAspectRatio=t.width/t.height);const i=this.resolutionTableCalculator.getResolutionTable(t,this.initialAspectRatio);let n={resolution:i[i.length-1],fps:this.FPS_TABLE[this.FPS_TABLE.length-1]};return i.some((t=>{const i=this.getFs(t);return this.FPS_TABLE.some((r=>{const s=this.getMbps(i,r);return i<=e.maxFs&&r<=e.maxFps&&s<=e.maxMbps&&(n={resolution:t,fps:r},!0)}))}))?this.logger.safe.info(`Calculated resolution: ${JSON.stringify(n)}`):this.logger.safe.error(`None of available resolutions are suitable: ${JSON.stringify(i)}. Fallback to: ${JSON.stringify(n)}`),n}getMbps(e,t){return e*t}getFs(e){return Math.ceil(e.width/Qe.MACROBLOCK_SIZE)*Math.ceil(e.height/Qe.MACROBLOCK_SIZE)}},cR=class{constructor(e,t){this.logger=e,this.maxCapabilities=t}ensureValidity(e){this.throwIfMissing(e);const t=this.calculateMissing(e);return this.maxCapabilities&&this.applyMaxCapabilities(t),this.logger.safe.info(`Validating capabilities ${JSON.stringify(t)}`),t}throwIfMissing(e){if(!e.maxFs&&!e.maxMbps&&!e.maxFps||e.maxFs&&!e.maxMbps&&!e.maxFps||!e.maxFs&&e.maxMbps&&!e.maxFps||!e.maxFs&&!e.maxMbps&&e.maxFps)throw new Error(`Missing video capabilities ${JSON.stringify(e)}`)}calculateMissing(e){const t=ot(e);return!e.maxFs&&e.maxMbps&&e.maxFps&&(t.maxFs=e.maxMbps/e.maxFps),e.maxFs&&!e.maxMbps&&e.maxFps&&(t.maxMbps=e.maxFs*e.maxFps),e.maxFs&&e.maxMbps&&!e.maxFps&&(t.maxFps=e.maxMbps/e.maxFs),t}applyMaxCapabilities(e){this.maxCapabilities.maxFs&&(e.maxFs=Math.min(e.maxFs,this.maxCapabilities.maxFs)),this.maxCapabilities.maxMbps&&(e.maxMbps=Math.min(e.maxMbps,this.maxCapabilities.maxMbps)),this.maxCapabilities.maxFps&&(e.maxFps=Math.min(e.maxFps,this.maxCapabilities.maxFps))}},lR=class extends sR{constructor(e,t){super(e),this.initialConstraints={maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,fps:15},this.maxCapabilities={maxFs:8160,maxFps:15},this.validator=new cR(this.logger.createChild("CV"),this.maxCapabilities),this.constraintsCalculator=new oR(this.logger.createChild("CC")),t.config.resizeModeForSharing&&(this.initialConstraints.resizeMode=t.config.resizeModeForSharing)}createConstraintsObject(e){if(!e.sharing)throw new Error(`Sharing constraints are not presented: ${JSON.stringify(e)}`);const t=this.convertConstraints(e.sharing,this.initialConstraints),i=e.audio?e.audio:null;return i?.deviceId===Qe.SYSTEM_AUDIO_SOURCE_ID&&delete i.deviceId,new rR(i,t,!1,!1,e.withOverridenStream)}generatePolicies(e){return[e]}calculateConstraints(e,t){this.logger.safe.info(`Stream resolution is ${JSON.stringify(t)}`);const i=this.validator.ensureValidity(e);return this.constraintsCalculator.calculateConstraints(i,t)}},dR=class extends lR{constructor(e,t,i){super(e,i);const n=t.screen.width/t.screen.height;n<1&&([this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[this.initialConstraints.maxHeight,this.initialConstraints.maxWidth],[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[this.initialConstraints.minHeight,this.initialConstraints.minWidth]);let r=nR({width:this.initialConstraints.maxWidth,height:this.initialConstraints.maxHeight},n);[this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[r.width,r.height],r=nR({width:this.initialConstraints.minWidth,height:this.initialConstraints.minHeight},n),[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[r.width,r.height]}},hR=class extends sR{constructor(e,t){super(t),this.configProvider=e}createConstraintsObject(e){const t={},i=ri().engine;void 0!==e.audioProcessingFlags&&("Chromium"===i||"ChromiumAVD"===i?(t.autoGainControl=!!(1&e.audioProcessingFlags),t.echoCancellation=!!(2&e.audioProcessingFlags),t.noiseSuppression=!!(4&e.audioProcessingFlags),this.configProvider.config.useGoogPrefixAudioConstraints&&(t.googAutoGainControl=!!(1&e.audioProcessingFlags),t.googAutoGainControl2=!!(1&e.audioProcessingFlags),t.googEchoCancellation=!!(2&e.audioProcessingFlags),t.googHighpassFilter=!!(4&e.audioProcessingFlags),t.googNoiseSuppression=!!(4&e.audioProcessingFlags),t.googTypingNoiseDetection=!!(4&e.audioProcessingFlags))):"Safari"===i||"Firefox"===i?(t.autoGainControl=!!(1&e.audioProcessingFlags),t.echoCancellation=!!(2&e.audioProcessingFlags),t.noiseSuppression=!!(4&e.audioProcessingFlags)):this.logger.warn(`Unsupported browser for audio processing flags ${i}`));const n=this.convertConstraints(e.audio,t),r=this.convertConstraints(e.video,this.initialVideoConstraints);return new rR(n,r,e.withTimeout,e.withEffect,e.withOverridenStream)}calculateConstraints(e){const t=Math.min(e.maxFs,this.configProvider.config.webrtcCameraOpenFs);return{resolution:ZA.Send.getResolutionByFs(t),fps:e.maxFps}}get initialVideoConstraints(){const e=ZA.Send.getResolutionByFs(this.configProvider.config.webrtcCameraOpenFs);return{maxWidth:e.width,minWidth:e.width,maxHeight:e.height,minHeight:e.height,fps:this.configProvider.config.maxCameraOpenFps}}},uR=class{static getProvider(e,t,i){if("ScreenShare"===e){const e=i.createChild("SharingCP");return"Safari"===ri().name?new dR(e,Vp.window,t):new lR(e,t)}return new hR(t,i.createChild("VideoCP"))}},gR=class{constructor(){}getPolicies(e){if(e.audio&&!e.video&&this.hasAudioProcessingConstraints(e))return[e,new rR({deviceId:e.audio.deviceId},null)];if(!e.video)return[e];const t=this.getSuitableResolutions(e).map((t=>this.getConstraintsForResolution(e,t))),i=e.audio,n={deviceId:e.video.deviceId},r=new rR(i,n,e.withTimeout);return t.push(r),t}getSuitableResolutions(e){return ZA.Send.getResolutions().filter((t=>t.width<=e.video.maxWidth&&t.height<=e.video.maxHeight)).reverse()}getConstraintsForResolution(e,t){const i=e.clone();return i.video.minWidth=t.width,i.video.minHeight=t.height,i}hasAudioProcessingConstraints(e){const t=e&&e.audio;return t&&(void 0!==t.echoCancellation||void 0!==t.autoGainControl||void 0!==t.noiseSuppression)}},pR=class{constructor(e,t){this.error=e,this.constraints=t,this.permissionDeniedBySystemErrorMsg=["Permission denied by system","The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission."]}getMediaError(){let e;switch(this.error.name){case"SourceUnavailableError":case"TrackStartError":case"NotReadableError":case"AbortError":e={type:Qe.MEDIA_ERROR.sourceUnavailableError,detail:`media device is already used by another process: ${Ve(this.error)}`};break;case"ConstraintNotSatisfiedError":case"OverconstrainedError":e={type:Qe.MEDIA_ERROR.constraintNotSatisfiedError,detail:`could not obtain constrained media stream: ${Ve(this.error)}`};break;case"DevicesNotFoundError":case"NotFoundError":e={type:Qe.MEDIA_ERROR.devicesNotFoundError,detail:`specified device not found: ${Ve(this.error)}`};break;case"NotAllowedError":e=this.permissionDeniedBySystemErrorMsg.some((e=>e===this.error.message))?{type:Qe.MEDIA_ERROR.permissionDeniedBySystemError,detail:`no system permissions: ${Ve(this.error)}`}:{type:Qe.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${Ve(this.error)}`};break;case"PermissionDeniedError":case"PermissionDismissedError":e={type:Qe.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${Ve(this.error)}`};break;case Qe.MEDIA_ERROR.extensionNotFoundError:e={type:Qe.MEDIA_ERROR.extensionNotFoundError,detail:`extension is not found: ${Ve(this.error)}`};break;case Qe.MEDIA_ERROR.chromeRuntimeNotDefinedError:e={type:Qe.MEDIA_ERROR.chromeRuntimeNotDefinedError,detail:`chrome runtime is not defined: ${Ve(this.error)}`};break;case Qe.MEDIA_ERROR.sharingCancelledError:e=this.getSharingCancelledError(this.error);break;case Qe.MEDIA_ERROR.mediaStreamRequestTimedOut:e={type:Qe.MEDIA_ERROR.mediaStreamRequestTimedOut,detail:"Media Stream request timed out."};break;default:e=this.error.message===Qe.MEDIA_ERROR.sharingCancelledError?this.getSharingCancelledError(this.error):{type:Qe.MEDIA_ERROR.mediaStreamRequestError,detail:`media stream request error: ${Ve(this.error)}`}}return e.isAudio=!!this.constraints.audio,e.detail+=` constraints: ${Ve(mm(this.constraints))}`,e.message=e.detail,e}getSharingCancelledError(e){return{type:Qe.MEDIA_ERROR.sharingCancelledError,detail:`screen sharing cancelled: ${Ve(e)}`}}},mR=class{constructor(e){this.logger=e}static isSupported(){return!0}getStream(e){const t=this.constraintsAdapter.toGumConstraints(e);return this.logger.safe.info(`Constraints to be applied: ${JSON.stringify(mm(t))}`),new Promise(((e,i)=>{Vp.window.navigator.getUserMedia(t,e,i)})).catch((t=>{throw new pR(t,e).getMediaError()}))}applyConstraints(e,t){if(!e||!e.getVideoTracks()||!e.getVideoTracks()[0])return Promise.reject("No video tracks found");const i=e.getVideoTracks()[0];return this.applyConstraintsForTrack(i,t)}applyConstraintsForTrack(e,t){const i=this.constraintsAdapter.toTrackConstraints(t);return e.applyConstraints?(this.logger.safe.info(`Apply constraints: ${JSON.stringify(i)} on ${JSON.stringify(e.id)}`),e.applyConstraints(i).catch((e=>{throw new pR(e,t).getMediaError()}))):Promise.reject("track.applyConstraints() is not supported")}},fR=class{constructor(e){this.configProvider=e}toGumConstraints(e){const t={};return e.audio&&(t.audio=ct(e.audio),t.audio.deviceId&&delete t.audio.deviceId,e.audio.deviceId&&e.audio.deviceId!==Qe.MEDIA_DEVICE.defaultId&&(t.audio.deviceId=e.audio.deviceId)),e.video&&(t.video={mandatory:{}},e.video.deviceId&&(t.video.mandatory.sourceId=e.video.deviceId),e.video.minWidth&&(t.video.mandatory.minWidth=e.video.minWidth),e.video.maxWidth&&(t.video.mandatory.maxWidth=e.video.maxWidth),e.video.minHeight&&(t.video.mandatory.minHeight=e.video.minHeight),e.video.maxHeight&&(t.video.mandatory.maxHeight=e.video.maxHeight),e.video.fps&&(t.video.mandatory.maxFrameRate=e.video.fps,this.configProvider.config.setMinFpsForWebkit&&(t.video.mandatory.minFrameRate=this.configProvider.config.minCameraOpenFps,t.video.mandatory.idealFrameRate=e.video.fps)),st(t.video.mandatory)&&delete t.video.mandatory),t}toTrackConstraints(e){const t={};return e.video&&(e.video.minWidth&&(t.width=e.video.minWidth),e.video.minHeight&&(t.height=e.video.minHeight),e.video.fps&&(t.frameRate=e.video.fps)),t}},SR=class{constructor(e){this.configProvider=e}toGumConstraints(e){const t={};if(e.audio&&(t.audio=ct(e.audio),t.audio.deviceId&&delete t.audio.deviceId,e.audio.deviceId&&e.audio.deviceId!==Qe.MEDIA_DEVICE.defaultId&&(t.audio.deviceId={exact:e.audio.deviceId})),e.video){t.video={width:{},height:{},frameRate:{}},e.video.deviceId&&(t.video.deviceId={exact:e.video.deviceId}),e.video.minWidth&&(t.video.width.min=e.video.minWidth),e.video.maxWidth&&(t.video.width.max=e.video.maxWidth),e.video.minHeight&&(t.video.height.min=e.video.minHeight),e.video.maxHeight&&(t.video.height.max=e.video.maxHeight),e.video.fps&&(t.video.frameRate.max=e.video.fps,t.video.frameRate.min=this.configProvider.config.minCameraOpenFps,t.video.frameRate.ideal=e.video.fps);for(const e in t.video)st(t.video[e])&&delete t.video[e]}return t}toTrackConstraints(e){const t={};return e.video&&(e.video.minWidth&&(t.width=e.video.minWidth),e.video.minHeight&&(t.height=e.video.minHeight),e.video.fps&&(t.frameRate=e.video.fps)),t}},vR=class{toGumConstraints(e){if(!e||!e.video)throw new Error(`constraints cannot be applied: ${e}`);const t={video:{}},i=e.video.deviceId&&e.video.deviceId!==Qe.DISPLAY_SOURCE_ID;return e.video.resizeMode&&(t.video.resizeMode=e.video.resizeMode),i&&(t.video.deviceId={exact:e.video.deviceId}),e.video.maxWidth&&(t.video.width={max:e.video.maxWidth},i&&(t.video.width.ideal=e.video.maxWidth)),e.video.maxHeight&&(t.video.height={max:e.video.maxHeight},i&&(t.video.height.ideal=e.video.maxHeight)),e.video.fps&&(t.video.frameRate=e.video.fps),e.audio&&(t.audio=!e.audio.deviceId||{deviceId:{exact:e.audio.deviceId}}),t}toTrackConstraints(e){const t=navigator.mediaDevices.getSupportedConstraints();if(!t)throw new Error("Constraints are not supported by browser");const i={};return t.width&&e.video.minWidth&&(i.width=e.video.minWidth),t.height&&e.video.minHeight&&(i.height=e.video.minHeight),t.frameRate&&e.video.fps&&(i.frameRate=e.video.fps),i.resizeMode=e.video.resizeMode,i}},yR=class extends mR{constructor(e,t){if(super(t.createChild("WebRTCProvider")),this.configProvider=e,this.timeoutId=null,void 0!==navigator.webkitGetUserMedia&&void 0!==webkitRTCPeerConnection&&Up()){if(!this.configProvider.config.overrideGumFromWebkit||!Np)return void(this.constraintsAdapter=new fR(e));this.logger.safe.info("Overriding getUserMedia from webkit"),Fp()}this.constraintsAdapter=new SR(e)}getStream(e){if(!e.withTimeout||!this.configProvider.config.gumRequestTimeout)return super.getStream(e);const t=this.startGumRequestTimer(e),i=super.getStream(e).then((t=>{if(!this.timeoutId)throw this.stopStreamAfterTimeout(t,e),this.getMediaStreamTimeoutError(e);return this.stopGumRequestTimer(),t}));return Promise.race([t,i]).catch((e=>{throw this.stopGumRequestTimer(),e}))}getMediaStreamTimeoutError(e){const t={name:Qe.MEDIA_ERROR.mediaStreamRequestTimedOut,message:`Media stream request timed out. Constraints: ${Ve(mm(e))}`};return new pR(t,e).getMediaError()}startGumRequestTimer(e){return new Promise(((t,i)=>{this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,i(this.getMediaStreamTimeoutError(e))}),this.configProvider.config.gumRequestTimeout)}))}stopGumRequestTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}stopStreamAfterTimeout(e,t){this.logger.safe.info(`Stopping media stream acquired after timeout: ${JSON.stringify(e.id)} with constraints: ${JSON.stringify(t)}`);try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.stop()})),this.logger.safe.info(`Media stream stopped: ${e.id}`)}catch(e){this.logger.safe.warn(`Failed to stop media stream: ${Ve(e)}`)}}},CR=class extends mR{constructor(e){super(e.createChild("WebRTCDispProvider")),this.constraintsAdapter=new vR}static isSupported(){return!!window.navigator.mediaDevices.getDisplayMedia}getStream(e){const t=this.constraintsAdapter.toGumConstraints(e);return this.logger.safe.info(`Constraints to be used: ${JSON.stringify(t)}`),Promise.resolve().then((()=>e.video?.deviceId&&e.video?.deviceId!==Qe.DISPLAY_SOURCE_ID?Vp.window.navigator.mediaDevices.getUserMedia(t):Vp.window.navigator.mediaDevices.getDisplayMedia(t))).catch((t=>{throw new pR(t,e).getMediaError()}))}},_R=class{constructor(e){this.detail=e}getStream(e){throw this.getError(e)}applyConstraints(e,t){throw this.getError(t)}applyConstraintsForTrack(e,t){throw this.getError(t)}getError(e){return{type:Qe.MEDIA_ERROR.unsupportedStream,detail:this.detail,message:this.detail,isAudio:!!e.audio}}},ER=class{static getStreamProvider(e,t,i){return"ScreenShare"===e?CR.isSupported()?new CR(i):(i.error("GUM stream provider cannot be created for display stream"),new _R("Sharing not supported")):new yR(t,i)}},TR=class extends ze{constructor(e,t,i){super(i),this.mediaStream=e,this.logger=i,this.mediaStreamSubscriptions=[],this.isHold=!1,this.isMuted=this.mediaStream.getMuted(),this._isDisposed=!1,this.originalId=e.id,this.subscribeOnMediaStreamEvents(),this.update(t),this.logger.safe.info("ctor"),this.mediaType=this.mediaStream.mediaType}get id(){return this.originalId}get parentId(){return this.originalId}get rawStream(){return this.gumStream}get rawTrack(){return this.getTrackByMediaType(this.rawStream,this.mediaType)}get deviceId(){return this.mediaStream.deviceId}update(e){e&&(this.gumStream=e,this.enableDisableTracks())}dispose(){this._isDisposed?this.logger.safe.info("already disposed"):(this._isDisposed=!0,this.logger.safe.info("dispose"),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaStream&&(this.mediaStream.disposeClient(this),this.unsubscribeFromMediaStreamEvents(),this.mediaStream=null),this.event("onStreamClientDisposed").raise(this))}clone(){const e=this.mediaStream.getClient();return this.isMuted&&e.setMuted(!0),this.isHold&&e.setHold(!0),e}applyCapabilities(e){return this.mediaStream.applyCapabilities(e)}setMuted(e,t=Te()){this.isMuted=e||this.mediaStream.getMuted(),this.logger.safe.info(`[${t}] setMuted => ${this.isMuted}`),this.enableDisableTracks()}setHold(e){this.isHold=e,this.enableDisableTracks()}start(){return this.mediaStream.start()}hasAudio(){return this.mediaStream.hasAudio()}hasVideo(){return this.mediaStream.hasVideo()}hasDisplay(){return this.mediaStream.hasDisplay()}isSameStream(e){return this.parentId===e.parentId}getResolution(){return this.mediaStream.getResolution()}getFrameRate(){return this.mediaStream.getFrameRate()}isActive(){return!0}isDisposed(){return this._isDisposed}subscribeOnMediaStreamEvents(){this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamStarted",((e,t)=>{this.event("onStreamClientStarted").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamError",((e,t)=>{this.event("onStreamClientError").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackMuted",((e,t)=>{this.event("onStreamClientMuted").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackEnded",((e,t)=>{this.event("onStreamClientEnded").raise(this,t)})))}unsubscribeFromMediaStreamEvents(){this.mediaStreamSubscriptions.forEach((e=>e.dispose())),this.mediaStreamSubscriptions=[]}enableDisableTracks(){this.gumStream?this.gumStream.getTracks().forEach((e=>{void 0!==e.enabled&&(e.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`Track ${JSON.stringify(e.id)} enabled state set to => ${e.enabled}`))})):this.logger.safe.warn("gumStream stream doesn't exist")}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}},IR=[30,15,7.5,3.75,1.875];function bR(e){return e&&e.getVideoTracks()[0]?AR(e.getVideoTracks()[0]):null}function AR(e){if(e&&e.getSettings){const t=e.getSettings();if(t)return{width:t.width,height:t.height}}return null}function RR(e){return e&&e.getVideoTracks()[0]?wR(e.getVideoTracks()[0]):0}function wR(e){if(e&&e.getSettings){const t=e.getSettings();if(t)return pt(IR,t.frameRate,!0)}return 0}var PR=class e extends ze{constructor(t,i,n,r){super(n),this.streamConstraints=t,this.serialQueue=i,this.configProvider=r,this.clientId=0,this.clients=[],this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.isMuted=!1,this.isHold=!1,this.gumStartTime=0,this.streamId=e.streamGeneration++,this.logger=n.createChild(`MediaStream:${this.streamId}`),this.mediaType=this.getMediaType(this.streamConstraints),this.constraintsProvider=uR.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(t)}get id(){return this.streamId}get rawStream(){return this.currentGumStream}get deviceId(){return this.rawStream?.getTracks()?.[0]?.getSettings?.()?.deviceId??null}applyCapabilities(e){if(this.currentGumStream){const t=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,e,this.getResolution());if(!t)return Promise.resolve(!1);if(this.currentConstraints!==t){this.currentConstraints=t;const e=this.currentConstraints;return this.hasDisplay()?this.applyConstraints(this.currentConstraints).then((()=>ht(this.currentConstraints,e))).catch((e=>(this.logger.safe.error(`Apply constraints error: ${Ve(e)}`),!1))):this.applyConstraintsInternal().then((()=>ht(this.currentConstraints,e)))}}return Promise.resolve(!1)}getClient(){let e;this.currentGumStream?(e=this.getClone(),this.clientGumStreams.push({[this.constraintsProvider.getKey(this.currentConstraints)]:e})):this.clientGumStreams.push({});const t=new TR(this,e,this.logger.createChild("Client:"+this.clientId++));return this.clients.push(t),t}getClone(){return this.hasDisplay()?this.currentGumStream:this.currentGumStream.clone()}setMuted(e){this.isMuted=e,this.clients.forEach((t=>{t.setMuted(e)})),this.enableDisableTracks()}getMuted(){return this.isMuted}setHold(e){this.isHold=e,this.clients.forEach((t=>{t.setHold(e)})),this.enableDisableTracks()}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(){for(let e=this.clients.length-1;e>=0;e--)this.clients[e].dispose()}disposeClient(e){const t=this.clients.indexOf(e);t>=0&&(this.clients.splice(t,1),this.streamsDump.push(this.clientGumStreams[t]),this.clientGumStreams.splice(t,1),0===this.clients.length)&&this.disposeStream()}async disposeStream(){this.event("onStreamDisposing").raise(this);try{await this.stopGumStream(),this.event("onStreamDisposed").raise(this)}catch(e){this.event("onStreamError").raise(this,e)}this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),super.dispose()}hasAudio(){return!!this.currentGumStream&&0!==this.currentGumStream.getAudioTracks().length}hasVideo(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId!==Qe.DISPLAY_SOURCE_ID}hasDisplay(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId===Qe.DISPLAY_SOURCE_ID}getVideoDeviceId(){return this.currentConstraints.video.deviceId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=bR(this.currentGumStream),i=t??e,n=`Stream resolution is ${i.width}x${i.height}.`;return t?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=RR(this.currentGumStream);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}async startStream(e){let t;t=e.video?this.applyConstraintsInternal():this.updateGumStreamInternal(e);try{await t,this.event("onStreamStarted").raise(this,e)}catch(e){throw this.event("onStreamError").raise(this,e),e}}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(e)}`)}updateClients(e){const t=this.constraintsProvider.getKey(e);this.clients.forEach(((e,i)=>{this.clientGumStreams[i][t]||(this.clientGumStreams[i][t]=this.getClone()),e.update(this.clientGumStreams[i][t])}))}applyConstraints(e){const t=this.getGumStreamProvider();return Promise.all(this.clients.map((i=>t.applyConstraints(i.rawStream,e)))).then((()=>{}))}applyConstraintsInternal(){return new Promise(((e,t)=>{this.logger.safe.info(`applying stream constraints: ${JSON.stringify(mm(this.currentConstraints))}`);const i=new Yu;this.clients.forEach((e=>{e.onApplyConstraints&&e.onApplyConstraints(i.promise)}));const n=this.serialQueue.add((()=>{const e=(new gR).getPolicies(this.currentConstraints);return this.mediaStreamStartPromise=this.updateGumStreamInternal(e[0]),e.slice(1).forEach((e=>{this.mediaStreamStartPromise=this.mediaStreamStartPromise.catch((t=>{if(Qe.MEDIA_ERROR.constraintNotSatisfiedError===t.type)return this.logger.safe.warn("could not obtain constrained media stream, will attempt weaker policy"),this.updateGumStreamInternal(e);throw t.constraints=e,t}))})),this.mediaStreamStartPromise})).then((()=>{i.resolve()})).catch((e=>{throw this.logger.safe.error(`failed to apply constraints: ${JSON.stringify(mm(e.constraints))} error: ${Ve(e)}`),i.reject(e),e}));e(n)}))}enableDisableTracks(){this.currentGumStream&&this.currentGumStream.getTracks().forEach((e=>{void 0!==e.enabled&&(e.enabled=!("audio"===e.kind&&this.isMuted||this.isHold),this.logger.safe.info(`control media stream track kind: ${e.kind} enabled: ${e.enabled} muted: ${e.muted}`))}))}getGumStreamProvider(){return ER.getStreamProvider(this.mediaType,this.configProvider,this.logger.createChild("MSProvider"))}async updateGumStreamInternal(e){this.logger.safe.info(`querying user media for stream: ${JSON.stringify(e)}`),this.logger.safe.info("Getting GUM stream");const t=await this.getGumStream(e);this.logger.safe.info("Updating gum stream audio tracks"),this.updateGumStreamAudioTracks(t),this.currentGumStream=t,this.logger.safe.info("Updating stream constraints"),this.updateConstraints(e,t),this.logger.safe.info("Caching GUM stream"),this.cacheGumStream(this.currentConstraints,t),this.updateClients(this.currentConstraints),this.updateGumStreamVideoTracks(t),this.enableDisableTracks(),this.logger.safe.info("media stream updated");const i=this.stopRequestCalculation();this.event("onStreamAcquired").raise(this,i,(this.hasVideo()||this.hasDisplay())&&this.getResolution()||void 0)}async getGumStream(e){const t=this.gumStreams[this.constraintsProvider.getKey(e)];if(t)return t;const i=this.getGumStreamProvider();return this.startRequestCalculation(),i.getStream(e)}updateGumStreamAudioTracks(e){e.getAudioTracks().forEach((e=>{e.onended=e=>{this.logger.safe.info(`Audio stream track ended: ${JSON.stringify(e.error?.name||e)}`),this.event("onStreamTrackEnded").raise(this,e)},e.onmute=()=>{this.logger.safe.info("Audio stream track muted"),this.event("onStreamTrackMuted").raise(this,!0)},e.onunmute=()=>{this.logger.safe.info("Audio stream track unmuted"),this.event("onStreamTrackMuted").raise(this,!1)},e.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(e.id)}`)}))}updateGumStreamVideoTracks(e){const[t]=e.getVideoTracks();t&&(t.onmute=e=>{this.logger.safe.error(`Video stream track muted: ${JSON.stringify(mm(this.currentConstraints))}; ${JSON.stringify(e)}`)},t.onended=e=>{this.logger.safe.info(`Video stream track ended: ${JSON.stringify(mm(this.currentConstraints))}; ${JSON.stringify(e?.error.name||e)}`),this.event("onStreamTrackEnded").raise(this,e)},this.hasDisplay()&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(t,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(t.id)}`))}cacheGumStream(e,t){const i=this.constraintsProvider.getKey(e);this.gumStreams[i]!==t&&(this.gumStreams[i]&&(this.logger.safe.info(`Stream cache hit for ${i}, stopping old stream`),this.stopOneGumStream(this.gumStreams[i])),this.gumStreams[i]=t)}updateConstraints(e,t){this.currentConstraints=e.video?this.constraintsProvider.updateResolution(e,this.getResolution()):e,this.logger.safe.info(`Stream constraints updated: ${JSON.stringify(this.currentConstraints)}`)}applyContentHint(e,t){["","text","detail","motion"].indexOf(t)<0?this.logger.safe.error(`Cannot apply content hint: ${t}`):(this.logger.safe.info(`Apply content hint: ${t}`),e.contentHint=t)}startRequestCalculation(){this.gumStartTime=Date.now()}stopRequestCalculation(){if(0===this.gumStartTime)return 0;const e=Date.now()-this.gumStartTime;return this.gumStartTime=0,e}stopGumStream(){return this.mediaStreamStartPromise?(this.logger.safe.info("queueing media stream stop"),this.serialQueue.add((()=>{this.stopGumStreamInternal()}))):Promise.resolve()}stopOneGumStream(e){try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.onended=null,e.onmute=null,e.stop()})),this.logger.safe.info("media stream stopped")}catch(e){this.logger.safe.warn(`failed to stop media stream: ${Ve(e)}`)}}stopGumStreamInternal(){this.currentGumStream&&([...this.clientGumStreams,...this.streamsDump,this.gumStreams].forEach((e=>{Xe(e,(e=>{this.stopOneGumStream(e)}))})),this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.currentGumStream=null)}};PR.streamGeneration=0;var MR=PR,DR=class extends ze{constructor(e,t,i,n,r,s,a){super(a),this.id=e,this.masterStream=t,this.currentConstraints=i,this.constraintsProvider=n,this.streamProvider=r,this.configProvider=s,this._isDisposed=!1,this.masterStreamSubscriptions=[],this.mixerSubscriptions=[],this.parentId=t.id,this.logger=a.createChild(`C:${this.parentId}:${this.id}`),this.subscribeOnMasterStreamEvents()}get rawTrack(){return this.mediaTrack}get rawStream(){return this.rawMediaStream||(this.rawMediaStream=new MediaStream([this.mediaTrack]),this.configProvider.config.reassignMediaStreamAudioTrackAfterCreation&&this.rawMediaStream.getAudioTracks().length>0&&(this.rawMediaStream.removeTrack(this.rawMediaStream.getAudioTracks()[0]),this.rawMediaStream.addTrack(this.mediaTrack))),this.rawMediaStream}get deviceId(){return this.masterStream.deviceId}get mediaType(){return this.masterStream.mediaType}get originalMediaStream(){return this.masterStream.getOriginalMediaStream()}getCurrentConstraints(){return this.currentConstraints}dispose(e){this._isDisposed||(this._isDisposed=!0,this.logger.safe.info(`dispose: ${e}`),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaTrack&&(this.unsubscribeFromMediaTrackEvents(),this.mediaTrack=null),this.masterStream&&(this.unsubscribeFromMasterStreamEvents(),this.masterStream.disposeClient(this),this.masterStream=null),this.unsubscribeFromMixerTrackEvents(),super.dispose(),this.event("onStreamClientDisposed").raise(this))}async applyCapabilities(e){if(!this.mediaTrack)return!1;const t=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,e,this.getResolution());if(!t||!this.configProvider.config.recoverOnStreamUnmute&&this.currentConstraints===t)return!1;const i=async e=>{try{return await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,t),this.currentConstraints=t,!0}catch(t){if(e)throw this.logger.safe.error(`Apply constraints error: ${JSON.stringify(t)}`),t;return this.logger.safe.warn(`Apply constraints failed and will be re-tried, error ${JSON.stringify(t)}`),!1}},n=this.currentConstraints.withEffect&&this.configProvider.config.effectsApplyConstraintsRetryMs;return!await i(!n)&&n&&(await km(this.configProvider.config.effectsApplyConstraintsRetryMs),await i(!0)),!0}start(){return this.masterStream.start()}clone(e){return this.masterStream||this.logger.safe.error(`clone: master stream is null, reason: ${e}`),this.masterStream.getClient(`streamclient: ${e}`)}setMuted(e,t){this.isMuted=e,this.applyState(t)}setHold(e,t){this.isHold=e,this.applyState(t)}isSameStream(e){return this.parentId===e.parentId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=AR(this.mediaTrack),i=t?.width?t:e,n=`Track resolution is ${i.width}x${i.height}.`;return t?.width?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=wR(this.mediaTrack);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}update(e){e?this.mediaTrack?this.logger.safe.error(`Media track is already created: ${this.mediaTrack.id}`):(this.mediaTrack=this.getTrackByMediaType(e,this.mediaType),this.updateTrackConstraints(),this.subscribeOnMediaTrackEvents(this.mediaTrack),this.hasMasterAudio=e&&e.getAudioTracks().length>0,this.hasMasterVideo=e&&e.getVideoTracks().length>0,this.hasMasterAudio&&this.hasMasterVideo&&(this.rawMediaStream=e),this.logger.safe.info(`Updated: ${Im(e)}`)):this.logger.safe.error("No master media stream, skipping update")}resetEffectsOutputConstraints(e){this.masterStream.resetEffectsOutputConstraints(e)}async updateTrackConstraints(){if("ScreenShare"!==this.mediaType)return;const e=this.masterStream.getResolution();if(e){const t=this.currentConstraints.clone();t.video.maxWidth=e.width,t.video.minWidth=e.width,t.video.maxHeight=e.height,t.video.minHeight=e.height;try{await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,t),this.currentConstraints=t}catch(e){this.logger.safe.error(`Apply constraints error: ${JSON.stringify(e)}`)}}}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}applyState(e){void 0!==this.mediaTrack?.enabled&&(this.mediaTrack.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`[${e}] Track ${JSON.stringify(this.mediaTrack.id)} enabled state set to => ${this.mediaTrack.enabled}`))}subscribeOnMediaTrackEvents(e){e.onended=t=>{this.logger.safe.info(`Track ${e.id} ended: ${JSON.stringify(t)}`),this.event("onStreamClientEnded").raise(this,t)},e.onmute=()=>{this.logger.safe.info(`Track ${e.id} muted`),this.event("onStreamClientMuted").raise(this,!0)},e.onunmute=()=>{this.logger.safe.info(`Track ${e.id} unmuted`),this.event("onStreamClientMuted").raise(this,!1)}}unsubscribeFromMediaTrackEvents(){this.mediaTrack.onended=null,this.mediaTrack.onmute=null,this.mediaTrack.onunmute=null}unsubscribeFromMixerTrackEvents(){this.mixerSubscriptions.forEach((e=>e.dispose())),this.mixerSubscriptions=[]}subscribeOnMasterStreamEvents(){this.masterStreamSubscriptions.push(this.masterStream.on("onStreamStarted",((e,t)=>this.event("onStreamClientStarted").raise(this,t))),this.masterStream.on("onStreamError",((e,t)=>this.event("onStreamClientError").raise(this,t))),this.masterStream.on("onStreamTrackMuted",((e,t)=>this.event("onStreamClientMuted").raise(this,t))),this.masterStream.on("onStreamDisposing",(e=>this.dispose())),this.masterStream.on("onStreamQualityChanged",((e,t,i,n)=>this.event("onStreamQualityChanged").raise(this,t,i,n))),this.masterStream.on("onStreamTrackEnded",((e,t)=>this.event("onStreamClientEnded").raise(this,t))))}unsubscribeFromMasterStreamEvents(){this.masterStreamSubscriptions.forEach((e=>e.dispose())),this.masterStreamSubscriptions=[]}hasAudio(){return this.hasMasterAudio}hasVideo(){return this.hasMasterVideo}isActive(){return this.mediaTrack?.enabled&&!this.mediaTrack?.muted&&"live"===this.mediaTrack?.readyState}onVideoStreamQualityChanged(e,t,i){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(e)}@${t}, reason=${i}`),this.masterStream.onVideoStreamQualityChanged(e,t,i)}isDisposed(){return this._isDisposed}},OR=class extends ze{constructor(e,t,i,n,r,s){super(s),this.stream=e,this.constraints=t,this.constraintsProvider=i,this.gumStreamProvider=n,this.configProvider=r,this.logger=s,this.clients=[],this.streams=[],this.clientId=0,this.mediaStreamSubscription=this.stream.on("onStreamAcquired",(()=>this.onStreamAcquired()))}getClient(){const e=new DR(this.clientId++,this.stream,this.constraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger);return this.addClient(e),e}disposeClient(e){this.removeClient(e),this.clients.length||this.event("onAllClientsDisposed").raise()}dispose(){this.mediaStreamSubscription.dispose(),this.clients.length&&this.logger.safe.error(`Not all clients are disposed! ${JSON.stringify(this.clients.map((e=>e.id)))}`),this.streams.forEach((e=>this.disposeStream(e))),super.dispose()}getOrCreateStream(){const e=this.streams.length?this.streams[this.streams.length-1]:this.stream.rawStream;if(!e)return null;const t=e.clone();return this.logger.safe.info(`Cloned: ${Im(e)} -> ${Im(t)}`),this.resetStream(t),this.streams.push(t),t}addClient(e){this.updateClient(e),this.clients.push(e)}updateClient(e){const t=this.getOrCreateStream();t&&e.update(t)}removeClient(e){const t=this.clients.indexOf(e);this.clients.splice(t,1)}addStream(){this.clients.forEach((e=>this.updateClient(e)))}disposeStream(e){e.getTracks().forEach((e=>{this.logger.safe.info(`Stopping track: ${JSON.stringify(e.id)}`),e.stop()}))}onStreamAcquired(){this.addStream()}resetStream(e){e.getTracks().forEach((e=>{this.logger.safe.info(`Resetting state for track: ${e.id}`),e.enabled=!0}))}},kR=class{static getStrategy(e,t,i,n,r,s){return s?new UR(i,n):"Video"===e?new xR(t,i,n,r):new LR(t,i,n)}},NR=class{constructor(e,t,i){this.gumStreamProvider=e,this.serialQueue=t,this.logger=i}getStream(e){return this.logger.safe.info(`Requesting stream with constraints: ${JSON.stringify(mm(e))}`),this.serialQueue.add((()=>this.request(e)))}},LR=class extends NR{constructor(e,t,i){super(e,t,i.createChild("SimpleStrat"))}request(e){return this.gumStreamProvider.getStream(e)}},xR=class extends NR{constructor(e,t,i,n){super(e,t,i.createChild("MultStrat")),this.policyGenerator=new gR}request(e){const t=this.policyGenerator.getPolicies(e);return this.makeRequests(t)}makeRequests(e){const t=e[0];return this.logger.safe.info(`Requesting media stream with policy: ${JSON.stringify(t)}`),this.makeRequestWithPolicy(t).catch((t=>{const i=e.slice(1);if(i.length&&Qe.MEDIA_ERROR.constraintNotSatisfiedError===t.type)return this.logger.safe.warn("Could not obtain constrained media stream, will attempt weaker policy"),this.makeRequests(i);throw t}))}makeRequestWithPolicy(e){return this.gumStreamProvider.getStream(e)}},UR=class extends NR{constructor(e,t){super(null,e,t.createChild("WithOveriddenStreamStart"))}request(e){return new Promise(((t,i)=>t(e.withOverridenStream)))}},FR=class e extends ze{constructor(t,i,n,r,s){super(r),this.serialQueue=i,this.configProvider=n,this.effectManager=s,this.gumRequestTime=0,this.id=e.streamId++,this.logger=r.createChild(`MediaStream:${this.id}`),this.mediaType=this.getMediaType(t),this.initialize(t)}get rawStream(){return this.mediaStream}get deviceId(){return this.originalMediaStream?this.originalMediaStream.getTracks()?.[0]?.getSettings?.()?.deviceId:null}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(e){this.event("onStreamDisposing").raise(this),this.stopMediaStream(e).catch((e=>{this.event("onStreamError").raise(this,e)})).finally((()=>{this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),this.clientGenerationStrategy.dispose(),this.event("onStreamDisposed").raise(this),super.dispose()}))}disposeClient(e){this.clientGenerationStrategy.disposeClient(e)}getClient(e){return this.logger.safe.debug(`getClient: ${e}`),this.clientGenerationStrategy.getClient()}getOriginalMediaStream(){return this.originalMediaStream}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=bR(this.mediaStream),i=t??e,n=`Stream resolution is ${i.width}x${i.height}.`;return t?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=RR(this.mediaStream);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(e)}`)}resetEffectsOutputConstraints(e){const t=bR(this.originalMediaStream);this.effectManager.resetOutputConstraints("Video",{width:Math.min(e.width,t.width||Number.MAX_SAFE_INTEGER),height:Math.min(e.height,t.height||Number.MAX_SAFE_INTEGER)})}initialize(e){this.constraintsProvider=uR.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(e),this.gumStreamProvider=ER.getStreamProvider(this.mediaType,this.configProvider,this.logger),this.mediaStreamRequestStrategy=kR.getStrategy(this.mediaType,this.gumStreamProvider,this.serialQueue,this.logger,this.configProvider,!!this.currentConstraints.withOverridenStream),this.clientGenerationStrategy=new OR(this,this.currentConstraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger),this.clientGenerationStrategy.on("onAllClientsDisposed",(()=>this.onAllClientsDisposed()))}onAllClientsDisposed(){this.logger.safe.info("All clients are disposed, disposing master stream"),this.dispose()}async startStream(e){try{await this.getOrCreateMediaStream(e),this.event("onStreamStarted").raise(this,this.currentConstraints)}catch(e){throw this.event("onStreamError").raise(this,e),e}}async getOrCreateMediaStream(e){if(this.mediaStream)return Promise.resolve();const t=this.getRequestStartTimestamp(),i=await this.mediaStreamRequestStrategy.getStream(e);return this.gumRequestTime=this.getRequestDuration(t),this.handleMediaStreamRequestSuccess(i,e)}async handleMediaStreamRequestSuccess(e,t){const i=t.withOverridenStream&&t.withEffect&&this.configProvider.config.useRawMediaApiForVideoEffects;this.logger.safe.info(`Media stream acquired: ${Im(e)} with constraints: ${JSON.stringify(mm(t))}`),this.originalMediaStream=e,this.subscribeToTrackEvents(this.originalMediaStream),this.currentConstraints=t,t.withEffect&&"Video"===this.mediaType&&!i?this.mediaStream=await this.getVideoEffectStream(e):this.mediaStream=e,await this.startNoiseSuppression(),this.applyState(this.mediaStream),this.event("onStreamAcquired").raise(this,this.gumRequestTime,"Audio"!==this.mediaType&&this.getResolution()||void 0)}async getVideoEffectStream(e){this.sub=this.effectManager.on("onVideoStreamQualityChanged",((e,t,i)=>this.onVideoStreamQualityChanged(e,t,i)));const t=await this.effectManager.startEffect("Video",e);return this.logger.safe.info(`Media stream switched: ${Im(e)} -> ${Im(t)}`),t}subscribeToTrackEvents(e){const t=e?this.getTrackByMediaType(e,this.mediaType):null;t&&(t.onended=e=>{this.logger.safe.info(`Track ${t.id} ended: ${JSON.stringify(e)}`),this.event("onStreamTrackEnded").raise(this,e)},t.onmute=()=>{this.logger.safe.info(`Track ${t.id} muted`),this.event("onStreamTrackMuted").raise(this,!0)},t.onunmute=()=>{this.logger.safe.info(`Track ${t.id} unmute`),this.event("onStreamTrackMuted").raise(this,!1)})}unsubscribeFromTrackEvents(e){const t=e?this.getTrackByMediaType(e,this.mediaType):null;t&&(t.onended=null,t.onmute=null,t.onunmute=null)}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}removeVideoEffectStream(){this.sub?.dispose(),this.effectManager.stopEffect("Video",this.mediaStream)}applyState(e){e.getAudioTracks()?.forEach((e=>this.applyAudioState(e)));const t=e.getVideoTracks()[0];this.applyVideoState(t)}applyAudioState(e){e&&(this.hasNonDefaultAudioProcessingConstraints()||"ScreenShare"===this.mediaType?this.applyContentHint(e,"music"):this.configProvider.config.defaultAudioContentHint&&this.applyContentHint(e,this.configProvider.config.defaultAudioContentHint),e.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(e.id)}`))}applyVideoState(e){e&&("ScreenShare"===this.mediaType&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(e,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(e.id)}`))}applyContentHint(e,t){this.logger.safe.info(`Apply content hint: ${t}`),e.contentHint=t}hasNonDefaultAudioProcessingConstraints(){const e=this.currentConstraints.audio;if(e){const t=this.configProvider.config.defaultAudioProcessingFlags;let i;return void 0===e.echoCancellation&&void 0===e.autoGainControl&&void 0===e.noiseSuppression||(i=0,void 0!==e.echoCancellation&&(i+=e.echoCancellation?2:0),void 0!==e.autoGainControl&&(i+=e.autoGainControl?1:0),void 0!==e.noiseSuppression&&(i+=e.noiseSuppression?4:0)),i!==t}return!1}getRequestStartTimestamp(){return Date.now()}getRequestDuration(e){return 0===e?0:Date.now()-e}async startNoiseSuppression(){"Audio"===this.mediaType&&(this.logger.safe.info(`ECS keys for wasmvqe are: ${JSON.stringify(this.configProvider.config.wasmvqe)}`),this.logger.safe.info(`ECS keys for wasmdns are: ${JSON.stringify(this.configProvider.config.wasmdns)}`),this.configProvider.config.applyAudioEffectOnDemand&&!this.currentConstraints.withEffect||(this.mediaStream=await this.effectManager.startEffect("Audio",this.mediaStream)))}stopMediaStream(e){return this.mediaStreamStartPromise?(this.logger.safe.info(`Queueing media stream stop: ${e}`),this.serialQueue.add((()=>this.stopMediaStreamInternal()))):Promise.resolve()}stopOneMediaStream(e){try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.stop()})),this.logger.safe.info(`Media stream stopped: ${e.id}`)}catch(e){this.logger.safe.warn(`Failed to stop media stream: ${Ve(e)}`)}}stopMediaStreamInternal(){"Video"===this.mediaType&&this.configProvider.config.enableVideoEffects&&this.removeVideoEffectStream(),this.mediaStream&&(this.stopOneMediaStream(this.mediaStream),this.mediaStream=null),this.originalMediaStream&&(this.stopOneMediaStream(this.originalMediaStream),this.unsubscribeFromTrackEvents(this.originalMediaStream),this.originalMediaStream=null)}onVideoStreamQualityChanged(e,t,i){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(e)}@${t}, reason=${i}`),this.event("onStreamQualityChanged").raise(this,e,t,i)}};FR.streamId=0;var VR=FR,BR=class e extends ze{constructor(e,t,i){super(e),this.logger=e,this.configProvider=t,this.effectsManager=i,this.cachedStreamsSubs=new Map,this.cachedStreamsMap=new Map,this.mediaStreamSerialQueue=new $A(this.logger),this.couldUseWebrtc_1_0=!1}getMediaStream(e,t){this.logger.safe.info(`retrieving media stream: ${JSON.stringify(mm(e))}`),this.cachedStreamsMap.size||(this.couldUseWebrtc_1_0=Sm(this.configProvider.config.checkSupportForWebrtc_1_0));let i=this.getSuitableStream(e);i||(this.logger.safe.info(`cached stream is not found. Creating a new one with constraints: ${Ve(mm(e))}`),i=this.createCachedStream(e)),this.logger.safe.info(`starting cached stream id=${i.id}`,t);const n=i.getClient(t);return n.start().catch((e=>{this.logger.safe.error(`could not start media stream: ${i.id}, total streams: ${this.cachedStreamsMap.size}, error: ${Ve(e)}`),this.removeStream(i)})),n}dispose(){this.cachedStreamsSubs&&(this.cachedStreamsSubs.forEach((e=>{e.forEach((e=>{e.dispose()}))})),this.cachedStreamsSubs=null),this.cachedStreamsMap&&(this.cachedStreamsMap.forEach((e=>e.dispose("MSM dispose"))),this.cachedStreamsMap=null),this.mediaStreamSerialQueue&&(this.mediaStreamSerialQueue.dispose(),this.mediaStreamSerialQueue=null),super.dispose()}getCachedStreams(){return this.cachedStreamsMap}getActiveConstraints(){const e={audio:!1,video:!1,sharing:!1};return this.cachedStreamsMap.forEach(((t,i)=>{i.audio&&(e.audio=!0),i.video&&(e.video=!0),i.sharing&&(e.sharing=!0)})),e}onDevicesChanged(t){this.configProvider.config.enablePermissionsWorkaround&&e.isDeviceListEmpty(t)?this.logger.safe.info("Device list is empty, permission workaround enabled"):this.cachedStreamsMap.forEach(((e,i)=>{if(!i.sharing){const e=this.isDeviceOutdated(i.audio,t),n=this.isDeviceOutdated(i.video,t);(e||n)&&this.cachedStreamsMap.delete(i)}}))}getSuitableStream(e){let t;return this.cachedStreamsMap.forEach(((i,n)=>{this.isSuitable(this.addDeviceIdIfNecessary(i,n),e)&&(t=n)})),t&&this.cachedStreamsMap.get(t)}addDeviceIdIfNecessary(e,t){if(!e.deviceId)return t;const i=this.cloneStreamConstraints(t);return t.audio&&void 0===t.audio.deviceId&&(i.audio.deviceId=e.deviceId),t.video&&void 0===t.video.deviceId&&(i.video.deviceId=e.deviceId),t.sharing&&(i.sharing.deviceId=Qe.DISPLAY_SOURCE_ID),i}cloneStreamConstraints(e){return{...ct(e),withOverridenStream:e.withOverridenStream}}createCachedStream(e){const t=this.createStream(e);return this.event("onStreamCreated").raise(t.id,t.mediaType),this.subscribeOnStreamEvents(t),this.logger.safe.info(`created media stream, id: ${t.id} total: ${this.cachedStreamsMap.size}`),this.cachedStreamsMap.set(e,t),t}disposeCurrentDeviceStream(t){for(const[i,n]of this.cachedStreamsMap.entries())t.sharing||i.sharing||(e.deviceChanged(t.audio,i.audio)||e.deviceChanged(t.video,i.video))&&n.dispose("MSM dispose oneStreamPerDeviceType")}createStream(e){return this.configProvider.config.oneStreamPerDeviceType&&this.couldUseWebrtc_1_0&&this.disposeCurrentDeviceStream(e),this.configProvider.config.webrtcSimulcastSessionEnabled&&Bp.hasApplyConstraints()&&this.couldUseWebrtc_1_0?new VR(e,this.mediaStreamSerialQueue,this.configProvider,this.logger,this.effectsManager):new MR(e,this.mediaStreamSerialQueue,this.logger,this.configProvider)}subscribeOnStreamEvents(e){const t=[];t.push(e.on("onStreamAcquired",((e,t,i)=>this.onStreamAcquired(e,t,i)))),t.push(e.on("onStreamDisposing",(e=>this.onStreamDisposing(e)))),this.cachedStreamsSubs.set(e,t)}unsubscribeFromStreamEvents(e){this.cachedStreamsSubs.get(e).forEach((e=>e.dispose())),this.cachedStreamsSubs.delete(e)}removeStream(e){this.logger.safe.info(`release media stream generation: ${e.id} cached: ${this.cachedStreamsMap.size}`),this.cachedStreamsSubs.has(e)?(this.unsubscribeFromStreamEvents(e),this.cachedStreamsMap.delete(this.getConstraintsForStream(e)),this.getStreamsCountByType("Audio")||this.effectsManager.stopEffect("Audio"),this.cachedStreamsMap.size||this.event("onAllStreamsRemoved").raise()):this.logger.safe.warn(`skipping unknown stream ${e.id}`)}getConstraintsForStream(e){let t;return this.cachedStreamsMap.forEach(((i,n)=>{e===i&&(t=n)})),t}isSuitable(e,t){const i=!(!e.withOverridenStream||!t.withOverridenStream),n=i||t.sharing||this.isAcceptable(e.audio,t.audio)&&e.audioProcessingFlags===t.audioProcessingFlags,r=i||this.isAcceptable(e.video,t.video),s=this.configProvider.config.requireUserActionForAudioSharing&&t.sharing&&!!e.audio!=!!t.audio,a=this.isAcceptable(e.sharing,t.sharing),o=a&&this.isAcceptable(e.audio,t.audio),c=s?o:a,l=e.withEffect===t.withEffect,d=e.withOverridenStream?.id===t.withOverridenStream?.id;return!t.force&&n&&r&&c&&l&&d}isAcceptable(e,t){return!e&&!t||e&&t&&e.deviceId===t.deviceId}isDeviceOutdated(e,t){return e?.deviceId&&!t.some((t=>t.deviceId===e.deviceId))}onStreamDisposing(e){this.logger.safe.info(`onStreamDisposing event ${e.id}`),this.event("onStreamDisposing").raise(e.id,e.mediaType),this.removeStream(e)}onStreamAcquired(e,t,i){const n="Audio"===e.mediaType?void 0:!!e.rawStream.getAudioTracks()[0],r="ScreenShare"===e.mediaType?this.getSharingSource(e):void 0;this.event("onStreamAcquired").raise(e.id,e.mediaType,t,i,n,r)}getSharingSource(e){const t=e.rawStream.getVideoTracks()[0],i=t.getConstraints();if(i?.deviceId)return"camera";const n=t.getSettings();return n?.displaySurface??"unknown"}static deviceChanged(e,t){return!(!e||!t)&&e.deviceId!==t.deviceId}static isDeviceListEmpty(e){return e.every((e=>""===e.label))}getStreamsCountByType(e){let t=0;return this.cachedStreamsMap.forEach((i=>{t+=i.mediaType===e?1:0})),t}},HR=class{constructor(e,t,i,n,r){this.deviceId=e,this.label=t,this.kind=i,this.groupId=n,this.capabilities=r,this.type=this.getType(this.kind),this.guid=`${this.type}:${this.deviceId}`,this.isSystemDefault=this.deviceId===Qe.MEDIA_DEVICE.defaultId}toDeviceDesc(){return{id:this.guid,browserId:this.deviceId,label:this.label,kind:this.type}}getType(e){switch(e){case Qe.MEDIA_DEVICE_KIND.audioInput:return Qe.MEDIA_DEVICE.microphone;case Qe.MEDIA_DEVICE_KIND.audioOutput:return Qe.MEDIA_DEVICE.speaker;case Qe.MEDIA_DEVICE_KIND.videoInput:return Qe.MEDIA_DEVICE.camera;case Qe.MEDIA_DEVICE_KIND.compositeAudio:return Qe.MEDIA_DEVICE.compositeAudio;case Qe.MEDIA_DEVICE_KIND.virtualDevice:return Qe.MEDIA_DEVICE.virtualDevice;default:throw new Error(`Device kind to recognized: ${e}`)}}},$R=class extends HR{constructor(e,t,i,n){super(e,t,i,n)}},GR=class extends HR{constructor(e,t,i,n,r){super(e,t,i,n,r)}toDeviceDesc(){const e=super.toDeviceDesc();return e.isSystemDefault=this.isSystemDefault,e}},jR=class extends HR{constructor(e,t,i,n,r){if(super(e,t,i,n,r),this.position="unknown",r&&r.facingMode&&1===r.facingMode.length)switch(r.facingMode[0]){case"user":this.position="front";break;case"environment":this.position="back"}}toDeviceDesc(){const e=super.toDeviceDesc();return e.position=this.position,e}},qR=class extends HR{constructor(e,t,i,n,r,s){super(null,i,n,""),this.micDevice=e,this.speakerDevice=t,this.formFactor=r,this.isPcInternalDevice=s,this.guid=null,this.isSystemDefault=!1}get micDeviceId(){return this.micDevice.guid}get speakerDeviceId(){return this.speakerDevice.guid}toDeviceDesc(){const e=super.toDeviceDesc();return e.microphoneId=this.micDeviceId,e.speakerId=this.speakerDeviceId,e.formFactor=this.formFactor,e.isPcInternalDevice=this.isPcInternalDevice,e}};function WR(e){const t=e.getCapabilities&&e.getCapabilities();switch(t&&(delete t.groupId,delete t.deviceId),e.kind){case Qe.MEDIA_DEVICE_KIND.audioInput:case Qe.MEDIA_DEVICE_KIND.audioOutput:return new GR(e.deviceId,e.label,e.kind,e.groupId,t);case Qe.MEDIA_DEVICE_KIND.videoInput:return new jR(e.deviceId,e.label,e.kind,e.groupId,t);default:throw new Error(`Device kind is not recognized: ${e.kind}`)}}function zR(e,t,i){return new qR(e,t,i,"compositeAudio",0,!1)}function JR(e){switch(e){case Qe.MEDIA_DEVICE.microphone:return Qe.MEDIA_DEVICE_KIND.audioInput;case Qe.MEDIA_DEVICE.speaker:return Qe.MEDIA_DEVICE_KIND.audioOutput;case Qe.MEDIA_DEVICE.camera:return Qe.MEDIA_DEVICE_KIND.videoInput;default:throw new Error(`Device type to recognized: ${e}`)}}function KR(e,t,i,n,r={str:""}){r.str+=`|input(${t.length})`;let s=[];const a=[n.config.devices.blacklist[e],n.defaultConfig.devices.blacklist[e]];for(const e of a)try{const i=new RegExp(e,"i");s=t.filter((t=>e&&t.label.match(i)?(r.str+=`|-blacklisted(${t.label})`,!1):t.deviceId!==Qe.MEDIA_DEVICE.communicationsId||(r.str+="|-communications",!1)));break}catch(i){r.str+=`|filterError('${e}', ${Ve(i)})`,s=t}if(s.length){const t=function(e,t,i){if(1===t.length)return i.str+="|default:only",t[0];const n=t.find((e=>e.isSystemDefault&&e.deviceId===Qe.MEDIA_DEVICE.defaultId));if(!n)return i.str+="|default:noSynthetic",t.find((e=>e.isSystemDefault))||t[0];{const r=t.filter((e=>e!==n));if(1===r.length)return i.str+="|default:firstNonDefault",r[0];if(""!==n.groupId){const e=r.filter((e=>e.groupId===n.groupId));if(1===e.length)return i.str+=`|default:groupId(${we(e[0].guid)})`,e[0]}const s=r.map((e=>e.label)),a=function(e,t){return t.reduce(((t,i)=>{const n=e.includes(i)?i.length:0;return t.length<n?i:t}),"")}(n.label,s),o=r.find((e=>e.label===a));if(o)return i.str+=`|default:label(${we(o.guid)})`,o;const c=e.find((e=>e.isSystemDefault));if(c){const e=r.find((e=>e.deviceId===c.deviceId));if(e)return i.str+=`|default:previousList(${we(e.guid)})`,e}}return i.str+="|default:anyOrNull",t.find((e=>e.isSystemDefault))||null}(i,s,r);if(t&&(t.isSystemDefault=!0,r.str+=`|default(${we(t.guid)})`),t&&t.deviceId!==Qe.MEDIA_DEVICE.defaultId&&s.length>1&&(s=s.filter((e=>e.deviceId!==Qe.MEDIA_DEVICE.defaultId||(r.str+="|-defaultId",!1)))),e===Qe.MEDIA_DEVICE.camera||t||(r.str+="|+syntheticDefault",s.unshift(function(e){const t={deviceId:Qe.MEDIA_DEVICE.defaultId,label:Qe.MEDIA_DEVICE.defaultDeviceLabel,kind:JR(e),groupId:"",toJSON:()=>JSON.stringify(t)};return WR(t)}(e))),i.forEach((e=>{const t=s.find((t=>t.guid===e.guid));t&&!t.label&&e.label&&(r.str+=`|migrateLabel(${we(t.guid)})`,t.label=e.label)})),e===Qe.MEDIA_DEVICE.speaker){const e=s.filter((e=>""===e.label));e.length>1&&e.length===s.length&&(s=t?[t]:[s[0]],r.str+=`|-filteredEmptyLabels(${e.length})`)}}return s}function YR(e,t,i=.5,n={str:""}){const r=[];if(e.length&&t.length){const s=function(e,t,i={str:""}){const n=new Set;for(const i of[...e,...t])n.add(i.groupId);const r=[];for(const s of n.values()){let n=e.filter((e=>e.groupId===s)),a=t.filter((e=>e.groupId===s));if(n&&a)if(1===n.length&&1===a.length)r.push({microphone:n[0],speaker:a[0]}),i.str+=`|pairSimple(${we(n[0].guid)}, ${we(a[0].guid)})`;else if(n.length>1||a.length>1){let e=QR(n,a);for(;e;)i.str+=`|pairComplex(${we(e.microphone.guid)}, ${we(e.speaker.guid)})`,r.push(e),n=n.filter((t=>t!==e.microphone)),a=a.filter((t=>t!==e.speaker)),e=QR(n,a)}}return r}(e.filter((e=>""!==e.groupId)),t.filter((e=>""!==e.groupId)),n);s.length&&(r.push(...s.map((e=>zR(e.microphone,e.speaker,XR(e.microphone.label,e.speaker.label))))),n.str+=`|directMatched(${r.length})`);const a=r.length;r.push(...function(e,t,i,n){const r=[];return e.length&&t.length?(e.forEach((e=>{const s=t.filter((t=>t.groupId===e.groupId));if(!s.length)return void(n.str+=`|lbl_nocand(${we(e.guid)})`);let a=vt(e.label,s[0].label).length;const o=s.sort(((t,i)=>{const n=vt(e.label,t.label),r=vt(e.label,i.label);return n.length>a&&(a=n.length),r.length>a&&(a=r.length),r.length-n.length}));if(o.length){const t=a/e.label.length;t>i&&(r.push(zR(e,o[0],XR(e.label,o[0].label))),n.str+=`|lbl_matched(${we(e.guid)} & ${we(o[0].guid)}, ${Math.round(1e4*t)/100}%)`)}})),r):r}(e.filter((e=>!r.some((t=>t.micDeviceId===e.guid)))),t.filter((e=>!r.some((t=>t.speakerDeviceId===e.guid)))),i,n)),n.str+=`|otherMatched(${r.length-a})`}return r}function QR(e,t){let i=999,n=null;if(e.length>0&&t.length>0)for(const r of e)for(const e of t){const t=yt(r.label,e.label);t<i&&(i=t,n={microphone:r,speaker:e})}return n}function XR(e,t){if(e===t)return e;let i=vt(e,t);i=i.trim().replace(/^\((.+)\)$/,"$1");let n="",r="",s=0;const a=[ZR(e),ZR(t)];if(0===a[0]||0===a[1])return i;for(let e=0;e<i.length;e++)if("("===i[e])s++,r+=i[e];else if(")"===i[e]){if(!(s>0))break;s--,r+=i[e],n+=r,r=""}else s>0?r+=i[e]:n+=i[e];const o=ZR(n);return o!==a[0]&&o!==a[1]||(n=n.replace(/\w+\s?\((.+)\)/,"$1"),n=XR(i,n)),n.trim()}function ZR(e){const t=["(",")"];let i=0;for(let n=0;n<e.length;n++)t.some((t=>e[n]===t))&&i++;return i}var ew={microphone:"",camera:"",speaker:"",compositeAudio:"",audioIngestDevice:"",virtualDevice:""},tw=class extends ze{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.debugInfo=ew,this.lists=new Map,this.lists.set(Qe.MEDIA_DEVICE.microphone,[]),this.lists.set(Qe.MEDIA_DEVICE.camera,[]),this.configProvider.userAgentConfig.isAudioOutputSelectionSupported&&(this.lists.set(Qe.MEDIA_DEVICE.speaker,[]),this.lists.set(Qe.MEDIA_DEVICE.compositeAudio,[])),e.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>this.onConfigUpdated())),this.logger.safe.info("Initialized")}get devices(){const e=[];return this.lists.forEach((t=>e.push(...t))),e}getDevicesByType(e){return this.lists.get(e)??[]}updateDevices(e,t=!1){if(ht(this.latestRawList,e))return;this.latestRawList=e;const i=this.devices;this.debugInfo.microphone="microphone",this.debugInfo.camera="camera",this.debugInfo.speaker="speaker",this.debugInfo.compositeAudio="compositeAudio",this.updatePrimitiveDeviceList(Qe.MEDIA_DEVICE.microphone,e.filter((e=>e.type===Qe.MEDIA_DEVICE.microphone))),this.updatePrimitiveDeviceList(Qe.MEDIA_DEVICE.camera,e.filter((e=>e.type===Qe.MEDIA_DEVICE.camera))),this.lists.get(Qe.MEDIA_DEVICE.speaker)&&(this.updatePrimitiveDeviceList(Qe.MEDIA_DEVICE.speaker,e.filter((e=>e.type===Qe.MEDIA_DEVICE.speaker))),this.lists.get(Qe.MEDIA_DEVICE.compositeAudio)&&this.updateCompositeAudioDeviceList(this.lists.get(Qe.MEDIA_DEVICE.microphone),this.lists.get(Qe.MEDIA_DEVICE.speaker)));const n=this.lists.get(Qe.MEDIA_DEVICE.compositeAudio)||[];this.lists.set(Qe.MEDIA_DEVICE.microphone,this.orderDeviceList(this.lists.get(Qe.MEDIA_DEVICE.microphone),n)),this.lists.get(Qe.MEDIA_DEVICE.speaker)&&this.lists.set(Qe.MEDIA_DEVICE.speaker,this.orderDeviceList(this.lists.get(Qe.MEDIA_DEVICE.speaker),n));const r=this.lists.get(Qe.MEDIA_DEVICE.microphone);this.setTopItemToDefault(r);const s=this.lists.get(Qe.MEDIA_DEVICE.speaker);this.setTopItemToDefault(s),ht(i,this.devices)||(this.logger.safe.info("Device lists updated and changed"),this.logger.safe.info(this.debugInfo.microphone),this.logger.safe.info(this.debugInfo.camera),this.logger.safe.info(this.debugInfo.speaker),this.logger.safe.info(this.debugInfo.compositeAudio),this.event("onDevicesChanged").raise(this.devices,t))}updateVirtualDeviceList(e){const t=this.lists.get(Qe.MEDIA_DEVICE.virtualDevice),i=e.map((e=>new $R(e.id,e.label,"virtualDevice","")));ht(t,i)?this.logger.safe.info("Device lists did not change."):(this.lists.set(Qe.MEDIA_DEVICE.virtualDevice,i),this.event("onDevicesChanged").raise(this.devices,!1))}updateActiveMicrophone(e){if(!e||e.deviceId===Qe.MEDIA_DEVICE.defaultId)return;const t=this.lists.get(Qe.MEDIA_DEVICE.microphone),i=t.findIndex((e=>e.isSystemDefault));-1!==i&&t[i]!==e?(this.logger.safe.info("Removing synthetic default microphone"),e.isSystemDefault=!0,t.splice(i,1),this.lists.set(Qe.MEDIA_DEVICE.microphone,t),this.event("onDevicesChanged").raise(this.devices,!1)):e.isSystemDefault=!0}updatePrimitiveDeviceList(e,t){const i={str:this.debugInfo[e]};this.lists.set(e,KR(e,t,this.lists.get(e)||[],this.configProvider,i)),this.debugInfo[e]=i.str}updateCompositeAudioDeviceList(e,t){const i={str:this.debugInfo.compositeAudio};this.lists.set(Qe.MEDIA_DEVICE.compositeAudio,YR(e,t,this.configProvider.config.devices.compositeLabelMatchingThreshold,i)),this.debugInfo.compositeAudio=i.str}orderDeviceList(e,t){return e.sort(((e,i)=>this.getDevicePriority(i,this.getCompositeAudioDeviceCounterpart(i,t))-this.getDevicePriority(e,this.getCompositeAudioDeviceCounterpart(e,t))))}getCompositeAudioDeviceCounterpart(e,t){const i=t.find((t=>t.micDeviceId===e.guid||t.speakerDeviceId===e.guid));return i?i[e.type===Qe.MEDIA_DEVICE.speaker?"micDevice":"speakerDevice"]:null}getDevicePriority(e,t){let i=0;return this.configProvider.config.devices.overrideDefault&&t&&(!e.isSystemDefault&&t.isSystemDefault?(this.debugInfo[e.type]+=`|overrideDefault(${we(e.guid)})`,i+=10):e.isSystemDefault&&!t.isSystemDefault&&"microphone"===e.type&&(i+=15)),e.isSystemDefault&&(i+=5),t&&(i+=1,t.isSystemDefault&&(i+=2)),i}setTopItemToDefault(e){e?.length&&(e.forEach((e=>e.isSystemDefault=!1)),e[0].isSystemDefault=!0)}onConfigUpdated(){let e=!1;this.configProvider.userAgentConfig.isAudioOutputSelectionSupported?this.lists.has(Qe.MEDIA_DEVICE.speaker)||(this.lists.set(Qe.MEDIA_DEVICE.speaker,[]),this.lists.set(Qe.MEDIA_DEVICE.compositeAudio,[]),e=!0):(this.lists.has(Qe.MEDIA_DEVICE.speaker)&&(this.lists.delete(Qe.MEDIA_DEVICE.speaker),e=!0),this.lists.has(Qe.MEDIA_DEVICE.compositeAudio)&&(this.lists.delete(Qe.MEDIA_DEVICE.compositeAudio),e=!0)),e&&(this.logger.safe.info("Updating device list due to config update"),this.updateDevices(this.latestRawList||[]))}},iw=class e extends ze{constructor(t,i){super(i),this.pollingInterval=0,e.enumeratorUsers.add(this),e.initialize(this,t,i)}startDevicePolling(t){this.pollingInterval=t?e.configProvider.config.devices.pollingIntervalIdle:e.configProvider.config.devices.pollingIntervalActive,e.updatePollingTask()}stopDevicePolling(t){this.pollingInterval=t?0:e.configProvider.config.devices.pollingIntervalIdle,e.updatePollingTask()}dispose(){super.dispose(),this.stopDevicePolling(!0),e.enumeratorUsers.delete(this),0===e.enumeratorUsers.size&&(e.logger.safe.info("disposing"),e.initializeCalled=!1,e.isInitialized=new Yu,e.list=void 0,e.window.navigator.mediaDevices.ondevicechange=void 0)}static get isPolling(){return 0!==e.currentPollingInterval}static initialize(t,i,n){e.initializeCalled||(e.initializeCalled=!0,e.window=Vp.window,e.configProvider=i,e.logger=n,e.list=new tw(i,n.createChild("DeviceList")),i.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>e.enumerateDevices())),i.on("configUpdated",(()=>{void 0!==i.config.devices.pollingIntervalIdle&&null!==e.pollingTimer&&t.startDevicePolling(!0)})),i.config.devices.pollingIntervalIdle&&i.config.devices.idlePollingOnStart&&t.startDevicePolling(!0),e.window.navigator.mediaDevices&&(e.window.navigator.mediaDevices.ondevicechange=()=>{n.safe.info("enumerating due to ondevicechange callback"),e.enumerateDevices().catch((e=>{n.safe.error(`unable to enumerate ondevicechange: ${Ve(e)}`)}))}),e.enumerateDevices().then((()=>e.isInitialized.resolve())).catch((t=>e.isInitialized.reject(t))))}static async enumerateDevices(t=!1){if(!e.window.navigator?.mediaDevices?.enumerateDevices)throw new Error("device enumeration unsupported");if(e.enumerateDevicesPromise&&!t)return e.logger.safe.info("enumeration request postponed"),void(e.hasPendingUpdate=!0);try{e.enumerateDevicesPromise??(e.enumerateDevicesPromise=e.configProvider.config.devices.enumerateDevicesTimeout?function(e,t,i,n){let r;const s=[e,new Promise(((e,n)=>{r=setTimeout(n.bind(null,new Error(`Promise timed out ${i?`: ${i}`:""} after ${t} ms`)),t)}))];n&&s.push(n);const a=Promise.race(s),o=()=>{r&&clearTimeout(r)};return a.then(o,o),a}(e.window.navigator.mediaDevices.enumerateDevices(),e.configProvider.config.devices.enumerateDevicesTimeout,"enumerateDevices"):e.window.navigator.mediaDevices.enumerateDevices());const i=await e.enumerateDevicesPromise;e.list.updateDevices(i.map((e=>WR(e))),t)}catch(t){const i=Ve(t);throw e.logger.safe.warn(`error with enumerating devices: ${i}`),e.raiseFailedEnumeration(i),t}finally{e.enumerateDevicesPromise=void 0,e.hasPendingUpdate&&(e.hasPendingUpdate=!1,e.logger.safe.info("running postponed enumeration"),e.enumerateDevices())}}static updatePollingTask(){let t=Number.MAX_SAFE_INTEGER;for(const i of e.enumeratorUsers.values())i.pollingInterval<t&&(t=i.pollingInterval);if(t===Number.MAX_SAFE_INTEGER&&(t=0),(e.pollingTimer||e.currentPollingInterval!==t)&&e.pollingTimer&&(e.window.clearTimeout(e.pollingTimer),e.pollingTimer=void 0),e.currentPollingInterval=t,0===t)return;const i=async()=>{if(e.currentPollingInterval)try{await e.enumerateDevices(!0),e.pollingTimer=e.window.setTimeout(i,e.currentPollingInterval)}catch(t){throw e.pollingTimer=null,t}};e.logger.safe.info(`starting device polling with interval ${t}ms`),e.pollingTimer=1,i()}static raiseFailedEnumeration(t){for(const i of e.enumeratorUsers.values())i.event("onDeviceEnumerationfailed").raise(t)}};iw.isInitialized=new Yu,iw.initializeCalled=!1,iw.currentPollingInterval=0,iw.hasPendingUpdate=!1,iw.enumeratorUsers=new Set;var nw=iw,rw=class extends ze{constructor(e,t,i){super(i),this.deviceList=e,this.configProvider=t,this.logger=i,this.userSelectedDevices={microphone:null,camera:null,speaker:null},this.currentlySelectedDevices={microphone:null,camera:null,speaker:null,audioIngestDevice:null},this.deviceList.on("onDevicesChanged",(e=>this.onDevicesChanged(e))),e.devices.length>0&&this.onDevicesChanged(e.devices),this.logger.safe.info("Initialized")}get selectedDevices(){return ct(this.currentlySelectedDevices)}selectDevices(e){let t=!1;if(Xe(e,((e,i)=>{const n=this.getDeviceToSelect(i,this.deviceList.getDevicesByType("audioIngestDevice"===i?"microphone":i),e);"camera"===i&&(this.userSelectedDevices[i]=n?.guid||this.userSelectedDevices[i]),n?.guid!==this.currentlySelectedDevices[i]?.guid&&(this.userSelectedDevices[i]=n?.guid||this.userSelectedDevices[i],t=!0),this.currentlySelectedDevices[i]=n})),t){const e=rt(this.currentlySelectedDevices).map((e=>JSON.stringify(pm(e,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed from public interface: ${e}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!0)}}getDeviceToSelect(e,t,i){let n;const r=this.userSelectedDevices[e];return i?n=t.find((e=>e.guid===i)):r&&(n=t.find((e=>e.guid===r))),"audioIngestDevice"===e?n:n||t[0]}onDevicesChanged(e){let t=!1;if(Object.keys(this.currentlySelectedDevices).forEach((i=>{const n="audioIngestDevice"===i?"microphone":i,r=e.filter((e=>e.type===n));if(r.length>0){const e=this.getDeviceToSelect(i,r);e?.guid!==this.currentlySelectedDevices[i]?.guid&&(this.currentlySelectedDevices[i]=e,t=!0)}else this.currentlySelectedDevices[i]&&(this.currentlySelectedDevices[i]=null,t=!0)})),t){const e=rt(this.currentlySelectedDevices).map((e=>JSON.stringify(pm(e,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed due to device list change: ${e}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!1)}}},sw=class extends ze{constructor(e,t){super(e),this.logger=e,this.mediaStream=t,this.subs=[],this.subscribeOnMediaStreamEvents(t)}acquire(){return this.mediaStream?this.mediaStream.start().then((()=>this.logger.safe.info("Stream acquired"))).catch((e=>{throw this.logger.safe.warn(`Failed to acquire the stream: ${Ve(e)}`),e})):Promise.reject("Disposed")}dispose(){this.logger.safe.info("Disposing stream"),this.unsubscribeFromMediaStreamEvents(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),super.dispose()}subscribeOnMediaStreamEvents(e){this.subs=[e.on("onStreamClientStarted",(()=>this.event("onStreamStateChanged").raise("active"))),e.on("onStreamClientMuted",((e,t)=>this.event("onStreamStateChanged").raise(t?"inactive":"active"))),e.on("onStreamClientEnded",(()=>this.event("onStreamStateChanged").raise("stopped"))),e.on("onStreamClientError",((e,t)=>{const i=t.type===Qe.MEDIA_ERROR.permissionDeniedError||t.type===Qe.MEDIA_ERROR.sharingCancelledError;this.event("onStreamStateChanged").raise(i?"cancelled":"failed")}))]}unsubscribeFromMediaStreamEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}},aw=[Qe.MEDIA_STATE.inactive,Qe.MEDIA_STATE.receive,Qe.MEDIA_STATE.send,Qe.MEDIA_STATE.sendReceive],ow=[Qe.MEDIA_STATE.inactive,Qe.MEDIA_STATE.receive],cw=class extends ze{constructor(e,t,i){super(i),this.configProvider=e,this.deviceManager=t,this.logger=i,this.currentState={microphone:"unknown",camera:"unknown"},this.lastGum={audio:!1,video:!1},this.registeredTrackers=new Set,this.accessIssuePermissionOther={audio:!1,video:!1},this.window=Vp.window,this.permittedModalities={audio:aw,video:aw,sharing:aw},this.initialize()}async initialize(){!Bp.hasPermissionsApi()||"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera?"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera||this.logger.safe.warn(`Permissions API is not supported in this browser. Microphone: ${this.currentState.microphone}, camera: ${this.currentState.camera}`):(this.logger.safe.info("Initializing"),await this.registerPermissionTracker("microphone"),await this.registerPermissionTracker("camera"))}getPermissionState(e){return this.currentState[e]||"unknown"}isPermissionKnown(e){const t=this.getPermissionState(e);return"unknown"!==t&&"prompt"!==t}get browserPermittedModalities(){return this.permittedModalities}get knownPermissionStates(){return ct(this.currentState)}update(e,t){const i=ct(t);e.audio||delete i.audio,e.video||delete i.video;const n=ct(this.permittedModalities);Xe(i,((e,t)=>{this.permittedModalities[t]=e?aw:ow})),ht(n,this.permittedModalities)||this.event("onDevicesPermissionChanged").raise()}async askDevicePermission(e){const t=e?ct(e):{audio:!0,video:this.deviceManager.hasCamera()};if(this.accessIssuePermissionOther={audio:!1,video:!1},this.configProvider.config.permissions.rememberNegative&&(t.audio=t.audio&&this.permittedModalities.audio===aw,t.video=t.video&&this.permittedModalities.video===aw),t.sharing)throw new Error("askDevicePermission does not support sharing constraints.");const i={audio:!1,video:!1};this.lastGum={audio:!1,video:!1};const n=async(i,n,r)=>{const s={audio:!!i.audio,video:!!i.video,sharing:!0};return!(this.configProvider.config.permissions.adpRequestAVLast&&t.audio&&t.video)||this.lastGum.audio&&this.lastGum.video||(this.logger.safe.info("Prompting for audio and video to ensure omnibar state"),await this.askDevicePermissionPrompt({audio:!0,video:!0},!1)),this.update(t,s),this.deviceManager.raiseTelemetryEvent("ask_device_permission",{constraints:e,resultConstraints:i,error:r,reason:n}),s};await this.initialize();const r=this.getPermissionState("microphone"),s=this.getPermissionState("camera");if(this.logger.safe.info(`Permission state { audio: ${r}, video: ${s} }`),this.configProvider.config.permissions.useNegativeInAdp&&(!t.audio||"denied"===r)&&(!t.video||"denied"===s))return n(i,"navigator_permissions_denied");if(this.configProvider.config.permissions.usePositiveInAdp&&(!t.audio||t.audio&&"granted"===r)&&(!t.video||t.video&&"granted"===s))return n(t,"navigator_permissions_granted");try{return n(this.getConstrainsWithPermissionError(await this.askDevicePermissionPrompt(t,this.configProvider.config.permissions.adpFallback)),"stream_acquisition")}catch(e){return n(i,"stream_acquisition",e)}}async askDevicePermissionPrompt(e,t=!0){const i={audio:!1,video:!1};try{const t=this.deviceManager.getMediaStream(e);return t&&(this.lastGum=ct(e),await t.start(),i.audio=t.hasAudio(),i.video=t.hasVideo(),this.disposeLater(t)),i}catch(n){if(e.audio&&e.video&&t){try{i.video=this.configProvider.config.permissions.adpFallbackVideo&&(await this.askDevicePermissionPrompt({video:!0})).video}catch(e){e.type!==Qe.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.video=!0)}try{i.audio=this.configProvider.config.permissions.adpFallbackAudio&&(await this.askDevicePermissionPrompt({audio:!0})).audio}catch(e){e.type!==Qe.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.audio=!0)}}else if(t)throw n;return i}}getConstrainsWithPermissionError(e){return this.configProvider.config.permissions.disableOnPermissionDeniedOnly?{audio:this.accessIssuePermissionOther.audio||e.audio,video:this.accessIssuePermissionOther.video||e.video}:e}disposeLater(e){setTimeout((()=>{e.dispose()}),this.configProvider.config.mediaStreamHoldInterval)}async registerPermissionTracker(e){if(!this.registeredTrackers.has(e))try{const t=await this.window.navigator.permissions.query({name:e});this.handlePermissionStateChanged(e,t.state),t.onchange=()=>this.handlePermissionStateChanged(e,t.state),this.registeredTrackers.add(e)}catch(t){this.logger.safe.error(`Error querying permissions for ${e}: ${Ve(t)}`)}}handlePermissionStateChanged(e,t){this.logger.safe.info(`Permission state for ${e} changed ${this.currentState[e]} -> ${t}`),this.currentState[e]=t,this.deviceManager.raiseTelemetryEvent("permissions_state_changed",this.knownPermissionStates),this.deviceManager.handlePermissionStateChange()}},lw=class extends We{constructor(e,t=dt()){super(),this.dms=e,this.label=t,this.id=dt(),this.receivedEvents=new Map,this.subscribeToDeviceManagers(e)}getDeviceManagers(){return this.dms}dispose(){super.dispose(),this.dms?.forEach((e=>e.dispose())),this.dms=null}subscribeToDeviceManagers(e){e.forEach(((e,t)=>{e.on("onVideoEffectsEvent",((...t)=>this.eventHandler("onVideoEffectsEvent",e,(()=>this.event("onVideoEffectsEvent").raise(...t))))),e.on("onVideoEffectApplied",((...t)=>this.eventHandler("onVideoEffectApplied",e,(()=>this.event("onVideoEffectApplied").raise(...t))))),e.on("onDeviceTelemetryEvent",(e=>this.event("onDeviceTelemetryEvent").raise({deviceId:`${this.id}/${t}`,...e}))),e.on("onVideoEffectsTelemetryEvent",(e=>this.event("onVideoEffectsTelemetryEvent").raise({deviceId:`${this.id}/${t}`,...e}))),e.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise(`${this.id}/${t}`))),e.on("onStreamUpdateRequested",((...e)=>this.event("onStreamUpdateRequested").raise(...e)))}))}eventHandler(e,t,i){let n=this.receivedEvents.get(e);if(n??(n=new Set),n.add(t),this.dms.every((e=>n.has(e))))return i(),void n.clear();this.receivedEvents.set(e,n)}},dw=()=>(e,t,i)=>{const n=i.value;return i.value=function(...e){return this.serialQueue.add(n.bind(this,...e))},i},hw=class{constructor(e){this.size=e,this.items=[]}clear(){this.items=[]}},uw=class extends hw{get isFull(){return this.items.length>=this.size}add(e){return this.isFull&&this.items.shift(),this.items.push(e),!0}},gw=class extends hw{add(e){return!(this.items.length>=this.size||(this.items.push(e),0))}},pw=class{constructor(e){this.error=new gw(e)}startLoadTimer(){this.loadStartTimestamp=Date.now()}stopLoadTimer(){this.loadDuration=Date.now()-this.loadStartTimestamp}clearErrors(){this.error.clear()}setError(e,t){this.error.add({type:e,message:t})}getReport(){return{loadDuration:this.loadDuration,error:this.error.items}}},mw=class{constructor(e,t,i){this.configProvider=e,this.statistics=t,this.logger=i}isWasmEffectSupported(){return this.configProvider.config.webcv.useWasmEffects?!!window.MediaStreamTrackProcessor||(this.logger.info("wasmEffects disabled, insertable streams are not supported"),!1):(this.logger.info("wasmEffects disabled by feature flag"),!1)}isWebgl2EffectSupported(){return this.isCurrentRendererSupported()&&this.isWebGL2Supported()}isCurrentRendererSupported(){const e=this.configProvider.config.webcv.webGLUnsupportedRenderers;let t=!1;const i=Bp.unmaskedGlRenderer;return i&&!e.some((e=>e===i))?t=!0:(this.statistics.setError("RendererIsNotSupported",`Blacklisted from ${JSON.stringify(e)}`),this.logger.info(`Unsupported renderer: ${Ve(i)}`)),t}isWebGL2Supported(){try{const e=document.createElement("canvas").getContext("webgl2");if(!e)return this.statistics.setError("WebGL2IsNotSupported"),this.logger.info("WebGL2 context is not supported"),!1;const t=e.getSupportedExtensions(),i=this.configProvider.config.webcv.webGLRequiredExtensions.filter((e=>!t.includes(e)));if(i.length>0)return this.statistics.setError("WebGL2RequiredExtensionsNotSupported","Required WebGL2 extensions not supported."),this.logger.info(`Unsupported WebGL2 extensions: ${Ve(i)}`),!1}catch(e){return this.statistics.setError("WebGL2IsNotSupported",`Error: ${Ve(e)}`),this.logger.error(`isWebGL2Supported: ${Ve(e)}`),!1}return!0}},fw=class extends ze{constructor(e,t,i,n){super(i),this.webcvProvider=e,this.configProvider=t,this.logger=i,this.createWasmCVWorker=n,this.serialQueue=new $A(this.logger),this.videoEffectToWebCVEffectMapping={0:fu.VideoEffectType.Off,1:fu.VideoEffectType.BackgroundBlur,16:fu.VideoEffectType.BackgroundReplacement},this.effectType=0,this.isPortrait=!1,this.effectProviderSubs=[],this.statistics=new pw(this.configProvider.config.effectsTelemetryBufferSize),this.processorType=fu.ProcessorType.Webgl2,this.lastNotifiedResolutions=new Map}get isEffectEnabled(){return 0!==this.effectType}async init(){if(!this.effectProvider){this.logger.safe.debug("Init");try{this.effectProvider=await this.initializeVideoEffectProvider()}catch(e){throw this.notifyError("FailedToInitialize",`Initialization failed, error:${Ve(e)}`),e}}}async dispose(){this.logger.safe.debug("Dispose"),this.effectProvider&&(this.effectProviderSubs.forEach((e=>e.dispose())),this.effectProviderSubs=null,await this.effectProvider.disposeAsync()),this.lastNotifiedResolutions.clear(),super.dispose()}async configure(e){if(this.logger.safe.debug(`Set config: ${JSON.stringify(e)}`),this.effectConfig={backgroundImageUrl:e.imagePath,headers:e.headers},this.effectProvider)return this.effectProvider.configureEffect(this.effectConfig);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setEffectAsync(e){if(!this.shouldApplyEffect(e))return void this.logger.safe.debug(`Effect ${this.effectType} is already set`);this.effectProvider||(this.logger.safe.debug("Initializing effect provider"),await this.init()),this.logger.safe.debug(`Set effect: ${e}`);const t=this.getWebCVEffect(e);if(!t)throw new Error(`Effect with type ${e} is not supported`);if(this.shouldCollectStats(e)&&this.notifyAboutLastSessionStats("EffectChanged"),this.effectType=e,this.effectProvider)try{await this.effectProvider.setEffectAsync(t)}catch(e){throw await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to apply ${t}, error:${Ve(e)}`),e}else this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setSourceAsync(e){if(this.logger.safe.debug(`Set source: ${e?e.id:"no stream"}`),!this.effectProvider)return this.logger.safe.debug("WebCV is not initialized. Do nothing"),e;if(e.getTracks().length>0){const t=e.getVideoTracks()[0].getSettings();this.isPortrait=t.height>t.width}let t=e;try{t=await this.effectProvider.setSourceAsync(e)}catch(e){await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to set source, error:${Ve(e)}`)}return t}async removeSourceAsync(e){if(this.logger.safe.debug(`Remove source: ${e?e.id:"no stream"}`),this.effectProvider)return this.effectProvider.removeSourceAsync(e);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async getEffectsCapability(){let e=0;const t=await this.getCapability();this.logger.safe.debug(`Get capabilty with return: ${JSON.stringify(t)}`);for(const i of t){const t=this.getVideoEffectType(i);if(!t)throw new Error(`Cannot convert WebCV effect to VideoEffect ${i}`);e|=t}return e}getStats(e){if(!this.effectProvider)return;const t=this.effectProvider.getStats(),i=this.statistics.getReport();return t||i.error.length?{timestamp:Date.now(),statsReason:e,...this.createTelemetryEvent(t,i)}:void 0}getVersion(){return this.effectProvider?.getVersion?.()??"Unknown"}async resetOutputConstraints(e,t=fu.EffectQualityChangeReason.ExternalParam){const i=this.getNewResolution(e,t),n={...this.configProvider.config.webcv.qualityConfig};return this.isPortrait?n.outputResolution=i.width:n.outputResolution=i.height,this.effectProvider?.configureStreamProcessor(n,fu.EffectQualityChangeReason.ExternalParam)}getNewResolution(e,t){let i;switch(t){case fu.EffectQualityChangeReason.ExternalParam:i=this.lastNotifiedResolutions.get(fu.EffectQualityChangeReason.RendererSize),this.lastNotifiedResolutions.set(fu.EffectQualityChangeReason.ExternalParam,e);break;case fu.EffectQualityChangeReason.RendererSize:i=this.lastNotifiedResolutions.get(fu.EffectQualityChangeReason.ExternalParam),this.lastNotifiedResolutions.set(fu.EffectQualityChangeReason.RendererSize,e)}return{width:Math.max(e.width,i?.width||Number.MIN_SAFE_INTEGER),height:Math.max(e.height,i?.height||Number.MIN_SAFE_INTEGER)}}createTelemetryEvent(e,t){return{payload:{version:this.getVersion(),...t,...e,isWasmEnabled:this.processorType===fu.ProcessorType.Wasm}}}notifyError(e,t){this.statistics.setError(e,t),this.notifyAboutLastSessionStats("EffectError")}notifyAboutLastSessionStats(e){const t=this.getStats(e);t&&this.event("onVideoEffectTelementyEvent").raise(t)}async initializeVideoEffectProvider(){if(!this.webcvProvider)return this.logger.safe.debug("WebCV provider is not set"),null;this.statistics.startLoadTimer();const e=await this.webcvProvider.getVideoEffectProvider();if(this.statistics.stopLoadTimer(),!e)return this.statistics.setError("FailedToInitialize"),this.logger.safe.warn("WebCV is not initialized"),null;this.logger.safe.debug(`WebCV v${e.getVersion?.()} is initialized`);const t=await this.webcvProvider.getModelConfig();return await e.configureModel(t),this.configProvider.config.webcv.loadWorkerCallback=this.createWasmCVWorker,await e.configure({...this.configProvider.config.webcv,processorType:this.processorType}),this.effectConfig&&await e.configureEffect(this.effectConfig),this.effectProviderSubs=[e.on("onEffectApplied",(()=>this.event("onMediaStreamUpdateRequested").raise("Video"))),e.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats("EffectStopped"))),e.on("onVideoEffectQualityChanged",(e=>this.event("onVideoEffectQualityChanged").raise(e))),e.on("onVideoStreamQualityChanged",(e=>this.event("onVideoStreamQualityChanged").raise(e.resolution,e.fps,e.reason))),e.on("onCapabilitiesChanged",(()=>this.event("onVideoEffectCapabilitiesChanged").raise())),e.on("onFirstFrameProcessed",(()=>this.onFirstFrameProcessed())),e.on("onErrorNotified",(e=>this.notifyError("WebcvProccessorError",e))),e.on("videoFreezeDetected",(e=>this.event("videoFreezeDetected").raise(e)))],e}async getCapability(){if(!this.configProvider.config.enableVideoEffects)return this.logger.debug("Video effects disabled"),[fu.VideoEffectType.Off];if(!this.webcvProvider)return this.logger.debug("WebCVProvider is not configured"),[fu.VideoEffectType.Off];const e=new mw(this.configProvider,this.statistics,this.logger.createChild("CapabilityChecker"));let t=[fu.VideoEffectType.Off];return e.isWasmEffectSupported()?(t=[fu.VideoEffectType.Off,fu.VideoEffectType.BackgroundBlur,fu.VideoEffectType.BackgroundReplacement],this.processorType=fu.ProcessorType.Wasm):e.isWebgl2EffectSupported()&&(t=[fu.VideoEffectType.Off,fu.VideoEffectType.BackgroundBlur,fu.VideoEffectType.BackgroundReplacement],this.processorType=fu.ProcessorType.Webgl2),this.effectProvider?this.effectProvider.getCapability():t}getWebCVEffect(e){return this.videoEffectToWebCVEffectMapping[e]}getVideoEffectType(e){return at(this.videoEffectToWebCVEffectMapping).find((t=>this.videoEffectToWebCVEffectMapping[t]===e))}onFirstFrameProcessed(){this.event("onVideoEffectApplied").raise(),this.logger.safe.debug("onVideoEffectApplied event raised")}async handleFailedProcessing(){this.effectType=0;try{await this.effectProvider.setEffectAsync(fu.VideoEffectType.Off)}catch(e){this.notifyError("WebcvProccessorError",`Failed to handle error state, error:${Ve(e)}`)}}shouldApplyEffect(e){return this.effectType!==e}shouldCollectStats(e){return 0!==this.effectType&&0!==e&&this.effectType!==e}};S([dw()],fw.prototype,"init",1),S([dw()],fw.prototype,"dispose",1),S([dw()],fw.prototype,"configure",1),S([dw()],fw.prototype,"setSourceAsync",1),S([dw()],fw.prototype,"removeSourceAsync",1),S([dw()],fw.prototype,"getEffectsCapability",1);var Sw=class extends ze{constructor(e,t,i,n,r,s){super(r),this.wasmdnsProvider=e,this.wasmaecProvider=t,this.wasmVqeProvider=i,this.configProvider=n,this.logger=r,this.createWasmAudioWorkletCbs=s,this.serialQueue=new $A(this.logger),this.stopped=!0,this.hasError=!1,this.statistics=new pw(this.configProvider.config.effectsTelemetryBufferSize),this.currentEffect=Su.AudioEffectType.Off,this.currentEffectCapability=0,this.audioEffectToWasmAudioEffectType={0:Su.AudioEffectType.Off,1:Su.AudioEffectType.NoiseSuppressionClassic,2:Su.AudioEffectType.NoiseSuppressionDeep,4:Su.AudioEffectType.EchoCancellationClassic,8:Su.AudioEffectType.VoiceQualityEnhancementClassic,16:Su.AudioEffectType.VoiceQualityEnhancementDeep},this.audioEffectTypeToUserNsMode={[Su.AudioEffectType.Off]:"Off",[Su.AudioEffectType.NoiseSuppressionClassic]:"Low",[Su.AudioEffectType.NoiseSuppressionDeep]:"High"},this.noiseSuppressionModeToWasmDnsEffectMapping={Off:Su.AudioEffectType.Off,High:Su.AudioEffectType.NoiseSuppressionDeep,Low:Su.AudioEffectType.NoiseSuppressionClassic}}get isEffectEnabled(){return this.currentEffect!==Su.AudioEffectType.Off}shouldFallbackToNativeProcessing(){return!(!this.configProvider.config.enableAudioProcessingFallback||(this.configProvider.config.wasmvqe.enableVqe||this.configProvider.config.wasmdns.enableNoiseSuppression?this.hasError?(this.logger.safe.info("shouldFallbackToNativeProcessing: error was encountred initializing the package"),0):this.configProvider.config.wasmvqe.enableVqe&&!this.wasmVqeProvider?(this.logger.safe.info("shouldFallbackToNativeProcessing: VQE provider is enabled but not loaded"),0):!this.configProvider.config.wasmdns.enableNoiseSuppression||this.wasmdnsProvider&&this.wasmaecProvider||(this.logger.safe.info("shouldFallbackToNativeProcessing: DNS/AEC provider is enabled but not loaded"),0):(this.logger.safe.info("shouldFallbackToNativeProcessing: custom processing is not enabled"),0)))}nsModeToVqeMode(e,t){switch(e){case"High":return t?Su.VqeMode.DeepVQE:Su.VqeMode.DeepNS;case"Low":return t?Su.VqeMode.SkypeVQE:Su.VqeMode.SkypeNS;default:return t?Su.VqeMode.SkypeAEC:Su.VqeMode.Off}}vqeModeToNsMode(e){switch(e){case Su.VqeMode.DeepVQE:case Su.VqeMode.DeepNS:return"High";case Su.VqeMode.SkypeVQE:case Su.VqeMode.SkypeNS:return"Low";case Su.VqeMode.SkypeAEC:case Su.VqeMode.Off:default:return"Off"}}vqeModeToAudioEffectType(e){switch(e){case Su.VqeMode.DeepVQE:return 16;case Su.VqeMode.DeepNS:return 2;case Su.VqeMode.SkypeVQE:return 8;case Su.VqeMode.SkypeNS:return 1;case Su.VqeMode.SkypeAEC:return 4;case Su.VqeMode.Off:default:return 0}}async initializeProvider(){if(this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider)return this.logger.safe.debug("Initializing VQE provider ..."),void(this.vqeProvider=await this.initializeAudioEffectProvider(Su.AudioEffectType.VoiceQualityEnhancementDeep));this.configProvider.config.wasmdns.enableNoiseSuppression&&!this.dnsProvider&&(this.logger.safe.debug("Initializing DNS provider ..."),this.dnsProvider=await this.initializeAudioEffectProvider(Su.AudioEffectType.NoiseSuppressionDeep)),this.configProvider.config.wasmdns.enableNoiseSuppression&&!this.aecProvider&&(this.logger.safe.debug("Initializing AEC provider ..."),this.aecProvider=await this.initializeAudioEffectProvider(Su.AudioEffectType.EchoCancellationClassic))}async configureEffect(e){this.statistics.clearErrors();let t=e;if(!t){let e=this.configProvider.mediaConfig.noiseSuppressionMode;this.logger.safe.info(`Configuring the audio effect manager for Noise Suppression mode: ${e}`),"Auto"===e&&(e=this.configProvider.config.wasmvqe.enableVqe?this.vqeModeToNsMode(this.configProvider.config.wasmvqe.defaultVqeMode):this.configProvider.config.wasmdns.noiseSuppressionMode,this.logger.safe.info(`Overriding 'Auto' with ${e}`)),t={...this.configProvider.config.wasmdns,...this.configProvider.config.wasmvqe},t.noiseSuppressionMode=e}if(await this.getEffectsCapability(),this.configProvider.config.wasmvqe.enableVqe)try{if(!this.vqeProvider)return void this.logger.safe.error("VQE provider is not initialized");this.userNoiseSuppressionMode&&(t.noiseSuppressionMode=this.vqeModeToNsMode(this.userNoiseSuppressionMode)),this.logger.safe.debug("Configuring VQE audio effects ..."),await this.vqeProvider.configureEffect(t),this.logger.safe.debug(`The audio effects were configured as follows: ${Ve(t)}, and current capability is ${this.currentEffectCapability}.`)}catch(e){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${e}), while trying to use this configuration: ${Ve(t)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}else if(this.configProvider.config.wasmdns.enableNoiseSuppression){t.noiseSuppressionMode||(this.logger.safe.debug("configureEffect was called without a noiseSuppressionMode. Using noiseSuppressionMode from config provider ..."),t.noiseSuppressionMode=this.configProvider.mediaConfig.noiseSuppressionMode),this.currentEffect=this.noiseSuppressionModeToWasmDnsEffectMapping[t.noiseSuppressionMode],this.logger.safe.debug(`currentEffect is ${this.currentEffect}`);try{if(!this.dnsProvider||!this.aecProvider)return void this.logger.safe.debug("DNS & AEC providers not initialized");this.logger.safe.debug("Configuring DNS/AEC audio effects ..."),t.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmDnsWorklet,await this.dnsProvider.configureEffect(t),t.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmAecWorklet,await this.aecProvider.configureEffect(t),this.logger.safe.debug(`The audio effects were configured as follows: ${Ve(t)}, and current capability is ${this.currentEffectCapability}.`)}catch(e){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${e}), while trying to use this configuration: ${Ve(t)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}}}async setSourceAsync(e){if(this.logger.safe.debug(`Set source: ${e?e.id:"no stream"}, currentEffect = ${this.currentEffect}`),this.stopped||(this.stop(),this.stopped=!1),await this.initializeProvider(),await this.configureEffect(),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const t=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${t}).`),this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${t}).`),e}if(!this.configProvider.config.wasmvqe.enableVqe&&!this.configProvider.config.wasmdns.enableNoiseSuppression)return e;if(this.effectProviderSubs=[this.vqeProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onErrorNotified",(e=>this.notifyError("WasmVqeProccessorError",e))),this.dnsProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onErrorNotified",(e=>this.notifyError("WasmDnsProccessorError",e))),this.aecProvider?.on("onErrorNotified",(e=>this.notifyError("WasmAecProccessorError",e)))],this.configProvider.config.wasmvqe.enableVqe)try{const t=await this.vqeProvider.setSourceAsync(e);return this.aecRefStream&&this.vqeProvider.setRefStream(this.aecRefStream),t}catch(t){return this.notifyError("WasmVqeProccessorError",`setSourceAsync: Failed to asynchronously set source for VQE (${t})`),e}let t=e;try{t=await this.aecProvider.setSourceAsync(e),this.aecRefStream&&this.aecProvider.setRefStream?.(this.aecRefStream)}catch(e){this.notifyError("WasmAecProccessorError",`setSourceAsync: Failed to asynchronously set source for AEC (${e})`)}try{return await this.dnsProvider.setSourceAsync(t)}catch(e){this.notifyError("WasmDnsProccessorError",`setSourceAsync: Failed to asynchronously set source for DNS (${e})`)}return t}async setAecRefStream(e){try{if(this.logger.safe.debug(`Setting the reference stream to: ${e?e.id:"Null"}`),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const e=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setAecRefStream: audio effect provider not initialized (${e}).`),void this.logger.safe.warn(`Unable to setAecRefStream for audio effects: audio effect provider not initialized (${e}).`)}this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider.setRefStream(e):this.configProvider.config.wasmdns.enableNoiseSuppression&&this.aecProvider.setRefStream(e)}catch(e){this.notifyError("WasmVqeProccessorError",`setRefStream: Failed to set reference stream for echo cancellation (${e})`)}this.aecRefStream=e}async setEffectAsync(e){const t=this.audioEffectToWasmAudioEffectType[e];if(this.currentEffect===t)return;const i=this.currentEffect===Su.AudioEffectType.Off||t===Su.AudioEffectType.Off;if(this.currentEffect=t,this.userNoiseSuppressionMode=this.nsModeToVqeMode(this.audioEffectTypeToUserNsMode[t],!1),await this.initializeProvider(),await this.configureEffect(),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const e=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${e}).`),void this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${e}).`)}try{this.configProvider.config.wasmvqe.enableVqe?await this.vqeProvider.setEffectAsync(t):this.configProvider.config.wasmdns.enableNoiseSuppression&&(await this.dnsProvider.setEffectAsync(t),await this.aecProvider.setEffectAsync(t)),this.configProvider.config.applyAudioEffectOnDemand&&this.configProvider.config.wasmvqe.enableVqe&&i&&this.requestStreamUpdate(!0),this.logger.safe.debug(`The audio effect was set to '${t}'`)}catch(e){throw this.notifyError("WasmVqeProccessorError",`setEffectAsync: Failed to apply '${t}' audio effect, error: ${Ve(e)}`),e}}stop(){try{this.dnsProvider?.dispose(),this.dnsProvider=null,this.aecProvider?.dispose(),this.aecProvider=null,this.vqeProvider?.dispose(),this.vqeProvider=null,this.effectProviderSubs?.forEach((e=>e?.dispose())),this.effectProviderSubs=null,this.stopped=!0,this.logger.safe.debug("The audio effects provider was stopped.")}catch(e){this.logger.safe.error(`Failed to stop the audio effects provider (${e})`)}}dispose(){try{this.hasError=!1,this.stop(),super.dispose(),this.logger.safe.debug("The audio effects provider was disposed.")}catch(e){this.logger.safe.error(`dispose: Failed to dispose the audio effects provider (${e})`)}}async getEffectsCapability(){return this.currentEffectCapability=0,this.configProvider.config.wasmvqe.enableVqe?(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.configProvider.config.wasmvqe.enableAec&&(this.currentEffectCapability|=4,this.currentEffectCapability|=8,this.currentEffectCapability|=16)):this.configProvider.config.wasmdns.enableNoiseSuppression&&(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.currentEffectCapability|=4),this.currentEffectCapability}getVersion(){return`WasmDns ${this.dnsProvider?.getVersion()??"Unknown"} / WasmAec ${this.aecProvider?.getVersion()??"Unknown"} / WasmVqe ${this.vqeProvider?.getVersion()??"Unknown"}`}getStats(){const e=this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider?.getStats():this.dnsProvider?.getStats();return e?(e.userNoiseSuppressionMethod=this.userNoiseSuppressionMode,{timestamp:Date.now(),...this.createTelemetryEvent(e)}):null}async initializeAudioEffectProvider(e){if(!this.wasmVqeProvider&&e===Su.AudioEffectType.VoiceQualityEnhancementDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmVqe package not available."),this.logger.safe.warn("WasmVqe package not available."),null;if(!this.wasmdnsProvider&&e===Su.AudioEffectType.NoiseSuppressionDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmDns package not available."),this.logger.safe.warn("WasmDns package not available."),null;if(!this.wasmaecProvider&&e===Su.AudioEffectType.EchoCancellationClassic)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmAec package not available."),this.logger.safe.warn("WasmAec package not available."),null;let t;this.statistics.startLoadTimer();try{this.configProvider.config.wasmvqe.enableVqe&&e===Su.AudioEffectType.VoiceQualityEnhancementDeep&&(t=await this.wasmVqeProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&e===Su.AudioEffectType.NoiseSuppressionDeep&&(t=await this.wasmdnsProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&e===Su.AudioEffectType.EchoCancellationClassic&&(t=await this.wasmaecProvider.getAudioEffectProvider())}catch(e){this.logger.safe.warn(`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${e})`),this.statistics.setError("FailedToInitialize",`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${e})`)}return this.statistics.stopLoadTimer(),t?(e===Su.AudioEffectType.VoiceQualityEnhancementDeep&&this.logger.safe.debug(`WasmVqe v${t.getVersion?.()} initialized!`),e===Su.AudioEffectType.NoiseSuppressionDeep&&this.logger.safe.debug(`WasmDns v${t.getVersion?.()} initialized!`),e===Su.AudioEffectType.EchoCancellationClassic&&this.logger.safe.debug(`WasmAec v${t.getVersion?.()} initialized!`),t):(this.logger.safe.warn("Unitialized Wasm audio effect provider."),null)}createTelemetryEvent(e){return{payload:{audioEffectsCapability:this.currentEffectCapability,version:this.getVersion(),...this.statistics.getReport(),...e}}}notifyError(e,t){this.statistics.setError(e,t),this.notifyAboutLastSessionStats()}notifyAboutLastSessionStats(){const e=this.getStats();e&&this.event("onAudioEffectTelemetryEvent").raise(e)}requestStreamUpdate(e=!1){(e||this.configProvider.config.enableAudioProcessingFallback&&!this.hasError)&&(this.hasError=!0,this.event("onMediaStreamUpdateRequested").raise("Audio"))}};S([dw()],Sw.prototype,"setSourceAsync",1),S([dw()],Sw.prototype,"setAecRefStream",1),S([dw()],Sw.prototype,"setEffectAsync",1),S([dw()],Sw.prototype,"stop",1),S([dw()],Sw.prototype,"dispose",1);var vw=class extends ze{constructor(e,t){super(),this.configProvider=e,this.logger=t}isEffectEnabled(e){switch(e){case"Video":return this.videoEffectManager?.isEffectEnabled;case"Audio":return this.audioEffectManager?.isEffectEnabled;default:return!1}}shouldFallbackToNativeProcessing(e){return"Audio"===e&&this.audioEffectManager?.shouldFallbackToNativeProcessing()}addEffectManager(e,t){switch(e){case"Audio":this.addAudioEffectManagerAndSubscribe(t);break;case"Video":this.addVideoEffectManagerAndSubscribe(t)}}async startEffect(e,t){switch(e){case"Audio":return this.logger.safe.info("audioEffectManager is "+(this.audioEffectManager?"defined":"undefined")),this.audioEffectManager?.shouldFallbackToNativeProcessing()?(this.logger.safe.info("No custom audio effect is used. Fallback to native audio processing"),t):this.audioEffectManager.setSourceAsync(t);case"Video":return this.videoEffectManager.setSourceAsync(t);default:return t}}async setEffectType(e,t){switch(e){case"Audio":return this.audioEffectManager?.setEffectAsync(t);case"Video":return this.videoEffectManager?.setEffectAsync(t)}}stopEffect(e,t){switch(e){case"Audio":this.logger.safe.info("stopping audio effect"),this.audioEffectManager?.stop();break;case"Video":this.logger.safe.info("stopping video effect"),this.videoEffectManager?.removeSourceAsync(t)}}resetOutputConstraints(e,t,i){"Video"===e&&this.videoEffectManager?.resetOutputConstraints(t,i)}getStats(e,t){switch(e){case"Audio":return this.audioEffectManager?.getStats();case"Video":return this.videoEffectManager?.getStats(t);default:return}}async configure(e,t){if("Video"===e)return this.videoEffectManager?.configure(t)}async getEffectsCapability(e){switch(e){case"Audio":return this.audioEffectManager?.getEffectsCapability();case"Video":return this.videoEffectManager?.getEffectsCapability();default:return 0}}setAecRefStream(e){return this.audioEffectManager.setAecRefStream(e)}vqeModeToAudioEffectType(e){return this.audioEffectManager.vqeModeToAudioEffectType(e)}nsModeToVqeMode(e,t){return this.audioEffectManager.nsModeToVqeMode(e,t)}dispose(){super.dispose(),this.audioEffectManager?.dispose(),this.audioEffectManager=null,this.videoEffectManager?.dispose(),this.videoEffectManager=null}addAudioEffectManagerAndSubscribe(e){this.audioEffectManager||(this.audioEffectManager=new Sw(e.wasmdnsProvider,e.wasmaecProvider,e.wasmVqeProvider,this.configProvider,this.logger.createChild("AudioEffectManager"),e.createAudioWasmWorkerCbs),this.audioEffectManager.on("onAudioEffectTelemetryEvent",(e=>{this.event("onAudioEffectTelemetryEvent").raise(e)})),this.audioEffectManager.on("onMediaStreamUpdateRequested",(e=>{this.event("onMediaStreamUpdateRequested").raise(e)})))}addVideoEffectManagerAndSubscribe(e){this.videoEffectManager||(this.videoEffectManager=new fw(e.webcvProvider,this.configProvider,this.logger.createChild("VideoEffectManager"),e.createWasmCVWorker),this.videoEffectManager.on("onMediaStreamUpdateRequested",(e=>{this.event("onMediaStreamUpdateRequested").raise(e)})),this.videoEffectManager.on("onVideoEffectQualityChanged",(e=>{this.event("onVideoEffectQualityChanged").raise(e)})),this.videoEffectManager.on("onVideoStreamQualityChanged",((e,t,i)=>{this.event("onVideoStreamQualityChanged").raise(e,t,i)})),this.videoEffectManager.on("onVideoEffectCapabilitiesChanged",(()=>{this.event("onVideoEffectCapabilitiesChanged").raise()})),this.videoEffectManager.on("onVideoEffectTelementyEvent",(e=>{this.event("onVideoEffectTelementyEvent").raise(e)})),this.videoEffectManager.on("onVideoEffectApplied",(()=>{this.event("onVideoEffectApplied").raise()})),this.videoEffectManager.on("videoFreezeDetected",(e=>{this.event("videoFreezeDetected").raise(e)})))}},yw=class e extends ze{constructor(t,i,n,r,s,a,o,c,l,d){super(t),this.logger=t,this.configProvider=i,this.diagnostics=n,this.domOverrides=r,this.ufdManager=s,this.id=dt(),this.virtualDeviceRecord=new Map,this.deviceEnumerator=new nw(this.configProvider,this.logger.createChild("DeviceEnumerator")),this.deviceSelection=new rw(nw.list,this.configProvider,this.logger.createChild("DeviceSelection")),this.permissionManager=new cw(this.configProvider,{getMediaStream:e=>this.getMediaStream({...e,withEffect:!1,withTimeout:!0,force:!1,audioProcessingFlags:e.audio&&!e.video?this.getAudioProcessingFlags():void 0},"permissionManager"),hasCamera:()=>this.hasDeviceType("camera"),raiseTelemetryEvent:(e,t)=>this.raiseTelemetryEvent(e,t),getActiveConstraints:()=>this.mediaStreamManager.getActiveConstraints(),handlePermissionStateChange:()=>this.handlePermissionStateChange()},this.logger.createChild("PermissionManager")),this.activeRenderers=[],this.selectedDevices={camera:null,microphone:null,speaker:null,audioIngestDevice:null},this.pendingDevices=null,this.deviceManagerSubscriptions=[],this.streamManagerSubscriptions=[],this.streamSubscriptions=new Map,this.rendererSubscriptions=new Map,this.rawDeviceStreamManager=new BA(this.logger.createChild("RawDeviceStream"),this.raiseTelemetryEvent.bind(this)),this.customDeviceMediaStreamMap=new Map,this.clientAudioRenderers=new Map,this.audioSharingRequested=!1,this.virtualDeviceSubs=new Map,this.effectsManagerInternal=new vw(this.configProvider,this.logger.createChild("EffectsManager")),this.effectsManagerInternal.addEffectManager("Audio",{wasmdnsProvider:o,wasmaecProvider:c,wasmVqeProvider:l,createAudioWasmWorkerCbs:d?.audioWorklet}),this.effectsManagerInternal.addEffectManager("Video",{webcvProvider:a,createWasmCVWorker:d?.createWasmCVWorker}),this.mediaStreamManager=new BR(this.logger.createChild("MediaStreamManager"),this.configProvider,this.effectsManager),this.deviceManagerSubscriptions=[this.permissionManager.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise())),nw.list.on("onDevicesChanged",((e,t)=>this.onDevicesChanged(e,t))),this.deviceSelection.on("onSelectedDevicesChanged",((e,t)=>this.onSelectedDevicesChanged(e,t))),this.effectsManager.on("onAudioEffectTelemetryEvent",(e=>{this.diagnostics?.registerAudioEffectsEvent(ct(e)),this.event("onAudioEffectsTelemetryEvent").raise(e)})),this.effectsManager.on("onMediaStreamUpdateRequested",(e=>this.onMediaStreamUpdateRequested(e,!0))),this.effectsManager.on("onVideoEffectQualityChanged",(e=>this.onVideoEffectsQualityEventHandler(e))),this.effectsManager.on("onVideoEffectTelementyEvent",(e=>{this.diagnostics?.registerVideoEffectsEvent(ct(e)),this.event("onVideoEffectsTelemetryEvent").raise(e)})),this.effectsManager.on("onVideoEffectApplied",(()=>{this.raiseTelemetryEvent("video_effect_applied",{}),this.event("onVideoEffectApplied").raise()}))],this.subscribeOnStreamManagerEvents(),this.subscribeOnDeviceEnumeratorEvents(),this.deviceList.length&&this.onSelectedDevicesChanged(this.deviceSelection.selectedDevices,!1),this.createChildDeviceManager=t=>new e(t,i,void 0,r,s,a,o,c,l,d)}get deviceList(){return nw.list.devices}get isDeviceEnumeratorInitialized(){return nw.isInitialized}get isAudioOutputSelectionSupported(){return this.configProvider.userAgentConfig.isAudioOutputSelectionSupported}get effectsManager(){return this.effectsManagerInternal}createPreviewRenderer(e){const t=new tR(e,this,this.logger.createChild("videorenderer"),this.configProvider);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(t.getVideoElement()),this.subscribeOnRendererEvents(t),t}async askDevicePermission(e){await this.isDeviceEnumeratorInitialized.promise;const t=await this.permissionManager.askDevicePermission(e);if(this.configProvider.config.devices.enumerateDevicesAfterADP)try{await nw.enumerateDevices()}catch(e){this.logger.safe.warn(`Post-ADP device enumeration failed: ${Ve(e)}`)}return t}getPermissionState(e){return this.permissionManager.getPermissionState(e)}handlePermissionStateChange(){this.diagnostics&&(this.diagnostics.permissionStates=this.permissionManager.knownPermissionStates),this.event("onPermissionStateChanged").raise()}onMediaStreamUpdateRequested(e,t=!1){if("Video"===e&&(this.updateRenderersAsync(),this.effectsManager.isEffectEnabled("Video")))return this.logger.safe.info("onStreamUpdateRequested will be called after the first frame is proccessed of the video effect stream"),void this.effectsManager.once("onVideoEffectApplied",(()=>this.event("onStreamUpdateRequested").raise(e)));this.event("onStreamUpdateRequested").raise(e,t)}createAudioRenderer(){const e=new HA(this.logger.createChild("CustomAudioRenderer"),this.configProvider),t=dt();this.clientAudioRenderers.set(t,e);const i=e.play.bind(e),n=e.stop.bind(e);return this.raiseTelemetryEvent("custom_audio_renderer_created",this.getSelectedDevices()),{play:i,stop:n,dispose:()=>{this.clientAudioRenderers.get(t)?.dispose(),this.clientAudioRenderers.delete(t)},setMuted:(t,i=Te())=>e.setMuted(t,i),isMuted:()=>e.muted}}setAudioSharingRequested(e){this.audioSharingRequested=e}createDevicesHandle(e,t,i){const n=e.sharing?"ScreenShare":e.video?"Video":"Audio";return new sw(this.logger.createChild("DevicesHandle"),this.getMediaStream({...e,...i&&{deviceId:i},withTimeout:!1,withEffect:!1,audioProcessingFlags:this.audioProcessingFlags,force:!1,withOverridenStream:this.customDeviceMediaStreamMap.get(n)?.active&&this.customDeviceMediaStreamMap.get(n)},t))}shareSystemSound(e){this.configProvider.config.postponeAudioMixerForAudioSharing&&(this.audioSharingRequested=e,this.event("onAudioSharingToggled").raise(e))}getAllowedModalities(){const e=ot(this.permissionManager.browserPermittedModalities);return this.hasDeviceType("microphone")||(e.audio=[Qe.MEDIA_STATE.inactive,Qe.MEDIA_STATE.receive]),this.hasDeviceType("camera")||(e.video=[Qe.MEDIA_STATE.inactive,Qe.MEDIA_STATE.receive]),e}getRawDeviceMediaStream(e,t){if("ScreenShare"!==e&&!this.hasDeviceType(this.getDeviceType(e)))throw new Error("NoInputDevice");this.audioSharingRequested=t;const i=this.getStreamHandlerByType(e);if(!i)return this.logger.safe.debug(`method not found for ${e}`),null;const n=this.rawDeviceStreamManager.createIRawStreamClient(i,e);return this.raiseTelemetryEvent("IRawStream_client_created",e),n}setRawMediaStream(e,t){if(!e)throw this.logger.error(`Could not set ${e} as to ${t}`),new Error("InvalidStream");this.customDeviceMediaStreamMap.set(t,e),this.onMediaStreamUpdateRequested(t),this.raiseTelemetryEvent("set_raw_outgoing_media_stream",t)}unsetRawMediaStream(e){this.customDeviceMediaStreamMap.get(e)?(this.customDeviceMediaStreamMap.delete(e),this.onMediaStreamUpdateRequested(e),this.raiseTelemetryEvent("unset_raw_outgoing_media_stream",e)):this.logger.safe.debug("no custom stream")}async setVideoEffects(e){return this.effectsManager.setEffectType("Video",e)}async setAudioEffects(e){return this.effectsManager.setEffectType("Audio",e)}async getAudioStream(e,t,i=!1){const n=this.configProvider.config.devices.enumerateBeforeGettingStream;return n&&("always"!==n&&nw.isPolling||await nw.enumerateDevices()),this.getMediaStream({audio:!0,withTimeout:this.permissionManager.isPermissionKnown("microphone"),withEffect:!i&&this.effectsManager.isEffectEnabled("Audio"),audioProcessingFlags:this.getAudioProcessingFlags(),force:e,withOverridenStream:!i&&this.customDeviceMediaStreamMap.get("Audio")?.active&&this.customDeviceMediaStreamMap.get("Audio")},t)}async getVideoStream(e,t,i=!1){const n=this.configProvider.config.devices.enumerateBeforeGettingStream;return n&&("always"!==n&&nw.isPolling||await nw.enumerateDevices()),this.getMediaStream({video:!0,withTimeout:this.permissionManager.isPermissionKnown("camera"),withEffect:!i&&this.configProvider.config.enableVideoEffects&&this.effectsManager.isEffectEnabled("Video"),force:e,withOverridenStream:!i&&this.customDeviceMediaStreamMap.get("Video")?.active&&this.customDeviceMediaStreamMap.get("Video")},t)}getDisplayStream(e,t=!1){const i=!(!this.configProvider.config.enableAudioSharing||!this.audioSharingRequested);return this.getMediaStream({audio:i,sharing:!0,withTimeout:!1,withEffect:!1,audioProcessingFlags:i?0:void 0,force:!1,withOverridenStream:!t&&this.customDeviceMediaStreamMap.get("ScreenShare")?.active&&this.customDeviceMediaStreamMap.get("ScreenShare")},e)}async enumerateDevicesAsync(){return await this.isDeviceEnumeratorInitialized.promise,this.getDeviceDescriptions(this.deviceList)}async getDeviceNameAsync(e){await this.isDeviceEnumeratorInitialized.promise;const t=this.deviceList.find((t=>t.guid===e));return t?.label??""}async getSpeakerDeviceDomIdAsync(e){await this.isDeviceEnumeratorInitialized.promise;const t=this.deviceList.find((t=>t.guid===e));return t?.deviceId??""}selectDevices(e){return this.pendingDevices?(this.logger.safe.info(`Overriding device selection until enumeration is complete with ${JSON.stringify(gm(this.pendingDevices))}`),void(this.pendingDevices=e)):this.isDeviceEnumeratorInitialized.isPending?(this.logger.safe.info("Postponing device selection until enumeration is complete"),this.pendingDevices=e,void this.isDeviceEnumeratorInitialized.promise.then((()=>{this.logger.safe.info("Performing postponed device selection");const e=this.pendingDevices;this.pendingDevices=null,this.selectDevices(e)}))):void this.deviceSelection.selectDevices(e)}getSelectedDevices(){return this.toSelectedDevices(this.deviceSelection.selectedDevices)}setAudioProcessingFlags(e){e!==this.audioProcessingFlags&&(this.logger.debug(`Setting audio processing flags: ${this.audioProcessingFlags} -> ${e}`),this.audioProcessingFlags=e,this.event("onStreamUpdateRequested").raise("Audio"))}getOutputDeviceId(){return this.selectedDevices.speaker?.deviceId}getDeviceDescriptions(e){return(e||this.deviceList).map((e=>e.toDeviceDesc()))}getDevicesCount(){return this.deviceList.reduce(((e,t)=>(e[t.type]++,e)),{camera:0,speaker:0,microphone:0,compositeAudio:0,virtualDevice:0,audioIngestDevice:0})}async getKnownPermissionStates(){return await this.permissionManager.initialize(),this.permissionManager.knownPermissionStates}getLocalVideoRenderers(){return this.activeRenderers}dispose(){this.deviceManagerSubscriptions?.forEach((e=>e.dispose())),this.deviceManagerSubscriptions=null,this.virtualDeviceSubs?.forEach((e=>e.forEach((e=>e.dispose())))),this.virtualDeviceSubs?.clear(),this.virtualDeviceSubs=null,this.virtualDeviceRecord?.forEach((e=>e.dispose())),this.virtualDeviceRecord=null,this.unsubscribeFromStreamManagerEvents(),this.deviceEnumerator.dispose(),this.mediaStreamManager.dispose(),this.activeVideoEffectSub?.dispose(),this.activeVideoStreamForEffect?.dispose(),this.disposeRawStreamAccess(),this.disposeClientAudioRenderer(),this.effectsManager.dispose(),super.dispose()}async registerVirtualDevice(e,t){const i=e.length?e.map((({id:e},t)=>{const i=this.createChildDeviceManager(this.logger.createChild(`VirtualDevice-${t}`));return i.selectDevices({camera:e}),i})):[this.createChildDeviceManager(this.logger.createChild("VirtualDevice"))],n=new lw(i,t),r=n.id,s=[n.on("onVideoEffectApplied",((...e)=>this.event("onVideoEffectApplied").raise(...e))),n.on("onVideoEffectsEvent",((...e)=>this.event("onVideoEffectsEvent").raise(...e))),n.on("onDeviceTelemetryEvent",((...e)=>this.event("onDeviceTelemetryEvent").raise(...e))),n.on("onVideoEffectsTelemetryEvent",((...e)=>this.event("onVideoEffectsTelemetryEvent").raise(...e))),n.on("onDevicesPermissionChanged",((...e)=>this.event("onDevicesPermissionChanged").raise(...e))),n.on("onStreamUpdateRequested",((...e)=>this.event("onStreamUpdateRequested").raise(...e)))];return this.virtualDeviceSubs.set(r,s),this.virtualDeviceRecord.set(r,n),nw.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.raiseTelemetryEvent("register_virtual_device",{deviceCount:i.length,id:r}),this.event("onVirtualDevicesChanged").raise(),r}async unregisterVirtualDevice(e){this.virtualDeviceRecord.has(e)?(this.virtualDeviceSubs.get(e).forEach((e=>e.dispose())),this.virtualDeviceSubs.delete(e),this.virtualDeviceRecord.get(e).dispose(),this.virtualDeviceRecord.delete(e),nw.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.event("onVirtualDevicesChanged").raise(),this.raiseTelemetryEvent("unregister_virtual_device",{id:e})):this.logger.error(`No virtual device found with id ${e}`)}getRegisteredDevices(){return Array.from(this.virtualDeviceRecord.values())}getAudioProcessingFlags(){if(!this.effectsManager.shouldFallbackToNativeProcessing("Audio"))return this.audioProcessingFlags??this.configProvider.config.defaultAudioProcessingFlags}disposeClientAudioRenderer(){this.clientAudioRenderers.size&&(this.clientAudioRenderers.forEach((e=>{e.dispose()})),this.clientAudioRenderers.clear(),this.raiseTelemetryEvent("custom_audio_renderer_disposed",this.getSelectedDevices()))}disposeRawStreamAccess(){this.rawDeviceStreamManager.disposeAll(),this.rawDeviceStreamManager=null}toSelectedDevices(e){return Object.entries(e).reduce(((e,[t,i])=>(i&&(e[t]=i.guid),e)),{})}getStreamConstraints(e){return{deviceId:e?.deviceId||void 0}}hasDeviceType(e){return rt(this.deviceList).some((t=>t.type===e))}getConstraints(e){if(!e.audio&&!e.video&&!e.sharing)throw new Error("requesting nothing");if(this.logger.safe.info(`retrieving media stream: ${JSON.stringify(e)}`),e.sharing){let t;const i=this.selectedDevices.audioIngestDevice;return t=i&&e.deviceId?{deviceId:i.deviceId}:e.audio&&!e.deviceId?{deviceId:Qe.SYSTEM_AUDIO_SOURCE_ID}:void 0,{audio:t,sharing:{deviceId:e.deviceId||Qe.DISPLAY_SOURCE_ID},withTimeout:e.withTimeout,withEffect:!1,audioProcessingFlags:e.audioProcessingFlags,force:!1,withOverridenStream:e.withOverridenStream}}const t=this.selectedDevices.microphone,i=this.selectedDevices.camera,n=e.audio&&t,r=e.video&&i;if(!n&&!r)throw{type:Qe.MEDIA_ERROR.noDeviceSelected,detail:`audio requested ${e.audio}, video requested: ${e.video} Devices: ${JSON.stringify(this.deviceList.map((e=>JSON.stringify(pm(e,this.configProvider.config.devices.piiSafeWords)))))}`};const s=this.getStreamConstraints(t),a=this.getStreamConstraints(i);let o=e.audioProcessingFlags;return void 0!==o&&e.audio&&!e.video&&t?.capabilities&&(t.capabilities.echoCancellation&&!t.capabilities.echoCancellation.includes(!!(2&o))&&(o^=2),t.capabilities.autoGainControl&&!t.capabilities.autoGainControl.includes(!!(1&o))&&(o^=1),t.capabilities.noiseSuppression&&!t.capabilities.noiseSuppression.includes(!!(4&o))&&(o^=4)),o!==e.audioProcessingFlags&&this.logger.safe.warn(`Unable to fulfill processing flags ${e.audioProcessingFlags}, using ${o} instead`),{audio:e.audio?s:void 0,video:e.video?a:void 0,withTimeout:e.withTimeout,withEffect:e.withEffect,audioProcessingFlags:o,force:e.force,withOverridenStream:e.withOverridenStream}}getMediaStream(e,t){const i=this.getConstraints(e),n=this.mediaStreamManager.getMediaStream(i,t);return this.subscribeOnStreamEvents(n),n.start().then((()=>{const t=n.hasAudio(),i=n.hasVideo();t&&this.signalDeviceGood("Audio",n.rawTrack.muted),i&&this.signalDeviceGood(n.mediaType,n.rawTrack.muted),this.permissionManager.update(e,e)})).catch((t=>this.handleUserMediaError(e,t))),n}signalDeviceGood(e,t){this.ufdManager.signalDeviceEvent(0,"Good",e,this.id),this.ufdManager.signalDeviceEvent(1,"Good",e,this.id),this.ufdManager.signalDeviceEvent(3,"Good",e,this.id),t||"Audio"!==e&&!this.configProvider.config.raiseVideoMuteUfd||this.ufdManager.signalDeviceEvent(2,"Good",e,this.id)}handleUserMediaError(e,t){const i=this.getMediaType(e),n=e.audio&&e.video,r=(e,t)=>{!n&&this.ufdManager.signalDeviceEvent(e,t,i,this.id)};switch(t.type){case Qe.MEDIA_ERROR.permissionDeniedError:"ScreenShare"!==i&&(r(3,"Bad"),this.configProvider.config.permissions.persistOnDeniedError&&this.refreshPermissions(e));break;case Qe.MEDIA_ERROR.permissionDeniedBySystemError:r(3,"Bad");break;case Qe.MEDIA_ERROR.sourceUnavailableError:r(0,"Bad");break;case Qe.MEDIA_ERROR.mediaStreamRequestTimedOut:r(1,"Bad");break;default:this.logger.safe.error(`getMediaStream() error: ${Ve(t)}`),r(0,"Bad")}}refreshPermissions(e){const t=e.audio&&!e.video,i=!e.audio&&e.video;t?this.permissionManager.update({audio:!0},{audio:!1}):i&&this.permissionManager.update({video:!0},{video:!1})}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`mediaType is not defined for this constraint ${JSON.stringify(e)}`)}subscribeOnStreamEvents(e){const t=[];t.push(e.on("onStreamClientStarted",((e,t)=>this.onStreamStarted(e,t)))),t.push(e.on("onStreamClientDisposing",(e=>this.onStreamDisposing(e)))),t.push(e.on("onStreamClientEnded",((e,t)=>this.onStreamEnded(e,t)))),t.push(e.on("onStreamClientMuted",((e,t)=>this.onStreamMuted(e,t)))),t.push(e.on("onStreamClientError",((e,t)=>this.onStreamError(e,t)))),this.configProvider.config.useRawMediaApiForVideoEffects&&t.push(e.on("onStreamClientDisposed",(e=>this.removeVideoEffectStream(e)))),this.streamSubscriptions.set(e,t)}async removeVideoEffectStream(e){if(e.getCurrentConstraints().withEffect){this.logger.safe.info(`this.activeVideoEffectSub: ${this.activeVideoEffectSub} to be disposed`),this.activeVideoEffectSub?.dispose();const e=await(this.activeVideoStreamForEffect?.getMediaStream());this.effectsManager.stopEffect("Video",e)}}unsubscribeFromStreamEvents(e){this.streamSubscriptions.has(e)&&(this.streamSubscriptions.get(e).forEach((e=>e.dispose())),this.streamSubscriptions.delete(e))}subscribeOnRendererEvents(e){const t=[];t.push(e.on("onRendererDisposed",(e=>this.onRendererDisposed(e)))),t.push(e.on("onRendererStarted",(e=>this.onRendererStarted(e)))),t.push(e.on("onRendererSizeChanged",((e,t)=>this.onRendererSizeChanged()))),this.rendererSubscriptions.set(e,t)}unsubscribeFromRendererEvents(e){this.rendererSubscriptions.has(e)&&(this.rendererSubscriptions.get(e).forEach((e=>e.dispose())),this.rendererSubscriptions.delete(e))}subscribeOnStreamManagerEvents(){this.streamManagerSubscriptions=[],this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onAllStreamsRemoved",(()=>this.onAllStreamsRemoved()))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamAcquired",((e,t,i,n,r,s)=>this.onStreamAcquired(e,t,i,n,r,s)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamCreated",((e,t)=>this.onStreamCreated(e,t)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamDisposing",((e,t)=>this.onMasterStreamDisposing(e,t))))}subscribeOnDeviceEnumeratorEvents(){this.deviceEnumerator.on("onDeviceEnumerationfailed",(e=>this.raiseTelemetryEvent("enumeration_failed",{error:e})))}unsubscribeFromStreamManagerEvents(){this.streamManagerSubscriptions.forEach((e=>e.dispose()))}async updateRenderersAsync(){try{await Promise.all(this.activeRenderers.map((e=>e.updateStreamAsync()))),this.logger.safe.info("Renderers updates finished")}catch(e){this.logger.safe.error(`Error updating renderers: ${Ve(e)}`)}}onSelectedDevicesChanged(e,t){const i=this.selectedDevices;if(this.selectedDevices=e,this.diagnostics?.setSelectedDevices(e,t),!("camera"in i^"camera"in this.selectedDevices||"microphone"in i^"microphone"in this.selectedDevices)){const e=this.toSelectedDevices(this.selectedDevices),t=this.toSelectedDevices(i);this.event("onSelectedDevicesChanged").raise(e,t),e.microphone!==t.microphone&&this.rawDeviceStreamManager.notifyChange("Audio"),e.camera!==t.camera&&this.rawDeviceStreamManager.notifyChange("Video"),this.clientAudioRenderers.forEach((e=>{e.setOutputDevice(this.getOutputDeviceId())}))}const n=this.configProvider.config.devices.piiSafeWords;this.raiseTelemetryEvent("selected_devices_changed",{microphone:this.selectedDevices.microphone&&_t(this.selectedDevices.microphone.label,n),camera:this.selectedDevices.camera&&_t(this.selectedDevices.camera.label,n),speaker:this.selectedDevices.speaker&&_t(this.selectedDevices.speaker.label,n),fromInterface:t}),this.updateRenderersAsync()}onDevicesChanged(e,t){this.event("onDevicesChanged").raise(e,t),this.mediaStreamManager.onDevicesChanged(e),this.diagnostics?.setDeviceList(e,t,this.getDeviceListDebugInfo());const i=this.getDevicesCount();this.ufdManager.signalEvent("ZeroCaptureDevicesEnumerated",i.microphone>0?"Good":"Bad"),this.isAudioOutputSelectionSupported&&this.ufdManager.signalEvent("ZeroRenderDevicesEnumerated",i.speaker>0?"Good":"Bad");const n=new Map;let r=1;this.raiseTelemetryEvent("devices_changed",{devices:e.map((e=>{const t=n.get(e.groupId)||r++;return n.set(e.groupId,t),{label:_t(e.label,this.configProvider.config.devices.piiSafeWords),isSystemDefault:e.isSystemDefault,kind:e.kind,type:e.type,capabilities:e.capabilities,groupId:`${t}`}})),debug:this.getDeviceListDebugInfo()})}getDeviceListDebugInfo(){return nw.list.debugInfo}raiseTelemetryEvent(e,t){this.logger.safe.info(`Device event: ${e}: ${JSON.stringify(this.scrubPayload(e,t))}`);const i={eventType:e,timestamp:Date.now(),payload:t};this.diagnostics?.registerDeviceTelemetryEvent(ct(i)),this.event("onDeviceTelemetryEvent").raise(i)}scrubPayload(e,t){return"devices_changed"===e?{devices:rt(t.devices).map((e=>pm(e,this.configProvider.config.devices.piiSafeWords))),debug:t.debug}:t}async onStreamStarted(e,t){if(this.permissionManager.browserPermittedModalities.audio.some((e=>e===Qe.MEDIA_STATE.send))||this.permissionManager.browserPermittedModalities.video.some((e=>e===Qe.MEDIA_STATE.send)))try{await nw.enumerateDevices()}catch(e){this.logger.safe.warn(`onStreamStarted device enumeration failed: ${Ve(e)}`)}if(e.rawTrack){switch(e.mediaType){case"Audio":this.deviceEnumerator.startDevicePolling(),this.updateActiveMicrophone(e,t);break;case"Video":this.deviceEnumerator.startDevicePolling()}this.configProvider.config.useRawMediaApiForVideoEffects&&e.getCurrentConstraints().withEffect&&(this.activeVideoEffectSub=this.effectsManager.on("onVideoStreamQualityChanged",((t,i,n)=>e.onVideoStreamQualityChanged(t,i,n))))}else this.logger.safe.warn(`stream:${e.id} is already disposed`)}updateActiveMicrophone(e,t){if(e.deviceId){const i=this.deviceList.find((t=>t.deviceId===e.deviceId));if(!i&&"default"!==e.deviceId)return void this.logger.safe.error("Active device not found",`Device id from track: '${we(e.deviceId)}', known devices: [${this.deviceList.map((e=>JSON.stringify(pm(e,this.configProvider.config.devices.piiSafeWords))))}]}`,JSON.stringify(mm(t)));i&&"default"!==e.deviceId&&t.audio&&t.audio.deviceId===Qe.MEDIA_DEVICE.defaultId&&nw.list.updateActiveMicrophone(i)}}onStreamDisposing(e){this.unsubscribeFromStreamEvents(e)}onStreamMuted(e,t){("Audio"===e.mediaType||this.configProvider.config.raiseVideoMuteUfd)&&this.ufdManager.signalDeviceEvent(2,t?"Bad":"Good",e.mediaType,this.id),"Audio"===e.mediaType&&this.event("onAudioStreamMuted").raise(t),this.raiseTelemetryEvent(t?"stream_muted":"stream_unmuted",e.mediaType)}onStreamEnded(e,t){t.error?(this.raiseTelemetryEvent("stream_ended_error",{mediaType:e.mediaType,error:{type:t.error.name,detail:t.error.message}}),"SourceUnavailableError"===t.error.name&&this.ufdManager.signalDeviceEvent(0,"Bad","Audio",this.id)):("Audio"!==e.mediaType&&"Video"!==e.mediaType||this.ufdManager.signalDeviceEvent(0,"Bad",e.mediaType,this.id),this.raiseTelemetryEvent("stream_ended",e.mediaType))}onStreamError(e,t){this.raiseTelemetryEvent("stream_error",{mediaType:e.mediaType,error:t})}onAllStreamsRemoved(){this.deviceEnumerator.stopDevicePolling(),this.audioSharingRequested=!1}onStreamAcquired(e,t,i,n,r,s){0!==i&&this.raiseTelemetryEvent("stream_acquired",{id:e,mediaType:t,timestamp:i,resolution:n,withAudio:r,source:s})}onStreamCreated(e,t){this.raiseTelemetryEvent("stream_created",{id:e,mediaType:t})}onMasterStreamDisposing(e,t){this.raiseTelemetryEvent("stream_disposed",{id:e,mediaType:t})}onRendererDisposed(e){nt(this.activeRenderers,(t=>t===e)),this.domOverrides.onMediaElementRemoved?.(e.getVideoElement()),this.unsubscribeFromRendererEvents(e)}onRendererStarted(e){this.activeRenderers.push(e),this.event("onLocalRendererStarted").raise(e)}getLargestRendererResolution(){const e=this.activeRenderers.map((e=>e.getResolution()));return e?.length>0?e.reduce(((e,t)=>t.height>e.height?t:e)):{width:0,height:0}}onVideoEffectsQualityEventHandler(e){const t=this.deviceSelection.selectedDevices.camera;if(t?.deviceId){const i={type:"onVideoEffectQualityChanged",payload:{message:e.message,effectType:e.effectType}};this.event("onVideoEffectsEvent").raise(t.deviceId,i)}}onRendererSizeChanged(){const e=this.getLargestRendererResolution();this.effectsManager.resetOutputConstraints("Video",e,fu.EffectQualityChangeReason.RendererSize)}getDeviceType(e){if("Video"===e)return"camera";if("Audio"===e)return"microphone";throw new Error(`DeviceType for mediaType: ${e} doesn't exist`)}getStreamHandlerByType(e){return"Video"===e?()=>this.getVideoStream(!1,"rawStream",!0):"Audio"===e?()=>this.getAudioStream(!1,"rawStream",!0):"ScreenShare"===e?()=>Promise.resolve(this.getDisplayStream("rawStream",!0)):null}},Cw=class{constructor(e){this.configProvider=e,this.data={deviceList:[],deviceSelectionChangeCount:0,deviceSelectionChangeCountFromInterface:0,permissionStates:{microphone:"unknown",camera:"unknown"},devicesCount:{microphone:0,camera:0,speaker:0,compositeAudio:0,audioIngestDevice:0,virtualDevice:0},devicesChangeCount:0,devicesPollChangeCount:0,deviceTelemetryEvents:[],videoEffectsEvents:[],audioEffectsEvents:[]},Object.defineProperty(this.data,"rawUsedDevices",{get:()=>this.rawUsedDevices,configurable:!1,enumerable:!1})}set permissionStates(e){this.data.permissionStates=e}setSelectedDevices(e,t){const i={microphone:_t(e.microphone?.label,this.configProvider.config.devices.piiSafeWords),camera:_t(e.camera?.label,this.configProvider.config.devices.piiSafeWords),speaker:_t(e.speaker?.label,this.configProvider.config.devices.piiSafeWords)};this.rawUsedDevices={microphone:e.microphone?.label,camera:e.camera?.label,speaker:e.speaker?.label},this.data.usedDevices&&(this.data.deviceSelectionChangeCount++,t&&this.data.deviceSelectionChangeCountFromInterface++),this.data.usedDevices=i}setDeviceList(e,t,i){this.data.deviceList=e.map((e=>({label:_t(e.label,this.configProvider.config.devices.piiSafeWords),kind:e.type}))),i&&(this.data.deviceDebugStrings=ct(i)),this.data.devicesCount.microphone=e.filter((e=>"microphone"===e.type)).length,this.data.devicesCount.camera=e.filter((e=>"camera"===e.type)).length,this.data.devicesCount.speaker=e.filter((e=>"speaker"===e.type)).length,this.data.devicesCount.compositeAudio=e.filter((e=>"compositeAudio"===e.type)).length,this.data.devicesChangeCount++,t&&this.data.devicesPollChangeCount++}registerDeviceTelemetryEvent(e){if("stream_acquired"===e.eventType){const t=e.payload;"Video"===t.mediaType&&(this.data.latestCameraOpenResolution=t.resolution)}Tt(this.data.deviceTelemetryEvents,e,this.configProvider.config.diagnostics.collectionLimits.numDeviceEvents)}registerVideoEffectsEvent(e){Tt(this.data.videoEffectsEvents,e,this.configProvider.config.diagnostics.collectionLimits.numVideoEffectsEvents)}registerAudioEffectsEvent(e){Tt(this.data.audioEffectsEvents,e,this.configProvider.config.diagnostics.collectionLimits.numAudioEffectsEvents)}getObjectRef(){return this.data}},_w=class{constructor(){this.data={clientDSH:void 0,signalingDSH:void 0,serverDSH:void 0,activeStrategy:void 0,lastMsgOrigin:void 0}}setCurrentActiveStrategy(e){this.data.activeStrategy=e}resetState(){return this.data.lastMsgOrigin=void 0,this}recordHistoryEvent(e,t){var i,n;(i=this.data)[n=t+"DSH"]??(i[n]={count:0,duplicateCount:0}),this.data.lastMsgOrigin=t;const r=this.data[t+"DSH"];r.count++,r.firstMsgTime??(r.firstMsgTime=Date.now()),ht(this.data.lastHistory,e)&&r.duplicateCount++,this.data.lastHistory=e,this.data.lastMsgDate=Date.now()}getObjectRef(){return this.data}},Ew=class{constructor(e,t){this.configProvider=e,this.addStatsError=t,this.data={video:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},sharing:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},subscribedTrackIds:[]}}set subscribedTrackIds(e){this.data.subscribedTrackIds=e}addSubscribe(e,t,i){const n=this.getModalityData(e);if(n){const e={evt:1,msi:t,localMsi:i,ts:Date.now()};Tt(n.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),n.counters.attempted++}}addSubscribed(e,t,i,n){const r=this.getModalityData(e);if(r){const e={evt:2,msi:t,localMsi:i,ts:Date.now(),duration:n};Tt(r.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),r.counters.subscribed++}}addUnsubscribe(e,t,i){const n=this.getModalityData(e);if(n){const e={evt:3,msi:t,localMsi:i,ts:Date.now()};Tt(n.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),n.counters.unsubscribed++}}addFailed(e,t,i,n){const r=this.getModalityData(e);if(r){const e={evt:-1,msi:t,localMsi:i,ts:Date.now(),error:n};Tt(r.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),r.counters.failed++}}getObjectRef(){return this.data}getModalityData(e){switch(e){case Qe.MEDIA_TYPE.video:return this.data.video;case Qe.MEDIA_TYPE.sharing:return this.data.sharing;default:return void this.addStatsError(`Unsupported modality ${e}`)}}},Tw=class{constructor(e,t){this.configProvider=e,this.addStatsError=t,this.data={videoMaxCapabilitiesEvents:[],videoMaxCapabilitiesErrors:[],sharingMaxCapabilitiesEvents:[],sharingMaxCapabilitiesErrors:[],currentVideoSsrcRequestedCapabilities:{},currentVideoSsrcAppliedCapabilities:{},currentSharingSsrcRequestedCapabilities:{},currentSharingSsrcAppliedCapabilities:{},numVideoControlMessages:0,numOutOfOrderVideoControlMessages:0,numWebcamFreezeIntervals:0,numProcessedStreamFreezeIntervals:0}}onMaxCapabilitiesRequested(e){const t={causeId:e.causeId,events:[{eventType:"req",timestamp:Date.now(),capabilities:e.capabilities,isSimulcast:e.isSimulcastEnabled}]};try{if(e.modality===Qe.MODALITY.video){Tt(this.data.videoMaxCapabilitiesEvents,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const t of e.capabilities)this.data.currentVideoSsrcRequestedCapabilities[`${t.ssrc??0}`]=t}else if(e.modality===Qe.MODALITY.sharing){Tt(this.data.sharingMaxCapabilitiesEvents,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const t of e.capabilities)this.data.currentSharingSsrcRequestedCapabilities[`${t.ssrc??0}`]=t}}catch(e){this.addStatsError?.("onMaxCapabilitiesRequested",Ve(e))}}onMaxCapabilitiesApplied(e){try{const t=this.getEventForCause(e.modality,e.causeId),i={eventType:"app",timestamp:Date.now(),capabilities:e.capabilities,error:`${e.error}`||"none"};if(t&&(Tt(t.events,i,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1),e.error&&(e.modality===Qe.MODALITY.video?Tt(this.data.videoMaxCapabilitiesErrors,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1):e.modality===Qe.MODALITY.sharing&&Tt(this.data.sharingMaxCapabilitiesErrors,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1))),e.modality===Qe.MODALITY.video)for(const t of e.capabilities)this.data.currentVideoSsrcAppliedCapabilities[`${t.ssrc??0}`]=t;else if(e.modality===Qe.MODALITY.sharing)for(const t of e.capabilities)this.data.currentSharingSsrcAppliedCapabilities[`${t.ssrc??0}`]=t}catch(e){this.addStatsError?.("onMaxCapabilitiesApplied",Ve(e))}}addVideoControlMessage(e=!1){this.data.numVideoControlMessages++,e&&this.data.numOutOfOrderVideoControlMessages++}getObjectRef(){return this.data}registerWebcamFreeze(){this.data.numWebcamFreezeIntervals++}registerProcessedStreamFreeze(){this.data.numProcessedStreamFreezeIntervals++}getEventForCause(e,t){return(e===Qe.MODALITY.video?this.data.videoMaxCapabilitiesEvents:this.data.sharingMaxCapabilitiesEvents).find((e=>e.causeId===t))}},Iw=class{constructor(e){this.configProvider=e,this.data={renderers:[],firstTimeToFirstFrameVideo:-1,firstTimeToFirstFrameSharing:-1,timeToFirstFrameSinceSubscriptionStartVideo:-1,timeToFirstFrameSinceSubscriptionStartSharing:-1,isRenderingEvents:{video:[],sharing:[]},preferredResolution:{video:void 0,sharing:void 0}}}setTimeToFirstFrame(e,t){-1!==e&&(t===Qe.MODALITY.video&&-1===this.data.firstTimeToFirstFrameVideo?this.data.firstTimeToFirstFrameVideo=e:t===Qe.MODALITY.sharing&&-1===this.data.firstTimeToFirstFrameSharing&&(this.data.firstTimeToFirstFrameSharing=e))}setTimeToFirstFrameSinceSubscriptionStart(e,t){-1!==e&&(t===Qe.MODALITY.video&&-1===this.data.timeToFirstFrameSinceSubscriptionStartVideo?this.data.timeToFirstFrameSinceSubscriptionStartVideo=e:t===Qe.MODALITY.sharing&&-1===this.data.timeToFirstFrameSinceSubscriptionStartSharing&&(this.data.timeToFirstFrameSinceSubscriptionStartSharing=e))}setIsRendering(e,t){this.data.isRenderingEvents[t]&&Tt(this.data.isRenderingEvents[t],{isRendering:e,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents)}setPreferredResolution(e,t){(e.width||e.height)&&(this.data.preferredResolution[t]=e)}newRendererDiagnostics(){const e=new bw(this,this.configProvider),t=e.on("onDisposed",(()=>{this.removeDeadRenderers(),t.dispose()}));return this.data.renderers.push(e.getObjectRef()),e}getObjectRef(){return this.data}removeDeadRenderers(){this.data.renderers=this.data.renderers.filter((e=>e.alive))}},bw=class extends ze{constructor(e,t){super(),this.managerDiagnostics=e,this.configProvider=t,this.isAlive=!0,this.data={alive:!0,totalFreezeDuration:0,isRendering:!1,timeToFirstFrame:-1,timeToFirstFrameSinceSubscriptionStart:-1,rendererStates:[]},delete this.data.alive,Object.defineProperty(this.data,"alive",{get:()=>this.isAlive,enumerable:!1,configurable:!1})}set trackId(e){this.data.trackId=e}set rendererSize(e){this.data.rendererSize=e,e.toString=()=>`${e.width}x${e.height}`,this.managerDiagnostics.setPreferredResolution(e,this.data.modality)}set msi(e){this.data.msi=e}set modality(e){this.data.modality=e}set isRendering(e){this.data.isRendering=e,this.managerDiagnostics.setIsRendering(e,this.data.modality)}set timeToFirstFrame(e){this.data.timeToFirstFrame=e,this.managerDiagnostics.setTimeToFirstFrame(e,this.data.modality)}set timeToFirstFrameSinceSubscriptionStart(e){this.data.timeToFirstFrameSinceSubscriptionStart=e,this.managerDiagnostics.setTimeToFirstFrameSinceSubscriptionStart(e,this.data.modality)}addFreezeDuration(e){this.data.totalFreezeDuration+=e}addStateChange(e){Tt(this.data.rendererStates,e,this.configProvider.config.diagnostics.telemetryLimits.numRendererStateChangedEvents)}dispose(){this.isAlive=!1,this.event("onDisposed").raise()}getObjectRef(){return this.data}},Aw=p,Rw=f(ye()),ww=p;function Pw(e){let t="";return Xe(e,((e,i)=>{t+=(t?";":"")+i,void 0!==e&&(t+=`=${e}`)})),t}var Mw=class{constructor(e){this.parameters={},e&&e.split(";").forEach((e=>{const t=e.split("=");this.parameters[t[0]]=t[1]}))}setIfMissing(e,t){this.contains(e)||(this.parameters[e]=t)}removeIfPresent(e){this.contains(e)&&delete this.parameters[e]}get(e){return this.parameters[e]}names(){return Object.keys(this.parameters)}contains(e){return this.parameters.hasOwnProperty(e)}toString(){return Pw(this.parameters)}};function Dw(e,t,i){if(!e.rtp)return;const n=e.rtp.filter((e=>e.payload===t))[0];n&&kw(e,{codec:n.codec,rate:n.rate,payload:n.payload,encoding:n.encoding},(e=>(e.rtp.payload=i,e)))}function Ow(e){const t=new Set;for(const i of e.media)for(const e of i.rtp??[])t.add(e.payload);const i=[96,127];for(let e=i[0];e<=i[1];e++)if(!t.has(e))return e;const n=[35,64];for(let e=n[0];e<=n[1];e++)if(!t.has(e))return e;return-1}function kw(e,t,i){Lw(e,t,!0,i)}function Nw(e,t,i){Lw(e,t,!1,i)}function Lw(e,t,i,n){if(e.rtp){for(let r=0;r<e.rtp.length;r++){const s=e.rtp[r],a=s.payload;if(t.codec.toLowerCase()!==s.codec.toLowerCase()||t.rate!==s.rate||t.encoding!==s.encoding||t.payload&&t.payload!==s.payload)continue;const o={rtp:s};e.fmtp||(e.fmtp=[]);const c=e.fmtp.find((e=>s.payload===e.payload));o.fmtp=c,e.rtcpFb||(e.rtcpFb=[]),o.rtcpFb=e.rtcpFb.filter((e=>e.payload===s.payload));const l=o.rtcpFb.length>0;if(null===n(o))e.payloads=e.payloads.toString().split(" ").filter((e=>s.payload!==+e)).join(" "),e.fmtp=e.fmtp.filter((e=>s.payload!==e.payload)),e.rtcpFb=e.rtcpFb.filter((e=>s.payload!==e.payload)),e.rtp[r]=null;else{if(o.rtp.payload!==a){const t=o.rtp.payload;e.payloads=e.payloads.toString().split(" ").map((e=>+e===a?t:+e)).join(" "),o.fmtp&&(o.fmtp.payload=t),o.rtcpFb&&o.rtcpFb.forEach((e=>e.payload=t)),e.fmtp.filter((e=>e.config&&e.config.indexOf(`apt=${a}`)>-1)).forEach((e=>e.config=e.config.replace(`apt=${a}`,`apt=${t}`)))}!c&&o.fmtp&&e.fmtp.push(o.fmtp),!l&&o.rtcpFb&&o.rtcpFb.forEach((t=>e.rtcpFb.push(t)))}if(i)break}e.rtp=e.rtp.filter((e=>!!e))}}function xw(e,t){if(!e.rtp)return;let i=-1;if(e.rtp.forEach((function(e,n){t.codec.toLowerCase()!==e.codec.toLowerCase()||t.rate!==e.rate||t.encoding!==e.encoding||t.payload&&t.payload!==e.payload||(i=n)})),i>=0&&e.rtp.length>1){const t=e.rtp[i].payload;e.rtp.splice(i,1),e.payloads=e.payloads.split(" ").filter((e=>t!==+e)).join(" "),e.fmtp=e.fmtp?.filter((e=>t!==e.payload))}}function Uw(e,t){e.rtp.unshift({payload:t.payload,codec:t.codec,rate:t.rate,encoding:t.encoding}),e.payloads=`${t.payload} ${e.payloads}`}function Fw(e,t,i){if(!(0,ww.isUndefined)(e.rate)&&e.rate!==t.rate)return!1;if(!(0,ww.isUndefined)(e.codec)&&e.codec.toLowerCase()!==t.codec.toLowerCase())return!1;if(!(0,ww.isUndefined)(e.encoding)){if(!(0,ww.isUndefined)(t.encoding)&&e.encoding!==t.encoding)return!1;if((0,ww.isUndefined)(t.encoding)&&1!==e.encoding)return!1}return!!(0,ww.isUndefined)(e.fmtpLine)||!(!i||!i.find((i=>i.payload===t.payload&&-1!==i.config.toLowerCase().indexOf(e.fmtpLine.toLowerCase()))))}function Vw(e,t){return t===e||"*"===t}function Bw(e,t,i,n){if(!e.rtp?.length)return;let r=e.rtp.filter((i=>t.some((t=>Fw(t,i,e.fmtp)))));e.type===Qe.MEDIA_TYPE.video&&(r=r.filter((t=>{const i=e.fmtp&&e.fmtp.find((e=>e.payload===t.payload&&e.config.startsWith("apt=")));if(i){const e=+i.config.split(";")[0].split("=")[1];return r.some((t=>t.payload===e))}return!0}))),r.length?(e.rtp=r,i&&(e.rtp=(0,ww.flatten)(t.map((t=>e.rtp.filter((i=>Fw(t,i,e.fmtp))))))),e.payloads=e.rtp.map((e=>e.payload)).join(" "),e.fmtp=e.fmtp&&e.fmtp.filter((t=>e.rtp.some((e=>Vw(e.payload,t.payload))))),e.rtcpFb=e.rtcpFb&&e.rtcpFb.filter((t=>e.rtp.some((e=>Vw(e.payload,t.payload)))))):n&&n.warn("Empty rtp list after filtering")}function Hw(e){if(e.label)switch(e.label){case Qe.MEDIA_LABEL.audio:return"Audio";case Qe.MEDIA_LABEL.video:return"Video";case Qe.MEDIA_LABEL.sharing:return"ScreenShare";case Qe.MEDIA_LABEL.data:return"Data"}else switch(e.type){case Qe.MEDIA_TYPE.audio:return"Audio";case Qe.MEDIA_TYPE.video:return"Video";case Qe.MEDIA_TYPE.data:case Qe.MEDIA_TYPE.dataChannel:return"Data"}return null}function $w(e){if(e.label)switch(e.label){case Qe.MEDIA_LABEL.audio:return Qe.MODALITY.audio;case Qe.MEDIA_LABEL.video:return Qe.MODALITY.video;case Qe.MEDIA_LABEL.sharing:return Qe.MODALITY.sharing;case Qe.MEDIA_LABEL.data:return Qe.MODALITY.data}else switch(e.type){case Qe.MEDIA_TYPE.audio:return Qe.MODALITY.audio;case Qe.MEDIA_TYPE.video:return Qe.MODALITY.video;case Qe.MEDIA_TYPE.data:case Qe.MEDIA_TYPE.dataChannel:return Qe.MODALITY.data}return null}function Gw(e){switch(e){case Qe.MODALITY.audio:return Qe.MEDIA_LABEL.audio;case Qe.MODALITY.video:return Qe.MEDIA_LABEL.video;case Qe.MODALITY.sharing:return Qe.MEDIA_LABEL.sharing;case Qe.MODALITY.data:return Qe.MEDIA_LABEL.data;default:return null}}function jw(e){return e.media.reduce(((e,t)=>{if(0!==t.port){const i=$w(t);if(!(i in e)){const n=t.direction?t.direction.toLowerCase():Qe.MEDIA_STATE.sendReceive;e[i]=n}}return e}),{})}function qw(e){const t=e.groups?.find((e=>"BUNDLE"===e.type));if(t){const i=t.mids?.toString().split(" ")[0];return e.media.find((e=>{const t="number"==typeof e.mid?e.mid.toString():e.mid;return i===t}))||null}return null}function Ww(e){return 0===e.port}function zw(e){let t;return e&&kw(e,{codec:"h264",rate:9e4},(e=>{e.fmtp?.config&&(t=function(e){const t=new Mw(e);return{maxFs:+t.get(Qe.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+t.get(Qe.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+t.get(Qe.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+t.get(Qe.VIDEO_CAPABILITIES.MAX_BR_PATH)}}(e.fmtp.config))})),t}function Jw(e){const t=e.media.map((e=>parseFloat(e.mid||"0")));for(let e=1;e<=Math.max(...t)+1;e++)if(!t.includes(e))return e.toString();return"-1"}var Kw=p;function Yw(){const e=[{jsep:"active",msSdp:"tcp-act"},{jsep:"passive",msSdp:"tcp-pass"},{jsep:"so",msSdp:"tcp-so"}];function t(e,t){delete e.generation,delete e["network-id"],delete e["network-cost"],e.transport.match(/tcp/i)&&i(e,t)}function i(t,i){e.some((function(e){if(i){if(e.msSdp===t.transport.toLowerCase())return t.transport="tcp",t.tcptype=e.jsep,!0}else if(t.tcptype&&e.jsep===t.tcptype.toLowerCase())return t.transport=e.msSdp,delete t.tcptype,!0;return!1}))}function n(e,t,i){const n=t.connection||i.connection,r=function(e,t,i){return e.port===i&&e.ip===t};return!!n&&(1===e.component?r(e,n.ip,t.port):!!t.rtcp&&r(e,t.rtcp.ip||n.ip,t.rtcp.port))}this.fromMsSdp=function(e){e.candidates=e.candidates||[],e.xCandidatesIpv6&&(e.xCandidatesIpv6.forEach((function(t){e.candidates.push(t)})),delete e.xCandidatesIpv6),e.candidates.forEach((function(e){t(e,!0)}))},this.toMsSdp=function(e,i){e.candidates=e.candidates||[],e.candidates.sort((function(t,r){return t.foundation!==r.foundation?t.foundation-r.foundation:t.component!==r.component?t.component-r.component:+n(r,e,i)-+n(t,e,i)})),e.candidates=e.candidates.filter((function(i,n){t(i,!1);const r=e.candidates[n-1];return!r||r.component!==i.component||r.foundation!==i.foundation})),function(e,t){if(e.port&&!e.candidates.length){const i=qw(t);i&&(e.port=i.port,e.connection=i.connection)}}(e,i)}}var Qw=()=>new Yw,Xw=class{toMsSdp(e,t){"offer"===t?e.rtcp&&(e.rtcp={port:e.port}):delete e.rtcp}},Zw=()=>new Xw,eP={STREAM_ID:{audio:"mainAudio",video:"mainVideo",sharing:"applicationsharingVideo"},STREAM_ID_DELIMITER:"-"},tP=[{label:Qe.MEDIA_LABEL.audio,id:eP.STREAM_ID.audio},{label:Qe.MEDIA_LABEL.video,id:eP.STREAM_ID.video},{label:Qe.MEDIA_LABEL.sharing,id:eP.STREAM_ID.sharing}].reduce(((e,t)=>(e[t.label]=t.id,e)),{}),iP=dt(),nP=class{constructor(e){this.configuration=e}fromMsSdp(e){if(0===e.port)return;if(!this.isRecvOnly(e)||this.configuration.unifiedPlanEnabled){if(e.msid){e.ssrcs&&1===e.ssrcs.length&&(this.addStream(e,e.ssrcs[0].id,e.ssrcs[0].value,e.msid),e.ssrcs.shift());const t=e.msid.split(" ");(this.configuration.addPrefixForMsid||"-"===t[0])&&(e.msid=this.getMsidValue(t[0],t[1]||t[0],e.label))}if(e.ssrcs)this.updateMsids(e.ssrcs,((t,i)=>this.configuration.addPrefixForMsid||"-"===t?this.getMsidValue(t,i,e.label):`${t} ${i}`));else{const t=this.getFlowSsrcs(e);t.length>0?t.forEach((i=>{this.addStream(e,i,iP,this.getMsidValue(t[0],t[0],e.label))})):e.xSsrcRange&&this.addStream(e,e.xSsrcRange.ssrcMin,iP,this.getMsidValue(e.xSsrcRange.ssrcMin,e.xSsrcRange.ssrcMin,e.label))}}delete e.xSsrcRange}toMsSdp(e,t){if(0===e.port)return;let i;e.ssrcs?.[0]&&(i=e.ssrcs[0].id),void 0!==i&&(e.xMultiStream||(e.xSsrcRange={ssrcMin:i,ssrcMax:i+t}))}getFlowSsrcs(e){if(e.ssrcGroups&&e.type===Qe.MEDIA_TYPE.video){let t;if(e.ssrcGroups.some((e=>"FID"===e.semantics&&(t=e,!0))),t)return t.ssrcs.split(" ").map((e=>+e))}return[]}addStream(e,t,i,n){e.ssrcs=e.ssrcs||[],e.ssrcs.push({attribute:"cname",id:t,value:i}),e.ssrcs.push({attribute:"msid",id:t,value:n})}updateMsids(e,t){e.filter((e=>"msid"===e.attribute)).forEach((e=>{const i=e.value.split(" ");e.value=t(i[0],i[1]||i[0])}))}getMsidValue(e,t,i){const n=this.getMsidPrefix(i);return n+e+" "+n+t}getMsidPrefix(e){return tP[e]?tP[e]+eP.STREAM_ID_DELIMITER:""}isRecvOnly(e){return"recvonly"===e.direction}},rP={audio:"main-audio",video:"main-video"},sP=class{constructor(e,t){this.context=e,this.mediaManager=t,this.logger=this.context.logger,this.candidateTransform=Qw(),this.streamTransform=new nP(this.context.configuration),this.rtcpTransform=Zw()}toMsSdp(e,t){return e.msidSemantic={semantic:"WMS",token:"*"},e.media.forEach(((i,n)=>{if(i.protocol=Qe.PROFILES.rtpSavp,i.label=i.label||this.getLabel(i.type),Ww(i)){for(const e in i)i.hasOwnProperty(e)&&["type","port","protocol","payloads"].indexOf(e)<0&&delete i[e];i.payloads="34"}const r=this.getSsrcRangeForIndex(i.direction,n);this.streamTransform.toMsSdp(i,r),i.crypto&&i.crypto.forEach((function(e){e.config+="|2^31"})),0!==i.port&&e.fingerprint&&(i.fingerprint=e.fingerprint),this.candidateTransform.toMsSdp(i,e),this.rtcpTransform.toMsSdp(i,t),i.invalid&&(this.logger.unsafe.error(`Unknown SDP attributes! ${JSON.stringify(i.invalid)}`),delete i.invalid),this.transformExtensions(i,!1),0!==i.port&&(i.type===Qe.MEDIA_TYPE.audio&&this.context.configProvider.config.webrtcAudioChannelSignalingFeedback?i.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcAudioChannelSignalingFeedback}:i.type===Qe.MEDIA_TYPE.video&&this.context.configProvider.config.webrtcVideoChannelSignalingFeedback&&(i.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcVideoChannelSignalingFeedback}))})),delete e.fingerprint,e}fromMsSdp(e,t){for(let i=e.media.length-1;i>=0;--i){const n=e.media[i];if((n.ssrcs&&n.ssrcs[0]||n.xSsrcRange)&&(e.msidSemantic={semantic:"WMS",token:"*"}),Ww(n))n.direction||(n.direction="inactive");else{if(this.streamTransform.fromMsSdp(n),delete n.cryptoscale,n.fingerprint&&(!this.isOffer(t)||this.context.configProvider.config.disableIncomingDtlsRoleOverride&&n.setup||(n.setup="actpass")),n.crypto)for(let e=n.crypto.length-1;e>=0;--e){const t=n.crypto[e];t.config.match(/.*\|\d+:\d+/)?n.crypto.splice(e,1):t.config=t.config.replace(/(.*)\|2\^\d+/,"$1")}n.remoteCandidates&&(delete n.candidates,delete n.xCandidatesIpv6,delete n.remoteCandidates),this.candidateTransform.fromMsSdp(n),n.rtcpFbXMessage&&delete n.rtcpFbXMessage,n.invalid&&this.logger.unsafe.info(`Unknown SDP attributes! ${JSON.stringify(n.invalid)}`),this.transformExtensions(n,!0)}}return e}transformExtensions(e,t){const i=[{name:Qe.ABS_SEND_TIME.EXT_URI,encoded:Qe.ABS_SEND_TIME.MSSDP_ENCODED_URI},{name:Qe.TRANSPORT_CC.EXT_URI,encoded:Qe.TRANSPORT_CC.MSSDP_ENCODED_URI}];e.ext&&e.ext.forEach((function(e){i.some((function(i){const n=t?i.encoded:i.name,r=t?i.name:i.encoded;return n===e.uri&&(e.uri=r,!0)}))}))}isOffer(e){return"offer"===e}getLabel(e){return rP.hasOwnProperty(e)&&rP[e]||"undefined"}getSsrcRangeForIndex(e,t){const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();return zp(e)&&n?n.getSsrcRange():0}},aP=class{constructor(e,t,i){this.context=e,this.mediaManager=t,this.sessionType=i,this.msSdpT=new sP(this.context,this.mediaManager)}modify(e){this.msSdpT.toMsSdp(e,this.sessionType)}},oP=class{constructor(e,t,i){this.context=e,this.mediaManager=t,this.sessionType=i,this.msSdpT=new sP(this.context,this.mediaManager)}modify(e){this.msSdpT.fromMsSdp(e,this.sessionType)}},cP=class{constructor(e){this.context=e}modify(e){const t=fm(this.context),i=im(e),n=e.media.find((e=>!!e.crypto));e.media.forEach((e=>{e.type!==Qe.MEDIA_TYPE.dataChannel&&(!t&&e.fingerprint&&e.crypto&&delete e.crypto,e.protocol=!i.dtls||i.sdes&&t?Qe.PROFILES.rtpSavpf:Qe.PROFILES.udpTlsRtpSavpf,Ww(e)&&e.protocol===Qe.PROFILES.rtpSavpf&&n&&(e.crypto=n.crypto))}))}},lP=class{constructor(e,t,i){this.mediaManager=e,this.isOffer=t,this.configProvider=i}modify(e){e.media.forEach(((e,t)=>{const i=e.setup,n=this.mediaManager.getMediaEntities()[t],r=n.getExtension("setup");i&&n.isEnabled()&&("actpass"!==i?n.setExtension("setup",i):this.isOffer&&void 0!==r&&"actpass"!==r&&!this.configProvider.config.disableOutgoingDtlsRoleOverride&&(e.setup=r))}))}},dP=class{constructor(e,t){this.mediaManager=e,this.modalities=t}modify(e){let t=0;e.media.forEach(((e,i)=>{const n=parseInt(e.mid,10);!isNaN(n)&&n>=t&&(t=n+1)})),e.media.forEach(((i,n)=>{const r=this.mediaManager.getMediaEntities()[n];if(Ww(i)||r.isDisabled()||!(r.getModality()in this.modalities)){const s=r.getExtension("midApplied")?void 0:i.mid||""+t++;0===n?i.direction=Qe.MEDIA_STATE.inactive:e.media[n]=mM(i.type,void 0,i.protocol,s)}}))}},hP=class{constructor(e,t){this.mediaManager=e,this.remote=t}modify(e){const t=this.mediaManager.getMediaEntities();for(let i=0;i<t.length;i++){const n=t[i],r=e.media[i];if(n.getExtension("rollback"))if(r&&!this.remote)e.media[i]=null;else if(!r&&this.remote){const t=n.getType()===Qe.MEDIA_TYPE.data?Qe.MEDIA_TYPE.dataChannel:n.getType(),i=t===Qe.MEDIA_TYPE.dataChannel?Qe.PROFILES.udpDtlsSctp:Qe.PROFILES.udpTlsRtpSavpf;e.media.push(mM(t,void 0,i,void 0))}}e.media=e.media.filter((e=>e))}},uP=class{constructor(e){this.mediaManager=e}modify(e){this.mediaManager.getMediaEntities().forEach(((t,i)=>{const n=e.media[i];t.getModality()!==Qe.MODALITY.data||n&&n.type===Qe.MEDIA_TYPE.dataChannel||e.media.splice(i,0,mM(Qe.MEDIA_TYPE.data,Qe.MEDIA_LABEL.data,Qe.PROFILES.rtpSavp,void 0))}))}},gP=class{constructor(e,t){this.context=e,this.direction=t}modify(e){e.media.forEach((e=>{e.type===Qe.MEDIA_TYPE.dataChannel&&(e.type=Qe.MEDIA_TYPE.data,e.payloads=Qe.PAYLOAD_TYPE.X_DATA)})),vm(this.context)&&fM(e,Qe.MEDIA_TYPE.data).forEach((t=>{t.rtp=t.rtp||[],t.fmtp=t.fmtp||[],t.rtp.push({codec:"x-data",payload:127,rate:9e4}),t.rtp.push({codec:"rtx",payload:126,rate:9e4}),t.fmtp.push({payload:126,config:"apt=127"});const i=this.getNonOverlappingSsrc(e);t.xSsrcRange={ssrcMin:i,ssrcMax:i},t.rtcpMux="rtcp-mux",t.xDataProtocol="sctp",t.direction=this.direction}))}getNonOverlappingSsrc(e){let t,i=!0;do{t=Math.floor(4294967293*Math.random())+2,fM(e).forEach((e=>{e?.ssrcs?.[0]?.id===t&&(i=!1)}))}while(!i);return t}},pP=class{constructor(e){this.configProvider=e,this.uri="urn:3gpp:video-orientation",this.value=13}modify(e){if(this.configProvider.config.enableVideoOrientationExtension)for(const t of fM(e,Qe.MEDIA_TYPE.video))this.modifyMedia(t)}},mP=class extends pP{modifyMedia(e){e.ext??(e.ext=[]),e.ext.some((e=>e.uri===this.uri))||e.ext.push({value:this.getAvailableValue(e.ext),uri:this.uri})}getAvailableValue(e){const t=e.map((e=>e.value));return t.includes(this.value)?Math.max(...t)+1:this.value}},fP=class extends pP{modifyMedia(e){e.ext=e.ext?.filter((e=>e.uri!==this.uri))}},SP=class{constructor(e){this.context=e}modify(e){const t=e.groups?.find((e=>"BUNDLE"===e.type));for(let i=e.media.length-1;i>=0;i--){const n=e.media[i];if(n.type===Qe.MEDIA_TYPE.data){const r=this.context.configProvider.config.rejectUnbundledDataModality&&!this.context.configProvider.mediaConfig.isTransportUnbundled&&!t?.mids?.toString().includes(n.mid),s=vm(this.context);s||this.context.configProvider.config.acceptDisabledDataModality?(n.port=s&&!r?n.port:0,n.payloads=Qe.PAYLOAD_TYPE.DATA_CHANNEL,n.type=Qe.MEDIA_TYPE.dataChannel,n.protocol=Qe.PROFILES.udpDtlsSctp,n.sctpPort??(n.sctpPort=this.context.configProvider.config.sctpPort),delete n.xDataProtocol,delete n.rtp,delete n.fmtp,delete n.rtcp,delete n.rtcpMux,delete n.ext,delete n.ssrcs,delete n.ssrcGroups,delete n.xSsrcRange):e.media.splice(i,1)}}}},vP=class{constructor(e,t){this.modalities=e,this.mediaManager=t}modify(e){fM(e).forEach((e=>{const t=$w(e),i=this.mediaManager.getMediaEntityByMid(e.mid);!(this.modalities[t]!==Qe.MEDIA_STATE.send||i.getExtension("reinviteless")||e.direction&&e.direction.toLowerCase()===Qe.MEDIA_STATE.receive)&&(e.direction=Qe.MEDIA_STATE.receive)}))}},yP=class{constructor(e,t){this.isMultiparty=e,this.cname=t}modify(e){this.isMultiparty&&fM(e).forEach((e=>{const t=e.direction;t!==Qe.MEDIA_STATE.receive&&t!==Qe.MEDIA_STATE.inactive||(e.ssrcs&&e.ssrcs[0]?e.ssrcs=[{id:e.ssrcs[0].id,attribute:"cname",value:this.cname}]:e.type===Qe.MEDIA_TYPE.audio?e.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:e.type===Qe.MEDIA_TYPE.video&&(e.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}))}},CP=class{modify(e){const t=new Set;fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{e.ssrcs&&e.ssrcs.length>1&&t.add(e.ssrcs[0].id)}));const i=fM(e,Qe.MEDIA_TYPE.video).find((e=>e.direction===Qe.MEDIA_STATE.sendReceive||e.direction===Qe.MEDIA_STATE.send));fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{const n=e.direction;if((n===Qe.MEDIA_STATE.receive||n===Qe.MEDIA_STATE.inactive)&&e.ssrcs&&1===e.ssrcs.length){const n=e.ssrcs[0].id;(1===n||i&&i.ssrcs[0].id===n||!i&&t.has(n))&&(delete e.ssrcs,delete e.ssrcGroups)}}))}},_P=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t];e.label=Gw(i.getModality())}))}},EP=class{modify(e){e.media.forEach((e=>{delete e.label}))}},TP=class{constructor(e,t,i){this.mediaManager=e,this.modalities=t,this.configProvider=i}modify(e){let t=this.configProvider.mediaConfig.maxBandwidthInKbps;const i=e.bandwidth?.find((e=>"CT"===e.type));i&&(!t||t>i.limit)&&(t=i.limit);const n=this.configProvider.config.audioBandwidthInKbps||0,r=Math.max(t-n,0),s=this.configProvider.config.videoBandwidthAllocation&&zp(this.modalities.video)&&zp(this.modalities.sharing);fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{if(delete e.bandwidth,r){let t=r;if(s){const i=this.mediaManager.getMediaEntityByMid(e.mid).getModality()===Qe.MODALITY.video?this.configProvider.config.videoBandwidthAllocation:1-this.configProvider.config.videoBandwidthAllocation;t=Math.round(r*i)}e.bandwidth=[{limit:t,type:"AS"}]}}))}},IP=class{constructor(e){this.configProvider=e}modify(e){const t=this.configProvider.mediaConfig.maxBandwidthInKbps;t&&(e.bandwidth=[{limit:t,type:"CT"}])}},bP=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t],n=i.getExtension("iceUfrag");i.setExtension("iceRestart",!!e.iceUfrag&&!!n&&n!==e.iceUfrag),i.setExtension("iceUfrag",e.iceUfrag)}))}},AP=class{modify(e){const t=new Set(["urn:ietf:params:rtp-hdrext:csrc-audio-level","http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"]);fM(e).forEach((e=>{e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))))}))}},RP=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.extmapAllowMixed&&(e.extmapAllowMixed="extmap-allow-mixed")}},wP=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.extmapAllowMixed||delete e.extmapAllowMixed}},PP=class{modify(e){fM(e).forEach((e=>{delete e.signalingFbXMessage}))}},MP=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){if(!this.configProvider.config.isAv1Allowed)return;const t=function(e,t){const i=new Set,n=[];for(const t of e.media)for(const e of t.rtp??[])i.add(e.payload);for(let e=t[0];e<=t[1];e++)i.has(e)||n.push(e);return n}(e,[96,127]);this.mediaManager.getMediaEntities().forEach(((i,n)=>{if(i.getModality()===Qe.MODALITY.audio)return;const r=e.media[n];let s=0;Nw(r,{codec:"AV1",rate:9e4},(e=>{e.rtp.payload<96&&(e.rtp.payload=t[s]??e.rtp.payload,s++)}))}))}},DP=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.baseModifier=new kP(this.mediaManager,this.configProvider,this.sdpType,!1)}modify(e){this.configProvider.config.filterCodecsInSdpV2||this.baseModifier.modify(e)}},OP=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.baseModifier=new kP(this.mediaManager,this.configProvider,this.sdpType,!0)}modify(e){this.configProvider.config.filterCodecsInSdpV2&&this.baseModifier.modify(e)}},kP=class{constructor(e,t,i,n=!1){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.alwaysReorder=n}modify(e){this.configProvider.config.filterCodecsInSdp&&"offer"===this.sdpType&&this.mediaManager.getMediaEntities().forEach(((t,i)=>{const n=e.media[i];if(!n)return;const r=ym(this.configProvider,n.type);r.length&&Bw(n,Em(r),!!t.getExtension("unnegotiatedModality")||this.alwaysReorder,null)}))}},NP=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;t&&i&&(i.codec!==i.lastUsedCodec&&"None"!==i.lastUsedCodec&&this.removeSubstitutionCodecIfNeeded(t,i.lastUsedCodec),i.enabledLocally&&!i.disabledRemotely&&this.addSubstitutionCodecIfNeeded(t,i.codec,e))}addSubstitutionCodecIfNeeded(e,t,i){if(this.isSubstitutionCodecAdded(e,t))return;const n=Ow(i);if(-1===n)return;const r=vM(t,"SUBSTITUTION");yM(i,r.payload,n),Uw(e,r)}removeSubstitutionCodecIfNeeded(e,t){xw(e,vM(t,"SUBSTITUTION"))}isSubstitutionCodecAdded(e,t){let i=!1;return kw(e,vM(t,"SUBSTITUTION"),(()=>{i=!0})),i}},LP=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(t&&i&&i.enabledLocally&&!i.disabledRemotely){const e=vM(i.codec,"SUBSTITUTION"),n=vM(i.codec,"CODEC");kw(t,e,(e=>{e.rtp.codec=n.codec,e.rtp.rate=n.rate,e.rtp.encoding=n.encoding}))}}},xP=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(!t||!i?.enabledLocally)return;const n=vM(i.codec,"CODEC"),r=vM(i.codec,"SUBSTITUTION");let s=!1;kw(t,n,(e=>{i.enabledForSend&&(e.rtp.codec=r.codec,e.rtp.rate=r.rate,e.rtp.encoding=r.encoding,e.fmtp={payload:n.payload,config:"ptime=20"}),s=!0})),i.disabledRemotely=!s}},UP=class{modify(e){xw(e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),{codec:"CN",rate:16e3})}},FP=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(!t||!i?.enabledLocally||i.disabledRemotely)return;let n=!1;const r={codec:"CN",rate:48e3};if(kw(t,r,(()=>{n=!0})),n)return;const s=Ow(e);-1!==s&&(yM(e,Qe.PAYLOAD_TYPE.MSRTC_CNFB,s),r.payload=Qe.PAYLOAD_TYPE.MSRTC_CNFB,Uw(t,r))}},VP=class{modify(e){xw(e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),{codec:"g722",rate:8e3,encoding:2})}},BP=class{constructor(e){this.configProvider=e}modify(e){const t=this.configProvider.config.enforceOpusFmtp;t&&kw(e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),{codec:"opus",rate:48e3,encoding:2},(e=>{e.fmtp||(e.fmtp={payload:e.rtp.payload});const i=new Mw(e.fmtp.config);Object.keys(t).forEach((e=>{i.removeIfPresent(e),i.setIfMissing(e,`${t[e]}`)})),e.fmtp.config=i.toString()}))}},HP=class{modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio));if(t&&Ww(t)){const i=e.media.find((e=>!!e.iceUfrag));i&&(t.port=9,t.direction="inactive",t.iceUfrag=i.iceUfrag,t.icePwd=i.icePwd,t.rtcpMux="rtcp-mux",i.crypto&&(t.crypto=i.crypto),i.fingerprint&&(t.fingerprint=i.fingerprint,t.setup=i.setup),t.rtp=[{payload:0,codec:"PCMU",rate:8e3}],t.payloads="0")}}},$P=class{constructor(e){this.otherPartyCodecs=e}modify(e){const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=["cn","telephone-event"],n=t.rtp.filter((e=>-1!==this.otherPartyCodecs.indexOf(e.codec.toLowerCase())&&-1===i.indexOf(e.codec.toLowerCase())));if(0===n.length)throw new Error("there is no matching primary audio codec");t.rtp.filter((e=>e!==n[0]&&-1===i.indexOf(e.codec.toLowerCase()))).forEach((e=>{xw(t,e)}))}},GP=class{constructor(e,t){this.configProvider=e,this.logger=t}modify(e){this.configProvider.config.webrtcInjectTransportCCAudio&&fM(e,Qe.MEDIA_TYPE.audio).forEach((e=>{const t=e.ext?.find((e=>e.uri===Qe.TRANSPORT_CC.EXT_URI));if(!t)return void this.logger.safe.info("transport-cc ext not present in sdp, skipping injecting transport-cc attribute for audio");const i=e.rtp?.find((e=>"opus"===e.codec.toLowerCase()));if(!i)return void this.logger.safe.info("opus codec not found, skipping injecting transport-cc attribute for audio");const n=i.payload,r=e.rtcpFb?.find((e=>e.type===Qe.TRANSPORT_CC.ATTRIBUTE&&e.payload===n));r?this.logger.safe.info("opus codec already has transport-cc attribute"):(e.rtcpFb=e.rtcpFb||[],e.rtcpFb.push({payload:n,type:Qe.TRANSPORT_CC.ATTRIBUTE}),this.logger.safe.info("injected transport-cc attribute"))}))}},jP=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){e.media.forEach(((e,t)=>{if(Ww(e)||e.type!==Qe.MEDIA_TYPE.video)return;const i=this.mediaManager.getMediaEntities()[t];kw(e,{codec:"h264",rate:9e4},(e=>{const t=i.getLocalRecvCapabilities();if(!t)return;e.fmtp||(e.fmtp={payload:e.rtp.payload});const n=new Mw(e.fmtp.config);this.configProvider.config.h264SdpProfile?(n.removeIfPresent("profile-level-id"),n.setIfMissing("profile-level-id",this.configProvider.config.h264SdpProfile)):n.setIfMissing("profile-level-id","42C02A"),n.setIfMissing("max-fs",t.getMaxFS().toString()),n.setIfMissing("max-mbps",t.getMaxMBPS().toString()),n.setIfMissing("max-fps",t.getMaxFPS().toString()),e.fmtp.config=n.toString()}))}))}},qP=class{constructor(e){this.configProvider=e}modify(e){if(!this.configProvider.config.multiStreamSupported||this.configProvider.config.numVideoChannelsGvc<this.configProvider.config.nonMultiStreamChannels)return;let t=0;for(let i=0;i<e.media.length;i++)if("video"===e.media[i].type){if(e.media[i].xMultiStream)break;t++}const i=e.media.findIndex((e=>e.xMultiStream)),n=e.media[i];if(!n)return;const r=n.xMultiStream.startSsrc,s=n.xMultiStream.ssrcGroupRange,a=n.xMultiStream.ssrcRange;delete n.xMultiStream;const o=this.configProvider.config.numVideoChannelsGvc-t-1,c=[];for(let t=0;t<o;t++){const o=(0,Kw.cloneDeep)(n);o.mid=Jw(e),o.xSourceStreamId=n.xSourceStreamId,o.subStreamIndex=t,c.push(o.mid);const l=r+t*a;o.ssrcGroups=[{ssrcs:`${l} ${l+s}`,semantics:"FID"}],o.xSsrcRange={ssrcMin:l,ssrcMax:l+a-1},e.media.splice(i+t,0,o)}const l=r+o*a;n.ssrcGroups=[{ssrcs:`${l} ${l+s}`,semantics:"FID"}],n.xSsrcRange={ssrcMin:l,ssrcMax:l+a-1};const d=e.groups.find((e=>e.mids.includes(n.mid)));d.mids=`${d.mids} ${c.join(" ")}`}},WP=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.type=i}modify(e){if(!this.configProvider.config.multiStreamSupported||this.configProvider.config.numVideoChannelsGvc<=this.configProvider.config.nonMultiStreamChannels+1)return;const t=this.mediaManager.getMediaEntitiesByModality(Qe.MODALITY.video);let i=-1,n=-1;if(t.forEach(((t,r)=>{const s=e.media.findIndex((e=>e.mid===t.getMid()));r===this.configProvider.config.nonMultiStreamChannels-1&&(n=s),i=s})),-1===i||-1===n)return;const r=e.media[i];e.media.splice(n+1,i-n-1);const s=this.configProvider.config.numVideoChannelsGvc-this.configProvider.config.nonMultiStreamChannels;r.xMultiStream={numberOfStreams:s,startSsrc:1,ssrcRange:1,ssrcGroupRange:1},"answer"===this.type&&(r.xMultiStream.numberOfStreams=Math.min(s,this.configProvider.mediaConfig.multiStreamChannelsOffered),r.ssrcGroups&&delete r.ssrcGroups,r.xSsrcRange&&delete r.xSsrcRange)}},zP=class{constructor(e){this.configProvider=e}modify(e){fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{kw(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new Mw,i=new Mw(e.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((e=>{if(i.contains(e)){let n=i.get(e);"profile-level-id"===e&&(n=this.configProvider.config.h264SendProfileOverride||n),t.setIfMissing(e,n)}})),e.fmtp.config=t.toString()}}))}))}},JP=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{Nw(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new Mw(e.fmtp.config);t.setIfMissing("sps-pps-idr-in-keyframe","1"),e.fmtp.config=t.toString()}}))}))}},KP=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&fM(e,Qe.MEDIA_TYPE.video).forEach((e=>{Nw(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new Mw(e.fmtp.config);t.removeIfPresent("sps-pps-idr-in-keyframe"),e.fmtp.config=t.toString()}}))}))}},YP=class{constructor(e){this.configProvider=e}modify(e){const t=(e.groups||[]).findIndex((e=>"BUNDLE"===e.type)),i=e.groups?e.groups[t]:void 0;i&&(this.configProvider.mediaConfig.isTransportUnbundled?(i.mids=this.createBundleFromMedia(fM(e,Qe.MEDIA_TYPE.video)),i.mids||e.groups.splice(t,1)):i.mids=this.createBundleFromMedia(fM(e)))}createBundleFromMedia(e){return e.map((e=>e.mid?.toString())).filter((e=>e)).join(" ")}},QP=class{modify(e){e.media.forEach((e=>{Ww(e)&&e.bundleOnly&&(e.port=9,delete e.invalid)}))}},XP=class{constructor(e,t){this.configProvider=e,this.mediaManager=t}modify(e){if(!this.configProvider.mediaConfig.isTransportUnbundled&&!e.groups?.find((e=>"BUNDLE"===e.type))){let t=!1;if(e.media.forEach(((e,i)=>{const n=this.mediaManager.getMediaEntities()[i];!t&&n.isEnabled()?(e.mid=n.getMid(),t=!0):(n.disable(),e.port=0)})),t){e.groups||(e.groups=[]);const t={type:"BUNDLE"};e.groups.push(t)}}}},ZP=class{constructor(e,t){this.configProvider=e,this.logger=t}modify(e){e.media.forEach((e=>{const t=!!e.candidates;if(e.candidates&&(e.candidates=e.candidates.filter((e=>{let t=!0,i=!0,n=!0;return this.configProvider.config.iceCandidateType&&(t=!!e.type.match(new RegExp(this.configProvider.config.iceCandidateType,"i"))),this.configProvider.config.iceCandidateTransport&&(i=!!e.transport.match(new RegExp(this.configProvider.config.iceCandidateTransport,"i"))),this.configProvider.config.iceCandidateFilterMDns&&(n=!this.isMdns(e.ip),n||this.logger.safe.info(`Filtering out mDNS candidate ${we(e.ip)}:${we(e.port)}`)),t&&i&&n}))),t&&e.connection&&this.configProvider.config.iceCandidateFilterMDns&&(e.candidates&&0!==e.candidates.length||(e.candidates=[SM(e.port)]),this.isMdns(e.connection.ip)||!this.hasMatchingCandidate(e))){const t=this.getDefaultCandidate(e);e.connection.ip=t.ip,e.port=t.port}}))}hasMatchingCandidate(e){const t=e.connection;return t&&!!e.candidates.find(this.createIpAndPortMatcher(t.ip,e.port))}getDefaultCandidate(e){return e.candidates.slice().sort(((e,t)=>e.type===t.type?0:"host"===e.type||"relay"===t.type?1:"relay"===e.type||"host"===t.type?-1:0))[0]}isMdns(e){return e.indexOf(".local")>-1||e.indexOf(".encrypted")>-1}createIpAndPortMatcher(e,t){return i=>i.ip===e&&i.port===t}},eM=class{modify(e){const t=fM(e)[0];t&&(t.candidates=[SM()])}},tM=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{this.fromMsSdp(e,t)}))}fromMsSdp(e,t){if(Ww(e)||e.rids&&e.simulcast)return;const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();n?.shouldBeEnabledInRemoteDesc()&&(n.enableInRemoteDesc(),e.simulcast={dir1:"recv",list1:n.ridList.map((e=>`${n.activeRids.includes(e)?"":"~"}${e}`)).join(";")},e.rids=n.ridList.map((e=>({id:e,direction:"recv"}))))}},iM=class{constructor(e,t){this.mediaManager=e,this.logger=t}modify(e){e.media.forEach(((e,t)=>{this.toMsSdp(e,t)}))}toMsSdp(e,t){const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();n&&(n.localDescriptionIsApplied(),n.shouldBeEnabledInLocalDesc()&&(n.enableInLocalDesc(),this.removeSimulcastEnvelope(e),this.addStreamSsrc(e,i.getLocalSsrc())))}removeSimulcastEnvelope(e){e.rids&&delete e.rids,e.simulcast&&delete e.simulcast}addStreamSsrc(e,t){if(!t)return;if(e.ssrcs)return void this.logger.safe.debug(`Media mid: ${e.mid} already contains ssrc: ${JSON.stringify(e.ssrcs)}`);const i=t;this.setSsrc(e,i)}setSsrc(e,t){e.ssrcs=[{id:t,attribute:"fake_attribute",value:"fake_value"}]}},nM=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t],n=i?.getLocalTrackId();(!e.msid&&i?.getSimulcastContext()?.shouldUseSimulcast()&&n||i?.getExtension("reinviteless"))&&(e.msid=`- ${n??"-"}`)}))}},rM=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){const t=this.mediaManager.getMediaEntities(),i=(0,Kw.flatMap)(t,(e=>e.getRtpHeaderExtensions())),n=i.find((e=>"vla"===e?.headerType))?.value,r=i.find((e=>"non-adv-vla"===e?.headerType))?.value,s=n??r??(0,Kw.flatMap)(e.media,(e=>e.ext||[])).find((e=>e.uri===Qe.VLA.EXT_URI))?.value,a=function(e,t,i,n=!1){const r=(0,Kw.flatMap)(e.media,(e=>e.ext||[])).map((e=>e.value));if(0===r.length)return i;const s=2,a=14;if(n&&!r.includes(i))return i;let o;for(let e=s;e<=a;e++)if(!r.includes(e)){o=e;break}return!o&&t&&(o=Math.max(...r)+1),o}(e,this.configProvider.config.extmapAllowMixed,Qe.VLA.DEFAULT_VALUE);e.media.forEach(((e,i)=>{const n=Hw(e);if(!this.configProvider.config.enableVla||"Video"!==n&&"ScreenShare"!==n)return;if(e.ext?.find((e=>e.uri===Qe.VLA.EXT_URI)))return;const r=t[i]?.getRtpHeaderExtensions(),o=r?r.find((e=>"vla"===e.headerType))?.value??r.find((e=>"non-adv-vla"===e.headerType))?.value:s??a;o&&(e.ext=e.ext||[],e.ext.push({value:o,uri:Qe.VLA.EXT_URI}))}))}},sM=class{constructor(e){this.configProvider=e}modify(e){e.media.forEach((e=>{const t=Hw(e);if(this.configProvider.config.allowRemoteVla&&("Video"===t||"ScreenShare"===t))return;const i=e.ext?.findIndex((e=>e.uri===Qe.VLA.EXT_URI));i>-1&&e.ext.splice(i,1)}))}},aM=class{constructor(e){this.configProvider=e}modify(e,t,i){e.media.forEach((e=>{const n=Hw(e);if(!this.configProvider.config.enableNonAdvVla||"Video"!==n&&"ScreenShare"!==n||e.ext?.find((e=>e.uri===i)))return;const r=e.ext?.find((e=>e.uri===t));r&&(r.uri=i)}))}},oM=class extends aM{constructor(e,t){super(e),this.mediaManager=t}modify(e){const t=this.mediaManager.getMediaEntities();(0,Kw.flatMap)(t,(e=>e.getRtpHeaderExtensions())).some((e=>"vla"===e?.headerType))||super.modify(e,Qe.VLA.EXT_URI,Qe.VLA.EXT_URI_NON_ADV)}},cM=class extends aM{constructor(e){super(e)}modify(e){super.modify(e,Qe.VLA.EXT_URI_NON_ADV,Qe.VLA.EXT_URI)}},lM=class{modify(e){e.media.forEach((e=>{e.ext?.forEach((e=>e.uri=this.normalizeSlashesInUri(e.uri)))}))}normalizeSlashesInUri(e){return e.replace(/\\/g,"/")}},dM=class{constructor(e){this.configProvider=e}modify(e){if(this.configProvider.config.fixSdpForPartialIceRestart){const[{iceUfrag:t,icePwd:i}={}]=e.media;void 0!==t&&void 0!==i&&e.media.forEach((e=>{e.iceUfrag=t,e.icePwd=i}))}}},hM=class{constructor(e){this.configProvider=e}modify(e){if(this.configProvider.config.reduceRtcpFbInSdp?.length)for(const t of fM(e,Qe.MEDIA_TYPE.video))t.rtcpFb=t.rtcpFb&&this.getFbList(t.rtcpFb)}getFbList(e){const t=[],i=[];for(const n of e){const e=n.subtype?`${n.type}/${n.subtype}`:`${n.type}`;t.includes(e)||(this.configProvider.config.reduceRtcpFbInSdp.includes(e)?(t.push(e),i.push({...n,payload:"*"})):i.push(n))}return i}},uM=class{constructor(e){this.configProvider=e}modify(e){if(!this.configProvider.config.redReceiveEnabled)return;const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio));let i=0;kw(t,{codec:"opus",rate:48e3,encoding:2},(e=>{i=e.rtp.payload}));const n={codec:"RED",rate:8e3};kw(t,n,(e=>{e.rtp.rate=48e3,e.rtp.encoding=2,i&&(e.fmtp={payload:e.rtp.payload,config:`${i}/${i}`})})),xw(t,n)}},gM=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.redReceiveEnabled&&kw(e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),{codec:"red",rate:48e3,encoding:2},(e=>{e.rtp.codec="RED",e.rtp.rate=8e3,delete e.rtp.encoding}))}},pM=class{constructor(e,t){this.configProvider=e,this.sdpType=t}modify(e){if(!this.configProvider.config.redReceiveEnabled||"offer"!==this.sdpType)return;const t=e.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i={codec:"red",rate:48e3,encoding:2};let n=0;if(kw(t,i,(e=>{n=e.rtp.payload})),n===Qe.PAYLOAD_TYPE.MSRTC_RED)return;const r=Ow(e);-1!==r&&(yM(e,Qe.PAYLOAD_TYPE.MSRTC_RED,r),kw(t,i,(e=>{e.rtp.payload=Qe.PAYLOAD_TYPE.MSRTC_RED})))}};function mM(e,t,i,n){const r={type:e,port:0,label:t,payloads:e===Qe.MEDIA_TYPE.dataChannel||e===Qe.MEDIA_TYPE.data?Qe.PAYLOAD_TYPE.DATA_CHANNEL:"36",protocol:i,connection:{ip:"10.10.10.10",version:4}};return n&&(r.mid=n),r}function fM(e,t=null){return e.media.filter((e=>!(Ww(e)||t&&e.type!==t)))}function SM(e=1234){return{component:1,ip:"10.10.10.10",foundation:1755259772,priority:2122197247,port:9!==e?e:1234,transport:"UDP",type:"host"}}function vM(e,t){if(!Qe.AUDIO_DECODER[e]?.[t])throw`unsupported codec ${e} or type ${t}`;const i=Qe.AUDIO_DECODER[e][t];return{codec:i.NAME,rate:i.RATE,encoding:i.ENCODING,payload:Qe.AUDIO_DECODER[e].PT}}function yM(e,t,i){for(const n of e.media)Dw(n,t,i)}var CM=class e{constructor(e,t,i,n){this.context=e,this.sessionType=t,this.sdp=i,this.remote=n,this.mediaManager=this.context.mediaManager,this.sdpTransform=this.context.sdpTransform,this.logger=this.context.logger.createChild("SessionDescr"),this.sdpModel=Rw.parse(this.sdp),n&&new qP(this.context.configProvider).modify(this.sdpModel),this.sdpModel.media.forEach((e=>{(0,Aw.isUndefined)(e.mid)||(e.mid=e.mid.toString())})),this.remote&&!this.context.configProvider.config.disableMsSdp&&new oP(e,this.mediaManager,t).modify(this.sdpModel)}clone(){return new e(this.context,this.sessionType,this.sdp,this.remote)}getModalities(){return this.modalities||jw(this.sdpModel)}updateModalities(e){this.modalities=e}getSrtpInfo(){return im(this.sdpModel)}getVideoCodecs(){const e={};return this.sdpModel.media.forEach((t=>{"video"===t.type&&t.rtp.map((e=>e.codec.toLowerCase())).forEach((t=>e[t]=!0))})),Object.keys(e)}usePrimaryAudioCodecOnly(e){new $P(e).modify(this.sdpModel)}isCodecSwitchSupported(){return!this.sdpModel.media.some((e=>e.type===Qe.MEDIA_TYPE.audio&&e.xMediaSettings&&this.containsMediaSetting(e.xMediaSettings,"codecswitchunsupported")))}toLocal(){return this.sdpModel=this.sdpTransform.toLocal(this.sdpModel,this.mediaManager,this.sessionType),Rw.write(this.sdpModel)}toOffer(){return this.toOfferAnswer()}toAnswer(){return this.toOfferAnswer()}toOfferAnswer(){const e="offer"===this.sessionType;return new ZP(this.context.configProvider,this.logger).modify(this.sdpModel),(new QP).modify(this.sdpModel),e&&this.mediaManager.isEmpty()&&this.mediaManager.fromOffer(this.sdpModel,this.modalities),this.mediaManager.syncModalities(this.sdpModel,this.modalities,!e),this.sdpModel=e?this.sdpTransform.toOffer(this.sdpModel,this.mediaManager,this.modalities):this.sdpTransform.toAnswer(this.sdpModel,this.mediaManager,this.modalities),this.context.configProvider.config.disableMsSdp||new aP(this.context,this.mediaManager,this.sessionType).modify(this.sdpModel),new jP(this.mediaManager,this.context.configProvider).modify(this.sdpModel),this.modalities=jw(this.sdpModel),Rw.write(this.sdpModel)}toRemote(e){return this.modalities=e,this.mediaManager.fromRemote(this.sdpModel,this.modalities),this.sdpModel=this.sdpTransform.toRemote(this.sdpModel,this.mediaManager,this.modalities,this.sessionType),Rw.write(this.sdpModel)}getVideoRecvCapabilities(){return zw(this.getMediaByLabel(Qe.MEDIA_LABEL.video))}getSharingRecvCapabilities(){return zw(this.getMediaByLabel(Qe.MEDIA_LABEL.sharing))}getMediaByType(e){return this.sdpModel.media.find((t=>t.type===e))}isUnbundled(){const e=this.sdpModel.groups?.find((e=>"BUNDLE"===e.type)),t=this.sdpModel.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),i=this.sdpModel.media.find((e=>e.type===Qe.MEDIA_TYPE.video));return e?!e.mids.toString().split(" ").find((e=>e===t.mid)):!!i}couldBeUnbundled(){return!this.sdpModel.groups?.find((e=>"BUNDLE"===e.type))||this.hasUnbundledIceCandidates()}containsMediaSetting(e,t){return e.some((e=>-1!==e.settings.indexOf(t)))}getMediaByLabel(e){return this.sdpModel.media.find((t=>t.label===e))}hasIceCandidatesForMediaType(e,t=""){const i=this.sdpModel.media?this.sdpModel.media.filter((t=>t.type===e&&!!t.candidates&&0!==t.candidates.length)):[];return t?i.some((e=>!!e.candidates&&e.candidates.some((e=>e.type===t)))):!!i.length}hasIceCandidates(){return this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.audio)||this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.video)}hasRelayIceCandidates(){return this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.audio,"relay")||this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.video,"relay")}hasUnbundledIceCandidates(){const e=this.sdpModel.media.filter((e=>e.type===Qe.MEDIA_TYPE.video&&0!==e.port));return this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.audio)&&(!e.length||this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.video))}hasUnbundledRelayIceCandidates(){const e=this.sdpModel.media.filter((e=>e.type===Qe.MEDIA_TYPE.video&&0!==e.port));return this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.audio,"relay")&&(!e.length||this.hasIceCandidatesForMediaType(Qe.MEDIA_TYPE.video,"relay"))}isIceRestart(){return this.mediaManager.getMediaEntities().some((e=>e.getExtension("iceRestart")))}isMSRTC(){return!!this.sdpModel.xMediaBw}insertFakeCandidateIfNeeded(e,t){this.hasIceCandidates()||(e.setFakeIceCandidate(!0),t&&(t.fakeIceCandidate=!0),(new eM).modify(this.sdpModel))}getBweType(){const e=this.sdpModel.media.find((e=>0!==e.port&&e.type===Qe.MEDIA_TYPE.video));if(!e)return"Unknown";const t=e.ext?.find((e=>e.uri===Qe.TRANSPORT_CC.EXT_URI||e.uri===Qe.TRANSPORT_CC.MSSDP_ENCODED_URI));return t?"SSBWE":"REMB"}fixDataModality(){new uP(this.mediaManager).modify(this.sdpModel)}getPayloadsForMedia(e){const t=this.sdpModel.media.find((t=>t.type===e&&0!==t.port));return t?.rtp??[]}},_M=class{constructor(e){this.context=e}createLocalOffer(e){return new CM(this.context,"offer",e)}createRemoteOffer(e){return new CM(this.context,"offer",e,!0)}createLocalAnswer(e){return new CM(this.context,"answer",e)}createRemoteAnswer(e){return new CM(this.context,"answer",e,!0)}},EM=class{static build(e){return new _M(e=e||{})}};function TM(e){let t="";return e.dtls&&(t+="dtls"),e.sdes&&(t+="sdes"),t}var IM=class{constructor(){this.info={OfferedSrtp:"none",NegotiatedSrtp:"none",IceConnectionState:"none",IceConnectionStatePrevious:"none",SignalingState:"none",SignalingStatePrevious:"none",RelayCandidate:"none",IceTransportPolicy:"none",IceServers:"none",FakeIceCandidate:!1,BweType:"none",SdpSemantics:"none",BundlePolicy:"none",IPAddress:"none",ReflexiveLocalIP:"none",NumberOfInterfaces:0,EncodedStreamWorker:!1,AudioCodecEvents:"none"}}setCandidateDetails(e){"host"===e.type&&"udp"===e.protocol?this.setIPAddressInfo(e.ip):"srflx"===e.type&&this.setReflexiveLocalIP(e.ip)}setOfferedModalities(e){this.offeredModalities=e,this.activeModalities=e}setNegotiatedModalities(e){this.negotiatedModalities=e,this.activeModalities=e}setNegotiatedSrtpInfo(e){this.info.NegotiatedSrtp=TM(e)}setOfferedSrtpInfo(e){this.info.OfferedSrtp=TM(e)}setIceConnectionState(e){this.info.IceConnectionStatePrevious=this.info.IceConnectionState,this.info.IceConnectionState=e}setSignalingConnectionState(e){this.info.SignalingStatePrevious=this.info.SignalingState,this.info.SignalingState=e}setRelayCandidateInfo(e){this.info.RelayCandidate=JSON.stringify(e)}fillExtensionInfo(e){!function(e,t){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i])}(e,this.info)}setIceTransportPolicy(e){this.info.IceTransportPolicy=e}setIceServers(e){const t=e.map((e=>{const t={...e};return t.username&&(t.username="true"),t.credential&&(t.credential="true"),t}));this.info.IceServers=JSON.stringify(t)}setFakeIceCandidate(e){this.info.FakeIceCandidate=e}setBweType(e){"Unknown"!==e&&(this.info.BweType=e)}setSdpSemantics(e){this.info.SdpSemantics=e}setBundlePolicy(e){this.info.BundlePolicy=e}setEncodedStreamWorkerLoaded(e){this.info.EncodedStreamWorker=e}setAudiocCodecEvents(e){this.info.AudioCodecEvents=JSON.stringify(e)}setCreateChannelFailReason(e){this.info.CreateChannelFailReason=Ve(e)}setIPAddressInfo(e){this.info.NumberOfInterfaces+=1,"none"===this.info.IPAddress&&(this.info.IPAddress=e)}setReflexiveLocalIP(e){"none"===this.info.ReflexiveLocalIP&&(this.info.ReflexiveLocalIP=e)}},bM=class{constructor(e){this.audioContext=new Vp.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(e),this.analyzerNode=this.createAnalyserNode(this.sourceNode)}dispose(){this.sourceNode.disconnect(),this.audioContext.close(),this.audioContext=null,this.sourceNode=null,this.analyzerNode=null}getInputLevel(){if(!this.analyzerNode)return 0;const e=new Uint8Array(this.analyzerNode.frequencyBinCount);return this.analyzerNode.getByteFrequencyData(e),Math.floor(65535*function(e){return 0===e.length?0:e.reduce(((e,t)=>e+t),0)/e.length}(e)/255)}createAnalyserNode(e){const t=this.audioContext.createAnalyser();return t.fftSize=1024,t.smoothingTimeConstant=.1,e.connect(t),t}},AM=class e{constructor(e){this.name=e,this.sharedState={mark:new Map,measure:[]}}mark(e,t){const i=Pt();this.sharedState.mark.set(e,{name:e,ts:i,startTime:Ct(Mt+i),details:t})}measure(e,t){const i=this.sharedState.mark.get(t.start),n=this.sharedState.mark.get(t.end);if(i&&n){const r={...t,parentName:this.name===e?"":this.name};this.sharedState.measure.push({name:e,details:r,duration:Ct(n.ts-i.ts),startTime:i.startTime})}}markAndMeasure(e,t,i,n){!1===this.sharedState.mark.has(t)&&this.mark(t,i);const r=this.sharedState.mark.get(e),s=this.sharedState.mark.get(t);if(r&&s){const e={...n,parentName:this.name===t?"":this.name};this.sharedState.measure.push({name:t,details:e,duration:Ct(s.ts-r.ts),startTime:r.startTime})}}clone(t){const i=new e(`${this.name}|${t}`);return i.setSharedState(this.sharedState),i}setSharedState(e){this.sharedState=e}getReport(){return this.sharedState.measure.map((e=>({name:e.name,duration:e.duration,ts:e.startTime,parentName:e.details.parentName})))}},RM=class e{mark(){}measure(){}markAndMeasure(){}clone(){return new e}getReport(){return[]}},wM=class{constructor(e){this.enableTimerTracker=e,this.timerTrackers={},this.timerTrackerOptions={}}getTimerTracker(e,t){if(!this.enableTimerTracker)return new RM;const i=new AM(e);if(this.timerTrackers[e]){const t=this.timerTrackerOptions[e];if(t?.first)return new RM;t?.last&&(this.timerTrackers[e]=[i]),t?.all&&this.timerTrackers[e].push(i)}else this.timerTrackers[e]=[i],this.timerTrackerOptions[e]=t;return i}getReport(){if(this.enableTimerTracker)return Object.keys(this.timerTrackers).reduce(((e,t)=>{const i=this.timerTrackerOptions[t];return(i.first||i.last)&&(e[t]=[this.timerTrackers[t][0]?.getReport()]),i.all&&(e[t]=Object.values(this.timerTrackers[t]).map((e=>e?.getReport()))),e}),{})}},PM=class{constructor(){this.presentationAPIUserDuration=0,this.presentationAudioDuration=0,this.isActiveScreenSharing=!1}handleInputLevel(e,t){this.isActiveScreenSharing&&("ScreenShare"===e&&t>0&&(this.presentationAPIUserDuration+=Qe.TIME_INTERVAL.SEC_1),"Audio"===e&&t>0&&(this.presentationAudioDuration+=Qe.TIME_INTERVAL.SEC_1))}updateScreenSharingStream(e,t){"ScreenShare"===t&&(this.isActiveScreenSharing=!!e)}getPresentationAudioDuration(){return this.presentationAudioDuration}getPresentationAudioAPIUserDuration(){return this.presentationAPIUserDuration}},MM=/profile-level-id=(.{6})/,DM=class{constructor(e,t,i=(()=>{}),n=(()=>this),r=(()=>{}),s=new _w,a){this.configProvider=e,this.dmDiagnostics=t,this.addSessionStatsError=i,this.newNativeSession=n,this.commitNativeSession=r,this.dshDiagnostics=s,this.getSessionRef=a,this.data={startTime:Date.now(),duration:0,offeredSrtp:"unknown",negotiatedSrtp:"unknown",iceConnectionState:"none",iceConnectionStatePrevious:"none",signalingState:"none",signalingStatePrevious:"none",relayCandidate:"none",iceTransportPolicy:"none",iceServers:"none",fakeIceCandidate:!1,bweType:"Unknown",sdpSemantics:"none",bundlePolicy:"none",iceCandidateErrors:[],H264Profiles:[],numInterfaces:0,statsReports:[],aggregatedModalityStats:{},multiViewStats:[],networkInfo:[],statsErrors:[],statsOnSubscribed:{},recvVideoStreamCount:{min:0,max:0,mode:0},reportedReceiveBandwidth:[],encodedStreamWorker:!1,audioCodecEvents:"none",totalVideoRecvMblocksRates:{macroblockRateReceivedMax:0,macroblockRateReceivedAvg:0,macroblockRateDecodedMax:0,macroblockRateDecodedAvg:0,macroblockRateMaxDecoderLossPercent:0,macroblockRateDecoderLossPercent:0},timerTrackerReport:{},loopIntervalMax:-1,loopIntervalMedian:-1,fetchTimeMax:-1,fetchTimeMedian:-1,videoPerformanceEvent:[],ovcToSubscriptionEvents:[],presentationAPIUserDuration:0,presentationAudioDuration:0,earlyMediaNumStatsPolls:0},this.timerTracker=new wM(this.configProvider.config.enableTimerTracker),this.presentationAudioTelemetry=new PM,It(this.data,{duration:()=>this.data.endTime?this.data.endTime-this.data.startTime:Date.now()-this.data.startTime,bandwidthReport:()=>this.bandwidthStatsRef?.getBandwidthReport(),timerTrackerReport:()=>this.timerTracker.getReport(),presentationAPIUserDuration:()=>this.presentationAudioTelemetry.getPresentationAudioAPIUserDuration(),presentationAudioDuration:()=>this.presentationAudioTelemetry.getPresentationAudioDuration()}),Object.defineProperty(this.data,"IPAddress",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.data,"reflexiveLocalIP",{enumerable:!1,writable:!0,configurable:!0})}getTimerTracker(e,t){return this.timerTracker.getTimerTracker(e,t)}get deviceManager(){return this.dmDiagnostics}get audioLevel(){return this.analyzer?.getInputLevel()}get reflexiveLocalIP(){return this.data.reflexiveLocalIP}set bandwidthDiagnostic(e){this.bandwidthStatsRef=e}get callIsMuted(){return this.getSessionRef?.().callIsMuted}get sharingAudioLevel(){return this.analyzerSharing?.getInputLevel()}set offeredModalities(e){this.data.offeredModalities=e,this.data.activeModalities=e}set negotiatedModalities(e){this.data.negotiatedModalities=e,this.data.activeModalities=e}set offeredSrtp(e){this.data.offeredSrtp=OM(e)}set negotiatedSrtp(e){this.data.negotiatedSrtp=OM(e)}set iceConnectionState(e){this.data.iceConnectionStatePrevious=this.data.iceConnectionState,this.data.iceConnectionState=e}set signalingConnectionState(e){this.data.signalingStatePrevious=this.data.signalingState,this.data.signalingState=e}set relayCandidateInfo(e){this.data.relayCandidate=JSON.stringify(e)}set iceTransportPolicy(e){this.data.iceTransportPolicy=e}set iceServers(e){const t=e.map((e=>{const t={...e};return t.username&&(t.username="true"),t.credential&&(t.credential="true"),t}));this.data.iceServers=JSON.stringify(t)}set fakeIceCandidate(e){this.data.fakeIceCandidate=e}set bweType(e){this.data.bweType=e}set sdpSemantics(e){this.data.sdpSemantics=e}set isCodecsSupported(e){this.data.codecSupport=e}set bundlePolicy(e){this.data.bundlePolicy=e}set latestRawReport(e){this.data.latestRawReport=e}set recvVideoStreamsCount(e){this.data.recvVideoStreamCount=e}set aggregatedStatsRef(e){this.data.aggregatedModalityStats=e}set multiViewStats(e){this.data.multiViewStats=e}set videoCapabilities(e){if(!e?.codecs)return;const t=[];e.codecs.forEach((e=>{if("h264"===e.mimeType&&e.sdpFmtpLine){const i=MM.exec(e.sdpFmtpLine)?.[1];i&&t.push(i)}})),this.data.H264Profiles=[...new Set(this.data.H264Profiles.concat(t))]}set sentBWSeed(e){var t;(t=this.data).initialBWSeed??(t.initialBWSeed=e),this.data.sentBWSeed=e}set reportedSendBandwidth(e){this.data.reportedSendBandwidth=e,(!this.data.reportedSendBandwidthMin||this.data.reportedSendBandwidthMin>e)&&(this.data.reportedSendBandwidthMin=e),(!this.data.reportedSendBandwidthMax||this.data.reportedSendBandwidthMax<e)&&(this.data.reportedSendBandwidthMax=e)}set maxSessionBandwidth(e){this.data.maxSessionBandwidth=e}set bwStabiliationTime(e){this.data.bwStabilizationTime=e}set bwDownlinkStabiliationTime(e){this.data.bwDownlinkStabilizationTime=e}set statsOnSubscribed(e){this.data.statsOnSubscribed=e}set loopIntervalMax(e){this.data.loopIntervalMax=e}set loopIntervalMedian(e){this.data.loopIntervalMedian=e}set fetchTimeMax(e){this.data.fetchTimeMax=e}set fetchTimeMedian(e){this.data.fetchTimeMedian=e}setTotalVideoRecvMblocksRates(e){this.data.totalVideoRecvMblocksRates=e}setCandidateDetails(e){"host"===e.type&&"udp"===e.protocol?(this.data.numInterfaces++,this.data.IPAddress||(this.data.IPAddress=e.ip)):"srflx"!==e.type||this.data.reflexiveLocalIP||(this.data.reflexiveLocalIP=e.ip)}setAudioSendStream(e,t){if(this.configProvider.config.useAudioAnalyzer){const i=new bM(e.rawStream);"ScreenShare"===t&&e.hasAudio()?(this.analyzerSharing?.dispose(),this.analyzerSharing=i):"Audio"===t&&(this.analyzer?.dispose(),this.analyzer=i)}}addNetworkInfo(e){Tt(this.data.networkInfo,e,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addIceCandidateError(e){this.data.iceCandidateErrors.push(e)}clearIceCandidateErrors(){this.data.iceCandidateErrors=[]}registerEarlyMediaPoll(){this.data.earlyMediaNumStatsPolls++}addReportedReceiveBandwidth(e){Tt(this.data.reportedReceiveBandwidth,e,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addOvcSubscriptionReport(e,t,i){const n=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];n?.ovc.count!==e&&Tt(this.data.ovcToSubscriptionEvents,{ovc:{ts:Date.now(),count:e,subsCount:t,...i},subs:[]},this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addSubscriptionToOvcEvent(e){const t=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];t&&t.subs.push({ts:Date.now(),count:e})}addStatsReport(e){Tt(this.data.statsReports,e,this.configProvider.config.diagnostics.collectionLimits.numStatsReports)}addStatsError(e,t){const i=this.data.statsErrors.find((i=>i.error===t&&i.origin===e));i?i.count++:Tt(this.data.statsErrors,{origin:e,error:t,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors),this.addSessionStatsError(`nativeSession:${e}`,t)}setPresentationAudioOnScreenSharing(e,t){this.presentationAudioTelemetry.updateScreenSharingStream(e,t)}handlePresentationAudioInputLevel(){this.presentationAudioTelemetry.handleInputLevel("Audio",this.audioLevel),this.presentationAudioTelemetry.handleInputLevel("ScreenShare",this.sharingAudioLevel)}terminate(){this.data.endTime=Date.now(),this.analyzer?.dispose(),this.analyzer=null,this.analyzerSharing?.dispose(),this.analyzerSharing=null}newQualityManagerDiagnostics(){const e=new Tw(this.configProvider,((e,t)=>this.addStatsError(`qualityManagerDiagnostics:${e}`,t)));return this.data.qualityManager=e.getObjectRef(),e}newRemoteVideoManagerDiagnostics(){const e=new Iw(this.configProvider);return this.data.remoteVideoManager=e.getObjectRef(),e}newSubscriptionManagerDiagnostics(){const e=new Ew(this.configProvider,(e=>this.addStatsError("subscriptionManagerDiagnostics",e)));return this.data.subscriptionManager=e.getObjectRef(),e}set encodedStreamWorker(e){this.data.encodedStreamWorker=e}set audioCodecEvents(e){this.data.audioCodecEvents=e}getObjectRef(){return this.data}registerVideoPerformanceEvent(e,t){const i={type:t,perfEvent:e,resRequestEvent:null,resChangedEvent:[]};this.data.videoPerformanceEvent=this.data.videoPerformanceEvent.concat(i)}registerResolutionChanageRequest(e){const t=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];t&&(t.resRequestEvent=e)}registerResolutionChanageEvent(e){const t=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];e.ts-t?.resRequestEvent.ts<this.configProvider.config.diagnostics.performanceMonitoring.telemetryResolutionRequestSpanMs&&t.resChangedEvent.push(e)}};function OM(e){let t="";return e.dtls&&(t+="dtls"),e.sdes&&(t+="sdes"),t}var kM=Symbol("sessionDiagnosticsRef"),NM=class{constructor(e,t,i,n,r,s){this.logger=e,this.configProvider=t,this.diagnosticsReport=i,this.dmDiagnostics=n,this.dshDiagnostics=new _w,this.data={creationTime:Date.now(),callNumber:0,sessionId:"unknown",isMultiParty:!1,dtmfSuccessCount:0,dtmfFailureCount:0,iceInitTime:0,iceConnectedStateTime:0,negotiationCount:0,rejectedNegotiationCount:0,initialNegotiationCompleted:!1,finalAnswerTime:0,transportReconnectedCount:0,rollbackNegotiation:[],activeModalities:{},allowedAudioSend:!0,allowedVideoSend:!0,allowedScreensharingSend:!0,noIceCandidatesEventCount:{good:0,bad:0},noRelayIceCandidatesEventCount:{good:0,bad:0},microphoneInUseEventCount:{good:0,bad:0},cameraInUseEventCount:{good:0,bad:0},cameraFreezeEventCount:{start:0,end:0},rawMedia:{audio:{recv:{numAttempts:0,durationRatio:0},send:{numAttempts:0,durationRatio:0}}},ufds:[],statsErrors:[],webrtcSessions:[],isOngoing:!1,duration:0,callMutedRatio:0,callOsMuted:0,callHwSilent:0,callSwMuted:0,callIsMuted:!1,callSpeakerMuted:0,callIsSpeaking:0,networkRecvUFD:void 0,networkSendUFD:void 0,deviceManager:void 0,relayTimers:void 0,authTokenFetcherStats:void 0,dominantSpeaker:this.dshDiagnostics.getObjectRef(),[kM]:this},this.transportDisconnected=!1,this.commonMuteTracker=new xM,this.swMuteTracker=new xM,this.osMuteTracker=new xM,this.speakerMuteTracker=new xM,this.hwSilentTracker=new xM,this.isSpeakingTracker=new xM,this.networkRecv=new UM,this.networkSend=new UM,this.rawMediaTimers={audio:{send:new xM,recv:new xM}},this.dmFragmenter=new LM(this.dmDiagnostics),this.durationTimer=new xM,this.data.callNumber=r,this.data.sessionId=s,this.durationTimer.start(),It(this.data,{isOngoing:()=>void 0===this.data.terminationTime,duration:()=>this.durationTimer.elapsed,callMutedRatio:()=>FM(this.commonMuteTracker.elapsed,this.data.duration),callOsMuted:()=>this.osMuteTracker.elapsed,callHwSilent:()=>this.hwSilentTracker.elapsed,callSwMuted:()=>this.swMuteTracker.elapsed,callIsMuted:()=>this.swMuteTracker.isRunning,callSpeakerMuted:()=>this.speakerMuteTracker.elapsed,callIsSpeaking:()=>this.isSpeakingTracker.elapsed,networkRecvUFD:()=>({good:this.networkRecv.getCount("Good"),poor:this.networkRecv.getCount("Poor"),bad:this.networkRecv.getCount("Bad"),goodRatio:FM(this.networkRecv.getElapsed("Good"),this.data.duration),poorRatio:FM(this.networkRecv.getElapsed("Poor"),this.data.duration),badRatio:FM(this.networkRecv.getElapsed("Bad"),this.data.duration)}),networkSendUFD:()=>({good:this.networkSend.getCount("Good"),poor:this.networkSend.getCount("Poor"),bad:this.networkSend.getCount("Bad"),goodRatio:FM(this.networkSend.getElapsed("Good"),this.data.duration),poorRatio:FM(this.networkSend.getElapsed("Poor"),this.data.duration),badRatio:FM(this.networkSend.getElapsed("Bad"),this.data.duration)}),deviceManager:()=>this.dmFragmenter.getFragment(this.dmDiagnostics),relayTimers:()=>this._relayManager?.getStats(),authTokenFetcherStats:()=>this._relayManager?.getAuthTokenStats()}),It(this.data.rawMedia.audio.recv,{durationRatio:()=>FM(this.rawMediaTimers.audio.recv.elapsed,this.data.duration)}),It(this.data.rawMedia.audio.send,{durationRatio:()=>FM(this.rawMediaTimers.audio.send.elapsed,this.data.duration)})}get telemetryReport(){const e={type:"WebRtcMediaStats",data:this.diagnosticsReport.getSessionTelemetry(this.data.sessionId)},t={};return Ze(e.data,((e,i,n)=>{let r=0;Hp.test(e)?(r=13,t[i]="IPv4"):$p.test(e)&&(r=4,t[i]="IPv6"),n[i]={type:r,value:e,__VALUE__:!0}})),e.data.metrics.piiFields={type:0,value:JSON.stringify(t),__VALUE__:!0},e}get mediaStatsReport(){return this.diagnosticsReport.getMediaSessionStats(this.data.sessionId)}get realtimeTelemetryReport(){return this.diagnosticsReport.getTeamsRealtimeTelemetry(this.data.sessionId)}get e2eDiagnostics(){return this.diagnosticsReport.getDiagnosticsForE2eTests(this.data.sessionId)}set relayManager(e){this._relayManager=e}set isMultiParty(e){this.data.isMultiParty=e}set mediaLegId(e){this.data.mediaLegId=e.process()}set ETag(e){this.data.ETag=e}set configIds(e){this.data.configIds=e}set reconnect(e){this.data.reconnect=e}set relay(e){this.data.relay={address:e.addresses.join(),expires:e.expires,realm:e.realm,credentials:!(!e.username||!e.password),ports:[e.udpPort?`udp:${e.udpPort}`:"",e.tcpPort?`tcp:${e.tcpPort}`:"",e.tlsPort?`tls:${e.tlsPort}`:""].join(","),fqdns:e.fqdns?e.fqdns.join():"none"}}set sessionError(e){this.data.error=e}set dtmfResult(e){e?this.data.dtmfSuccessCount++:this.data.dtmfFailureCount++}set swMute(e){e?this.swMuteTracker.start():this.swMuteTracker.stop(),this.updateCommonMute()}set speakerMute(e){e?this.speakerMuteTracker.start():this.speakerMuteTracker.stop()}set hwSilent(e){e?this.hwSilentTracker.start():this.hwSilentTracker.stop()}set isSpeaking(e){e?this.isSpeakingTracker.start():this.isSpeakingTracker.stop()}set iceInitTime(e){this.data.iceInitTime||(this.data.iceInitTime=e)}set finalAnswerTime(e){var t;(t=this.data).finalAnswerTime??(t.finalAnswerTime=e)}set iceConnectedStateTimestamp(e){this.data.iceConnectedStateTime||(this.data.iceConnectedStateTime=e)}set allowedModalities(e){this.data.allowedAudioSend=e.audio.some((e=>zp(e))),this.data.allowedVideoSend=e.video.some((e=>zp(e))),this.data.allowedScreensharingSend=e.sharing.some((e=>zp(e)))}negotiationStart(e){var t;(t=this.data).initialNegotiationType??(t.initialNegotiationType=e),this.data.negotiationCount++}negotiationCompleted(e){this.data.initialNegotiationCompleted=!0,this.data.activeModalities=e,this.data.error=void 0}negotiationRejected(){this.data.rejectedNegotiationCount++}registerRollbackEvent(e){this.data.rollbackNegotiation.push({type:e.type,attempt:this.data.rollbackNegotiation.length+1,error:e.error})}registerRawMediaAccess(e,t,i){const n=this.data.rawMedia[e]?.[t];if(n){n.numAttempts++;const r=this.rawMediaTimers[e]?.[t];i?r?.start():r?.stop()}}registerQualityStateChangedEvent(e){switch(e.type){case"NoNetwork":"Good"===e.value?this.data.noIceCandidatesEventCount.good++:this.data.noIceCandidatesEventCount.bad++;break;case"NetworkRelaysNotReachable":"Good"===e.value?this.data.noRelayIceCandidatesEventCount.good++:this.data.noRelayIceCandidatesEventCount.bad++;break;case"DeviceCaptureNotFunctioning":"Good"===e.value?this.data.microphoneInUseEventCount.good++:this.data.microphoneInUseEventCount.bad++;break;case"VideoCapturerDeviceStartFailed":"Good"===e.value?this.data.cameraInUseEventCount.good++:this.data.cameraInUseEventCount.bad++;break;case"DeviceCaptureMute":"Bad"===e.value?this.osMuteTracker.start():this.osMuteTracker.stop(),this.updateCommonMute();break;case"NetworkRecvQuality":this.networkRecv.updateLevel(e.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(e.value);break;case"VideoCaptureDeviceFreeze":"Good"===e.value?this.data.cameraFreezeEventCount.end++:this.data.cameraFreezeEventCount.start++}"DeviceSpeakWhileMuted"!==e.type&&Tt(this.data.ufds,{...e,timestamp:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numUFDs)}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.data.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}terminated(e){this.data.terminationReason=ct(e),this.data.terminationTime=Date.now(),this.durationTimer.stop(),this.swMuteTracker.stop(),this.speakerMuteTracker.stop(),this.hwSilentTracker.stop(),this.isSpeakingTracker.stop(),this.dmFragmenter.terminated(this.dmDiagnostics)}addStatsError(e,t){const i=this.data.statsErrors.find((i=>i.error===t&&i.origin===e));this.logger.safe.error(`Stats error from '${e}': ${t} (${i?.count??1})`),i?i.count++:Tt(this.data.statsErrors,{origin:e,error:t,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors)}newNativeSessionDiag(e=!0){let t;return t=new DM(this.configProvider,this.dmDiagnostics,((e,t)=>this.addStatsError(e,t)),(e=>this.newNativeSessionDiag(e)),(()=>this.pushNativeSessionDiag(t.getObjectRef())),this.dshDiagnostics.resetState(),(()=>this.getObjectRef())),e&&Tt(this.data.webrtcSessions,t.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numNativeSessions),t}pushNativeSessionDiag(e){Tt(this.data.webrtcSessions,e,this.configProvider.config.diagnostics.collectionLimits.numNativeSessions)}getObjectRef(){return this.data}updateCommonMute(){this.swMuteTracker.isRunning||this.osMuteTracker.isRunning?this.commonMuteTracker.start():this.swMuteTracker.isRunning||this.osMuteTracker.isRunning||this.commonMuteTracker.stop()}},LM=class{constructor(e){this.fragmentBase=this.sanitizeDiagnostics(e)}getFragment(e){const t=this.fragmentTerminated??e;return{devicesChangeCount:t.devicesChangeCount-this.fragmentBase.devicesChangeCount,deviceSelectionChangeCount:t.deviceSelectionChangeCount-this.fragmentBase.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:t.deviceSelectionChangeCountFromInterface-this.fragmentBase.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:t.devicesPollChangeCount-this.fragmentBase.devicesPollChangeCount}}terminated(e){this.fragmentTerminated=this.sanitizeDiagnostics(e)}sanitizeDiagnostics(e){return{devicesChangeCount:e.devicesChangeCount,deviceSelectionChangeCount:e.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:e.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:e.devicesPollChangeCount}}},xM=class{constructor(){this.startTime=0,this.elapsedInternal=0,this.countInternal=0}get isRunning(){return!!this.startTime}get elapsed(){return Math.round(this.startTime?this.elapsedInternal+Pt()-this.startTime:this.elapsedInternal)}get count(){return this.countInternal}start(){this.startTime||(this.startTime=Pt(),this.countInternal++)}stop(){this.startTime&&(this.elapsedInternal+=Pt()-this.startTime,this.startTime=0)}},UM=class{constructor(){this.currentLevel="Good",this.stopWatches={},this.getStopWatch(this.currentLevel).start()}updateLevel(e){this.currentLevel!==e&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=e,this.getStopWatch(this.currentLevel).start())}getCount(e){const t=this.stopWatches[e];return t?t.count:0}getElapsed(e){const t=this.stopWatches[e];return t?t.elapsed:0}getStopWatch(e){let t=this.stopWatches[e];return t||(t=new xM,this.stopWatches[e]=t),t}};function FM(e,t){return e/(0!==t?t:1)}function VM(e,t,i){return lt({recv:lt({id:t?.inboundRTP.id,ssrc:t?.inboundRTP.ssrc,mediaType:t?.inboundRTP.mediaType??t?.inboundRTP.kind,bytesReceived:kt(e.audio?.recv,(e=>e.inboundRTP.bytesReceived)),packetsReceived:kt(e.audio?.recv,(e=>e.inboundRTP.packetsReceived)),packetsLost:kt(e.audio?.recv,(e=>e.inboundRTP.packetsLost)),googCodecName:t?.codec?.mimeType.split("/")[1],googTrackId:t?.track?.trackIdentifier,transport_id:t?.transport?.id,transportId:t?.inboundRTP.transportId,transport_selectedCandidatePairId:t?.transport?.selectedCandidatePairId,transport_dtlsCipher:t?.transport?.dtlsCipher,transport_srtpCipher:t?.transport?.srtpCipher,pair_id:t?.transport?.selectedCandidatePair?.id,pair_responsesSent:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:t?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:t?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:t?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:t?.transport?.selectedCandidatePair?.writable,pair_requestsSent:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:kt(e.audio?.recv,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:t?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:t?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:t?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:t?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:t?.transport?.selectedCandidatePair?.localCandidate?.ip??t?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:t?.transport?.selectedCandidatePair?.remoteCandidate?.ip??t?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:kt(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:t?.transport?.selectedCandidatePair?.nominated}),send:lt({id:i?.outboundRTP.id,ssrc:i?.outboundRTP.ssrc,mediaType:i?.outboundRTP.mediaType??i?.outboundRTP.kind,bytesSent:kt(e.audio?.send,(e=>e.outboundRTP.bytesSent)),packetsSent:kt(e.audio?.send,(e=>e.outboundRTP.packetsSent)),packetsLost:kt(e.audio?.send,(e=>e.remoteInboundRTP?.packetsLost)),googCodecName:i?.codec?.mimeType.split("/")[1],googTrackId:i?.track?.trackIdentifier,transport_id:i?.transport?.id,transportId:i?.outboundRTP.transportId,transport_selectedCandidatePairId:i?.transport?.selectedCandidatePairId,transport_dtlsCipher:i?.transport?.dtlsCipher,transport_srtpCipher:i?.transport?.srtpCipher,pair_id:i?.transport?.selectedCandidatePair?.id,pair_responsesSent:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:i?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:i?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:i?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:i?.transport?.selectedCandidatePair?.writable,pair_requestsSent:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:kt(e.audio?.send,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:i?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:i?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:i?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:i?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:i?.transport?.selectedCandidatePair?.localCandidate?.ip??i?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:i?.transport?.selectedCandidatePair?.remoteCandidate?.ip??i?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:kt(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:i?.transport?.selectedCandidatePair?.nominated})})}function BM(e,t,i,n){return lt({recv:lt({id:i?.inboundRTP.id,ssrc:i?.inboundRTP.ssrc,mediaType:i?.inboundRTP.mediaType??i?.inboundRTP.kind,bytesReceived:kt(t[e]?.recv,(e=>e.inboundRTP.bytesReceived)),packetsReceived:kt(t[e]?.recv,(e=>e.inboundRTP.packetsReceived)),packetsLost:kt(t[e]?.recv,(e=>e.inboundRTP.packetsLost)),googCodecName:i?.codec?.mimeType.split("/")[1],codecImplementationName:i?.inboundRTP.decoderImplementation,googTrackId:i?.track?.trackIdentifier,transport_id:i?.transport?.id,transportId:i?.inboundRTP.transportId,transport_selectedCandidatePairId:i?.transport?.selectedCandidatePairId,transport_dtlsCipher:i?.transport?.dtlsCipher,transport_srtpCipher:i?.transport?.srtpCipher,pair_id:i?.transport?.selectedCandidatePair?.id,pair_responsesSent:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:i?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:i?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:i?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:i?.transport?.selectedCandidatePair?.writable,pair_requestsSent:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:kt(t[e]?.recv,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:i?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:i?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:i?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:i?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:i?.transport?.selectedCandidatePair?.localCandidate?.ip??i?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:i?.transport?.selectedCandidatePair?.remoteCandidate?.ip??i?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:kt(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:i?.transport?.selectedCandidatePair?.nominated,framesDecoded:kt(t[e]?.recv,(e=>e.inboundRTP.framesDecoded)),googFrameHeightReceived:kt(t[e]?.recv,(e=>e.inboundRTP.frameHeight)),googFrameWidthReceived:kt(t[e]?.recv,(e=>e.inboundRTP.frameWidth)),googFrameRateReceived:kt(t[e]?.recv,(e=>e.extensions?.frameRateReceived||0)),googNacksSent:kt(t[e]?.recv,(e=>e.inboundRTP.nackCount)),googPlisSent:kt(t[e]?.recv,(e=>e.inboundRTP.pliCount)),keyFramesDecoded:kt(t[e]?.recv,(e=>e.inboundRTP.keyFramesDecoded)),googFirsSent:kt(t[e]?.recv,(e=>e.inboundRTP.firCount)),googJitterBufferMs:kt(t[e]?.recv,(e=>e.extensions?.jitterBufferMs)),googFrameRateDecoded:kt(t[e]?.recv,(e=>e.extensions?.frameRateDecoded||0)),googFrameRateOutput:i?.extensions?.trackRecvFps,jitter:i?.inboundRTP.jitter}),send:lt({id:n?.outboundRTP.id,ssrc:n?.outboundRTP.ssrc,mediaType:n?.outboundRTP.mediaType??n?.outboundRTP.kind,bytesSent:kt(t[e]?.send,(e=>e.outboundRTP.bytesSent)),packetsSent:kt(t[e]?.send,(e=>e.outboundRTP.packetsSent)),packetsLost:kt(t[e]?.send,(e=>e.remoteInboundRTP?.packetsLost)),googCodecName:n?.codec?.mimeType.split("/")[1],codecImplementationName:n?.outboundRTP.encoderImplementation,googTrackId:n?.track?.trackIdentifier,transport_id:n?.transport?.id,transportId:n?.outboundRTP.transportId,transport_selectedCandidatePairId:n?.transport?.selectedCandidatePairId,transport_dtlsCipher:n?.transport?.dtlsCipher,transport_srtpCipher:n?.transport?.srtpCipher,pair_id:n?.transport?.selectedCandidatePair?.id,pair_responsesSent:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:n?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:n?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:n?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:n?.transport?.selectedCandidatePair?.writable,pair_requestsSent:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:kt(t[e]?.send,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:n?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:n?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:n?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:n?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:n?.transport?.selectedCandidatePair?.localCandidate?.ip??n?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:n?.transport?.selectedCandidatePair?.remoteCandidate?.ip??n?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:kt(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:n?.transport?.selectedCandidatePair?.nominated,framesEncoded:kt(t[e]?.send,(e=>e.outboundRTP.framesEncoded)),googNacksReceived:kt(t[e]?.send,(e=>e.outboundRTP.nackCount)),googPlisReceived:kt(t[e]?.send,(e=>e.outboundRTP.pliCount)),googFirsReceived:kt(t[e]?.send,(e=>e.outboundRTP.firCount)),keyFramesEncoded:kt(t[e]?.send,(e=>e.outboundRTP.keyFramesEncoded)),googFrameHeightInput:n?.mediaSource?.height,googFrameWidthInput:n?.mediaSource?.width,googFrameRateInput:kt(t[e]?.send,(e=>e.mediaSource?.framesPerSecond)),googFrameHeightSent:kt(t[e]?.send,(e=>e.outboundRTP.frameHeight)),googFrameWidthSent:kt(t[e]?.send,(e=>e.outboundRTP.frameWidth)),googFrameRateSent:kt(t[e]?.send,(e=>e.extensions?.frameRateSent)),googRtt:kt(t[e]?.send,(e=>1e3*(e.remoteInboundRTP?.roundTripTime??0)),!0),hugeFramesSent:n?.outboundRTP.hugeFramesSent,qpSum:kt(t[e]?.send,(e=>e.outboundRTP.qpSum)),qualityLimitationDurations:n?JSON.stringify(n?.outboundRTP.qualityLimitationDurations):void 0,qualityLimitationReason:n?.outboundRTP.qualityLimitationReason,qualityLimitationResolutionChanges:n?.outboundRTP.qualityLimitationResolutionChanges,jitter:n?.remoteInboundRTP?.jitter})})}function HM(e){return e?.substring(e.indexOf("/")+1).toUpperCase()}var $M=e=>lt({id:e.outboundRTP.ssrc.toString(),codecName:HM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.remoteInboundRTP?.jitter,packets:e.outboundRTP.packetsSent,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.remoteInboundRTP?.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,rtt:e.remoteInboundRTP?.roundTripTime,frameRateInput:e.mediaSource?.framesPerSecond,frameWidthInput:e.mediaSource?.width,frameHeightInput:e.mediaSource?.height,framesEncoded:e.outboundRTP.framesEncoded,frameRateEncoded:e.extensions?.frameRateEncoded,framesSent:e.outboundRTP.framesSent,frameRateSent:e.extensions?.frameRateSent,frameWidthSent:e.outboundRTP.frameWidth,frameHeightSent:e.outboundRTP.frameHeight,keyFramesEncoded:e.outboundRTP.keyFramesEncoded,nackCount:e.outboundRTP.nackCount,firCount:e.outboundRTP.firCount,pliCount:e.outboundRTP.pliCount,transportId:e.outboundRTP.transportId,altLayouts:e.altLayouts?.map($M)}),GM=e=>lt({id:e.inboundRTP.ssrc.toString(),codecName:HM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.inboundRTP.jitter,packets:e.inboundRTP.packetsReceived,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.inboundRTP.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.inboundRTP.packetsDiscarded,rtt:e.remoteOutboundRTP?.roundTripTime,msi:e.renderer?.msi,jitterBufferMs:e.extensions?.jitterBufferMs,frameRateOutput:e.extensions?.frameRateDecoded,frameRateDecoded:e.extensions?.frameRateDecoded,frameRateReceived:e.extensions?.frameRateReceived,frameWidthReceived:e.inboundRTP.frameWidth,frameHeightReceived:e.inboundRTP.frameHeight,longestFreezeDuration:e.extensions?.longestFreeze,totalFreezeDuration:e.extensions?.totalFreezeDuration,framesReceived:e.inboundRTP.framesReceived,framesDropped:e.inboundRTP.framesDropped,framesDecoded:e.inboundRTP.framesDecoded,keyFramesDecoded:e.inboundRTP.keyFramesDecoded,nackCount:e.inboundRTP.nackCount,firCount:e.inboundRTP.firCount,pliCount:e.inboundRTP.pliCount,transportId:e.inboundRTP.transportId}),jM=e=>lt({id:e.outboundRTP.ssrc.toString(),codecName:HM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.remoteInboundRTP?.jitter,packets:e.outboundRTP.packetsSent,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.remoteInboundRTP?.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.remoteInboundRTP?.packetsDiscarded,rtt:e.remoteInboundRTP?.roundTripTime,audioLevel:e.mediaSource?.audioLevel,transportId:e.outboundRTP.transportId}),qM=e=>lt({id:e.inboundRTP.ssrc.toString(),codecName:HM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.inboundRTP.jitter,packets:e.inboundRTP.packetsReceived,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.inboundRTP.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.inboundRTP.packetsDiscarded,rtt:e.remoteOutboundRTP?.roundTripTime,jitterBufferMs:e.extensions?.jitterBufferMs,audioLevel:e.inboundRTP.audioLevel,healedRatio:e.extensions?.healedRatio,transportId:e.inboundRTP.transportId}),WM=e=>lt({id:e.id,state:e.state,dataChannelIdentifier:e.dataChannelIdentifier,messagesSent:e.messagesSent,bytesSent:e.bytesSent,messagesReceived:e.messagesReceived,bytesReceived:e.bytesReceived,sendBitrate:e.extensions?.sendBitrate,recvBitrate:e.extensions?.recvBitrate,messagesSentPerSecond:e.extensions?.sendMessageRate,messagesReceivedPerSecond:e.extensions?.recvMessageRate}),zM=e=>lt({id:e.id,rtt:e.selectedCandidatePair?.currentRoundTripTime,availableIncomingBitrate:e.selectedCandidatePair?.availableIncomingBitrate,availableOutgoingBitrate:e.selectedCandidatePair?.availableOutgoingBitrate,relayProtocol:e.selectedCandidatePair?.localCandidate?.relayProtocol,candidateType:`${e.selectedCandidatePair?.localCandidate?.candidateType??""}:${e.selectedCandidatePair?.remoteCandidate?.candidateType??""}`});function JM(e){return(e.audio?.send??[]).map(jM)}function KM(e){return(e.audio?.recv??[]).map(qM)}function YM(e){return e.video?.send?.length?e.video.send.map($M):[]}function QM(e){return(e.video?.recv??[]).map(GM)}function XM(e){return e.sharing?.send?.length?e.sharing.send.map($M):[]}function ZM(e){return(e.sharing?.recv??[]).map(GM)}function eD(e){return(e.data??[]).map(WM)}function tD(e){return Object.values(e.transports??{}).map(zM)}function iD(e){return 1e4*e}function nD(e,t=Number(new Date)){if(!e)return;const i=ct(e);return e.lastMsgDate&&(e.timeSinceLastMsg=e.lastMsgDate-t),delete i.lastMsgDate,delete i.lastHistory,lt(i)}function rD(e,t,i=0){const n=t.filter((e=>void 0!==e));let r;switch(e){case"Difference":r=n[n.length-1]-n[0];break;case"Average":r=n.reduce(((e,t)=>e+t),0)/n.length;break;case"LastValue":r=n[n.length-1]}return r||0===r?`${"number"==typeof r?+r.toFixed(i):r}`:void 0}function sD(e,t,i){return(i?e.map((e=>e?.[t]?.[i])):e.map((e=>e?.[t]))).filter((e=>void 0!==e)).reduce(((e,t)=>e.concat(t)),[])}function aD(e){const t=e[e.length-1]?.extensions?.powerEfficient;return void 0===t?"":t?"hw":"sw"}function oD(e,t){return e&t?"Bidirectional":e?"ReceiveFromPeer":t?"SendToPeer":"Inactive"}function cD(e){const t=e[e.length-1]?.extensions?.callIsMuted,i=e[e.length-1]?.extensions?.rawInputVolume;return t?"0":!t&&i>0?"2":t||0!==i?void 0:"1"}function lD(e,t){const i=sD(e,"audio","send"),n=sD(e,"audio","recv"),r=function(e){const t=e.find((e=>e?.transports));return t?t.transports[Object.keys(t.transports)[0]]:void 0}(e);if(i.length||n.length)return lt({mediaType:"Audio",mediaDirection:oD(n.length,i.length),"Received BW estimate":rD("Average",n.map((e=>e?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Recv Loss Rate (Avg)":rD("LastValue",n.map((e=>e?.extensions?.lossRate/100)),3),"Rtp Packets Received":rD("Difference",n.map((e=>e?.inboundRTP.packetsReceived))),"Rtp Packet Sent":rD("Difference",i.map((e=>e?.outboundRTP.packetsSent))),"Sent BW estimate":rD("Average",i.map((e=>e?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Audio Codec":rD("LastValue",i.map((e=>e?.codec?.mimeType)))?.split("/")[1],"Send RTT (Avg)":rD("LastValue",i.map((e=>e?.extensions?.rttAvg))),"Audio NW jitter avg":rD("LastValue",n.map((e=>e?.extensions?.jitterAvg)),3),"Audio send bps":rD("Average",i.map((e=>e?.extensions?.bitrate))),"JB delay (ms)":rD("LastValue",n.map((e=>e?.extensions?.jitterBufferDelayMs))),"Recv Audio Codec":rD("LastValue",n.map((e=>e?.codec?.mimeType)))?.split("/")[1],"Current Render Device Name":t?.speaker,"Current Capture Device Name":t?.microphone,"Latest Network Type":r?.selectedCandidatePair?.localCandidate?.networkType,"Latest Transport Protocol":r?.selectedCandidatePair?.localCandidate?.protocol,"Latest Reflexive Address":bm(r?.extensions?.reflexiveLocalIP),"Local Address":bm(r?.selectedCandidatePair?.localCandidate?.ip),"Local short-term Healed Data Ratio":rD("LastValue",n.map((e=>e?.extensions?.healedRatio))),"Send activity (0=muted; 1=inactive; 2=active)":cD(i)})}function dD(e,t){const i=rD("LastValue",e.map((e=>e?.codec?.mimeType)))?.split("/")[1],n=i?i+` ${aD(e)}`:void 0;return{"Rtp Packet Sent":rD("Difference",e.map((e=>e?.outboundRTP.packetsSent))),"Sent BW estimate":rD("Average",e.map((e=>e?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Current Bitrate":rD("Average",e.map((e=>e?.extensions?.bitrate))),"Allocated Send Bandwidth Average":rD("LastValue",e.map((e=>e?.extensions?.bitrateAvg))),"Send Actual Height":rD("LastValue",e.map((e=>e?.outboundRTP.frameHeight))),"Send Actual Width":rD("LastValue",e.map((e=>e?.outboundRTP.frameWidth))),"Send Current Frame Rate":rD("Average",e.map((e=>e?.extensions?.frameRateSent))),"Send RTT (Avg)":rD("LastValue",e.map((e=>e?.extensions?.rttAvg))),"Sent Codec Name":n,"Webcam Freeze Intervals":rD("LastValue",e.map((e=>e?.extensions?.captureFreezeIntervalsCount))),"Current Capture Device Name":t?.camera,"Number of Sync Frame Request per Minute":rD("LastValue",e.map((e=>e?.extensions?.pliRate)))}}function hD(e){const t=rD("LastValue",e.map((e=>e?.mediaEntity?.xSourceStreamId))),i=rD("LastValue",e.map((e=>e?.codec?.mimeType)))?.split("/")[1],n=i?i+` ${aD(e)}`:void 0;return{"Recv Loss Rate (Avg)":rD("LastValue",e.map((e=>e?.extensions?.lossRate)),3),"Received BW estimate":rD("Average",e.map((e=>e?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Receive Current Bitrate":rD("Average",e.map((e=>e?.extensions?.bitrate))),"Rtp Packets Received":rD("Difference",e.map((e=>e?.inboundRTP.packetsReceived))),"Receive Actual Height":rD("LastValue",e.map((e=>e?.inboundRTP.frameHeight))),"Receive Actual Width":rD("LastValue",e.map((e=>e?.inboundRTP.frameWidth))),"Receive Current Frame Rate":rD("Average",e.map((e=>e?.extensions?.frameRateReceived))),"Received Codec Name":n,"Received Total Freeze Fraction (ms per min)":rD("LastValue",e.map((e=>e?.extensions?.totalFreezeFraction))),videoSourceId:t?parseInt(t):void 0,"Received Fps Time Weighted Harmonic Average":rD("LastValue",e.map((e=>e?.extensions?.fpsHarmonicAverage)))}}function uD(e,t,i){const n=lD(e,t);n&&i.channels.push(n);const r=function(e,t){const i=[],n=function(e){const t={},i=i=>{e.map((e=>e?.video?.[i])).forEach((e=>{e?.forEach((e=>{var n;const r=e?.mediaEntity?.remoteSsrc;t[r]??(t[r]={}),(n=t[r])[i]??(n[i]=[]),t[r][i].push(e)}))}))};return i("recv"),i("send"),t}(e);for(const{send:e,recv:r}of Object.values(n)){let n={mediaType:"Camera",mediaDirection:oD(r?.length,e?.length)};r&&(n={...n,...hD(r)}),e&&(n={...n,...dD(e,t)}),i.push(lt(n))}return i}(e,t);r.length&&i.channels.push(...r);const s=function(e){const t=sD(e,"sharing","send"),i=sD(e,"sharing","recv");if(!i.length&&!t.length)return;let n={mediaType:"AppSharing",mediaDirection:"Bidirectional","Render Device Name":""};return i.length&&(n={...n,...hD(i)}),t.length&&(n={...n,...dD(t,{microphone:void 0,camera:"Screen sharing",speaker:void 0})}),lt(n)}(e);s&&i.channels.push(s)}function gD(e,t,i,n,r){return lt({recv:lt({id:i?.inboundRTP.id,ssrc:i?.inboundRTP.ssrc,mediaType:i?.inboundRTP.mediaType??i?.inboundRTP.kind,bytes:Nt(t[e]?.recv,(e=>e.inboundRTP.bytesReceived),r),packets:Nt(t[e]?.recv,(e=>e.inboundRTP.packetsReceived),r),packetsLost:Nt(t[e]?.recv,(e=>e.inboundRTP.packetsLost),r),codec:i?.codec?.mimeType.split("/")[1],codecReport:i?.aggregated?.codecReport,framesDecoded:Nt(t[e]?.recv,(e=>e.inboundRTP.framesDecoded),r),height:Nt(t[e]?.recv,(e=>e.inboundRTP.frameHeight),r),width:Nt(t[e]?.recv,(e=>e.inboundRTP.frameWidth),r),frameRate:Nt(t[e]?.recv,(e=>e.extensions?.frameRateReceived),r)}),send:lt({id:n?.outboundRTP.id,ssrc:n?.outboundRTP.ssrc,mediaType:n?.outboundRTP.mediaType??n?.outboundRTP.kind,bytes:Nt(t[e]?.send,(e=>e.outboundRTP.bytesSent),r),packets:Nt(t[e]?.send,(e=>e.outboundRTP.packetsSent),r),packetsLost:Nt(t[e]?.send,(e=>e.remoteInboundRTP?.packetsLost),r),codec:n?.codec?.mimeType.split("/")[1],framesEncoded:Nt(t[e]?.send,(e=>e.outboundRTP.framesEncoded),r),heightInput:n?.mediaSource?.height,widthInput:n?.mediaSource?.width,height:Nt(t[e]?.send,(e=>e.outboundRTP.frameHeight),r),width:Nt(t[e]?.send,(e=>e.outboundRTP.frameWidth),r),frameRate:Nt(t[e]?.send,(e=>e.extensions?.frameRateSent),r)})})}function pD(e,t,i,n){const r=t?.codec?.mimeType.split("/");return lt({recv:lt({id:t?.inboundRTP.id,ssrc:t?.inboundRTP.ssrc,mediaType:t?.inboundRTP.mediaType??t?.inboundRTP.kind,bytes:Nt(e.audio?.recv,(e=>e.inboundRTP.bytesReceived),n),packets:Nt(e.audio?.recv,(e=>e.inboundRTP.packetsReceived),n),packetsLost:Nt(e.audio?.recv,(e=>e.inboundRTP.packetsLost),n),codec:r?.[r?.length-1],audioLevel:Nt(e.audio?.recv,(e=>Math.floor(65535*e.inboundRTP.audioLevel)),n)}),send:lt({id:i?.outboundRTP.id,ssrc:i?.outboundRTP.ssrc,mediaType:i?.outboundRTP.mediaType??i?.outboundRTP.kind,bytes:Nt(e.audio?.send,(e=>e.outboundRTP.bytesSent),n),packets:Nt(e.audio?.send,(e=>e.outboundRTP.packetsSent),n),packetsLost:Nt(e.audio?.send,(e=>e.remoteInboundRTP?.packetsLost),n),codec:i?.codec?.mimeType.split("/")[1],audioLevel:Nt(e.audio?.send,(e=>Math.floor(65535*e.aggregated.audioLevel)),n)})})}var mD=class{constructor(e,t){this.rootRef=e,this.configProvider=t}get rootCopy(){return ct(this.rootRef)}get rawRootRef(){return this.rootRef}getSessionTelemetry(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e)),i={metrics:{},Extensions:{}};if(!t)return;const n=Pt();try{const e=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,n=e?.terminationTime??0,r=t.webrtcSessions[t.webrtcSessions.length-1];i.metrics=function(e,t,i,n){const r=e.webrtcSessions[e.webrtcSessions.length-1];return lt({MediaLegId:e.mediaLegId,CreationTime:iD(e.creationTime),CallNumber:e.callNumber,SessionId:e.sessionId,MultiParty:e.isMultiParty,ErrorType:e.error?.type??"none",ErrorDetail:e.error?.detail??"none",IncompatibleOffer:e.error?.type===Qe.MEDIA_ERROR.incompatibleOffer,TerminationTime:iD(e.terminationTime),TerminationReason_code:e.terminationReason?.code,TerminationReason_subCode:e.terminationReason?.subCode,TerminationReason_phrase:e.terminationReason?.phrase,TerminationReason_remoteTerminated:e.terminationReason?.remoteTerminated,TerminationReason_clientReasonPhrase:e.terminationReason?.clientReasonPhrase,TerminationReason_clientReasonSubCode:e.terminationReason?.clientReasonSubCode,CallDuration:iD(e.duration),IceInitTime:iD(e.iceInitTime),IceConnectedStateTime:iD(e.iceConnectedStateTime),NegotiationCount:e.negotiationCount,RejectedNegotiationCount:e.rejectedNegotiationCount,InitialNegotiationCompleted:e.initialNegotiationCompleted,InitialNegotiationType:e.initialNegotiationType,FinalAnswerTime:iD(e.finalAnswerTime),TransportReconnectedCount:e.transportReconnectedCount,RollbackNegotiation:JSON.stringify(e.rollbackNegotiation),Relay:e.relay?JSON.stringify(e.relay):void 0,ActiveModalities:JSON.stringify(e.activeModalities),AllowedAudioSend:e.allowedAudioSend,AllowedVideoSend:e.allowedVideoSend,AllowedScreensharingSend:e.allowedScreensharingSend,RelayManager:JSON.stringify(e.relayTimers),AuthTokenStats:JSON.stringify(e.authTokenFetcherStats),CallMutedRatio:iD(e.callMutedRatio),CallOsMuted:iD(e.callOsMuted),CallHwSilent:iD(e.callHwSilent),CallSwMuted:iD(e.callSwMuted),CallSpeakerMuted:iD(e.callSpeakerMuted),CallIsSpeaking:iD(e.callIsSpeaking),DtmfSuccess:e.dtmfSuccessCount,DtmfFailure:e.dtmfFailureCount,ReconnectInProgress:e.reconnect?.isReconnecting,RetargetIncomingCount:e.reconnect?.retargetCount.incoming,RetargetOutgoingCount:e.reconnect?.retargetCount.outgoing,RetargetCompletedCount:e.reconnect?.retargetCount.completed,RetargetRejectedCount:e.reconnect?.retargetCount.rejected,EscalationAttemptedCount:e.reconnect?.escalationCount.attempted,EscalationCompletedCount:e.reconnect?.escalationCount.completed,EscalationRejectedCount:e.reconnect?.escalationCount.rejected,ReconnectAttemptedCount:e.reconnect?.reconnectCount.attempted,ReconnectConnectedCount:e.reconnect?.reconnectCount.connected,ReconnectAttempts:JSON.stringify(Dt(Et(e.reconnect?.records,n.config.diagnostics.telemetryLimits.numReconnects),"startTime",e.creationTime)),NetworkEvents:JSON.stringify(Dt(Et(e.reconnect?.tmpRecords,n.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",e.creationTime)),NoIceCandidatesGoodEventCount:e.noIceCandidatesEventCount.good,NoIceCandidatesBadEventCount:e.noIceCandidatesEventCount.bad,NoRelayIceCandidatesGoodEventCount:e.noRelayIceCandidatesEventCount.good,NoRelayIceCandidatesBadEventCount:e.noRelayIceCandidatesEventCount.bad,MicrophoneInUseGoodEventCount:e.microphoneInUseEventCount.good,MicrophoneInUseBadEventCount:e.microphoneInUseEventCount.bad,CameraInUseGoodEventCount:e.cameraInUseEventCount.good,CameraInUseBadEventCount:e.cameraInUseEventCount.bad,CameraFreezeStartEventCount:e.cameraFreezeEventCount.start,CameraFreezeEndEventCount:e.cameraFreezeEventCount.end,NetworkRecvGood:e.networkRecvUFD.good,NetworkRecvGoodRatio:e.networkRecvUFD.goodRatio,NetworkRecvPoor:e.networkRecvUFD.poor,NetworkRecvPoorRatio:e.networkRecvUFD.poorRatio,NetworkRecvBad:e.networkRecvUFD.bad,NetworkRecvBadRatio:e.networkRecvUFD.badRatio,NetworkSendGood:e.networkSendUFD.good,NetworkSendGoodRatio:e.networkSendUFD.goodRatio,NetworkSendPoor:e.networkSendUFD.poor,NetworkSendPoorRatio:e.networkSendUFD.poorRatio,NetworkSendBad:e.networkSendUFD.bad,NetworkSendBadRatio:e.networkSendUFD.badRatio,Connection_Downlink:kt(r.networkInfo,(e=>e.downlink)),Connection_EffectiveType:kt(r.networkInfo,(e=>e.effectiveType)),Connection_Rtt:kt(r.networkInfo,(e=>e.rtt)),Connection_SaveData:bt(r.networkInfo)?.saveData,RawOutputAudioAccessAttempted:e.rawMedia.audio.recv.numAttempts,RawOutputAudioAccessDurationRatio:e.rawMedia.audio.recv.durationRatio,RawInputAudioOverrideAttempted:e.rawMedia.audio.send.numAttempts,RawInputAudioOverrideDurationRatio:e.rawMedia.audio.send.durationRatio,UFDs:JSON.stringify(Dt(Et(e.ufds,n.config.diagnostics.telemetryLimits.numUFDs),"timestamp",e.creationTime)),MediaQosEnabled:i.configuration.mediaConfig?.enableMediaQoS??!1,PortRangeConfigured:!!i.configuration.mediaConfig?.mediaPortRanges,hardwareConcurrency:i.configuration.userAgentConfig.hardwareConcurrency,ETag:e.ETag,ConfigIds:e.configIds,GPUName:i.configuration.userAgentConfig.unmaskedGlRenderer,PermissionStates:JSON.stringify(i.deviceManager.permissionStates),DeviceList:JSON.stringify(i.deviceManager.deviceList),DeviceListDebug:JSON.stringify(i.deviceManager.deviceDebugStrings),DevicesChangeCount:e.deviceManager.devicesChangeCount,DevicesPollChangeCount:e.deviceManager.devicesPollChangeCount,DeviceSelectionChangeCount:e.deviceManager.deviceSelectionChangeCount,DeviceSelectionChangeFromInterfaceCount:e.deviceManager.deviceSelectionChangeCountFromInterface,DevicesCount:JSON.stringify(i.deviceManager.devicesCount),UsedMicrophone:i.deviceManager.usedDevices?.microphone,UsedSpeaker:i.deviceManager.usedDevices?.speaker,UsedCamera:i.deviceManager.usedDevices?.camera,DeviceEvents:JSON.stringify(Dt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),VideoEffects:JSON.stringify(Dt(i.deviceManager.videoEffectsEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),AudioEffects:JSON.stringify(Dt(i.deviceManager.audioEffectsEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),MediaByPassEnabled:!!i.configuration.mediaConfig.enableMediaBypass,CallConstraints:JSON.stringify(n.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(nD(e.dominantSpeaker,e.terminationTime))})}(t,n,this.rootRef,this.configProvider),i.Extensions=function(e,t,i){const n=e.aggregatedModalityStats,r=bt(n.audio?.recv),s=bt(n.audio?.send),a=bt(n.video?.recv),o=bt(n.video?.send),c=bt(n.sharing?.recv),l=bt(n.sharing?.send),d=i=>i&&Et(ct(i).map((i=>Dt(Et(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested),h=d(e.qualityManager?.videoMaxCapabilitiesEvents),u=d(e.qualityManager?.videoMaxCapabilitiesErrors),g=d(e.qualityManager?.sharingMaxCapabilitiesEvents),p=d(e.qualityManager?.sharingMaxCapabilitiesErrors),m="REMB"!==e.bweType?e.bandwidthReport:void 0,f="REMB"===e.bweType?e.bandwidthReport:void 0,S=[],v=[];return e.statsOnSubscribed.video?.forEach((e=>S.push(e))),e.statsOnSubscribed.sharing?.forEach((e=>v.push(e))),lt({BundlePolicy:e.bundlePolicy,FakeIceCandidate:e.fakeIceCandidate,H264_available_profiles:JSON.stringify(e.H264Profiles),IceConnectionState:e.iceConnectionState,IceConnectionStatePrevious:e.iceConnectionStatePrevious,IceServers:e.iceServers,IceTransportPolicy:e.iceTransportPolicy,NegotiatedSrtp:JSON.stringify(e.negotiatedSrtp),OfferedSrtp:JSON.stringify(e.offeredSrtp),RelayCandidate:e.relayCandidate,SdpSemantics:e.sdpSemantics,iceCandidateErrors:JSON.stringify(e.iceCandidateErrors),SignalingState:e.signalingState,SignalingStatePrevious:e.signalingStatePrevious,WebRTCStats_statsErrors:JSON.stringify(i),MaxSessionBandwidth:e.maxSessionBandwidth,Bandwidth_uplinkStabilizationTime:JSON.stringify(e.bwStabilizationTime),Bandwidth_downlinkStabilizationTime:JSON.stringify(e.bwDownlinkStabilizationTime),totalVideoControlMessages:e.qualityManager?.numVideoControlMessages,outOfOrderVideoControlMessages:e.qualityManager?.numOutOfOrderVideoControlMessages,webcamFreezeIntervals:e.qualityManager?.numWebcamFreezeIntervals,processedStreamFreezeIntervals:e.qualityManager?.numProcessedStreamFreezeIntervals,IPAddress:e.IPAddress??"none",ReflexiveLocalIP:e.reflexiveLocalIP??"none",NumberOfInterfaces:e.numInterfaces,StartTime:e.startTime,EndTime:e.endTime,AudioTransportRecvBitrate:r?.transport?.extensions?.recvBWAvg,AudioTransportSendBitrate:r?.transport?.extensions?.sendBWAvg,AudioPayloadRecvBitrate:r?.aggregated?.bitrateAvg,AudioPayloadSendBitrate:s?.aggregated?.bitrateAvg,VideoPayloadRecvBitrate:a?.aggregated?.bitrateAvg,VideoPayloadSendBitrate:o?.aggregated?.bitrateAvg,WebRTCStats_bweStat_googAvailableReceiveBandwidth:kt(n.video?.recv,(e=>e.transport?.selectedCandidatePair?.availableIncomingBitrate))??kt(n.video?.send,(e=>e.transport?.selectedCandidatePair?.availableIncomingBitrate)),WebRTCStats_bweStat_googAvailableSendBandwidth:kt(n.video?.send,(e=>e.transport?.selectedCandidatePair?.availableOutgoingBitrate))??kt(n.video?.recv,(e=>e.transport?.selectedCandidatePair?.availableOutgoingBitrate)),ReportedSendBWMax:e.reportedSendBandwidthMax,ReportedSendBWMin:e.reportedSendBandwidthMin,Bandwidth_jumpsHistogram:JSON.stringify(o?.transport?.extensions?.bwJumpsHistogram),StartCallBWESendSide:JSON.stringify(m?.startOfTheCall),EndCallBWESendSide:JSON.stringify(m?.endOfTheCall),BWEStdSendSide:JSON.stringify(m?.std),BwPercentilesSendSide:JSON.stringify(m?.bwPercentiles),AvgBwSendSide:JSON.stringify(m?.avgBwe),StartCallBWE:JSON.stringify(f?.startOfTheCall),EndCallBWE:JSON.stringify(f?.endOfTheCall),BWEStd:JSON.stringify(f?.std),BwPercentiles:JSON.stringify(f?.bwPercentiles),AvgBw:JSON.stringify(f?.avgBwe),WebRTCStats_ssrc:lt({audio:VM(n,r,s),video:BM("video",n,a,o),sharing:BM("sharing",n,c,l)}),Audio_recv_jitterBufferAvgSize:r?.aggregated?.avgJitterBufferSize,Audio_recv_packetsLostRateMax:r?.aggregated?.lossRateMax,Audio_recv_jitterAvg:r?.aggregated?.jitterAvg,Audio_recv_networkAvgLossRate:r?.aggregated?.networkAvgLossRate,Audio_send_rttAvg:s?.aggregated?.rttAvg&&Ct(1e3*s.aggregated.rttAvg),Audio_send_rttMax:s?.aggregated?.rttMax&&Ct(1e3*s.aggregated.rttMax),Audio_send_RawInputVolume:kt(n.audio?.send,(e=>e.aggregated?.rawInputVolume)),Audio_send_packetsLostRateMax:s?.aggregated?.lossRateMax,Audio_send_presentationAPIUserDuration:e.presentationAPIUserDuration,Audio_send_presentationDuration:e.presentationAudioDuration,Video_recv_DurationSeconds:a?.aggregated?.duration,Video_recv_FreezeHistogram:JSON.stringify(a?.aggregated?.freezeCountHistogram),Video_recv_FreezeTimestamps:JSON.stringify(Ot(a?.aggregated?.freezeTimestampsHistogram,e.startTime)),Video_recv_LongestFreezeDuration:a?.aggregated?.longestFreeze,Video_recv_OngoingFreeze:a?.extensions?.isFrozen,Video_recv_OngoingFreezeDuration:a?.aggregated?.ongoingFreezeDuration,Video_recv_TotalFreezeDuration:a?.aggregated?.totalFreezeDuration,Video_recv_RecvAvgFreezeDuration:a?.aggregated?.avgFreezeDuration,Video_recv_NumResolutionSwitches:a?.aggregated?.numResolutionSwitches,Video_recv_ResolutionDurations:JSON.stringify(a?.aggregated?.resolutionDurations),Video_recv_StreamsMax:e.recvVideoStreamCount.max,Video_recv_StreamsMin:e.recvVideoStreamCount.min,Video_recv_StreamsMode:e.recvVideoStreamCount.mode,Video_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Video_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Video_recv_bitrateAvg:a?.aggregated?.bitrateAvg,Video_recv_bitrateMax:a?.aggregated?.bitrateMax,Video_recv_frameRateAvg:a?.aggregated?.avgFrameRate,Video_recv_jitterBufferAvgSize:a?.aggregated?.avgJitterBufferSize,Video_recv_packetsLostRateMax:a?.aggregated?.lossRateMax,Video_recv_isRenderingEvents:JSON.stringify(Et(e.remoteVideoManager?.isRenderingEvents.video,t.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Video_recv_FpsHarmonicAverage:a?.aggregated?.fpsHarmonicAverage,Video_recv_PreferredResolution:e.remoteVideoManager?.preferredResolution.video?.toString(),Video_recv_statsOnSubscribed:JSON.stringify(S),Video_SubscriptionEvents:JSON.stringify(Dt(e.subscriptionManager?.video.events,"ts",e.startTime)),Video_SubscriptionCounters:JSON.stringify(e.subscriptionManager?.video.counters),Video_send_CaptureFramerateAvg:o?.aggregated?.captureFramerateAvg,Video_send_DurationSeconds:o?.aggregated?.duration,Video_send_FreezeIntervals:o?.extensions?.captureFreezeIntervalsCount,Video_send_MaxCapabilities:JSON.stringify(h),Video_send_MaxCapabilitiesErrors:JSON.stringify(u),Video_send_OvershootDurations:JSON.stringify({fs:o?.aggregated?.totalFsOvershootDuration,fps:o?.aggregated?.totalFpsOvershootDuration,br:o?.aggregated?.totalBrOvershootDuration}),Video_send_OvershootEvents:JSON.stringify(Dt(o?.aggregated.overshootEvents,"timestamp",e.startTime)),Video_send_QpAvg:o?.aggregated?.qpAvg,Video_send_bitrateAvg:o?.aggregated?.bitrateAvg,Video_send_bitrateMax:o?.aggregated?.bitrateMax,Video_send_frameRateAvg:o?.aggregated?.frameRateAvg,Video_send_AllocateBWAvg:o?.aggregated?.bweAvg,Video_send_CameraOpenWidth:o?.extensions?.cameraOpenResolution?.width,Video_send_CameraOpenHeight:o?.extensions?.cameraOpenResolution?.height,Video_send_packetsLostRateMax:o?.aggregated?.lossRateMax,Video_send_resolutionSwitches:JSON.stringify(o?.aggregated?.resolutionSwitches),Sharing_recv_DurationSeconds:c?.aggregated?.duration,Sharing_recv_FreezeHistogram:JSON.stringify(c?.aggregated?.freezeCountHistogram),Sharing_recv_FreezeTimestamps:JSON.stringify(Ot(c?.aggregated?.freezeTimestampsHistogram,e.startTime)),Sharing_recv_LongestFreezeDuration:c?.aggregated?.longestFreeze,Sharing_recv_OngoingFreeze:c?.extensions?.isFrozen,Sharing_recv_TotalFreezeDuration:c?.aggregated?.totalFreezeDuration,Sharing_recv_RecvAvgFreezeDuration:c?.aggregated?.avgFreezeDuration,Sharing_recv_NumResolutionSwitches:c?.aggregated?.numResolutionSwitches,Sharing_recv_ResolutionDurations:JSON.stringify(c?.aggregated?.resolutionDurations),Sharing_recv_StreamsMax:e.recvVideoStreamCount.max,Sharing_recv_StreamsMin:e.recvVideoStreamCount.min,Sharing_recv_StreamsMode:e.recvVideoStreamCount.mode,Sharing_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameSharing,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Sharing_recv_bitrateAvg:c?.aggregated?.bitrateAvg,Sharing_recv_bitrateMax:c?.aggregated?.bitrateMax,Sharing_recv_frameRateAvg:c?.aggregated?.avgFrameRate,Sharing_recv_jitterBufferAvgSize:c?.aggregated?.avgJitterBufferSize,Sharing_recv_packetsLostRateMax:c?.aggregated?.lossRateMax,Sharing_recv_FpsHarmonicAverage:c?.aggregated?.fpsHarmonicAverage,Sharing_recv_isRenderingEvents:JSON.stringify(Et(e.remoteVideoManager?.isRenderingEvents.sharing,t.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Sharing_recv_PreferredResolution:e.remoteVideoManager?.preferredResolution.sharing?.toString(),Sharing_recv_statsOnSubscribed:JSON.stringify(v),Sharing_SubscriptionEvents:JSON.stringify(Dt(e.subscriptionManager?.sharing.events,"ts",e.startTime)),Sharing_SubscriptionCounters:JSON.stringify(e.subscriptionManager?.sharing.counters),Sharing_send_CaptureFramerateAvg:l?.aggregated?.captureFramerateAvg,Sharing_send_DurationSeconds:l?.aggregated?.duration,Sharing_send_MaxCapabilities:JSON.stringify(g),Sharing_send_MaxCapabilitiesErrors:JSON.stringify(p),Sharing_send_OvershootDurations:JSON.stringify({fs:l?.aggregated?.totalFsOvershootDuration,fps:l?.aggregated?.totalFpsOvershootDuration,br:l?.aggregated?.totalBrOvershootDuration}),Sharing_send_resolutionSwitches:l?.aggregated?.resolutionSwitches,Sharing_send_OvershootEvents:JSON.stringify(Dt(l?.aggregated.overshootEvents,"timestamp",e.startTime)),Sharing_send_QpAvg:l?.aggregated?.qpAvg,Sharing_send_bitrateAvg:l?.aggregated?.bitrateAvg,Sharing_send_bitrateMax:l?.aggregated?.bitrateMax,Sharing_send_frameRateAvg:l?.aggregated?.frameRateAvg,Sharing_send_AllocateBWAvg:l?.aggregated?.bweAvg,Sharing_send_packetsLostRateMax:l?.aggregated?.lossRateMax,multipleVideoStreams:JSON.stringify(Dt(e.multiViewStats,"startTime",e.startTime)),ReportedReceiveBandwidth:e.reportedReceiveBandwidth,OvcToSubscriptions:JSON.stringify(e.ovcToSubscriptionEvents),EncodedStreamWorker:e.encodedStreamWorker,AudioCodecEvents:JSON.stringify(e.audioCodecEvents),HevcCodecSupport:JSON.stringify(e?.codecSupport),CallSetupTimeTracker:JSON.stringify(e.timerTrackerReport),InitialBWSeed:e.initialBWSeed,SentBWSeed:e.sentBWSeed,videoPerformanceEvent:JSON.stringify(e.videoPerformanceEvent),EarlyMedia_NumStatsPolls:e.earlyMediaNumStatsPolls})}(r,this.configProvider,t.statsErrors)}catch(e){t[kM].addStatsError("DiagnosticsReport:getSessionTelemetry",Ve(e)),i.Extensions.WebRTCStats_statsErrors=JSON.stringify(t.statsErrors)}return i.metrics.ReportGenerationTimeMs=Ct(Pt()-n),i}getTeamsRealtimeTelemetry(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));if(t)try{const e=t.webrtcSessions[t.webrtcSessions.length-1],i=this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval;return function(e,t){const i=sD(e,"inactiveTracks"),n={channels:[]};return uD(e,t,n),i.length&&uD(i,void 0,n),n}(e.statsReports.slice(e.statsReports.length-i),this.rootRef.deviceManager.rawUsedDevices)}catch(e){throw t[kM].addStatsError("DiagnosticsReport:getRealTimeTelemetry",Ve(e)),e}}getMediaSessionStats(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));if(t)try{const e=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,i=e?.terminationTime??0,n=t.webrtcSessions[t.webrtcSessions.length-1],r=n?.statsReports.length?n.statsReports[n.statsReports.length-1]:void 0,s=r?function(e){return{audio:{send:JM(e),recv:KM(e)},video:{send:YM(e),recv:QM(e)},screenShare:{send:XM(e),recv:ZM(e)},data:eD(e),transports:tD(e)}}(r):void 0;return s&&(s.extensions=function(e,t){const i=e.qualityManager&&Et(ct(e.qualityManager.videoMaxCapabilitiesEvents).map((i=>Dt(Et(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested),n=e.qualityManager&&Et(ct(e.qualityManager.sharingMaxCapabilitiesEvents).map((i=>Dt(Et(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested);return lt({Video_SubscriptionEvents:JSON.stringify(Dt(e.subscriptionManager?.video.events,"ts",e.startTime)),Sharing_SubscriptionEvents:JSON.stringify(Dt(e.subscriptionManager?.sharing.events,"ts",e.startTime)),Video_send_MaxCapabilities:JSON.stringify(i),Sharing_send_MaxCapabilities:JSON.stringify(n),RelayCandidate:e.relayCandidate,Video_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Sharing_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameSharing,Video_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.timeToFirstFrameSinceSubscriptionStartVideo,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.timeToFirstFrameSinceSubscriptionStartSharing})}(n,this.configProvider),s.metrics=function(e,t,i){return lt({DeviceEvents:JSON.stringify(Dt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),IceConnectedStateTime:1e4*e.iceConnectedStateTime})}(t,i,this.rootRef)),s}catch(e){throw t[kM].addStatsError("DiagnosticsReport:getMediaSessionStats",Ve(e)),e}}getDiagnosticsForE2eTests(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));let i={};if(t){try{const e=t.webrtcSessions[t.webrtcSessions.length-1],n=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,r=n?.terminationTime??0;i=function(e,t,i,n,r){const s=e.aggregatedModalityStats,a=bt(s.audio?.recv),o=bt(s.audio?.send),c=bt(s.video?.recv),l=bt(s.video?.send),d=bt(s.sharing?.recv),h=bt(s.sharing?.send),u=[],g=[];return e.statsOnSubscribed.video?.forEach((e=>u.push(e))),e.statsOnSubscribed.sharing?.forEach((e=>g.push(e))),lt({multipleVideoStreams:e.multiViewStats,WebRTCStats_ssrc:lt({audio:pD(s,a,o,r),video:gD("video",s,c,l,r),sharing:gD("sharing",s,d,h,r)}),CallSwMuted:1e3*t.callSwMuted,DeviceEvents:Dt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>n)),"timestamp",t.creationTime),VideoEffects:Dt(i.deviceManager.videoEffectsEvents.filter((e=>e.timestamp>n)),"timestamp",t.creationTime)})}(e,t,this.rootRef,r,this.configProvider.config.diagnostics.collectionLimits.numSamplesForE2E)}catch(e){t[kM].addStatsError("DiagnosticsReport:getSessionTelemetry",Ve(e))}return i}}},fD=class{constructor(e,t){this.configProvider=e,this.deviceManagerDiagnostics=t,this.root={creationTime:Date.now(),numTotalSessions:0,deviceManager:this.deviceManagerDiagnostics.getObjectRef(),configuration:{stackConfig:this.configProvider.stackConfig,defaultConfig:this.configProvider.defaultConfig,mediaConfig:{},userAgentConfig:{isAudioOutputSelectionSupported:this.configProvider.userAgentConfig.isAudioOutputSelectionSupported,isBrowserRollbackSupported:this.configProvider.userAgentConfig.isBrowserRollbackSupported,hardwareConcurrency:Bp.hardwareConcurrency,unmaskedGlRenderer:Bp.unmaskedGlRenderer,hasMediaApi:Bp.hasMediaApi(),hasCapabilitiesApi:Bp.hasCapabilitiesApi(),hasUnifiedPlanSupport:void 0},consoleOverrides:this.configProvider.consoleOverrides,fullConfig:ct(this.configProvider.config),ecsConfigUpdates:[]},browserInfo:ri(),sessions:[]},this.diagnosticsReport=new mD(this.root,this.configProvider),this.configProvider.on("newConfigReceived",((e,t,i)=>{this.root.configuration.ecsConfigUpdates.push({timestamp:Date.now(),etag:t,configIds:i,config:e})})),this.configProvider.on("configUpdated",(()=>{this.root.configuration.consoleOverrides=this.configProvider.consoleOverrides,this.root.configuration.fullConfig=ct(this.configProvider.config)}))}get reportGenerator(){return this.diagnosticsReport}get rootRef(){return this.root}set mediaConfig(e){this.root.configuration.mediaConfig=e}newSession(e,t,i){this.root.configuration.userAgentConfig.hasUnifiedPlanSupport=this.configProvider.mediaConfig.simulcastSessionEnabled;const n=new NM(i,e,this.diagnosticsReport,this.root.deviceManager,++this.root.numTotalSessions,t);return Tt(this.root.sessions,n.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numSessions),n}},SD=class e{constructor(e,t){this.safe=e,this.unsafe=t,this.safe||(this.safe=this.unsafe)}warn(...e){this.unsafe.warn(...e)}error(...e){this.unsafe.error(...e)}debug(...e){this.unsafe.debug(...e)}info(...e){this.unsafe.info(...e)}createChild(t){return new e(this.safe.createChild(t),this.unsafe.createChild(t))}},vD=p,yD=class{constructor(e){this.logger=e,this.extensionId="nkeimhogjdpnpccoofpliimaahmaaome",this.editorExtensionId="ncbjelpjchkpbikbpkcchkhkblodoama",this.logId="TeamsWebRTCLogs",this.loggingState="unknown",this.connectionCount=0,window.webRtcInternalsCollector=this}get isExtensionAvailable(){return"unavailable"!==this.loggingState}async updateSessionCount(e){this.isExtensionAvailable&&(0===this.connectionCount&&1===e?("stopped"===this.loggingState&&await this.discardLogs(),await this.initialStartLogging()):0===e&&await this.stopLogging(),this.connectionCount=e)}async collect(){return this.isExtensionAvailable?this.collectPromise?this.collectPromise:this.collectPromise=new Promise((async e=>{try{this.connectionCount>0&&(this.logger.safe.info(`Stopping logger for gathering, open connections: ${this.connectionCount}`),await this.stopLogging()),await this.storeLogs();const t=await this.gatherFromStorage();this.connectionCount>0&&await this.continueLogging(),e(t.length>0?t.join("\r\n"):"")}catch(t){this.logger.safe.error("Error while collecting logs",t),e(JSON.stringify(t))}this.collectPromise=void 0})):""}async initialStartLogging(){try{await this.startLogging()}catch(e){if(e?.includes("A log is already open"))try{const t=e.match(/State=(\w+)/);await this.cleanState(t?.[1]),await this.startLogging()}catch(e){this.logger.safe.error("Error while starting logging at cleanup phase",e),this.loggingState="unknown"}else this.logger.safe.error("Error while starting logging",e),this.loggingState="unavailable"}}async continueLogging(){try{await this.startLogging()}catch(e){this.logger.safe.error("Error while continuing logging",e),this.loggingState="stopped"}}async startLogging(){await this.sendMessage(this.extensionId,{method:"logging.start"}),this.logger.safe.info("Logging started"),this.loggingState="started"}async cleanState(e){try{if("started"===e)await this.stopLogging(),await this.discardLogs();else{if("stopped"!==e)throw new Error(`Unexpected logging state: ${e}`);await this.discardLogs()}}catch(e){this.logger.safe.error("Error while cleaning state",e)}}async stopLogging(){try{await this.sendMessage(this.extensionId,{method:"logging.stop"}),this.logger.safe.info("Logging stopped"),this.loggingState="stopped"}catch(e){this.logger.safe.error("Error while stopping logging",e)}}async discardLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.discard"}),this.logger.safe.info("Logs discarded"),this.loggingState="closed"}catch(e){this.logger.safe.error("Error while discarding logs",e)}}async storeLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.store",logId:this.logId}),this.logger.safe.info(`Logs stored to ${this.logId}`),this.loggingState="closed"}catch(e){this.logger.safe.error("Error while storing logs",e)}}async gatherFromStorage(){const e=[];let t={offset:0};do{t=await this.sendMessage(this.editorExtensionId,{api:"getWebRtcLog",logId:this.logId,offset:t.offset}),e.push(t.data),this.logger.safe.info(`Batch gathered with offset: ${t.offset}, moreData: ${t.moreData}`)}while(t.moreData);return this.logger.safe.info("Finished gathering"),e}sendMessage(e,t){return new Promise(((i,n)=>{const r=chrome.runtime;r.sendMessage(e,t,(e=>{if(!e||e?.error){const i=e?JSON.stringify(e.error):r.lastError;n(`sendMessage ${JSON.stringify(t)} failed with error: ${i}`)}i(e)}))}))}},CD=(()=>{let e;return{getInstance:function(t,i){return i?.config.enableWebRtcInternalsLogs&&"EdgeAnaheim"===ri().name&&chrome?.runtime?(e||(e=new yD(t)),e):(t.safe.info("WebRTC internal logging is disabled"),{collect:()=>Promise.resolve(""),updateSessionCount:()=>Promise.resolve()})}}})(),_D=CD,ED=class{getId(){return 0}getDeviceId(){return Qe.EMPTY_DEVICE_ID}getPreviewAsync(e,t){return Promise.resolve(null)}getDescription(){return"display"}getType(){return 1}getIcon(e,t){return Promise.resolve(null)}},TD=class{constructor(e){this.descr=e}getId(){return 0}getDeviceId(){return this.descr.browserId}getPreviewAsync(e,t){return Promise.resolve(null)}getDescription(){return this.descr.label}getType(){return 3}getIcon(e,t){return Promise.resolve(null)}},ID=class{constructor(e){this.deviceManager=e,this.sharingSource=new ED}onScreensChanged(e){return{dispose:()=>{}}}enumerateScreensAsync(){return Promise.resolve([this.sharingSource])}enumerateWindowsAsync(){return Promise.resolve([])}async enumerateCamerasAsync(){return(await this.deviceManager.enumerateDevicesAsync()).filter((e=>"camera"===e.kind)).map((e=>new TD(e)))}},bD=class{constructor(){this.data={records:[],tmpRecords:[],isReconnecting:!1,networkRecoveredCount:0,disconnectedRecoveredCount:0,reconnectCount:{attempted:0,connected:0},retargetCount:{incoming:0,outgoing:0,completed:0,rejected:0},escalationCount:{attempted:0,completed:0,rejected:0}}}registerState(e){const t="connected"===e?this.activeTmpRecord:this.getTmpRecord();t&&t.events[t.events.length-1]?.type!==e&&(t.events.push({type:e,time:Date.now()-t.startTime}),"networkOnline"===e?this.data.networkRecoveredCount++:"connected"===e&&this.data.disconnectedRecoveredCount++,"reconnect"!==e&&"connected"!==e||(t.endTime=Date.now()-t.startTime,this.activeTmpRecord=null))}registerReconnectAttempt(e){this.activeRecord&&(this.activeAttempt={direction:e,startTime:Date.now()-this.activeRecord.startTime,status:!1},this.data.isReconnecting=!0,this.activeRecord.attempts.push(this.activeAttempt))}registerReconnectAttemptStatus(e){"completed"===e&&(this.data.isReconnecting=!1),this.activeAttempt&&this.activeRecord&&(this.activeAttempt.endTime=Date.now()-this.activeRecord.startTime,this.activeAttempt.status="completed"===e)}registerReconnect(e){if(this.data.reconnectCount[e]++,this.data.isReconnecting="attempted"===e,"attempted"===e){if(this.activeRecord)return;this.activeRecord={startTime:Date.now(),attempts:[]},this.data.records.push(this.activeRecord)}else if("connected"===e){if(!this.activeRecord)return;this.activeTmpRecord&&this.registerState("connected"),this.activeRecord.endTime=Date.now()-this.activeRecord.startTime,this.activeRecord=void 0,this.activeAttempt=void 0}}registerRetarget(e){this.data.retargetCount[e]++}registerEscalation(e){this.data.escalationCount[e]++}getObject(){return this.data}getTmpRecord(){return(!this.activeTmpRecord||this.activeTmpRecord.endTime>0)&&(this.activeTmpRecord={startTime:Date.now(),events:[]},this.data.tmpRecords.push(this.activeTmpRecord)),this.activeTmpRecord}},AD=class{constructor(){}process(e){return this.mediaLegId=e||this.mediaLegId||dt().toUpperCase(),this.mediaLegId}},RD=class{constructor(e,t){this.relayManager=e,this.diagnostics=t}initialize(){}setRelayOverride(){}async queryRelaysAsync(e){const t=await this.relayManager.queryRelaysAsync(e);return t.length>0&&(this.diagnostics.relay=t[0]),t}getStats(){return this.relayManager.getStats?.()??{unavailable:"1"}}getAuthTokenStats(){return this.relayManager.getAuthTokenStats()}},wD=class{constructor(e,t,i){this.stats=e,this.diag=t,i&&t&&(i.reconnect=t.getObject())}registerState(e){this.diag?.registerState(e)}registerReconnectAttempt(e){this.stats.registerReconnectAttempt(e),this.diag?.registerReconnectAttempt(e)}registerReconnectAttemptStatus(e){switch(e){case"completed":this.stats.registerReconnectAttemptCompleted();break;case"rejected":this.stats.registerReconnectAttemptRejected()}this.diag?.registerReconnectAttemptStatus(e)}registerReconnect(e){switch(e){case"attempted":this.stats.registerReconnectAttempted();break;case"connected":this.stats.registerReconnectConnected()}this.diag?.registerReconnect(e)}registerRetarget(e){switch(e){case"completed":this.stats.registerRetargetCompleted();break;case"rejected":this.stats.registerRetargetRejected();break;case"incoming":this.stats.registerRetargetIncoming();break;case"outgoing":this.stats.registerRetargetOutgoing()}this.diag?.registerRetarget(e)}registerEscalation(e){switch(e){case"attempted":this.stats.registerEscalationStart();break;case"completed":this.stats.registerEscalationCompleted();break;case"rejected":this.stats.registerEscalationRejected()}this.diag?.registerEscalation(e)}},PD=class{constructor(e){this.initialCallbacks=e,this.queueCallbacks={onTerminated:this.genCallback(this.initialCallbacks.onTerminated),onSessionErrorOccurred:this.genCallback(this.initialCallbacks.onSessionErrorOccurred),onNegotiationRequired:this.genCallback(this.initialCallbacks.onNegotiationRequired),onAudioStateChanged:this.genCallback(this.initialCallbacks.onAudioStateChanged),onAudioHwSilentChanged:this.genCallback(this.initialCallbacks.onAudioHwSilentChanged),onTransportDisconnected:this.genCallback(this.initialCallbacks.onTransportDisconnected),onTransportConnected:this.genCallback(this.initialCallbacks.onTransportConnected),onTransportInitialized:this.genCallback(this.initialCallbacks.onTransportInitialized),onTransportFailed:this.genCallback(this.initialCallbacks.onTransportFailed),onUpdateMediaDescriptionsRequired:this.genCallback(this.initialCallbacks.onUpdateMediaDescriptionsRequired),onTeamsRealtimeTelemetryReport:this.genCallback(this.initialCallbacks.onTeamsRealtimeTelemetryReport)},this.queue=[]}flush(){this.queue.forEach((e=>{e.method.apply(null,e.args)})),this.clear()}clear(){this.queue=[]}genCallback(e){return(...t)=>this.queue.push({method:e,args:t})}},MD=class{constructor(e,t){this.relayConfig=e,this.logger=t}async ensureOnline(){if(0===this.relayConfig.length)return this.logger.safe.warn("No TURN servers defined"),0;if(this.probeDeferred)return this.probeDeferred.promise;this.logger.safe.info(`Starting TURN probes with ${JSON.stringify(this.relayConfig[0].urls)}`),this.checkStart=Date.now();let e=0;this.probeDeferred=vi();const t=async()=>{await this.performCheck()&&this.finalize()},i=()=>{t(),e<3e3&&(e+=1e3),this.probeTimer=setTimeout(i,e)};return i(),this.probeDeferred.promise}finalize(){this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=0),this.probeDeferred&&(this.probeDeferred.resolve(Date.now()-this.checkStart),this.probeDeferred=null)}dispose(){this.finalize()}async performCheck(){this.logger.safe.info("Probing...");const e=this.tryCreatePc();if(!e)return!1;e.createDataChannel("probe");const t=vi();function i(i){e.onicecandidate=void 0,e.close(),t.resolve(i)}let n=!1;return e.onicecandidate=e=>{const t=e.candidate;if(!t)return n||this.logger.safe.info("still offline"),void i(n);const r=t.type??rm(t.candidate).type;"srflx"!==r&&"relay"!==r||(this.logger.safe.info(`Back online through ${r} candidate`),n=!0,"srflx"===r&&(this.ipFromRelay=t.address,i(!0)))},await e.setLocalDescription(await e.createOffer()),t.promise}tryCreatePc(){try{return new Vp.window.RTCPeerConnection({iceServers:this.relayConfig})}catch(e){return this.logger.safe.info(`Failed to create PC, errCode=${e.code}`),null}}},DD=(e,t)=>e.reduce(((e,i)=>{const n=[],r=i.addresses&&i.addresses[0],s=i.fqdns&&i.fqdns.length>0,a=t.iceUdpAddressType,o=t.iceTcpAddressType,c=t.iceServerTransport;if(!r&&!s)return e;if(c.includes("udp")&&i.udpPort){const e=!s||"fqdn"!==a&&r?r:i.fqdns[0];n.push(`turn:${e}:${i.udpPort}?transport=udp`)}if(c.includes("tcp")&&i.tcpPort){const e=!s||"fqdn"!==o&&r?r:i.fqdns[0];n.push(`turn:${e}:${i.tcpPort}?transport=tcp`)}return c.includes("tls")&&i.tlsPort&&s&&n.push(`turns:${i.fqdns[0]}:${i.tlsPort}`),e.concat({urls:n,credential:i.password,username:i.username})}),[]),OD=(e,t)=>e.reduce(((e,i)=>{const n=[],r=i.addresses&&i.addresses[0],s=i.fqdns&&i.fqdns.length>0,a=t.iceUdpAddressType,o=t.iceServerTransport;if(!r&&!s)return e;if(o.includes("udp")&&i.udpPort){const e=!s||"fqdn"!==a&&r?r:i.fqdns[0];n.push(`stun:${e}:${i.udpPort}`)}return o.includes("tls")&&i.tlsPort&&s&&n.push(`turns:${i.fqdns[0]}:${i.tlsPort}`),e.concat({urls:n,credential:i.password,username:i.username})}),[]),kD=class{constructor(e,t,i,n,r,s,a,o){this.session=e,this.context=t,this.diagnostics=i,this.sessionOperationQueue=n,this.callback=r,this.sessionCallbacks=s,this.configProvider=a,this.relayManager=o,this.wasConnected=!1,this.isDisconnected=!1,this.isReconnectConference=!1,this.escalationType=0,this._isSignalingStable=!0,this.reconnectDelayTime=0,this._isReconnectScheduled=!1,this.isDisposing=!1,this.isWaitingForNetwork=!1,this.onOnline=async()=>{this.logger.safe.info("onOnline: Network is up"),this.diagnostics.registerState("networkOnline"),this.isOnlineDeferred?.resolve(),this.isOnlineDeferred=null},this.onOffline=()=>{this.logger.safe.info("onOffline: Network is down"),this.diagnostics.registerState("networkOffline"),this.isOnlineDeferred=Om()},this.logger=t.getLogger().createChild("ReconnectManagerV2"),this.ufdManager=t.getUfdManager(),this.session.callbacks=s,this.reconnectManagerMessageQueue=new PD(s),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)}get isOnline(){return!this.isOnlineDeferred}async createRelayProber(){if(!this._relayProber){const e=Date.now(),t=OD(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config),i=Date.now()-e;this.logger.safe.info(`RelayProber configuration fetched in ${i} ms`),i>5e3&&this.diagnostics.registerState("relayConfigFetched"),this._relayProber=new MD(t,this.logger.createChild("RelayProber"))}return this._relayProber}dispose(){this.isDisposing=!0,window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline),this._relayProber?.dispose(),this.isOnlineDeferred?.reject(new Error("dispose")),this.reconnectTimer&&this.resetReconnectTimer()}get settings(){return(this.reconnectSession||this.session).getSessionConfig().config}getCurrentSession(){return this.reconnectSession||this.session}getMainSession(){return this.session||this.reconnectSession}getReconnectSession(){return this.reconnectSession}async onIceDisconnect(e){if(this.wasConnected)this.raiseReconnectEvent("Bad",e);else if(!this.settings.reconnectWithNoRelays&&!this.session.hasRelayCandidates())return void this.onReconnectFailed("no relays",e);if(this.isDisconnected=!0,!this.isReconnecting()&&!this.isWaitingForNetwork)return this.logger.safe.info(`[${e}] reconnect attempt after iceDisconnect error`),this.session.isFailed()&&this.diagnostics.registerState("failed"),this.diagnostics.registerReconnect("attempted"),this.reconnectAsync(e)}onTransportDisconnect(e){this.isDisconnected=!0,this.wasConnected&&(this.diagnostics.registerState("disconnected"),this.handleTmpConnectivityLoss(e))}onConnected(e){this.isDisconnected=!1,this.logger.safe.info(`[${e}] set allow UFD`),this.diagnostics.registerState("connected"),this.raiseReconnectEvent("Good",e),this.wasConnected=!0,this._relayProber?.finalize()}onNegotiationCompletedAsync(e){return this.logger.safe.info(`[${e}] handle negotiation completed`),this.setSignalingState(!0),this.isReconnecting()&&(this.diagnostics.registerRetarget("completed"),2===this.escalationType&&this.blockCurrentSession(e)),Promise.resolve()}async onSessionErrorOccurred(e,t){this.logger.safe.info(`[${t}] handle session error`,Ve(e)),await this.rejectReconnect(t),this.isReconnectAllowed()?await this.scheduleReconnectRetry(t,!1,!1):this.callback.onSessionErrorOccurred(e,t,this.wasConnected)}onNegotiationRejection(e,t){this.logger.safe.info(`[${t}] handle negotiation rejection`),this.diagnostics.registerRetarget("rejected");const i=1===this.escalationType;return this.rejectReconnect(t).then((()=>{const n=e.type===Qe.RENEGOTIATION_ERROR.glare&&i;(e.type!==Qe.RENEGOTIATION_ERROR.glare||i)&&(this.isRecoverableError(e.type)||n?this.scheduleReconnectRetry(t,n,i):this.onReconnectFailed(Ve(e),t))}))}async ensureNetwork(e){const t=this.isOnline;if(!this.isOnline){this.logger.safe.info(`[${e}] waiting for network...`);try{await this.isOnlineDeferred.promise}catch(t){return void this.logger.safe.info(`${e} call disposed while waiting for network`)}this.logger.safe.info(`[${e}] network seems up`)}if(this.isDisconnected){const i=await this.createRelayProber(),n=await i.ensureOnline();this.logger.safe.info(`[${e}] probing complete in ${n} ms`),this.diagnostics.registerState("relaysUp"),t&&n<1e3&&this.logger.safe.info(`[${e}] looks like network failed on remote side, recovery was quick`)}}oldSessionIsOnline(e){return!!this.session?.isConnected()&&(this.logger.safe.info(`[${e}] old session recovered`),this.isReconnecting()||this.diagnostics.registerReconnect("connected"),!0)}async waitForNetworkAndTryLightweightRecovery(e){const t=this.oldSessionIsOnline(e);if(t||!this.settings.reconnectWithProbes)return t;this.setReconnectTimer(),this.isWaitingForNetwork=!0;const i=this.getMaxNetworkWaitTime();return this.logger.safe.info(`[${e}] can wait up to ${i} ms`),await Promise.race([this.ensureNetwork(e),yi(i)]),this.isWaitingForNetwork=!1,this.session&&(this.session.isConnected()||this.session.isFailed()||(this.logger.safe.info(`[${e}] giving session a moment to recover`),await yi(this.settings.reconnectWaitTimeAfterProbe)),this.oldSessionIsOnline(e))?(this.resetReconnectTimer(),!0):this.checkIfTimerFailed(e)?(this.logger.safe.info(`[${e}] session reconnect timer reached during network checks`),!0):!!this.isDisposing&&(this.logger.safe.info(`[${e}] session is disposed`),!0)}reconnectAsync(e,t=!1,i=!1){return this.logger.safe.info(`[${e}] queueing reconnect, force=${t}, escalation=${i}`),this.diagnostics.registerReconnectAttempt(i?"local escalation":"out"),this._isReconnectScheduled=!0,i&&(this.escalationType=1),this.sessionOperationQueue.queueOperation((async()=>{if(this._isReconnectScheduled=!1,t||!await this.waitForNetworkAndTryLightweightRecovery(e))return this.isReconnecting()?(this.logger.safe.info(`[${e}] ongoing reconnect is in progress`),void this.sessionOperationQueue.completeCurrentOperation()):(this.diagnostics.registerState("reconnect"),await this.initReconnect(e),await this.reconnectSession.configureModalitiesAsync(this.getConfiguredModalities(),e),void this.sessionOperationQueue.completeCurrentOperation());this.sessionOperationQueue.completeCurrentOperation()}),e)}async acceptReconnectStartAsync(e,t){return this.logger.safe.info(`[${t}] accepting reconnect`),this.diagnostics.registerRetarget("incoming"),e?(this.escalationType=2,this.diagnostics.registerEscalation("attempted")):(!this.isReconnecting()&&this.isDisconnected?this.diagnostics.registerReconnect("attempted"):this.isReconnecting()&&await this.rejectReconnect(t),this.diagnostics.registerState("reconnect"),this.diagnostics.registerReconnectAttempt("in")),this.initReconnect(t)}acceptReconnectFinish(e){const t=this.getConfiguredModalities();return this.reconnectSession.configureModalitiesAsync(t,e).then((()=>t))}isReconnecting(){return!!this.reconnectSession}isReconnectScheduled(){return this._isReconnectScheduled}cleanUp(){this.sessionCallbacks=null,this.reconnectSession=null}async terminateAsync(e){try{await(this.session?.terminate(e,{}))}catch{}try{await this.terminateReconnectSessionAsync(e,!0)}catch{}this.cleanUp()}completeReconnect(e){return this.logger.safe.info(`[${e}] completing reconnect`),2===this.escalationType&&(this.unblockCurrentSession(),this.diagnostics.registerEscalation("completed")),this.escalationType=0,this.reconnectSession&&(this.context.config.isConference=this.isReconnectConference,this.disposeActiveSession(e),this.session=this.reconnectSession,this.reconnectManagerMessageQueue.clear(),this.diagnostics.registerReconnectAttemptStatus("completed"),this._isSignalingStable||this.diagnostics.registerRetarget("completed"),this.isDisconnected&&this.diagnostics.registerReconnect("connected"),this.resetReconnectTimer(),this.reconnectDelayTime=0,this.reconnectSession=null,this.negotiationPausePromise=null,this.session.callbacks=this.sessionCallbacks||{}),Promise.resolve()}async rejectReconnect(e){this.logger.safe.info(`[${e}] rejecting reconnect`),this.setSignalingState(!1),2===this.escalationType&&this.diagnostics.registerEscalation("rejected"),this.escalationType=0,this.reconnectSession&&(await this.terminateReconnectSessionAsync(e,!1),this.diagnostics.registerReconnectAttemptStatus("rejected")),this.session&&(this.reconnectManagerMessageQueue.flush(),this.session.callbacks=this.sessionCallbacks,this.unblockCurrentSession())}configureModalitiesAsync(e,t){this.lastKnownConfiguredModalities=e;const i=[];return this.session&&i.push(this.session.configureModalitiesAsync(e,t)),this.reconnectSession&&i.push(this.reconnectSession.configureModalitiesAsync(e,t)),Promise.all(i).then((()=>Promise.resolve()))}canSendDtmf(){return this.getMainSession().canSendDtmf()}getExtensionsManager(){return this.getMainSession().getExtensionsManager()}muteHold(e,t){this.getMainSession().muteHold(e,t)}muteInputAsync(e){return this.getMainSession().muteInputAsync(e)}unmuteInputAsync(e){return this.getMainSession().unmuteInputAsync(e)}muteOutputAsync(e){return this.getMainSession().muteOutputAsync(e)}unmuteOutputAsync(e){return this.getMainSession().unmuteOutputAsync(e)}_deviceSelectionChanged(){this.session&&this.session.deviceSelectionChanged(),this.reconnectSession&&this.reconnectSession.deviceSelectionChanged()}disposeActiveSession(e){if(this.session&&this.isReconnecting()){this.logger.safe.info(`[${e}] About to dispose current session...`);const t=this.session;return this.lastKnownConfiguredModalities=this.session.getConfiguredModalities(),t.callbacks=this.reconnectManagerMessageQueue.queueCallbacks,t.move(this.reconnectSession,e),this.session=null,t.terminate(e,{},!1)}return Promise.resolve()}registerRetargetOutgoing(){this.diagnostics.registerRetarget("outgoing")}isSignalingStable(){return this._isSignalingStable}getConfiguredModalities(){return this.getMainSession().getConfiguredModalities()||this.lastKnownConfiguredModalities}checkIfTimerFailed(e){return!(this.isReconnectAllowed()||this.session&&!this.session.isFailed()||(this.onReconnectFailed("the time limit was reached",e),0))}async scheduleReconnectRetry(e,t,i){const n=this.getReconnectDelayTime();if(this.logger.safe.info(`[${e}}] scheduling reconnect retry attempt in ${n}`),await yi(n),t||!this.checkIfTimerFailed(e))return this.reconnectAsync(e,i,i)}isRecoverableError(e){return Qe.RENEGOTIATION_ERROR.media===e||Qe.RENEGOTIATION_ERROR.signaling===e}async resetReconnectSession(e){this.logger.safe.info(`[${e}] Resetting reconnect session. Session exists: old: ${!!this.session}, new: ${!!this.reconnectSession}`),this.isReconnectConference=0!==this.escalationType||this.context.config.isConference;const t=0!==this.escalationType||this.context.config.isConference&&this.wasConnected&&!this.isDisconnected,i=this.getMainSession(),n=this.configProvider.getConfigView(this.isReconnectConference,i.getSessionConfig()),r=i.clone(t,n);r.callbacks={...this.sessionCallbacks,onTransportConnected:e=>{2!==this.escalationType&&this.completeReconnect(e),this.raiseReconnectEvent("Good",e),this.sessionCallbacks.onTransportConnected(e)}},this.session&&(this.session.callbacks={...this.reconnectManagerMessageQueue.queueCallbacks,onSessionErrorOccurred:(e,t)=>(e.type!==Qe.MEDIA_ERROR.iceConnectionError&&this.reconnectManagerMessageQueue.queueCallbacks.onSessionErrorOccurred(e,t),Promise.resolve())}),this.reconnectSession&&(this.reconnectSession.move(r,e),this.logger.safe.info(`[${e}] reconnect session still exists during reconnect clone operation`),await this.terminateReconnectSessionAsync(e,!1)),this.logger.safe.info(`[${e}] New session reset.`),this.reconnectSession=r}async initReconnect(e){this.logger.safe.info(`[${e}] initiate reconnect`),this.setReconnectTimer(),await this.resetReconnectSession(e),this.setSignalingState(!1),this.session&&(this.blockCurrentSession(e),await Promise.all([this.reconnectSession.muteInputAsync(e),this.reconnectSession.muteOutputAsync(e)]))}blockCurrentSession(e){this.negotiationPausePromise=this.session.pauseNegotiations(e)}unblockCurrentSession(){this.negotiationPausePromise&&(this.negotiationPausePromise.resolve(),this.negotiationPausePromise=null)}raiseReconnectEvent(e,t){this.ufdManager.signalEvent("NetworkReconnect",e,"Audio",!0,t)}async terminateReconnectSessionAsync(e,t){if(this.reconnectSession){const i=new PD(this.sessionCallbacks);this.reconnectSession.callbacks={...i.queueCallbacks,onTerminated:t?this.sessionCallbacks.onTerminated:i.queueCallbacks.onTerminated},await this.reconnectSession.terminate(e,{},!1),i.clear(),this.reconnectSession=null}}setReconnectTimer(){const e=this.wasConnected?this.settings.reconnectTimeLimit:this.settings.initialReconnectTimeLimit;e>0&&!this.reconnectTimer&&(this.reconnectTimerStart=Date.now(),this.reconnectTimer=window.setTimeout((()=>this.resetReconnectTimer()),e))}resetReconnectTimer(){clearTimeout(this.reconnectTimer),this.reconnectTimer=null}isReconnectAllowed(){return!!this.reconnectTimer&&!this.isDisposing}getReconnectDelayTime(){return 1e3*Math.min(++this.reconnectDelayTime,this.settings.maxReconnectDelayTime)}getMaxNetworkWaitTime(){const e=this.reconnectTimerStart>0?Date.now()-this.reconnectTimerStart:0;return Math.max(this.settings.reconnectTimeLimit-e,0)}onReconnectFailed(e,t){this.callback.onSessionErrorOccurred({type:Qe.MEDIA_ERROR.iceConnectionError,detail:`Reconnect failed, error - ${Ve(e)}`},t,this.wasConnected)}setSignalingState(e){this._isSignalingStable=e}async handleTmpConnectivityLoss(e){this.logger.safe.info(`[${e}] Session went into disconnected state, giving it ${this.settings.losingConnectivityTimeoutMs}ms to recover`),-1!==this.settings.losingConnectivityTimeoutMs&&(await yi(this.settings.losingConnectivityTimeoutMs),this.isDisconnected&&this.raiseReconnectEvent("Poor",e)),this.isDisconnected&&this.settings.reconnectOnDisconnect&&(this.logger.safe.info(`[${e}] Session is still down, triggering reconnect`),this.onIceDisconnect(e))}},ND=class{constructor(e,t){this.stats=e,this.diagnostics=t}set mediaLegId(e){this.stats.setMediaLegId(e.process()),this.diagnostics&&(this.diagnostics.mediaLegId=e)}set isMultiParty(e){e&&this.stats.setMultiParty(),this.diagnostics&&(this.diagnostics.isMultiParty=e)}set allowedModalities(e){this.stats.setSendModalities(e),this.diagnostics&&(this.diagnostics.allowedModalities=e)}set sessionError(e){this.stats.setError(e),this.diagnostics&&(this.diagnostics.sessionError=e)}set finalAnswerTime(e){this.stats.setFinalAnswerTimestamp(e),this.diagnostics&&(this.diagnostics.finalAnswerTime=e)}set dtmfResult(e){this.stats.dtmfResult(e),this.diagnostics&&(this.diagnostics.dtmfResult=e)}set swMute(e){this.stats.setSwMute(e),this.diagnostics&&(this.diagnostics.swMute=e)}set speakerMute(e){this.stats.setSpeakerMute(e),this.diagnostics&&(this.diagnostics.speakerMute=e)}set hwSilent(e){this.stats.setHwSilent(e),this.diagnostics&&(this.diagnostics.hwSilent=e)}set isSpeaking(e){this.stats.setSpeakingState(e),this.diagnostics&&(this.diagnostics.isSpeaking=e)}set iceConnectedStateTimestamp(e){this.stats.setIceConnectedStateTimestamp(e),this.diagnostics&&(this.diagnostics.iceConnectedStateTimestamp=e)}set iceInitTime(e){this.stats.setIceInitTimestamp(e),this.diagnostics&&(this.diagnostics.iceInitTime=e)}set ETag(e){this.stats.setETag(e),this.diagnostics&&(this.diagnostics.ETag=e)}set configIds(e){this.stats.setConfigIds(e),this.diagnostics&&(this.diagnostics.configIds=e)}set relay(e){this.stats.setRelay(e),this.diagnostics&&(this.diagnostics.relay=e)}negotiationStart(e){switch(this.diagnostics?.negotiationStart(e),e){case"Offering":this.stats.negotiation.offering.started();break;case"Answering":this.stats.negotiation.answering.started()}}negotiationCompleted(e){this.stats.negotiation.current.completed(e),this.diagnostics?.negotiationCompleted(e)}negotiationRejected(){this.stats.negotiation.current.rejected(),this.diagnostics?.negotiationRejected()}registerTransportConnected(){this.stats.registerTransportConnected(),this.diagnostics?.registerTransportConnected()}registerTransportDisconnected(){this.stats.registerTransportDisconnected(),this.diagnostics?.registerTransportDisconnected()}registerTransportFailed(){this.stats.registerTransportFailed(),this.diagnostics?.registerTransportFailed()}registerRollbackEvent(e){this.stats.registerRollbackEvent(e),this.diagnostics?.registerRollbackEvent(e)}registerRawMediaAccess(e,t,i){"send"===t?this.stats.registerSetInputRawMedia(i):this.stats.registerOutputRawMediaAccess(),this.diagnostics?.registerRawMediaAccess(e,t,i)}registerQualityStateChangedEvent(e){this.stats.registerQualityStateChangedEvent(e),this.diagnostics?.registerQualityStateChangedEvent(e)}terminated(e){this.stats.terminated(e),this.diagnostics?.terminated(e)}},LD=class{constructor(e){this.logger=e,this.operationQueue=null,this.currentOperationDeferred=null,this.operationQueue=new $A(this.logger)}queueOperation(e,t=Te()){this.logger.safe.info(`[${t}] queueing operation`);const i=new Yu,n=this.operationQueue.add((()=>(this.currentOperationDeferred=i,e())),t);return this.operationQueue.add(i,t),n}completeCurrentOperation(){this.currentOperationDeferred&&(this.logger.safe.info("completing operation"),this.currentOperationDeferred.resolve())}},xD=class extends ze{constructor(e,t,i,n,r,s,a,o=i.getLogger().createChild("SessionV2",t)){super(o),this.session=e,this.context=i,this.callback=n,this.statistics=r,this.configProvider=s,this.diagnostics=a,this.logger=o,this.audioStreamStates={[Qe.STREAMING_STATE.inactive]:[Qe.STREAMING_STATE.started,Qe.STREAMING_STATE.active,Qe.STREAMING_STATE.failed],[Qe.STREAMING_STATE.started]:[Qe.STREAMING_STATE.active,Qe.STREAMING_STATE.removed,Qe.STREAMING_STATE.stopped,Qe.STREAMING_STATE.failed],[Qe.STREAMING_STATE.active]:[Qe.STREAMING_STATE.removed,Qe.STREAMING_STATE.stopped,Qe.STREAMING_STATE.failed]},this.mediaLegId=new AD,this.rejectedNegotiations=0,this.negotiationState=null,this.audioStreamState=Qe.STREAMING_STATE.inactive,this.deviceManagerDisposables=[],this.visibilityChangedHandler=()=>{if(this.logger.safe.debug(`document.visibilityState changed: ${document.visibilityState}`),"visible"===document.visibilityState&&this.pcClosedInfo){const e=this.pcClosedInfo;this.pcClosedInfo=null,Date.now()<e.timestamp+this.configProvider.config.reconnectWakeupTimeLimit?(this.logger.safe.info(`[${e.causeId}] start reconnect after wakeup`),this.startReconnect(e.causeId)):(this.logger.safe.info(`[${e.causeId}] terminate a call after wakeup because allowed time limit for reconnect exceeded`),this.endCallOnFailure(e.mediaError,e.causeId))}},this.ufdManager=i.getUfdManager(),this.ufdManagerDisposable=this.ufdManager.on("onQualityChanged",(e=>this.qualityChanged(e))),this.sessionOperationQueue=new LD(this.logger),this.mediaLegId=new AD,this.diagnosticsWrapper=new ND(this.statistics,this.diagnostics),this.statistics.setId(t),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.diagnosticsWrapper.ETag=this.configProvider.ETag,this.diagnosticsWrapper.configIds=this.configProvider.ecsConfigIds,this.diagnosticsWrapper.isMultiParty=!!i.config.isConference,this.recoverableErrors=this.configProvider.config.recoverableMediaErrors.split(","),this.forceReconnectErrors=this.configProvider.config.forceReconnectErrors.split(",");const c=this.getSessionCallbacks();e.callbacks=c,e.relayManagerProvider=this,this.reconnectManager=new kD(e,i,new wD(this.statistics,this.diagnostics?new bD:void 0,this.diagnostics),this.sessionOperationQueue,this.getReconnectManagerCallbacks(),c,this.configProvider,this.getRelayManager()),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesPermissionChanged",(()=>this.diagnosticsWrapper.allowedModalities=this.getAllowedModalities()))),this.deviceManagerDisposables.push(this.deviceManager.on("onSelectedDevicesChanged",(()=>this.deviceSelectionChanged()))),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesChanged",((e,t)=>this.deviceListChanged(t)))),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount()),this.diagnostics&&(this.diagnostics.relayManager=this.getRelayManager()),this.ufdManager.applyCurrentState((e=>this.qualityChanged(e))),document.addEventListener("visibilitychange",this.visibilityChangedHandler),this.requestWakeLock()}async requestWakeLock(){if(Bp.isWakeLockSupported()&&this.configProvider.config.useWakeLockApi)try{this.wakeLock=await window.navigator.wakeLock.request("screen")}catch(e){this.logger.safe.info(`Wakelock request failed - ${e.message}`)}}enableTeamsRealTimeTelemetry(){this.realtimeTelemetryInterval||(this.logger.safe.info("teams realtime telemetry is enabled"),this.getSessionCallbacks().onTeamsRealtimeTelemetryReport(),this.realtimeTelemetryInterval=window.setInterval((()=>{this.getSessionCallbacks().onTeamsRealtimeTelemetryReport()}),1e3*this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval))}getMediaStatsReport(){return this.diagnostics?.mediaStatsReport}createOfferAsync(e){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Offering");try{const t=await this.getCurrentSession().createOfferAsync(e);return this.updateSelectedDevices(),t.mediaLegId=this.mediaLegId.process(t.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.reconnectManager.isReconnecting()&&!this.reconnectManager.isSignalingStable()&&(this.reconnectManager.registerRetargetOutgoing(),t.newOffer=!0),t}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}),e)}setCallConstraints(e,t){return this.getCurrentSession().setCallConstraints(e,t)}processOfferAsync(e,t){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Answering"),e.mediaLegId=this.mediaLegId.process(e.mediaLegId);try{e.newOffer&&await this.reconnectManager.acceptReconnectStartAsync(e.escalationOccurring,t);const i=await this.getCurrentSession().processOfferAsync(e,t);if(e.newOffer){const e=await this.reconnectManager.acceptReconnectFinish(t);return i.sharing===Qe.MEDIA_STATE.sendReceive&&(i.sharing=e.sharing===Qe.MEDIA_STATE.send?Qe.MEDIA_STATE.send:Qe.MEDIA_STATE.receive),i}return i}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}),t)}async processAnswerAsync(e,t,i,n){try{return await this.getCurrentSession().processAnswerAsync(e,t,i,n)}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}async completeNegotiationAsync(e){this.rejectedNegotiations=0;try{const t=await this.getCurrentSession().completeNegotiationAsync(e);return this.negotiationState=t,this.diagnosticsWrapper.finalAnswerTime=Date.now(),this.diagnosticsWrapper.negotiationCompleted?.(t.activeModalities),await this.reconnectManager.onNegotiationCompletedAsync(e),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}ignoreNotReconnectError(e){return e.detail?.type!==Qe.MEDIA_ERROR.incompatibleOriginator}async rejectNegotiationAsync(e,t){this.logger.safe.info(`[${t}] rejectNegotiationAsync`,e);try{if(this.reconnectManager.isReconnecting()&&this.ignoreNotReconnectError(e))return await this.reconnectManager.onNegotiationRejection(e,t),this.registerNegotiationRejection(this.negotiationState),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState;{const i=await this.getCurrentSession().rejectNegotiationAsync(e,t,this.isRenegotiationAllowed(e.type));return this.sessionOperationQueue.completeCurrentOperation(),this.registerNegotiationRejection(i),i}}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}completeEscalationAsync(e){return this.reconnectManager.completeReconnect(e)}rejectEscalationAsync(e){return this.reconnectManager.rejectReconnect(e)}async terminate(e,t){this.logger.safe.info(`terminate reject reason: ${JSON.stringify(t||"")}`),this.registerVideoEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Video","StatsQuery")),this.registerAudioEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Audio")),this.statistics.setPermissionStates(await this.deviceManager.getKnownPermissionStates()),this.diagnosticsWrapper.terminated(t);const i=()=>this.cleanUp();return this.reconnectManager.terminateAsync(e).then(i,i)}async getStatsAsync(e){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.getMainSession().getStatsAsync(e).then((e=>this.prepareStats(e)))}getLastKnownStats(e=!1){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.prepareStats(this.getMainSession().getLastKnownStats(e),e)}getCallTechnicalInfo(){return this.diagnostics?.realtimeTelemetryReport}async createAnswerAsync(e,t){try{const i=await this.getCurrentSession().createAnswerAsync(e,t);return this.updateSelectedDevices(),i.mediaLegId=this.mediaLegId.process(i.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,i}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}configureModalitiesAsync(e,t){return Xe(e,((t,i)=>{t||delete e[i]})),this.reconnectManager.configureModalitiesAsync(e,t)}getAllowedModalities(){return this.deviceManager.getAllowedModalities()}createRemoteRenderer(e){return this.getMainSession().createRemoteRenderer(e)}async sendDtmf(e){try{const t=await this.getMainSession().sendDtmf(e);return this.diagnosticsWrapper.dtmfResult=!0,t}catch(e){throw this.diagnosticsWrapper.dtmfResult=!1,e}}canSendDtmf(){return this.reconnectManager.canSendDtmf()}getExtensionsManager(){return this.reconnectManager.getExtensionsManager()}muteHold(e,t){this.reconnectManager.muteHold(e,t)}muteInputAsync(e){return this.diagnosticsWrapper.swMute=!0,this.ufdManager.setSwMute(!0),this.reconnectManager.muteInputAsync(e)}unmuteInputAsync(e){return this.diagnosticsWrapper.swMute=!1,this.ufdManager.setSwMute(!1),this.reconnectManager.unmuteInputAsync(e)}muteOutputAsync(e){return this.diagnosticsWrapper.speakerMute=!0,this.reconnectManager.muteOutputAsync(e)}unmuteOutputAsync(e){return this.diagnosticsWrapper.speakerMute=!1,this.reconnectManager.unmuteOutputAsync(e)}getAcceptedTypes(){return this.reconnectManager.getCurrentSession().getAcceptedTypes()}useNullAudioStreamClient(){this.getCurrentSession().useNullAudioStreamClient()}createAudioElement(e){this.getCurrentSession().createAudioElement(e)}getIncomingRawAudioStream(){return this.diagnosticsWrapper.registerRawMediaAccess("audio","recv",!0),this.getCurrentSession().getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.getCurrentSession().getUnmixedAudioProvider()}deviceSelectionChanged(){this.updateSelectedDevices(),this.reconnectManager._deviceSelectionChanged()}registerDeviceTelemetryEvent(e){this.getCurrentSession().onDeviceEvent(e),this.statistics.registerDeviceTelemetryEvent(e)}registerVideoEffectsTelemetryEvent(e){this.statistics.registerVideoEffectsTelemetryEvent(e)}registerAudioEffectsTelemetryEvent(e){this.statistics.registerAudioEffectsTelemetryEvent(e)}reconnectAsync(e,t=!1){return this.reconnectManager.reconnectAsync(e,!0,t)}isReconnecting(){return this.reconnectManager.isReconnecting()}getRelayManager(){return this.relayManager??(this.relayManager=new RD(this.context.maContext.getRelayManager(),this.diagnosticsWrapper))}getSessionConfig(){return this.reconnectManager.getCurrentSession().getSessionConfig()}getDiagnostics(){return this.diagnostics}getLocalMediaTrackId(e){return this.reconnectManager.getMainSession().getLocalMediaTrackId(e)}getSubscriptionManager(){return this.getCurrentSession().getSubscriptionManager()}getDisabledModalities(){return this.getCurrentSession().getDisabledModalities()}configureSpatialAudio(e,t){this.getCurrentSession().configureSpatialAudio(e,t)}setParticipantSpatialAudioPositions(e,t){this.getCurrentSession().setParticipantSpatialAudioPositions(e,t)}startMediaDescriptionsUpdateAsync(e){return this.getCurrentSession().startMediaDescriptionsUpdateAsync(e)}completeMediaDescriptionsUpdateAsync(e){return this.getCurrentSession().completeMediaDescriptionsUpdateAsync(e)}rejectMediaDescriptionsUpdateAsync(e,t){return this.getCurrentSession().rejectMediaDescriptionsUpdateAsync(e,t)}processNotification(e,t){this.session.processNotification(e,t)}async cleanUp(){this.callback=null,this.deviceManagerDisposables.forEach((e=>e.dispose())),this.ufdManagerDisposable.dispose(),this.reconnectManager.dispose(),this.pcClosedInfo=null,document.removeEventListener("visibilitychange",this.visibilityChangedHandler),window.clearInterval(this.realtimeTelemetryInterval),this.wakeLock&&(await this.wakeLock.release(),this.wakeLock=null)}updateSelectedDevices(){const e=this.deviceManager.getSelectedDevices(),t=e=>e?this.deviceManager.getDeviceNameAsync(e).then((e=>_t(e,this.configProvider.config.devices.piiSafeWords))):Promise.resolve("none");Promise.all([t(e.microphone),t(e.speaker),t(e.camera)]).then((([e,t,i])=>{this.statistics.setUsedDevices({microphone:e,speaker:t,camera:i})}))}getCurrentSession(){return this.reconnectManager.getCurrentSession()}getMainSession(){return this.reconnectManager.getMainSession()}setAudioStreamState(e,t,i){this.isAudioStateValid(e)?this.raiseAudioStateChanged(e,t,i):this.logger.safe.error(`[${t}] audio state transition is invalid: ${this.audioStreamState} -> ${e}`)}isAudioStateValid(e){return this.audioStreamStates[this.audioStreamState].indexOf(e)>=-1}raiseAudioStateChanged(e,t,i){if(this.logger.safe.info(`[${t}] audio state changed to ${e}`),this.callback.onAudioStateChanged){const t={content:"audio",direction:"receive",stream:e};this.callback.onAudioStateChanged(t,i)}}getReconnectManagerCallbacks(){return{onSessionErrorOccurred:(e,t,i)=>{this.isNetworkMediaError(e)&&!i&&this.ufdManager.raisePendingWhitelistingUFD(),this.endCallOnFailure(e,t)}}}isNetworkMediaError(e){return e.type===Qe.MEDIA_ERROR.iceConnectionError||e.type===Qe.MEDIA_ERROR.noNetworkError}isRecoverableMediaError(e){return this.recoverableErrors.includes(e.type)}startReconnect(e=Te()){return this.reconnectManager.onIceDisconnect(e)}shouldForceReconnect(e){return this.forceReconnectErrors.includes(e.type)}isUnexpectedPcClose(e){return e.type===Qe.MEDIA_ERROR.unexpectedClose}getSessionCallbacks(){return this.sessionCallbacks||(this.sessionCallbacks={onTerminated:()=>{this.logger.safe.warn("call onTerminated"),this.event("onTerminated").raise(this)},onSessionErrorOccurred:(e,t=Te())=>this.isUnexpectedPcClose(e)?this.handlePcClosed(e,t):this.shouldForceReconnect(e)?this.reconnectManager.reconnectAsync(t,!0):this.isRecoverableMediaError(e)?this.reconnectManager.isReconnecting()?this.reconnectManager.onSessionErrorOccurred(e,t):this.startReconnect(t):(this.endCallOnFailure(e,t),Promise.resolve()),onNegotiationRequired:e=>this.callback.onNegotiationRequired(e),onAudioHwSilentChanged:e=>{this.diagnosticsWrapper.hwSilent=e},onAudioStateChanged:(e,t)=>{this.setAudioStreamState(e,t)},onTransportConnected:(e=Te())=>{this.logger.safe.info(`[${e}] Transport connectivity established`),this.ufdManager.cancelPendingWhitelistingUFD(),this.reconnectManager.onConnected(e),this.diagnosticsWrapper.registerTransportConnected(),this.diagnosticsWrapper.iceConnectedStateTimestamp=Date.now(),this.callback?.onTransportConnected(e)},onTransportDisconnected:(e=Te())=>{this.logger.safe.warn(`[${e}] Transport connectivity lost`),this.reconnectManager.onTransportDisconnect(e),this.diagnosticsWrapper.registerTransportDisconnected()},onTransportFailed:()=>{this.diagnosticsWrapper.registerTransportFailed()},onTransportInitialized:()=>{this.diagnosticsWrapper.iceInitTime=Date.now()},onUpdateMediaDescriptionsRequired:e=>this.callback.onUpdateMediaDescriptionsRequired(e),onTeamsRealtimeTelemetryReport:()=>this.callback.onRealtimeTelemetryReport()}),this.sessionCallbacks}registerNegotiationRejection(e){this.rejectedNegotiations++,this.diagnosticsWrapper.negotiationRejected?.(),e.rollback&&this.diagnosticsWrapper.registerRollbackEvent(e.rollback)}isRenegotiationAllowed(e){return this.rejectedNegotiations<this.context.configProvider.config.renegotiationAttempts&&!this.reconnectManager.isReconnectScheduled&&(Qe.RENEGOTIATION_ERROR.signaling===e||Qe.RENEGOTIATION_ERROR.media===e)}prepareStats(e,t=!1){this.statistics.setDeviceList(this.deviceManager.getDeviceDescriptions(),this.deviceManager.getDeviceListDebugInfo()),this.statistics.setRelayManagerTimers(this.getRelayManager().getStats()),this.statistics.setVideoEffectStats(this.context.callDeviceManager.getDeviceManager("Video").effectsManager.getStats("Video","StatsQuery")),this.statistics.setAudioEffectStats(this.deviceManager.effectsManager.getStats("Audio"));const i=this.statistics.generateStatistics(e,this.mediaLegId,t);return this.configProvider.config.diagnostics.features.useNewerStatisticsMetrics&&(i.data.metrics=this.diagnostics?.telemetryReport?.data.metrics),i}deviceListChanged(e){e&&this.statistics.deviceChangedByPoll(),this.statistics.devicesChanged(),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount())}qualityChanged(e){const t=e.deviceManagerId;!t||this.context.callDeviceManager.hasDevice(t)?this.callback?.onQualityChanged&&(this.diagnosticsWrapper.registerQualityStateChangedEvent(e),"DeviceSpeakWhileMuted"===e.type&&(this.diagnosticsWrapper.isSpeaking="Good"!==e.value),this.callback.onQualityChanged(e)):this.logger.info(`${t} - is not added to Call, skipping UFD.`)}endCallOnFailure(e,t,i){this.callback&&(this.callback.onSessionErrorOccurred&&this.callback.onSessionErrorOccurred(e,t),this.diagnosticsWrapper.sessionError=e,this.setAudioStreamState(Qe.STREAMING_STATE.failed,t,i))}async handlePcClosed(e,t){const i=this.configProvider.config.reconnectWakeupTimeLimit;return this.logger.safe.info(`[${t}] handle unexpected PC closed event`,`visibilityState=${document.visibilityState}, wakeupLimit=${this.configProvider.config.reconnectWakeupTimeLimit}`),"visible"===document.visibilityState?this.startReconnect(t):i?void(this.pcClosedInfo={timestamp:Date.now(),causeId:t,mediaError:e}):this.endCallOnFailure(e,t,"suspended")}},UD=class{constructor(e){this.creationTime=e,this.records=[],this.activeRecord=null,this.activeAttempt=null,this.reconnectState=!1}getReport(){return this.records.length?JSON.stringify(this.records):""}isReconnecting(){return this.reconnectState}onReconnectStart(){this.reconnectState=!0,this.activeRecord||(this.activeRecord={attempts:[],endTime:null,startTime:Date.now()-this.creationTime},this.records.push(this.activeRecord))}onReconnectAttempt(e){if(!this.activeRecord)return null;this.activeAttempt={direction:e,status:!1,endTime:null,startTime:this.getTimestamp()},this.reconnectState=!0,this.activeRecord.attempts.push(this.activeAttempt)}onReconnectConnected(){if(!this.activeRecord)return null;this.reconnectState=!1,this.activeRecord.endTime=this.getTimestamp(),this.activeRecord=this.activeAttempt=null}onReconnectCompleted(){this.reconnectState=!1,this.resolveReconnectAttempt(!0)}onReconnectRejected(){this.resolveReconnectAttempt(!1)}resolveReconnectAttempt(e){this.activeAttempt&&this.activeRecord&&(this.activeAttempt.status=e,this.activeAttempt.endTime=this.getTimestamp())}getTimestamp(){return Date.now()-this.creationTime-this.activeRecord.startTime}},FD=window.navigator,VD=class{constructor(e="Good"){this.stopWatches=[],this.currentLevel=e,this.getStopWatch(e).start()}updateLevel(e){this.currentLevel!==e&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=e,this.getStopWatch(this.currentLevel).start())}getCount(e){const t=this.stopWatches[e];return t?t.count:0}getElapsed(e){const t=this.stopWatches[e];return t?t.elapsed:0}getStopWatch(e){let t=this.stopWatches[e];return t||(t=new xM,this.stopWatches[e]=t),t}},BD=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\:[0-9]{2,5})?$/),HD=RegExp(/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))(:[0-9]{2,5})?$/),$D=class{constructor(e,t,i){this.configProvider=e,this.callNumber=t,this.sessionDiagnostics=i,this.negotiation={offering:this.offering(),answering:this.answering(),current:this.current()},this.creationTime=Date.now(),this.negotiationCount=0,this.initialNegotiationCompleted=!1,this.activeModalities={},this.multiParty=!1,this.noIceCandidatesGoodEventCount=0,this.noIceCandidatesBadEventCount=0,this.noRelayIceCandidatesGoodEventCount=0,this.noRelayIceCandidatesBadEventCount=0,this.cameraInUseBadEventCount=0,this.cameraInUseGoodEventCount=0,this.microphoneInUseBadEventCount=0,this.microphoneInUseGoodEventCount=0,this.cameraFreezeStartEventCount=0,this.cameraFreezeEndEventCount=0,this.networkRecv=new VD,this.networkSend=new VD,this.retargetIncomingCount=0,this.retargetOutgoingCount=0,this.retargetCompletedCount=0,this.retargetRejectedCount=0,this.reconnectAttemptedCount=0,this.reconnectConnectedCount=0,this.escalationAttemptedCount=0,this.escalationCompletedCount=0,this.escalationRejectedCount=0,this.durationTimer=new xM,this.terminationReason={},this.terminationTime=0,this.sessionId="0",this.rejectedNegotiationCount=0,this.mediaError={type:"none",detail:"none"},this.incompatibleOffer=!1,this.dtmfSuccess=0,this.dtmfFailure=0,this.relay=null,this.relayManagerTimers=null,this.allowedAudioSend=!0,this.allowedVideoSend=!0,this.allowedScreensharingSend=!0,this.iceInitTime=0,this.finalAnswerTime=0,this.iceConnectedStateTime=0,this.usedDevices=null,this.deviceSelectionChangeCount=0,this.devicesChangeCount=0,this.devicesPollChangeCount=0,this.mute=new xM,this.osMute=new xM,this.hwSilent=new xM,this.isSpeaking=new xM,this.swMute=new xM,this.speakerMute=new xM,this.deviceTelemetryEvents=[],this.videoEffectsTelemetryEvents=new uw(this.configProvider.config.effectsTelemetryBufferSize),this.audioEffectsTelemetryEvents=new uw(this.configProvider.config.effectsTelemetryBufferSize),this.devicesCount=null,this.reconnectStats=new UD(this.creationTime),this.transportDisconnected=!1,this.transportReconnectedCount=0,this.ufds=[],this.mediaQosEnabled=!1,this.portRangeConfigured=!1,this.rollbackNegotiation=[],this.rawOutputAudioAccess={attempt:0,timer:new xM},this.rawInputAudioOverride={attempt:0,timer:new xM},this.connectionEffectiveTypeSeries=new uw(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionRttSeries=new uw(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionDownlinkSeries=new uw(this.configProvider.config.navConnectionNumSamplesToCollect),this.navigatorConnectionInterval=setInterval((()=>{const e=FD?.connection;e&&("number"==typeof e.downlink&&this.connectionDownlinkSeries.add(e.downlink),"number"==typeof e.rtt&&this.connectionRttSeries.add(e.rtt),"number"==typeof e.effectiveType&&this.connectionEffectiveTypeSeries.add(e.effectiveType))}),this.configProvider.config.navConnectionPollingInterval),this.durationTimer.start()}terminated(e){this.terminationReason=ct(e),this.terminationTime=Date.now(),this.durationTimer.stop(),this.osMute.stop(),this.swMute.stop(),this.hwSilent.stop(),this.isSpeaking.stop(),this.mute.stop(),this.speakerMute.stop(),this.rawInputAudioOverride.timer.stop(),this.rawOutputAudioAccess.timer.stop(),clearInterval(this.navigatorConnectionInterval)}setMultiParty(){this.multiParty=!0}updateCommonMute(){this.swMute.isRunning||this.osMute.isRunning?this.mute.start():this.mute.stop()}setDeviceList(e,t){this.deviceList=e.map((e=>({label:_t(e.label,this.configProvider.config.devices.piiSafeWords),kind:e.kind}))),t&&(this.deviceDebugStrings=ct(t))}setPermissionStates(e){this.permissionStates=e}setSwMute(e){e?this.swMute.start():this.swMute.stop(),this.updateCommonMute()}setSpeakerMute(e){e?this.speakerMute.start():this.speakerMute.stop()}setHwSilent(e){e?this.hwSilent.start():this.hwSilent.stop()}setSpeakingState(e){e?this.isSpeaking.start():this.isSpeaking.stop()}setETag(e){this.ETag=e}setConfigIds(e){this.configIds=e}setVideoEffectStats(e){e&&this.videoEffectsTelemetryEvents.add(e)}setAudioEffectStats(e){e&&this.audioEffectsTelemetryEvents.add(e)}registerQualityStateChangedEvent(e){switch(e.type){case"NoNetwork":"Good"===e.value?this.noIceCandidatesGoodEventCount++:this.noIceCandidatesBadEventCount++;break;case"NetworkRelaysNotReachable":"Good"===e.value?this.noRelayIceCandidatesGoodEventCount++:this.noRelayIceCandidatesBadEventCount++;break;case"DeviceCaptureNotFunctioning":"Good"===e.value?this.microphoneInUseGoodEventCount++:this.microphoneInUseBadEventCount++;break;case"VideoCapturerDeviceStartFailed":"Good"===e.value?this.cameraInUseGoodEventCount++:this.cameraInUseBadEventCount++;break;case"DeviceCaptureMute":"Audio"===e.mediaType&&("Bad"===e.value?this.osMute.start():this.osMute.stop(),this.updateCommonMute());break;case"NetworkRecvQuality":this.networkRecv.updateLevel(e.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(e.value);break;case"VideoCaptureDeviceFreeze":"Good"===e.value?this.cameraFreezeEndEventCount++:this.cameraFreezeStartEventCount++}"DeviceSpeakWhileMuted"!==e.type&&this.ufds.push({...e,timestamp:Date.now()-this.creationTime}),this.ufds.length>this.configProvider.config.maxStoredUFDCount&&this.ufds.shift()}registerRetargetIncoming(){this.retargetIncomingCount++}registerRetargetOutgoing(){this.retargetOutgoingCount++}registerRetargetCompleted(){this.retargetCompletedCount++}registerRetargetRejected(){this.retargetRejectedCount++}registerEscalationStart(){this.escalationAttemptedCount++}registerEscalationCompleted(){this.escalationCompletedCount++}registerEscalationRejected(){this.escalationRejectedCount++}registerRollbackEvent(e){e&&this.rollbackNegotiation.push({type:e.type,attempt:this.rollbackNegotiation.length+1,error:e.error?e.error:""})}registerReconnectAttempted(){this.reconnectAttemptedCount++,this.reconnectStats.onReconnectStart()}registerReconnectConnected(){this.reconnectConnectedCount++,this.reconnectStats.onReconnectConnected()}registerDeviceTelemetryEvent(e){e.timestamp=e.timestamp-this.creationTime,this.deviceTelemetryEvents.push(e)}registerVideoEffectsTelemetryEvent(e){e&&(e.timestamp=e.timestamp-this.creationTime,this.videoEffectsTelemetryEvents.add(e))}registerAudioEffectsTelemetryEvent(e){if(e){e.timestamp=e.timestamp-this.creationTime;const t=this.audioEffectsTelemetryEvents.items.pop();t&&this.audioEffectsChanged(t,e)&&this.audioEffectsTelemetryEvents.add(t),this.audioEffectsTelemetryEvents.add(e)}}audioEffectsChanged(e,t){return e.payload.fallback!==t.payload.fallback||void 0!==t.payload.userNoiseSuppressionMethod&&e.payload.userNoiseSuppressionMethod!==t.payload.userNoiseSuppressionMethod||void 0!==t.payload.userAudioEffect&&e.payload.userAudioEffect!==t.payload.userAudioEffect}registerReconnectAttempt(e){this.reconnectStats.onReconnectAttempt(e)}registerReconnectAttemptCompleted(){this.reconnectStats.onReconnectCompleted()}registerReconnectAttemptRejected(){this.reconnectStats.onReconnectRejected()}setMediaLegId(e){this.mediaLegId=e}setId(e){this.sessionId=e}setError(e){e.type===Qe.MEDIA_ERROR.incompatibleOffer&&(this.incompatibleOffer=!0),this.mediaError.type=e.type||Qe.MEDIA_ERROR.internalError,this.mediaError.detail=e.detail||e.toString()}setRelay(e){this.relay={address:e.addresses.join(),expires:e.expires,realm:e.realm,credentials:!(!e.username||!e.password),ports:[e.udpPort?`udp:${e.udpPort}`:"",e.tcpPort?`tcp:${e.tcpPort}`:"",e.tlsPort?`tls:${e.tlsPort}`:""].join(","),fqdns:e.fqdns?e.fqdns.join():"none"}}setRelayManagerTimers(e){this.relayManagerTimers=e}setSendModalities(e){this.allowedAudioSend=e.audio.some((e=>zp(e))),this.allowedVideoSend=e.video.some((e=>zp(e))),this.allowedScreensharingSend=e.sharing.some((e=>zp(e)))}setIceInitTimestamp(e){this.iceInitTime||(this.iceInitTime=e)}setFinalAnswerTimestamp(e){this.finalAnswerTime||(this.finalAnswerTime=e)}setIceConnectedStateTimestamp(e){this.iceConnectedStateTime||(this.iceConnectedStateTime=e)}dtmfResult(e){e?++this.dtmfSuccess:++this.dtmfFailure}setUsedDevices(e){this.usedDevices&&JSON.stringify(e)!==JSON.stringify(this.usedDevices)&&this.deviceSelectionChangeCount++,this.usedDevices=e}setDevicesCount(e){this.devicesCount=e}setMediaQosEnabled(e){this.mediaQosEnabled=e}setPortRangeConfigured(e){this.portRangeConfigured=e}devicesChanged(){this.devicesChangeCount++}deviceChangedByPoll(){this.devicesPollChangeCount++}registerOutputRawMediaAccess(){this.rawOutputAudioAccess.attempt++,this.rawOutputAudioAccess.timer.start()}registerSetInputRawMedia(e){this.rawInputAudioOverride.attempt++,e?this.rawInputAudioOverride.timer.start():this.rawInputAudioOverride.timer.stop()}getReport(){const e=this.usedDevices||{microphone:"none",speaker:"none",camera:"none"};return{RawOutputAudioAccessDurationRatio:this.getDurationRatio(this.rawOutputAudioAccess.timer.elapsed),RawOutputAudioAccessAttempted:this.rawOutputAudioAccess.attempt,RawInputAudioOverrideDurationRatio:this.getDurationRatio(this.rawInputAudioOverride.timer.elapsed),RawInputAudioOverrideAttempted:this.rawInputAudioOverride.attempt,SessionId:this.sessionId,CallNumber:this.callNumber,NoIceCandidatesBadEventCount:this.noIceCandidatesBadEventCount,NoIceCandidatesGoodEventCount:this.noIceCandidatesGoodEventCount,NoRelayIceCandidatesBadEventCount:this.noRelayIceCandidatesBadEventCount,NoRelayIceCandidatesGoodEventCount:this.noRelayIceCandidatesGoodEventCount,CameraInUseBadEventCount:this.cameraInUseBadEventCount,CameraInUseGoodEventCount:this.cameraInUseGoodEventCount,MicrophoneInUseBadEventCount:this.microphoneInUseBadEventCount,MicrophoneInUseGoodEventCount:this.microphoneInUseGoodEventCount,CameraFreezeStartEventCount:this.cameraFreezeStartEventCount,CameraFreezeEndEventCount:this.cameraFreezeEndEventCount,RetargetIncomingCount:this.retargetIncomingCount,RetargetOutgoingCount:this.retargetOutgoingCount,RetargetCompletedCount:this.retargetCompletedCount,RetargetRejectedCount:this.retargetRejectedCount,ReconnectAttemptedCount:this.reconnectAttemptedCount,ReconnectConnectedCount:this.reconnectConnectedCount,EscalationAttemptedCount:this.escalationAttemptedCount,EscalationCompletedCount:this.escalationCompletedCount,EscalationRejectedCount:this.escalationRejectedCount,CreationTime:this.getHpTimeFromMillis(this.creationTime),InitTime:this.getHpTimeFromMillis(this.creationTime),TerminationTime:this.getHpTimeFromMillis(this.terminationTime),CallDuration:this.getHpTimeFromMillis(this.getCurrentDuration()),InitialNegotiationType:this.initialNegotiationType||"none",InitialNegotiationCompleted:this.initialNegotiationCompleted,ActiveModalities:JSON.stringify(this.activeModalities),NegotiationCount:this.negotiationCount,RejectedNegotiationCount:this.rejectedNegotiationCount,MediaLegId:this.mediaLegId,MultiParty:this.multiParty,ErrorType:this.mediaError.type,ErrorDetail:this.mediaError.detail,TerminationReason:this.terminationReason,IncompatibleOffer:this.incompatibleOffer,DtmfSuccess:this.dtmfSuccess,DtmfFailure:this.dtmfFailure,Relay:this.relay?JSON.stringify(this.relay):"none",RelayManager:this.relayManagerTimers?JSON.stringify(this.relayManagerTimers):"none",AllowedAudioSend:this.allowedAudioSend,AllowedVideoSend:this.allowedVideoSend,AllowedScreensharingSend:this.allowedScreensharingSend,IceInitTime:this.getHpTimeFromMillis(this.iceInitTime),FinalAnswerTime:this.getHpTimeFromMillis(this.finalAnswerTime),IceConnectedStateTime:this.getHpTimeFromMillis(this.iceConnectedStateTime),UsedMicrophone:e.microphone,UsedSpeaker:e.speaker,UsedCamera:e.camera,DeviceSelectionChangeCount:this.deviceSelectionChangeCount,DevicesChangeCount:this.devicesChangeCount,DevicesPollChangeCount:this.devicesPollChangeCount,DevicesCount:this.devicesCount?JSON.stringify(this.devicesCount):"none",ETag:this.ETag||"",ConfigIds:this.configIds?Array.isArray(this.configIds)?this.configIds.join(","):this.configIds:"",CallMutedRatio:this.getDurationRatio(this.mute.elapsed),CallOsMuted:this.getHpTimeFromMillis(this.osMute.elapsed),CallHwSilent:this.getHpTimeFromMillis(this.hwSilent.elapsed),CallSwMuted:this.getHpTimeFromMillis(this.swMute.elapsed),CallSpeakerMuted:this.getHpTimeFromMillis(this.speakerMute.elapsed),CallIsSpeaking:this.getHpTimeFromMillis(this.isSpeaking.elapsed),NetworkRecvGood:this.networkRecv.getCount("Good")-1,NetworkRecvPoor:this.networkRecv.getCount("Poor"),NetworkRecvBad:this.networkRecv.getCount("Bad"),NetworkSendGood:this.networkSend.getCount("Good")-1,NetworkSendPoor:this.networkSend.getCount("Poor"),NetworkSendBad:this.networkSend.getCount("Bad"),NetworkRecvGoodRatio:this.getDurationRatio(this.networkRecv.getElapsed("Good")),NetworkRecvPoorRatio:this.getDurationRatio(this.networkRecv.getElapsed("Poor")),NetworkRecvBadRatio:this.getDurationRatio(this.networkRecv.getElapsed("Bad")),NetworkSendGoodRatio:this.getDurationRatio(this.networkSend.getElapsed("Good")),NetworkSendPoorRatio:this.getDurationRatio(this.networkSend.getElapsed("Poor")),NetworkSendBadRatio:this.getDurationRatio(this.networkSend.getElapsed("Bad")),DeviceEvents:JSON.stringify(this.deviceTelemetryEvents),DeviceList:JSON.stringify(this.deviceList),DeviceListDebug:JSON.stringify(this.deviceDebugStrings),VideoEffects:JSON.stringify(this.videoEffectsTelemetryEvents.items),AudioEffects:JSON.stringify(this.audioEffectsTelemetryEvents.items),PermissionStates:JSON.stringify(this.permissionStates),ReconnectAttempts:this.reconnectStats.getReport(),NetworkEvents:JSON.stringify(Dt(Et(this.sessionDiagnostics?.getObjectRef().reconnect?.tmpRecords,this.configProvider.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",this.creationTime)),ReconnectInProgress:this.reconnectStats.isReconnecting(),TransportReconnectedCount:this.transportReconnectedCount,UFDs:JSON.stringify(this.ufds),MediaQosEnabled:this.mediaQosEnabled,PortRangeConfigured:this.portRangeConfigured,RollbackNegotiation:JSON.stringify(this.rollbackNegotiation),hardwareConcurrency:Bp.hardwareConcurrency,GPUName:Bp.unmaskedGlRenderer,Connection_Downlink:kt(this.connectionDownlinkSeries.items,(e=>e)),Connection_EffectiveType:kt(this.connectionEffectiveTypeSeries.items,(e=>e)),Connection_Rtt:kt(this.connectionRttSeries.items,(e=>e)),Connection_SaveData:FD?.connection?.saveData,MediaByPassEnabled:!!this.configProvider.mediaConfig.mediaBypassEnabled,CallConstraints:JSON.stringify(this.configProvider.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(nD(this.sessionDiagnostics?.getObjectRef().dominantSpeaker,this.terminationTime))}}generateStatistics(e,t,i=!1){if(this.setMediaLegId(t.process()),"WebRtcMediaStats"!==e.type)throw new Error(`Unknown stats type - ${e.type}`);if(i){const e=this.deviceTelemetryEvents.length;this.deviceTelemetryEvents.splice(0,e-1),this.deviceDebugStrings=ew,this.audioEffectsTelemetryEvents.clear()}e.data.metrics=this.getReport();const n=this.sessionDiagnostics?.getObjectRef().statsErrors;if(n?.length)if(e.data.Extensions?.WebRTCStats?.statsErrors){const t=JSON.parse(e.data.Extensions.WebRTCStats.statsErrors);t.push(...n),e.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(t)}else e.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(n);const r={};return Ze(e.data,((e,t,i)=>{let n=0;BD.test(e)?(n=13,r[t]="IPv4"):HD.test(e)&&(n=4,r[t]="IPv6"),i[t]={type:n,value:e,__VALUE__:!0}})),e.data.metrics.piiFields={type:0,value:JSON.stringify(r),__VALUE__:!0},e}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}resetError(){this.setError({type:"none",detail:"none"})}offering(){return{started:()=>{this.currentNegotiationType="Offering",this.negotiationStarted()}}}answering(){return{started:()=>{this.currentNegotiationType="Answering",this.negotiationStarted()}}}negotiationStarted(){this.initialNegotiationType=this.initialNegotiationType||this.currentNegotiationType,++this.negotiationCount}current(){return{completed:e=>{this.initialNegotiationCompleted=!0,this.activeModalities=e,this.resetError()},rejected:()=>{++this.rejectedNegotiationCount}}}getDurationRatio(e){const t=this.getCurrentDuration();return e/(0!==t?t:1)}getCurrentDuration(){return this.durationTimer.elapsed}getHpTimeFromMillis(e){return 1e4*e}},GD=class{constructor(e,t,i,n){this.onActiveSpeakersChanged=e,this.onDominantSpeakersChanged=t,this.diagnostics=i,this.logger=n}setStrategy(e){this.disposeStrategy(),this.dshStrategy=e,this.dshStrategy?.setOnDominantSpeakerChanged(this.onDominantSpeakerHistoryChanged.bind(this)),this.diagnostics?.setCurrentActiveStrategy("client")}onContributingSourcesChanged(e){this.onActiveSpeakersChanged(e),this.dshStrategy?.setSources(e)}onDominantSpeakerHistoryChanged(e,t){this.onDominantSpeakersChanged(e),this.diagnostics?.recordHistoryEvent(e,t),"client"!==t&&this.dshStrategy&&(this.logger.safe.info("Disposing client DSH strategy and switching to MP provided DSH"),this.disposeStrategy())}dispose(){this.disposeStrategy(),this.onActiveSpeakersChanged=null,this.onDominantSpeakersChanged=null}disposeStrategy(){this.dshStrategy?.dispose(),this.dshStrategy=null}},jD=4294967040,qD=class{constructor(){this.ssrc=Math.floor(Math.random()*(jD-1))+1}nextAudioStreamSsrc(){return this.nextSsrc(0)}nextVideoStreamSsrc(){return this.nextSsrc(99)}nextSsrc(e){let t=this.ssrc;do{t=this.ssrc,this.ssrc=(this.ssrc+e+1)%jD,0===this.ssrc&&(this.ssrc=1)}while(t+e>jD);return{min:t,max:t+e}}},WD=class{};WD.SourceNone=-1,WD.SourceAny=-2;var zD=class{constructor(e){this.listener=e,this.streams=[]}add(e){this.streams.some((t=>t.getId()===e.getId()))||(this.streams.push(e),this.listener.streamAdded(e))}remove(e){let t;nt(this.streams,(i=>i.getId()===e&&(t=i,!0)))&&this.listener.streamRemoved(t)}getStreams(){return this.streams}clear(){this.streams.forEach((e=>e.dispose())),this.streams=[]}},JD=class{constructor(e){this.subscription=e}get subscribedStream(){return this.subscription.stream?.getMediaStream()}get msi(){return this.checkDisposed(),this.subscription.msi}get modality(){return this.checkDisposed(),this.subscription.modality}get localMsi(){return this.checkDisposed(),this.subscription.localMsi}setOnMediaStreamChangedHandler(e){this.checkDisposed(),this.mediaStreamChanged=e,this.subscription.isStreamReady&&this.notifyMediaStreamChanged()}setOnErrorHandler(e){this.checkDisposed(),this.error=e}dispose(){this.subscription&&(this.subscription.dispose(Te(),this),this.subscription=null)}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}notifyMediaStreamChanged(){if(this.mediaStreamChanged){const e=this.subscription.stream,t=this.subscription.isStreamReady;this.mediaStreamChanged(e&&t?e.getMediaStream():null)}}notifyError(e){this.error&&this.error(e)}checkDisposed(){if(!this.subscription)throw new Error("subscription disposed")}},KD=class extends ze{constructor(e,t,i){super(),this.modality=e,this.msi=t,this.disposeDelay=i,this.clients=[],this.streamReady=!1}createClient(){const e=new JD(this);return this.clients.push(e),e}get isStreamReady(){return this.streamReady}get localMsi(){return this.subStream?.getSourceStreamId()}get isInactive(){return!this.clients.length}get stream(){return this.subStream}set stream(e){try{if(e===this.subStream)return;this.subStream&&(this.unsubscribe(!1),this.notifyStreamChanged()),this.subStream=e,e&&(this.streamReady=!1,e.requestSource(this.msi).then((()=>{this.streamReady=!0,this.notifyStreamChanged()})).catch((e=>{this.notifyError(e)})))}catch(e){this.event("onFailed").raise(this,e)}}notifyError(e){this.clients.forEach((t=>{t.notifyError(e)})),this.event("onFailed").raise(this,e)}dispose(e,t){t?(nt(this.clients,(e=>e===t)),this.isInactive&&(this.disposeTimeout=window.setTimeout((()=>{this.disposeTimeout=null,this.unsubscribeIfInactive()}),this.disposeDelay))):(this.clients=[],this.unsubscribe())}unsubscribeIfInactive(){this.isInactive&&(this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.unsubscribe())}unsubscribe(e=!0){this.subStream&&(this.subStream.requestSource(WD.SourceNone).catch((()=>{})),this.streamReady=!1,this.subStream=null),e&&this.event("onDisposed").raise(this)}notifyStreamChanged(){this.clients.forEach((e=>e.notifyMediaStreamChanged())),this.event("onStreamChanged").raise()}},YD=class extends ze{constructor(e,t,i,n){super(e),this.configProvider=t,this.diagnostics=n,this.videoSubscriptions=[],this.subscriptionEvents=new Map,this.setLogger(e),this.diagnostics??(this.diagnostics=new Ew(this.configProvider,(()=>{}))),this.setStreamProvider(i),this.logger.safe.info("created")}getSubscriptionsCount(){return this.videoSubscriptions.length}setStreamProvider(e){this.streamProvider=e,this.streamProvider.setOnStreamsChangedHandler((()=>this.streamsChanged()))}setLogger(e){this.logger=e}subscribeVideo(e,t=WD.SourceAny){let i=this.videoSubscriptions.find((i=>i.msi===t&&i.modality===e));if(!i){const n=Date.now();this.disposeInactiveSubscriptionIfNeeded(e);const r=this.getAvailableStream(e),s=r?.getSourceStreamId();this.logger.safe.info(`creating new subscription #${t} for modality ${e}`),this.event("onSubscriptionChanged").raise(1,e,t,s,null),this.diagnostics.addSubscribe(e,t,s),i=new KD(e,t,this.configProvider.config.webrtcVideoSubscriptionDisposeTimeout);const a=[];a.push(i.on("onDisposed",(e=>this.onSubscriptionDisposed(e)))),a.push(i.on("onStreamChanged",(()=>{const r=i.stream?.getId(),s=i.localMsi;if(this.updateTrackIds(),i.isStreamReady){const i=Date.now();this.event("onSubscriptionChanged").raise(2,e,t,s,i-n,r),this.diagnostics.addSubscribed(e,t,s,i-n)}}))),a.push(i.on("onFailed",((e,t)=>this.onSubscriptionFailed(e,t)))),this.subscriptionEvents.set(i,a),this.videoSubscriptions.push(i),r&&this.assignStream(i,r)}return i.createClient()}dispose(){const e=Te();this.videoSubscriptions.concat().forEach((t=>t.dispose(e))),this.streamProvider.setOnStreamsChangedHandler(null),super.dispose(),this.logger.safe.info("disposed")}reriseSubscribeEvents(){this.logger.safe.info(`rerising subscription events: ${this.videoSubscriptions.length}`);const e=[];this.videoSubscriptions.forEach((t=>{const i=t.modality,n=t.msi,r=t.localMsi;this.event("onSubscriptionChanged").raise(1,i,n,r),this.diagnostics.addSubscribe(i,n,r),e.push(...this.getSubscriptionVideoTrackIds(t))})),this.diagnostics.subscribedTrackIds=e}setDiagnostics(e){this.diagnostics=e??new Ew(this.configProvider,(e=>{this.logger.safe.warn(`Unhandled stats error from inactive subscription manager: ${e}`)}))}streamChangedByMsi(e){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`);const t=this.videoSubscriptions.find((t=>t.msi===e));t?this.assignSubscriptionToStream(t):this.logger.safe.error(`Subscription for msi ${e} not found`)}streamsChanged(){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`),this.videoSubscriptions.forEach((e=>{this.assignSubscriptionToStream(e)}))}assignSubscriptionToStream(e){const t=!e.stream||this.isStreamRemoved(e.stream);if(this.logger.safe.info(`Subscription for ${e.modality} ${e.msi} needs new stream: ${t}`),!t)return;const i=this.getAvailableStream(e.modality);i?this.assignStream(e,i):this.resignStream(e)}getAvailableStream(e){return this.streamProvider.getStreams().find((t=>e===t.getModality()&&t.getMsi()===WD.SourceNone))}isStreamRemoved(e){return!this.streamProvider.getStreams().some((t=>t===e))}assignStream(e,t){this.logger.safe.info(`assigning stream #${t.getId()} to subscription #${e.msi}`),e.stream=t}resignStream(e){e.stream&&(this.logger.safe.info(`removing stream from subscription #${e.msi}`),e.stream=null)}disposeInactiveSubscriptionIfNeeded(e){this.getAvailableStream(e)||this.videoSubscriptions.find((t=>t.modality===e&&t.isInactive))?.unsubscribeIfInactive()}onSubscriptionDisposed(e){const t=Te(),i=e.modality,n=e.msi,r=e.localMsi;this.event("onSubscriptionChanged").raise(3,i,n,r),this.diagnostics.addUnsubscribe(i,n,r),this.logger.safe.info(`disposing subscription for ${i} #${n}`),nt(this.videoSubscriptions,(t=>t===e)),this.streamsChanged(),this.updateTrackIds(),this.subscriptionEvents.has(e)&&(this.subscriptionEvents.get(e).forEach((e=>e.dispose(t))),this.subscriptionEvents.delete(e))}updateTrackIds(){const e=[],t=[];this.videoSubscriptions.forEach((i=>{if(!i.isStreamReady)return;const n=i.stream?.getId().split("-")[1];t.push(n),e.push(...this.getSubscriptionVideoTrackIds(i))})),this.event("onTrackIdsChanged").raise(e),this.diagnostics.subscribedTrackIds=e,this.configProvider.config.subscribeToSsrcForVideo&&this.event("onTrackSsrcChanged").raise(t)}getSubscriptionVideoTrackIds(e){return e?.stream?.getMediaStream()?.getVideoTracks().map((e=>e.id))??[]}onSubscriptionFailed(e,t){this.event("onSubscriptionFailed").raise(-1,e.modality,e.msi,e.localMsi,t),this.diagnostics.addFailed(e.modality,e.msi,e.localMsi,Ve(t))}},QD=f(ye()),XD=class{constructor(e,t,i){this.logger=e,this.qualityManager=t,this.configProvider=i}getControlItem(){return this.controlItem}setControlItem(e){this.controlItem=e}dispose(){this.controlItem=null}setVideoControlMessage(e){this.controlItem=this.messageToControlItem(e),this.logger.safe.info(`BW limit requested to ${this.controlItem.bandwidth}`)}modifyDescriptor(e){if(!this.controlItem)return e;const t=QD.parse(e.sdp);if(!t.media[1])return this.logger.unsafe.warn("video modality is disabled, skipping sdp modification, ",e),e;const i=this.getCurrentResolutionBitrate();this.logger.safe.info(`Select the BW limit as min of requested ${this.controlItem.bandwidth} and Current Resolution Max BR ${i}`);const n=this.getSessionBitrate(t),r=Math.min(i,this.controlItem.bandwidth,n);if(t.media[1].bandwidth)t.media[1].bandwidth[0].limit=r;else{const e={limit:r,type:"AS"};t.media[1].bandwidth=[e]}return e.sdp=QD.write(t),e}messageToControlItem(e){const t=new Mw(e.controlVideoStreaming.controlInfo[0].fmtParams),i="max-br";if(!t.contains(i))return null;const n=Math.round(1.2*+t.get(i));return{sourceId:e.controlVideoStreaming.controlInfo[0].sourceId,streamMsid:e.controlVideoStreaming.controlInfo[0].streamMsid,bandwidth:n}}getCurrentResolutionBitrate(){const e=this.qualityManager.getCurrentResolution(),t=ZA.Send.getResolutionByFs(e);return e&&t?Math.floor(ZA.Send.getBitrateForResolution(t.width,t.height).maxBitrate/1e3):Number.MAX_VALUE}getSessionBitrate(e){let t=Number.MAX_SAFE_INTEGER;return this.configProvider.mediaConfig.maxBandwidthInKbps&&(t=this.configProvider.mediaConfig.maxBandwidthInKbps),e.bandwidth&&(t=Math.min(e.bandwidth[0].limit,t)),t-(this.configProvider.config.audioBandwidthInKbps||0)}},ZD=class{constructor(e,t,i){this.pc=e,this.configProvider=t,this.logger=i.createChild("MediaRollbackModifier")}modifyDescriptor(e){const t=QD.parse(e.sdp);return QD.parse(this.pc.localDescription.sdp).media.forEach(((e,i)=>{const n=t.media[i];(Ww(e)&&!e.bundleOnly||!n||Ww(n))&&(this.logger.safe.info(`Adding disabled media ${e.type}, position ${i}`),t.media[i]=mM(e.type,void 0,e.protocol,void 0))})),new YP(this.configProvider).modify(t),e.sdp=QD.write(t),e}},eO=class{constructor(e){this.manager=null,this.extensionType=e}initialize(e){e.manager&&(this.manager=e.manager),e.logger&&(this.logger=e.logger.createChild(this.extensionType)),e.configProvider&&(this.configProvider=e.configProvider)}dispose(){this.manager&&(this.manager=null),this.logger&&(this.logger.safe.info("disposed"),this.logger=this.logger.createChild("DISPOSED"))}configure(e){this.options=e}getOptions(){return this.options}getType(){return this.extensionType}},tO=class extends eO{constructor(){super("dominantSpeakerHistory"),this.callback=null}initialize(e){super.initialize(e),this.extensionManagerSubscription=this.manager.on("onDominantHistoryMessage",((e,t)=>this.onDominantHistoryMessage(e,t))),e&&e.callback&&(this.callback=e.callback)}dispose(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null,this.callback=null,super.dispose()}onDominantHistoryMessage(e,t){this.callback&&("server"===t?this.callback(e.history,t):"signaling"===t&&this.callback(e.previousDominantSpeakerHistory,t))}},iO=class{constructor(e,t,i,n,r,s){this.logger=e,this.emulator=t,this.qualityManager=i,this.diagnostics=n,this.configProvider=r,this.statsGatherer=s,this.previousSequenceNumber=new Map,this.modifiers=this.configProvider.mediaConfig.simulcastSessionEnabled?[]:[new XD(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider)]}dispose(){this.cleanupDevToolsInjector(),this.modifiers&&(this.modifiers.forEach((e=>e.dispose())),this.modifiers=null),this.emulator=null,this.logger=this.logger.createChild("DISPOSED")}handleMessage(e){const t=e.controlInfo[0].sourceId;if(this.previousSequenceNumber.has(t)&&e.sequenceNumber<this.previousSequenceNumber.get(t))return this.statsGatherer.addVideoControlMessage(!0),this.diagnostics?.addVideoControlMessage(!0),this.logger.safe.info(`Discarded old media stream control message for sourceId ${t}: (${JSON.stringify(e)})`),Promise.resolve();this.previousSequenceNumber.set(t,e.sequenceNumber),this.statsGatherer.addVideoControlMessage(),this.diagnostics?.addVideoControlMessage(),this.configProvider.config.enableDevtoolsAPI&&this.injectFmtpHandler(e);const i={controlVideoStreaming:e};return this.configureResolution(i),this.modifiers.length?(this.modifiers.forEach((e=>e.setVideoControlMessage(i))),this.emulator.renegotiate(this.modifiers)):Promise.resolve()}configureResolution(e){this.logger.safe.info(`Signaling FMTP: ${JSON.stringify(e.controlVideoStreaming)}`);const t=String(e.controlVideoStreaming.sequenceNumber),i=e.controlVideoStreaming.controlInfo[0].fmtParamsList,n=e.controlVideoStreaming.controlInfo[0].fmtParams,r=i&&this.configProvider.config.webrtcFmtParamListSupported?this.parseFmtParamsList(i):[this.parseFmtParams(n)],s=+e.controlVideoStreaming.controlInfo[0].sourceId,a=[{causeId:t,isSimulcast:r.some((e=>void 0!==e.rid))||r.length>1,capabilities:r,sourceId:s}];this.qualityManager.setMaxCapabilities(a)}parseFmtParamsList(e){return e.map((e=>this.parseFmtParams(e)))}parseFmtParams(e){const t=new Mw(e);return{maxFs:+t.get(Qe.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+t.get(Qe.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+t.get(Qe.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+t.get(Qe.VIDEO_CAPABILITIES.MAX_BR_PATH),ssrc:+t.get(Qe.VIDEO_CAPABILITIES.SSRC_PATH),rid:t.get(Qe.VIDEO_CAPABILITIES.RID_PATH),keyframe:this.shouldGenerateKeyFrame(t),vlaDebug:t.get(Qe.VIDEO_CAPABILITIES.VLA_DEBUG)}}shouldGenerateKeyFrame(e){return e.get(Qe.VIDEO_CAPABILITIES.KEYFRAME_PATH)?!!+e.get(Qe.VIDEO_CAPABILITIES.KEYFRAME_PATH):this.configProvider.config.webrtcAllowRestoreKeyframe}injectFmtpHandler(e){const t=window;t&&t.webMA&&(t.webMA.fmtp||(t.webMA.fmtp={handleMessage:this.handleMessage.bind(this)}),t.webMA.fmtp.lastFmtp=e)}cleanupDevToolsInjector(){const e=window;e&&e.webMA&&delete e.webMA.fmtp}},nO=class{constructor(){this.sequence=0}getVideoControlMessage(e,t,i){const n={controlVideoStreaming:{sequenceNumber:++this.sequence,globalTimeStamp:(new Date).toString(),controlInfo:[{control:"start",sourceId:t,streamMsid:e}]}};return i&&(n.controlVideoStreaming.controlInfo[0].fmtParams=Pw(i)),n}getSourceRequestMessage(e,t,i,n,r){if(!n)throw new Error("Failed to construct SourceRequestMessage, missing fmtParams");const s={sourceId:t,streamMsid:e,fmtParams:n};return s.subStreamIndex=r,{applyChannelParameters:{multiChannelParameter:{mids:[i],mediaParameter:JSON.stringify({controlVideoStreaming:{sequenceNumber:++this.sequence,controlInfo:s}})}}}}getBandwidthInfoMessage(e,t){return{applyChannelParameters:{multiChannelParameter:{mids:e,mediaParameter:JSON.stringify({remoteUplinkBWE:{bw:t.toString()}})}}}}getMaxVideoSendCapabilitiesMessage(e){function t(e){return 16*Math.ceil(e/16)}const{streamMIDs:i,capabilities:n,useMax:r,sendMaxFs:s,sendMaxMbps:a}=e;let o=t(n.maxWidth),c=t(n.maxHeight);r&&(o=c=Math.max(o,c));const l={[Qe.VIDEO_CAPABILITIES.MAX_FPS_PATH]:n.maxFps,[Qe.VIDEO_CAPABILITIES.MAX_WIDTH]:o,[Qe.VIDEO_CAPABILITIES.MAX_HEIGHT]:c};return s&&(l[Qe.VIDEO_CAPABILITIES.MAX_FS_PATH]=n.maxFs),a&&(l[Qe.VIDEO_CAPABILITIES.MAX_MBPS_PATH]=n.maxMbps),{applyChannelParameters:{multiChannelParameter:{mids:i,mediaParameter:JSON.stringify({maxVideoSendCapabilities:{caps:l}})}}}}},rO=class{constructor(e){this.logger=e}dispose(){this.sender=null}configure(e){this.sender=e.sender}async sendMessage(e,t){if(!this.checkConfigured())return this.logger.safe.warn("extension not configured with sender"),null;let i,n;return"ApplyChannelParametersSourceRequest"===e&&(i=JSON.parse(t.applyChannelParameters.multiChannelParameter.mediaParameter),n=i.controlVideoStreaming.sequenceNumber),this.logger.safe.info(`sending video control message: ${JSON.stringify(t)}`),this.sender.send(e,t,i,n)}checkConfigured(){return!!this.sender}},sO=class extends eO{constructor(){super("videoStreamControl"),this.messageGenerator=new nO}initialize(e){super.initialize(e),this.subscribeListeners(),this.sourceRequester=new rO(e.logger),this.streamConfigurationHandler=new iO(e.logger,e.negotiationEmulator,e.qualityManager,e.diagnostics,e.configProvider,e.statisticsGatherer)}configure(e){super.configure(e),this.sourceRequester.configure(e)}sendSourceRequest(e,t,i,n,r){if(this.configProvider?.config.useApplyChannelParametersForSourceRequests){const s=this.messageGenerator.getSourceRequestMessage(e,t,i,n,r);return this.sourceRequester.sendMessage("ApplyChannelParametersSourceRequest",s)}const s=this.messageGenerator.getVideoControlMessage(e,t,n?.[0]);return this.sourceRequester.sendMessage("ControlVideoStreaming",s)}sendBandwidthInfo(e,t){const i=this.messageGenerator.getBandwidthInfoMessage(e,t);return this.sourceRequester.sendMessage("ApplyChannelParametersBandwidth",i)}sendMaxVideoSendCapabilities(e,t){const i=this.messageGenerator.getMaxVideoSendCapabilitiesMessage({streamMIDs:e,capabilities:t,sendMaxFs:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxFs,sendMaxMbps:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxMbps,useMax:this.configProvider.config.maxSendVideoCapabilitiesReportingUseMaximumWidthHeight});return this.sourceRequester.sendMessage("ApplyChannelParametersVideoCapabilities",i)}dispose(){this.unsubscribeListeners(),this.streamConfigurationHandler&&(this.streamConfigurationHandler.dispose(),this.streamConfigurationHandler=null),this.sourceRequester&&(this.sourceRequester.dispose(),this.sourceRequester=null),super.dispose()}onMediaStreamControlMessage(e){this.streamConfigurationHandler.handleMessage(e)}subscribeListeners(){this.extensionManagerSubscription=this.manager.on("onMediaStreamControlMessage",(e=>this.onMediaStreamControlMessage(e)))}unsubscribeListeners(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}},aO=class extends eO{constructor(){super("bandwidthTelemetry")}initialize(e){super.initialize(e),this.statisticsGatherer=e.statisticsGatherer,this.diagnostics=e.diagnostics,this.extensionManagerSubscription=this.manager.on("onBandwidthMessage",(e=>this.onBandwidthMessage(e)))}dispose(){super.dispose(),this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}onBandwidthMessage(e){this.statisticsGatherer.addReportedReceiveBandwidth(e.bw),this.diagnostics.addReportedReceiveBandwidth(e.bw)}},oO=class{constructor(e){this.key=e.config.bwSeedOptions.localStorageKey||"bwSeed";const t=localStorage.getItem(this.key);parseInt(t)||localStorage.setItem(this.key,e.config.bwSeedOptions.constValue.toString())}getSeed(){const e=localStorage.getItem(this.key),t=parseInt(e);return isNaN(t)?void 0:t}saveSeed(e){localStorage.setItem(this.key,e.toString())}static localStorageAvailable(){try{const e=window.localStorage,t="someKey",i="someValue";return e.setItem(t,i),e.removeItem(t),!0}catch(e){return!1}}},cO=class e{constructor(t){e.value??(e.value=t.config.bwSeedOptions.constValue)}getSeed(){return e.value}saveSeed(t){e.value=t}},lO=class{constructor(e){this.value=e}addValue(e){}getAggregated(){return this.value}},dO=class{addValue(e){this.value=e}getAggregated(){return this.value}},hO=class{constructor(e){this.values=new uw(e)}addValue(e){this.values.add(e)}getAggregated(){return Math.floor(it(this.values.items))}},uO=class{constructor(){this.total=0,this.duration=0,this.max=0,this.minNonZero=Number.MAX_SAFE_INTEGER}get avg(){return 0!==this.duration?this.total/this.duration:0}get maxSample(){return this.max}get minNonZeroSample(){return this.minNonZero}captureSample(e){(e||0===e)&&(this.total+=e,this.duration++,this.max=Math.max(e,this.max),0!==e&&(this.minNonZero=Math.min(e,this.minNonZero)))}},gO=class{constructor(){this.sampleCounts={}}get min(){const e=Object.keys(this.sampleCounts).map(Number).filter((e=>e>0));return e.length>0?Math.min(...e):0}get max(){const e=Object.keys(this.sampleCounts).map(Number);return e.length>0?Math.max(...e):0}get mode(){const e=Object.keys(this.sampleCounts).map(Number);return e.length>0?e.reduce(((e,t)=>this.sampleCounts[t]>this.sampleCounts[e]?t:e),e[0]):0}captureSample(e){var t;if(void 0!==e){const i=`${e}`;(t=this.sampleCounts)[i]??(t[i]=0),this.sampleCounts[i]++}}},pO=class{get delta(){if(void 0!==this.cur&&void 0!==this.last)return this.cur-this.last}captureSample(e,t){void 0!==e&&(void 0!==this.cur&&(this.last=this.cur),this.cur=e)}},mO=class{constructor(e=0){this.precision=e}get delta(){if(void 0!==this.currentSample&&void 0!==this.prevSample){let e=1;return void 0!==this.currentTimestamp&&void 0!==this.prevTimestamp&&(e=(this.currentTimestamp-this.prevTimestamp)/1e3),e&&Ct((this.currentSample-this.prevSample)/e,this.precision)}}captureSample(e,t){if(this.currentTimestamp!==t){if(void 0===e)return this.prevSample=void 0,this.currentSample=void 0,this.prevTimestamp=void 0,void(this.currentTimestamp=void 0);void 0!==this.currentSample&&(this.prevSample=this.currentSample),this.prevTimestamp=this.currentTimestamp,this.currentTimestamp=t,this.currentSample=e}}},fO=class{constructor(){this.startTime=Date.now()}get elapsed(){return Ct((Date.now()-this.startTime)/1e3,0)}},SO=class{constructor(){this.eventCount=0,this.totalActiveDuration=0,this.countBuckets={seconds1to3:0,seconds3to5:0,seconds5to8:0,seconds8to15:0,seconds15to60:0,seconds60toMax:0},this.timestampBuckets={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]},this.averager=new uO}get active(){return!!this.current}get ongoingDuration(){return this.current?.elapsed||0}get avgDuration(){return this.averager.avg}get longestDuration(){return this.averager.maxSample}get numEvents(){return this.eventCount}get totalDuration(){return this.current?this.totalActiveDuration+this.current.elapsed:this.totalActiveDuration}get timestamps(){return ct(this.timestampBuckets)}get counts(){return ct(this.countBuckets)}set active(e){if(!this.current&&e)this.current=new fO;else if(this.current&&!e){const e=this.current.elapsed;this.averager.captureSample(e),this.totalActiveDuration+=e;for(const t of Object.keys(Qe.HISTOGRAM_BATCH))if(e<=Qe.HISTOGRAM_BATCH[t]){this.countBuckets[t]++,this.timestampBuckets[t].push(this.current.startTime);break}this.eventCount++,this.current=void 0}}},vO=class{constructor(){this.sampleChangeCount=0,this.sampleDurations={}}get durations(){return ct(this.sampleDurations)}get sortedDurations(){return Object.keys(this.sampleDurations).sort(((e,t)=>this.sampleDurations[t]-this.sampleDurations[e]))}get durationRatios(){const e={};let t=0;for(const e in this.sampleDurations)t+=this.sampleDurations[e];for(const i in this.sampleDurations)e[i]=Ct(this.sampleDurations[i]/t*100);return e}get changeCount(){return this.sampleChangeCount}captureSample(e){this.sampleDurations[e]||(this.sampleDurations[e]=0),this.sampleDurations[e]++,e!==this.lastSample&&(this.sampleChangeCount++,this.lastSample=e)}},yO=class{constructor(e,t){this.validTimeBetweenFramesArrival=e,this.invalidFPSAboveMax=t,this.lastSampleTimestamp=-1,this.fpsHarmonicSumWeigtsTs=0,this.fpsHarmonicWeigtedSumsFramePerDelayTs=0}captureSample(e){const t=Date.now();if(e>0&&this.lastSampleTimestamp>0){const i=t-this.lastSampleTimestamp;if(this.lastSampleTimestamp=t,i<0||i>this.validTimeBetweenFramesArrival||e>this.invalidFPSAboveMax)return;const n=i/e;this.fpsHarmonicSumWeigtsTs+=i,this.fpsHarmonicWeigtedSumsFramePerDelayTs+=i*n}(this.lastSampleTimestamp<0||0===e)&&(this.lastSampleTimestamp=t)}get harmonicMean(){return this.fpsHarmonicWeigtedSumsFramePerDelayTs>0?1e3*this.fpsHarmonicSumWeigtsTs/this.fpsHarmonicWeigtedSumsFramePerDelayTs:0}},CO=class{constructor(e){this.samplesNum=e,this.samples=[],this.lastReport={avg:-1,max:-1,median:-1,volatilityPercent:-1}}isReportComplete(){return this.samples.length===this.samplesNum}getReport(){return this.lastReport}captureSample(e){void 0===e||e<0||(Tt(this.samples,e,this.samplesNum),this.lastReport={avg:this.getAvg(),max:this.getMax(),median:this.getMedian(),volatilityPercent:this.getVolatility()})}getAvg(){return it(this.samples)}getMax(){return Math.max(...this.samples)}getMedian(){return this.samples.sort(((e,t)=>e-t)),this.samples.length%2==1?this.samples[Math.floor(this.samples.length/2)]:(this.samples[this.samples.length/2]+this.samples[this.samples.length/2-1])/2}getVolatility(){const e=this.getAvg();if(0===e)return 0;let t=0;return this.samples.forEach((i=>{t+=Math.abs(i-e)})),Ct(t/this.samples.length*100/e,2)}},_O=class{constructor(){this.duration=0,this.reportAggr={avg:0,max:0,median:0,volatilityPercent:0}}captureSample(e){!e||e.avg<0||(this.reportAggr={avg:this.reportAggr.avg+e.avg,max:Math.max(this.reportAggr.max,e.max),median:this.reportAggr.median+e.median,volatilityPercent:this.reportAggr.volatilityPercent+e.volatilityPercent},this.duration++)}getReport(){if(0!==this.duration)return{avg:this.reportAggr.avg/this.duration,max:this.reportAggr.max,median:this.reportAggr.median/this.duration,volatilityPercent:this.reportAggr.volatilityPercent/this.duration}}},EO=class{constructor(e=0){this.allowedOvershoot=e,this.past=[],this.totalOvershootDuration=0,this.lastAllowed=0}get isOvershooting(){return!!this.current}get events(){return this.current?[...this.past,this.current]:this.past}get totalDuration(){return this.totalOvershootDuration}captureSample(e,t){const i=Ct(e-t);i>this.allowedOvershoot&&(0===this.lastAllowed||t===this.lastAllowed||!this.current&&t>this.lastAllowed)?(this.totalOvershootDuration++,this.current?(this.current.min=Math.min(this.current.min,i),this.current.max=Math.max(this.current.max,i)):this.current={timestamp:Date.now(),min:i,max:i}):this.current&&(this.current.duration=Date.now()-this.current.timestamp,this.past.push(this.current),this.current=void 0),this.lastAllowed=t}},TO=class{constructor(e=100){this.minPackets=e,this.prevLost=0,this.prevReceived=0}calculate(e,t){if(void 0===e||void 0===t)return;const i=e-this.prevReceived,n=t-this.prevLost;return i+n<this.minPackets?void 0:(this.prevReceived=e,this.prevLost=t,n*this.minPackets/(n+i))}},IO=class{constructor(){this.capturedSamples=[]}captureSample(e){e&&this.capturedSamples.push(e)}calculateStd(){if(!this.capturedSamples.length)return;const e=this.capturedSamples.reduce(((e,t)=>e+t),0)/this.capturedSamples.length,t=this.capturedSamples.map((t=>(t-e)**2)),i=t.reduce(((e,t)=>e+t),0)/t.length;return Ct(Math.sqrt(i),2)}getFirst(){return this.capturedSamples[0]}getLast(){if(this.capturedSamples.length)return this.capturedSamples[this.capturedSamples.length-1]}calculatePercentile(e){if(!this.capturedSamples.length)return;const t=this.capturedSamples.sort(((e,t)=>e-t)),i=(t.length-1)*e,n=Math.floor(i),r=i-n;return void 0!==t[n+1]?t[n]+r*(t[n+1]-t[n]):t[n]}};function bO(e){if(!e)return;const t=["libvpx","ffmpeg"];let i=!0;for(const n of t)if(e.toLowerCase().includes(n)){i=!1;break}return i}var AO=class{constructor(e){this.samplesCount=e,this.capturedSamples=[]}captureSample(e){void 0!==e&&Tt(this.capturedSamples,e,this.samplesCount)}getRate(){if(!this.capturedSamples.length)return;const e=this.samplesCount/this.capturedSamples.length;return this.capturedSamples.reduce(((e,t)=>e+t))*e/this.samplesCount}},RO=class{constructor(e=5){this.limit=e,this.curWidth=0,this.curHeight=0,this.resolutionSwitches=[]}captureSample(e,t){e===this.curWidth&&t===this.curHeight||(Tt(this.resolutionSwitches,`${e}x${t}`,this.limit),this.curWidth=e,this.curHeight=t)}get switches(){if(this.resolutionSwitches.length)return this.resolutionSwitches}};function wO(e,t,i){return e&&t?Math.ceil(e/Qe.MACROBLOCK_SIZE)*Math.ceil(t/Qe.MACROBLOCK_SIZE)*i:0}var PO=class{constructor(){this.macroblockRateAveragerReceived=new uO,this.macroblockRateAveragerDecoded=new uO,this.maxDecoderLoss=0,this.decoderLoss=0}captureSample(e,t){this.macroblockRateAveragerReceived.captureSample(e),this.macroblockRateAveragerDecoded.captureSample(t);let i=this.maxDecoderLoss;e&&(i=(e-t)/e*100),this.decoderLoss=i,this.maxDecoderLoss=Math.max(i,this.maxDecoderLoss)}getReport(){return{macroblockRateReceivedMax:this.macroblockRateAveragerReceived.maxSample,macroblockRateReceivedAvg:this.macroblockRateAveragerReceived.avg,macroblockRateDecodedMax:this.macroblockRateAveragerDecoded.maxSample,macroblockRateDecodedAvg:this.macroblockRateAveragerDecoded.avg,macroblockRateMaxDecoderLossPercent:Math.floor(this.maxDecoderLoss),macroblockRateDecoderLossPercent:Math.floor(this.decoderLoss)}}},MO=class{constructor(){this.codecReport={}}captureSample(e,t){var i,n;const r=e.split("/")[1];return void 0===this.activeMsi||this.activeMsi!==t?(this.activeMsi=t,this.previousCodec=r,void((i=this.codecReport)[t]??(i[t]={[r]:1,codecSwitchCounter:0}))):this.previousCodec!==r?((n=this.codecReport[t])[r]??(n[r]=0),this.codecReport[t][r]++,this.codecReport[t].codecSwitchCounter++,void(this.previousCodec=r)):void this.codecReport[t][r]++}get report(){return this.codecReport}},DO=class{constructor(){this.bandwidthAverager=new uO}addValue(e){this.bandwidthAverager.captureSample(e)}getAggregated(){return Math.floor(this.bandwidthAverager.avg)}},OO=class{constructor(e){this.configProvider=e,this.aggregator=this.getAggregator(),this.storage=this.getStorage(),this.cappingValue=this.configProvider.config.bwSeedOptions.cappingValue,this.minValue=this.configProvider.config.bwSeedOptions.minValue??-1}getSeed(){const e=this.storage.getSeed()??-1;return this.cappingValue>0?Math.min(Math.max(e,this.minValue),this.cappingValue):Math.max(e,this.minValue)}saveSeed(e){this.aggregator.addValue(e);const t=this.aggregator.getAggregated();this.storage.saveSeed(t)}getAggregator(){switch(this.configProvider.config.bwSeedOptions.aggregation){case"avg":return this.configProvider.config.bwSeedOptions.aggregateLastN>0?new hO(this.configProvider.config.bwSeedOptions.aggregateLastN):new DO;case"last":return new dO;default:return new lO(this.configProvider.config.bwSeedOptions.constValue)}}getStorage(){return this.configProvider.config.bwSeedOptions.useLocalStorage&&oO.localStorageAvailable()?new oO(this.configProvider):new cO(this.configProvider)}},kO=class extends eO{constructor(){super("bandwidthCache")}initialize(e){super.initialize(e),this.bandwidthCache=new OO(e.configProvider),this.onBandwidthMessageSubscription=this.manager.on("onBandwidthMessage",(e=>{this.bandwidthCache.saveSeed(e.bw)}))}getBWSeed(){return this.bandwidthCache.getSeed()}dispose(){super.dispose(),this.onBandwidthMessageSubscription?.dispose(),this.onBandwidthMessageSubscription=null}},NO=class{static getExtension(e){switch(e){case"dominantSpeakerHistory":return new tO;case"videoStreamControl":return new sO;case"bandwidthTelemetry":return new aO;case"bandwidthCache":return new kO;default:throw new Error(`Extension of type ${e} is not found`)}}},LO=class extends ze{constructor(e){super(e),this.logger=e,this.extensions=[]}dispose(){this.extensions.map((e=>e.dispose())),this.extensions=[],super.dispose()}addExtension(e,t){t.manager||(t.manager=this);const i=NO.getExtension(e);i.initialize(t),this.extensions.push(i)}getExtension(e){return this.extensions.find((t=>t.getType()===e))}configureExtension(e,t){this.getExtension(e)?.configure(t)}processNotification(e,t){switch(e){case"ControlVideoStreaming":this.event("onMediaStreamControlMessage").raise(t);break;case"DominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(t,"signaling");break;case"McpDominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(t,"server");break;case"BandwithNotification":this.event("onBandwidthMessage").raise(t);break;default:this.logger.safe.error(`Notification message handler not found for type: ${e}`)}}},xO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(e){if(!e)return;const t=new Set;if(e.send){this.diagnostics.handlePresentationAudioInputLevel();for(const i of e.send)try{t.add(i.outboundRTP.id);let e=this.sendExtenders.get(i.outboundRTP.id)??new VO(this.diagnostics,this.configProvider);i.outboundRTP.bytesSent<e.lastBytes&&(e=new VO(this.diagnostics,this.configProvider)),this.sendExtenders.set(i.outboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("AudioStatsProcessor:send",Ve(e))}}if(Lt(this.sendExtenders,t),t.clear(),e.recv)for(const i of e.recv)try{t.add(i.inboundRTP.id);let e=this.recvExtenders.get(i.inboundRTP.id)??new UO(this.configProvider);i.inboundRTP.bytesReceived<e.lastBytes&&(e=new UO(this.configProvider)),this.recvExtenders.set(i.inboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("AudioStatsProcessor:recv",Ve(e))}Lt(this.recvExtenders,t)}},UO=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new TO,this.bytesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.totalSamplesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.concealedSamplesDiff=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.silentConcealedSamplesDiff=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.concealedRatioAverager=new uO,this.stretchedRatioAverager=new uO,this.codecSwitchesTracker=new vO,this.packetDurationTracker=new vO,this.jitterAverager=new uO,this.jitterBufferDelayAverager=new uO,this.lastBytes=0}processSample(e){let t,i,n,r,s;const a=this.lossRateCalculator.calculate(e.inboundRTP.packetsReceived,e.inboundRTP.packetsLost)??0;this.lastBytes=e.inboundRTP.bytesReceived,this.bytesReceivedDiff.captureSample(e.inboundRTP.bytesReceived,e.inboundRTP.timestamp),this.totalSamplesReceivedDiff.captureSample(e.inboundRTP.totalSamplesReceived,e.inboundRTP.timestamp),this.concealedSamplesDiff.captureSample(e.inboundRTP.concealedSamples,e.inboundRTP.timestamp),this.silentConcealedSamplesDiff.captureSample(e.inboundRTP.silentConcealedSamples,e.inboundRTP.timestamp);const o=this.bytesReceivedDiff.delta&&8*this.bytesReceivedDiff.delta;this.packetsDelta.captureSample(e.inboundRTP.packetsReceived,e.inboundRTP.timestamp),this.packetsLostDelta.captureSample(e.inboundRTP.packetsLost,e.inboundRTP.timestamp);const c=e.inboundRTP.jitterBufferDelay&&e.inboundRTP.jitterBufferEmittedCount&&Ct(e.inboundRTP.jitterBufferDelay/e.inboundRTP.jitterBufferEmittedCount*1e3,0);if(this.jitterAverager.captureSample(1e3*e.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(e.inboundRTP.jitterBufferDelay),t=this.totalSamplesReceivedDiff.delta&&this.concealedSamplesDiff.delta&&this.silentConcealedSamplesDiff.delta&&Ct((this.concealedSamplesDiff.delta-this.silentConcealedSamplesDiff.delta)/this.totalSamplesReceivedDiff.delta),e.customHealerStats){e.customHealerStats.numSamplesPerFrame&&(r=e.customHealerStats.decodedSamples/e.customHealerStats.numSamplesPerFrame,s=e.customHealerStats.cngSamples/e.customHealerStats.numSamplesPerFrame),t=e.customHealerStats.healedSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples),n=e.customHealerStats.concealSamples&&e.customHealerStats.concealSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples),i=e.customHealerStats.stretchSamples&&e.customHealerStats.stretchSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples);const a=e.customHealerStats.packetDurationInMs&&e.customHealerStats.packetDurationInMs>100?100:e.customHealerStats.packetDurationInMs;this.concealedRatioAverager.captureSample(n),this.stretchedRatioAverager.captureSample(i),this.codecSwitchesTracker.captureSample(`${e.customHealerStats.pullAdspPayloadType}`),this.packetDurationTracker.captureSample(`${a}`)}e.extensions={lossRate:a,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,healedRatio:t,jitterBufferMs:c,bitrate:o||0,customHealerStats:e.customHealerStats&&{concealedDataRatio:n,concealedDataRatioMax:this.concealedRatioAverager.maxSample,stretchedDataRatio:i,stretchedDataRatioMax:this.stretchedRatioAverager.maxSample,numberOfDecodedFrames:r,usageMetricsCodecId:this.codecSwitchesTracker.sortedDurations,percentageOfPtime:this.packetDurationTracker.durationRatios,pushPacketProcessingTimes:e.customHealerStats.pushProcessingTimes,pullPacketProcessingTimes:e.customHealerStats.pullProcessingTimes,pullProcessingTimePerStreamNumber:e.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:e.customHealerStats.cnpPushCount,cnpPullCount:e.customHealerStats.cnpPullCount,numberOfCNFrames:s,redPacketsCount:e.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:e.customHealerStats.pullNumOfStreamsCounter},jitterAvg:Ct(this.jitterAverager.avg),jitterBufferDelayMs:Ct(this.jitterBufferDelayAverager.avg)},this.duration++}},FO=class{constructor(){this.duration=0,this.lossRateAverager=new uO,this.bitrateAverager=new uO,this.jitterBufferAverager=new uO,this.jitterAverager=new uO,this.jitterBufferDelayAverager=new uO,this.healedRatioAverager=new uO}processSample(e,t,i){const n=e[0],r={inboundRTP:n.inboundRTP};if(n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.remoteOutboundRTP&&(r.remoteOutboundRTP=n.remoteOutboundRTP),n.extensions){this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.healedRatioAverager.captureSample(n.extensions.healedRatio),this.jitterBufferAverager.captureSample(n.extensions.jitterBufferMs),this.jitterAverager.captureSample(1e3*n.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(n.inboundRTP.jitterBufferDelay);const e=n.inboundRTP.packetsReceived+n.inboundRTP.packetsLost;r.aggregated={lossRateMax:this.lossRateAverager.maxSample,lossRateAvg:this.lossRateAverager.avg,networkAvgLossRate:e>0?n.inboundRTP.packetsLost/e:0,duration:this.duration,bitrateAvg:Ct(this.bitrateAverager.avg,0),bitrateMax:Ct(this.bitrateAverager.maxSample,0),jitterAvg:this.jitterAverager.avg,avgJitterBufferSize:this.jitterBufferAverager.avg,healedRatioAvg:this.healedRatioAverager.avg,healedRatioMax:this.healedRatioAverager.maxSample,customHealerStats:n.extensions.customHealerStats&&{concealedDataRatio:n.extensions.customHealerStats.concealedDataRatio,concealedDataRatioMax:n.extensions.customHealerStats.concealedDataRatioMax,stretchedDataRatio:n.extensions.customHealerStats.stretchedDataRatio,stretchedDataRatioMax:n.extensions.customHealerStats.stretchedDataRatioMax,numberOfDecodedFrames:n.extensions.customHealerStats.numberOfDecodedFrames,usageMetricsCodecId:n.extensions.customHealerStats.usageMetricsCodecId,percentageOfPtime:n.extensions.customHealerStats.percentageOfPtime,pushPacketProcessingTimes:n.extensions.customHealerStats.pushPacketProcessingTimes,pullPacketProcessingTimes:n.extensions.customHealerStats.pullPacketProcessingTimes,pullProcessingTimePerStreamNumber:n.extensions.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:n.extensions.customHealerStats.cnpPushCount,cnpPullCount:n.extensions.customHealerStats.cnpPullCount,numberOfCNFrames:n.extensions.customHealerStats.numberOfCNFrames,redPacketsCount:n.extensions.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:n.extensions.customHealerStats.pullNumOfStreamsCounter}},this.duration++}Tt(t,r,i)}},VO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new TO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.bytesSendDiff=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.rttAverager=new uO,this.lastBytes=0}processSample(e){const t=this.lossRateCalculator.calculate(e.remoteInboundRTP?.packetsReceived,e.remoteInboundRTP?.packetsLost)??0;this.packetsDelta.captureSample(e.outboundRTP.packetsSent,e.outboundRTP.timestamp),this.packetsLostDelta.captureSample(e.remoteInboundRTP?.packetsLost,e.remoteInboundRTP?.timestamp),this.lastBytes=e.outboundRTP.bytesSent,this.bytesSendDiff.captureSample(e.outboundRTP.bytesSent,e.outboundRTP.timestamp);const i=this.bytesSendDiff.delta;this.rttAverager.captureSample(1e3*(e.remoteInboundRTP?.roundTripTime??0)),e.extensions={lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,bitrate:i?8*i:0,rttAvg:Ct(this.rttAverager.avg),callIsMuted:this.diagnostics.callIsMuted,rawInputVolume:this.diagnostics.audioLevel},this.duration++}},BO=class{constructor(e){this.diagnostics=e,this.duration=0,this.lossRateAverager=new uO,this.bitrateAverager=new uO,this.rttAverager=new uO}processSample(e,t,i){const n=e[0],r={outboundRTP:n.outboundRTP};n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.mediaSource&&(r.mediaSource=n.mediaSource),n.remoteInboundRTP&&(r.remoteInboundRTP=n.remoteInboundRTP),n.extensions&&(this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.rttAverager.captureSample(n.remoteInboundRTP?.roundTripTime),r.aggregated={duration:this.duration,lossRateMax:this.lossRateAverager.maxSample,bitrateAvg:Ct(this.bitrateAverager.avg,0),bitrateMax:Ct(this.bitrateAverager.maxSample,0),rttAvg:Ct(this.rttAverager.avg),rttMax:Ct(this.rttAverager.maxSample),rawInputVolume:this.diagnostics.audioLevel,audioLevel:n.track?.audioLevel??n.mediaSource?.audioLevel},this.duration++),Tt(t,r,i)}},HO=p,$O={fs:0,fps:1},GO=class{constructor(e){this.logger=e,this.allowed=new Map,this.lastParams=new Map,this.currentEvents=new Map,this.finishedEvents=[]}setMaxCapabilities(e){e.forEach((e=>{if(e.ssrc||0===e.ssrc){this.finishIfActive(e.ssrc),this.allowed.set(e.ssrc,{fs:e.maxFs+$O.fs,fps:e.maxFps+$O.fps});const t=this.lastParams.get(e.ssrc);t&&this.setCurrentParams(e.ssrc,t.fs,t.fps)}}))}setCurrentParams(e,t,i){this.lastParams.set(e,{fs:t,fps:i});const n=this.getAllowedParams(e);n&&(t>n.fs||i>n.fps)?(this.captureOvershoot(e,i,n.fps,"fps"),this.captureOvershoot(e,t,n.fs,"fs")):n&&this.finishIfActive(e)}flush(){this.currentEvents.forEach(((e,t)=>this.finishIfActive(t)))}getEvents(){const e=[...ct(this.finishedEvents)],t=Date.now();return this.currentEvents.forEach((i=>i.forEach((i=>e.push({ssrc:i.ssrc,timestamp:i.timestamp,duration:t-i.timestamp,overshootType:i.overshootType,amount:i.amount}))))),e}captureOvershoot(e,t,i,n){const r=this.currentEvents.get(e)||[],s=r.findIndex((e=>e.overshootType===n)),a=r[s],o=t-i,c=$O[n];o<=c&&a?(a.duration=Date.now()-a.timestamp,this.finishedEvents.push(a),this.logger.debug(`stopped overshooting ${n} by ${a.amount}`),r.splice(s,1)):o>c&&!a?(this.logger.safe.info(`overshooting ${n} by ${t-i}`),r.push({ssrc:e,timestamp:Date.now(),duration:-1,overshootType:n,amount:{min:o,max:o}})):o>c&&a&&(a.amount={min:Math.min(a.amount.min,o),max:Math.max(a.amount.max,o)}),r.length?this.currentEvents.set(e,r):this.currentEvents.has(e)&&this.currentEvents.delete(e)}getAllowedParams(e){return this.allowed.get(e)||this.allowed.get(0)}finishIfActive(e){const t=this.currentEvents.get(e);if(t){const i=Date.now();t.forEach((t=>{t.duration=i-t.timestamp,this.finishedEvents.push(t),this.logger.debug(`finished overshooting ${t.overshootType} by min:${t.amount.min} max:${t.amount.max} for ${t.duration}ms for ssrc ${e}`)})),this.currentEvents.delete(e)}}},jO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(e){if(!e)return;const t=new Set;if(e.send&&(0,HO.flatMap)(e.send,(e=>[e,...e.altLayouts??[]])).forEach((e=>{try{t.add(e.outboundRTP.id);let i=this.sendExtenders.get(e.outboundRTP.id)??new zO(this.diagnostics,this.configProvider);e.outboundRTP.bytesSent<i.lastBytes&&(i=new zO(this.diagnostics,this.configProvider)),this.sendExtenders.set(e.outboundRTP.id,i),i.processSample(e)}catch(e){this.diagnostics.addStatsError("VideoStatsProcessor:send",Ve(e))}})),Lt(this.sendExtenders,t),t.clear(),e.recv)for(const i of e.recv)try{t.add(i.inboundRTP.id);let e=this.recvExtenders.get(i.inboundRTP.id)??new qO(this.configProvider);i.inboundRTP.bytesReceived<e.lastBytes&&(e=new qO(this.configProvider)),this.recvExtenders.set(i.inboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("VideoStatsProcessor:recv",Ve(e))}Lt(this.recvExtenders,t)}},qO=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new TO,this.bytesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.framesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.framesDecodedDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.trackFramesDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.decodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new mO(2):new pO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.freezeHistogram=new SO,this.harmonicDecodedFps=new yO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.prevTimeToFirstFrame=-1,this.lastBytes=0,this.macroblockStatsTracker=new PO}processSample(e){const t=this.lossRateCalculator.calculate(e.inboundRTP.packetsReceived,e.inboundRTP.packetsLost)??0;this.framesReceivedDelta.captureSample(e.inboundRTP.framesReceived,e.inboundRTP.timestamp),this.framesDecodedDelta.captureSample(e.inboundRTP.framesDecoded,e.inboundRTP.timestamp),this.trackFramesDelta.captureSample(e.inboundRTP.framesReceived??e.track?.framesReceived,e.inboundRTP.timestamp),this.packetsDelta.captureSample(e.inboundRTP.packetsReceived,e.inboundRTP.timestamp),this.packetsLostDelta.captureSample(e.inboundRTP.packetsLost,e.inboundRTP.timestamp);const i=this.framesReceivedDelta.delta,n=this.framesDecodedDelta.delta;this.harmonicDecodedFps.captureSample(n),this.decodeTimeDelta.captureSample(e.inboundRTP.totalDecodeTime,e.inboundRTP.timestamp);const r=this.decodeTimeDelta.delta&&n&&Ct(this.decodeTimeDelta.delta/n*1e3,0),s=e.renderer?.timeToFirstFrame??-1;this.freezeHistogram.active=-1!==s&&-1!==this.prevTimeToFirstFrame&&(0===n||0===i),this.prevTimeToFirstFrame=s,this.lastBytes=e.inboundRTP.bytesReceived,this.bytesReceivedDelta.captureSample(e.inboundRTP.bytesReceived,e.inboundRTP.timestamp);const a=this.bytesReceivedDelta.delta,o=e.inboundRTP.jitterBufferEmittedCount&&Ct((e.inboundRTP.jitterBufferDelay??0)/e.inboundRTP.jitterBufferEmittedCount*1e3),c=wO(e.inboundRTP.frameWidth,e.inboundRTP.frameHeight,i||0),l=wO(e.inboundRTP.frameWidth,e.inboundRTP.frameHeight,n||0);this.macroblockStatsTracker.captureSample(c,l),e.extensions={lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,frameRateReceived:i,frameRateDecoded:n,trackRecvFps:this.trackFramesDelta.delta,decodeTime:r||0,jitterBufferMs:o,bitrate:a?8*a:0,isFrozen:this.freezeHistogram.active,macroblockRateReceived:c,macroblockRateDecoded:l,macroblockRateStats:this.macroblockStatsTracker.getReport(),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,powerEfficient:void 0!==e.inboundRTP.powerEfficientDecoder?e.inboundRTP.powerEfficientDecoder:bO(e.inboundRTP.decoderImplementation),totalFreezeFraction:this.duration?this.freezeHistogram.totalDuration/this.duration:0,fpsHarmonicAverage:Ct(this.harmonicDecodedFps.harmonicMean)},this.duration++}},WO=class{constructor(e){this.configProvider=e,this.duration=0,this.lossRateAverager=new uO,this.bitrateAverager=new uO,this.jitterAverager=new uO,this.frameRateAverager=new uO,this.freezeHistogram=new SO,this.harmonicDecodedFps=new yO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.resolutionDurations=new vO,this.codecCalculator=new MO}processSample(e,t,i){const n=e.sort(((e,t)=>t.inboundRTP.frameHeight*t.inboundRTP.frameWidth-e.inboundRTP.frameHeight*e.inboundRTP.frameWidth))[0],r={inboundRTP:n.inboundRTP};n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec,this.configProvider?.config.isAv1Allowed&&"sharing"===n.mediaEntity?.modality&&this.codecCalculator.captureSample(n.codec.mimeType,n.renderer?.msi)),n.track&&(r.track=n.track),n.remoteOutboundRTP&&(r.remoteOutboundRTP=n.remoteOutboundRTP),n.extensions&&(r.extensions=n.extensions),n.extensions&&(this.harmonicDecodedFps.captureSample(n.extensions.frameRateDecoded),this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.jitterAverager.captureSample(1e3*(n.inboundRTP.jitter??0)),this.frameRateAverager.captureSample(n.extensions.frameRateReceived??n.extensions.frameRateDecoded),this.freezeHistogram.active=n.extensions.isFrozen,n.inboundRTP.frameWidth&&n.inboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${n.inboundRTP.frameWidth}x${n.inboundRTP.frameHeight}`),r.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,avgFrameRate:Ct(this.frameRateAverager.avg),fpsHarmonicAverage:Ct(this.harmonicDecodedFps.harmonicMean),avgJitterBufferSize:Ct(this.jitterAverager.avg),bitrateAvg:Ct(this.bitrateAverager.avg,0),bitrateMax:Ct(this.bitrateAverager.maxSample,0),bitrateMinNonZero:Ct(this.bitrateAverager.minNonZeroSample,0),ongoingFreezeDuration:this.freezeHistogram.ongoingDuration,numFreezes:this.freezeHistogram.numEvents,avgFreezeDuration:Ct(this.freezeHistogram.avgDuration),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,freezeCountHistogram:this.freezeHistogram.counts,freezeTimestampsHistogram:this.freezeHistogram.timestamps,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,macroblockRateStats:n.extensions.macroblockRateStats,codecReport:this.codecCalculator?.report},this.duration++),Tt(t,r,i)}},zO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new TO,this.lossRateAverager=new uO,this.captureFreezeIntervalsCount=0,this.bytesSendDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.encodedFramesDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.sentFramesDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.harmonicEncodedFps=new yO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.encodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new mO(2):new pO,this.qpDelta=this.useLastSampleDeltaPerSecondConverter?new mO(3):new pO,this.fsOvershoot=new EO,this.fpsOvershoot=new EO(1),this.brOvershoot=new EO,this.plisDelta=new pO,this.pliRate=new AO(60),this.resolutionSwitcherTracker=new RO(this.configProvider.config.diagnostics.collectionLimits.numResolutionSwitches),this.bitrateAverager=new uO,this.rttAverager=new uO,this.lastBytes=0}processSample(e){const t=this.lossRateCalculator.calculate(e.remoteInboundRTP?.packetsReceived,e.remoteInboundRTP?.packetsLost);this.lossRateAverager.captureSample(t),this.plisDelta.captureSample(e.outboundRTP.pliCount),this.pliRate.captureSample(this.plisDelta.delta),this.packetsDelta.captureSample(e.outboundRTP.packetsSent,e.outboundRTP.timestamp),this.packetsLostDelta.captureSample(e.remoteInboundRTP?.packetsLost,e.remoteInboundRTP?.timestamp),this.lastBytes=e.outboundRTP.bytesSent,this.bytesSendDelta.captureSample(e.outboundRTP.bytesSent,e.outboundRTP.timestamp);const i=this.bytesSendDelta.delta,n=i?8*i:void 0;this.bitrateAverager.captureSample(n),this.rttAverager.captureSample(1e3*(e.remoteInboundRTP?.roundTripTime??0)),this.encodedFramesDelta.captureSample(e.outboundRTP.framesEncoded,e.outboundRTP.timestamp);const r=this.encodedFramesDelta.delta;this.sentFramesDelta.captureSample(e.outboundRTP.framesSent,e.outboundRTP.timestamp);const s=this.sentFramesDelta.delta||0;this.harmonicEncodedFps.captureSample(r);const a=e.mediaSource?.framesPerSecond;0===a&&void 0!==this.lastCaptureFramerate&&this.lastCaptureFramerate>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFramerate=a,this.encodeTimeDelta.captureSample(e.outboundRTP.totalEncodeTime,e.outboundRTP.timestamp);const o=this.encodeTimeDelta.delta&&r&&Ct(this.encodeTimeDelta.delta/r*1e3,0);this.qpDelta.captureSample(e.outboundRTP.qpSum,e.outboundRTP.timestamp);const c=this.qpDelta.delta&&r&&Ct(this.qpDelta.delta/r,2);e.outboundRTP.frameWidth&&e.outboundRTP.frameHeight&&this.resolutionSwitcherTracker.captureSample(e.outboundRTP.frameWidth,e.outboundRTP.frameHeight);const l=this.diagnostics.deviceManager?.latestCameraOpenResolution,d=e.appliedCapabilities??e.requestedCapabilities;d&&(void 0!==e.outboundRTP.frameHeight&&void 0!==e.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(e.outboundRTP.frameHeight/16*(e.outboundRTP.frameWidth/16),d.maxFs),this.fpsOvershoot.captureSample(s,d.maxFps),d.maxBr&&this.brOvershoot.captureSample(n,d.maxBr));const h=[];for(const e of this.fsOvershoot.events)h.push({...e,overshootType:"fs"});for(const e of this.fpsOvershoot.events)h.push({...e,overshootType:"fps"});for(const e of this.brOvershoot.events)h.push({...e,overshootType:"br"});h.sort(((e,t)=>e.timestamp-t.timestamp)),e.extensions={cameraOpenResolution:l,lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,pliRate:this.pliRate.getRate(),frameRateEncoded:this.encodedFramesDelta.delta,frameRateSent:s,bitrate:n||0,encodeTime:o||0,qp:c||0,captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:h,powerEfficient:void 0!==e.outboundRTP.powerEfficientEncoder?e.outboundRTP.powerEfficientEncoder:bO(e.outboundRTP.encoderImplementation),bitrateAvg:Ct(this.bitrateAverager.avg,0),rttAvg:Ct(this.rttAverager.avg)},this.duration++}},JO=class{constructor(e){this.configProvider=e,this.duration=0,this.lossRateAverager=new uO,this.bitrateAverager=new uO,this.sendBWEAverager=new uO,this.rttAverager=new uO,this.framerateAverager=new uO,this.captureFpsAverager=new uO,this.captureFreezeIntervalsCount=0,this.lastCaptureFps=void 0,this.resolutionDurations=new vO,this.fsOvershoot=new EO,this.fpsOvershoot=new EO(1),this.brOvershoot=new EO,this.harmonicEncodedFps=new yO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax)}processSample(e,t,i){e.length>1&&e.sort(((e,t)=>{const i=e.appliedCapabilities??e.requestedCapabilities,n=t.appliedCapabilities??t.requestedCapabilities;return i?.maxMbps&&n?.maxMbps?n.maxMbps-i.maxMbps:0}));const n=e[0],r={outboundRTP:n.outboundRTP};if(n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.mediaSource&&(r.mediaSource=n.mediaSource),n.remoteInboundRTP&&(r.remoteInboundRTP=n.remoteInboundRTP),n.extensions&&(r.extensions=n.extensions),n.extensions){this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.sendBWEAverager.captureSample(n.transport?.selectedCandidatePair?.availableOutgoingBitrate),this.rttAverager.captureSample(n.remoteInboundRTP?.roundTripTime),this.framerateAverager.captureSample(n.extensions.frameRateSent);const e=n.mediaSource?.framesPerSecond;this.captureFpsAverager.captureSample(e),0===e&&void 0!==this.lastCaptureFps&&this.lastCaptureFps>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFps=e,n.outboundRTP.frameWidth&&n.outboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${n.outboundRTP.frameWidth}x${n.outboundRTP.frameHeight}`);const t=n.appliedCapabilities??n.requestedCapabilities;t&&(void 0!==n.outboundRTP.frameHeight&&void 0!==n.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(n.outboundRTP.frameHeight/16*(n.outboundRTP.frameWidth/16),t.maxFs),this.fpsOvershoot.captureSample(n.extensions.frameRateSent,t.maxFps),t.maxBr&&this.brOvershoot.captureSample(n.extensions?.bitrate,t.maxBr)),this.harmonicEncodedFps.captureSample(n.extensions.frameRateEncoded);const i=[];for(const e of this.fsOvershoot.events)i.push({...e,overshootType:"fs"});for(const e of this.fpsOvershoot.events)i.push({...e,overshootType:"fps"});for(const e of this.brOvershoot.events)i.push({...e,overshootType:"br"});i.sort(((e,t)=>e.timestamp-t.timestamp)),r.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,frameRateAvg:Ct(this.framerateAverager.avg),captureFramerateAvg:Ct(this.captureFpsAverager.avg),fpsHarmonicAverage:Ct(this.harmonicEncodedFps.harmonicMean),qpAvg:Ct(n.outboundRTP.qpSum/n.outboundRTP.framesSent),rttAvg:Ct(this.rttAverager.avg),bitrateAvg:Ct(this.bitrateAverager.avg,0),bitrateMax:Ct(this.bitrateAverager.maxSample,0),bitrateMinNonZero:Ct(this.bitrateAverager.minNonZeroSample,0),bweAvg:Ct(this.sendBWEAverager.avg,0),captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:i},this.duration++}Tt(t,r,i)}},KO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.extenders=new Map}processStats(e){const t=new Set;for(const i in e)try{t.add(i);const n=e[i],r=this.extenders.get(n.id)??new YO(this.configProvider,this.diagnostics);this.extenders.set(n.id,r),r.processSample(n)}catch(e){this.diagnostics.addStatsError("TransportStatsProcessor",Ve(e))}Lt(this.extenders,t)}},YO=class{constructor(e,t){this.configProvider=e,this.diagnostics=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.bwJumpsHistogramCollector=new SO,this.sendBWEAverager=new uO,this.recvBWEAverager=new uO,this.sendBW=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.recvBW=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.sendBWAverager=new uO,this.recvBWAverager=new uO}processSample(e){this.sendBWEAverager.captureSample(e.selectedCandidatePair?.availableOutgoingBitrate),this.recvBWEAverager.captureSample(e.selectedCandidatePair?.availableIncomingBitrate),this.sendBW.captureSample(e.selectedCandidatePair?.bytesSent,e.selectedCandidatePair?.timestamp),this.recvBW.captureSample(e.selectedCandidatePair?.bytesReceived,e.selectedCandidatePair?.timestamp);const t=this.sendBW.delta,i=this.recvBW.delta,n=t?8*t:void 0,r=i?8*i:void 0;this.sendBWAverager.captureSample(n),this.recvBWAverager.captureSample(r);const s=e.selectedCandidatePair?.availableOutgoingBitrate;s&&(this.bwJumpsHistogramCollector.active=this.bwJumpsHistogramCollector.active&&s<this.configProvider.config.webrtcBWJumpUpperLimit||s<this.configProvider.config.webrtcBWJumpLowerLimit),e.extensions={sendBWEAvg:Ct(this.sendBWEAverager.avg,0),sendBWEMax:Ct(this.sendBWEAverager.maxSample,0),recvBWEAvg:Ct(this.recvBWEAverager.avg,0),recvBWEMax:Ct(this.recvBWEAverager.maxSample,0),sendBitrate:n,recvBitrate:r,sendBWAvg:Ct(this.sendBWAverager.avg,0),sendBWMax:Ct(this.sendBWAverager.maxSample,0),recvBWAvg:Ct(this.recvBWAverager.avg,0),recvBWMax:Ct(this.recvBWAverager.maxSample,0),bwJumpsHistogram:this.bwJumpsHistogramCollector.counts,reflexiveLocalIP:this.diagnostics.reflexiveLocalIP}}},QO=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.extenders=new Map}processStats(e){if(!e)return;const t=new Set;for(const i of e)try{t.add(i.id);const e=this.extenders.get(i.id)??new XO(this.configProvider);this.extenders.set(i.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("DataChannelStatsProcessor",Ve(e))}Lt(this.extenders,t)}},XO=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.sendBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.recvBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.sendMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new mO:new pO,this.recvMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new mO:new pO}processSample(e){this.sendBytesDeltaCalculator.captureSample(e.bytesSent,e.timestamp),this.recvBytesDeltaCalculator.captureSample(e.bytesReceived,e.timestamp);const t=this.sendBytesDeltaCalculator.delta,i=this.recvBytesDeltaCalculator.delta,n=t?8*t:void 0,r=i?8*i:void 0;this.sendMessagesDeltaCalculator.captureSample(e.messagesSent,e.timestamp),this.recvMessagesDeltaCalculator.captureSample(e.messagesReceived,e.timestamp);const s=this.sendMessagesDeltaCalculator.delta,a=this.recvMessagesDeltaCalculator.delta;e.extensions={sendBitrate:n,recvBitrate:r,sendMessageRate:s,recvMessageRate:a}}},ZO=class{constructor(e){this.collecVideoStatsAfterSubscription=e,this.videoStatsEvent=[],this.count=0}prepareCollectingStatsOnSubscribed(e){this.count=0,this.videoStatsEvent.push({ts:Date.now(),framesDecoded:[],bytesReceived:[],height:[],msi:e})}captureStatsOnSubscribed(e,t,i,n){if(this.count>=this.collecVideoStatsAfterSubscription)return;const r=bt(this.videoStatsEvent);r&&(r.framesDecoded.push(e),r.bytesReceived.push(t),void 0!==i&&r.height.push(i)),this.count++}getStatsOnSubscribed(){return this.videoStatsEvent}},ek=class{constructor(e,t,i,n){this.slidingWindowSize=e,this.maxDeviation=t,this.minBandwidth=i,this.directionalityCheck=n,this.slidingWindow=new uw(this.slidingWindowSize),this.currentModality=null,this.previousModality=null,this.inProcess=!1}processBandwidth(e,t,i){this.currentModality?this.handleStopEvent(t,i):this.handleStartEvent(t,i),this.inProcess&&(this.stabilizationTime++,this.slidingWindow.add(e),this.inProcess=!this.slidingWindow.isFull||!this.isBandwidthStable())}getReport(e=!1){if(void 0!==this.stabilizationTime)return{time:this.inProcess?this.stabilizationTime:Math.max(this.stabilizationTime-this.slidingWindowSize,0),bandwidth:e?Ct(this.averageBandwidth,2):this.averageBandwidth,finished:!this.inProcess,modality:this.previousModality}}handleStartEvent(e,t){this.currentModality=this.GetModalityString(e),t&&this.currentModality&&!this.previousModality&&(this.previousModality=this.currentModality,this.stabilizationTime=0,this.slidingWindow.clear(),this.inProcess=!0)}handleStopEvent(e,t){t&&(this.directionalityCheck(e.audio)||this.directionalityCheck(e.video)||this.directionalityCheck(e.sharing))||(this.currentModality=null,this.inProcess=!1)}GetModalityString(e){return[this.directionalityCheck(e.audio)?Qe.MODALITY.audio:null,this.directionalityCheck(e.video)?Qe.MODALITY.video:null,this.directionalityCheck(e.sharing)?Qe.MODALITY.sharing:null].filter(Boolean).join(", ")}isBandwidthStable(){if(this.averageBandwidth=it(this.slidingWindow.items),this.averageBandwidth<this.minBandwidth)return!1;{const e=this.averageBandwidth*this.maxDeviation,t=this.averageBandwidth-e,i=this.averageBandwidth+e;return this.slidingWindow.items.every((e=>mt(e,t,i)))}}},tk=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.uplinkStabilizationTelemetry=new ek(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,zp),this.downlinkSabilizationTelemetry=new ek(this.configProvider.config.downlinkBWStabilizationSlidingWindowSize,this.configProvider.config.downlinkBWStabilizationMaxDeviation,this.configProvider.config.downlinkBWStabilizationMinBandwidth,Jp),this.bandwidthCalculator=new IO,this.bandwidthAvg=new uO}processStats(e){const t=this.diagnostics.getObjectRef(),i=t?.activeModalities;if(!i||!e.transports)return;const n=e.transports[Object.keys(e.transports)[0]],r=t?.reportedReceiveBandwidth?.[t.reportedReceiveBandwidth.length-1],s=n?.selectedCandidatePair?.availableOutgoingBitrate,a=e.audio?.send?.length>0||e.video?.send?.length>0||e.sharing?.send?.length>0,o=e.audio?.recv?.length>0||e.video?.recv?.length>0||e.sharing?.recv?.length>0;this.bweType!==t?.bweType&&(this.bandwidthCalculator=new IO,this.bandwidthAvg=new uO,this.bweType=t?.bweType);const c="REMB"===t?.bweType?"availableIncomingBitrate":"availableOutgoingBitrate",l=n?.selectedCandidatePair?.[c];this.bandwidthCalculator.captureSample(l),this.bandwidthAvg.captureSample(l);try{this.uplinkStabilizationTelemetry.processBandwidth(s,i,a),this.downlinkSabilizationTelemetry.processBandwidth(r,i,o)}catch(e){this.diagnostics.addStatsError("BandwithStatsProcessor",Ve(e))}}getStabilizedReport(e=!1){return this.uplinkStabilizationTelemetry.getReport(e)}getDownlinkStabilizedReport(e=!1){return this.downlinkSabilizationTelemetry.getReport(e)}calculateBwPercentiles(){if(!this.bandwidthCalculator.getFirst())return;const e=this.configProvider.config.bwPercentiles,t={};return e.forEach((e=>{Object.defineProperty(t,e,{value:this.bandwidthCalculator.calculatePercentile(e/100),enumerable:!0})})),t}getBandwidthReport(){return{startOfTheCall:this.bandwidthCalculator.getFirst(),endOfTheCall:this.bandwidthCalculator.getLast(),std:this.bandwidthCalculator.calculateStd(),bwPercentiles:this.calculateBwPercentiles(),avgBwe:Ct(this.bandwidthAvg.avg,2)}}},ik=class{constructor(e,t){this.configProvider=e,this.diagnostics=t,this.dataChannelStatsProcessor=new QO(this.diagnostics,this.configProvider),this.transportStatsProcessor=new KO(this.diagnostics,this.configProvider),this.audioStatsProcessor=new xO(this.diagnostics,this.configProvider),this.videoStatsProcessor=new jO(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new jO(this.diagnostics,this.configProvider),this.bandwithStatsProcessor=new tk(this.diagnostics,this.configProvider),this.macroblockStatsTracker=new PO,this.statsAggregators={audio:{recv:new FO,send:new BO(this.diagnostics)},video:{recv:new WO(this.configProvider),send:new JO(this.configProvider)},sharing:{recv:new WO(this.configProvider),send:new JO(this.configProvider)}},this.aggregatedModalityStats={},this.recvVideoStreamsCounter=new gO,this.multiviewData={},this.multiviewKeySet=new Set,this.statsOnSubscribedData={video:{},sharing:{}},this.statsOnSubscribed={video:[],sharing:[]},this.diagnostics.aggregatedStatsRef=this.aggregatedModalityStats,this.diagnostics.statsOnSubscribed=this.statsOnSubscribed,this.diagnostics.bandwidthDiagnostic=this.bandwithStatsProcessor}processStats(e){this.dataChannelStatsProcessor.processStats(e.data),this.transportStatsProcessor.processStats(e.transports),this.audioStatsProcessor.processStats(e.audio),this.videoStatsProcessor.processStats(e.video),this.sharingStatsProcessor.processStats(e.sharing),this.bandwithStatsProcessor.processStats(e),this.diagnostics.bwStabiliationTime=this.bandwithStatsProcessor.getStabilizedReport(!0),this.diagnostics.bwDownlinkStabiliationTime=this.bandwithStatsProcessor.getDownlinkStabilizedReport(!0),this.recvVideoStreamsCounter.captureSample(e.video?.recv?.length),this.diagnostics.recvVideoStreamsCount={min:this.recvVideoStreamsCounter.min,max:this.recvVideoStreamsCounter.max,mode:this.recvVideoStreamsCounter.mode};try{this.processAggregated(e)}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processAggregated",Ve(e))}try{this.processMultiview(e.video?.recv??[])}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processMultiview",Ve(e))}try{const e=navigator?.connection;e&&this.diagnostics.addNetworkInfo({downlink:e.downlink,rtt:e.rtt,effectiveType:e.effectiveType,saveData:e.saveData})}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processStats(networkInfo)",Ve(e))}try{this.processMacroblockRateStats(e.video?.recv)}catch(e){this.diagnostics.addStatsError("webrtcStatistics: processMacroblockRateStats",Ve(e))}}signalNoConnection(){this.transportStatsProcessor=new KO(this.diagnostics,this.configProvider),this.audioStatsProcessor=new xO(this.diagnostics,this.configProvider),this.videoStatsProcessor=new jO(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new jO(this.diagnostics,this.configProvider)}processMultiview(e){const t=new Set;for(const i of e){const e=i.inboundRTP.id;t.add(e);let n=this.multiviewData[e];n&&this.multiviewKeySet.has(e)?n.stats.duration++:(n={bitrateAverager:new uO,jitterAverager:new uO,frameRateAverager:new uO,freezeHistogram:new SO,resolutionDurations:new vO,isRenderingEvents:[],statsOnSubscribed:new ZO(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),stats:{ssrc:i.inboundRTP.ssrc,startTime:Date.now(),duration:0,framesDecoded:[],bytesReceived:[],height:[],width:[]}},n.statsOnSubscribed.prepareCollectingStatsOnSubscribed(i.renderer?.msi),this.multiviewData[e]=n),n.statsOnSubscribed.captureStatsOnSubscribed(i.inboundRTP.framesDecoded,i.inboundRTP.bytesReceived,i.inboundRTP.frameHeight),n.bitrateAverager.captureSample(i.extensions?.bitrate),n.jitterAverager.captureSample(1e3*(i.inboundRTP.jitter??0)),n.frameRateAverager.captureSample(i.extensions.frameRateReceived),n.freezeHistogram.active=i.extensions?.isFrozen,i.inboundRTP.frameWidth&&i.inboundRTP.frameHeight&&n.resolutionDurations.captureSample(`${i.inboundRTP.frameWidth}x${i.inboundRTP.frameHeight}`);const r=i.renderer?.isRendering??!1;(!n.isRenderingEvents.length&&r||n.isRenderingEvents.length&&bt(n.isRenderingEvents).isRendering!==r)&&Tt(n.isRenderingEvents,{isRendering:r,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents),n.stats.frameRateAvg=Ct(n.frameRateAverager.avg),n.stats.bitrateAvg=Ct(n.bitrateAverager.avg,0),n.stats.bitrateMax=Ct(n.bitrateAverager.maxSample,0),n.stats.bitrateMinNonZero=Ct(n.bitrateAverager.minNonZeroSample),n.stats.freezeHistogram=n.freezeHistogram.counts,n.stats.freezeTimestamps=n.freezeHistogram.timestamps,n.stats.avgFreezeDuration=Ct(n.freezeHistogram.avgDuration),n.stats.totalFreezeDuration=n.freezeHistogram.totalDuration,n.stats.ongoingFreeze=n.freezeHistogram.active,n.stats.ongoingFreezeDuration=n.freezeHistogram.ongoingDuration,n.stats.numResolutionSwitches=n.resolutionDurations.changeCount,n.stats.rendererSize=`${i.renderer?.rendererSize?.width}x${i.renderer?.rendererSize?.height}`,n.stats.resolutionDurations=n.resolutionDurations.durations,n.stats.timeToFirstFrame=i.renderer?.timeToFirstFrame,n.stats.timeToFirstFrameSinceSubscriptionStart=i.renderer?.timeToFirstFrameSinceSubscriptionStart,n.stats.isRenderingEvents=n.isRenderingEvents,n.stats.statsOnSubscribed=n.statsOnSubscribed.getStatsOnSubscribed(),n.stats.msi=i.renderer?.msi,n.stats.rendererStates=i.renderer?.rendererStates,Tt(n.stats.framesDecoded,i.inboundRTP.framesDecoded,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),Tt(n.stats.bytesReceived,i.inboundRTP.bytesReceived,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),Tt(n.stats.height,i.inboundRTP.frameHeight,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),Tt(n.stats.width,i.inboundRTP.frameWidth,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples);const s=i.extensions?.macroblockRateStats??{};for(const e in s)n.stats[e]=Ct(s[e],0)}this.diagnostics.multiViewStats=Object.values(this.multiviewData).map((e=>e.stats)),this.multiviewKeySet=t}processAggregated(e){for(const t of["audio","video","sharing"])if(e[t])for(const i in e[t])this.processAggregatedModality(e,t,i)}processAggregatedModality(e,t,i){var n,r;const s=e[t]?.[i]?.length??0;s>0&&((n=this.aggregatedModalityStats)[t]??(n[t]={}),(r=this.aggregatedModalityStats[t])[i]??(r[i]=[]),s>1&&("audio"===t||"sharing"===t)&&this.diagnostics.addStatsError("webrtcStatistics:processAggregatedModality",`Multiple ${t} ${i} streams: ${s}`),this.statsAggregators[t][i].processSample(e[t][i],this.aggregatedModalityStats[t][i],this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),"sharing"!==t&&"video"!==t||"recv"!==i||this.processStatsOnSubscribed(e[t][i],t))}processStatsOnSubscribed(e,t){const i=new Set;for(const n of e)if(n.inboundRTP){const e=`${n.inboundRTP.id}x${n.renderer?.msi}`;let r=this.statsOnSubscribedData[t]?.[e];i.add(e),r||(r=new ZO(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),r.prepareCollectingStatsOnSubscribed(n.renderer?.msi),this.statsOnSubscribedData[t][e]=r,this.statsOnSubscribed[t].push(...r.getStatsOnSubscribed())),r.captureStatsOnSubscribed(n.inboundRTP.framesDecoded,n.inboundRTP.bytesReceived)}!function(e,t){const i=[];for(const n of Object.keys(e))t.has(n)||i.push(n);for(const t of i)delete e[t]}(this.statsOnSubscribedData[t],i)}processMacroblockRateStats(e){if(!e?.length)return;let t=0,i=0;for(const n of e)t+=n.extensions?.macroblockRateReceived,i+=n.extensions?.macroblockRateDecoded;this.macroblockStatsTracker.captureSample(t,i),this.diagnostics.setTotalVideoRecvMblocksRates(this.macroblockStatsTracker.getReport())}},nk=p,rk=class{constructor(e,t,i,n){this.logger=e,this.configProvider=t,this.diagnostics=i,this.mediaManager=n,this.webrtcStats=new ik(this.configProvider,this.diagnostics),this.ssrcToRecvTrackMap=new Map,this.activeChannels={}}setAudioDecoderStatsProvider(e){this.audioDecoderStatsProvider=e}signalNoConnection(){this.webrtcStats.signalNoConnection()}processRawReport(e){this.diagnostics.latestRawReport=e;const t={loopTime:-1,fetchTime:-1,convertTime:-1,processingTime:-1,legacyProcessingTime:-1};try{let i=Pt(),n=i;const r=this.convertStatsReport(e);return r.perfCounters=t,i=Pt(),t.convertTime=i-n,n=i,this.webrtcStats.processStats(r),this.diagnostics.addStatsReport(r),i=Pt(),t.processingTime=i-n,r}catch(e){const t=Ve(e);return this.logger.safe.error(`Error processing raw stats: ${t}`),void this.diagnostics.addStatsError("StatisticsGatherer:processRawReport",t)}}setSsrcTrackPair(e,t){null===t?this.ssrcToRecvTrackMap.delete(e):this.ssrcToRecvTrackMap.set(e,t)}convertStatsReport(e){const t={transports:this.processTransportStats(e)};return this.appendPcStats(e,t),this.appendSendMediaStats(e,t),this.appendRecvMediaStats(e,t),e["data-channel"]&&(t.data=Object.values(e["data-channel"])),t}processTransportStats(e){if(e.transport){const t={};for(const i in e.transport){const n=e.transport[i];if(t[i]=ot(n),n.selectedCandidatePairId){const r=ot(e["candidate-pair"][n.selectedCandidatePairId]);r.localCandidate=e["local-candidate"][r.localCandidateId],r.remoteCandidate=e["remote-candidate"][r.remoteCandidateId],t[i].selectedCandidatePair=r}n.localCertificateId&&e.certificate&&(t[i].localCertificate=e.certificate[n.localCertificateId]),n.remoteCertificateId&&e.certificate&&(t[i].remoteCertificate=e.certificate[n.remoteCertificateId])}return t}if(e["candidate-pair"]){const t={};for(const i in e["candidate-pair"]){const n=ot(e["candidate-pair"][i]);n.selected&&(n.localCandidate=e["local-candidate"][n.localCandidateId],n.remoteCandidate=e["remote-candidate"][n.remoteCandidateId],t.faketransport={id:"faketransport",timestamp:n.timestamp,type:"transport",selectedCandidatePair:n,selectedCandidatePairId:n.id})}return t}}appendPcStats(e,t){let i="";e["peer-connection"]&&(Object.keys(e["peer-connection"]).forEach((e=>{""===i?i=e:(this.logger.safe.error(`Unexpected second peer connection stats id ${e}, also found ${i}`),this.diagnostics.addStatsError("StatisticsGatherer","Unexpected second peer connection stats"))})),t.peerConnection=e["peer-connection"][i])}appendSendMediaStats(e,t){var i,n,r,s;for(const a in e["outbound-rtp"]){const o=e["outbound-rtp"][a],c={outboundRTP:o};o.codecId&&e.codec&&(c.codec=e.codec[o.codecId]),Object.defineProperty(c,"transport",{value:t.transports[o.transportId??"faketransport"],configurable:!1,enumerable:!1}),o.remoteId&&e["remote-inbound-rtp"]&&(c.remoteInboundRTP=e["remote-inbound-rtp"][o.remoteId]),o.mediaSourceId&&e["media-source"]&&(c.mediaSource=e["media-source"][o.mediaSourceId]),o.trackId&&e.track&&(c.track=e.track[o.trackId]);const l=lk(this.mediaManager,c.track?.trackIdentifier??c.mediaSource?.trackIdentifier,o.rid)??ck(this.mediaManager,o.ssrc,o.rid)??gk(this.mediaManager,c.outboundRTP.mid,o.rid);if(!l?.getLocalTrackId())continue;c.mediaEntity=l.serialize(),!c.mediaSource&&c.mediaEntity&&e["media-source"]&&(c.mediaSource=Object.values(e["media-source"]).find((e=>e.trackIdentifier===c.mediaEntity.localTrackId)));const d="video"===o.kind?"sharing"===l?.getModality()?"sharing":"video":o.kind;if((i=this.activeChannels)[d]??(i[d]={}),(n=this.activeChannels[d]).send??(n.send={}),zp(this.diagnostics.getObjectRef().activeModalities?.[d])){if(t[d]||(t[d]={}),t[d].send||(t[d].send=[]),"video"===o.kind){const e=dk(this.diagnostics,d,o.ssrc)??dk(this.diagnostics,d,0);e&&(c.requestedCapabilities=e);const i=hk(this.diagnostics,d,o.ssrc)??hk(this.diagnostics,d,0);i&&(c.appliedCapabilities=i);const n=t[d].send.find((e=>e.outboundRTP.trackId===c.outboundRTP.trackId));if(n){const e=parseInt(n.outboundRTP.rid,10)>parseInt(c.outboundRTP.rid,10);if(!n.altLayouts&&e&&(n.altLayouts=[]),e)n.altLayouts.push(c);else{c.altLayouts=[],c.altLayouts.push(n);const e=t[d].send.indexOf(n);t[d].send[e]=c}continue}}this.activeChannels[d].send[o.id]=c,t[d].send.push(c)}else this.activeChannels[d].send[o.id]&&"sharing"!==d&&(t.inactiveTracks??(t.inactiveTracks={}),(r=t.inactiveTracks)[d]??(r[d]={}),(s=t.inactiveTracks[d]).send??(s.send=[]),t.inactiveTracks[d].send.push(this.activeChannels[d].send[o.id]))}}appendRecvMediaStats(e,t){var i,n,r,s;const a=this.diagnostics.getObjectRef().subscriptionManager?.subscribedTrackIds;for(const o in e["inbound-rtp"]){const c=e["inbound-rtp"][o],l={inboundRTP:c};c.codecId&&e.codec&&(l.codec=e.codec[c.codecId]),"audio"===c.kind&&l.inboundRTP.ssrc===this.audioDecoderStatsProvider?.ssrc&&(l.codec||(l.codec={transportId:c.transportId??"faketransport",id:"fakeCodec",payloadType:999,timestamp:c.timestamp,type:"codec",mimeType:"unk"}),l.codec.mimeType=this.audioDecoderStatsProvider.codecName,l.inboundRTP=(0,nk.merge)(l.inboundRTP,this.audioDecoderStatsProvider.getWebRtcCompatibaleStats()),l.customHealerStats=this.audioDecoderStatsProvider.getWasmStats()),t.transports[c.transportId??"faketransport"]&&Object.defineProperty(l,"transport",{value:t.transports[c.transportId??"faketransport"],configurable:!1,enumerable:!1}),c.remoteId&&e["remote-outbound-rtp"]&&(l.remoteOutboundRTP=e["remote-outbound-rtp"][c.remoteId]);const d=l.inboundRTP.trackIdentifier??this.ssrcToRecvTrackMap.get(c.ssrc);if(c.trackId||d){c.trackId&&e.track?l.track=e.track[c.trackId]:d&&(l.track={id:"ssrcToTrackId",kind:c.kind,timestamp:c.timestamp,type:"track",trackIdentifier:d});const t=uk(this.diagnostics,l.track?.trackIdentifier);t&&(l.renderer=t)}const h=ok(this.mediaManager,l.track?.trackIdentifier)??ak(this.mediaManager,c.ssrc);if(!h)continue;l.mediaEntity=h.serialize();const u="video"===c.kind&&l.track?"sharing"===h?.getModality()?"sharing":"video":c.kind;(i=this.activeChannels)[u]??(i[u]={}),(n=this.activeChannels[u]).recv??(n.recv={}),"video"!==c.kind||a.some((e=>e&&e===l.track?.trackIdentifier))?Jp(this.diagnostics.getObjectRef().activeModalities?.[u])&&(t[u]||(t[u]={}),t[u].recv||(t[u].recv=[]),this.activeChannels[u].recv[c.id]=l,t[u].recv.push(l)):this.activeChannels[u].recv[c.id]&&"sharing"!==u&&(t.inactiveTracks??(t.inactiveTracks={}),(r=t.inactiveTracks)[u]??(r[u]={}),(s=t.inactiveTracks[u]).recv??(s.recv=[]),t.inactiveTracks[u].recv.push(this.activeChannels[u].recv[c.id]))}}};function sk(e,t){return!t||e.getSimulcastContext()?.activeRids.map(String).some((e=>e===t))}function ak(e,t){return e.getMediaEntities().find((e=>e.getRemoteSsrc()===t))}function ok(e,t){const i=e.getMediaEntities();return void 0!==t?i.find((e=>e.getRemoteTrackId()===t)):void 0}function ck(e,t,i){return e.getMediaEntities().find((e=>e.getLocalSsrc()===t&&sk(e,i)))}function lk(e,t,i){const n=e.getMediaEntities();return t?n.find((e=>e.getLocalTrackId()===t&&sk(e,i))):void 0}function dk(e,t,i){const n=e.getObjectRef().qualityManager;return"video"===t?n?.currentVideoSsrcRequestedCapabilities[`${i}`]:"sharing"===t?n?.currentSharingSsrcRequestedCapabilities[`${i}`]:void 0}function hk(e,t,i){const n=e.getObjectRef().qualityManager;return"video"===t?n?.currentVideoSsrcAppliedCapabilities[`${i}`]:"sharing"===t?n?.currentSharingSsrcAppliedCapabilities[`${i}`]:void 0}function uk(e,t){return e.getObjectRef().remoteVideoManager?.renderers.find((e=>e.trackId===t))}function gk(e,t,i){const n=e.getMediaEntities();return t?n.find((e=>e.getMid()===t&&sk(e,i))):void 0}var pk=class{constructor(){this.googCandidatePair={},this.ssrc={},this.googComponent={},this.VideoBwe={bweforvideo:{}}}},mk=class{constructor(){this.statistics=new pk,this.statsDiffMap=new Map,this.ssrcTrackMap=new Map}build(e){return this.statistics=new pk,this.constructGoogCandidatePair(e),this.constructGoogSsrc(e),this.constructGoogComponent(e),this.constructDataChannel(e),this.constructBwe(e),this.statistics}setSsrcTrackPair(e,t){null===t?this.ssrcTrackMap.delete(e):this.ssrcTrackMap.set(e,t)}setAudioDecoderStatsProvider(e){this.audioDecoderStatsProvider=e}constructGoogSsrc(e){const t={};if(e.hasOwnProperty("outbound-rtp")){const i=e["outbound-rtp"];Object.keys(i).forEach((n=>{const r=`ssrc_${i[n].ssrc}_send`,s=this.constructSendSsrc(e,i[n]);t[r]=s}))}if(e.hasOwnProperty("inbound-rtp")){const i=e["inbound-rtp"];Object.keys(i).forEach((n=>{const r=`ssrc_${i[n].ssrc}_recv`,s=this.constructRecvSsrc(e,i[n]);t[r]=s}))}this.statistics.ssrc=t}constructSendSsrc(e,t){const i=t.trackId?e.track[t.trackId]:null,n=t.mediaSourceId?e["media-source"][t.mediaSourceId]:null,r=e["remote-inbound-rtp"]?.[t.remoteId],s=`ssrc_${t.ssrc}_send`,a=n?.trackIdentifier??i?.trackIdentifier??this.ssrcTrackMap.get(t.ssrc);let o={id:s,ssrc:t.ssrc,mediaType:t.mediaType??t.kind,bytesSent:t.bytesSent,bytesSentDiff:this.calculateDiff(s,t.bytesSent,4),packetsSent:t.packetsSent,packetsLost:r?.packetsLost,jitter:r?.jitter,googRtt:this.getRtt(r),googCodecName:this.getCodec(e,t.codecId),transportId:t.transportId,googTrackId:a};return"audio"===o.mediaType&&(o={...o,...this.constructAudioSendSsrc(t,n)}),"video"===o.mediaType&&(o={...o,...this.constructVideoSendSsrc(t,n,s,i)}),lt(o)}constructAudioSendSsrc(e,t){return{audioInputLevel:t?.audioLevel,totalAudioEnergy:t?.totalAudioEnergy,fecPacketsSent:e.fecPacketsSent}}constructVideoSendSsrc(e,t,i,n){return{framesEncoded:e.framesEncoded,googFrameRateEncoded:this.calculateDiff(i,e.framesEncoded,2),googFrameRateSent:this.calculateDiff(i,e.framesSent??n?.framesSent,1),googFrameRateInput:t?.framesPerSecond,googFrameHeightSent:e.frameHeight??n?.frameHeight,googFrameWidthSent:e.frameWidth??n?.frameWidth,googFrameHeightInput:t?.height,googFrameWidthInput:t?.width,hugeFramesSent:e.hugeFramesSent??n?.hugeFramesSent,keyFramesEncoded:e.keyFramesEncoded,qpSum:e.qpSum,qp:this.calculateDiff(i,e.qpSum,8),googPlisReceived:e.pliCount,googFirsReceived:e.firCount,googNacksReceived:e.nackCount,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,codecImplementationName:e.encoderImplementation,rid:e.rid,encodeTime:e.totalEncodeTime&&Math.round(1e3*this.calculateDiff(i,e.totalEncodeTime,6))}}constructRecvSsrc(e,t){const i=t.trackId?e.track[t.trackId]:null,n=`ssrc_${t.ssrc}_recv`,r=t.trackIdentifier??i?.trackIdentifier??this.ssrcTrackMap.get(t.ssrc);let s={id:n,ssrc:t.ssrc,mediaType:t.mediaType??t.kind,bytesReceived:t.bytesReceived,bytesReceivedDiff:this.calculateDiff(n,t.bytesReceived,5),packetsReceived:t.packetsReceived,packetsLost:t.packetsLost,jitter:t.jitter,googJitterBufferMs:t.jitterBufferEmittedCount&&Math.round(t.jitterBufferDelay/t.jitterBufferEmittedCount*1e3),googCodecName:this.getCodec(e,t.codecId),googTrackId:r,transportId:t.transportId};return"audio"===s.mediaType&&(s={...s,...this.constructAudioRecvSsrc(t,i)}),"video"===s.mediaType&&(s={...s,...this.constructVideoRecvSsrc(t,n,i)}),lt(s)}constructAudioRecvSsrc(e,t){const i=this.audioDecoderStatsProvider?.ssrc===e.ssrc?this.audioDecoderStatsProvider?.getWebRtcCompatibaleStats():e,n={audioOutputLevel:i.audioLevel??t?.audioLevel,totalAudioEnergy:i.totalAudioEnergy??t?.totalAudioEnergy,concealedSamples:i.concealedSamples,silentConcealedSamples:i.silentConcealedSamples,totalSamplesReceived:i.totalSamplesReceived,healedRatio:i.totalSamplesReceived&&(i.concealedSamples-i.silentConcealedSamples)/i.totalSamplesReceived,fecPacketsReceived:i.fecPacketsReceived,fecPacketsDiscarded:i.fecPacketsDiscarded,packetsDiscarded:i.packetsDiscarded};if(this.audioDecoderStatsProvider?.ssrc===e.ssrc){n.googJitterBufferMs=i.jitterBufferEmittedCount&&Math.round(i.jitterBufferDelay/i.jitterBufferEmittedCount*1e3),n.googCodecName=this.audioDecoderStatsProvider.codecName;const e=this.audioDecoderStatsProvider.getDecoderStats();n.pushCount=e.pushCount,n.pushErrCount=e.pushErrCount,n.pullCount=e.pullCount,n.pullErrCount=e.pullErrCount}return n}constructVideoRecvSsrc(e,t,i){return{framesDecoded:e.framesDecoded,googFrameRateDecoded:this.calculateDiff(t,e.framesDecoded,3),googFrameRateReceived:this.calculateDiff(t,e.framesReceived??i?.framesReceived,0),googFrameHeightReceived:e.frameHeight??i?.frameHeight,googFrameWidthReceived:e.frameWidth??i?.frameWidth,keyFramesDecoded:e.keyFramesDecoded,googPlisSent:e.pliCount,googFirsSent:e.firCount,googNacksSent:e.nackCount,codecImplementationName:e.decoderImplementation,decodeTime:e.totalDecodeTime&&Math.round(1e3*this.calculateDiff(t,e.totalDecodeTime,7))}}constructGoogCandidatePair(e){const t=e["candidate-pair"];t&&Object.keys(t).forEach((i=>{const n=this.constructPair(e,t[i]);this.statistics.googCandidatePair[n.id]=n}))}constructPair(e,t){const i=e["local-candidate"][t.localCandidateId],n=e["remote-candidate"][t.remoteCandidateId];return lt({bytesReceived:t.bytesReceived,bytesSent:t.bytesSent,googTransportType:i.protocol,googRtt:t.currentRoundTripTime?Math.round(1e3*t.currentRoundTripTime):void 0,googLocalAddress:`${i.ip?i.ip:i.address}:${i.port}`,googLocalCandidateType:i.candidateType,localRelayProtocol:i.relayProtocol,localNetworkType:i.networkType,googRemoteAddress:`${n.ip?n.ip:n.address}:${n.port}`,googRemoteCandidateType:n.candidateType,googActiveConnection:t.nominated,requestsReceived:t.requestsReceived,requestsSent:t.requestsSent,responsesReceived:t.responsesReceived,responsesSent:t.responsesSent,consentRequestsSent:t.consentRequestsSent,id:t.id,remoteCandidateId:t.remoteCandidateId,localCandidateId:t.localCandidateId,googWritable:t.writable,selected:t.selected,packetsDiscardedOnSend:t.packetsDiscardedOnSend})}constructGoogComponent(e){e.transport&&Object.keys(e.transport).forEach((t=>{this.statistics.googComponent[t]={id:t,selectedCandidatePairId:e.transport[t].selectedCandidatePairId}}))}constructDataChannel(e){if(!e.hasOwnProperty("data-channel"))return;const t=e["data-channel"];this.statistics.data=Object.keys(t).map((e=>{const i=t[e];return{bytesReceived:i.bytesReceived,bytesSent:i.bytesSent,dataChannelIdentifier:i.dataChannelIdentifier,label:i.label,messagesReceived:i.messagesReceived,messagesSent:i.messagesSent,protocol:i.protocol,state:i.state,timestamp:i.timestamp,type:i.type}}))}constructBwe(e){const t=Object.values(e["outbound-rtp"]??{})?.find((e=>{const t=e.mediaType??e.kind;return"audio"===t||"video"===t}));if(!t)return;const i=e.transport?.[t.transportId];if(!i)return;const n=e["candidate-pair"]?.[i.selectedCandidatePairId];if(!n)return;const r={googAvailableSendBandwidth:n.availableOutgoingBitrate,googAvailableReceiveBandwidth:n.availableIncomingBitrate};this.statistics.VideoBwe.bweforvideo=lt(r)}getRtt(e){const t=e?.roundTripTime;return t?Math.round(1e3*t):void 0}getCodec(e,t){if(t&&e.codec&&e.codec[t])return e.codec[t].mimeType.split("/")[1]}calculateDiff(e,t,i){if(void 0===t)return;let n=t;const r=this.statsDiffMap.has(e)?this.statsDiffMap.get(e):new Map;if(r.has(i)){const e=r.get(i);e<=t&&(n=t-e)}return r.set(i,t),this.statsDiffMap.set(e,r),isNaN(n)?void 0:n}},fk=p,Sk=p,vk=class{constructor(e){this.healedRatio=0,this.healedRatioMax=0,this.healedRatioDuration=0,this.healedRatioTotal=0,this.totalSamplesReceivedDiff=0;const t=e.config;this.networkDetectionDuration=t.webrtcStatNetworkDetectionDuration,this.networkRecvQualityDiagnostics=t.networkRecvQualityDiagnostics,this.networkRecvQualityDiagnostics&&(this.healedRatioAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesDiffAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesDiffAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedDiffAccumulator=new uw(t.webrtcHealedRatioExtendedWindowSize))}captureHealedRatioSamples(e,t,i){!e||!t||!i||e.length<=this.networkDetectionDuration||t.length<=this.networkDetectionDuration||i.length<=this.networkDetectionDuration||this.setHealedRatioPerDuration(e,t,i)}getHealedRatioMax(){return this.healedRatioMax}getHealedRatioAvg(){return this.healedRatioDuration?this.healedRatioTotal/this.healedRatioDuration:0}getHealedRatio(){return this.healedRatio}getTotalSamplesReceivedDiff(){return this.totalSamplesReceivedDiff}setHealedRatioPerDuration(e,t,i){const n=-1-this.networkDetectionDuration,r=Math.max((0,Sk.last)(e)-(0,Sk.nth)(e,n),0),s=Math.max((0,Sk.last)(t)-(0,Sk.nth)(t,n),0);this.totalSamplesReceivedDiff=Math.max((0,Sk.last)(i)-(0,Sk.nth)(i,n),0),0!==this.totalSamplesReceivedDiff&&(this.healedRatio=(r-s)/this.totalSamplesReceivedDiff,this.healedRatioDuration++,this.healedRatioTotal+=this.healedRatio,this.healedRatioMax=Math.max(this.healedRatioMax,this.healedRatio),this.networkRecvQualityDiagnostics&&(this.concealedSamplesAccumulator.add((0,Sk.last)(e)),this.silentConcealedSamplesAccumulator.add((0,Sk.last)(t)),this.totalSamplesReceivedAccumulator.add((0,Sk.last)(i)),this.concealedSamplesDiffAccumulator.add(r),this.silentConcealedSamplesDiffAccumulator.add(s),this.totalSamplesReceivedDiffAccumulator.add(this.totalSamplesReceivedDiff),this.healedRatioAccumulator.add(this.healedRatio)))}getDiagnostics(e){return{quality:(0,Sk.last)(e),qualityLevels:e,concealedSamples:this.concealedSamplesAccumulator.items,silentConcealedSamples:this.silentConcealedSamplesAccumulator.items,totalSamplesReceived:this.totalSamplesReceivedAccumulator.items,concealedSamplesDiff:this.concealedSamplesDiffAccumulator.items,silentConcealedSamplesDiff:this.silentConcealedSamplesDiffAccumulator.items,totalSamplesReceivedDiff:this.totalSamplesReceivedDiffAccumulator.items,healedRatio:this.healedRatioAccumulator.items.map((e=>Ct(e)))}}},yk=class{constructor(e=100){this.minPacketsReceivedToCalculatePacketLossRate=e,this.packetsReceivedForPrevWindow=0,this.packetsLostForPrevWindow=0,this.packetLostRateMax=0,this.totalPacketsLost=0,this.totalPacketsRecv=0,this.packetsLostDuration=0}capturePacketsLostAndPacketsReceived(e,t){this.packetsLostDuration+=Qe.TIME_INTERVAL.SEC_1,this.totalPacketsRecv=t,this.totalPacketsLost=e,this.calculateMaxLostRateInWindowSize(e,t)}getPacketsLostRateMax(){return this.packetLostRateMax}getNetworkAvgLostRate(){const e=this.totalPacketsLost+this.totalPacketsRecv;return e>0?this.totalPacketsLost/e:0}getAvgPacketsLost(){return this.totalPacketsLost?Ct(this.totalPacketsLost/this.packetsLostDuration,2):0}calculateMaxLostRateInWindowSize(e,t){const i=t-this.packetsReceivedForPrevWindow;if(i<this.minPacketsReceivedToCalculatePacketLossRate)return;this.packetsReceivedForPrevWindow=t;const n=e-this.packetsLostForPrevWindow;this.packetsLostForPrevWindow=e,this.packetLostRateMax=Math.max(Ct(n*this.minPacketsReceivedToCalculatePacketLossRate/(n+i),2),this.packetLostRateMax)}},Ck=class{constructor(e){this.configProvider=e,this.audioAnalyzers=new Map,this.jitterBufferDuration=0,this.jitterBufferTotal=0,this.jitterTotal=0,this.jitterDuration=0,this.rttDuration=0,this.rttTotal=0,this.rttMax=0,this.jitterMax=0,this.webrtcAudioPacketLossRate=new yk(e.config.minPacketsReceivedToCalculatePacketLossRate)}captureJitterBuffer(e){this.jitterBufferDuration+=Qe.TIME_INTERVAL.SEC_1,this.jitterBufferTotal+=e}captureJitter(e){const t=1e3*e;this.jitterTotal+=t,this.jitterMax=Math.max(t,this.jitterMax),this.jitterDuration+=Qe.TIME_INTERVAL.SEC_1}getJitterAvg(){return this.jitterDuration?Ct(this.jitterTotal/this.jitterDuration):0}getAvgJitterBuffer(){return this.jitterBufferDuration?Math.round(this.jitterBufferTotal/this.jitterBufferDuration):0}capturePacketsLostAndPacketsReceived(e,t){this.webrtcAudioPacketLossRate.capturePacketsLostAndPacketsReceived(e,t)}getPacketsLostRateMax(){return this.webrtcAudioPacketLossRate.getPacketsLostRateMax()}getNetworkAvgLostRate(){return this.webrtcAudioPacketLossRate.getNetworkAvgLostRate()}getAvgPacketsLost(){return this.webrtcAudioPacketLossRate.getAvgPacketsLost()}captureRtt(e){if(null!==e){const t=parseInt(e);this.rttDuration+=Qe.TIME_INTERVAL.SEC_1,this.rttTotal+=t,this.rttMax=Math.max(this.rttMax,t)}}getAvgRtt(){return this.rttDuration?Ct(this.rttTotal/this.rttDuration):0}getMaxRtt(){return this.rttMax}getJitterMax(){return this.jitterMax}updateSendStream(e,t){if(!this.configProvider.config.useAudioAnalyzer)return;const i=this.audioAnalyzers.get(t);i&&(i.dispose(),this.audioAnalyzers.delete(t)),e?.rawStream?.getAudioTracks().length&&this.audioAnalyzers.set(t,new bM(e.rawStream))}getInputLevel(e){const t=this.audioAnalyzers.get(e);return t?.getInputLevel()}},_k=class{constructor(e,t){this.dropBadBandwidth=e,this.dropGoodBandwidth=t,this.dropDurationCounts={},Object.keys(Qe.HISTOGRAM_BATCH).forEach((e=>{this.dropDurationCounts[e]=0}))}recordSendBandwidth(e){this.currentDropDuration&&e<this.dropGoodBandwidth||e<this.dropBadBandwidth?this.initiateDrop():this.currentDropDuration&&e>this.dropGoodBandwidth&&this.recoverDrop()}getReport(){const e=ot(this.dropDurationCounts);return this.currentDropDuration&&(e.ongoingDuration=this.currentDropDuration),e}initiateDrop(){this.currentDropDuration?this.currentDropDuration++:this.currentDropDuration=1}recoverDrop(){for(const e of Object.keys(Qe.HISTOGRAM_BATCH))if(this.currentDropDuration<=Qe.HISTOGRAM_BATCH[e]){this.dropDurationCounts[e]+=1,this.currentDropDuration=0;break}}},Ek=p,Tk=class{constructor(e,t,i,n){this.lowThreshold=e,this.highThreshold=t,this.isLowerBetter=i,this.curInLowerRange=i,this.stateTracker=new Ik(n)}onSample(e,t){let i=this.curInLowerRange;this.curInLowerRange?e>this.highThreshold&&(i=!1):e<this.lowThreshold&&(i=!0);const n=this.stateTracker.onNewState(this.getQuality(i),t);return n!==this.getQuality(this.curInLowerRange)&&(this.curInLowerRange=i),n}getQuality(e){return e===this.isLowerBetter?"Good":"Bad"}},Ik=class{constructor(e){this.stickinessTime=e}onNewState(e,t){return"Good"!==e&&"Bad"!==e?this.curState:0===this.stickinessTime?e:e===this.curState?(this.stickTimerStarted=0,this.curState):("Bad"===this.curState?0===this.stickTimerStarted?this.stickTimerStarted=t:t-this.stickTimerStarted>this.stickinessTime&&(this.curState=e,this.stickTimerStarted=0):(this.curState=e,this.stickTimerStarted=0),this.curState)}},bk=class{constructor(e,t,i,n){this.stateProcessor=e,this.windowSize=t,this.extendedWindowSize=i,this.addDiagnosticData=n,this.dataAccumulator=new uw(i),this.avgAccumulator=new uw(i)}getLatestSendQuality(e,t,i){if(this.dataAccumulator.add(e),this.dataAccumulator.items.length>=this.windowSize){const e=this.dataAccumulator.items.slice(-this.windowSize),i=(0,Ek.mean)(e);return this.addDiagnosticData&&this.avgAccumulator.add(i),this.stateProcessor.onSample(i,t)}return i}getData(){return this.dataAccumulator.items.map((e=>Ct(e)))}getAggregatedData(){return this.avgAccumulator.items.map((e=>Ct(e)))}},Ak=class{constructor(e,t,i){this.configProvider=e,this.newStatsApi=t,this.webrtcHealedRatio=i,this.sendAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiffAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostDiffAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.totalAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendQualityAccumulator=new uw(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiagnosticsEnabled=this.configProvider.config.networkSendQualityDiagnostics,this.recvDiagnosticsEnabled=this.configProvider.config.networkRecvQualityDiagnostics,this.recvQualityAccumulator=new uw(this.configProvider.config.webrtcHealedRatioExtendedWindowSize);const n=Number(this.configProvider.config.webrtcStatNetworkDetectionHysteresis);this.networkDetectionBadLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionBadLevel)+n/2,this.networkDetectionBadLevelLow=this.networkDetectionBadLevelHigh-n,this.networkDetectionGoodLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionGoodLevel)+n/2,this.networkDetectionGoodLevelLow=this.networkDetectionGoodLevelHigh-n;const r=new Tk(e.config.webrtcJitterLowThreshold,e.config.webrtcJitterHighThreshold,!0,e.config.webrtcJitterSticknessTime),s=new Tk(e.config.webrtcLossRateLowThreshold,e.config.webrtcLossRateHighThreshold,!0,e.config.webrtcLossRateSticknessTime);this.jitterCalculator=new bk(r,e.config.webrtcJitterWindowSize,e.config.webrtcJitterExtendedWindowSize,this.sendDiagnosticsEnabled),this.lossRateCalculator=new bk(s,e.config.webrtcLossRateWindowSize,e.config.webrtcLossRateExtendedWindowSize,this.sendDiagnosticsEnabled)}calculateNetworkSendQualityLevel(e,t,i,n){if(!e||!t)return{quality:n};if(e.length<2||t.length<2||(0,Ek.last)(e)<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return{quality:n};const r=Date.now(),s=(0,Ek.last)(i),a=this.jitterCalculator.getLatestSendQuality(s,r,n),[o,c]=e.slice(-2),[l,d]=t.slice(-2),h=this.getLossRate(c,o,d,l),u=this.lossRateCalculator.getLatestSendQuality(h,r,n),g="Good"===a&&"Good"===u?"Good":"Bad";return this.sendDiagnosticsEnabled&&(this.sendAccumulator.add(c),this.lostAccumulator.add(d),this.sendQualityAccumulator.add(g)),this.sendDiagnosticsEnabled?{quality:g,packetsSend:this.sendAccumulator.items,packetsLost:this.lostAccumulator.items,packetsSendDiff:this.sendDiffAccumulator.items,packetsLostDiff:this.lostDiffAccumulator.items,lossRates:this.lossRateCalculator.getData(),lossRatesAggregated:this.lossRateCalculator.getAggregatedData(),jitter:this.jitterCalculator.getData(),jitterAggregated:this.jitterCalculator.getAggregatedData(),qualityLevels:this.sendQualityAccumulator.items}:{quality:g}}calculateNetworkRecvQualityLevel(e){if(this.newStatsApi){const t=e;return this.calculateNetworkRecvQualityLevelNewStatsApi(t.concealedSamples,t.silentConcealedSamples,t.totalSamplesReceived,t.oldNetworkLevel)}{const t=e;return this.calculateNetworkRecvQualityLevelLegacyStatsApi(t.googDecodingCTN,t.googDecodingPLC,t.oldNetworkLevel)}}calculateNetworkRecvQualityLevelLegacyStatsApi(e,t,i){const n=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!e||!t||e.length<2*n)return{quality:i};let r=e.length-1-n;const s=e[e.length-1];for(;r>=0&&s-e[r]<100*n;)r--;if(r<0)return{quality:i};const a=s-e[r],o=t[t.length-1]-t[r];if(a<=0)return{quality:i};const c=o/a;return{quality:this.getRecvQuality(c,i)}}calculateNetworkRecvQualityLevelNewStatsApi(e,t,i,n){const r=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!e||e.length<=r||!t||t.length<=r||!i||i.length<=r)return{quality:n};if((0,Ek.last)(i)<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality)return{quality:n};if(0===this.webrtcHealedRatio.getTotalSamplesReceivedDiff())return{quality:n};const s=this.webrtcHealedRatio.getHealedRatio(),a=this.getRecvQuality(s,n);return this.recvDiagnosticsEnabled?(this.recvQualityAccumulator.add(a),this.webrtcHealedRatio.getDiagnostics(this.recvQualityAccumulator.items)):{quality:a}}getRecvQuality(e,t){return e<this.networkDetectionGoodLevelLow?"Good":e<this.networkDetectionGoodLevelHigh?"Good"===t?"Good":"Poor":e<this.networkDetectionBadLevelLow?"Poor":e<this.networkDetectionBadLevelHigh?"Bad"===t?"Bad":"Poor":"Bad"}getLossRate(e,t,i,n){const r=e-t,s=i-n,a=r+s;return this.sendDiagnosticsEnabled&&(this.sendDiffAccumulator.add(r),this.lostDiffAccumulator.add(s),this.totalAccumulator.add(a)),a>0?s/a:0}},Rk=class{constructor(e){this.configProvider=e,this.qualityLimitationReasonEvents=[]}setQualityLimitationReason(e){this.lastQualityLimitationReason!==e&&this.qualityLimitationReasonEvents.push({event:e,startTime:Date.now(),endTime:Date.now()}),this.qualityLimitationReasonEvents.length>this.configProvider.config.maxStoredQualityLimitationReasonEvents&&this.qualityLimitationReasonEvents.shift(),this.lastQualityLimitationReason=e}getQualityLimitationReasonEvents(){return this.qualityLimitationReasonEvents.reduce(((e,t,i)=>"none"===t.event?e:[...e,{...t,endTime:this.qualityLimitationReasonEvents[i+1]?.startTime??Date.now()}]),[])}},wk=class{constructor(){this.bitrateData={[Qe.MEDIA_DIRECTION.SEND]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0,allocateBW:0,allocateBWSamples:0},[Qe.MEDIA_DIRECTION.RECV]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0}}}captureSample(e,t){const i=Date.now()/1e3;if(0!==this.bitrateData[e].lastTimestamp&&t>this.bitrateData[e].lastBytes){const n=i-this.bitrateData[e].lastTimestamp,r=8*(t-this.bitrateData[e].lastBytes)/n;this.onBitrateSample(e,r)}this.bitrateData[e].lastTimestamp=i,this.bitrateData[e].lastBytes=t}getMax(e){return Math.round(this.bitrateData[e].maxSample)}getAvg(e){return 0===this.bitrateData[e].nSamples?0:Math.round(this.bitrateData[e].bitrateTotal/this.bitrateData[e].nSamples)}stopCapture(e){this.bitrateData[e].lastBytes=0,this.bitrateData[e].lastTimestamp=0}onBitrateSample(e,t){t>this.bitrateData[e].maxSample&&(this.bitrateData[e].maxSample=t),this.bitrateData[e].bitrateTotal+=t,this.bitrateData[e].nSamples++}captureAllocateBandwidth(e){if(e){const t=parseInt(e[e.length-1]);this.bitrateData[Qe.MEDIA_DIRECTION.SEND].allocateBW+=t,this.bitrateData[Qe.MEDIA_DIRECTION.SEND].allocateBWSamples+=1}}getAllocateBandwidthAvg(){const e=this.bitrateData[Qe.MEDIA_DIRECTION.SEND].allocateBW,t=this.bitrateData[Qe.MEDIA_DIRECTION.SEND].allocateBWSamples;if(e>0&&t>0)return Math.floor(e/t)}},Pk=class{constructor(e,t){this.maxAppliedCapabilitiesCount=t,this.events=[],this.events.push({eventType:"req",timestamp:Date.now(),capabilities:e.capabilities,isSimulcast:e.isSimulcastEnabled})}setMaxCapabilitiesApplied(e){this.events.push({eventType:"app",timestamp:Date.now(),capabilities:e.capabilities,error:e.error?`${e.error}`:"none"}),this.maxAppliedCapabilitiesCount&&this.events.length>this.maxAppliedCapabilitiesCount+1&&this.events.splice(1,1)}getEvents(){return this.events}},Mk=class{constructor(e,t){this.configProvider=e,this.logger=t,this.resolutionChangeRequestRecords={},this.currentResolutionsByRid={},this.resolutionChangeCounterByRid={},this.events=[],this.errors=[]}setMaxCapabilitesRequested(e){const t=new Pk(e,this.configProvider.config.webrtcLastAppliedVideoCapabilitiesCount);this.events.push({causeId:e.causeId,seq:t}),this.recordResolutionChange(e),this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.length>this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.shift()}setMaxCapabilitesApplied(e){const t=this.events.find((t=>t.causeId===e.causeId));t?(t.seq.setMaxCapabilitiesApplied(e),e.error&&this.errors.push(t)):this.logger.safe.warn(`Requested capabilities with id ${e.causeId} not found`)}getEvents(){return this.events.map((e=>({causeId:e.causeId,events:e.seq.getEvents()})))}getErrors(){return this.errors.map((e=>({causeId:e.causeId,events:e.seq.getEvents()})))}getResolutionRecords(){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo)return{req:this.resolutionChangeRequestRecords,count:this.resolutionChangeCounterByRid}}recordResolutionChange(e){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo){const t=Object.keys(this.currentResolutionsByRid),i=e=>e.rid||"default";[...t,...e.capabilities.map((e=>i(e)))].forEach((t=>{const n=e.capabilities.find((e=>i(e)===t)),r=this.currentResolutionsByRid[t]||0,s=n?.maxFs||0;if(r===s)return;this.resolutionChangeRequestRecords[t]||(this.resolutionChangeRequestRecords[t]=[],this.resolutionChangeCounterByRid[t]=0);const a=this.resolutionChangeRequestRecords[t].find((e=>e.from===r&&e.to===s));a?a.counter++:this.resolutionChangeRequestRecords[t].push({from:r,to:s,counter:1}),this.currentResolutionsByRid[t]=s,this.resolutionChangeCounterByRid[t]++}))}}},Dk=class{constructor(){this.delayCur=[],this.delayTotal=0,this.delayEventCount=0}analyzeDelay(e,t){if(t&&""!==t){this.delayCur.length===e&&this.delayCur.shift();const i=parseInt(t);this.delayCur.push(i),this.delayTotal+=i,this.delayEventCount+=Qe.TIME_INTERVAL.SEC_1}}getDelayCur(){if(this.delayCur.length>0){const e=this.delayCur.reduce(((e,t)=>e+t))/this.delayCur.length;return e<0?0:e}}getDelayAvg(){if(this.delayEventCount>0&&this.delayTotal>0){const e=this.delayTotal/this.delayEventCount;return e<0?0:e}}},Ok=class{constructor(e,t){this.configProvider=e,this.startTime=t,this.recvTotalFreezeDuration=-1,this.recvFreezeDurations=[],this.recvFreezeIsOngoing=!1,this.recvCurrentFreezeDuration=0,this.recvFreezeCount=0,this.receiveFreezeDurationCounts={},this.longestRecvFreezeDuration=0,this.sendCameraFreezeIntervalsCount=0,this.previousInputFrame=0,this.recvCurrentFreezeStartTimestamp=0,this.receiveFreezeDurationTimestamps={},this.finalFreezeIsOngoing=!1,this.finalRecvCurrentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0,Object.keys(Qe.HISTOGRAM_BATCH).forEach((e=>{this.receiveFreezeDurationCounts[e]=0,this.receiveFreezeDurationTimestamps[e]=[]}))}gatherFreezeData({frameRateDecoded:e,frameRateRecv:t,bytesReceived:i,mediaType:n}){if(e){const r=parseInt(e[e.length-1],10),s=t?.length>0?parseInt(t[t.length-1],10):void 0;void 0!==i&&"ScreenShare"!==n&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&!this.configProvider.config.isRenderingBasedOnRawStatistics&&this.calculateBitrate(i,r),-1===this.recvTotalFreezeDuration&&(this.recvTotalFreezeDuration=0),r>0&&(this.mediaStarted=!0),0!==r&&0!==s||!this.mediaStarted?r>0&&(void 0===s||s>0)&&this.recvFreezeIsOngoing&&this.stopRecvDataGathering(!1):(this.recvFreezeIsOngoing||(this.recvCurrentFreezeStartTimestamp=Date.now()-this.startTime),this.recvFreezeIsOngoing=!0,this.recvCurrentFreezeDuration+=Qe.TIME_INTERVAL.SEC_1,this.recvTotalFreezeDuration+=Qe.TIME_INTERVAL.SEC_1)}}getIsRendering(e){return this.recvCurrentFreezeDuration<e&&this.currentLowBitrateDuration<e&&this.mediaStarted}detectCaptureFreeze(e){if(e){const t=parseInt(e[e.length-1],10);this.previousInputFrame>0&&0===t&&(this.sendCameraFreezeIntervalsCount+=1),this.previousInputFrame=t}}getSendCameraFreezeIntervals(){return this.sendCameraFreezeIntervalsCount>0?this.sendCameraFreezeIntervalsCount:void 0}stopRecvDataGathering(e=!0){this.finalFreezeIsOngoing=this.recvFreezeIsOngoing,this.recvFreezeIsOngoing=!1,e&&(this.mediaStarted=!1),this.recvCurrentFreezeDuration>0&&(this.populateLongestRecvFreezeDuration(),this.populateRecvFreezeDurationCounts(),this.recvFreezeDurations.push(this.recvCurrentFreezeDuration),this.recvFreezeCount+=1),this.finalRecvCurrentFreezeDuration=this.recvCurrentFreezeDuration,this.recvCurrentFreezeDuration=0}getRecvFreezeDurationCounts(){return this.recvFreezeCount>0?JSON.stringify(this.receiveFreezeDurationCounts):void 0}getRecvFreezeDurationTimestamps(e){if(0===this.recvFreezeCount)return;const t={};return Object.keys(this.receiveFreezeDurationTimestamps).forEach((i=>{const n=this.receiveFreezeDurationTimestamps[i].length;t[i]=n>e?this.receiveFreezeDurationTimestamps[i].slice(n-e):this.receiveFreezeDurationTimestamps[i]})),JSON.stringify(t)}getRecvFreezeIsOngoing(e){return this.finalRecvCurrentFreezeDuration>=e&&this.finalFreezeIsOngoing}getRecvTotalFreezeDuration(){return this.recvTotalFreezeDuration>=0?this.recvTotalFreezeDuration:void 0}getRecvAvgFreezeDuration(){if(this.recvTotalFreezeDuration>0&&this.recvFreezeCount>0)return this.recvTotalFreezeDuration/this.recvFreezeCount}getLongestRecvFreezeDuration(){return this.longestRecvFreezeDuration>0?this.longestRecvFreezeDuration:void 0}populateRecvFreezeDurationCounts(){for(const e of Object.keys(Qe.HISTOGRAM_BATCH))if(this.recvCurrentFreezeDuration<=Qe.HISTOGRAM_BATCH[e]){this.receiveFreezeDurationCounts[e]+=1,this.receiveFreezeDurationTimestamps[e].push(this.recvCurrentFreezeStartTimestamp);break}this.recvCurrentFreezeStartTimestamp=0}populateLongestRecvFreezeDuration(){this.recvCurrentFreezeDuration>this.longestRecvFreezeDuration&&(this.longestRecvFreezeDuration=this.recvCurrentFreezeDuration)}calculateBitrate(e,t){const i=(e-this.lastBytesRecv)/125;this.lastBytesRecv=e,i<this.configProvider.config.notRenderingLowBitrateThreshold&&t<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}},kk=class{constructor(){this.mediaData={[Qe.MEDIA_DIRECTION.SEND]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0},[Qe.MEDIA_DIRECTION.RECV]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0}},this.gatheringSendData=!1}captureMediaData(e,t,i){const n=this.mediaData[e];if(e===Qe.MEDIA_DIRECTION.SEND&&(this.gatheringSendData=!0),t){const e=parseInt(t[t.length-1],10);n.totalFrameCount+=e}if(i){-1===n.totalMediaDuration&&(n.totalMediaDuration=0);const e=parseInt(i[i.length-1],10);n.mediaStarted||e>0&&(n.mediaStarted=!0,n.mediaStartTimestamp=new Date)}n.mediaStarted&&(n.totalMediaDuration+=Qe.TIME_INTERVAL.SEC_1)}captureFrameRate(e){const t=this.mediaData[Qe.MEDIA_DIRECTION.SEND];if(e){const i=parseInt(e[e.length-1],10);t.cameraFrameRate+=i}}stopRecvDataGathering(){const e=this.mediaData[Qe.MEDIA_DIRECTION.RECV],t=(new Date).getTime();e.timeSinceLastDecode=e.totalMediaDuration>0?Math.round((t-e.mediaStartTimestamp.getTime())/1e3):0,e.mediaStarted=!1}isGatheringSendData(){return this.gatheringSendData}stopSendDataGathering(){const e=this.mediaData[Qe.MEDIA_DIRECTION.SEND],t=new Date;e.timeSinceLastDecode=e.totalMediaDuration>0?Math.round((t.getTime()-e.mediaStartTimestamp.getTime())/1e3):0,this.gatheringSendData=!1,e.mediaStarted=!1}getAvgFrameRate(e){const t=this.mediaData[e];if(t.totalMediaDuration>0&&t.totalFrameCount>0)return t.totalFrameCount/t.totalMediaDuration}getTotalDuration(e){const t=this.mediaData[e];return t.totalMediaDuration>=0?t.totalMediaDuration:void 0}getTimeSinceLastDecode(e){const t=this.mediaData[e];return t.timeSinceLastDecode>0?t.timeSinceLastDecode:void 0}getSendCameraFramerate(){const e=this.mediaData[Qe.MEDIA_DIRECTION.SEND];if(e.totalMediaDuration>0)return e.cameraFrameRate/e.totalMediaDuration}},Nk=class{constructor(){this.qpData={[Qe.MEDIA_DIRECTION.SEND]:{frames:0,qpSum:0},[Qe.MEDIA_DIRECTION.RECV]:{frames:0,qpSum:0}}}captureQpData(e,t,i){const n=this.qpData[e];if(i&&i.length>0){const e=parseInt(i[i.length-1],10);e>0&&(n.frames=e)}if(t){const e=parseInt(t,10);e>0&&(n.qpSum=e)}}getQpAverage(e){const t=this.qpData[e];if(t.qpSum>0&&t.frames>0)return t.qpSum/t.frames}},Lk=class{constructor(){this.resolutionChangedCount=0,this.resDurations={},this.preferredResolutionDurations={},this.preferredResolutions=[]}get resolutionSwitchCount(){return this.resolutionChangedCount}get resolutionDurationRatios(){return this.countResolutionDurationRatio(this.resDurations)}get preferredResolutionDurationRatios(){return this.countResolutionDurationRatio(this.preferredResolutionDurations)}get preferredResolution(){return this.preferredResolutions}captureSample(e){e&&e.width&&e.height&&(this.isResolutionChanged(this.lastResolution,e)&&this.resolutionChanged(e),this.updateResolutionDuration(this.getResolutionKey(e),this.resDurations)),this.lastPreferredResolution&&this.updatePreferredResolutionDurations()}capturePreferredResolution(e,t){const i=this.getResolutionKey(e);this.preferredResolution.includes(i)||(this.preferredResolutions.length>=t&&this.preferredResolutions.shift(),this.preferredResolutions.push(i)),this.isResolutionChanged(this.lastPreferredResolution,e)&&(this.preferredResolutionChanged(e),this.updatePreferredResolutionDurations())}getResolutionKey(e){return`${e.width}x${e.height}`}isResolutionChanged(e,t){return!e||e.width!==t.width||e.height!==t.height}countResolutionDurationRatio(e){const t={};let i=0;for(const t in e)i+=e[t];for(const n in e)t[n]=Ct(e[n]/i*100,2);return t}updatePreferredResolutionDurations(){this.updateResolutionDuration(this.getResolutionKey(this.lastPreferredResolution),this.preferredResolutionDurations)}updateResolutionDuration(e,t){t[e]||(t[e]=0),t[e]++}preferredResolutionChanged(e){this.lastPreferredResolution=e}resolutionChanged(e){this.lastResolution=e,this.resolutionChangedCount++}},xk=class{constructor(){this.streamsTimers={}}countRecvStreams(e){const t=`${e}`;this.streamsTimers.hasOwnProperty(t)||(this.streamsTimers[t]=0),this.streamsTimers[t]++}getStreamCounts(){const e={min:void 0,max:void 0,mode:void 0},t=Object.keys(this.streamsTimers).map(Number);return 0===t.length||1===t.length&&0===t[0]||(e.min=Math.min(...t.filter((e=>e>0))),e.max=Math.max(...t),e.mode=t.reduce(((e,t)=>this.streamsTimers[t]>this.streamsTimers[e]?t:e),t[0])),e}},Uk=class{constructor(e){this.configProvider=e,this.subscriptionEvents=[],this.subscriptionCounters={attempted:0,subscribed:0,unsubscribed:0,failed:0}}addSubscriptionEvent(e){switch(this.subscriptionEvents.length>this.configProvider.config.webrtcSubscriptionEventLimit&&this.subscriptionEvents.shift(),this.subscriptionEvents.push(e),e.evt){case 1:this.subscriptionCounters.attempted++;break;case 2:this.subscriptionCounters.subscribed++;break;case 3:this.subscriptionCounters.unsubscribed++;break;case-1:this.subscriptionCounters.failed++}}getSubscriptionEvents(){return this.subscriptionEvents.length>0?{events:this.subscriptionEvents}:void 0}getSubscriptionCounters(){return this.subscriptionEvents.length>0?this.subscriptionCounters:void 0}},Fk=class{constructor(e,t,i,n="Video"){this.startTime=e,this.configProvider=t,this.logger=i,this.mediaType=n,this.subscriptionCounter=0,this.videoFreezeTelemetry=new Ok(this.configProvider,this.startTime),this.videoDelayTelemetry=new Dk,this.videoSubscriptionEvents=new Uk(this.configProvider),this.videoQPEvents=new Nk,this.videoResolutionTelemetry=new Lk,this.videoGeneralTelemetry=new kk,this.videoStreamsCounters=new xk,this.videoBitrate=new wk,this.videoMaxCapabilities=new Mk(this.configProvider,this.logger),this.videoOvershoot=new GO(this.logger),this.videoQualityLimitations=new Rk(this.configProvider),this.videoPacketLostRate=new yk(this.configProvider.config.minPacketsReceivedToCalculatePacketLossRate),this.videoStatsOnSubscribed=new ZO(this.configProvider.config.maxVideoStatsAfterSubscription),this.videoResolutionSwitchTracker=new RO(this.configProvider.config.diagnostics?.collectionLimits?.numResolutionSwitches),this.timeToFirstFrame=-1,this.timeToFirstFrameSinceSubscriptionStart=-1,this.currentTrackId="",this.recvTotalFreezeDurationMs=0,this.isRenderingEvents=[]}get trackId(){return this.currentTrackId}set trackId(e){this.currentTrackId=e}get isRecvDataGatheringEnabled(){return this.subscriptionCounter>0}startStopRecvDataGathering(e){this.logger.safe.info("Receive data gathering is "+(e?"enabled":"disabled")),e?this.subscriptionCounter++:this.subscriptionCounter--,this.subscriptionCounter<0&&this.logger.safe.error(`Subscription counter should not be less than 0. Actual value is ${this.subscriptionCounter}`),0===this.subscriptionCounter&&this.stopRecvGathering()}stopDataGathering(){this.stopRecvGathering(),this.stopSendGathering()}stopRecvGathering(){this.videoFreezeTelemetry.stopRecvDataGathering(),this.videoGeneralTelemetry.stopRecvDataGathering(),this.videoBitrate.stopCapture(Qe.MEDIA_DIRECTION.RECV)}isSendGathering(){return this.videoGeneralTelemetry.isGatheringSendData()}stopSendGathering(){this.videoGeneralTelemetry.stopSendDataGathering(),this.videoBitrate.stopCapture(Qe.MEDIA_DIRECTION.SEND),this.videoOvershoot.flush()}gatherRecvFreezeData(e,t,i){this.videoFreezeTelemetry.gatherFreezeData({frameRateDecoded:e,frameRateRecv:t,bytesReceived:i,mediaType:this.mediaType})}detectCaptureFreeze(e){this.videoFreezeTelemetry.detectCaptureFreeze(e)}getRecvFreezeDurationCounts(){return this.videoFreezeTelemetry.getRecvFreezeDurationCounts()}getRecvFreezeDurationTimestamps(){return this.videoFreezeTelemetry.getRecvFreezeDurationTimestamps(this.configProvider.config.maxVideoFreezeTimestampsInBucket)}getRecvTotalFreezeDuration(){return this.videoFreezeTelemetry.getRecvTotalFreezeDuration()}setRecvTotalFreezeDurationMs(e){this.recvTotalFreezeDurationMs=void 0!==e?this.recvTotalFreezeDurationMs+=e:void 0}analyzeDelay(e,t){this.videoDelayTelemetry.analyzeDelay(e,t)}getDelayCur(){return this.videoDelayTelemetry.getDelayCur()}getDelayAvg(){return this.videoDelayTelemetry.getDelayAvg()}addSubscriptionEvent(e){this.videoSubscriptionEvents.addSubscriptionEvent(e)}getSubscriptionEvents(){return this.videoSubscriptionEvents.getSubscriptionEvents()}getSubscriptionCounters(){return this.videoSubscriptionEvents.getSubscriptionCounters()}captureQpData(e,t,i){this.videoQPEvents.captureQpData(e,t,i)}getQpAverage(e){return this.videoQPEvents.getQpAverage(e)}captureMediaData(e,t,i){this.videoGeneralTelemetry.captureMediaData(e,t,i)}getIsRendering(){const e=this.configProvider.config.notRenderingTimeInterval["Video"===this.mediaType?"video":"sharing"];return this.videoFreezeTelemetry.getIsRendering(e)}captureFrameRate(e){this.videoGeneralTelemetry.captureFrameRate(e)}getTotalDuration(e){return this.videoGeneralTelemetry.getTotalDuration(e)}captureResolutionSample(e){this.videoResolutionTelemetry.captureSample(e)}countRecvStreams(e){this.videoStreamsCounters.countRecvStreams(e)}captureBitrateSample(e,t){this.videoBitrate.captureSample(e,t)}captureAllocateBandwidth(e){this.videoBitrate.captureAllocateBandwidth(e)}capturePreferredResolution(e,t){this.videoResolutionTelemetry.capturePreferredResolution(e,t)}setMaxCapabilitesRequested(e,t=!1){this.videoMaxCapabilities.setMaxCapabilitesRequested(e),t||1===e.capabilities.length&&!e.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(e.capabilities)}setMaxCapabilitesApplied(e,t=!1){this.videoMaxCapabilities.setMaxCapabilitesApplied(e),t||1===e.capabilities.length&&!e.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(e.capabilities)}getMaxCapabilitiesEvents(){const e=this.videoMaxCapabilities.getEvents();return JSON.stringify(e)}getMaxCapabilitiesResolutionChanges(){const e=this.videoMaxCapabilities.getResolutionRecords();return e?JSON.stringify(e):""}getMaxCapabilitiesErrors(){const e=this.videoMaxCapabilities.getErrors();return e?JSON.stringify(e):""}setCurrentParameters(e,t,i){this.videoOvershoot.setCurrentParams(e,t.height/16*(t.width/16),i)}setMaxCapabilitiesOvershoot(e){this.videoOvershoot.setMaxCapabilities(e)}getOvershootEvents(){let e=this.videoOvershoot.getEvents();return e=e.slice(Math.max(0,e.length-(this.configProvider.config.maxReportedOvershootingEvents+1)),e.length),e.forEach((e=>e.timestamp=e.timestamp-this.startTime)),JSON.stringify(e)}getOvershootTotalDurations(){const e=this.videoOvershoot.getEvents();return e.forEach((e=>e.timestamp=e.timestamp-this.startTime)),JSON.stringify({fs:e.reduce(((e,t)=>"fs"===t.overshootType?e+t.duration:e),0),fps:e.reduce(((e,t)=>"fps"===t.overshootType?e+t.duration:e),0)})}setQualityLimitationReason(e){this.videoQualityLimitations.setQualityLimitationReason(e)}getQualityLimitationReasonEvents(){return this.videoQualityLimitations.getQualityLimitationReasonEvents()}captureTimeToFirstFrame(e,t){-1!==e&&(this.timeToFirstFrame=e,this.timeToFirstFrameSinceSubscriptionStart=t)}getTimeToFirstFrame(){return this.timeToFirstFrame}setIsRendering(e){Tt(this.isRenderingEvents,{isRendering:e,ts:Date.now()},this.configProvider.config.diagnostics.telemetryLimits.numIsRenderingEvents)}capturePacketsLostAndPacketsReceved(e,t){this.videoPacketLostRate.capturePacketsLostAndPacketsReceived(e,t)}setMsi(e){this.msi=e}setLocalMsi(e){this.localMsi=e}prepareCollectingStatsOnSubscribed(e){this.videoStatsOnSubscribed.prepareCollectingStatsOnSubscribed(e)}captureStatsOnSubscribed(e,t){this.videoStatsOnSubscribed.captureStatsOnSubscribed(e,t)}calculateResolutinSwitches(e,t){this.videoResolutionSwitchTracker.captureSample(e,t)}getReport(e,t,i=!1){const n={};if(n[t+"DurationSeconds"]=this.getTotalDuration(e),n[t+"QpAvg"]=this.getQpAverage(e),n[t+"frameRateAvg"]=this.videoGeneralTelemetry.getAvgFrameRate(e),n[t+"bitrateAvg"]=this.videoBitrate.getAvg(e),n[t+"bitrateMax"]=this.videoBitrate.getMax(e),e===Qe.MEDIA_DIRECTION.SEND)n[t+"DelayCur"]=this.getDelayCur(),n[t+"DelayAvg"]=this.getDelayAvg(),n[t+"TimeSinceLastEncodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(e),n[t+"AllocateBWAvg"]=this.videoBitrate.getAllocateBandwidthAvg(),n[t+"CaptureFramerateAvg"]=this.videoGeneralTelemetry.getSendCameraFramerate(),n[t+"FreezeIntervals"]=this.videoFreezeTelemetry.getSendCameraFreezeIntervals(),n[t+"MaxCapabilities"]=i?"":this.getMaxCapabilitiesEvents(),n[t+"MaxCapabilitiesErrors"]=i?"":this.getMaxCapabilitiesErrors(),n[t+"OvershootEvents"]=this.getOvershootEvents(),n[t+"OvershootDurations"]=this.getOvershootTotalDurations(),n[t+"qualityLimitationReasonEvents"]=JSON.stringify(this.getQualityLimitationReasonEvents()),n[t+"MaxCapabilitiesResolutions"]=this.getMaxCapabilitiesResolutionChanges(),n[t+"ResolutionsSwitches"]=this.videoResolutionSwitchTracker.switches?JSON.stringify(this.videoResolutionSwitchTracker.switches):"";else if(e===Qe.MEDIA_DIRECTION.RECV){n[t+"TimeSinceLastDecodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(e),n[t+"FreezeHistogram"]=this.getRecvFreezeDurationCounts(),n[t+"FreezeTimestamps"]=this.getRecvFreezeDurationTimestamps(),n[t+"LongestFreezeDuration"]=this.videoFreezeTelemetry.getLongestRecvFreezeDuration(),n[t+"RecvAvgFreezeDuration"]=this.videoFreezeTelemetry.getRecvAvgFreezeDuration(),n[t+"TotalFreezeDuration"]=this.getRecvTotalFreezeDuration(),n[t+"TotalFreezeDurationMs"]=this.recvTotalFreezeDurationMs,n[t+"OngoingFreeze"]=this.videoFreezeTelemetry.getRecvFreezeIsOngoing(this.configProvider.config.webrtcEndOfCallFreezeThreshold),n[t+"NumResolutionSwitches"]=this.videoResolutionTelemetry.resolutionSwitchCount,n[t+"PreferredResolution"]=this.videoResolutionTelemetry.preferredResolution,n[t+"PreferredResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.preferredResolutionDurationRatios),n[t+"packetsLostRateMax"]=this.videoPacketLostRate.getPacketsLostRateMax(),n[t+"ResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.resolutionDurationRatios);const i=this.videoStreamsCounters.getStreamCounts();n[t+"StreamsMin"]=i.min,n[t+"StreamsMax"]=i.max,n[t+"StreamsMode"]=i.mode,n[t+"TimeToFirstFrame"]=this.timeToFirstFrame,n[t+"TimeToFirstFrameSinceSubscriptionStart"]=this.timeToFirstFrameSinceSubscriptionStart,n[t+"LocalMsi"]=this.localMsi,n[t+"Msi"]=this.msi,n[t+"isRenderingEvents"]=JSON.stringify(this.isRenderingEvents),n[t+"statsOnSubscribed"]=JSON.stringify(this.videoStatsOnSubscribed.getStatsOnSubscribed())}return n}},Vk=Symbol("mslbase"),Bk=Symbol("mslsamples"),Hk=class{constructor(e,t){this.logger=e,this.configProvider=t,this.currentLayouts={},this.collectedModalitySessions=[],this.startTimestamp=Date.now()}get collectedSessions(){return this.collectedModalitySessions}get highestFidelitySSRC(){if(!this.currentModalitySession)return;let e;for(const t in this.currentLayouts)e=this.getHigherFidelitySSRC(t,e);return parseInt(e)}processStats(e){const t=Object.values(e.ssrc??{}).filter((e=>e.rid&&e.ssrc&&e.googFrameHeightInput&&this.lastMaxCapabilitiesEvent?.capabilities.some((t=>t.rid===e.rid)))),i=new Map(t.map((e=>[`${e.ssrc}`,e.rid])));for(const e in this.currentLayouts)i.has(e)||this.collectLayout(e);!this.currentModalitySession&&i.size>0&&(this.currentModalitySession={timestamp:Date.now()-this.startTimestamp,duration:0,numLayouts:0,layouts:[]},this.logger.safe.info("Modality session started")),t.forEach((e=>{this.currentLayouts[`${e.ssrc}`]||this.addLayout(e)})),0===i.size&&this.currentModalitySession&&this.collectSession(),t.forEach((e=>this.processLayoutData(e)))}setMaxCapabilities(e,t){if(this.lastMaxCapabilitiesEvent=e,Object.keys(this.currentLayouts).length)for(const i of e.capabilities){const n=Object.values(this.currentLayouts).find((e=>e.rid===i.rid));n&&(t?(Tt(n.fmtp,{...i,timestamp:Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-n.timestamp,causeId:e.causeId},this.configProvider.config.simulcastTelemetryNumFMTP),n.gatherer.setMaxCapabilitesApplied(e)):n.gatherer.setMaxCapabilitesRequested(e),n.gatherer.setMaxCapabilitiesOvershoot([i]))}}finish(){this.logger.safe.info("Finishing statistics gathering");for(const e in this.currentLayouts)this.collectLayout(e);this.currentModalitySession&&this.collectSession()}addLayout(e){const t=`${e.ssrc}`,i=e.rid,n=this.lastMaxCapabilitiesEvent?.capabilities.find((e=>e.rid===i));this.logger.safe.info(`Adding layout for ssrc ${t} rid ${i}`);const r=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,s=new Fk(r,this.configProvider,this.logger.createChild(`Telemetry#${t}`));this.currentLayouts[t]={ssrc:e.ssrc,rid:i,fmtp:[{...n,timestamp:r,causeId:this.lastMaxCapabilitiesEvent?.causeId}],timestamp:r,duration:0,gatherer:s,[Vk]:{firCount:e.googFirsReceived,nackCount:e.googNacksReceived,pliCount:e.googPlisReceived,framesEncoded:e.framesEncoded,bytesSent:e.bytesSent,packetsSent:e.packetsSent,packetsLost:e.packetsLost,qpSum:e.qpSum},[Bk]:{firCount:[],nackCount:[],pliCount:[],framesEncoded:[],bytesSent:[],packetsSent:[],packetsLost:[],qpSum:[],frameHeightInput:[],frameHeightSent:[],frameRateInput:[],frameRateSent:[]}},s.setMaxCapabilitiesOvershoot([n]),this.currentModalitySession.numLayouts++}processLayoutData(e){const t=`${e.ssrc}`,i=this.currentLayouts[t];this.processMediaStats(i,e),i.gatherer.captureMediaData(Qe.MEDIA_DIRECTION.SEND,[String(e.googFrameRateSent)],[String(e.framesEncoded)]),i.gatherer.captureFrameRate([String(e.googFrameRateInput)]),i.gatherer.captureQpData(Qe.MEDIA_DIRECTION.SEND,String(e.qpSum),[String(e.framesEncoded)]),i.gatherer.captureBitrateSample(Qe.MEDIA_DIRECTION.SEND,e.bytesSent),i.gatherer.detectCaptureFreeze([String(e.googFrameRateInput)]),i.gatherer.setCurrentParameters(e.ssrc,{width:e.googFrameWidthSent,height:e.googFrameHeightSent},e.googFrameRateSent)}processMediaStats(e,t){const i=e[Vk],n=t.googFirsReceived-i.firCount,r=t.googNacksReceived-i.nackCount,s=t.googPlisReceived-i.pliCount,a=t.framesEncoded-i.framesEncoded,o=t.bytesSent-i.bytesSent,c=t.packetsSent-i.packetsSent,l=t.packetsLost-i.packetsLost,d=t.qpSum-i.qpSum,h=e[Bk],u=this.configProvider.config.webrtcStatStoredRecordsNumber;Tt(h.firCount,n,u),Tt(h.nackCount,r,u),Tt(h.pliCount,s,u),Tt(h.framesEncoded,a,u),Tt(h.bytesSent,o,u),Tt(h.packetsSent,c,u),Tt(h.packetsLost,l,u),Tt(h.qpSum,d,u),Tt(h.frameHeightInput,t.googFrameHeightInput,u),Tt(h.frameHeightSent,t.googFrameHeightSent,u),Tt(h.frameRateInput,t.googFrameRateInput,u),Tt(h.frameRateSent,t.googFrameRateSent,u)}collectLayout(e){this.logger.safe.info(`Collecting layout for ssrc ${e}`),this.currentLayouts[e].duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-this.currentLayouts[e].timestamp,this.currentLayouts[e].gatherer.isSendGathering()&&this.currentLayouts[e].gatherer.stopSendGathering();const t=this.currentLayouts[e].gatherer.getReport(Qe.MEDIA_DIRECTION.SEND,"",!1);for(const i in t)this.currentLayouts[e][i]=t[i];for(const t in this.currentLayouts[e][Bk])this.currentLayouts[e][t]=kt(this.currentLayouts[e][Bk][t],(e=>e));delete this.currentLayouts[e].gatherer,Tt(this.currentModalitySession.layouts,this.currentLayouts[e],this.configProvider.config.simulcastTelemetryLayoutsPerSession),delete this.currentLayouts[e]}collectSession(){this.logger.safe.info("Collecting session");for(const e in this.currentLayouts)this.collectLayout(e);this.currentModalitySession.duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,Tt(this.collectedModalitySessions,this.currentModalitySession,this.configProvider.config.simulcastTelemetryNumModalitySessions),this.currentModalitySession=void 0,this.lastMaxCapabilitiesEvent=void 0}getHigherFidelitySSRC(e,t){if(!e||!t)return e||t;const[i]=this.currentLayouts[e].fmtp.slice(-1),[n]=this.currentLayouts[t].fmtp.slice(-1);return(i?.maxMbps??0)>0&&(n?.maxMbps??0)>0?i.maxMbps>n.maxMbps?e:t:e||t}},$k=["googFrameHeightReceived","googFrameWidthReceived","googFrameHeightSent","googFrameWidthSent","googFrameRateInput","googFrameRateSent","googNacksSent","googNacksReceived","googPlisSent","googPlisReceived","googFirsSent","googFirsReceived","framesDecoded","googFrameRateDecoded","googFrameRateReceived","framesEncoded","packetsLost","packetsSent","packetsReceived","bytesReceived","bytesSent","googEncodeUsagePercent","audioInputLevel","audioOutputLevel","googDecodingCTN","googDecodingPLC","keyFramesEncoded","keyFramesDecoded","googRtt","concealedSamples","silentConcealedSamples","totalSamplesReceived","healedRatio","jitter","googJitterBufferMs","qpSum","fecPacketsReceived","fecPacketsDiscarded","fecPacketsSent","packetsDiscarded","pushCount","pushErrCount","pullCount","pullErrCount"],Gk=["bytesSent","bytesReceived","googRtt","packetsSent","requestsSent","consentRequestsSent","responsesSent","requestsReceived","responsesReceived"],jk=["googAvailableReceiveBandwidth","googAvailableSendBandwidth","googTransmitBitrate"];function qk(e,t,i){const n=i.value;i.value=function(...e){try{return n.apply(this,e)}catch(e){this.processStatsError(t,e)}}}var Wk=class{constructor(e,t,i,n,r,s){this.logger=e,this.sessionInfo=t,this.configProvider=i,this.mediaManager=n,this.multiparty=r,this.newStatsApi=s,this.statsErrors=[],this.subscribedTrackIds=[],this.iceCandidateErrors=[],this.terminated=!1,this.hwSilent=!1,this.isSpeaking=!1,this.networkSendLevel={quality:"Good"},this.networkRecvLevel={quality:"Good"},this.audioTelemetry=new Ck(this.configProvider),this.cameraOpenResolution={width:0,height:0},this.streamSenderStarted={},this.totalVideoControlMessages=0,this.outOfOrderVideoControlMessages=0,this.subscribedTrackSsrc=[],this.multiViewVideoTelemetry={},this.h264AvailableProfiles=[],this.timeToFirstFrame={},this.timeToFirstFrameSinceSubscriptionStart={},this.missedInitialPreferredResolution={},this.MSIDs=new Set,this.MSIDsPairs={},this.timerTrackerManager=new wM(this.configProvider.config.enableTimerTracker),this.extensions={WebRTCStats:{},AudioTransportRecvBitrate:0,AudioTransportSendBitrate:0,AudioPayloadSendBitrate:0,AudioPayloadRecvBitrate:0,VideoPayloadSendBitrate:0,VideoPayloadRecvBitrate:0,TimerAudioTransportRecvBitrate:0,TimerAudioTransportSendBitrate:0,TimerAudioPayloadRecvBitrate:0,TimerAudioPayloadSendBitrate:0,TimerVideoPayloadRecvBitrate:0,TimerVideoPayloadSendBitrate:0,StartTime:Date.now(),EndTime:Date.now(),Audio_recv_jitterBufferAvgSize:0,Audio_recv_jitterMax:0,Audio_recv_jitterAvg:0,Audio_send_rttAvg:0,Audio_send_rttMax:0,MaxSessionBandwidth:0,Video_recv_MSIDs:[],CallSetupTimeTracker:"",Audio_send_presentationUserAPIDuration:"",Audio_send_presentationDuration:""},this.report={type:"WebRtcMediaStats",data:{Extensions:this.extensions}},this.lastSSRCs=new Map,this.videoTelemetry=new Fk(this.extensions.StartTime,this.configProvider,this.logger.createChild("Video"),"Video"),this.sharingTelemetry=new Fk(this.extensions.StartTime,this.configProvider,this.logger.createChild("Sharing"),"ScreenShare"),this.dataTelemetry=new Wg,this.bandwidthTelemetry=new _k(this.configProvider.config.webrtcBWJumpLowerLimit,this.configProvider.config.webrtcBWJumpUpperLimit),this.stabilizationTelemetry=new ek(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,zp),this.storedRecordsNumber=Number(this.configProvider.config.webrtcStatStoredRecordsNumber),this.hwSilentDetectionDuration=Number(this.configProvider.config.webrtcStatHwSilentDetectionDuration),this.hwSilentDetectionLevel=Number(this.configProvider.config.webrtcStatHwSilentDetectionLevel),this.audioHealedRatioTelemetry=new vk(this.configProvider),this.networkQualityTelemetry=new Ak(this.configProvider,this.newStatsApi,this.audioHealedRatioTelemetry),this.speakingWhileMutedBadDuration=Number(this.configProvider.config.webrtcSpeakingWhileMutedBadDuration),this.speakingWhileMutedDetectionLevel=Number(this.configProvider.config.webrtcSpeakingWhileMutedDetectionLevel),this.videoDelayTimePeriod=this.configProvider.config.webrtcVideoDelayThreshold,this.maxStoredPreferredResolutions=this.configProvider.config.maxStoredPreferredResolutionCount,this.simulcastVideo=new Hk(this.logger.createChild("simulcastVideo"),this.configProvider),this.simulcastSharing=new Hk(this.logger.createChild("simulcastSharing"),this.configProvider)}get currentVideoRecvTrackId(){return this.extensions.WebRTCStats.ssrc_video_recv?.googTrackId}get currentSharingRecvTrackId(){return this.extensions.WebRTCStats.ssrc_sharing_recv?.googTrackId}get isMultiViewVideoTelemetry(){return Object.getOwnPropertyNames(this.multiViewVideoTelemetry).length>0}onDeviceEvent(e){if("stream_acquired"===e.eventType){const t=e.payload;"Video"===t.mediaType&&(this.cameraOpenResolution=t.resolution)}}onMaxCapabilitiesRequested(e){(e.modality===Qe.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesRequested(e),(e.modality===Qe.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(e,!1)}onMaxCapabilitiesApplied(e){(e.modality===Qe.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesApplied(e),(e.modality===Qe.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(e,!0)}setSubscribedTrackIds(e){this.subscribedTrackIds=e||[]}setSubscribedTrackSsrc(e){this.subscribedTrackSsrc=e||[]}addSubscriptionEvent(e,t,i,n,r,s,a){const o={evt:e,ts:Date.now()-this.extensions.StartTime,msi:i,localMsi:n,duration:s};r&&(o.error=Ve(r));const c=this.getHandlerForModality(t);if(c.addSubscriptionEvent(o),a&&this.setMSIDsPair(i,n,a),1===e||3===e){const t=1===e;c.startStopRecvDataGathering(t)}2===e&&c.prepareCollectingStatsOnSubscribed(i)}setMSIDsPair(e,t,i){const n=`ssrc_${i.replace(/\D/g,"")}_recv`;this.MSIDsPairs[n]={msi:e,localMsi:t}}getHandlerForModality(e){switch(e){case Qe.MODALITY.video:return this.videoTelemetry;case Qe.MODALITY.sharing:return this.sharingTelemetry;default:throw new Error(`Handler not found for modality: ${e}`)}}setTerminated(){this.extensions.EndTime=(new Date).getTime(),this.terminated=!0}startWaitingForStreamStart(e){this.streamStartDetection||this.sessionInfo.setOfferedModalities(e),this.streamStartDetection=!0}recordDataChannelProtocolEvent(e){this.dataTelemetry.recordDataChannelProtocolEvent(e)}setSessionDataChannelState(e){this.dataTelemetry.setSessionDataChannelState(e)}recordDataChannelError(e){this.dataTelemetry.recordDataChannelError(e)}processStatsDict(e){if(this.processSimulcastStats(e),this.constructWebRtcReportForSingleStream(this.extensions.WebRTCStats,e),this.streamStartDetection&&(this.setStartTime(this.sessionInfo.offeredModalities)||this.terminated)&&(this.streamStartDetection=!1),Object.keys(this.missedInitialPreferredResolution).length>0&&(this.currentVideoRecvTrackId||this.currentSharingRecvTrackId)&&this.setMissedInitialPreferredResolution(),this.constructWebRTCDataReport(this.extensions.WebRTCStats,e),this.calculateHwSilentState(),this.calculateSpeakingState(),this.setHealedRatioSamples(),this.calculateNetworkRecvQualityLevel(),this.calculateNetworkSendQualityLevel(),this.sessionInfo.activeModalities&&(this.processBandwidthStats(),this.processAudioStats(),this.processVideoStatsRecv(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_recv,!0),this.processVideoStatsSend(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_send),this.processSharingStats(),this.processStreamsCounters()),this.configProvider.config.enableMultiViewStats){const t=this.extensions.WebRTCStats[Qe.MULTIPLE_RECV_STREAMS]?this.extensions.WebRTCStats[Qe.MULTIPLE_RECV_STREAMS]:{};this.constructWebRtcReportForMultipleStreams(t,e);for(const e of Object.keys(t)){const i=t[e];this.processVideoStatsRecv(this.multiViewVideoTelemetry[e],i)}this.extensions.WebRTCStats[Qe.MULTIPLE_RECV_STREAMS]=t}this.extensions.WebRTCStats.statsErrors=JSON.stringify(this.statsErrors)}setTimeToFirstFrame(e,t,i){i in this.timeToFirstFrame||(this.timeToFirstFrame[i]=e,this.timeToFirstFrameSinceSubscriptionStart[i]=t)}getCurrentTimeToFirstFrame(e){return this.timeToFirstFrame[e]?this.timeToFirstFrame[e]:-1}getCurrentTimeToFirstFrameSinceSubscriptionStart(e){return this.timeToFirstFrameSinceSubscriptionStart[e]?this.timeToFirstFrameSinceSubscriptionStart[e]:-1}getVideoTelemetryBySsrc(e){let t;return this.extensions.WebRTCStats.ssrc_video_recv&&this.extensions.WebRTCStats.ssrc_video_recv.id===e?t=this.videoTelemetry:this.extensions.WebRTCStats.ssrc_sharing_recv&&this.extensions.WebRTCStats.ssrc_sharing_recv.id===e?t=this.sharingTelemetry:this.isMultiViewVideoTelemetry&&(t=this.multiViewVideoTelemetry[e]),t}getIsRendering(e){const t=this.getVideoTelemetryBySsrc(e);return t?t.getIsRendering():void 0}setFreezeDuration(e,t){for(const i of Object.keys(this.multiViewVideoTelemetry))this.multiViewVideoTelemetry[i].trackId===t&&this.isSubscribed(t)&&this.multiViewVideoTelemetry[i].setRecvTotalFreezeDurationMs(e);this.currentSharingRecvTrackId===t&&this.isSubscribed(t)&&this.sharingTelemetry.setRecvTotalFreezeDurationMs(e),this.currentVideoRecvTrackId===t&&this.isSubscribed(t)&&this.videoTelemetry.setRecvTotalFreezeDurationMs(e)}addVideoControlMessage(e){this.totalVideoControlMessages++,e&&this.outOfOrderVideoControlMessages++}setStreamSenderStarted(e,t){this.streamSenderStarted[e]=t}addReportedReceiveBandwidth(e){this.limitCaptureAmount(this.extensions,"ReportedReceiveBandwidth",e)}setHealedRatioSamples(){this.audioHealedRatioTelemetry.captureHealedRatioSamples(this.extensions?.WebRTCStats?.ssrc_audio_recv?.concealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.silentConcealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.totalSamplesReceived)}processSimulcastStats(e){this.simulcastVideo.processStats(e),this.simulcastSharing.processStats(e)}processBandwidthStats(){const e=this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth;if(e){const t=this.streamSenderStarted.Video||this.streamSenderStarted.ScreenShare;this.bandwidthTelemetry.recordSendBandwidth(e[e.length-1]),this.stabilizationTelemetry.processBandwidth(parseInt(e[e.length-1]),this.sessionInfo.activeModalities,t)}}processAudioStats(){if(this.extensions.WebRTCStats.ssrc_audio_send&&this.limitCaptureAmount(this.extensions,"Audio_send_RawInputVolume",this.audioTelemetry.getInputLevel("Audio")),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.googJitterBufferMs&&this.audioTelemetry.captureJitterBuffer((0,fk.last)(this.extensions.WebRTCStats.ssrc_audio_recv.googJitterBufferMs)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_audio_recv?.packetsReceived&&this.audioTelemetry.capturePacketsLostAndPacketsReceived((0,fk.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsLost),(0,fk.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsReceived)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.jitter&&this.audioTelemetry.captureJitter((0,fk.last)(this.extensions.WebRTCStats.ssrc_audio_recv.jitter)),this.extensions.WebRTCStats.ssrc_audio_send?.googRtt){const e=this.extensions.WebRTCStats.ssrc_audio_send.googRtt;this.audioTelemetry.captureRtt(e[e.length-1])}}stopGatheringIfNeeded(e,t,i,n){const r=`${t}${i}`;n!==this.lastSSRCs.get(r)&&(this.lastSSRCs.set(r,n),t===Qe.MEDIA_DIRECTION.SEND?e.stopSendGathering():e.stopRecvGathering())}processVideoStatsSend(e,t){t&&zp(this.sessionInfo.activeModalities.video)?(this.stopGatheringIfNeeded(e,Qe.MEDIA_DIRECTION.SEND,"Video",t.ssrc),e.captureMediaData(Qe.MEDIA_DIRECTION.SEND,t.googFrameRateSent,t.framesEncoded),e.captureFrameRate(t.googFrameRateInput),e.analyzeDelay(this.videoDelayTimePeriod,t.googAvgEncodeMs),e.captureQpData(Qe.MEDIA_DIRECTION.SEND,t.qpSum,t.framesEncoded),e.captureBitrateSample(Qe.MEDIA_DIRECTION.SEND,this.getLastSampleInt(t.bytesSent)),e.detectCaptureFreeze(t.googFrameRateInput),e.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),e.setCurrentParameters(parseInt(t.ssrc),{width:this.getLastSampleInt(t.googFrameWidthSent),height:this.getLastSampleInt(t.googFrameHeightSent)},this.getLastSampleInt(t.googFrameRateSent)),e.setQualityLimitationReason(t.qualityLimitationReason),this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo&&e.calculateResolutinSwitches(this.getLastSampleInt(t.googFrameWidthSent),this.getLastSampleInt(t.googFrameHeightSent))):e.isSendGathering()&&(e.stopSendGathering(),this.lastSSRCs.delete(`${Qe.MEDIA_DIRECTION.SEND}Video`))}processVideoStatsRecv(e,t,i=!1){t&&Jp(this.sessionInfo.activeModalities.video)&&this.videoTelemetry.isRecvDataGatheringEnabled?(i&&this.stopGatheringIfNeeded(e,Qe.MEDIA_DIRECTION.RECV,"Video",t.ssrc),e.trackId=t.googTrackId,e.gatherRecvFreezeData(t.googFrameRateDecoded,t.googFrameRateReceived,this.getLastSampleInt(t.bytesReceived)),e.captureMediaData(Qe.MEDIA_DIRECTION.RECV,t.googFrameRateReceived,t.googFrameRateDecoded),e.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(t.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(t.googTrackId)),e.captureQpData(Qe.MEDIA_DIRECTION.RECV,t.qpSum,t.framesDecoded),e.captureBitrateSample(Qe.MEDIA_DIRECTION.RECV,this.getLastSampleInt(t.bytesReceived)),e.captureResolutionSample({width:this.getLastSampleInt(t.googFrameWidthReceived),height:this.getLastSampleInt(t.googFrameHeightReceived)}),this.extensions.WebRTCStats.ssrc_video_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_video_recv?.packetsReceived&&this.videoTelemetry.capturePacketsLostAndPacketsReceved((0,fk.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsLost),(0,fk.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsReceived)),e.captureStatsOnSubscribed(this.getLastSampleInt(t.framesDecoded),this.getLastSampleInt(t.bytesReceived))):i&&this.lastSSRCs.delete(`${Qe.MEDIA_DIRECTION.RECV}Video`)}processSharingStats(){const e=this.extensions.WebRTCStats.ssrc_sharing_send,t=this.extensions.WebRTCStats.ssrc_sharing_recv;e&&zp(this.sessionInfo.activeModalities.sharing)?(this.stopGatheringIfNeeded(this.sharingTelemetry,Qe.MEDIA_DIRECTION.SEND,"Sharing",e.ssrc),this.sharingTelemetry.captureMediaData(Qe.MEDIA_DIRECTION.SEND,e.googFrameRateSent,e.framesEncoded),this.sharingTelemetry.captureFrameRate(e.googFrameRateInput),this.sharingTelemetry.analyzeDelay(this.videoDelayTimePeriod,e.googAvgEncodeMs),this.sharingTelemetry.captureQpData(Qe.MEDIA_DIRECTION.SEND,e.qpSum,e.framesEncoded),this.sharingTelemetry.captureBitrateSample(Qe.MEDIA_DIRECTION.SEND,this.getLastSampleInt(e.bytesSent)),this.sharingTelemetry.detectCaptureFreeze(e.googFrameRateInput),this.sharingTelemetry.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),this.sharingTelemetry.setCurrentParameters(parseInt(e.ssrc),{width:this.getLastSampleInt(e.googFrameWidthSent),height:this.getLastSampleInt(e.googFrameHeightSent)},this.getLastSampleInt(e.googFrameRateSent)),this.limitCaptureAmount(this.extensions,"Sharing_send_RawInputVolume",this.audioTelemetry.getInputLevel("ScreenShare"))):this.sharingTelemetry.isSendGathering()&&(this.sharingTelemetry.stopSendGathering(),this.lastSSRCs.delete(`${Qe.MEDIA_DIRECTION.SEND}Sharing`)),t&&Jp(this.sessionInfo.activeModalities.sharing)&&this.sharingTelemetry.isRecvDataGatheringEnabled?(this.stopGatheringIfNeeded(this.sharingTelemetry,Qe.MEDIA_DIRECTION.RECV,"Sharing",t.ssrc),this.sharingTelemetry.trackId=t.googTrackId,this.sharingTelemetry.gatherRecvFreezeData(t.googFrameRateDecoded,t.googFrameRateReceived),this.sharingTelemetry.captureMediaData(Qe.MEDIA_DIRECTION.RECV,t.googFrameRateReceived,t.googFrameRateDecoded),this.sharingTelemetry.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(t.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(t.googTrackId)),this.sharingTelemetry.captureQpData(Qe.MEDIA_DIRECTION.RECV,t.qpSum,t.framesDecoded),this.sharingTelemetry.captureBitrateSample(Qe.MEDIA_DIRECTION.RECV,this.getLastSampleInt(t.bytesReceived)),this.sharingTelemetry.captureResolutionSample({width:this.getLastSampleInt(t.googFrameWidthReceived),height:this.getLastSampleInt(t.googFrameHeightReceived)}),this.sharingTelemetry.captureStatsOnSubscribed(this.getLastSampleInt(t.framesDecoded),this.getLastSampleInt(t.bytesReceived))):this.lastSSRCs.delete(`${Qe.MEDIA_DIRECTION.RECV}Sharing`)}processStreamsCounters(){const e=this.extensions.WebRTCStats.recvCounters;e&&(this.videoTelemetry.countRecvStreams(e[Qe.MODALITY.video]),this.sharingTelemetry.countRecvStreams(e[Qe.MODALITY.sharing]))}setMissedInitialPreferredResolution(){Xe(this.missedInitialPreferredResolution,((e,t)=>{this.setPreferredResolution(t,e)})),this.missedInitialPreferredResolution={}}setPreferredResolution(e,t,i){if((i===Qe.MEDIA_TYPE.video&&!this.currentVideoRecvTrackId||i===Qe.MEDIA_TYPE.sharing&&!this.currentSharingRecvTrackId)&&(this.missedInitialPreferredResolution[e]=t),this.currentVideoRecvTrackId===e&&this.videoTelemetry.capturePreferredResolution(t,this.maxStoredPreferredResolutions),this.currentSharingRecvTrackId===e&&this.sharingTelemetry.capturePreferredResolution(t,this.maxStoredPreferredResolutions),this.isMultiViewVideoTelemetry){const i=this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(e)];i&&i.capturePreferredResolution(t,this.maxStoredPreferredResolutions)}}setIsRendering(e,t,i){t===Qe.MEDIA_TYPE.video&&this.videoTelemetry.setIsRendering(e),t===Qe.MEDIA_TYPE.sharing&&this.sharingTelemetry.setIsRendering(e),this.isMultiViewVideoTelemetry&&this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(i)]?.setIsRendering(e)}setReportedSendBandwidth(e){this.extensions.ReportedSendBWMax||this.extensions.ReportedSendBWMin?e>this.extensions.ReportedSendBWMax?this.extensions.ReportedSendBWMax=e:e<this.extensions.ReportedSendBWMin&&(this.extensions.ReportedSendBWMin=e):(this.extensions.ReportedSendBWMax=e,this.extensions.ReportedSendBWMin=e)}setMaxSessionBandwidth(e){this.extensions.MaxSessionBandwidth=e}isSubscribed(e,t){let i=this.subscribedTrackIds.some((t=>t===e));return!i&&this.configProvider.config.subscribeToSsrcForVideo&&(i=this.subscribedTrackSsrc.some((e=>e===`${t}`))),i||!this.multiparty&&this.configProvider.config.subscribeToSsrcForVideo}getReport(e=!1,t=!1){try{t&&this.resetPairValues(),e||(this.videoTelemetry.stopDataGathering(),this.sharingTelemetry.stopDataGathering());const i=this.videoTelemetry.getTotalDuration(Qe.MEDIA_DIRECTION.RECV),n=this.videoTelemetry.getTotalDuration(Qe.MEDIA_DIRECTION.SEND),r=this.sharingTelemetry.getTotalDuration(Qe.MEDIA_DIRECTION.RECV),s=this.sharingTelemetry.getTotalDuration(Qe.MEDIA_DIRECTION.SEND);if(i>=0&&(Xe(this.videoTelemetry.getReport(Qe.MEDIA_DIRECTION.RECV,"Video_recv_",t),((e,t)=>this.extensions[t]=e)),!st(this.multiViewVideoTelemetry))){const e=[];for(const i of Object.keys(this.multiViewVideoTelemetry)){const n={id:i};Xe(this.multiViewVideoTelemetry[i].getReport(Qe.MEDIA_DIRECTION.RECV,"Video",t),((e,t)=>{void 0!==e&&(n[t]=e)})),e.push(n)}this.extensions[Qe.MULTIPLE_RECV_STREAMS]=JSON.stringify(e)}r>=0&&Xe(this.sharingTelemetry.getReport(Qe.MEDIA_DIRECTION.RECV,"Sharing_recv_",t),((e,t)=>this.extensions[t]=e)),n>=0&&(Xe(this.videoTelemetry.getReport(Qe.MEDIA_DIRECTION.SEND,"Video_send_",t),((e,t)=>this.extensions[t]=e)),this.extensions.Bandwidth_jumpsHistogram=JSON.stringify(this.bandwidthTelemetry.getReport()),this.extensions.Bandwidth_uplinkStabilizationTime=JSON.stringify(this.stabilizationTelemetry.getReport(!0)),this.extensions.Video_send_CameraOpenWidth=this.cameraOpenResolution.width,this.extensions.Video_send_CameraOpenHeight=this.cameraOpenResolution.height),s>=0&&Xe(this.sharingTelemetry.getReport(Qe.MEDIA_DIRECTION.SEND,"Sharing_send_",t),((e,t)=>this.extensions[t]=e)),Xe(this.dataTelemetry.getReport("Data_"),((e,t)=>this.extensions[t]=e)),e||t||(this.simulcastVideo.finish(),this.extensions.Video_send_Simulcast=JSON.stringify(this.simulcastVideo.collectedSessions),this.simulcastSharing.finish(),this.extensions.Sharing_send_Simulcast=JSON.stringify(this.simulcastSharing.collectedSessions)),this.iceCandidateErrors.length>0&&(this.extensions.iceCandidateErrors=JSON.stringify(this.iceCandidateErrors)),this.extensions.Audio_recv_jitterBufferAvgSize=this.audioTelemetry.getAvgJitterBuffer(),this.extensions.Audio_recv_packetsLostRateMax=this.audioTelemetry.getPacketsLostRateMax(),this.extensions.Audio_recv_networkAvgLossRate=this.audioTelemetry.getNetworkAvgLostRate(),this.extensions.Audio_recv_jitterMax=this.audioTelemetry.getJitterMax(),this.extensions.Audio_recv_jitterAvg=this.audioTelemetry.getJitterAvg(),this.extensions.Video_SubscriptionEvents=t?"":JSON.stringify(this.videoTelemetry.getSubscriptionEvents()),this.extensions.Video_SubscriptionCounters=t?"":JSON.stringify(this.videoTelemetry.getSubscriptionCounters()),this.extensions.Sharing_SubscriptionEvents=t?"":JSON.stringify(this.sharingTelemetry.getSubscriptionEvents()),this.extensions.Sharing_SubscriptionCounters=t?"":JSON.stringify(this.sharingTelemetry.getSubscriptionCounters()),this.extensions.Audio_recv_healedRatioMax=this.audioHealedRatioTelemetry.getHealedRatioMax(),this.extensions.Audio_recv_healedRatioAvg=this.audioHealedRatioTelemetry.getHealedRatioAvg(),this.extensions.Audio_recv_packetsLostAvg=this.audioTelemetry.getAvgPacketsLost(),this.extensions.Audio_send_rttAvg=this.audioTelemetry.getAvgRtt(),this.extensions.Audio_send_rttMax=this.audioTelemetry.getMaxRtt(),this.extensions.CallSetupTimeTracker=JSON.stringify(this.timerTrackerManager.getReport());for(const e of Object.keys(this.extensions))void 0===this.extensions[e]&&delete this.extensions[e];return delete this.extensions.WebRTCStats[Qe.MULTIPLE_RECV_STREAMS],this.sessionInfo.fillExtensionInfo(this.extensions),Object.keys(this.extensions.WebRTCStats).length>0&&!this.extensions.WebRTCStats.hasStatsError&&this.calculateAverages(),this.extensions.H264_available_profiles=this.h264AvailableProfiles.join(),this.extensions.Video_recv_MSIDs=Array.from(this.MSIDs),this.totalVideoControlMessages>0&&(this.extensions.totalVideoControlMessages=this.totalVideoControlMessages,this.extensions.outOfOrderVideoControlMessages=this.outOfOrderVideoControlMessages),ct(this.report)}catch(e){throw this.processStatsError("Report",e),{error:e,partialReport:ct(this.report)}}}getAudioHwSilent(){return this.hwSilent}getSpeakingState(){return this.isSpeaking}getNetworkSendLevel(){return this.networkSendLevel}getNetworkRecvLevel(){return this.networkRecvLevel}addIceCandidateError(e){this.iceCandidateErrors.push(e)}clearIceCandidateErrors(){this.iceCandidateErrors=[]}addH264AvailableProfiles(e){this.h264AvailableProfiles=[...new Set(this.h264AvailableProfiles.concat(e))]}updateSendStream(e,t){this.audioTelemetry.updateSendStream(e,t)}getTimerTracker(e,t){return this.timerTrackerManager.getTimerTracker(e,t)}resetPairValues(){Object.keys(this.extensions.WebRTCStats).forEach((e=>{delete this.extensions.WebRTCStats[e].pair}))}limitCaptureAmount(e,t,i){void 0!==i&&(e[t]=Array.isArray(e[t])?e[t]:[],e[t].push(i),e[t].length>this.storedRecordsNumber&&e[t].shift())}setStartTime(e){const t=this.extensions.WebRTCStats;if(!t.ssrc_audio_send||!t.ssrc_audio_recv)return!1;const i=(e,t)=>!e||t&&-1===t?t:(new Date).getTime();return this.extensions.TimerAudioPayloadRecvBitrate=Jp(e.audio)?i(t.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioPayloadRecvBitrate):-1,this.extensions.TimerAudioPayloadSendBitrate=zp(e.audio)?i(t.ssrc_audio_send.bytesSent,this.extensions.TimerAudioPayloadSendBitrate):-1,this.extensions.TimerAudioTransportRecvBitrate=Jp(e.audio)?i(t.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioTransportRecvBitrate):-1,this.extensions.TimerAudioTransportSendBitrate=zp(e.audio)?i(t.ssrc_audio_send.bytesSent,this.extensions.TimerAudioTransportSendBitrate):-1,!!(t.ssrc_video_send&&t.ssrc_video_recv&&(this.extensions.TimerVideoPayloadRecvBitrate=Jp(e.video)?i(t.ssrc_video_recv.bytesReceived,this.extensions.TimerVideoPayloadRecvBitrate):-1,this.extensions.TimerVideoPayloadSendBitrate=zp(e.video)?i(t.ssrc_video_send.bytesSent,this.extensions.TimerVideoSendBitrate):-1,this.extensions.TimerVideoPayloadRecvBitrate&&this.extensions.TimerVideoPayloadSendBitrate&&this.extensions.TimerAudioPayloadRecvBitrate&&this.extensions.TimerAudioPayloadSendBitrate&&this.extensions.TimerAudioTransportRecvBitrate&&this.extensions.TimerAudioTransportSendBitrate))}calculateAverages(){const e=this.extensions.EndTime,t=(t,i)=>t&&e-i>0&&0!==i&&-1!==i?Math.round(8*t/(e-i)):0,i=e=>{const t=e.split(".").reduce(((e,t)=>null==e?e:e[t]),this.extensions.WebRTCStats);return Array.isArray(t)?t[t.length-1]:t};this.extensions.AudioPayloadRecvBitrate=t(i("ssrc_audio_recv.bytesReceived"),this.extensions.TimerAudioPayloadRecvBitrate),this.extensions.AudioPayloadSendBitrate=t(i("ssrc_audio_send.bytesSent"),this.extensions.TimerAudioPayloadSendBitrate),this.extensions.VideoPayloadRecvBitrate=t(i("ssrc_video_recv.bytesReceived"),this.extensions.TimerVideoPayloadRecvBitrate),this.extensions.VideoPayloadSendBitrate=t(i("ssrc_video_send.bytesSent"),this.extensions.TimerVideoPayloadSendBitrate),this.extensions.AudioTransportRecvBitrate=t(i("ssrc_audio_send.pair.bytesReceived"),this.extensions.TimerAudioTransportRecvBitrate),this.extensions.AudioTransportSendBitrate=t(i("ssrc_audio_send.pair.bytesSent"),this.extensions.TimerAudioTransportSendBitrate)}addFilteredFields(e,t,i=[]){for(const n in t)if(t.hasOwnProperty(n)&&"type"!==n)if(-1!==i.indexOf(n)){const i=e[n]||[];i.push(this.formatFields(t,n)),i.length>this.storedRecordsNumber&&i.shift(),e[n]||(e[n]=i)}else e[n]=t[n]}formatFields(e,t){const i=e[t];switch(t){case"audioInputLevel":case"audioOutputLevel":return this.newStatsApi?Math.floor(65535*i):2*i;case"googJitterBufferMs":return parseInt(i);case"healedRatio":return Ct(parseFloat(i),this.configProvider.config.healedRatioPrecision);case"jitter":return Ct(parseFloat(i),this.configProvider.config.jitterPrecision);default:return i}}processSource(e,t,i){let n;if(this.addFilteredFields(e,t,$k),t.transportId){const r=i.googComponent?.[t.transportId];e.transport||(e.transport={}),r&&(this.addFilteredFields(e.transport,r),r.selectedCandidatePairId&&(n=i.googCandidatePair?.[r.selectedCandidatePairId]))}else n=Object.values(i.googCandidatePair).find((e=>e.selected));n&&(e.pair||(e.pair={}),this.addFilteredFields(e.pair,n,Gk))}getWebrtcReport(e,t,i,n){const r=e.ssrc[i],s=n?r.id.replace(/[0-9]+/,n):r.id;t[s]?r.ssrc!==t[s].ssrc&&(s.endsWith("video_send")?this.videoTelemetry.stopSendGathering():s.endsWith("video_recv")?this.videoTelemetry.stopRecvGathering():s.endsWith("sharing_send")?this.sharingTelemetry.stopSendGathering():s.endsWith("sharing_recv")&&this.sharingTelemetry.stopRecvGathering()):t[s]={},this.processSource(t[s],r,e)}constructWebRTCDataReport(e,t){if(!t.data?.length)return;const i=t.data.sort(((e,t)=>t.timestamp-e.timestamp)),n=i.find((e=>"open"===e.state));e.data=n||i[0]}constructWebRtcReportForSingleStream(e,t){if(!t.ssrc)return;const i=this.selectSsrcsToCollect(t.ssrc);e.recvCounters=i.recvCounters,delete i.recvCounters,delete i.multiRecv,Xe(i,(i=>{Xe(i,((i,n)=>{this.getWebrtcReport(t,e,i,n)}))})),t.VideoBwe?.bweforvideo&&(e.bweStat||(e.bweStat={}),this.addFilteredFields(e.bweStat,t.VideoBwe.bweforvideo,jk))}constructWebRtcReportForMultipleStreams(e,t){t.ssrc&&this.selectSsrcsToCollect(t.ssrc).multiRecv.forEach((i=>this.getWebrtcReport(t,e,i)))}getMediaType(e,t){let i=t?t.getModality():e.mediaType;return e.googTrackId?.match("applicationsharing")&&i!==Qe.MEDIA_TYPE.sharing&&(i=Qe.MEDIA_TYPE.sharing),i}selectSsrcsToCollect(e){const t={send:{},recv:{},recvCounters:{video:0,sharing:0},multiRecv:[]};if(!this.sessionInfo.activeModalities)return t;let i=[];for(const n of Object.keys(e)){const r=e[n],s=r.googTrackId;if(!s&&r.mediaType!==Qe.MEDIA_TYPE.audio)continue;const a=this.getMediaEntity(s,r),o=this.getMediaType(r,a),c=a?.getXSourceStreamId();if(n.endsWith("send"))switch(o){case Qe.MEDIA_TYPE.audio:zp(this.sessionInfo.activeModalities.audio)&&(t.send.audio=n);break;case Qe.MEDIA_TYPE.video:if(this.extensions.Video_send_SourceId=c,this.simulcastVideo.highestFidelitySSRC){this.simulcastVideo.highestFidelitySSRC===r.ssrc&&(t.send.video=n);break}this.streamSenderStarted.Video&&zp(this.sessionInfo.activeModalities.video)&&a?.getLocalTrackId()&&(a?.getLocalTrackId()===r.googTrackId||this.configProvider.config.statsAllowAnyVideoSendTrack&&!t.send.video)&&(!r.rid||"1"===r.rid)&&(t.send.video=n);break;case Qe.MEDIA_TYPE.sharing:if(this.simulcastSharing.highestFidelitySSRC){this.simulcastSharing.highestFidelitySSRC===r.ssrc&&(t.send.sharing=n);break}this.streamSenderStarted.ScreenShare&&zp(this.sessionInfo.activeModalities.sharing)&&a?.getLocalTrackId()===r.googTrackId&&(t.send.sharing=n);break;default:this.logger.warn(`Unknown media type '${o}'`)}else if(n.endsWith("recv"))switch(o){case Qe.MEDIA_TYPE.audio:Jp(this.sessionInfo.activeModalities.audio)&&(t.recv.audio=n);break;case Qe.MEDIA_TYPE.video:void 0!==c&&this.MSIDs.add(c),this.isSubscribed(r.googTrackId,r.ssrc)&&Jp(this.sessionInfo.activeModalities.video)&&(i.push(r),+r.googFrameRateReceived>0&&t.recvCounters[Qe.MODALITY.video]++);break;case Qe.MEDIA_TYPE.sharing:this.isSubscribed(r.googTrackId,r.ssrc)&&Jp(this.sessionInfo.activeModalities.sharing)&&(t.recv.sharing=n,+r.googFrameRateReceived>0&&t.recvCounters[Qe.MODALITY.sharing]++);break;default:this.logger.warn(`Unknown media type '${o}'`)}}if(i.length>0){i=i.sort(((e,t)=>+t.googFrameHeightReceived-+e.googFrameHeightReceived));const e=i.find((e=>e.mediaType===Qe.MEDIA_TYPE.video));e&&(t.recv.video=e.id),this.multiparty&&this.configProvider.config.enableMultiViewStats&&(t.multiRecv=i.map((e=>e.id)),t.multiRecv.forEach((e=>{this.multiViewVideoTelemetry[e]||(this.multiViewVideoTelemetry[e]=new Fk(this.extensions.StartTime,this.configProvider,this.logger.createChild(`Video[${e}]`,"Video")),this.multiViewVideoTelemetry[e].setMsi(this.MSIDsPairs[e]?.msi),this.multiViewVideoTelemetry[e].setLocalMsi(this.MSIDsPairs[e]?.localMsi),this.multiViewVideoTelemetry[e].prepareCollectingStatsOnSubscribed(this.MSIDsPairs[e]?.msi))})))}return t}getMediaEntityForTrack(e){if(e)return this.mediaManager.getMediaEntities().find((t=>t.getLocalTrackId()===e||t.getRemoteTrackId()===e))}getMediaEntityByRemoteSsrc(e){if(e)return this.mediaManager.getMediaEntities().find((t=>t.getRemoteSsrc()===+e))}getMediaEntity(e,t){const i=`${t.ssrc}`,n=t.id;let r=this.getMediaEntityForTrack(e);return!r&&this.configProvider.config.subscribeToSsrcForVideo&&n.endsWith("recv")&&(r=this.getMediaEntityByRemoteSsrc(i)),r}calculateHwSilentState(){const e=this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!e||e.length<2*this.hwSilentDetectionDuration)return;let t=!0;for(let i=e.length-this.hwSilentDetectionDuration-1;i<e.length;i++)if(e[i]>this.hwSilentDetectionLevel){t=!1;break}this.hwSilent!==t&&(this.hwSilent=t,this.logger.safe.info(`HW silent changed to ${this.hwSilent}`))}calculateSpeakingState(){const e=this.newStatsApi&&this.configProvider.config.useAudioAnalyzer?this.extensions.Audio_send_RawInputVolume:this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!e||e.length<=this.speakingWhileMutedBadDuration)return;let t=!1;for(let i=e.length-this.speakingWhileMutedBadDuration;i<e.length;i++)if(e[i]>this.speakingWhileMutedDetectionLevel){t=!0;break}this.isSpeaking=t}calculateNetworkRecvQualityLevel(){this.configProvider.config.enableNetworkRecvQualityUFD&&this.extensions.WebRTCStats.ssrc_audio_recv&&(this.networkRecvLevel=this.networkQualityTelemetry.calculateNetworkRecvQualityLevel({googDecodingCTN:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingCTN??[],googDecodingPLC:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingPLC??[],concealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.concealedSamples??[],silentConcealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.silentConcealedSamples??[],totalSamplesReceived:this.extensions.WebRTCStats.ssrc_audio_recv.totalSamplesReceived??[],oldNetworkLevel:this.networkRecvLevel.quality}))}calculateNetworkSendQualityLevel(){this.extensions.WebRTCStats.ssrc_audio_send&&(this.networkSendLevel=this.networkQualityTelemetry.calculateNetworkSendQualityLevel(this.extensions.WebRTCStats.ssrc_audio_send.packetsSent,this.extensions.WebRTCStats.ssrc_audio_send.packetsLost,this.extensions.WebRTCStats.ssrc_audio_send.jitter,this.networkSendLevel.quality))}processStatsError(e,t){const i=Ve(t);this.logger.safe.error(`webrtcStatistics error [${e}]: ${i}`);const n=this.statsErrors.find((t=>t.error===i&&t.origin===e));n?n.count++:this.statsErrors.push({origin:e,error:i,count:1}),this.statsErrors.length>10&&this.statsErrors.splice(1)}getLastSampleInt(e){return"number"==typeof e?e:e&&parseInt(e[e.length-1])||0}getSsrcIdFromMultipleVideoStream(e){let t;const i=this.extensions.WebRTCStats[Qe.MULTIPLE_RECV_STREAMS]||{};for(const n in i){const r=i[n];if(r&&r.googTrackId===e){t=n;break}}return t}};S([qk],Wk.prototype,"onDeviceEvent",1),S([qk],Wk.prototype,"onMaxCapabilitiesRequested",1),S([qk],Wk.prototype,"onMaxCapabilitiesApplied",1),S([qk],Wk.prototype,"addSubscriptionEvent",1),S([qk],Wk.prototype,"processSimulcastStats",1),S([qk],Wk.prototype,"processBandwidthStats",1),S([qk],Wk.prototype,"processAudioStats",1),S([qk],Wk.prototype,"processVideoStatsSend",1),S([qk],Wk.prototype,"processVideoStatsRecv",1),S([qk],Wk.prototype,"processSharingStats",1),S([qk],Wk.prototype,"processStreamsCounters",1),S([qk],Wk.prototype,"setMissedInitialPreferredResolution",1),S([qk],Wk.prototype,"setPreferredResolution",1),S([qk],Wk.prototype,"setIsRendering",1),S([qk],Wk.prototype,"setReportedSendBandwidth",1),S([qk],Wk.prototype,"setMaxSessionBandwidth",1),S([qk],Wk.prototype,"setStartTime",1),S([qk],Wk.prototype,"calculateAverages",1),S([qk],Wk.prototype,"addFilteredFields",1),S([qk],Wk.prototype,"formatFields",1),S([qk],Wk.prototype,"processSource",1),S([qk],Wk.prototype,"getWebrtcReport",1),S([qk],Wk.prototype,"constructWebRTCDataReport",1),S([qk],Wk.prototype,"constructWebRtcReportForSingleStream",1),S([qk],Wk.prototype,"constructWebRtcReportForMultipleStreams",1),S([qk],Wk.prototype,"selectSsrcsToCollect",1),S([qk],Wk.prototype,"calculateHwSilentState",1),S([qk],Wk.prototype,"calculateSpeakingState",1),S([qk],Wk.prototype,"calculateNetworkRecvQualityLevel",1),S([qk],Wk.prototype,"calculateNetworkSendQualityLevel",1);var zk=class extends ze{constructor(e,t,i,n){super(),this.logger=e,this.configProvider=t,this.mediaManager=i,this.window=Vp.window,this._sessionInfo=new IM,this.statisticsMapper=new mk,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.webRtcStatistics=new Wk(this.logger.createChild("WebrtcStatistics"),this._sessionInfo,this.configProvider,i,n,this.useNewStatsApi)}setAudioDecoderStatsProvider(e){this.statisticsMapper?.setAudioDecoderStatsProvider(e)}get sessionInfo(){return this._sessionInfo}get isDisposed(){return null===this.pc&&0===this.interval}initialize(e){this.pc=e}startWaitingForStreamStart(e){this.webRtcStatistics.startWaitingForStreamStart(e)}onDeviceEvent(e){this.webRtcStatistics.onDeviceEvent(e)}onMaxCapabilitiesRequested(e){this.webRtcStatistics.onMaxCapabilitiesRequested(e)}onMaxCapabilitiesApplied(e){this.webRtcStatistics.onMaxCapabilitiesApplied(e)}onSendersChanged(e,t){this.webRtcStatistics.setStreamSenderStarted(e,t)}addSubscriptionEvent(e,t,i,n,r,s,a){this.webRtcStatistics.addSubscriptionEvent(e,t,i,n,r,s,a)}setSubscribedTrackIds(e){this.webRtcStatistics.setSubscribedTrackIds(e)}setSubscribedTrackSsrc(e){this.webRtcStatistics.setSubscribedTrackSsrc(e)}setPreferredResolution(e,t,i){this.webRtcStatistics.setPreferredResolution(e,t,i)}setIsRendering(e,t,i){this.webRtcStatistics.setIsRendering(e,t,i)}setReportedSendBandwidth(e){this.webRtcStatistics.setReportedSendBandwidth(e)}setMaxSessionBandwidth(e){this.webRtcStatistics.setMaxSessionBandwidth(e)}setTerminated(){this.webRtcStatistics.setTerminated()}addIceCandidateError(e){this.webRtcStatistics.addIceCandidateError(e)}clearIceCandidateErrors(){this.webRtcStatistics.clearIceCandidateErrors()}recordDataChannelProtocolEvent(e){this.webRtcStatistics.recordDataChannelProtocolEvent(e)}setSessionDataChannelState(e){this.webRtcStatistics.setSessionDataChannelState(e)}recordDataChannelError(e){this.webRtcStatistics.recordDataChannelError(e)}updateSendStream(e,t){this.webRtcStatistics.updateSendStream(e,t)}getTimerTracker(e,t){return this.webRtcStatistics.getTimerTracker(e,t)}setH264AvailableProfiles(e){if(!e?.codecs)return;let t=[];e.codecs.forEach((e=>{if("h264"===e.mimeType&&e.sdpFmtpLine){const i=/profile-level-id=(.{6})/.exec(e.sdpFmtpLine);i?.[1]&&(t=t.concat(i[1]))}})),this.webRtcStatistics.addH264AvailableProfiles(t)}processRawReport(e){this.processStatsDict(this.statisticsMapper.build(e))}processLegacyReport(e){this.processStatsDict(function(e){const t={};return e.result().forEach((e=>{e.names().forEach((i=>{t[e.type]=t[e.type]||{},t[e.type][e.id]=t[e.type][e.id]||{},t[e.type][e.id][i]=e.stat(i)})),t[e.type][e.id].id=e.id})),t}(e))}getReport(e,t=!1){const i=this.webRtcStatistics.getReport(e,t);return this.addStreamInfoForE2ETests(i),i}dispose(){this.interval&&(this.window.clearInterval(this.interval),this.interval=0),this.pc=null}getLastStatistics(){return this.statistics}setTimeToFirstFrame(e,t,i){this.webRtcStatistics.setTimeToFirstFrame(e,t,i)}setFreezeDuration(e,t){this.webRtcStatistics.setFreezeDuration(e,t)}addVideoControlMessage(e=!1){this.webRtcStatistics.addVideoControlMessage(e)}setSsrcTrackPair(e,t){this.statisticsMapper.setSsrcTrackPair(e,t)}updateStatsWithLocalSsrcTrackInfo(){for(const e of this.mediaManager.getMediaEntities()){const t=e.getLocalSsrc();t&&this.statisticsMapper.setSsrcTrackPair(t,e.getLocalTrackId())}}addReportedReceiveBandwidth(e){this.webRtcStatistics.addReportedReceiveBandwidth(e)}addStreamInfoForE2ETests(e){const t=this._sessionInfo.negotiatedModalities;if(t&&!this.isDisposed)try{e.localStreams=this.getSendersReport(this.pc.getSenders(),{audio:zp(t.audio),video:zp(t.video)}),e.remoteStreams=this.getReceiversReport(this.pc.getReceivers(),{audio:Jp(t.audio),video:Jp(t.video)})}catch(e){this.logger.safe.warn(`addStreamInfoForE2ETests failed: ${Ve(e)}`)}}getReceiversReport(e,t){const i=[];return e.forEach((e=>{const n={tracks:[]};i.push(n),e.track&&("audio"===e.track.kind&&t.audio||"video"===e.track.kind&&t.video)&&n.tracks.push({stream:void 0,track:e.track})})),i}getSendersReport(e,t){const i=[],n={tracks:[]};return i.push(n),e.forEach((e=>{e.track&&("audio"===e.track.kind&&t.audio||"video"===e.track.kind&&t.video)&&n.tracks.push({stream:void 0,track:e.track})})),i}processStatsDict(e){this.webRtcStatistics.processStatsDict(e);let t=0,i=0;const n=e.VideoBwe?.bweforvideo;n&&(t=Number(n.googAvailableReceiveBandwidth),i=Number(n.googAvailableSendBandwidth));const r=1e3*((this.configProvider.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(this.configProvider.config.audioBandwidthInKbps||0)),s=isNaN(t)?0:t,a=isNaN(i)?0:i,o={estimatedReceiveBandwidth:Math.min(s,r),estimatedSendBandwidth:Math.min(a,r),remoteVideoStreams:{},localVideoStreams:{},isSpeaking:this.webRtcStatistics.getSpeakingState(),audioHwSilent:this.webRtcStatistics.getAudioHwSilent(),networkSendLevel:this.webRtcStatistics.getNetworkSendLevel(),networkRecvLevel:this.webRtcStatistics.getNetworkRecvLevel()};Xe(e.ssrc,(e=>{if("video"!==e.mediaType)return;const t=e.googTrackId,i=e.id;-1!==i.indexOf("_recv")?(o.remoteVideoStreams[t]={trackId:t,frameRateReceived:Number(e.googFrameRateReceived),frameRateDecoded:Number(e.googFrameRateDecoded),framesDecoded:Number(e.framesDecoded)},this.configProvider.config.isRenderingBasedOnRawStatistics||(o.remoteVideoStreams[t].isRendering=this.webRtcStatistics.getIsRendering(i))):t&&-1!==i.indexOf("_send")&&(o.localVideoStreams[t]={trackId:t,ssrc:Number(e.ssrc),frameRateInput:Number(e.googFrameRateInput)})})),ht(this.statistics,o)||(this.statistics=o,this.notifyStatisticsChanged())}notifyStatisticsChanged(){this.event("onStatisticsChanged").raise(this.statistics)}},Jk=class extends ze{constructor(e,t,i,n,r){super(),this.logger=e,this.configProvider=t,this.diagnostics=i,this.mediaManager=n,this.window=Vp.window,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.loopIntervalTracker=new CO(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.loopIntervalAggregator=new _O,this.fetchTimeTracker=new CO(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.fetchTimeAggregator=new _O,this.gathererV1=new zk(this.logger.createChild("V1"),this.configProvider,this.mediaManager,r),this.gathererV1.on("onStatisticsChanged",(e=>this.event("onStatisticsChanged").raise(e))),this.useNewStatsApi&&t.config.diagnostics.sideBySide&&(this.gathererV2=new rk(this.logger.createChild("V2"),this.configProvider,this.diagnostics,this.mediaManager))}initialize(e){this.pc=e,this.gathererV1.initialize(e),this.interval??(this.interval=this.window.setInterval((()=>this.processStats()),this.configProvider.config.webrtcStatPollInterval))}setAudioDecoderStatsProvider(e){this.gathererV1.setAudioDecoderStatsProvider(e),this.gathererV2?.setAudioDecoderStatsProvider(e)}dispose(){super.dispose(),this.interval&&(this.window.clearInterval(this.interval),this.interval=void 0),this.gathererV1.dispose(),this.pc=void 0}get isDisposed(){return!this.pc&&void 0===this.interval}async processStats(){if(this.configProvider.config.diagnostics.collectWhileNotConnected){if(!this.pc||"closed"===this.pc.iceConnectionState)return}else if(!this.pc||"connected"!==this.pc.iceConnectionState&&"completed"!==this.pc.iceConnectionState)return void this.gathererV2?.signalNoConnection();if(this.useNewStatsApi){const e=Pt(),t=void 0===this.loopTimer?-1:e-this.loopTimer;this.loopTimer=e,this.loopIntervalTracker.captureSample(t),this.loopIntervalAggregator.captureSample(this.loopIntervalTracker.getReport());const i=this.loopIntervalAggregator.getReport();i&&(this.diagnostics.loopIntervalMax=i.max,this.diagnostics.loopIntervalMedian=i.median);const n={};(await this.pc.getStats()).forEach((e=>{this.cleanupPii(e);const t=e.type;delete e.type,n[t]??(n[t]={}),n[t][e.id]=e}));const r=Pt()-e;this.fetchTimeTracker.captureSample(r),this.fetchTimeAggregator.captureSample(this.fetchTimeTracker.getReport());const s=this.fetchTimeAggregator.getReport();s&&(this.diagnostics.fetchTimeMax=s.max,this.diagnostics.fetchTimeMedian=s.median);const a=this.gathererV2?.processRawReport(n);let o=Pt();this.gathererV1.processRawReport(n),o=Pt()-o,a&&this.event("onDiagnosticUpdated").raise(a),a?.perfCounters&&(a.perfCounters.loopTime=t,a.perfCounters.fetchTime=r,a.perfCounters.legacyProcessingTime=o)}else this.pc.getStats((e=>{e.result&&this.gathererV1.processLegacyReport(e)}))}cleanupPii(e){switch(e.type){case"local-candidate":case"remote-candidate":{const t=e;Object.defineProperty(t,"address",{enumerable:!1}),Object.defineProperty(t,"url",{enumerable:!1}),Object.defineProperty(t,"relatedAddress",{enumerable:!1}),Object.defineProperty(t,"ip",{enumerable:!1}),Object.defineProperty(t,"usernameFragment",{enumerable:!1});break}case"certificate":{const t=e;Object.defineProperty(t,"fingerprint",{enumerable:!1}),Object.defineProperty(t,"base64Certificate",{enumerable:!1});break}}}get sessionInfo(){return this.gathererV1.sessionInfo}setReportedSendBandwidth(e){this.gathererV1.setReportedSendBandwidth(e)}onMaxCapabilitiesApplied(e){this.gathererV1.onMaxCapabilitiesApplied(e)}clearIceCandidateErrors(){this.gathererV1.clearIceCandidateErrors()}setSsrcTrackPair(e,t){this.gathererV1.setSsrcTrackPair(e,t),this.gathererV2?.setSsrcTrackPair(e,t)}addSubscriptionEvent(e,t,i,n,r,s,a){this.gathererV1.addSubscriptionEvent(e,t,i,n,r,s,a)}setSubscribedTrackSsrc(e){this.gathererV1.setSubscribedTrackSsrc(e)}addIceCandidateError(e){this.gathererV1.addIceCandidateError(e)}setH264AvailableProfiles(e){this.gathererV1.setH264AvailableProfiles(e)}setTerminated(){this.gathererV1.setTerminated()}onDeviceEvent(e){this.gathererV1.onDeviceEvent(e)}getReport(e,t=!1){const i=this.gathererV1.getReport(e,t);if(this.gathererV2&&this.configProvider.config.diagnostics.sideBySide){const e=this.loopIntervalAggregator.getReport();e&&(i.data.Extensions.LoopIntervalMax=`${Ct(e.max,1)}`,i.data.Extensions.LoopIntervalMedian=`${Ct(e.median,1)}`);const t=this.fetchTimeAggregator.getReport();t&&(i.data.Extensions.FetchTimeMax=`${Ct(t.max,1)}`,i.data.Extensions.FetchTimeMedian=`${Ct(t.median,1)}`);const n=this.diagnostics.getObjectRef();i.data.Extensions.multipleVideoStreams=JSON.stringify(Dt(n.multiViewStats,"startTime",n.startTime)),i.data.Extensions.OvcToSubscriptions=JSON.stringify(n.ovcToSubscriptionEvents),i.data.Extensions.videoPerformanceEvent=JSON.stringify(n.videoPerformanceEvent);const r=n.bandwidthReport;"REMB"===n.bweType?(i.data.Extensions.StartCallBWE=JSON.stringify(r?.startOfTheCall),i.data.Extensions.EndCallBWE=JSON.stringify(r?.endOfTheCall),i.data.Extensions.BWEStd=JSON.stringify(r?.std),i.data.Extensions.BwPercentiles=JSON.stringify(r?.bwPercentiles),i.data.Extensions.AvgBwe=JSON.stringify(r?.avgBwe)):(i.data.Extensions.StartCallBWESendSide=JSON.stringify(r?.startOfTheCall),i.data.Extensions.EndCallBWESendSide=JSON.stringify(r?.endOfTheCall),i.data.Extensions.BWEStdSendSide=JSON.stringify(r?.std),i.data.Extensions.BwPercentilesSendSide=JSON.stringify(r?.bwPercentiles),i.data.Extensions.AvgBwSendSide=JSON.stringify(r?.avgBwe)),i.data.Extensions.InitialBWSeed=JSON.stringify(n.initialBWSeed),i.data.Extensions.SentBWSeed=JSON.stringify(n.sentBWSeed),i.data.Extensions.Bandwidth_downlinkStabilizationTime=JSON.stringify(n.bwDownlinkStabilizationTime);const s=n.aggregatedModalityStats?.video?.recv||[],a=n.aggregatedModalityStats?.audio?.recv||[],o=n.aggregatedModalityStats?.sharing?.recv||[],c=s[s.length-1],l=o[o.length-1],d=c?.aggregated?.macroblockRateStats??{},h=a[a.length-1]?.aggregated?.customHealerStats??{};if(h?.pullPacketProcessingTimes){const e=Ut(h.pullPacketProcessingTimes);h.pullPacketProcessingTimeP50=e.getPercentile(.5),h.pullPacketProcessingTimeP95=e.getPercentile(.95)}if(h?.pushPacketProcessingTimes){const e=Ut(h.pushPacketProcessingTimes);h.pushPacketProcessingTimeP50=e.getPercentile(.5),h.pushPacketProcessingTimeP95=e.getPercentile(.95)}for(const e in d)i.data.Extensions[`Video_recv_${e}`]=`${Ct(d[e],0)}`;for(const e in n.totalVideoRecvMblocksRates)i.data.Extensions[`totalVideoRecv_${e}`]=`${Ct(n.totalVideoRecvMblocksRates[e],0)}`;for(const e in h)if(void 0!==h[e]){const t="number"!=typeof h[e]?JSON.stringify(h[e]):h[e];i.data.Extensions[`Audio_recv_customHealer_${e}`]=t}i.data.Extensions.CallSetupTimeTracker=JSON.stringify(n.timerTrackerReport),i.data.Extensions.Audio_send_presentationAPIUserDuration=JSON.stringify(n.presentationAPIUserDuration),i.data.Extensions.Audio_send_presentationDuration=JSON.stringify(n.presentationAudioDuration),i.data.Extensions.CodecSupport=JSON.stringify(n.codecSupport),i.data.Extensions.Video_recv_FpsHarmonicAverage=c?.extensions.fpsHarmonicAverage?.toString(),i.data.Extensions.Sharing_recv_FpsHarmonicAverage=l?.extensions.fpsHarmonicAverage?.toString(),i.data.Extensions.Sharing_recv_CodecReport=JSON.stringify(l?.aggregated.codecReport),this.configProvider.config.diagnostics.features.takeFreezeTelemetryFromGathererV2&&(s.length&&(i.data.Extensions.Video_recv_FreezeHistogram=JSON.stringify(c.aggregated.freezeCountHistogram),i.data.Extensions.Video_recv_LongestFreezeDuration=JSON.stringify(c?.aggregated?.longestFreeze),i.data.Extensions.Video_recv_OngoingFreeze=JSON.stringify(c?.extensions?.isFrozen),i.data.Extensions.Video_recv_OngoingFreezeDuration=JSON.stringify(c?.aggregated?.ongoingFreezeDuration),i.data.Extensions.Video_recv_TotalFreezeDuration=JSON.stringify(c?.aggregated?.totalFreezeDuration),i.data.Extensions.Video_recv_RecvAvgFreezeDuration=JSON.stringify(c?.aggregated?.avgFreezeDuration),i.data.Extensions.Video_recv_FreezeTimestamps=JSON.stringify(Ot(c?.aggregated?.freezeTimestampsHistogram,n.startTime))),o.length&&(i.data.Extensions.Sharing_recv_FreezeHistogram=JSON.stringify(l.aggregated.freezeCountHistogram),i.data.Extensions.Sharing_recv_LongestFreezeDuration=JSON.stringify(l?.aggregated?.longestFreeze),i.data.Extensions.Sharing_recv_OngoingFreeze=JSON.stringify(l?.extensions?.isFrozen),i.data.Extensions.Sharing_recv_OngoingFreezeDuration=JSON.stringify(l?.aggregated?.ongoingFreezeDuration),i.data.Extensions.Sharing_recv_TotalFreezeDuration=JSON.stringify(l?.aggregated?.totalFreezeDuration),i.data.Extensions.Sharing_recv_RecvAvgFreezeDuration=JSON.stringify(l?.aggregated?.avgFreezeDuration),i.data.Extensions.Sharing_recv_FreezeTimestamps=JSON.stringify(Ot(l?.aggregated?.freezeTimestampsHistogram,n.startTime)))),i.data.Extensions.EarlyMedia={NumStatsPolls:`${n.earlyMediaNumStatsPolls}`}}return i}startWaitingForStreamStart(e){this.gathererV1.startWaitingForStreamStart(e)}getTimerTracker(e,t){return this.gathererV1.getTimerTracker(e,t)}getLastStatistics(){return this.gathererV1.getLastStatistics()}updateSendStream(e,t){this.gathererV1.updateSendStream(e,t)}setSubscribedTrackIds(e){this.gathererV1.setSubscribedTrackIds(e)}setMaxSessionBandwidth(e){this.gathererV1.setMaxSessionBandwidth(e)}updateStatsWithLocalSsrcTrackInfo(){this.gathererV1.updateStatsWithLocalSsrcTrackInfo()}onSendersChanged(e,t){this.gathererV1.onSendersChanged(e,t)}setPreferredResolution(e,t,i){this.gathererV1.setPreferredResolution(e,t,i)}setIsRendering(e,t,i){this.gathererV1.setIsRendering(e,t,i)}setTimeToFirstFrame(e,t,i){this.gathererV1.setTimeToFirstFrame(e,t,i)}setFreezeDuration(e,t){this.gathererV1.setFreezeDuration(e,t)}addVideoControlMessage(e){this.gathererV1.addVideoControlMessage(e)}setSessionDataChannelState(e){this.gathererV1.setSessionDataChannelState(e)}recordDataChannelError(e){this.gathererV1.recordDataChannelError(e)}onMaxCapabilitiesRequested(e){this.gathererV1.onMaxCapabilitiesRequested(e)}recordDataChannelProtocolEvent(e){this.gathererV1.recordDataChannelProtocolEvent(e)}addReportedReceiveBandwidth(e){this.gathererV1.addReportedReceiveBandwidth(e)}},Kk=101,Yk=[48e3,32e3,24e3,16e3,12e3],Qk=class{constructor(e){this.context=e,this.cname=dt(),this.dataMedia={type:Qe.MEDIA_TYPE.data,protocol:Qe.PROFILES.rtpSavp,port:0},this.configProvider=e.configProvider,this.logger=e.getLogger().createChild("WebkitSdpTrans")}fixTelephoneEvent(e){let t;return Yk.forEach((t=>{xw(e,{codec:"telephone-event",rate:t})})),Dw(e,Kk,999),kw(e,{codec:"telephone-event",rate:8e3},(e=>(t=e.rtp.payload,e.rtp.payload=Kk,e))),Dw(e,999,t||Kk),t}toLocal(e,t,i){const n=t.isEmpty(),r=ct(e);let s;return r.media.forEach((e=>{if("audio"===e.type)n&&(s=this.fixTelephoneEvent(e)),Zk(e);else{s&&Dw(e,Kk,s);const i=t.getLocalSsrcs().get($w(e));this.enforceFixedSsrc(e,i)}const r=ym(this.configProvider,e.type);"offer"===i&&nN(e,r,n,this.logger)})),new JP(this.configProvider).modify(r),delete r.extmapAllowMixed,r}toOffer(e,t,i){return this.fromNative(e,t,i,!0)}toAnswer(e,t,i){return this.fromNative(e,t,i,!1)}toRemote(e,t,i,n){const r=ct(e);let s,a,o=this.configProvider.mediaConfig.maxBandwidthInKbps;r.bandwidth&&(!o||o>e.bandwidth[0].limit)&&(o=e.bandwidth[0].limit),r.media.forEach(((e,i)=>{t.getMediaEntity(i).isDisabled()&&e.type!==Qe.MEDIA_TYPE.audio&&(e.port=0)}));let c=function(e){return e.groups?e.groups.find((e=>"BUNDLE"===e.type)):null}(r);if(!c){let e=!1;r.media.forEach(((i,n)=>{const r=t.getMediaEntity(n);!e&&r.isEnabled()?(i.mid=r.getMid(),e=!0):(r.disable(),i.port=0)})),e&&(r.groups||(r.groups=[]),c={type:"BUNDLE"},r.groups.push(c))}r.media.forEach((e=>{const t=$w(e);i[t]===Qe.MEDIA_STATE.send&&(e.direction&&e.direction.toLowerCase()===Qe.MEDIA_STATE.receive||(e.direction=Qe.MEDIA_STATE.receive))}));const l=r.media.filter((e=>e.type===Qe.MEDIA_TYPE.video));if(l.length>0){const e=l.filter((e=>0!==e.port));if(e.length>0){a=ct(e[0]),a.bandwidth&&delete a.bandwidth;const t=this.configProvider.config.audioBandwidthInKbps?this.configProvider.config.audioBandwidthInKbps:0;o&&o-t>0&&(a.bandwidth=[{limit:o-t,type:"AS"}]),a.mid="video",a.direction=null,delete a.label,a.ssrcs=[],a.ssrcGroups=[],delete a.msid,e.forEach((e=>{e.ssrcs&&(a.ssrcs=a.ssrcs.concat(e.ssrcs)),e.ssrcGroups&&(a.ssrcGroups=a.ssrcGroups.concat(e.ssrcGroups)),a.direction=function(e,t){return e===Qe.MEDIA_STATE.sendReceive||t===Qe.MEDIA_STATE.sendReceive?Qe.MEDIA_STATE.sendReceive:e===t?e:e&&t&&e!==t?Qe.MEDIA_STATE.sendReceive:e||t}(a.direction,e.direction||Qe.MEDIA_STATE.sendReceive)})),Xk(a)}else a=tN(Qe.MEDIA_TYPE.video,void 0,l[0].protocol,l[0].payloads)}const d=r.media.find((e=>e.type===Qe.MEDIA_TYPE.audio));if(d)if(0!==d.port)s=ct(d),s.mid="audio",delete s.label,function(e){xw(e,{codec:"g722",rate:8e3,encoding:2})}(s),Zk(s),Xk(s);else{s=tN(Qe.MEDIA_TYPE.audio,void 0,d.protocol,d.payloads);const e=r.media.find((e=>!!e.iceUfrag));e&&(s.port=9,s.direction="inactive",s.mid="audio",s.iceUfrag=e.iceUfrag,s.icePwd=e.icePwd,s.rtcpMux="rtcp-mux",e.crypto&&(s.crypto=e.crypto),e.fingerprint&&(s.fingerprint=e.fingerprint,s.setup=e.setup),s.rtp=[{payload:0,codec:"PCMU",rate:8e3}],s.payloads="0")}r.media.forEach(((e,t)=>{e.type===Qe.MEDIA_TYPE.data&&(e.type=Qe.MEDIA_TYPE.dataChannel,e.payloads=Qe.PAYLOAD_TYPE.DATA_CHANNEL,e.protocol=Qe.PROFILES.udpDtlsSctp,e.mid="data",delete e.xDataProtocol,delete e.direction,Ww(e)&&(r.media[t]=tN(e.type,void 0,e.protocol,e.payloads)))}));const h=vm(this.context)?r.media.find((e=>e.type===Qe.MEDIA_TYPE.dataChannel)):null;r.media=[s,a,h].filter((e=>e)),t.getMediaEntities()[0].getModality()!==Qe.MODALITY.audio&&r.media.reverse();const u=fm(this.context),g=im(e);return r.media.forEach((e=>{e.type!==Qe.MEDIA_TYPE.dataChannel&&(!u&&e.fingerprint&&e.crypto&&delete e.crypto,e.protocol=!g.dtls||g.sdes&&u?Qe.PROFILES.rtpSavpf:Qe.PROFILES.udpTlsRtpSavpf)})),"offer"===n&&(nN(s,this.configProvider.config.allowedAudioCodecs,!1,this.logger),nN(a,this.configProvider.config.allowedVideoCodecs,!1,this.logger)),eN(r,this.configProvider.mediaConfig.isTransportUnbundled),r}splitMedia(e,t,i,n,r){const s=e.getMid(),a=e.getModality(),o=ct(t);if(o.label=Gw(a),o.direction=n,o.mid=s,o.ssrcs=[],o.ssrcGroups=[],e.getModality()===Qe.MODALITY.data)return o.type=Qe.MEDIA_TYPE.data,o.payloads=Qe.PAYLOAD_TYPE.X_DATA,o;const c=i.filter((e=>e.modality===a));if(c&&c.length){const e=[];t.ssrcs&&(c.forEach((i=>{const n=t.ssrcs.filter((e=>"msid"===e.attribute&&i.trackId===iN(e.value))).map((e=>e.id));e.push(...n)})),o.ssrcs=t.ssrcs.filter((t=>e.indexOf(t.id)>-1)),o.ssrcs.forEach((e=>{"cname"===e.attribute&&(e.value=this.cname)}))),t.ssrcGroups&&(o.ssrcGroups=t.ssrcGroups.filter((t=>t.ssrcs.split(" ").find((t=>e.indexOf(+t)>-1)))))}else{if(n===Qe.MEDIA_STATE.send||n===Qe.MEDIA_STATE.sendReceive)return tN(t.type,Gw(a),t.protocol,t.payloads);n!==Qe.MEDIA_STATE.receive&&n!==Qe.MEDIA_STATE.inactive||(r[t.type].ssrcs&&r[t.type].ssrcs[0]?o.ssrcs=[{id:r[t.type].ssrcs[0].id,attribute:"cname",value:this.cname}]:t.type===Qe.MEDIA_TYPE.audio?o.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:t.type===Qe.MEDIA_TYPE.video&&(o.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}return o}fromNative(e,t,i,n){const r=ct(e),s=this.configProvider.mediaConfig.maxBandwidthInKbps;s&&(r.bandwidth=[{limit:s,type:"CT"}]),new KP(this.configProvider).modify(r);const a=r.media.find((e=>e.type===Qe.MEDIA_TYPE.audio)),o=r.media.find((e=>e.type===Qe.MEDIA_TYPE.video)),c=r.media.find((e=>e.type===Qe.MEDIA_TYPE.dataChannel)),l={};l[Qe.MODALITY.audio]=a,l[Qe.MODALITY.video]=o,l[Qe.MODALITY.sharing]=o,l[Qe.MODALITY.data]=c||this.dataMedia;const d={};d[Qe.MEDIA_TYPE.audio]=a,d[Qe.MEDIA_TYPE.video]=o,d[Qe.MEDIA_TYPE.data]=c||this.dataMedia;const h={};return h[Qe.MODALITY.audio]=t.getMediaEntitiesByModality(Qe.MODALITY.audio)[0],h[Qe.MODALITY.video]=t.getMediaEntitiesByModality(Qe.MODALITY.video)[0],h[Qe.MODALITY.sharing]=t.getMediaEntitiesByModality(Qe.MODALITY.sharing)[0],h[Qe.MODALITY.data]=t.getMediaEntitiesByModality(Qe.MODALITY.data)[0],r.media=[],t.getMediaEntities().forEach((e=>{let s,a=i[e.getModality()];!e.isEnabled()||0===l[e.getModality()].port||e!==h[e.getModality()]&&a===Qe.MEDIA_STATE.send?(s=tN(e.getType(),Gw(e.getModality()),l[e.getModality()].protocol,l[e.getModality()].payloads),l[e.getModality()].payloads===Qe.PAYLOAD_TYPE.DATA_CHANNEL&&(s.payloads=Qe.PAYLOAD_TYPE.DATA_CHANNEL)):(a!==Qe.MEDIA_STATE.inactive&&e!==h[e.getModality()]&&(a=Qe.MEDIA_STATE.receive),s=this.splitMedia(e,l[e.getModality()],t.getLocalTracksInfo(),a,d),e!==h[e.getModality()]&&(s.candidates=[]));const o=l[e.getModality()].setup;o&&("actpass"!==o?e.setExtension("setup",o):n&&void 0!==e.getExtension("setup")&&(s.setup="actpass"!==e.getExtension("setup")?e.getExtension("setup"):o));const c=l[e.getModality()].iceUfrag,u=e.getExtension("iceUfrag");e.setExtension("iceRestart",!!c&&!!u&&u!==c),e.setExtension("iceUfrag",c),Ww(s)&&e.disable(),r.media.push(s)})),new gP(this.context,i.data).modify(r),eN(r,this.configProvider.mediaConfig.isTransportUnbundled),r}enforceFixedSsrc(e,t){let i=-1;if(!e.ssrcs)return;const n=[];if(e.ssrcs.forEach((e=>{"msid"===e.attribute&&n.push({ssrc:e.id,trackId:iN(e.value)})})),e.ssrcs.forEach((e=>{"cname"===e.attribute&&i++,t&&(e.id=this.getVideoSSRC(i,t))})),e.ssrcGroups){const t=e.ssrcs.filter((e=>"cname"===e.attribute)).map((e=>e.id));e.ssrcGroups.forEach(((e,i)=>{e.ssrcs=[t[2*i],t[2*i+1]].join(" ")}))}}getVideoSSRC(e,t){return e%2==1?t+50:t}};function Xk(e){const t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))))}function Zk(e){xw(e,{codec:"CN",rate:16e3})}function eN(e,t){const i=e.groups?.findIndex((e=>"BUNDLE"===e.type)),n=e.groups?e.groups[i]:void 0;n&&(t?(n.mids=e.media.filter((e=>e.type===Qe.MEDIA_TYPE.video)).map((e=>e.mid)).filter((e=>e)).join(" "),n.mids||delete e.groups[i]):n.mids=e.media.map((e=>e.mid)).filter((e=>e)).join(" "))}function tN(e,t,i,n){return{type:e,port:0,label:t,payloads:n,protocol:i}}function iN(e){return e.split(" ")[1]}function nN(e,t,i,n){t.length&&e?.port&&Bw(e,Em(t),i,n)}var rN=f(ye()),sN=class{getCapabilities(e){const t=RTCRtpReceiver.getCapabilities(e);return t.codecs.forEach((e=>{const t=e.mimeType.toLowerCase().split("/");e.mimeType=t[1]||t[0]})),Promise.resolve(t)}},aN=class{constructor(e,t){this.noRequiredCodecsWorkaround=t,this.selfGlobal=e.global.capabilityGatherer=e.global.capabilityGatherer||{},this.getCapabilities("video")}async getCapabilities(e){if("video"!==e&&"audio"!==e)return Promise.reject(new Error(`capabilities for ${e} are not supported`));if(!this.selfGlobal.gatherTask){const e=Om();this.selfGlobal.gatherTask=e.promise;const t=void 0!==Vp.window.webkitRTCPeerConnection,i=t?new Vp.window.webkitRTCPeerConnection(null):new Vp.window.RTCPeerConnection(null),n=e=>t?new Promise(((t,n)=>{i.createOffer(t,n,e)})):(this.noRequiredCodecsWorkaround&&i.addTrack(i.addTransceiver("video").receiver.track),i.createOffer(e));try{const t=await n({offerToReceiveVideo:1,offerToReceiveAudio:1}),r={};rN.parse(t.sdp).media.forEach((e=>{r[e.type]=e.rtp.map((t=>{const i={mimeType:t.codec.toLowerCase()};if("video"===e.type){const n=e.fmtp?.find((e=>e.payload===t.payload));i.sdpFmtpLine=n?.config}return i}))})),i.close(),e.resolve(r)}catch(t){this.selfGlobal.gatherTask=null,i.close(),e.reject(t)}}return this.selfGlobal.gatherTask.then((t=>({codecs:t[e]})))}},oN=(e,t,i=!1)=>!t&&Bp.hasCapabilitiesApi()?new sN:new aN(e,i),cN=f(ye()),lN="rollback";function dN(){const e=[].slice.apply(arguments);let t=e[0]&&hN(e[0].type);e.splice(0,t?1:0,null);const i=new(Function.prototype.bind.apply(Vp.window.RTCSessionDescription,e)),n=Object.getOwnPropertyDescriptor(Vp.window.RTCSessionDescription.prototype,"type");return Object.defineProperty(i,"type",{get:()=>t?lN:n.get.call(i),set(e){t=hN(e),t||n.set.call(i,e)}}),i}function hN(e){return lN===e}var uN=()=>dN,gN=[{codec:"telephone-event",rate:8e3},{codec:"cn",rate:16e3}];function pN(e){const t=[],i=uN(),n=[].slice.apply(arguments);n.splice(0,1,null),function(e,t){n[1]&&n[1][e]&&(n[1][t]=n[1][e])}("iceTransportPolicy","iceTransports");const r=new(Function.prototype.bind.apply(Vp.window.webkitRTCPeerConnection,n));function s(e,t){let i;Object.defineProperty(this,"dtmf",{get:()=>"audio"===e.kind?(i=i||r.createDTMFSender(e),i):null}),this.track=e,this._stream=t}return[{name:"createOffer",reverseArgs:!0},"createAnswer","setRemoteDescription","setLocalDescription"].forEach((function(e){const t=e.name||e,i=r[t];r[t]=function(){const t=arguments;return new Promise((function(n,s){const a=[n,s];t.length>0&&a.splice(e.reverseArgs?a.length:0,0,t[0]),i.apply(r,a)}))}})),function(){["createOffer","createAnswer","setLocalDescription"].forEach((function(t){const i=r[t];r[t]=function(){const t=arguments;return e.getCapabilities("video").then((function(){return i.apply(i,t)}))}}));const t=r.setRemoteDescription;r.setRemoteDescription=function(i){return e.getCapabilities("video").then((function(e){const n=e.codecs,r=cN.parse(i.sdp);return r.media.forEach((function(e){if("video"===e.type&&(e.rtp.some((function(e){return n.some((function(t){return e.codec.toLowerCase()===t.mimeType}))}))?function(e){kw(e,{codec:"h264",rate:9e4},(function(e){if(e.fmtp){const t=new Mw,i=new Mw(e.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((function(e){if(i.contains(e)){let n=i.get(e);"profile-level-id"===e&&(n="42C02A"),t.setIfMissing(e,n)}})),e.fmtp.config=t.toString()}}))}(e):e.port=0),!function(e){return"RTP/SAVPF"!==e.protocol}(e)){const t=qw(r);t?e.crypto=t.crypto:e.port||r.media.some((function(t){return!!t.port&&(e.crypto=t.crypto,!0)}))}})),i.sdp=cN.write(r),t(i)}))}}(),function(){const e=r.createAnswer;r.createAnswer=function(){const t=arguments;return e.apply(r,t).then((function(e){if(!r.localDescription||!r.localDescription.sdp)return e;const t=cN.parse(r.localDescription.sdp),n=[];if(t.media.forEach((function(e){gN.forEach((function(t){kw(e,t,(function(e){n.push(e)}))}))})),n.length){const t=cN.parse(e.sdp);let r=!1;t.media.forEach((function(e){n.forEach((function(t){kw(e,{codec:t.rtp.codec,rate:t.rtp.rate},(function(e){e.rtp.payload!==t.rtp.payload&&(e.rtp.payload=t.rtp.payload,r=!0)}))}))})),r&&(e=new i({type:e.type,sdp:cN.write(t)}))}return e}))}}(),function(){const e=r.createOffer;r.createOffer=function(t){const i=arguments;return t&&t.offerToReceiveVideo>1&&(t.offerToReceiveVideo=1),e.apply(r,i)}}(),r.getSenders&&r.addTrack&&r.removeTrack||(r.getSenders=function(){return t.slice()},r.addTrack=function(e,i){if(!e||!i)throw new Error("both media track and stream need to be provided");r.getLocalStreams().some((function(e){return e.id===i.id}))||r.addStream(i);let n=t.find((function(t){return t.track.id===e.id}));return n||(n=new s(e,i),t.push(n)),n},r.removeTrack=function(e){r.getLocalStreams().filter((function(t){return t.id===e._stream.id})).forEach((function(e){r.removeStream(e)})),nt(t,(t=>t===e))}),r}var mN=e=>pN.bind(null,e),fN=class{constructor(e){const t=e.configProvider.config.useSdpCapabilitiesLegacySession,i=e.configProvider.config.noRequiredCodecsWorkaround;this.RTCRtpReceiver=oN(e,t,i),this.SdpTransform=Qk,this.RTCPeerConnection=mN(this.RTCRtpReceiver),this.RTCSessionDescription=uN()}};function SN(){function e(){throw new Error("unsupported platform")}this.SdpTransform=e,this.RTCPeerConnection=e,this.RTCSessionDescription=e,this.RTCRtpReceiver=e}var vN=e=>void 0!==Vp.window.webkitRTCPeerConnection?new fN(e):new SN,yN=class{constructor(e,t,i,n){this.logger=e,this.configProvider=t,this.activeSpeakerManager=i,this.contributingSourcesProvider=n,this.lastSources=[],this.poll=()=>{const e=this.contributingSourcesProvider.getContributingSources();if(!e)return this.logger.safe.info("Contributing sources are not supported on this client"),void this.dispose();this.activeSpeakerManager.onContributingSourcesChanged(e.filter((e=>{const t=this.lastSources.find((t=>t.source===e.source));return!t||t.timestamp!==e.timestamp})).map((e=>e.source))),this.updateLastSources(e),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)},this.contributingSourcesProvider=n,this.logger.safe.info("Polling started"),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)}dispose(){this.timer&&(window.clearTimeout(this.timer),this.timer=void 0),this.contributingSourcesProvider=void 0,this.logger.safe.info("Polling stopped")}updateLastSources(e){this.lastSources=e.map((e=>({source:e.source,timestamp:e.timestamp})))}},CN=class{constructor(e,t){this.logger=e,this.peerConnection=t}getContributingSources(){try{if(!this.peerConnection?.getReceivers)return;const e=this.peerConnection.getReceivers().find((e=>"audio"===e.track.kind));return e?e.getContributingSources?.():[]}catch(e){return void this.logger.safe.error("Failed to get contributing sources",e)}}},_N=p,EN=[2812,4218,8437,16875,33750,67500,108e3,135e3,198e3,244800,27e4,352500,52e4],TN=class{constructor(e,t,i,n){this.initialMaxFS=e,this.initialMaxFPS=t,this.isAv1Allowed=i,this.h264SubscribeProfile=n,this.maxFS=e,this.maxFPS=t}setMaxFS(e,t){return!(this.maxFS===e||(this.maxFS=e,!t)||(t(this),0))}getMaxFS(){return this.maxFS}getMaxFPS(){return this.maxFPS}getMaxMBPS(){return this.calculateMbps(this.maxFS,this.maxFPS)}calculateMbps(e,t){return pt(EN,e*t/100,!0)}resetToInitial(){this.maxFS=this.initialMaxFS,this.maxFPS=this.initialMaxFPS}fmtpParams(){return{"max-fs":this.getMaxFS(),"max-mbps":this.getMaxMBPS(),"max-fps":this.getMaxFPS()}}buildFmtp(){const e=[];let t=this.fmtpParams();return this.h264SubscribeProfile&&(t["profile-level-id"]=this.h264SubscribeProfile),e.push(t),this.isAv1Allowed&&(t=this.fmtpParams(),t.codec="AV1",e.push(t)),e}},IN=class e{constructor(e,t){this.entity=e,this.configProvider=t}static getVideoCababilities(e,t,i){if(e!==Qe.MEDIA_TYPE.video)return null;let n,r;t===Qe.MODALITY.sharing?(n=i.config.webrtcScreensharingCapabilityMaxFS,r=i.config.webrtcScreensharingCapabilityMaxFPS):(n=i.config.webrtcVideoCapabilityMaxFS,r=i.config.webrtcVideoCapabilityMaxFPS,i.config.useMultiviewLimitsOnInitialRequest&&i.config.multiviewResolutionLimits[1]&&(n=ZA.Send.getResolutionForHeight(i.config.multiviewResolutionLimits[1]).fs));const s=i.config.isAv1Allowed&&t===Qe.MODALITY.sharing;return new TN(n,r,s,i.config.h264SubscribeProfile)}static create(t,i,n){const r=function(e){switch(e){case Qe.MODALITY.audio:return Qe.MEDIA_TYPE.audio;case Qe.MODALITY.video:case Qe.MODALITY.sharing:return Qe.MEDIA_TYPE.video;case Qe.MODALITY.data:return Qe.MEDIA_TYPE.data;default:return null}}(i),s=new e({modality:i,mid:n,mtype:r,extensions:{}},t);return s.localRecvCapabilities=e.getVideoCababilities(r,i,t),s}clone(){const t=new e((0,_N.cloneDeep)(this.entity),this.configProvider);return t.setSimulcastContext(this.simulcastContext),t.localRecvCapabilities=this.localRecvCapabilities,t.remoteRecvCapabilities=this.remoteRecvCapabilities,t}getModality(){return this.entity.modality}getType(){return this.entity.mtype}getMid(){return this.entity.mid}disable(){this.entity.mid=null}update(t,i){this.entity.modality!==t&&(this.localRecvCapabilities=e.getVideoCababilities(this.entity.mtype,t,this.configProvider)),this.entity.modality=t,this.entity.mid=i,this.isEnabled()&&this.setExtension("rollback",!1)}isDisabled(){return!this.entity.mid}isEnabled(){return!!this.entity.mid}getLocalRecvCapabilities(){return this.localRecvCapabilities}getRemoteRecvCapabilities(){return{sourceId:this.getXSourceStreamId(),capabilities:this.remoteRecvCapabilities?[this.remoteRecvCapabilities]:[]}}setRemoteRecvCapabilities(e){this.remoteRecvCapabilities=e}getRemoteStreamId(){return this.entity.remoteStreamId}setRemoteStreamId(e){this.entity.remoteStreamId=e}setRemoteSsrc(e){this.entity.remoteSsrc=e}getRemoteSsrc(){return this.entity.remoteSsrc}setLocalSsrc(e){this.entity.localSsrc=e}getLocalSsrc(){return this.entity.localSsrc}getRemoteTrackId(){return this.entity.remoteTrackId}setRemoteTrackId(e){this.entity.remoteTrackId=e}getXSourceStreamId(){return this.entity.xSourceStreamId}setXSourceStreamId(e){this.entity.xSourceStreamId=e}setLocalTrackId(e){this.entity.localTrackId=e}getLocalTrackId(){return this.entity.localTrackId}setSubStreamIndex(e){this.entity.subStreamIndex=e}getSubstreamIndex(){return this.entity.subStreamIndex}getExtension(e){return this.entity.extensions[e]}setExtension(e,t){this.entity.extensions[e]=t}getRtpHeaderExtensions(){return this.entity.rtpExt}setRtpHeaderExtensions(e){this.entity.rtpExt=e}setSimulcastContext(e){this.simulcastContext=e}getSimulcastContext(){return this.simulcastContext}serialize(){return ct(this.entity)}},bN=class{constructor(e){this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.localSsrcs=new Map,this.ssrcGenerator=new qD,this.logger=e.logger.createChild("MM"),this.configProvider=e.configProvider,this.numVideoChannels=e.numVideoChannels}fromOffer(e,t){e.media.forEach((e=>{if(e.type===Qe.MEDIA_TYPE.audio)Qe.MODALITY.audio in t&&this.addMediaEntity(Qe.MODALITY.audio);else if(e.type===Qe.MEDIA_TYPE.video){if(Qe.MODALITY.video in t)for(let e=0;e<this.numVideoChannels;e++)this.addMediaEntity(Qe.MODALITY.video);Qe.MODALITY.sharing in t&&this.addMediaEntity(Qe.MODALITY.sharing)}else e.type===Qe.MEDIA_TYPE.data&&Qe.MODALITY.data in t&&this.addMediaEntity(Qe.MODALITY.data)}))}fromRemote(e,t){e.media.forEach(((e,i)=>{const n=$w(e);if(Ww(e)||!(n in t))this.mediaEntities[i]?this.mediaEntities[i].disable():this.addDisabledMediaEntity(n),this.mediaEntities[i].setRemoteStreamId(null),this.mediaEntities[i].setRemoteTrackId(null);else{if(this.mediaEntities[i]?this.mediaEntities[i].update(n,e.mid||this.generateMid(i)):this.addMediaEntity(n,e.mid||this.generateMid(i)),e.msid)this.mediaEntities[i].setRemoteStreamId(e.msid.split(" ")[0]),this.mediaEntities[i].setRemoteTrackId(e.msid.split(" ")[1]);else if(e.ssrcs){const t=e.ssrcs.find((e=>"msid"===e.attribute));t?(this.mediaEntities[i].setRemoteStreamId(t.value.split(" ")[0]),this.mediaEntities[i].setRemoteTrackId(t.value.split(" ")[1])):this.logger.safe.warn(`No ssrc msid for media of type ${e.type} with mid ${e.mid}`)}const t=e.xSourceStreamId||this.generateSourceStreamId(i);this.mediaEntities[i].setXSourceStreamId(t)}}))}isEmpty(){return 0===this.mediaEntities.length}addMediaEntity(e,t){this.createMediaEntity(e,t||this.generateMid(this.mediaEntities.length))}addDisabledMediaEntity(e){this.createMediaEntity(e)}getMediaEntities(){return this.mediaEntities}createMediaEntity(e,t){const i=IN.create(this.configProvider,e,t);return this.mediaEntities.push(i),i}getMediaEntity(e){return this.mediaEntities[e]}getMediaEntityByMid(e){return this.mediaEntities.find((t=>t.getMid()===e))}getMediaEntitiesByModality(e){return this.mediaEntities.filter((t=>t.getModality()===e))}getMediaEntityByRemoteStreamId(e){return this.mediaEntities.find((t=>t.getRemoteStreamId()===e))}getMediaEntityByLocalTrackId(e){return this.mediaEntities.find((t=>t.getLocalTrackId()===e))}getMediaEntityByXSourceStreamId(e){return this.mediaEntities.find((t=>t.getXSourceStreamId()===e))}reset(){this.mediaEntities=[]}syncModalities(e,t,i){this.disableModalities(t),i||(this.enableModalities(t),this.addModalities(t))}enableModalities(e){this.mediaEntities.forEach(((t,i)=>{t.getModality()in e&&t.isDisabled()&&t.update(t.getModality(),this.generateMid(i))}))}disableModalities(e){this.mediaEntities.forEach((t=>{t.getModality()in e||t.disable()}))}setRollbackUpdateHandler(e){}addModalities(e){const t={};this.mediaEntities.map((e=>e.getModality())).forEach((e=>{t[e]=!0}));for(const i in e)i in t||this.addMediaEntity(i)}setLocalTracksInfo(e){this.mediaTracks=e,this.updateLocalSsrc(this.mediaTracks)}getLocalTracksInfo(){return this.mediaTracks}getLocalSsrcs(){return this.localSsrcs}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((e=>e.setLocalTrackId(null))),this.mediaTracks.forEach((e=>{const t=this.getMediaEntitiesByModality(e.modality)[0];t?t.setLocalTrackId(e.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(e.modality)}`)})))}updateMediaEntitiesWithActivityState(e,t){}backup(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{this.mediaEntitiesBackup.push(e.clone())}))}commit(){this.mediaEntitiesBackup=[]}rollback(){this.mediaEntities=this.mediaEntitiesBackup}generateSourceStreamId(e){return e+10}generateMid(e){return`media_${e}`}updateLocalSsrc(e){e.forEach((e=>{if(!this.localSsrcs.get(e.modality)){const t=this.ssrcGenerator.nextVideoStreamSsrc().min;this.logger.safe.debug(`Ssrc updated for modality: ${e.modality}: ${t}`),this.localSsrcs.set(e.modality,t)}}))}},AN=f(ye()),RN=class{constructor(e,t,i,n,r){this.logger=e,this.RtcDescType=t,this.sessionDescription=i,this.negotiationQueue=n,this.mediaManager=r}dispose(){this.peerConnection=null}configure(e){this.peerConnection=e}renegotiateNow(){return this.renegotiate(null,!0)}renegotiate(e,t=!1,i="local"){if(!this.peerConnection)throw new Error("trying to renegotiate during empty peerConnection");const n="local"===i?this.createNegotiationTaskForHaveLocalOffer(e):this.createNegotiationTaskForHaveRemoteOffer(e);return t?(this.logger.safe.info(`forced ${i} renegotiation starting`),Promise.resolve(n())):this.negotiationQueue.add(n)}normalizeRemoteSdpSDES(e,t){if(t.media[0].crypto)e.media.forEach((e=>{delete e.fingerprint,delete e.setup,e.crypto=e.crypto.filter((e=>t.media[0].crypto.some((t=>t.id===e.id)))).slice(0,1)})),e.fingerprint&&delete e.fingerprint;else{const t=this.mediaManager.getMediaEntities().find((e=>void 0!==e.getExtension("setup")));e.media.forEach((e=>{const i=t?.getExtension("setup")||"actpass";"actpass"===e.setup&&(e.setup="active"===i?"passive":"active")}))}}normalizeRemoteSdpExtensions(e,t){e.media.forEach(((e,i)=>{const n=new Set(t.media[i].ext?.map((e=>e.value))||[]);e.ext=e.ext?.filter((e=>n.has(e.value)))}))}throwIfNoPeerConnection(){if(!this.peerConnection)throw this.logger.safe.warn("no peer connection present"),new Error("trying to renegotiate during empty peerConnection")}createNegotiationTaskForHaveLocalOffer(e){return()=>{let t=this.peerConnection.remoteDescription.sdp;const i=this.peerConnection.localDescription.sdp;this.logger.safe.info(`local renegotiation starting remoteSdp=${!!t} localSdp=${!!i}`);const n=AN.parse(t),r=AN.parse(i);this.normalizeRemoteSdpSDES(n,r),this.normalizeRemoteSdpExtensions(n,r),t=AN.write(n);let s=new this.RtcDescType({sdp:t,type:"answer"});return e&&e.forEach((e=>{s=e.modifyDescriptor(s)})),Promise.resolve().then((()=>(this.logger.safe.info("creating offer"),this.throwIfNoPeerConnection(),this.peerConnection.createOffer()))).then((e=>{this.throwIfNoPeerConnection();const t=this.sessionDescription.createLocalOffer(e.sdp),i=new this.RtcDescType({sdp:t.toLocal(),type:"offer"});return this.logger.safe.info("setting local description"),this.logger.unsafe.debug(`local description, sdp: ${i.sdp}`),this.peerConnection.setLocalDescription(i)})).then((()=>(this.throwIfNoPeerConnection(),this.logger.safe.info("setting remote description"),this.logger.unsafe.debug(`remote description, sdp: ${s.sdp}`),this.peerConnection.setRemoteDescription(s)))).then((e=>(this.logger.safe.debug("local renegotiation done"),e))).catch((e=>{throw this.logger.safe.error("local renegotiation failed: ",e.toString()),e}))}}createNegotiationTaskForHaveRemoteOffer(e){return this.logger.safe.info("createNegotiationTaskForRemote"),()=>(this.logger.safe.info("proceed with setting local sdp start"),Promise.resolve().then((()=>(this.logger.safe.info("creating answer"),this.throwIfNoPeerConnection(),this.peerConnection.createAnswer()))).then((e=>{this.logger.safe.info("applying answer"),this.throwIfNoPeerConnection();const t=this.sessionDescription.createLocalAnswer(e.sdp),i=new this.RtcDescType({sdp:t.toLocal(),type:"answer"});return this.logger.safe.info("setting [answer] local description"),this.logger.unsafe.debug(`[answer] local description, sdp: ${i.sdp}`),this.peerConnection.setLocalDescription(i)})).then((e=>(this.logger.safe.info("local answer for renegotiation is done"),e))).catch((e=>{throw this.logger.safe.error("local answer for renegotiation failed: ",e.toString()),e})))}},wN=15e3,PN=class{constructor(e,t,i){this.settings=e,this.listener=t,this.logger=i,this.lastSendBW=0,this.coolingDown=!1,this.cooldownTimer=null,this.cooldownEnd=0,this.active=!1,this.maxResolution=this.settings.maxResolution,this.settings.scalingEnabled?this.active=!0:this.logger.safe.info("Resolution management disabled: no resolution management for 1x1 calls")}dispose(){this.currentResolution=null,this.pendingResolution=null,this.maxResolution=null,this.listener=null,this.active=!1,clearTimeout(this.cooldownTimer),this.cooldownTimer=null,this.listener=null}setMaxResolution(e){const t=ZA.Send.getResolutionByFs(e);t!==this.maxResolution&&(this.logger.safe.info(`Setting max resolution: ${t}`),this.maxResolution=t,this.lastSendBW&&this.processEstimatedBandwidth(this.lastSendBW))}updateEstimatedSendBandwidth(e){e!==this.lastSendBW&&(this.logger.safe.debug(`Send BW: ${e}`),this.processEstimatedBandwidth(e))}resetCurrentResolution(){this.currentResolution=null}getCurrentResolution(){return this.currentResolution?.fs}setCurrentResolution(e){this.currentResolution=e}applyRes(e){this.pendingResolution=e,this.coolingDown&&(!this.currentResolution||e.fs>this.currentResolution.fs)||(this.coolingDown=!0,this.logger.safe.info(`Changing resolution to ${e}`),this.listener&&this.listener.onResolutionChanged(e.fs).then((t=>{t?(e===this.pendingResolution&&(this.pendingResolution=null),this.coolingDown&&!this.currentResolution&&(this.coolingDown=!1),this.currentResolution=e,this.cooldown()):(this.logger.safe.info("Unable to apply resolution at the moment"),this.cooldown(5e3))})).catch((e=>{this.logger.safe.error(`Error while applying new resolution: ${JSON.stringify(e)}`),this.pendingResolution=null})))}cooldown(e=wN){!this.active||this.coolingDown&&this.cooldownEnd-Date.now()>wN||(this.cooldownTimer&&clearTimeout(this.cooldownTimer),this.coolingDown=!0,this.cooldownEnd=Date.now()+wN,this.cooldownTimer=setTimeout((()=>{this.logger.safe.debug("Resolution changer cooled down"),this.coolingDown=!1,this.cooldownTimer=null,this.pendingResolution?this.proposeResolution(this.pendingResolution):this.processEstimatedBandwidth(this.lastSendBW)}),e))}proposeResolution(e){let t=e;this.maxResolution&&this.maxResolution.fs<t.fs&&(t=this.maxResolution),this.currentResolution&&t.fs===this.currentResolution.fs||this.applyRes(t)}processEstimatedBandwidth(e){const{lowRes:t,highRes:i}=ZA.Send.getResolutionForBitrate(e),n=e<this.lastSendBW?i:t;e<this.lastSendBW&&n&&this.currentResolution&&this.currentResolution.fs<n.fs||(n&&this.proposeResolution(n),this.lastSendBW=e)}};function MN(e,t){const i=1e3*((t.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(t.config.audioBandwidthInKbps||0)),n=e.transport?.selectedCandidatePair?.availableOutgoingBitrate??0;return Math.min(i,n)}var DN=class extends ze{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.lastReportedAgo=1/0,this._forceUpdate=!1}forceUpdate(){this._forceUpdate=!0}onBandwidthChanged(e){this._forceUpdate?this.updateBandwidth(e,"forceUpdate"):this.processEstimatedBandwidth(e)}processEstimatedBandwidth(e){if(this.lastReportedAgo++,!e||this.bandwidth===e)return;const t=this.configProvider.config.webrtcSendBandwidthIgnoredUpdateLimit,i=this.configProvider.config.webrtcSendBandwidthThreshold,n=this.lastReportedAgo===1/0,r=!t&&!i,s=t&&this.lastReportedAgo>=t,a=i&&Math.abs((e-this.bandwidth)/this.bandwidth)>=i;if(n||r||s||a){const t=+n|+r<<1|+s<<2|+a<<3,i=this.getUpdateReason(t);this.updateBandwidth(e,i)}}updateBandwidth(e,t){this.bandwidth=e,this.logger.safe.debug(`Updating send bandwidth: ${this.bandwidth}, reason: ${t}`),this.notifySendBandwidthChanged()}notifySendBandwidthChanged(){this._forceUpdate=!1,this.event("onSendBandwidthChanged").raise(this.bandwidth),this.lastReportedAgo=0}getUpdateReason(e){return 1&e?"firstReport":2&e?"throttlingDisabled":4&e?"noReportsForTooLong":8&e?"bigMovement":"none"}},ON=class{constructor(e,t,i,n,r,s,a){this.listener=e,this.statisticsGatherer=t,this.diagnostics=i,this.logger=n,this.configProvider=r,this.isSimulcastEnabled=a,this.serialQueue=new $A(this.logger),this.modality=Qe.MODALITY.video;const o=s.maxResolution?{maxFs:s.maxResolution.fs}:null;this.validator=new cR(this.logger.createChild("CapsValidator"),o),this.resolutionManager=new PN(s,this,this.logger.createChild("rm")),this.statisticsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e))),this.statisticsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e)))}async setMaxCapabilities(e,t){const i={modality:this.modality,causeId:e,capabilities:t,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(i),this.diagnostics?.onMaxCapabilitiesRequested(i),this.causeId=e;const n=this.validator.ensureValidity(t[0]);this.streamSenderParams={...t[0],...n},this.resolutionManager.setMaxResolution(this.streamSenderParams.maxFs),this.configProvider.mediaConfig.simulcastSessionEnabled&&await this.applyCapabilities(this.getParamsToApply())}resetCurrentResolution(){this.resolutionManager.resetCurrentResolution()}getCurrentResolution(){return this.resolutionManager.getCurrentResolution()}setCurrentResolution(e){this.resolutionManager.setCurrentResolution(e)}async onResolutionChanged(e){return this.applyCapabilities(this.getParamsToApply(e))}dispose(){this.resolutionManager.dispose(),this.resolutionManager=null}async applyCapabilities(e){return e?this.lastAppliedSenderParams===e?(this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}`),!0):(this.logger.safe.info(`Capabilities to apply: ${JSON.stringify(e)}`),this.lastAppliedSenderParams=e,this.listener.onReceiveCapabilitiesChanged(this.modality,this.causeId,[e])):(this.logger.safe.error("Send capabilities are not set. Cannot apply constraints"),!1)}getParamsToApply(e){if(!this.streamSenderParams)return null;const t=e||this.resolutionManager.getCurrentResolution();if(!t||this.streamSenderParams.maxFs<=t)return this.streamSenderParams;const i=ot(this.streamSenderParams);return i.maxFs=t,i}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.resolutionManager.updateEstimatedSendBandwidth(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){if(this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation){if(!e.video?.send?.length||!e.video.send[0])return;const t=MN(e.video.send[0],this.configProvider);this.resolutionManager.updateEstimatedSendBandwidth(t)}}};S([dw()],ON.prototype,"applyCapabilities",1);var kN=class{constructor(e,t,i,n,r){this.modality=e,this.listener=t,this.statisticsGatherer=i,this.diagnostics=n,this.isSimulcastEnabled=r}setMaxCapabilities(e,t){const i={modality:this.modality,causeId:e,capabilities:t,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(i),this.diagnostics?.onMaxCapabilitiesRequested(i),this.listener.onReceiveCapabilitiesChanged(this.modality,e,t)}dispose(){}resetCurrentResolution(){}getCurrentResolution(){return null}setCurrentResolution(e){}},NN=class{constructor(e,t,i,n,r,s){this.logger=e,this.settings=t,this.listener=i,this.statsGatherer=n,this.diagnostics=r,this.configProvider=s,this.mediaSourceModels=[],this.pendingCapabilities=new Map,this.statsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e))),this.statsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e)))}dispose(){this.mediaSourceModels.forEach((e=>{e.handler&&(e.handler.dispose(),e.handler=null)})),this.mediaSourceModels=null,this.sendBandwidthCalculator&&this.disableSendBandwidthCalculator()}updateRegisteredSources(e){this.logger.safe.info(`Local media params updated: ${JSON.stringify(e)}`);const t=[];this.mediaSourceModels.forEach((e=>t.push(e.sourceId)));const i=e.map((e=>e.sourceId)),n=St(t,i);this.removeSourcesWithIds(n);const r=St(i,t);this.addSourcesWithIds(r,e),this.settings.sendBandwidthNotificationsEnabled&&this.updateSendBandwidthCalculator()}setMaxCapabilities(e){for(const t of e){if(!t.capabilities.length)continue;if(!t.sourceId){this.logger.safe.info(`SourceId is not defined to apply recv capabilities: ${JSON.stringify(t)}`);continue}const e=this.getModelWithSourceId(t.sourceId);if(!e){this.logger.safe.info(`Model is not registered for sourceId: ${t.sourceId}`),this.configProvider.config.enableCachingFMTP&&this.pendingCapabilities.set(t.sourceId,t);continue}this.logger.safe.info(`Capabilities handler found for sourceId: ${t.sourceId}`);const i=this.getOrCreateHandlerForModel(e,t.isSimulcast);i?i.setMaxCapabilities(t.causeId,t.capabilities):this.logger.safe.info(`Handler is not found for sourceId: ${t.sourceId}`)}this.logger.safe.debug("Max capabilities application completed")}setPendingCapabilities(){if(!this.configProvider.config.enableCachingFMTP)return;this.logger.safe.info(`Apply pending capabilties for sources [${Array.from(this.pendingCapabilities.keys())}]`);const e=Array.from(this.pendingCapabilities.values());this.setMaxCapabilities(e),this.pendingCapabilities.clear()}clearPendingCapabilities(){this.pendingCapabilities.clear()}resetCurrentResolution(){const e=this.mediaSourceModels.find((e=>e.modality===Qe.MODALITY.video));e?.handler&&e.handler.resetCurrentResolution()}getCurrentResolution(){const e=this.mediaSourceModels.find((e=>e.modality===Qe.MODALITY.video));return e?.handler?e.handler.getCurrentResolution():this.currentResolution?.fs}setCurrentResolution(e){const t=this.mediaSourceModels.find((e=>e.modality===Qe.MODALITY.video));t?.handler?t.handler.setCurrentResolution(e):this.currentResolution=e}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.sendBandwidthCalculator.onBandwidthChanged(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){if(this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation){if(!e.video?.send?.length||!e.video?.send[0])return;const t=MN(e.video.send[0],this.configProvider);this.sendBandwidthCalculator.onBandwidthChanged(t)}}getOrCreateHandlerForModel(e,t){return e.handler||(e.handler=this.getCapabilitiesHandler(e.modality,t)),e.handler}addSourcesWithIds(e,t){e.forEach((e=>{const i=t.find((t=>t.sourceId===e));this.registerSource(e,i.modality)}))}removeSourcesWithIds(e){e.forEach((e=>this.unregisterSource(e)))}registerSource(e,t){this.logger.safe.info(`SourceId ${e} registered with mediaType: ${t}`),this.mediaSourceModels.push({modality:t,sourceId:e})}unregisterSource(e){const t=this.mediaSourceModels.find((t=>t.sourceId===e));t?(t.handler&&t.handler.dispose(),this.mediaSourceModels.splice(this.mediaSourceModels.indexOf(t),1),this.logger.safe.info(`SourceId ${e} unregistered`)):this.logger.safe.info(`Model doesn't exist with sourceId ${e}`)}updateSendBandwidthCalculator(){this.mediaSourceModels.some((e=>[Qe.MODALITY.video,Qe.MODALITY.sharing].indexOf(e.modality)>-1))?this.enableSendBandwidthCalculator():this.disableSendBandwidthCalculator()}enableSendBandwidthCalculator(){this.sendBandwidthCalculator||(this.sendBandwidthCalculator=new DN(this.configProvider,this.logger.createChild("SendBwCalc")),this.sendBandwidthCalculatorSubscription=this.sendBandwidthCalculator.on("onSendBandwidthChanged",(e=>this.onSendBandwidthChanged(e))))}disableSendBandwidthCalculator(){this.sendBandwidthCalculatorSubscription&&(this.sendBandwidthCalculatorSubscription.dispose(),this.sendBandwidthCalculatorSubscription=null),this.sendBandwidthCalculator&&(this.sendBandwidthCalculator.dispose(),this.sendBandwidthCalculator=null)}getModelWithSourceId(e){return this.mediaSourceModels.find((t=>t.sourceId===e))}getCapabilitiesHandler(e,t){if(e===Qe.MODALITY.audio)return null;if(e===Qe.MODALITY.video&&!t&&this.settings.customBwEstimationEnabled){const e=new ON(this.listener,this.statsGatherer,this.diagnostics,this.logger.createChild("ach"),this.configProvider,this.settings,t);return this.currentResolution&&e.setCurrentResolution(this.currentResolution),e}return new kN(e,this.listener,this.statsGatherer,this.diagnostics,t)}onSendBandwidthChanged(e){return this.listener.onSendBandwidthChanged(e).catch((e=>{this.logger.safe.error("Error while reporting send bandwidth change",e),this.sendBandwidthCalculator.forceUpdate()}))}},LN=class extends ze{constructor(e,t,i,n,r,s){super(e),this.logger=e,this.multiParty=t,this.configProvider=i,this.mediaManager=n,this.statsGatherer=r,this.diagnostics=s,this.rendererResolutions=new Map,this.rendererResolutionsApplied=new Map,this.rendererResolutionMax=new Map,this.hasPendingLimitResolutionUpdate=!1}addRenderer(e){this.rendererResolutions.set(e,{width:0,height:0}),e.on("onRendererSizeChanged",((e,t)=>{this.onRendererSizeChanged(e,t)})),this.scheduleUpdateLimitedResolutions()}removeRenderer(e){this.rendererResolutions.delete(e),this.rendererResolutionsApplied.delete(e),this.rendererResolutionMax.delete(e),this.scheduleUpdateLimitedResolutions()}clearRenderers(){this.rendererResolutions.clear(),this.rendererResolutionsApplied.clear(),this.rendererResolutionMax.clear()}getMaxAllowedVideoFS(){const e=this.getMaxHeightFromConfig(this.renderersCount);return this.getMaxFSForHeight(e)}limitResolutionOnPoorPerformance(e){const t=this.getRendererByMsi(e);if(!t)return;const i=t.resolution.height>t.resolution.width,n=ZA.Recv.getNextLowerResolution(t.resolution.width,t.resolution.height);if(!n)return void this.logger.safe.info("Poor perf. Lowest resolution reached. Not limiting resolution");const r={width:i?n.height:n.width,height:i?n.width:n.height};this.rendererResolutionMax.set(t.renderer,r),this.diagnostics?.registerResolutionChanageRequest({ts:Date.now(),msi:t.renderer.getMsi(),res:r}),this.logger.safe.info(`Poor perf. Limiting resolution for renderer msi: ${t.renderer.getMsi()} from ${t.resolution.height}p to ${r.height}p`),this.onRendererSizeChanged(t.renderer,r)}get renderersCount(){return this.rendererResolutions.size}getMaxFSForHeight(e){return this.limitMaxFS(ZA.Recv.getResolutionForHeight(e).fs)}getRendererByMsi(e){for(const[t,i]of this.rendererResolutions.entries())if(t.getMsi()===e)return{renderer:t,resolution:i};return null}applyRendererResolution(e,t){this.setMaxFSCapabilities(e,t),this.rendererResolutionsApplied.set(e,t);const i=e.getMediaStream()&&e.getMediaStream().getVideoTracks();i?.[0]&&this.statsGatherer.setPreferredResolution(i[0].id,t,e.getModality())}onRendererSizeChanged(e,t){this.rendererResolutions.set(e,t),this.scheduleUpdateLimitedResolutions()}scheduleUpdateLimitedResolutions(){this.hasPendingLimitResolutionUpdate||(this.hasPendingLimitResolutionUpdate=!0,window.setTimeout((()=>{this.hasPendingLimitResolutionUpdate=!1;const e=this.groupMaxRenderersResolutionsByMsi();this.logger.safe.info(`Updating resolution limits: renderers count ${this.renderersCount}`),this.spotlightedRenderer=this.findSpotlightedRenderer(),this.spotlightedRenderer&&this.logger.safe.info(`Spotlighted renderer: ${this.spotlightedRenderer.getMsi()}`);for(const[t,i]of this.rendererResolutions.entries()){if(!i.height)continue;const n=e.get(t.getMsi()),r=this.limitRendererResolution(t,n||i),s=this.rendererResolutionsApplied.get(t);(!s||s.height!==r.height||s.width!==r.width)&&this.applyRendererResolution(t,r)}}),this.configProvider.config.multiviewResolutionLimitUpdateThrottleDelay))}findSpotlightedRenderer(){if(1===this.renderersCount||!this.configProvider.config.isSpotlightEnabled)return;let e,t=0,i=0;for(const[n,r]of this.rendererResolutions.entries()){if(!r.height)continue;i++;const s=ZA.Recv.getMaxFS(r.width,r.height);s>t?(e=n,t=s):s===t&&(e=void 0)}return i<=1?void 0:e}getMaxHeightFromConfig(e,t=!1){return t?this.configProvider.config.maxSpotlightResolution:this.configProvider.config.multiviewResolutionLimits[`${e}`]||this.configProvider.config.multiviewResolutionLimits.more}getMaxHeight(e){const t=this.spotlightedRenderer?.getMsi()===e.getMsi();let i=this.getMaxHeightFromConfig(this.renderersCount,t);const n=this.rendererResolutionMax.get(e);return n&&(i=Math.min(i,Math.min(n.height,n.width))),i}limitRendererResolution(e,t){const i=this.getMaxHeight(e);if(!i)return t;if(t.height>t.width&&t.width>i){const e=i/t.width;return{height:Math.ceil(t.height*e),width:i,limited:!0}}if(t.width>t.height&&t.height>i){const e=i/t.height;return{height:i,width:Math.ceil(t.width*e),limited:!0}}return t}setMaxFSCapabilities(e,t){const i=e.getMediaStream();if(!i)return void this.logger.safe.warn("renderer has no stream attached");const n=this.mediaManager.getMediaEntityByRemoteStreamId(i.id);if(!n?.getLocalRecvCapabilities())return void this.logger.safe.warn(`no capabilities for provided modality: ${e.getModality()}`);const r=t.limited?this.getMaxFSForHeight(t.height):this.getMaxFS(t.width,t.height),s=n.getLocalRecvCapabilities();s.setMaxFS(r,(()=>{if(this.logger.safe.info(`updated max-fs video capability to ${r} for renderer msi: ${e.getMsi()}`),this.multiParty&&this.configProvider.config.webrtcMultiPartyRecvVideoSignaling){const t=e.getMsi(),n=s.buildFmtp();this.event("onSourceRequestRequired").raise(i.id,t,n)}else this.event("onNegotiationRequired").raise()}))}getMaxFS(e,t){return this.limitMaxFS(ZA.Recv.getMaxFS(e,t))}limitMaxFS(e){return this.multiParty?Math.min(e,this.configProvider.config.webrtcMultiPartyRecvVideoMaxFS):Math.min(e,this.configProvider.config.webrtcRecvVideoMaxFS)}groupMaxRenderersResolutionsByMsi(){const e=new Map;return this.rendererResolutions.forEach(((t,i)=>{const n=i.getMsi(),r=e.get(n);(!r||t.width>r.width&&t.height>r.height)&&e.set(n,t)})),e}},xN=class extends ze{constructor(e,t){super(),this.configProvider=e,this.getModality=t,this.isRendering=!1,this.currentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0}captureRawStatistics(e){const t=e.googFrameRateDecoded,i=e.googFrameRateReceived,n=e.bytesReceived;void 0!==n&&this.getModality()!==Qe.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateBitrate(n,t),t>0&&(this.mediaStarted=!0),0===t||0===i?this.currentFreezeDuration+=Qe.TIME_INTERVAL.SEC_1:t>0&&(void 0===i||i>0)&&(this.currentFreezeDuration=0);const r=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(r)}updateRenderingTracker(e){const t=e.extensions.frameRateDecoded||0,i=e.extensions.frameRateReceived||0,n=e.extensions.bitrate;void 0!==n&&this.getModality()!==Qe.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateLowBitrateDuration(n,t),t>0&&(this.mediaStarted=!0),0===t||0===i?this.currentFreezeDuration+=Qe.TIME_INTERVAL.SEC_1:t>0&&(void 0===i||i>0)&&(this.currentFreezeDuration=0);const r=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(r)}calculateLowBitrateDuration(e,t){e/1e3<this.configProvider.config.notRenderingLowBitrateThreshold&&t<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}calculateBitrate(e,t){const i=8*(e-this.lastBytesRecv);this.lastBytesRecv=e,this.calculateLowBitrateDuration(i,t)}setIsRendering(e){const t=this.currentFreezeDuration<e&&this.currentLowBitrateDuration<e&&this.mediaStarted;t!==this.isRendering&&(this.isRendering=t,this.event("onIsRenderingChanged").raise(this.isRendering))}},UN=class extends ze{constructor(e,t,i){super(),this.videoElement=e,this.configProvider=t,this.getTimeToFirstFrame=i,this.prevCurrentTime=0,this.prevDecodedFrameCount=0,this.prevTimestamp=Date.now(),this.currentFreezeDuration=0,this.freezeDurationTimer=window.setInterval((()=>{this.calcFreezeDurationMs()}),this.configProvider.config.freezeIntervalFrequency)}calcFreezeDurationMs(){const e=this.videoElement.currentTime,t=e===this.prevCurrentTime,i=this.videoElement.webkitDecodedFrameCount,n=void 0===i||i===this.prevDecodedFrameCount;if(this.prevCurrentTime=e,this.prevDecodedFrameCount=i,-1!==this.getTimeToFirstFrame())if(t&&n){const e=Date.now();this.currentFreezeDuration+=e-this.prevTimestamp,this.prevTimestamp=e}else{if(this.currentFreezeDuration>this.configProvider.config.freezeMinDuration){const e=this.calcFreeze();this.event("onFreezeEnded").raise(e)}this.currentFreezeDuration=0}this.prevTimestamp=Date.now()}getEndOfTheFreeze(){let e=0;return this.currentFreezeDuration>0&&(e=this.calcFreeze(),this.currentFreezeDuration=0),e}dispose(){const e=this.getEndOfTheFreeze();this.event("onFreezeEnded").raise(e),clearInterval(this.freezeDurationTimer)}calcFreeze(){const e=Date.now()-this.prevTimestamp;return this.currentFreezeDuration+e}},FN=class extends KA{constructor(e,t,i,n,r,s){super(r,e.createChild("remote"),t),this.diagnostics=i,this.subscriptionManager=n,this.sessionDiagnostics=s,this.disposed=!1,this.currentIsRendering=!1,this.startTimeTTFF=0,this.timeToFirstFrame=-1,this.isTimeToFirstFrameReported=!1,this.configProvider.config.freezeIntervalFrequency&&(this.freezeTracker=new UN(this.getVideoElement(),this.configProvider,(()=>this.timeToFirstFrame)),this.freezeTracker.on("onFreezeEnded",(e=>{this.diagnostics?.addFreezeDuration(e),this.event("onFreezeEnded").raise(e)}))),this.configProvider.config.isRenderingBasedOnRawStatistics&&(this.isRenderingTracker=new xN(this.configProvider,this.getModality.bind(this)),this.isRenderingChangedSubscription=this.isRenderingTracker.on("onIsRenderingChanged",(e=>{this.setIsRendering(e)}))),this.overlayStats=new qA(this.configProvider.config.showStatsInCall,r,this)}getEndOfTheFreeze(){return this.freezeTracker?.getEndOfTheFreeze()}resetTimeToFirstFrameFlag(){this.isTimeToFirstFrameReported=!1}setIsRendering(e){this.currentIsRendering!==e&&(this.currentIsRendering=e,this.captureIsRenderingEvent(e))}updateStatsOverlay(e){this.overlayStats.setStats(e)}updateIsRenderingTracker(e){this.isRenderingTracker?.updateRenderingTracker(e)}subscribeVideoAsync(e,t){return this.timeToFirstFrameSinceSubscriptionStart=Date.now(),new Promise(((i,n)=>{this.modality=t?Qe.MODALITY.sharing:Qe.MODALITY.video,this.diagnostics&&(this.diagnostics.msi=e,this.diagnostics.modality=this.modality),this.trackElementSizeChange(),this.unsubscribe(),this.sessionDiagnostics&&this.modality===Qe.MODALITY.video&&(this.on("onVideoSizeChanged",((t,i)=>{if(this.sessionDiagnostics.registerResolutionChanageEvent({ts:Date.now(),msi:e,res:{width:t,height:i}}),!this.isTimeToFirstFrameReported){if(-1===this.timeToFirstFrame){const e=Date.now();this.timeToFirstFrame=e-this.startTimeTTFF,this.timeToFirstFrameSinceSubscriptionStart=Date.now()-this.timeToFirstFrameSinceSubscriptionStart}const e=this.getTrackId();e&&(this.diagnostics.timeToFirstFrameSinceSubscriptionStart=this.timeToFirstFrameSinceSubscriptionStart,this.diagnostics.timeToFirstFrame=this.timeToFirstFrame,this.sizeTracker?.triggerVideoElementSizeChange(),this.event("onVideoStarted").raise(this.timeToFirstFrame,this.timeToFirstFrameSinceSubscriptionStart,e),this.isTimeToFirstFrameReported=!0)}})),this.on("onVideoRendererStateChanged",(e=>{this.diagnostics.addStateChange(e)})));const r=this.subscriptionManager.subscribeVideo(this.modality,e);this.subscription=r,this.logger.safe.info(`subscribing renderer to type: ${r.modality} msi: ${r.msi}`),r.setOnMediaStreamChangedHandler((e=>{const t=this.getMediaStream();this.attachMediaStream(e),e&&(this.startTimeTTFF=Date.now());const n=this.getTrackId();n&&this.diagnostics&&(this.diagnostics.trackId=n),this.logger.safe.info(`subscribed renderer to type: ${r.modality} msi: ${r.msi} on stream #${e?e.id:"none"}`),e&&t!==e&&this.sizeTracker?.triggerVideoElementSizeChange(),i()})),r.setOnErrorHandler((t=>{this.logger.safe.error(`failed to subscribe renderer ${Ve(t)}`),"webRtcSession cleanup"===JSON.stringify(t)&&(this.logger.safe.info(`Retry to subscribe to video stream with msi: ${e}. Previous session was cleaned up`),this.subscriptionManager.streamChangedByMsi(e),i()),n(t)}))}))}dispose(){this.disposed?this.logger.safe.warn("renderer already disposed"):(this.disposed=!0,this.logger.safe.info("disposing"),this.unsubscribe(),this.captureIsRenderingEvent(!1),this.freezeTracker?.dispose(),this.isRenderingChangedSubscription?.dispose(),this.overlayStats.dispose(),this.diagnostics?.dispose(),this.event("onRendererDisposed").raise(this),super.dispose())}getModality(){return this.modality}getMsi(){return this.subscription?.msi??WD.SourceNone}getLocalMsi(){return this.subscription?.localMsi}getCurrentResolution(){return this.resolution??{width:0,height:0}}unsubscribeNow(){this.subscription?.unsubscribe(),this.subscription=null}trackElementSizeChange(){const e=this.modality===Qe.MODALITY.sharing,t=e?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMin:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,i=e?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMax:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax;t&&i?(this.sizeTracker=new eR(this.getVideoElement(),t,i,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged()))):this.logger.safe.info("skipping video size tracking")}onSizeTrackerChanged(){this.resolution={width:this.sizeTracker.width,height:this.sizeTracker.height},this.logger.safe.info(`video renderer size changed to ${this.resolution.width}x${this.resolution.height}`),this.diagnostics&&(this.diagnostics.rendererSize=this.resolution),this.event("onRendererSizeChanged").raise(this,this.resolution)}unsubscribe(){this.subscription?.dispose(),this.subscription=null}captureIsRenderingEvent(e){this.diagnostics&&(this.diagnostics.isRendering=e),this.event("onIsRenderingChanged").raise(e,this.getModality(),this.getTrackId())}},VN=class{constructor(e,t,i,n,r,s){this.logger=e,this.configProvider=t,this.statsGatherer=i,this.sessionDiagnostics=n,this.remoteVideoResolutionManager=r,this.domOverrides=s,this.remoteRendererSubscriptions=new Map,this.diagnostics=n?.newRemoteVideoManagerDiagnostics()}createRenderer(e,t,i){const n=new FN((i??this.logger).createChild("videorenderer"),this.configProvider,this.diagnostics?.newRendererDiagnostics(),t,e,this.sessionDiagnostics);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(n.getVideoElement()),this.addRenderer(n),n}moveRenderers(e){this.renderers.forEach((t=>{t.resetTimeToFirstFrameFlag(),e.addRenderer(t),this.removeRenderer(t)}))}getMaxAllowedVideoFS(){return this.remoteVideoResolutionManager.getMaxAllowedVideoFS()}dispose(){this.renderers.forEach((e=>e.resetTimeToFirstFrameFlag())),this.renderers.forEach((e=>{const t=e.getTrackId(),i=e.getEndOfTheFreeze();this.statsGatherer.setFreezeDuration(i,t)})),this.remoteRendererSubscriptions.forEach(((e,t)=>{t.dispose(),e.forEach((e=>e.dispose()))})),this.remoteRendererSubscriptions.clear(),this.remoteVideoResolutionManager.clearRenderers()}processStatsReport(e){this.configProvider.config.isRenderingBasedOnRawStatistics&&this.onDiagnosticUpdated(e),this.updateOverlayStats(e)}processLegacyStats(e){this.configProvider.config.isRenderingBasedOnRawStatistics||this.renderers.forEach((t=>{const i=t.getTrackId();if(e.remoteVideoStreams[i]){const n=e.remoteVideoStreams[i].isRendering;void 0!==n&&t.setIsRendering(n)}}))}playVideo(){this.renderers.forEach((e=>e.playVideo()))}get renderers(){return Array.from(this.remoteRendererSubscriptions,(([e])=>e))}addRenderer(e){this.remoteRendererSubscriptions.set(e,this.subscribeOnEvents(e)),this.logger.safe.info("Added renderer to manager"),this.remoteVideoResolutionManager.addRenderer(e)}generateVideoRecvStats(e){const t=new Map,i=e=>{e?.forEach((e=>{const i=e.track?.trackIdentifier??e.inboundRTP.trackIdentifier;t.set(i,e)}))};return i(e.sharing?.recv),i(e.video?.recv),t}updateOverlayStats(e){const t=this.generateVideoRecvStats(e);this.renderers.forEach((e=>{const i=e.getTrackId();t.has(i)&&e.updateStatsOverlay(t.get(i))}))}onDiagnosticUpdated(e){const t=[...e.video?.recv??[],...e.sharing?.recv??[]];if(t.length){const e=new Map;t.forEach((t=>{e.set(t.track?.trackIdentifier,t)})),this.renderers.forEach((t=>{const i=t.getTrackId();e.has(i)&&t.updateIsRenderingTracker(e.get(i))}))}}subscribeOnEvents(e){return[e.on("onRendererDisposed",(e=>this.onRendererDisposed(e))),e.on("onVideoStarted",((e,t,i)=>this.onVideoStarted(e,t,i))),e.on("onFreezeEnded",(t=>{const i=e.getTrackId();this.statsGatherer.setFreezeDuration(t,i)})),e.on("onIsRenderingChanged",((e,t,i)=>this.statsGatherer.setIsRendering(e,t,i)))]}onRendererDisposed(e){this.logger.safe.debug("Renderer removed from manager"),this.removeRenderer(e),this.domOverrides.onMediaElementRemoved&&this.domOverrides.onMediaElementRemoved(e.getVideoElement())}removeRenderer(e){this.remoteRendererSubscriptions.get(e).forEach((e=>e.dispose())),this.remoteRendererSubscriptions.delete(e),this.remoteVideoResolutionManager.removeRenderer(e)}onVideoStarted(e,t,i){this.statsGatherer.setTimeToFirstFrame(e,t,i)}},BN=class extends ze{constructor(e,t,i){super(),this.configProvider=t,this.callDeviceManager=i,this.lastFramerateInput=-1,this.trackInfo=[],this.timeoutId=null,this.logger=e.createChild("localStreamWatcher"),this.callDeviceManagerSub=i.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, updating subscriptions"),this.handleDeviceManagerChange()}))}get effectsManager(){return this.callDeviceManager.getDeviceManager("Video").effectsManager}startWatching(e){this.configProvider.config.videoCaptureFreezeTimeout&&(this.trackInfo=e,this.videoEffectManagerSubscription||(this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(e=>this.onVideoFreezeDetected(e)))))}stopWatching(){this.trackInfo=[],this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=null,0!==this.lastFramerateInput||this.timeoutId||this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")),this.disposeTimer(),this.lastFramerateInput=-1}dispose(e){this.callDeviceManagerSub?.dispose(),super.dispose(e),this.stopWatching()}onDiagnosticUpdated(e){if(!this.trackInfo.length||!e.video?.send?.length)return;const t=e.video?.send[0];let i,n=0;[t,...t.altLayouts??[]].forEach((e=>{const t=e.mediaSource,r=t?.framesPerSecond??0;this.trackInfo.some((e=>e.trackId===t.trackIdentifier))&&(!i||n<r)&&(i=t,n=r)})),i?n!==this.lastFramerateInput&&(0===n?this.scheduleCaptureFreezeStart(i.trackIdentifier,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${i.trackIdentifier}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=n):this.logger.safe.warn("WebRTC Stats for send video not found")}onStatisticsChanged(e){if(!this.trackInfo.length)return;let t;Object.keys(e.localVideoStreams).forEach((i=>{const n=e.localVideoStreams[i];this.trackInfo.some((e=>e.trackId===n.trackId))&&(!t||t.frameRateInput<n.frameRateInput)&&(t=n)})),t?t.frameRateInput!==this.lastFramerateInput&&(0===t.frameRateInput?this.scheduleCaptureFreezeStart(t.trackId,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${t.trackId}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=t.frameRateInput):this.logger.safe.warn("WebRTC Stats for send video not found")}onVideoFreezeDetected(e){this.logger.info(`onVideoCaptureFreeze, webcam freeze detected trackId: ${e}`),this.event("onVideoCaptureFreeze").raise(!1,!0)}scheduleCaptureFreezeStart(e,t){this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,this.logger.info(`onVideoCaptureFreeze start for trackId: ${e}`),this.event("onVideoCaptureFreeze").raise(!0,t)}),this.configProvider.config.videoCaptureFreezeTimeout)}disposeTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handleDeviceManagerChange(){this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(e=>this.onVideoFreezeDetected(e)))}},HN=class{constructor(e,t,i,n,r,s,a){this.mediaStream=e,this.receiver=t,this.modality=i,this.sourceStreamId=n,this.controller=r,this.videoCapabilties=s,this.getMaxAllowedVideoFS=a,this.msi=WD.SourceNone,this.operations=Promise.resolve()}dispose(){this.receiver=null,this.mediaStream=null}getId(){return this.mediaStream.id}getModality(){return this.modality}getMsi(){return this.msi}getMediaStream(){return this.mediaStream}getReceiver(){return this.receiver}getSourceStreamId(){return this.sourceStreamId}requestSource(e){this.msi=e;const t=this.operations.then((()=>{let t;return this.videoCapabilties&&(this.videoCapabilties.resetToInitial(),this.getMaxAllowedVideoFS&&this.videoCapabilties.setMaxFS(Math.min(this.getMaxAllowedVideoFS(),this.videoCapabilties.getMaxFS())),t=this.videoCapabilties.buildFmtp(),this.videoCapabilties.resetToInitial()),this.controller.requestSource(this.mediaStream.id,e,t)}));return this.operations=t.catch((()=>{})),t}},$N=class{constructor(e){this.queue=[],this.logger=e}cleanup(){this.queue.forEach((e=>{e.reject({notSent:e.tones})})),this.queue=[]}waitForNotification(e){return e?(this.logger.unsafe.info("sending dtmf tones: ",e),new Promise(((t,i)=>{this.queue.push({tones:e,resolve:t,reject:i})}))):Promise.reject(new Error("invalid input"))}toneSent(e){this.queue[0]&&(e===this.queue[0].tones[0]?(this.queue[0].tones=this.queue[0].tones.substr(1),""===this.queue[0].tones&&(this.queue[0].resolve(),this.queue.shift())):(this.queue[0].reject(new Error(`sent tone does not match: expected '${this.queue[0].tones[0]}' got '${e}'`)),this.queue.shift(),this.toneSent(e)))}},GN=class{constructor(e){this.webRtcSender=null,this.configProvider=e.configProvider,this.queue=new $N(e.logger)}sendDtmf(e,t){return e&&e.getSenders?(this.syncSender(e),this.webRtcSender?(this.webRtcSender.ontonechange=this.onToneChange.bind(this),this.webRtcSender.insertDTMF(this.webRtcSender.toneBuffer+t,this.configProvider.config.dtmf.toneDuration,this.configProvider.config.dtmf.toneGap),this.queue.waitForNotification(t)):Promise.reject(new Error("not available"))):Promise.reject(new Error("bad peerConnection"))}canSendDtmf(e){return!(!e||!e.getSenders)&&(this.syncSender(e),!!this.webRtcSender&&this.webRtcSender.canInsertDTMF)}dispose(){this.queue.cleanup()}syncSender(e){const t=e.getSenders().filter((e=>e.track&&"audio"===e.track.kind)).filter((e=>e.dtmf&&e.dtmf.canInsertDTMF))[0];this.webRtcSender&&t&&t.dtmf!==this.webRtcSender&&(this.webRtcSender.ontonechange=null,this.queue.cleanup()),this.webRtcSender=t?t.dtmf:null}onToneChange(e){e.tone&&this.queue.toneSent(e.tone)}},jN=e=>new GN(e),qN=0,WN=class e{constructor(e,t,i){this.context=e,this.callId=t,this.callback=i,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc-"+ ++qN),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.webrtcAdapter=vN({global:this.context.maContext,configProvider:this.configProvider}),this.iceHostCandidateOnly=this.multiParty&&ft("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new bN({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:!1}),this.sessionDescription=EM.build({sdpTransform:new this.webrtcAdapter.SdpTransform(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=ft("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new zD({streamAdded:e=>this.streamAdded(e),streamRemoved:e=>this.streamRemoved(e)}),this.stats=new Jk(this.logger.createChild("stats"),this.configProvider,void 0,this.mediaManager,this.multiParty),this.maxResolution=this.multiParty?ZA.Send.getResolutionByFs(this.configProvider.config.webrtcMultipartyMaxScalingFs):ZA.Send.getResolutionByFs(this.configProvider.config.webrtcMaxScalingFs),this.qualityManager=new NN(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,cooldownTimeout:this.configProvider.config.webrtcResolutionManagerCooldownTimeout,retryDelay:this.configProvider.config.webrtcResolutionManagerRetryDelay,maxResolution:this.maxResolution,customBwEstimationEnabled:!0,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},{onReceiveCapabilitiesChanged:(e,t,i)=>this.applyCapabilitiesForModality(e,t,i),onSendBandwidthChanged:e=>this.onSendBandwidthChanged(e)},this.stats,void 0,this.configProvider),this.localVideoStreamWatcher=new BN(this.logger,this.configProvider,this.context.callDeviceManager),this.activeSpeakerManager=new GD(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,null,this.logger.createChild("ActiveSpeakerManager")),this.senders={},this.negotiationQueue=new $A(this.logger),this.negotiationEmulator=new RN(this.logger.createChild("negotiationEmulator"),this.webrtcAdapter.RTCSessionDescription,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.toBeCalledAfterConnected=[],this.iceTransportPolicy=this.configProvider.config.iceTransportPolicyForced||this.context.config.iceTransportPolicy||Qe.ICE_TRANSPORT_POLICY.all,this.isMuteHold=!1,this.peerConnection=null,this.mediaStreams=new Map,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Yu,this.relayCandidateGathered=!1,this.iceCandidatesTimer=null,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=jN({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=ft("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new YD(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:e=>this.onStreamsChanged(e)}),this.remoteVideoResolutionManager=new LN(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.stats),this.remoteVideoManager=new VN(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.stats,void 0,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Yu,this.ssrcGenerator=new qD,this.ssrcs={Audio:this.getSsrcRangeForMediaType("Audio"),Video:this.getSsrcRangeForMediaType("Video"),ScreenShare:this.getSsrcRangeForMediaType("ScreenShare")},this.forceKeyFramePromise=null,this.ufdManager=e.getUfdManager(),this.stats.on("onStatisticsChanged",(e=>{this.remoteVideoManager.processLegacyStats(e),this.localVideoStreamWatcher?.onStatisticsChanged(e),this.updateQualityLevels(e)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((e,t,i)=>this.requestSource(e,t,i))),this.setSubsForSubscriptionManager(),this.localVideoStreamWatcher.on("onVideoCaptureFreeze",(e=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",e?"Bad":"Good","Video")})),this.configProvider.mediaConfig.maxBandwidthInKbps&&this.stats.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.createAudioRenderer(),this.configProvider.config.webrtcVideoScaling&&this.onOptimalVideoReceiversCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount)}get audioStream(){return this.mediaStreams.get("Audio")}get videoStream(){return this.mediaStreams.get("Video")}get displayStream(){return this.mediaStreams.get("ScreenShare")}useNullAudioStreamClient(){}getIncomingRawAudioStream(){return null}configureSpatialAudio(e,t){}setParticipantSpatialAudioPositions(e,t){}getAcceptedTypes(){return this.allowedMediaContentType}clone(t=!1){const i=ot(this.context);i.config=ot(this.context.config),i.config.webrtcMediaContentType=this.mediaContentType,i.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,t?i.config.isConference=!0:(i.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(i.config.webrtcIceGatheringTimeoutIncreased=!0));const n=new e(i,this.callId,this.callback);return this.relayManagerProvider&&(n.relayManagerProvider=this.relayManagerProvider),n.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,n}setInternals(e){if(e.extensionsManager&&this.extensionsManager){const t=e.extensionsManager.getExtension("videoStreamControl");t&&t.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",t.getOptions())}e.subscriptionManager&&(this.subscriptionManager&&this.subscriptionManager.dispose(),this.subscriptionManager=e.subscriptionManager,this.subscriptionManager.setStreamProvider({getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:e=>this.onStreamsChanged(e)}),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),e.audioRenderer&&(e.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=e.audioRenderer),e.remoteVideoManager&&e.remoteVideoManager.moveRenderers(this.remoteVideoManager)}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(e=>this.stats.setSubscribedTrackIds(e))),this.subscriptionManager.on("onTrackSsrcChanged",(e=>this.stats.setSubscribedTrackSsrc(e))),this.subscriptionManager.on("onSubscriptionChanged",((e,t,i,n,r,s)=>this.stats.addSubscriptionEvent(e,t,i,n,null,r,s))),this.subscriptionManager.on("onSubscriptionFailed",((e,t,i,n,r)=>this.stats.addSubscriptionEvent(e,t,i,n,r)))]}move(e,t){e.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager}),e.muteHold(this.isMuteHold,t),this.doAudioMute?e.muteInputAsync(t):e.unmuteInputAsync(t),this.subscriptionManager=null,this.audioRenderer=null,this.callbacks.onTerminated=null}setMute(e,t,i){this.logger.safe.info(`[${i}] call setMuteAsync with mute state ${t}, audio stream exists: ${!!this.audioStream}`),"Audio"===e&&this.audioStream?this.audioStream.setMuted(t,i):"Video"===e&&this.videoStream?this.videoStream.setMuted(t,i):"ScreenShare"===e&&this.displayStream&&this.displayStream.setMuted(t,i),this.updateQualityLevels(this.stats.getLastStatistics())}setCallConstraints(e,t){return Promise.reject(new Error("Not supported"))}configureModalitiesAsync(e,t){const i=this.configuredModalitiesPromise.then((()=>{if(!e||!e.audio&&!e.video&&!e.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(e)}`);const i=!this.configuredModalities||!em(e,this.negotiatedModalities);return this.configuredModalities=e,this.logger.safe.info(`[${t}] configure modalities`,`audio: ${e.audio}`,`video: ${e.video}`,`sharing: ${e.sharing}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?this.peerConnection.signalingState:"-"}`,`needNewRenegotiation: ${i}`),i&&this.triggerRenegotiation(!1,t),this.configuredModalities}));return this.configuredModalitiesPromise=i.catch((e=>{this.logger.safe.warn(`[${t}] Error during configuring modalities: ${Ve(e)}`)})).then((()=>{})),i.then((()=>{}))}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}getSubscriptionManager(){return null}createAudioElement(e){}createOfferAsync(e){const t=this.negotiationQueue.add((()=>new Promise((t=>{this.logger.safe.info(`[${e}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,this.offeredModalities=this.negotiatingModalities,this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[Qe.MODALITY.data]&&this.multiParty&&(this.offeredModalities[Qe.MODALITY.data]=Qe.MEDIA_STATE.inactive),Yp(this.offeredModalities)&&!st(this.negotiatedModalities)&&Object.keys(this.offeredModalities).forEach((e=>{void 0===this.negotiatedModalities[e]&&delete this.offeredModalities[e]})),t(this.updatePeerConnectionStreamsAsync(this.offeredModalities,!0,!0,e).then((()=>{const t=this.createNegotiationConstraints(this.offeredModalities);return this.logger.safe.info(`[${e}] create [offer] offered: ${JSON.stringify(this.offeredModalities)} constraints: ${JSON.stringify(t)}`),this.peerConnection.createOffer(t)})).then((t=>{this.logger.unsafe.debug(`[${e}] create [offer] offer from peer connection`,"sdp:",t.sdp);const i=this.sessionDescription.createLocalOffer(t.sdp);this.hasIceCandidates(i)||this.resetCandidateGathering(e),this.stats.startWaitingForStreamStart(this.offeredModalities);const n=new this.webrtcAdapter.RTCSessionDescription({sdp:i.toLocal(),type:"offer"});return this.setupIceGatheringTimeout(e),Promise.all([this.peerConnection.setLocalDescription(n),this.iceCandidatesDeferred.promise])})).then((()=>{const t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);t.updateModalities(this.offeredModalities),this.checkIceCandidates(t);const i=t.toOffer();this.logger.unsafe.debug("CREATE OFFER","sdp:",i);const n={blob:i,contentType:this.mediaContentType};return""===this.configProvider.config.webrtcRequiredFeatures||this.multiParty||(n.requiredFeatures=this.configProvider.config.webrtcRequiredFeatures),this.configProvider.countryCode&&(n.clientLocation=this.configProvider.countryCode),this.doRetargetIfNeeded(n,t,e),n})))}))),e);return this.resetNegotiationQueue(e),t}processOfferAsync(e,t){const i=this.negotiationQueue.add((()=>new Promise((i=>{const n=e.blob;if(this.logger.unsafe.debug(`[${t}] process [offer]`,"sdp:",n),this.configProvider.config.webrtcCompareContentTypeInOffer&&(ut(e.contentType,this.allowedMediaContentType),this.mediaContentType=e.contentType),e.requiredFeatures){const t=this.configProvider.config.webrtcRejectedFeatures.split(",");gt(e.requiredFeatures.split(","),t)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(n),this.canTriggerRenegotiation=!1,this.offeredModalities=qp(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let r=Promise.resolve(this.offeredModalities);if(zp(this.offeredModalities.video)||Jp(this.offeredModalities.video)||zp(this.offeredModalities.sharing)||Jp(this.offeredModalities.sharing)){const e=this.offeredDescription.getVideoCodecs();r=this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((i=>{if(!i.codecs.some((t=>e.some((e=>t.mimeType===e))))){this.logger.safe.warn(`[${t}] offer doesn't contain any supported video codecs`);const e=ot(this.offeredModalities);return this.disabledModalities.video=e.video,this.disabledModalities.sharing=e.sharing,e.video=void 0,e.sharing=void 0,e}return this.offeredModalities})).catch((e=>(this.logger.safe.error(`[${t}] failed to get video capability ${Ve(e)}`),this.offeredModalities)))}i(r.then((e=>(this.logger.safe.info(`[${t}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(e)}`),e))))}))),t);return this.resetNegotiationQueue(t),i}createAnswerAsync(e,t){return new Promise((i=>{if(e)return void i({blob:"",contentType:this.mediaContentType});this.logger.safe.info(`[${t}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for"),this.negotiatingModalities=this.configuredModalities;let n=Qp(this.offeredModalities,this.negotiatingModalities);const r=this.offeredDescription.clone();i(this.updatePeerConnectionStreamsAsync(n,!0,!1,t).then((()=>this.handleCodecSwitchUnsupported(t))).then((()=>{const e=this.offeredDescription.toRemote(n);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources();const i=new this.webrtcAdapter.RTCSessionDescription({sdp:e,type:"offer"});return this.updateDescriptor(i,r),this.logger.unsafe.info(`[${t}] create [answer] set remote description`,"negotiated:",n,"sdp:",i.sdp),this.peerConnection.setRemoteDescription(i)})).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.updatePeerConnectionStreamsAsync(n,!1,!0,t)))).then((()=>(this.handleSharingRecvCapabilities(r),this.handleVideoRecvCapabilities(r)))).then((()=>this.peerConnection.createAnswer())).then((e=>{this.logger.unsafe.debug(`[${t}] create [answer] answer from peer connection`,"sdp:",e.sdp);const i=this.sessionDescription.createLocalAnswer(e.sdp);this.hasIceCandidates(i)||this.resetCandidateGathering(t),this.stats.startWaitingForStreamStart(n);const r=new this.webrtcAdapter.RTCSessionDescription({sdp:i.toLocal(),type:"answer"});return this.setupIceGatheringTimeout(t),Promise.all([this.peerConnection.setLocalDescription(r),this.iceCandidatesDeferred.promise])})).then((()=>{const e=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);e.updateModalities(n),this.checkIceCandidates(e);const i=e.toAnswer();n=e.getModalities(),Zp(this.configuredModalities,this.negotiatingModalities,n)||this.triggerRenegotiation(!0,t),this.setNegotiatedModalities(n),this.stats.sessionInfo.setBweType(e.getBweType()),this.logger.unsafe.debug("CREATE ANSWER","sdp:",i);const r={blob:i,contentType:this.mediaContentType};return this.configProvider.countryCode&&(r.clientLocation=this.configProvider.countryCode),r})))}))}processAnswerAsync(e,t,i){const n=e.blob;if(this.logger.unsafe.debug(i?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",n),i)return this.logger.safe.info(`[${t}] process [pranswer] ignored`),Promise.resolve();this.mediaContentType=e.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType);const r=this.sessionDescription.createRemoteAnswer(n),s=r.clone(),a=qp(r.getModalities());this.setNegotiatedModalities(a);const o=r.toRemote(this.negotiatedModalities);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources(),this.stats.sessionInfo.setBweType(r.getBweType());const c=new this.webrtcAdapter.RTCSessionDescription({sdp:o,type:"answer"});return this.updateDescriptor(c,s),this.logger.unsafe.info(`[${t}] process [answer] set remote description`,"negotiated:",this.negotiatedModalities,"sdp:",c.sdp),this.peerConnection.setRemoteDescription(c).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.negotiatedModalities))).then((()=>(this.handleSharingRecvCapabilities(s),this.handleVideoRecvCapabilities(s)))).then((e=>{e&&this.triggerRenegotiation(!0,t)}))}completeNegotiationAsync(e){return new Promise((t=>{this.mediaManager.commit();const i=this.configuredModalities,n=this.forceMediaStreamUpdate&&!Yp(this.negotiatedModalities)||!Zp(i,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,r=!n;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${e}] negotiation completed isComplete: ${r} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),n&&this.triggerRenegotiation(!1,e),this.negotiationCompletedPromise.resolve(),t({isComplete:r,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})}))}rejectNegotiationAsync(e,t,i=!1){return Promise.resolve().then((()=>{if(this.mediaManager.rollback(),this.logger.safe.warn(`[${t}] negotiation rejected isComplete: ${!i} error: ${Ve(e)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.peerConnection){if("have-local-offer"===this.peerConnection.signalingState)return this.logger.safe.info(`[${t}] rolling back local description`),this.configProvider.config.webrtcHandleRollback?(this.logger.safe.info(`[${t}] rolling back using local renegotiation`),this.negotiationEmulator.renegotiateNow().then((()=>{this.logger.safe.info(`[${t}] rolling back using local complete`)}))):this.peerConnection.setLocalDescription(new this.webrtcAdapter.RTCSessionDescription({type:"rollback"}));this.logger.safe.error(`[${t}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`)}})).then((()=>{this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),this.getAddedMediaTypes(this.negotiatedModalities,this.negotiatingModalities).forEach((e=>{this.removeTrackByMediaType(e),this.disposeStreamByMediaType(e)})),this.registerLocalStreams()})).then((()=>(i&&(this.logger.safe.info(`[${t}] retrying failed negotiation`),this.triggerRenegotiation(!1,t)),{isComplete:!i,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})))}startMediaDescriptionsUpdateAsync(e){return Promise.reject(new Error("Not supported"))}completeMediaDescriptionsUpdateAsync(e){return Promise.reject(new Error("Not supported"))}rejectMediaDescriptionsUpdateAsync(e,t){return Promise.reject(new Error("Not supported"))}createRemoteRenderer(e){return this.remoteVideoManager.createRenderer(e,this.subscriptionManager,this.logger)}getStatsAsync(e){return this.terminated||(this.statisticsReport=this.statisticsReport.then((()=>this.stats.getReport(e))).catch((e=>(this.logger.safe.error(`getting statistics should never fail: ${e.error}`),e.partialReport)))),this.statisticsReport}getLastKnownStats(e=!1){return this.stats.getReport(!1,e)}muteHold(e,t){this.isMuteHold=e;const i=[Qe.MODALITY.audio,Qe.MODALITY.video,Qe.MODALITY.sharing].filter((e=>zp(this.negotiatedModalities[e])&&(e!==Qe.MODALITY.audio||!this.doAudioMute)));for(const n of i)this.setMute(cm(n),e,t)}async muteInputAsync(e){this.doAudioMute=!0,this.setMute("Audio",!0,e)}async unmuteInputAsync(e){this.doAudioMute=!1,this.setMute("Audio",!1,e)}muteOutputAsync(e){return this.audioRenderer.setMuted(!0,e),Promise.resolve()}unmuteOutputAsync(e){return this.audioRenderer.setMuted(!1,e),Promise.resolve()}sendDtmf(e){return this.dtmfSender.sendDtmf(this.peerConnection,e)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(e=Te()){const t=new Yu;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(t,e)})),t}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(e){this.stats.onDeviceEvent(e)}deviceSelectionChanged(){this.peerConnection&&(this.audioRenderer&&this.audioRenderer.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),Yp(this.negotiatedModalities)||(this.forceMediaStreamUpdate=!0,this.triggerRenegotiation(!0)))}async terminate(e,t,i=!0){this.logger.safe.info(`[${e}] terminate`),this.stats.setTerminated(),this.canTriggerRenegotiation=!1,this.cleanUp(e);try{i&&await this.getStatsAsync(!1)}catch(t){this.logger.safe.error(`[${e}] Error while gathering stats ${Ve(t)}`)}finally{this.stats.dispose(),this.terminated=!0}}processNotification(e,t){this.extensionsManager.processNotification(e,t)}cleanUp(e){this.negotiationQueue.dispose(),this.localVideoStreamWatcher.dispose(),this.remoteVideoManager.dispose(),this.resetPeerConnection(e),this.subscriptionManagerSubs.forEach((e=>e.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(e){this.logger.safe.info(`[${e}] reset peer connection`),this.audioRenderer&&this.audioRenderer.dispose(),this.dtmfSender&&(this.dtmfSender.dispose(),this.dtmfSender=null),this.peerConnection&&this.peerConnection.close(),this.toBeCalledAfterConnected=[],this.disposeStreams(),this.peerConnection=null,this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(e),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(e=Te()){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Yu,e)}setNegotiationPromise(e,t=Te()){this.terminated||(this.negotiationCompletedPromise=e,this.negotiationQueue.add(this.negotiationCompletedPromise,t))}setupExtensionsManager(){const e=new LO(this.logger.createChild("ExtMgr"));return e.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),e.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,configProvider:this.configProvider,statisticsGatherer:this.stats}),e}updateQualityLevels(e){if(!e)return;this.hwSilent!==e.audioHwSilent&&(this.hwSilent=e.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",e.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:e.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",e.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:e.networkSendLevel});const t=!(!e.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",t?"Bad":"Good")}triggerRenegotiation(e,t=Te()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${t}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(t)):e&&(this.logger.safe.info(`[${t}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(e){if(!this.configuredModalities)throw new Error(e)}addTrack(e,t,i){if(!e)return;const n=this.modalityByMediaType(i);if(this.logger.safe.info(`add media track kind: ${e.kind} id: ${e.id}`),this.senders[n])throw new Error("track already created, modality:"+n+", kind:"+e.kind+", id:"+e.id);"closed"!==this.peerConnection.iceConnectionState&&(this.senders[n]=this.peerConnection.addTrack(e,t))}registerMediaSources(){const e=[];if(this.mediaStreams.forEach(((t,i)=>{const n={sourceId:this.getSourceIdForStream(t),defaultSSRC:this.ssrcs[i].min,modality:this.modalityByMediaType(i)};e.push(n)})),this.qualityManager.updateRegisteredSources(e),this.videoStream){const e=this.videoStream.getResolution();this.qualityManager.setCurrentResolution(new QA(e.width,e.height))}}updateStream(e,t){return e.start().then((()=>{try{const i=this.mediaStreams.get(t);if(i&&e.isSameStream(i))return e.dispose(),null;if(this.updateSsrcRangeForMediaType(t),this.removeTrackByMediaType(t),this.disposeStreamByMediaType(t),!this.peerConnection)return e.dispose(),null;if(this.addTrack(e.rawTrack,e.rawStream,t),e.onApplyConstraints=i=>{this.removeTrackByMediaType(t),i.then((()=>{this.addTrack(e.rawTrack,e.rawStream,t),this.registerLocalStreams(),this.mediaManager.updateMediaEntitiesWithLocalTracks()}))},this.mediaStreams.set(t,e),"Video"===t){const e=[this.getMediaTrackInfo(t)];this.localVideoStreamWatcher.startWatching(e)}}catch(i){throw this.removeTrackByMediaType(t),this.disposeStreamByMediaType(t),e.dispose(),i}}))}getSourceIdForStream(e){const t=e.rawStream.getTracks()[0].id,i=this.mediaManager.getMediaEntityByLocalTrackId(t);return i?(this.logger.safe.info(`Media entity found: ${JSON.stringify(i.getXSourceStreamId())}`),i.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(t)}`),0)}updatePeerConnectionStreamsAsync(e,t,i,n){const r=zp(this.negotiatedModalities.audio),s=zp(this.negotiatedModalities.video),a=zp(this.negotiatedModalities.sharing),o=Yp(this.negotiatedModalities),c=zp(e.audio),l=zp(e.video),d=zp(e.sharing),h=Yp(e);return o||h||(this.stats.onSendersChanged("Audio",c),this.stats.onSendersChanged("Video",l),this.stats.onSendersChanged("ScreenShare",d)),this.assurePeerConnectionAsync(n).then((async()=>{if(this.logger.safe.info("updatePeerConnectionStreamsAsync","pc state",this.peerConnection.signalingState,"hold","[",o,"->",h,"]","audio","[",r,"->",c,"]","video","[",s,"->",l,"]","sharing","[",a,"->",d,"]"),o!==h){if(this.videoStream&&this.videoStream.setHold(h),this.audioStream&&this.audioStream.setHold(h),this.displayStream&&this.displayStream.setHold(h),h)return;if(!h&&this.audioStream){this.removeTrackByMediaType("Audio");const e=this.audioStream.clone();this.audioStream.dispose(),this.mediaStreams.set("Audio",e),this.addTrack(this.audioStream.rawStream.getAudioTracks()[0],this.audioStream.rawStream,"Audio")}}if((r!==c||s!==l||a!==d||this.forceMediaStreamUpdate)&&(i&&(this.forceMediaStreamUpdate=!1),t&&(this.logger.safe.info("not using any media(track api) track, remove all senders"),c||(this.removeTrackByMediaType("Audio"),this.disposeStreamByMediaType("Audio")),i&&l||(this.removeTrackByMediaType("Video"),this.disposeStreamByMediaType("Video")),i&&d||(this.removeTrackByMediaType("ScreenShare"),this.disposeStreamByMediaType("ScreenShare"))),i)){const e=[];if(l){const t=await this.deviceManager.getVideoStream(!1);e.push(this.updateStream(t,"Video"))}if(d){const t=this.deviceManager.getDisplayStream();e.push(this.updateStream(t,"ScreenShare"))}if(c){const t=await this.deviceManager.getAudioStream(!1);e.push(this.updateStream(t,"Audio").then((()=>{this.audioStream.setMuted(this.doAudioMute)})))}return Promise.all(e).then((()=>this.registerLocalStreams()))}}))}getMediaTrackInfo(e){const t=this.modalityByMediaType(e),i=this.mediaStreams.get(e).rawStream.getTracks()[0].id;return i||this.logger.safe.error(`No media track for modality found: ${t}`),{trackId:i,modality:t}}getSsrcRangeForMediaType(e){const t={min:1,max:1};switch(e){case"Audio":return this.ssrcGenerator.nextAudioStreamSsrc();case"Video":case"ScreenShare":return this.ssrcGenerator.nextVideoStreamSsrc();default:return t}}updateSsrcRangeForMediaType(e){"Video"!==e&&"ScreenShare"!==e||(this.ssrcs[e]=this.ssrcGenerator.nextVideoStreamSsrc())}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!1,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}registerLocalStreams(){const e=[];this.mediaStreams.forEach(((t,i)=>{e.push(this.getMediaTrackInfo(i))})),this.mediaManager.setLocalTracksInfo(e)}handleVideoRecvCapabilities(e){if(this.configProvider.config.enableLocalVideoConstraints&&Jp(e.getModalities().video)){if(this.videoStream){const t=e.getVideoRecvCapabilities();if(!t)return this.logger.safe.error("No fmt params found for video modality"),Promise.resolve(!1);const i=this.generateReceiveCapabilities(t,this.videoStream);this.qualityManager.setMaxCapabilities([i])}this.logger.safe.error("remote endpoint didn't specify video receive capability")}return Promise.resolve(!1)}handleSharingRecvCapabilities(e){if(this.configProvider.config.enableLocalVideoConstraints&&Jp(e.getModalities().sharing)&&this.displayStream){const t=e.getSharingRecvCapabilities();if(!t)return void this.logger.safe.error("No fmt params found for sharing modality");const i=this.generateReceiveCapabilities(t,this.displayStream);this.qualityManager.setMaxCapabilities([i])}}generateReceiveCapabilities(e,t){const i={ssrc:0,rid:"0",keyframe:!1,...e},n={causeId:Te(),isSimulcast:!1,sourceId:this.getSourceIdForStream(t),capabilities:[i]};return this.logger.safe.info(`Generated receive capabilities for stream ${t.id}: ${JSON.stringify(n)}`),n}updateDescriptor(e,t){const i=t.getVideoRecvCapabilities(),n={sourceId:0,streamMsid:0,bandwidth:0};if(i&&this.videoStream&&!this.displayStream&&(n.sourceId=this.getSourceIdForStream(this.videoStream),n.streamMsid=this.videoStream.id,n.bandwidth=i.maxBr?i.maxBr:Number.MAX_VALUE),n.bandwidth>0){n.bandwidth=Math.floor(n.bandwidth/1200);const t=new XD(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider);t.setControlItem(n),t.modifyDescriptor(e)}}removeTrackByMediaType(e){return this.removeTracksByModality(this.modalityByMediaType(e))}modalityByMediaType(e){switch(e){case"Audio":return Qe.MODALITY.audio;case"Video":return Qe.MODALITY.video;case"ScreenShare":return Qe.MODALITY.sharing;default:throw new Error(`Modality is not defined for media type: ${e}`)}}removeTracksByModality(e){this.forceKeyFramePromise&&"sharing"===e?this.forceKeyFramePromise.then((()=>{this.removeTracksByModality(e)})):e in this.senders&&(this.logger.safe.info(`remove sender track kind: ${this.senders[e].track.kind} track id: ${this.senders[e].track.id}`),"closed"!==this.peerConnection.iceConnectionState&&this.peerConnection.removeTrack(this.senders[e]),delete this.senders[e])}handleCodecSwitchUnsupported(e){return this.offeredDescription.isCodecSwitchSupported()?Promise.resolve():this.webrtcAdapter.RTCRtpReceiver.getCapabilities(Qe.MEDIA_TYPE.audio).then((e=>{const t=e.codecs.map((e=>e.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(t)})).catch((t=>{this.logger.safe.error(`[${e}] failed to set primary codec based on audio capability ${Ve(t)}`)}))}disposeStreamByMediaType(e){const t=this.mediaStreams.get(e);t&&(this.mediaStreams.delete(e),t.dispose(),"Video"===e&&this.localVideoStreamWatcher.stopWatching())}disposeStreams(){this.mediaStreams.forEach(((e,t)=>this.disposeStreamByMediaType(t)))}assurePeerConnectionAsync(e){if(!this.peerConnectionPromise){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info("fetching relay details from RelayManager...");const t={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};this.peerConnectionPromise=this.relayManagerProvider.getRelayManager().queryRelaysAsync(t).then((t=>{if(this.terminated)throw new Error("session already disposed");const i={optional:[]},n=DD(t,this.configProvider.config),r=this.configureCrypto(i);this.configureCpuThreshold(i),this.logger.safe.info("create peer connection");const s=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle",a=this.peerConnection=new this.webrtcAdapter.RTCPeerConnection({iceServers:n,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,bundlePolicy:s,sdpSemantics:"plan-b",audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===r,offerExtmapAllowMixed:!1},i);this.negotiationEmulator.configure(a),this.stats.initialize(a),this.stats.sessionInfo.setIceServers(n),this.stats.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.stats.sessionInfo.setBundlePolicy(s),this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((e=>this.stats.setH264AvailableProfiles(e))),a.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${a.signalingState}`)},a.onsignalingstatechange=()=>{this.stats.sessionInfo.setSignalingConnectionState(a.signalingState),this.logger.safe.info(`onsignalingstatechange signalingState: ${a.signalingState}`)},a.onicecandidateerror=e=>{const[t,i]=[e.address,e.port];this.logger.safe.warn(`On ICE candidate error ${e.url} | ${t}:${i}: code ${e.errorCode}: ${e.errorText}`),this.isConnected()&&!this.iceCandidatesDeferred.isPending||this.stats.addIceCandidateError({address:t,port:+i,url:e.url,errorCode:e.errorCode,errorText:e.errorText})};const o=e=>{if(!this.isConnected())return this.logger.safe.info("onaddstream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>o(e)));const t=e.stream;this.logger.safe.info(`onaddstream stream: ${t.id}`);let i=this.mediaManager.getMediaEntityByRemoteStreamId(t.id);if(i||(this.logger.safe.info(`cannot find media entity with stream id ${t.id} trying to fallback`),t.getAudioTracks()[0]&&(i=this.mediaManager.getMediaEntitiesByModality(Qe.MODALITY.audio)[0])),i){const e=this.createReceiveStream(t,i);this.receiveStreamCollection.add(e)}else this.logger.safe.error(`could not find media entity for an added stream: ${t.id}`)};a.onaddstream=o,a.ontrack=e=>{this.logger.safe.info(`ontrack track: ${e.track}`)};const c=e=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>c(e)));this.logger.safe.info(`onremovestream stream: ${e.stream.id}`),this.receiveStreamCollection.remove(e.stream.id)};a.onremovestream=c,a.onicecandidate=t=>{const i=t.candidate;if(i){const t=rm(i.candidate);this.logger.safe.info(`[${e}] onicecandidate candidate: prio:${t.priority} type:${t.type} port:${t.port}`),this.logger.unsafe.info(`[${e}] candidate details: ${i.candidate}`),!this.relayCandidateGathered&&i.candidate.indexOf("typ relay")>-1&&(this.stats.sessionInfo.setRelayCandidateInfo({priority:i.priority||i.candidate.split(" ")[3],time:Date.now()-this.iceRelayCandidatesGatherStartTime}),this.relayCandidateGathered=!0)}else this.logger.safe.info(`[${e}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const r=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,s=this.iceHostCandidateOnly||0===n.length;if(!i&&r||s){i&&this.logger.safe.info(`[${e}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${e}] Is connected:`,this.isConnected(),a.iceConnectionState,a.signalingState);let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&i&&(t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledIceCandidates()),t&&this.completeCandidateGathering(e)}else if(this.relayCandidateGathered){let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&(t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledRelayIceCandidates()),t&&(this.stats.clearIceCandidateErrors(),this.completeCandidateGathering(e))}},a.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${a.iceGatheringState}`)},a.oniceconnectionstatechange=()=>{const e=Te();if(!this.terminated){if(this.stats.sessionInfo.setIceConnectionState(a.iceConnectionState),this.logger.safe.info(`[${e}] oniceconnectionstatechange iceConnectionState: ${a.iceConnectionState} pc.signalingState: ${a.signalingState}`),"connected"===a.iceConnectionState||"completed"===a.iceConnectionState)this.onTransportConnected(e);else if("failed"===a.iceConnectionState){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${e}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(e);this.raiseError({type:Qe.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},e),this.configProvider.config.webrtcCloseAfterIceFailure&&a.close(),this.onTransportFailed()}"disconnected"===a.iceConnectionState?(this.onTransportDisconnected(e),this.startIceDisconnectedTimer(e)):this.clearIceDisconnectedTimer()}},this.multiParty&&(this.contributingSources=new yN(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new CN(this.logger.createChild("ContributingSourcesProvider"),a)))}))}return this.peerConnectionPromise}configureCrypto(e){let t=!1;const i=fm(this.context);if(this.offeredDescription){const e=this.offeredDescription.getSrtpInfo();this.stats.sessionInfo.setOfferedSrtpInfo(e),t=!e.dtls||e.sdes&&i}else t=i;return t&&(this.logger.safe.info("configuring peer connection to use sdes"),e.optional.push({DtlsSrtpKeyAgreement:!1})),this.stats.sessionInfo.setNegotiatedSrtpInfo({dtls:!t,sdes:!!t}),t?0:1}configureCpuThreshold(e){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&e.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(e){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${e}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(e){if(this.logger.safe.info(`[${e}] audio transport connected`),this.stats.clearIceCandidateErrors(),!this.terminated)for(this.callbacks.onAudioStateChanged(Qe.STREAMING_STATE.active,e),this.callbacks.onTransportConnected&&this.callbacks.onTransportConnected(e);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}onTransportDisconnected(e){this.callbacks.onTransportDisconnected&&this.callbacks.onTransportDisconnected(e)}onTransportFailed(){this.callbacks.onTransportFailed&&this.callbacks.onTransportFailed()}startIceDisconnectedTimer(e){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${e}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise CONSTANTS.MEDIAthis._ERROR.iceConnectionError`),this.raiseError({type:Qe.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},e)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(e,t=Te()){this.logger.safe.error(`[${t}] Media error occurred type: ${e.type} detail: ${e.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(e,t)}createNegotiationConstraints(e){function t(e){return!!e&&(Jp(e)||"inactive"===e)}return{offerToReceiveAudio:t(e.audio),offerToReceiveVideo:t(e.video)||t(e.sharing)}}resetCandidateGathering(e){this.logger.safe.info(`[${e}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Yu}checkIceCandidates(e){const t=this.hasIceCandidates(e);if(t===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:Qe.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(t){const t=this.hasRelayIceCandidates(e);if(t===this.noRelayIceCandidates){if(!t&&("connected"===this.peerConnection.iceConnectionState||"completed"===this.peerConnection.iceConnectionState))return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledIceCandidates():e.hasIceCandidates()}hasRelayIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledRelayIceCandidates():e.hasRelayIceCandidates()}doRetargetIfNeeded(e,t,i){const n=t.isIceRestart();this.logger.safe.info(`[${i}] ICE restart: ${n}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription?.isMSRTC()&&n&&!this.multiParty&&t.getSrtpInfo().sdes&&(e.newOffer=!0)}getAddedMediaTypes(e,t){e||(e={}),t||(t={});const i=[];return zN(e.audio,t.audio)&&i.push("Audio"),zN(e.video,t.video)&&i.push("Video"),zN(e.sharing,t.sharing)&&i.push("ScreenShare"),i}applyCapabilitiesForModality(e,t,i){return e===Qe.MODALITY.video?this.applyCapabilitiesForVideo(t,i[0]):e===Qe.MODALITY.sharing?this.applyCapabilitiesForSharing(t,i[0]):Promise.resolve(!1)}applyCapabilitiesForSharing(e,t){return this.displayStream?this.applyCapabilities(this.displayStream,t).then((i=>(this.stats.onMaxCapabilitiesApplied({causeId:e,modality:Qe.MODALITY.sharing,capabilities:[t]}),this.configProvider.config.webrtcAllowRestoreKeyframe?this.forceKeyframe(this.senders[Qe.MODALITY.sharing]).then((()=>i)):Promise.resolve(i)))):(this.logger.safe.info(`${JSON.stringify(t)} is ignored as no sharing stream is sent, no renegotiation`),Promise.resolve(!1))}forceKeyframe(e){if(!e)return this.logger.safe.error("forceKeyframe: No sender available for sharing"),null;if(this.forceKeyFramePromise)return this.logger.safe.warn("forceKeyframe: already in progress"),this.forceKeyFramePromise;this.logger.safe.info("Restoring keyframe");const t=e.track;return this.forceKeyFramePromise=e.replaceTrack(null).then((()=>e.replaceTrack(t))).then((()=>{this.forceKeyFramePromise=null,this.logger.safe.info("Restoring keyframe finished")})).catch((e=>{this.forceKeyFramePromise=null,this.logger.safe.error(`Restoring keyframe failed: ${e}`),delete this.senders[Qe.MODALITY.sharing]})),this.forceKeyFramePromise}applyCapabilitiesForVideo(e,t){return this.negotiationCompletedPromise.isPending?(this.logger.safe.info("##### Renegotiation is in progress, no local resolution switch for now #####"),this.negotiationCompletedPromise.promise.then((()=>Promise.resolve(!1)))):this.videoStream?this.scheduleApplyCapabilities(this.videoStream,e,t):(this.logger.safe.info(`${JSON.stringify(t)} is ignored as no video is sent, no renegotiation`),Promise.resolve(!0))}scheduleApplyCapabilities(e,t,i){this.logger.safe.info("Queueing local renegotiation...");let n=!1;return this.negotiationQueue.add((()=>(this.logger.safe.info("############# LOCAL RENEGOTIATION START #############"),this.applyCapabilities(e,i).then((()=>{this.stats.onMaxCapabilitiesApplied({causeId:t,modality:Qe.MODALITY.video,capabilities:[i]}),n=!0})))),t),this.negotiationEmulator.renegotiate().then((()=>(this.logger.safe.info(`############# LOCAL RENEGOTIATION END. RESULT: ${n}  #############`),n)))}applyCapabilities(e,t){return e?(this.logger.safe.info(`Changing resolution to ${JSON.stringify(t)}`),e.applyCapabilities(t)):(this.logger.safe.info(`Resolution ${JSON.stringify(t)} ignored, no stream is being sent`),Promise.resolve(!1))}onOptimalVideoReceiversCountChanged(e){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(e)}async onSendBandwidthChanged(e){if(!this.isConnected())return;const t=this.extensionsManager.getExtension("videoStreamControl"),i=this.mediaManager.getMediaEntities().filter((e=>[Qe.MODALITY.video,Qe.MODALITY.sharing].indexOf(e.getModality())>-1)).filter((e=>e.isEnabled())).map((e=>e.getMid()));return 0!==i.length?t.sendBandwidthInfo(i,e).then((()=>{this.stats.setReportedSendBandwidth(e)})):void 0}getStreams(){return this.receiveStreamCollection.getStreams()}onStreamsChanged(e){this.streamsChangedListener=e}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}streamAdded(e){Qe.MODALITY.audio===e.getModality()&&(this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),this.audioRenderer.play(e.getMediaStream())),this.notifyStreamsChanged()}streamRemoved(e){Qe.MODALITY.audio===e.getModality()&&this.audioRenderer.getStream()===e.getMediaStream()&&this.audioRenderer.stop(),this.notifyStreamsChanged()}setNegotiatedModalities(e){this.negotiatedModalities=e,this.stats.sessionInfo.setNegotiatedModalities(e)}setupIceGatheringTimeout(e){this.iceRelayCandidatesGatherStartTime=Date.now();const t=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!t)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const i=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,i.isPending&&(this.logger.safe.warn(`[${e}] ICE candidates gathering terminated due to timeout ${t}`),i.resolve())}),t)}createAudioRenderer(){this.audioRenderer=new HA(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved)}isConnected(){const e=this.peerConnection;return e&&("connected"===e.iceConnectionState||"completed"===e.iceConnectionState)}isFailed(){return this.peerConnection&&("failed"===this.peerConnection.iceConnectionState||"closed"===this.peerConnection.iceConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}createReceiveStream(e,t){const i=this.configProvider.config.addFmtpToInitialSubscription?t.getLocalRecvCapabilities():null,n=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&t.getModality()!==Qe.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null;return new HN(e,null,t.getModality(),+t.getXSourceStreamId(),this,i,n)}requestSource(e,t,i){if(!this.multiParty)return Promise.resolve();const n=this.mediaManager.getMediaEntityByRemoteStreamId(e);return!this.isMuteHold&&this.negotiatedModalities[n.getModality()]!==Qe.MEDIA_STATE.inactive||t===WD.SourceNone?this.negotiationCompletedPromise.isPending?this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>this.requestSource(e,t))):Promise.resolve().then((()=>this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(n.getXSourceStreamId(),t,n?.getMid(),i,n.getSubstreamIndex()))):km(10).then((()=>this.requestSource(e,t)))}getSessionConfig(){return this.configProvider}getUnmixedAudioProvider(){return null}};function zN(e,t){return!zp(e)&&zp(t)}var JN={build:(e,t,i)=>new WN(e,t,i)},KN=class{constructor(e,t,i,n){this.worker=e,this.clientId=t,this.transformType=i,this.listener=n,this.worker.subscribeClient(this.clientId,this.transformType,(e=>this.processMsg(e))),this.worker.sendTransformCommand(this.clientId,{operation:"add",transformType:this.transformType})}processMsg(e){if(this.listener&&e.name in this.listener)return this.listener[e.name].apply(this.listener,e.args);throw`unexpected message received for transform type ${this.transformType}: ${JSON.stringify(e)}`}},YN=class{constructor(e){this.logger=e}createBaseInstanse(e){this.imp=new QN(this.logger.safe),e.addTransform(this.imp)}createWorkerInstanse(e,t){this.imp=new XN(e,t)}},QN=class{constructor(e){this.logger=e,this.transformType=0}transform(e){return this.processChunk(e),e}dispose(){}getStartCodeSize(e){const t=e.getUint32(0);return 1===t?4:256==(4294967040&t)?3:0}processChunk(e){if("key"!==e.type)return;const t=this.isH264KeyFrame(e.data)?`${this.getH264Profile(e.data)}(H264)`:"unknown";this.logger.info(`keyframe metadata: ${JSON.stringify(e.getMetadata())}, profile=${t}`)}isH264KeyFrame(e){if(e.byteLength<7)return!1;const t=new DataView(e),i=this.getStartCodeSize(t);return!!i&&7==(31&t.getUint8(i))}getH264Profile(e){const t=new DataView(e),i=this.getStartCodeSize(t);return(16777215&t.getUint32(i)).toString(16)}},XN=class extends KN{constructor(e,t){super(e,t,0,void 0)}},ZN=p,eL=[Qe.MODALITY.audio,Qe.MODALITY.video,Qe.MODALITY.sharing],tL=class{constructor(e,t,i,n,r){this.peerConnection=t,this.mediaManager=i,this.reinvitelessContext=r,this.entityTransceiverMap=new Map,this.logger=e.createChild("TM"),this.configProvider=n.configProvider,this.isMultiparty=n.config.isConference,this.isPstnCall=n.config.isPstnCall,this.isParkedCall=n.config.isParkedCall,this.numVideoChannels=this.isMultiparty&&this.configProvider.config.numVideoChannelsGvc||1,n.configProvider.config.enableRollbackHandler&&this.mediaManager.setRollbackUpdateHandler(this.handleMediaEntitiesRollback.bind(this))}getTransceivers(){return this.peerConnection.getTransceivers().filter(rL)}assureTransceivers(e){this.assureNegotiatedOrder(),this.addModalities(e),this.logTransceiversInfo("assureTransceivers"),this.setDirections(e)}syncTransceivers(e){this.syncWithMediaEntities(),this.setDirections(e)}assureNegotiatedOrder(){const e=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((t=>{-1!==eL.indexOf(t.getModality())&&(sL(this.entityTransceiverMap.get(t),e)||this.createTransceiverForEntity(t))}))}addModalities(e){const t=this.mediaManager.isEmpty();this.isMultiparty||!t||this.isPstnCall||(e.video=e.video||"inactive",e.sharing=e.sharing||"inactive"),this.configProvider.config.webrctRemoveVideoModalitiesForPstn&&this.isPstnCall&&!this.isParkedCall&&(delete e.video,delete e.sharing);for(const i of eL){if(this.mediaManager.getMediaEntitiesByModality(i)[0]||!e[i])continue;const n=i===Qe.MODALITY.video?this.numVideoChannels:1;(0,ZN.times)(n,(e=>{const n=this.mediaManager.createMediaEntity(i);n.setExtension("reinviteless",t&&this.reinvitelessContext.maxStreamsForModality[i]>e),this.createTransceiverForEntity(n)}))}}createTransceiverForEntity(e){const t=e.getModality();this.logger.safe.info(`createTransceiver: modality=${t}`);const i=t===Qe.MODALITY.audio?Qe.MEDIA_TYPE.audio:Qe.MEDIA_TYPE.video,n=e.getSimulcastContext(),r=this.createTransceiver(i,n);this.setCodecPreferences(r,i,!0),this.setExtensionPreferences(r,t),this.entityTransceiverMap.set(e,r),e.setExtension("unnegotiatedModality",!0)}setCodecPreferences(e,t,i){const n=ym(this.configProvider,t);if(!n?.length||!Bp.hasCapabilitiesApi()||this.configProvider.config.filterCodecsInSdp)return;const r=Vp.window.RTCRtpReceiver.getCapabilities(t);if(!r)return;const s=[];if(i)for(const e of n){const t=r.codecs.filter((t=>iL(e,t)));s.push(...t)}else for(const e of r.codecs)n.some((t=>iL(t,e)))&&s.push(e);s.length&&e.setCodecPreferences&&e.setCodecPreferences(s)}setExtensionPreferences(e,t){if(!this.configProvider.config.headerExtensionsToUpdate?.[t])return;if(!e.getHeaderExtensionsToNegotiate||!e.setHeaderExtensionsToNegotiate)return void this.logger.safe.debug("setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate is not supported");const i=this.configProvider.config.headerExtensionsToUpdate[t],n=e.getHeaderExtensionsToNegotiate();for(const e of n){const t=i.find((t=>t.uri===e.uri));t&&(e.direction=t.direction)}try{e.setHeaderExtensionsToNegotiate(n)}catch(e){this.logger.safe.error(`setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate failed, err ${Ve(e)}`)}}async createSender(e,t,i){const n=await this.associateTrackWithTransceiver(e,t,i);if(!n)throw new Error(`Transceiver for modality=${i} is not found`);const r=this.findEntityForTransceiver(n),s=i!==Qe.MODALITY.sharing||r?.getExtension("reinviteless")?Qe.MEDIA_STATE.sendReceive:Qe.MEDIA_STATE.send;return n.direction=s,this.logger.safe.info(`Replace track completed direction:${n.direction} for transceiver mid=${n.mid}`),n.sender}removeSender(e){this.removeSenderInternal(e,!1)}async removeSenderAsync(e){return this.removeSenderInternal(e,!0)}removeSenderInternal(e,t){if("closed"===(this.peerConnection.connectionState||this.peerConnection.iceConnectionState))return void this.logger.safe.info("Not removing sender from pc, connection is closed");const i=this.getTransceivers().find((t=>t.sender===e));if(!i)throw new Error(`Transceiver for sender with track=${e.track?.id} is not found`);const n=this.findEntityForTransceiver(i),r=!!n?.getExtension("reinviteless");this.logger.safe.info(`Remove sender with track=${e.track?.id} for transceiver mid=${i.mid}, reinviteless=${r}, doAsync=${t}`);let s=Promise.resolve();return r&&t?s=i.sender.replaceTrack(null):this.peerConnection.removeTrack(e),t?s:void 0}createTransceiver(e,t){const i={direction:"inactive"};return this.addSimulcastEnvelopeIfNeeded(i,t),this.peerConnection.addTransceiver(e,i)}addSimulcastEnvelopeIfNeeded(e,t){t?.shouldUseSimulcast()&&(e.sendEncodings=(0,ZN.times)(t.config.layerScaleFactors.length,(e=>{const i=`${t.ridList[e]}`,n=t.config.layerScaleFactors[e];return this.logger.safe.debug(`Added layer ${e} with rid: ${i} SF: ${n}`),{rid:i,scaleResolutionDownBy:n}})))}async associateTrackWithTransceiver(e,t,i){const n=this.findAvailableTransceiverToSend(i);if(n){this.logger.safe.info(`Associate track=${e?.id} (${i}) with existing transceiver mid=${n.mid}`);try{await n.sender.replaceTrack(e),this.configProvider.config.useSetStreamsForSender&&n.sender.setStreams&&n.sender.setStreams(t)}catch(e){throw this.logger.safe.error(`replaceTrack failed, err ${JSON.stringify(e)}`),e}return n}return null}syncWithMediaEntities(){const e=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((t=>{let i=this.entityTransceiverMap.get(t);i=sL(i,e)?i:e.find((e=>e.mid===t.getMid())),this.entityTransceiverMap.set(t,i)})),this.logTransceiversInfo("syncWithMediaEntities")}getTransceiversByModality(e){return this.mediaManager.getMediaEntitiesByModality(e).map((e=>this.entityTransceiverMap.get(e))).filter(rL)}setDirections(e){const t=!Yp(e);for(const i of eL)for(const[n,r]of this.getTransceiversByModality(i).entries()){const s=this.findEntityForTransceiver(r);if(s?.getExtension("reinviteless")&&t){r.direction="sendrecv";continue}const a=e[i]||Qe.MEDIA_STATE.inactive;r.direction=0===n&&r.currentDirection?a:nL(a)}this.logTransceiversInfo("setDirections")}handleMediaEntitiesRollback(e,t){e.forEach((e=>{const i=this.entityTransceiverMap.get(e),n=t.find((t=>t.getMid()===e.getMid()));this.entityTransceiverMap.set(n,i)})),this.logTransceiversInfo("handleMediaEntitiesRollback")}findAvailableTransceiverToSend(e){const t=this.mediaManager.getMediaEntitiesByModality(e)[0];return this.entityTransceiverMap.get(t)}findEntityForTransceiver(e){for(const[t,i]of this.entityTransceiverMap)if(i===e)return t}logTransceiversInfo(e){let t=`${e}: transceivers details:`;for(const e of eL){const i=this.getTransceiversByModality(e);t+=` ${e}(${i.length}) [${i.map((e=>`mid=${e.mid}, direction=${e.direction}`)).join(";")}]`}this.logger.safe.debug(t)}};function iL(e,t){return!(!(0,ZN.isUndefined)(e.channels)&&e.channels!==t.channels||!(0,ZN.isUndefined)(e.clockRate)&&e.clockRate!==t.clockRate||!(0,ZN.isUndefined)(e.mimeType)&&e.mimeType.toLowerCase()!==t.mimeType.toLowerCase()||!(0,ZN.isUndefined)(e.sdpFmtpLine)&&-1===t.sdpFmtpLine.toLowerCase().indexOf(e.sdpFmtpLine.toLowerCase()))}function nL(e){let t=e;return zp(e)&&(t=Wp(e)),t||Qe.MEDIA_STATE.inactive}function rL(e){return e&&"stopped"!==e.direction&&!e.stopped}function sL(e,t){return rL(e)&&-1!==t.indexOf(e)}var aL=class{constructor(e,t){this.transforms=[];const i=new TransformStream({transform:(e,t)=>{let i=e;for(const e of this.transforms)if(i=e.transform(i),!i)return;t.enqueue(i)}});e.pipeThrough(i).pipeTo(t)}clearTransforms(){for(const e of this.transforms)e.dispose();this.transforms=[]}addTransform(e){this.transforms.push(e)}getTransform(e){return this.transforms.find((t=>t.transformType===e))}},oL=class{constructor(e,t){this.logger=t,this.clientsMap=new Map,this.loaded=!1,this.initDefer=Om();try{this.worker=e.getWorker(),this.worker.onmessage=e=>this.handleEvent(e.data),this.worker.onerror=e=>{this.logger.safe.error(`error inside worker: ${e.message}`),this.initDefer.resolve()}}catch(e){this.logger.safe.error("failed to create worker"),this.initDefer.resolve()}}initialize(){return Promise.race([this.initDefer.promise,km(5e3)])}isWorkerLoaded(){return this.loaded}sendTransformCommand(e,t,i=[]){const n={type:"transform",clientId:e,payload:t};this.worker.postMessage(n,i)}subscribeClient(e,t,i){const n=this.clientsMap.get(e)??new Map;n.set(t,i),this.clientsMap.set(e,n)}dispose(){this.worker.postMessage({type:"generic",payload:{operation:"dispose"}}),this.worker.terminate()}handleEvent(e){switch(e.type){case"init":this.initDefer.resolve(),this.loaded=!0;break;case"transform":{const t=this.clientsMap.get(e.payload.clientId),i=t?.get(e.payload.event.transformType);i?.(e.payload.event),i||this.logger.safe.error(`received event for unknown Client ${e.payload.clientId} or transformType ${e.payload.event.transformType}`)}break;case"log":switch(e.level){case"debug":this.logger.safe.debug(e.msg);break;case"info":this.logger.safe.info(e.msg);break;case"warn":this.logger.safe.warn(e.msg);break;case"error":this.logger.safe.error(e.msg);break;default:this.logger.safe.error(`unknown log level ${e.level}`)}break;default:this.logger.safe.error(`received unsupported event from worker ${e.type}`)}}},cL=class extends ze{constructor(e,t,i){super(),this.configProvider=e,this.workerProvider=t,this.logger=i,this.transformsCollections=new Map}async initialize(){return this.configProvider.config.useInsertableStreams&&this.workerProvider&&Bp.hasEncodedStreamApi()&&(this.worker=new oL(this.workerProvider,this.logger)),this.worker?this.worker.initialize():Promise.resolve()}initTransformsCollection(e,t,i){const n=Bp.hasScriptTransformApi()||this.workerProvider;if(!this.configProvider.config.useInsertableStreams||!Bp.hasEncodedStreamApi()||n&&!this.isWorkerLoaded())return null;if(!this.transformsCollections.has(e)){const n=this.worker?new dL(this.worker,e):new lL(e);this.transformsCollections.set(e,{collection:n,mediaType:i,objType:t})}const r=this.transformsCollections.get(e);return this.event("onTransformsCollectionCreated").raise(r),r.collection}clearTransformsCollection(e){const t=this.transformsCollections.get(e);t&&(this.event("onTransformsCollectionCleared").raise(t),t.collection.clearTransforms())}dispose(){for(const e of this.transformsCollections.values())this.event("onTransformsCollectionCleared").raise(e),e.collection.clearTransforms();this.transformsCollections.clear(),this.worker?.dispose(),super.dispose()}isWorkerLoaded(){return!!this.worker?.isWorkerLoaded()}},lL=class{constructor(e){const{readable:t,writable:i}=e.createEncodedStreams();this.streamTransformer=new aL(t,i)}addTransform(e){e.createBaseInstanse(this.streamTransformer)}clearTransforms(){this.streamTransformer.clearTransforms()}},dL=class{constructor(e,t){if(this.workerHandler=e,this.clientId=t.track.id,Bp.hasScriptTransformApi())return void(t.transform=new RTCRtpScriptTransform(this.workerHandler.worker,{clientId:this.clientId}));const{readable:i,writable:n}=t.createEncodedStreams(),r=[i,n];this.workerHandler.sendTransformCommand(this.clientId,{operation:"init",readable:i,writable:n},r)}addTransform(e){e.createWorkerInstanse(this.workerHandler,this.clientId)}clearTransforms(){this.workerHandler.sendTransformCommand(this.clientId,{operation:"clear"})}},hL=p,uL=class extends ze{constructor(e,t){super(t),this.logger=t,this.id=-1,this.parentId=-1,this.rawStream=null,this.rawTrack=null,this.deviceId=null,this.mediaType=e}start(){return this.logger.safe.debug("start"),Promise.resolve()}clone(){return this.logger.safe.debug("clone"),this}setMuted(e,t){this.logger.safe.debug("setMuted")}setHold(e){this.logger.safe.debug("setHold")}getResolution(){return this.logger.safe.debug("getResolution"),{width:240,height:180}}getFrameRate(){return this.logger.safe.debug("getFrameRate"),1}hasAudio(){return this.logger.safe.debug("hasAudio"),!1}hasVideo(){return this.logger.safe.debug("hasVideo"),!1}isSameStream(e){return this.logger.safe.debug("isSameStream"),e===this}applyCapabilities(e){return this.logger.safe.debug("applyCapabilities"),Promise.resolve(!1)}onApplyConstraints(e){this.logger.safe.debug("onApplyConstraints")}update(e){this.logger.safe.debug("update")}isActive(){return!1}isDisposed(){return!1}},gL=class e extends ze{constructor(e,t,i,n){super(n),this.callDeviceManager=e,this.configProvider=t,this.serialQueue=i,this.logger=n,this.mediaStreams={Audio:null,Video:null,ScreenShare:null},this.streamSubscriptions=new Map,this.deviceManagerSubscriptions=[],this.isNullAudioStream=!1}get currentMediaTypes(){return at(this.streams).filter((e=>!!this.streams[e]))}get streams(){return this.mediaStreams}useNullAudioStreamClient(){this.isNullAudioStream=!0}async update(e,t){const i=at(e).filter((t=>e[t]));return ht(i,this.currentMediaTypes)?(this.logger.safe.info("Requested modalities have not changed. Do nothing"),dm(this.streams)):(this.logger.safe.info(`Starting media session with modalities: ${JSON.stringify(e)}`),await this.updateStreams(i,t),this.subscribeOnDeviceManagerEvents(),dm(this.streams))}async stopAsync(){this.logger.safe.info("Stopping streams async"),this.stop()}stop(){this.logger.safe.info("Stopping streams"),this.unsubscribeFromDeviceManagerEvents(),at(this.mediaStreams).forEach((e=>this.removeStreamByType(e)))}async ensureUpdateCompleted(){this.logger.safe.debug("streams updated")}dispose(){this.stop(),super.dispose()}async updateStreams(e,t){const i=this.getAvailableMediaTypes(),n=(0,hL.intersection)(e,i),r=at(this.mediaStreams).filter((e=>this.mediaStreams[e])),s=t?[]:St(n,r),a=St(r,n);this.logger.safe.info(`Adding media streams for types: ${JSON.stringify(s)}`),await Promise.all(s.map((async e=>{await this.addStream(e,!1),this.mediaStreams[e]&&this.event("onStreamAdded").raise(e)}))),this.logger.safe.info(`Removing media streams for types: ${JSON.stringify(a)}`),a.forEach((e=>{this.event("onStreamRemoving").raise(e),this.removeStreamByType(e)}))}getAvailableMediaTypes(){const e=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices(),t=[];return e.microphone&&t.push("Audio"),e.camera&&t.push("Video"),t.push("ScreenShare"),t}async addStream(e,t){if(this.mediaStreams[e])return void this.logger.safe.warn(`Stream with type: ${e} is already registered`);const i=await this.getStream(e,t);this.subscribeOnMediaStreamEvents(i);try{await i.start()}catch(t){return this.logger.safe.error(`Media stream request error: ${JSON.stringify(t)}`),void this.event("onStreamError").raise(e,t)}this.mediaStreams[e]=i}removeStreamByType(e){const t=this.mediaStreams[e];t?(this.unsubscribeFromMediaStreamEvents(t),t.dispose(),this.mediaStreams[e]=null):this.logger.safe.warn(`Stream with type: ${e} is not registered`)}async updateStream(e,t,i=!1){i&&"Audio"===e?await this.updateStreamWithEffect(e):(this.removeStreamByType(e),await this.addStream(e,t)),this.event("onStreamUpdated").raise(e)}async updateStreamWithEffect(e){const t=this.mediaStreams[e];t&&this.unsubscribeFromMediaStreamEvents(t);const i=await this.getStreamByMediaType(e,!0);this.subscribeOnMediaStreamEvents(i);try{await i.start()}catch(t){return this.logger.safe.error(`updateStreamWithEffect. Media stream request error: ${JSON.stringify(t)}`),void this.event("onStreamError").raise(e,t)}this.mediaStreams[e]=i,t?.dispose()}subscribeOnMediaStreamEvents(e){if(this.streamSubscriptions.has(e))return;const t=[];t.push(e.on("onStreamClientError",((e,t)=>this.onStreamError(e,t)))),t.push(e.on("onStreamClientDisposing",(e=>this.onStreamDisposing(e)))),this.streamSubscriptions.set(e,t)}unsubscribeFromMediaStreamEvents(e){this.streamSubscriptions.has(e)&&(this.streamSubscriptions.get(e).forEach((e=>e.dispose())),this.streamSubscriptions.delete(e))}async getStream(e,t){const i=this.mediaStreams[e];return i?(this.logger.safe.info(`Stream exists with id: ${i.id}, type: ${e}`),i):this.getStreamByMediaType(e,t)}async getStreamByMediaType(e,t){switch(e){case"Audio":return this.isNullAudioStream?new uL("Audio",this.logger.createChild("NullStreamClient")):this.getDeviceManagerByType("Audio").getAudioStream(t,"sessionStream");case"Video":return this.getDeviceManagerByType("Video").getVideoStream(t,"sessionStream");case"ScreenShare":return this.getDeviceManagerByType("ScreenShare").getDisplayStream("sessionStream");default:throw new Error(`Media type is not supported: ${e}`)}}getMediaTypeForStream(e){const t=Object.keys(this.mediaStreams).find((t=>this.mediaStreams[t]===e));return t||this.logger.safe.error(`Media type is not found for stream: ${Ve(e)}`),t}subscribeOnDeviceManagerEvents(){if(0!==this.deviceManagerSubscriptions.length)return;if(this.callDeviceManager.isVirtualDeviceEnabled){const e=this.callDeviceManager.on("onSelectedVirtualDevicesChanged",((e,t)=>{const i=e;if(!e.camera){this.logger.info("Virtual DeviceID for camera is undefined, falling back to default device");const{camera:e}=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices();i.camera=e}this.callDeviceManager.isModalityEnabled("Video")&&t.camera!==i.camera&&(this.logger.info("Updating stream for camera"),this.updateStreamForVirtualDeviceChange("Video")),this.callDeviceManager.isModalityEnabled("ScreenShare")&&t.screenshare!==i.screenshare&&(this.logger.info("Updating stream for screenshare"),this.updateStreamForVirtualDeviceChange("ScreenShare"))}));this.deviceManagerSubscriptions.push(e)}const e=this.callDeviceManager.getDefaultDeviceManager();this.deviceManagerSubscriptions.push(e.on("onSelectedDevicesChanged",((e,t)=>this.onSelectedDevicesChanged(e,t))),e.on("onStreamUpdateRequested",((e,t)=>this.requestStreamUpdate(e,!1,t))),e.on("onAudioSharingToggled",(e=>this.onAudioSharingToggled(e))))}unsubscribeFromDeviceManagerEvents(){0!==this.deviceManagerSubscriptions.length&&(this.deviceManagerSubscriptions.forEach((e=>e.dispose())),this.deviceManagerSubscriptions=[])}getMediaTypesToUpdate(e,t){const i=[];return this.currentMediaTypes.some((e=>"Audio"===e))&&e.microphone&&e.microphone!==t.microphone&&i.push("Audio"),!this.callDeviceManager.getSelectedDevices().camera&&this.currentMediaTypes.some((e=>"Video"===e))&&e.camera&&e.camera!==t.camera&&i.push("Video"),i}removeStream(e){const t=this.getMediaTypeForStream(e);this.removeStreamByType(t)}async onSelectedDevicesChanged(t,i){if(this.configProvider.config.enablePermissionsWorkaround&&e.isDeviceListEmpty(t,i))return void this.logger.safe.info("Device list is empty, permission workaround enabled");const n=this.getMediaTypesToUpdate(t,i);this.logger.safe.info(`Media types to update: ${JSON.stringify(n)}`),await Promise.all(n.map((e=>this.updateStream(e,!1))))}async onAudioSharingToggled(e){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&e)return this.updateStream("ScreenShare",!0)}async requestStreamUpdate(e,t,i=!1){if(this.currentMediaTypes.some((t=>t===e))||t)return this.logger.safe.debug(`UpdateStream with media type: ${e}, force: ${t}`),this.updateStream(e,t,i);this.logger.safe.debug(`Stream with media type: ${e} is not active. Do nothing`)}onStreamError(e,t){this.removeStream(e)}onStreamDisposing(e){this.removeStream(e)}static isDeviceListEmpty(e,t){return!e.camera&&!e.microphone||!t.microphone&&!t.camera}getDeviceManagerByType(e){return this.callDeviceManager.getDeviceManager(e)}async updateStreamForVirtualDeviceChange(e){return this.updateStream(e,!1)}};S([dw()],gL.prototype,"update",1),S([dw()],gL.prototype,"stopAsync",1),S([dw()],gL.prototype,"ensureUpdateCompleted",1),S([dw()],gL.prototype,"onSelectedDevicesChanged",1),S([dw()],gL.prototype,"onAudioSharingToggled",1),S([dw()],gL.prototype,"requestStreamUpdate",1),S([dw()],gL.prototype,"updateStreamForVirtualDeviceChange",1);var pL=gL,mL=p,fL=[5e4,1e6,15e5,2e6,25e5,375e4,4e6],SL=[7e4,2e5,4e5,8e5,15e5,2499990,25e5];var vL=class{constructor(e){this.logger=e,this.availableBandwidth=0,this.receivers=new Map,this.currentLayout={},this.ladders={}}setAvailableBandwidth(e){this.availableBandwidth=e,this.logger.safe.debug(`Total available bandwidth updated: ${e}`),this.updateLayouts()}addReceiverCapability(e,t){this.logger.safe.debug(`Receiver maxBr set: ${e}/${t}`),this.receivers.set(e,t),this.updateLayouts()}removeReceiver(e){this.logger.safe.debug(`Receiver maxBr removed: ${e}`),this.receivers.delete(e),this.updateLayouts()}getLayouts(){return this.currentLayout}setLadder(e,t){this.ladders[e]=t}updateLayouts(){const e=this.generateLayouts();(0,mL.isEqual)(e,this.currentLayout)||(this.currentLayout=e,this.logger.safe.debug(`Bandwidth distribution updated: ${Ve(e)}`))}generateLayouts(){const e={},t={};for(const i of Object.keys(this.ladders)){const n=this.receivers.get(i);n&&(t[i]=n||Number.MAX_SAFE_INTEGER,e[i]=0)}let i=this.availableBandwidth,n=0;const r=()=>{if(!i)return!1;for(const e of Object.values(t))if(e)return!0;return!1};for(;r();){for(const r of Object.keys(e)){const s=this.ladders[r];let a=s[n]||s[s.length-1];a=Math.min(a,i,t[r]),e[r]+=a,i-=a,t[r]-=a}n++}return e}},yL=class{constructor(e,t,i){this.timeout=t,this.logger=i,this.isFirstTimeDeferred=!0,this.internalCallback=t=>{this.logger.safe.debug(`Trigger reason: ${t}`),e()}}invoke(e){if(this.logger.safe.debug(`Schedule shouldDefer: ${e}`),this.createTimerIfNeeded(e),this.timer)return e?this.startTimer():this.stopTimerAndTrigger();this.internalCallback("request")}dispose(){this.stopTimer()}startTimer(){this.timer.isActive||(this.timer.start(this.timeout),this.logger.safe.debug(`Timer started for : ${this.timeout}ms`))}stopTimer(){this.timer?.isActive&&(this.timer.stop(),this.logger.safe.debug("Timer stopped"))}stopTimerAndTrigger(){this.stopTimer(),this.internalCallback("request")}createTimerIfNeeded(e){e&&this.isFirstTimeDeferred&&(this.isFirstTimeDeferred=!1,this.timer=new Dm((()=>{this.internalCallback("timeout"),this.timer=null})))}},CL=class{constructor(e){this.logger=e,this.currentFrameSize=ZA.Send.initialResolution.fs}setAvailableBandwidth(e){e!==this.lastSendBW&&(this.logger.safe.debug(`Available bandwidth updated ${e}`),this.processEstimatedBandwidth(e))}setMaxFrameSize(e){this.logger.safe.debug(`SetMaxFrameSize ${e}`),e!==this.maxFrameSize?(this.maxFrameSize=e,this.lastSendBW?(this.logger.safe.debug(`Setting max frame size: ${e}`),this.processEstimatedBandwidth(this.lastSendBW)):this.logger.safe.debug("Last send bwe is not defined. Do nothing")):this.logger.safe.debug(`Max frame size did not change. Do nothing, maxFs: ${e}`)}getFrameSize(){return this.currentFrameSize}processEstimatedBandwidth(e){if(this.logger.safe.debug(`Process estimated bandwidth ${e}`),0===e)return this.lastSendBW=0,void this.proposeResolution(0);const{lowRes:t,highRes:i}=ZA.Send.getResolutionForBitrate(e);this.logger.safe.debug("low",t,"hi",i);const n=e<this.lastSendBW?i.fs:t.fs;e<this.lastSendBW&&this.currentFrameSize<n?this.logger.safe.debug(`proposed resolution is above the existing one, so we should stay on the current resolution, last bw: ${e}`):(n&&this.proposeResolution(n),this.logger.safe.debug(`Updating last bw: ${e}`),this.lastSendBW=e)}proposeResolution(e){this.logger.safe.debug(`Propose resolution ${e}`);const t=this.maxFrameSize?Math.min(e,this.maxFrameSize):e;t!==this.currentFrameSize&&(this.currentFrameSize=t,this.logger.safe.debug(`Proposed new frame size: ${t} based on bandwidth: ${this.lastSendBW}`))}},_L=[{bwe:2e5,param:5e5},{bwe:5e5,param:12e5},{bwe:8e5,param:25e5},{bwe:12e5,param:4e6}],EL=[{bwe:2e5,param:240},{bwe:3e5,param:405},{bwe:5e5,param:920},{bwe:9e5,param:2040}],TL=(e,t,i)=>{for(const n of i)if(t<n.bwe)return Math.min(e,n.param);return e},IL=(e,t,i=_L)=>TL(e,t,i),bL=class extends ze{constructor(e,t,i){super(t),this.configProvider=e,this.logger=t,this.layoutsNumber=i,this.totalBandwidth=1e8,this.totalBandwidthMax=0,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),this.outputLayouts=null,super.dispose()}setAvailableBandwidth(e){this.storeAvailableBandwidth(e),this.inputLayouts?(this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.debug("Layouts are not set. Skip update")}setLayouts(e,t){this.storeAvailableBandwidth(t),e.length===this.layoutsNumber?(this.logger.safe.debug(`Set layouts: ${JSON.stringify(e)}`),this.inputLayouts=this.getPrioritizedLayouts(e),this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.warn(`Incorrect number of layouts! ${JSON.stringify(e)}, expected ${this.layoutsNumber}`)}getLayouts(){return this.inputLayouts}getPrioritizedLayouts(e){return e}checkForChangesAndNotify(){const e=this.getLayouts();ht(this.outputLayouts,e)?this.logger.safe.debug("Layout has not changed, skip update"):(this.outputLayouts=e.slice(),this.event("onLayoutsChanged").raise())}storeAvailableBandwidth(e){this.logger.safe.debug(`Set available bandwidth: ${e}`),this.totalBandwidth=e,this.totalBandwidthMax=Math.max(this.totalBandwidthMax,this.totalBandwidth)}},AL=class extends bL{constructor(e,t){super(e,t,2),this.resolutionManager=new CL(this.logger.createChild("BWEControlledResolutionManager"))}getLayouts(){return this.hiFiLayout?[this.loFiLayout,this.hiFiLayout]:[this.loFiLayout]}dispose(){super.dispose(),this.resolutionManager=null}getHighLayoutBandwidth(e){const t=this.inputLayouts?.[0].maxBr||0,i=Math.max(e-t,0);this.logger.safe.debug(`Setting available bandwidth for layouts. High: ${i}, low: ${t||"not set"}, total: ${e}`);const n=this.configProvider.config.specCompliantSimulcast?.allowedBweOvershootRatio||1;return Math.floor(i*n)}recalculateLayouts(){const e=this.hiFiLayout,t=this.getHighLayoutBandwidth(this.totalBandwidth);this.resolutionManager.setAvailableBandwidth(t),this.resolutionManager.setMaxFrameSize(this.inputLayouts[1].maxFs),this.loFiLayout=this.getMinimalLayoutParams(this.inputLayouts),this.hiFiLayout=this.getHighLayoutParams(this.inputLayouts,t,this.loFiLayout),this.loFiLayout=this.adjustLowLayoutBasedOnHighLayout(this.hiFiLayout,this.loFiLayout,e)}adjustLowLayoutBasedOnHighLayout(e,t,i){return this.configProvider.config.useMediaQualityControllerForceKeyFrame&&!e&&i&&(this.logger.safe.debug("Forcing kayframe on low layout due to disabling high layout"),t.keyframe=!0),e?(t.maxBr===e.maxBr&&t.maxBr--,t):t}getPrioritizedLayouts(e){return e.sort(((e,t)=>e.maxFs-t.maxFs?e.maxFs-t.maxFs:e.maxFps-t.maxFps))}getHighLayoutParams(e,t,i){const n=e[1];if(n.maxBr<=t)return this.logger.safe.debug(`High layout bandwidth suits requested caps. Applying as-is: ${JSON.stringify(n)}`),n;const r={...e[1],maxFs:this.resolutionManager.getFrameSize(),maxBr:Math.min(t,e[1].maxBr),maxFps:e[1].maxFps},s=r.maxBr<i.maxBr||r.maxFs<i.maxFs||r.maxFs===i.maxFs&&r.maxFps<=i.maxFps,a=`Potential high layout: ${JSON.stringify(r)}`;return!this.hiFiLayout&&s?(this.logger.safe.debug(`High layout is already disabled. Do nothing. ${a}`),null):this.hiFiLayout&&s?(this.logger.safe.debug(`High layout gets disabled. ${a}`),null):(this.hiFiLayout&&ht(r,this.hiFiLayout)?this.logger.safe.debug(`High layout has not been changed. Do nothing. ${a}`):this.hiFiLayout?this.logger.safe.debug(`High layout updated. ${a}`):this.logger.safe.debug(`High layout enabled. ${a}`),r)}getMinimalLayoutParams(e){const t=Math.min(e[0].maxBr,e[1].maxBr),i=this.configProvider.config.specCompliantSimulcast.maxBrControlEnabled?IL(t,this.totalBandwidth,this.configProvider.config.specCompliantSimulcast.bitrateToBweTable):t;return{...e[0],maxBr:i,maxFps:Math.min(e[0].maxFps,e[1].maxFps),maxFs:Math.min(e[0].maxFs,e[1].maxFs)}}},RL=class extends bL{constructor(e,t,i){super(t,i,1),this.couldLimitFs=e}getLayouts(){return[this.layout]}recalculateLayouts(){let e=this.inputLayouts[0].maxFs;if(this.configProvider.config.specCompliantSimulcast.allowResLimit&&this.couldLimitFs&&this.totalBandwidthMax){const t=this.configProvider.config.specCompliantSimulcast.fsToBweTable;e=((e,t,i=EL)=>TL(e,t,i))(this.inputLayouts[0].maxFs,this.totalBandwidthMax,t)}const t=this.configProvider.config.specCompliantSimulcast.bitrateToBweTable,i=IL(this.inputLayouts[0].maxBr,this.totalBandwidth,t);this.layout={...this.inputLayouts[0],maxFs:e,maxBr:i}}},wL=class extends ze{constructor(e){super(e),this.logger=e,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),super.dispose()}setAvailableBandwidth(e){this.logger.safe.debug(`Available bandwidth updated ${e}`)}setLayouts(e,t){this.layouts=e,this.setAvailableBandwidth(t)}getLayouts(){return this.layouts}},PL=class extends ze{constructor(e,t,i,n){super(n),this.supportSingleBwControl=e,this.configProvider=i,this.logger=n,this.multiStream=!1,this.deferredOperation=new yL((()=>this.updateStrategy()),this.configProvider.config.layoutControlTimeout,this.logger.createChild("DeferredOperation")),this.createStrategy(this.multiStream,t)}configure(e){const t=this.isMultiStream(e);this.multiStream!==t&&(this.multiStream=t,this.deferredOperation.invoke(this.multiStream&&!this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled))}setLayouts(e,t){ht(this.latestLayouts,e)&&this.latestBandwidth===t?this.logger.safe.debug("Layouts and bandwidth are not changed. Skipping update"):(this.latestLayouts=e,this.latestBandwidth=t,this.strategy.setLayouts(this.latestLayouts,t))}setAvailableBandwidth(e){this.latestBandwidth!==e?(this.strategy.setAvailableBandwidth(e),this.latestBandwidth=e):this.logger.safe.debug("Bandwidth is not changed. Skipping update")}getLayouts(){return this.strategy.getLayouts()}dispose(){this.strategy.dispose(),this.strategy=null,this.deferredOperation.dispose(),this.deferredOperation=null,super.dispose()}updateStrategy(){this.strategy.dispose(),this.createStrategy(this.multiStream),this.latestLayouts&&this.strategy.setLayouts(this.latestLayouts,this.latestBandwidth)}isMultiStream(e){return e>1}createStrategy(e,t=!1){this.strategy=this.getNewStrategy(e,t),this.strategy.on("onLayoutsChanged",(()=>{this.event("onLayoutsChanged").raise()}))}getNewStrategy(e,t){return e?new AL(this.configProvider,this.logger.createChild("BWEControlledStrategy")):this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled&&this.supportSingleBwControl?new RL(t,this.configProvider,this.logger.createChild("BWEControlledStrategySingle")):new wL(this.logger.createChild("NoControlStrategy"))}},ML=class extends ze{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.bandwidthAllocator=null,this.sendBandwidthCalculator=new DN(this.configProvider,this.logger.createChild("SendBandwidthCalculator")),this.layoutProviders=new Map,this.hadLayoutProvider=new Set,this.bandwidthAllocator=function(e,t){const i=new vL(e.createChild("BandwidthAllocator"));return i.setLadder("ScreenShare",t.config.sharingBitrateLadderOverride||fL),i.setLadder("Video",t.config.videoBitrateLadderOverride||SL),i}(this.logger,this.configProvider),this.sendBandwidthCalculator.on("onSendBandwidthChanged",(e=>this.onAvailableBandwidthChanged(e)))}dispose(){this.bandwidthAllocator=null,this.layoutProviders.forEach((e=>e.dispose())),this.layoutProviders.clear(),this.layoutProviders=null,super.dispose()}addReceiver(e,t){this.logger.safe.debug(`Set receiver max capabilities for ${e}: ${JSON.stringify(t)}`),this.configureProviders(e,t.length);const i=t.map((e=>e.maxBr)).reduce(((e,t)=>e+t));this.bandwidthAllocator.addReceiverCapability(e,i);const n=this.bandwidthAllocator.getLayouts();this.layoutProviders.get(e).setLayouts(t,n[e]),this.updateBandwidthDistribution()}removeReceiver(e){this.logger.safe.debug(`Removing receiver for ${e}`),this.layoutProviders.get(e)?.dispose(),this.layoutProviders.delete(e),this.bandwidthAllocator.removeReceiver(e),this.updateBandwidthDistribution()}getLayouts(e){return this.layoutProviders.get(e).getLayouts()}onStatisticsChanged(e){this.sendBandwidthCalculator.onBandwidthChanged(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){e.video?.send?.length&&e.video?.send[0]&&this.sendBandwidthCalculator.onBandwidthChanged(MN(e.video.send[0],this.configProvider))}configureProviders(e,t){if(!this.layoutProviders.has(e)){const t=this.createProvider(e);this.layoutProviders.set(e,t)}this.layoutProviders.get(e).configure(t)}createProvider(e){const t=new PL("Video"===e,!this.hadLayoutProvider.has(e),this.configProvider,this.logger.createChild(`LG:${e}`));return t.on("onLayoutsChanged",(()=>{const i=t.getLayouts();this.logger.safe.debug(`New layouts generated: ${JSON.stringify(i)}`),this.event("onLayoutsUpdated").raise(e)})),this.hadLayoutProvider.add(e),t}onAvailableBandwidthChanged(e){this.bandwidthAllocator.setAvailableBandwidth(e),this.updateBandwidthDistribution()}updateBandwidthDistribution(){const e=this.bandwidthAllocator.getLayouts();for(const[t,i]of Object.entries(e))this.layoutProviders.get(t)?.setAvailableBandwidth(i)}},DL=p;function OL(e,t,i){if("Video"!==e||!i)return i;const{maxBitrate:n,maxResolution:r,maxFramerate:s}=t.config.outgoingVideoLimit??{},a=n??1/0,o=r?(e=>ZA.Send.getResolutionForHeight(e).fs)(r):1/0,c=s??1/0;return a===1/0&&o===1/0&&c===1/0?i:i.map((e=>({...e,maxFs:tt(e.maxFs,o),maxBr:tt(e.maxBr,a),maxFps:tt(e.maxFps,c)})))}var kL=class{constructor(e,t,i,n,r){this.sender=e,this.streamResolution=t,this.maxSimulcastLayerCount=i,this.logger=n,this.configProvider=r}async setCapabilities(e){if(!(0,DL.isEqual)(this.currentCapabilities,e))return this.defaultCapabilities=(0,DL.cloneDeep)(e),this.currentCapabilities=(0,DL.cloneDeep)(e),await this.generateKeyFrameIfNeeded(e),this.applyCapabilities(e,0);this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`)}async updateStreamQualityParams(e,t,i){if(e&&!(0,DL.isEqual)(this.streamResolution,e))return this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.streamResolution=e,this.applyCapabilities(this.currentCapabilities,i);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async stop(){return this.logger.safe.info("Stopping senders."),this.deactivateSenders()}applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.currentCapabilities=OL(this.sender.mediaType,this.configProvider,this.defaultCapabilities),this.applyCapabilities(this.currentCapabilities,3)}getScaleFactor(e){const t=ZA.Send.getResolutionByFs(e),i=this.streamResolution;let n=Math.min(i.width,i.height)/t.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(i)} and new Fs: ${e} as ${n}`),n<1&&(this.logger.safe.error("Scale factor cannot be less than 1! Limiting to 1"),n=1),n}deactivateSenders(){const e=this.sender.rtpSender.getParameters();return e.encodings.forEach((e=>e.active=!1)),this.logger.safe.info(`Stopping senders. Encoding params to set: ${JSON.stringify(e.encodings)}`),this.sender.rtpSender.setParameters(e)}async generateKeyFrameIfNeeded(e){const t=this.sender.rtpSender.getParameters(),i=[];if(e.forEach((e=>{const n=this.getEncondingIndexForRid(e.rid,t.encodings),r=t.encodings[n];e.keyframe&&r.active?(this.logger.safe.info(`Keyframe is needed for encoder with index ${n}`),i.push(n)):this.logger.safe.info(`Keyframe is not needed for index ${n} because encoding is active: ${r.active} or KF is requested: ${e.keyframe}`)})),0===i.length)return void this.logger.safe.info("No keyframes needed. Skipping");const n=this.getParamsForKeyFrame(t,i);return this.logger.safe.info(`Applying keyframe encoding params new: ${JSON.stringify(n.encodings)}, old: ${JSON.stringify(t.encodings)}`),this.sender.rtpSender.setParameters(n)}async applyCapabilities(e,t){if(!e)return void this.logger.safe.info("Capabilities are not set. Do nothing");await this.applyStreamCapabilities(e,t);const i=this.sender.rtpSender.getParameters(),n=(0,DL.cloneDeep)(i);return e.forEach((e=>{const t=this.getEncondingIndexForRid(e.rid,i.encodings);this.updateEncodingsWithCaps(i.encodings[t],e)})),this.updateActiveStates(i,e),this.logger.safe.info(`Encoding params new: ${JSON.stringify(i.encodings)}, old: ${JSON.stringify(n.encodings)}`),this.sender.rtpSender.setParameters(i)}async applyStreamCapabilities(e,t){if(!this.configProvider.config.specCompliantSimulcast?.video?.useApplyConstraints||2===t||!e.length||"Video"!==this.sender.mediaType)return;let i=e[0];for(const t of e)i.maxFs<t.maxFs&&(i=t);e.length>1&&(i=(0,DL.cloneDeep)(i),i.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,i.maxFs)),this.streamResolution=await this.sender.applyStreamCapabilities(i)}getEncondingIndexForRid(e,t){if(!e)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const i=t.findIndex((t=>t.rid===e));return i<0||i-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):i}updateEncodingsWithCaps(e,t){e?(e.maxBitrate=t.maxBr,e.scaleResolutionDownBy=this.getScaleFactor(t.maxFs),e.maxFramerate=t.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(t)}`)}updateActiveStates(e,t){const i=e.encodings.map((e=>e.rid)),n=i.filter((e=>t.some((t=>e===t.rid)))),r=St(i,n);n.forEach((t=>this.changeEncodingState(e,t,!0))),r.forEach((t=>this.changeEncodingState(e,t,!1)))}changeEncodingState(e,t,i){const n=e.encodings.find((e=>e.rid===t));n?n.active=i:this.logger.safe.error(`Encoding not found for RID: ${t}`)}getParamsForKeyFrame(e,t){const i=(0,DL.cloneDeep)(e);return t.forEach((e=>{i.encodings[e].active&&i.encodings[e].scaleResolutionDownBy&&(i.encodings[e]=this.getEncodingParamsForKeyFrame(i.encodings[e]))})),i}getEncodingParamsForKeyFrame(e){const t=(0,DL.cloneDeep)(e);return t.scaleResolutionDownBy&&(t.scaleResolutionDownBy=1.1*e.scaleResolutionDownBy),t}},NL=class{constructor(e,t,i){this.sender=e,this.logger=t,this.configProvider=i}applyCallConstraints(e){this.logger.safe.info(`[${e}] Applying call constraints`);const t=OL(this.sender.mediaType,this.configProvider,this.currentCapabilities);return this.setCapabilities(t)}async setCapabilities(e){if(0===e.length||1!==e.length)return void this.logger.safe.error("Incorrect number of sender params!");this.currentCapabilities=e;const t=this.currentCapabilities?.find((e=>"1"===e.rid))??this.currentCapabilities?.[0];await this.sender.setParameters(t),await this.sender.start()}updateStreamQualityParams(e,t,i){return this.sender.updateStreamQualityParams(e,t,i)}async stop(){await this.sender.stop()}},LL=p,xL=new Set(["maintain-framerate","maintain-resolution","balanced"]),UL=class{constructor(e,t){this.configProvider=e,this.logger=t}async setActive(e,t){const i=this.getSenderParameters(e);return i.encodings[0].active=t,this.setSenderParameters(e,i,"setActive")}getScaleFactor(e,t){if(!t.width||!t.height)return this.logger.safe.warn("Stream resolution is not set yet. Cannot calculate scale factor. Returning 1"),1;const i=ZA.Send.getResolutionByFs(e);let n=Math.min(t.width,t.height)/i.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(t)} and new Fs: ${e} as ${n}`),n<1&&(this.logger.safe.warn("Scale factor cannot be less than 1! Limiting to 1"),n=1),n}async generateKeyFrameIfNeeded(e,t){if(!t.track)return void this.logger.safe.info("No track attached. Skipping");const i=this.getSenderParameters(t),n=e.filter((e=>e.keyframe)).map((e=>e.rid));if(0!==n.length&&i.encodings.some((e=>e.active)))if(this.configProvider.config.useKeyFrameApi){const e=[];i.encodings.forEach((t=>{!t.active||t.rid&&!n.includes(t.rid)?e.push({keyFrame:!1}):e.push({keyFrame:!0})})),await this.setSenderParameters(t,i,"generateKeyFrameAPI",!0,{encodingOptions:e})}else{const e=i.encodings.map(((e,t)=>e.active?e.rid&&!n.includes(e.rid)?null:{idx:t,factor:e.scaleResolutionDownBy||1}:null)).filter((e=>e));for(const t of e)i.encodings[t.idx].scaleResolutionDownBy=t.factor*this.configProvider.config.forceKeyFrameV2ScaleFactor;this.logger.safe.debug(`Restoring keyframe starting. Update scaleResolutionDownBy for encodings: ${JSON.stringify(i.encodings)}`),await this.setSenderParameters(t,i,"generateKeyFrameStart");const r=this.getSenderParameters(t);for(const t of e)r.encodings[t.idx].scaleResolutionDownBy=t.factor;await this.setSenderParameters(t,r,"generateKeyFrameEnd"),this.logger.safe.debug(`Restoring keyframe completed. Set scaleResolutionDownBy back for encodings: ${JSON.stringify(r.encodings)}`)}else this.logger.safe.info("No keyframes needed. Skipping")}getSenderParameters(e){const t=e.getParameters();if(t.encodings?.length||(t.encodings=[{}]),this.configProvider.config.reuseLastSetParameters&&this.lastSetEncodings){this.logger.safe.info(`Override returned encodings ${JSON.stringify(t.encodings)}`);const e=(0,LL.merge)((0,LL.cloneDeep)(t.encodings),this.lastSetEncodings);this.logger.safe.info(`Overrided encodings ${JSON.stringify(e)}`),t.encodings=e}return t}async setSenderParameters(e,t,i,n=!0,r){try{await e.setParameters(t,r),this.logger.safe.info(`${i}: Parameters applied for sender: encodings: ${JSON.stringify(t.encodings)}, degradationPreference: ${t.degradationPreference}`),this.lastSetEncodings=t.encodings}catch(e){const r=`${i}: setParameters failed. Parameters: ${JSON.stringify(t.encodings)}, error:  ${Ve(e)}`;if(this.logger.safe.error(r),n)throw new Error(r)}}getAdjustedBitrate(e,t){let i=e||0;const n=ZA.Send.getResolutionRecord(t.width,t.height);return i=Math.min(i||n.maxBitrate,n.maxBitrate),i}async updateStreamParameters(e,t,i){if(e.getCurrentConstraints().withEffect&&t?.maxFs){const i=ZA.Send.getResolutionByFs(t.maxFs),n={width:i.width,height:i.height};this.logger.safe.info(`Applying video constrains for video effetcs ${JSON.stringify(n)}`),e.resetEffectsOutputConstraints(n)}i&&await e.applyCapabilities(t)}augmentDegradationPreference(e,t){xL.has(t)&&e.degradationPreference!==t&&(e.degradationPreference=t,this.logger.safe.info(`degradationPreference changed to: ${e.degradationPreference}`))}},FL=class{constructor(e,t,i){this.maxSimulcastLayerCount=e,this.configProvider=t,this.logger=i,this.capabiltiesHelper=new UL(this.configProvider,this.logger)}setSender(e){this.rtpSender=e}updateStream(e){this.stream=e,this.streamResolution=e.getResolution()}setActive(e){return this.capabiltiesHelper.setActive(this.rtpSender,e)}async setCapabilities(e){(0,LL.isEqual)(this.currentCapabilities,e)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`):(this.defaultCapabilities=(0,LL.cloneDeep)(e),this.currentCapabilities=(0,LL.cloneDeep)(e),await this.applyLastCapabilities(),await this.capabiltiesHelper.generateKeyFrameIfNeeded(e,this.rtpSender))}async updateStreamQualityParams(e,t,i){if(e&&!(0,LL.isEqual)(this.streamResolution,e))return this.streamResolution=e,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.applyLastCapabilities();this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async startSender(){}async stopSender(){this.logger.safe.info("Stopping senders.");const e=this.capabiltiesHelper.getSenderParameters(this.rtpSender);return e.encodings.forEach((e=>e.active=!1)),this.capabiltiesHelper.setSenderParameters(this.rtpSender,e,"Stopping senders")}async applyLastCapabilities(){if(!this.currentCapabilities)return void this.logger.safe.info("Capabilities are not set. Do nothing");this.currentCapabilities=OL(this.stream.mediaType,this.configProvider,this.defaultCapabilities),await this.applyStreamCapabilities(this.currentCapabilities);const e=this.capabiltiesHelper.getSenderParameters(this.rtpSender),t=(0,LL.cloneDeep)(e);return this.currentCapabilities.forEach((t=>{const i=this.getEncondingIndexForRid(t.rid,e.encodings);this.updateEncodingsWithCaps(e.encodings[i],t)})),this.capabiltiesHelper.augmentDegradationPreference(e,this.configProvider.config.degradationPreference),this.updateActiveStates(e,this.currentCapabilities),this.logger.safe.info(`Encoding params new: ${JSON.stringify(e.encodings)}, old: ${JSON.stringify(t.encodings)}`),this.capabiltiesHelper.setSenderParameters(this.rtpSender,e,"applyCapabilities")}async applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.applyLastCapabilities()}async applyStreamCapabilities(e){if("Video"!==this.stream.mediaType||!e.length)return;let t=e[0];for(const i of e)t.maxFs<i.maxFs&&(t=i);e.length>1&&(t=(0,LL.cloneDeep)(t),t.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,t.maxFs));const i=this.configProvider.config.specCompliantSimulcast.video.useApplyConstraints;await this.capabiltiesHelper.updateStreamParameters(this.stream,t,i),i&&(this.streamResolution=this.stream.getResolution())}getEncondingIndexForRid(e,t){if(!e)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const i=t.findIndex((t=>t.rid===e));return i<0||i-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):i}updateEncodingsWithCaps(e,t){e?(e.maxBitrate=t.maxBr,e.scaleResolutionDownBy=this.capabiltiesHelper.getScaleFactor(t.maxFs,this.streamResolution),e.maxFramerate=t.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(t)}`)}updateActiveStates(e,t){const i=e.encodings.map((e=>e.rid)),n=i.filter((e=>t.some((t=>e===t.rid)))),r=St(i,n);n.forEach((t=>this.changeEncodingState(e,t,!0))),r.forEach((t=>this.changeEncodingState(e,t,!1)))}changeEncodingState(e,t,i){const n=e.encodings.find((e=>e.rid===t));n?n.active=i:this.logger.safe.error(`Encoding not found for RID: ${t}`)}},VL=class{constructor(e,t){this.configProvider=e,this.logger=t,this.capabiltiesHelper=new UL(this.configProvider,this.logger)}get params(){return this.currentCapabilities?.find((e=>"1"===e.rid))??this.currentCapabilities?.[0]}async applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.applyLastCapabilities(3)}setSender(e){this.rtpSender=e}updateStream(e){this.stream=e,this.streamResolution=e.getResolution()}setActive(e){return this.capabiltiesHelper.setActive(this.rtpSender,e)}async setCapabilities(e){(0,LL.isEqual)(this.currentCapabilities,e)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`):1===e.length?(this.defaultCapabilities=(0,LL.cloneDeep)(e),this.currentCapabilities=(0,LL.cloneDeep)(e),await this.applyLastCapabilities(0),await this.capabiltiesHelper.generateKeyFrameIfNeeded(e,this.rtpSender)):this.logger.safe.error("Incorrect number of sender params!")}async updateStreamQualityParams(e,t,i){if(e&&!(0,LL.isEqual)(this.streamResolution,e))return this.streamResolution=e,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.applyLastCapabilities(i);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async startSender(e){this.logger.safe.info(`Replace sender with track: ${e.id}`),await this.rtpSender.replaceTrack(e),this.logger.safe.info("replaceTrack completed"),this.configProvider.config.applySenderParamsBeforeStart&&this.currentCapabilities&&await this.capabiltiesHelper.generateKeyFrameIfNeeded(this.currentCapabilities,this.rtpSender)}async stopSender(){this.logger.safe.info("Replace sender with track: null"),await this.rtpSender.replaceTrack(null),this.logger.safe.info("replaceTrack completed")}async applyLastCapabilities(e){this.currentCapabilities?(this.currentCapabilities=OL(this.stream.mediaType,this.configProvider,this.defaultCapabilities),this.logger.safe.info(`Applying params: ${JSON.stringify(this.params)}`),await this.applyParams(this.params,e),await this.applyBitrate(this.params.maxBr)):this.logger.safe.debug("Capabilities are not yet set, nothing to apply")}applyBitrate(e){let t=e||0;return"Video"===this.stream.mediaType&&(t=this.capabiltiesHelper.getAdjustedBitrate(t,this.streamResolution)),this.setSingleEncodingParameters(this.rtpSender,{maxBitrate:t},"applyBitrate",!1)}async applyParams(e,t){if(this.configProvider.config.useSetParametersToApplyCapabilities)return this.setSingleEncodingParameters(this.rtpSender,{scaleResolutionDownBy:this.capabiltiesHelper.getScaleFactor(e.maxFs,this.streamResolution),maxFramerate:e.maxFps},"applyParams");2!==t&&await this.capabiltiesHelper.updateStreamParameters(this.stream,e,!0)}async setSingleEncodingParameters(e,t,i,n=!0){const r=this.capabiltiesHelper.getSenderParameters(e);return(0,LL.merge)(r.encodings[0],t),0===r.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?r.encodings[0].maxBitrate=void 0:delete r.encodings[0].maxBitrate),this.capabiltiesHelper.augmentDegradationPreference(r,this.configProvider.config.degradationPreference),this.capabiltiesHelper.setSenderParameters(this.rtpSender,r,i,n)}},BL=class{constructor(e,t,i){this.transitionStates=e,this.logger=i,this.stateInternal=t}get state(){return this.stateInternal}isDestinationStateValid(e){return this.transitionStates[this.stateInternal].indexOf(e)>-1}setState(e){return this.isDestinationStateValid(e)?(this.stateInternal=e,!0):(this.logger.safe.info(`Invalid state transition ${this.stateInternal} -> ${e}`),!1)}isCurrentStateMatchedWith(e){return this.stateInternal===e||(this.logger.safe.info(`State does not match. Current: ${this.stateInternal} required: ${e}`),!1)}},HL=p,$L=class{constructor(e,t=document.body){this.logger=e,this.parentElement=t,this.container=this.createContainerElement(),this.video=this.createVideoElement(),this.canvas=this.createCanvasElement(),this.context=this.canvas.getContext("2d"),this.medaiQuery=window.matchMedia("(orientation: portrait)"),this.isPortrait=this.medaiQuery.matches,this.captureFrameRate=30,this.mediaQueryChangeListener=e=>{this.isPortrait=e.matches},this.container.append(this.video,this.canvas),this.parentElement.prepend(this.container),this.medaiQuery.addEventListener("change",this.mediaQueryChangeListener)}modify(e){this.logger.safe.info("modify()"),this.clearAnimationFrames(),this.disposeStream(),this.stream=this.canvas.captureStream(this.captureFrameRate),this.video.srcObject=new MediaStream([e]),this.video.play();let t=e.getSettings(),i=0,n=0;const r=()=>{t=e.getSettings();const s=this.isPortrait?Math.min(t.width,t.height):Math.max(t.width,t.height),a=this.isPortrait?Math.max(t.width,t.height):Math.min(t.width,t.height);i===s&&n===a||(this.canvas.width=s,this.canvas.height=a,i=s,n=a),this.context.drawImage(this.video,0,0,s,a),this.animationFrame=requestAnimationFrame(r)};return this.animationFrame=requestAnimationFrame(r),this.stream.getVideoTracks()[0]}dispose(){this.logger.safe.info("dispose()"),this.clearAnimationFrames(),this.disposeStream(),this.container.parentElement.removeChild(this.container),this.medaiQuery.removeEventListener("change",this.mediaQueryChangeListener)}disposeStream(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=void 0)}createContainerElement(){const e=document.createElement("div");return e.style.opacity="0",e.style.position="fixed",e.style.zIndex="-2147483648",e.style.pointerEvents="none",e.style.top="0",e.style.left="0",e.style.bottom="0",e.style.right="0",e}createVideoElement(){const e=document.createElement("video");return e.setAttribute("muted",""),e.setAttribute("playsinline",""),e.setAttribute("autoplay",""),e.style.top="0",e.style.left="0",e}createCanvasElement(){const e=document.createElement("canvas");return e.style.right="0",e.style.bottom="0",e}clearAnimationFrames(){this.logger.safe.info("clearAnimationFrames()"),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}},GL=class extends ze{constructor(e){super(e),this.logger=e,this.audioContext=new Vp.window.AudioContext,this.destination=this.audioContext.createMediaStreamDestination(),this.streamNodeMap=new Map,this.logger.safe.info(`Destination stream: ${this.destination.stream.id}, track: ${this.getDestinationTrack().id}`),this.subscribeOnMediaTrackEvents(this.getDestinationTrack())}get numberOfStreams(){return this.streamNodeMap.size}addSourceStream(e){if(!e.rawStream)return;if(this.streamNodeMap.has(e.rawStream))return;const t=e.on("onStreamClientDisposing",(()=>{this.removeSourceStream(e.rawStream),t.dispose()}));this.logger.safe.info(`Add stream: ${e.rawStream.id}, track: ${jL(e.rawStream).id}`),this.addStream(e.rawStream,e.mediaType)}getDestinationTrack(){return jL(this.destination.stream)}dispose(){super.dispose(),this.unsubscribeFromMediaTrackEvents(this.getDestinationTrack());for(const e of this.streamNodeMap.keys())this.removeSourceStream(e);this.audioContext.close(),this.audioContext=null}addStream(e,t="Audio"){const i=this.audioContext.createMediaStreamSource(e);i.connect(this.destination),this.streamNodeMap.set(e,{mediaType:t,sourceNode:i})}removeSourceStream(e){const t=this.streamNodeMap.get(e);t&&(this.logger.safe.info(`Remove stream: ${e.id}, track: ${jL(e).id}`),t.sourceNode.disconnect(),this.streamNodeMap.delete(e))}subscribeOnMediaTrackEvents(e){e.onended=t=>{this.logger.safe.info(`Track ${e.id} ended: ${JSON.stringify(t)}`)},e.onmute=()=>{this.logger.safe.info(`Track ${e.id} muted`)},e.onunmute=()=>{this.logger.safe.info(`Track ${e.id} unmuted`)}}unsubscribeFromMediaTrackEvents(e){e.onended=null,e.onmute=null,e.onunmute=null}};function jL(e){return e.getAudioTracks()[0]}var qL=class{constructor(e){this.logger=e}createBaseInstanse(e){this.imp=new WL,e.addTransform(this.imp)}createWorkerInstanse(e,t){this.imp=new zL(e,t)}mute(e){this.logger.safe.info(`Dropping audio chunks: ${e}`),this.imp.mute(e)}},WL=class{constructor(){this.transformType=1,this.muted=!1}transform(e){return this.muted?null:e}mute(e){this.muted=e}dispose(){}},zL=class extends KN{constructor(e,t){super(e,t,1,void 0)}mute(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"mute",args:[e]}})}},JL=class extends ze{constructor(e,t,i,n,r,s){super(),this.mediaConnection=e,this.contextStream=i,this.logger=n,this.configProvider=r,this.encStreamsManager=s,this.isActive=!1,this.isMuted=!1,this.configProvider.config.renderThroughCanvas&&(this.videoThroughCanvas=new $L(this.logger.createChild("videoThroughCanvas"))),this.stream=t.clone("streamSender ctor"),this.streamResolution=this.stream.getResolution()}get rtpSender(){return this.sender}get trackId(){const e=this.rawTrack;return e?.id}get mediaType(){return this.stream.mediaType}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get canvasedRawTrack(){return this.configProvider.config.renderThroughCanvas?"Video"!==this.stream.mediaType?this.rawTrack:this.videoThroughCanvas?.modify(this.rawTrack)??this.rawTrack:this.rawTrack}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms()}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.wakeSender(),this.params&&await this.applyParams(this.params,0),this.logger.safe.info("Started"))}async stop(){if(this.isActive){if(this.logger.safe.info("Stopping"),this.isActive=!1,"Audio"!==this.stream.mediaType){const e=this.configProvider.config.webrtcDisabledSenderBitrate;await this.applyBitrate(e,!1)}await this.sleepSender(),this.logger.safe.info("Stopped")}else this.logger.safe.info("Already stopped. Do nothing")}setMuted(e,t,i){this.isMuted=e,this.stream.setMuted(e,t),e&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(e),!this.configProvider.config.requestNewStreamOnUnmute||e||i||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(e,t){return this.activateSender(!e,t)}async setMainStream(e){if(this.stream.dispose(),this.stream=e.clone("streamSender setMainStream"),this.streamResolution=this.stream.getResolution(),this.stream.setMuted(this.isMuted),this.params&&await this.applyCapabilities(this.params,1),this.audioMixer?.addSourceStream(this.stream),this.isActive){const e=this.rawTrack?.id;this.logger.safe.info(`Replace sender with track: ${e}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Replace completed")}}async addAdditionalStream(e){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(e),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}async setParameters(e,t=!1,i=0){if(t||this.params!==e){if(this.params=e,this.isActive)return this.applyParams(this.params,i);this.logger.safe.info("Sender is not active, preserving params")}}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((e=>e.active)).map((e=>+e.rid))}async updateStreamQualityParams(e,t,i){if(this.configProvider.config.useSetParametersToApplyCapabilities)if(e){if(this.logger.safe.debug(`Stream resolution has changed to ${JSON.stringify(e)}@${t}, re-applying send parameters`),this.streamResolution=e,this.params)return this.setParameters(this.params,!0,i);this.logger.safe.debug("Params are not yet set, do nothing")}else this.logger.safe.debug(`Resolution is not defined: ${JSON.stringify(e)}@${t}`)}async applyStreamCapabilities(e){return await this.stream.applyCapabilities(e),this.stream.getResolution()}async applyParams(e,t){this.logger.safe.info(`Applying params: ${JSON.stringify(e)}`),await this.applyCapabilities(e,t),await this.applyBitrate(e.maxBr),this.params.keyframe&&await this.forceKeyframe()}applyBitrate(e,t=!0){const i=t?this.getAdjustedBitrate(e):e;return this.setEncodingParameters({maxBitrate:i},"applyBitrate")}getAdjustedBitrate(e){let t=e||0;if("Video"===this.stream.mediaType){const e=ZA.Send.getResolutionRecord(this.streamResolution.width,this.streamResolution.height);t=Math.min(t||e.maxBitrate,e.maxBitrate)}return t}async activateSender(e,t){await this.setEncodingParameters({active:e},"activateSender"),this.logger.safe.info(`[${t}] Active state applied isActive = ${e}`)}async forceKeyframe(){if(!this.sender)return this.logger.safe.error("No sender available"),null;if(!this.sender.track)return void this.logger.safe.info("Sender track does not exist, not restoring keyframe");this.logger.safe.info("Restoring keyframe starting");const e=this.getSenderParameters().encodings[0].scaleResolutionDownBy||1;await this.setEncodingParameters({scaleResolutionDownBy:e*this.configProvider.config.forceKeyFrameV2ScaleFactor},"forceKeyframe start"),await this.setEncodingParameters({scaleResolutionDownBy:e},"forceKeyframe end"),this.logger.safe.info("Restoring keyframe finished")}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ve(e)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ve(e)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.canvasedRawTrack,this.contextStream,lm(this.stream.mediaType))}async wakeSender(){this.logger.safe.info("Wake started"),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Wake completed")}async sleepSender(){this.logger.safe.info("Sleep started"),await this.sender.replaceTrack(null),this.logger.safe.info("Sleep completed")}addStreamTransforms(){const e=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);e&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new qL(this.logger.createChild("SendAudioPayload")),e.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&e.addTransform(new YN(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new GL(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const e=this.sender.getParameters();return e.encodings?.length||(e.encodings=[{}]),e}async setEncodingParameters(e,t,i=!1){const n=this.getSenderParameters();(0,HL.merge)(n.encodings[0],e),0===n.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?n.encodings[0].maxBitrate=void 0:delete n.encodings[0].maxBitrate);try{await this.sender.setParameters(n),this.logger.safe.info(`${t}: Parameters applied for sender: ${JSON.stringify(n.encodings[0])}`)}catch(e){if(this.logger.safe.error(`${t}: setParameters failed: ${Ve(e)}, parameters ${JSON.stringify(n.encodings[0])}`),i)throw e}}async applyCapabilities(e,t){this.configProvider.config.useSetParametersToApplyCapabilities?await this.setEncodingParameters({scaleResolutionDownBy:this.getScaleFactor(e.maxFs),maxFramerate:e.maxFps},"applyCapabilities",!0):2!==t&&await this.applyStreamCapabilities(e)}getScaleFactor(e){const t=ZA.Send.getResolutionByFs(e),{width:i,height:n}=this.streamResolution,r=Math.min(i,n)/t.height;return this.logger.safe.debug(`Current stream resolution: ${i}x${n}, scale factor: ${r}`),r<1?(this.logger.safe.warn(`Resolution scale factor is less than 1: ${r}`),1):r}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.stream=null,this.isActive=!1,this.videoThroughCanvas?.dispose()}},KL=class extends ze{constructor(e,t,i,n,r,s,a){super(),this.mediaConnection=e,this.contextStream=i,this.logger=n,this.configProvider=r,this.encStreamsManager=s,this.capabilitiesManager=a,this.isActive=!1,this.isMuted=!1,this.stream=t.clone("streamSender ctor"),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.updateStream(this.stream)}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get trackId(){const e=this.rawTrack;return e?.id}get rtpSender(){throw new Error("rtpSender getter not implemented.")}get mediaType(){throw new Error("mediaType getter not implemented.")}setParameters(e){throw new Error("setParameters not implemented.")}applyStreamCapabilities(e){throw new Error("applyStreamCapabilities not implemented.")}applyCallConstraints(e){return this.capabilitiesManager.applyCallConstraints(e)}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms(),this.capabilitiesManager.setSender(this.sender)}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.capabilitiesManager.startSender(this.rawTrack),this.logger.safe.info("Started"))}async stop(){this.isActive?(this.logger.safe.info("Stopping"),this.isActive=!1,await this.capabilitiesManager.stopSender(),this.logger.safe.info("Stopped")):this.logger.safe.info("Already stopped. Do nothing")}async setCapabilities(e){this.configProvider.config.applySenderParamsBeforeStart||await this.start(),await this.capabilitiesManager.setCapabilities(e),await this.start()}updateStreamQualityParams(e,t,i){return this.capabilitiesManager.updateStreamQualityParams(e,t,i)}setMuted(e,t,i){this.isMuted=e,this.stream.setMuted(e,t),e&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(e),!this.configProvider.config.requestNewStreamOnUnmute||e||i||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(e,t){if(this.configProvider.config.holdSkipActivation)return;const i=!e;this.logger.safe.info(`[${t}] change isActive state to ${i}`);try{return this.capabilitiesManager.setActive(i)}catch(e){const n=this.configProvider.config.holdRetryActivationDelay;if(n>=0)return this.logger.safe.info(`[${t}] retrying after delay of ${n}`),await yi(n),this.logger.safe.info(`[${t}] change isActive state to ${i}, second attempt`),this.capabilitiesManager.setActive(i);throw e}}async setMainStream(e){return this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=e.clone("streamSender setMainStream"),this.stream.setMuted(this.isMuted),this.audioMixer?.addSourceStream(this.stream),this.isActive&&(this.logger.safe.info(`Replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("Replace completed")),this.capabilitiesManager.updateStream(this.stream),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.applyLastCapabilities(1)}async addAdditionalStream(e){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(e),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((e=>e.active)).map((e=>+e.rid))}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ve(e)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ve(e)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.rawTrack,this.contextStream,lm(this.stream.mediaType))}addStreamTransforms(){const e=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);e&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new qL(this.logger.createChild("SendAudioPayload")),e.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&e.addTransform(new YN(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new GL(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const e=this.sender.getParameters();return e.encodings?.length||(e.encodings=[{}]),e}subscribeOnStreamClientMuted(){this.configProvider.config.recoverOnStreamUnmute&&(this.onStreamClientMutedSubscription=this.stream.on("onStreamClientMuted",(async(e,t)=>{t||await this.capabilitiesManager.applyLastCapabilities(1)})))}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=null,this.isActive=!1}},YL=class e extends ze{constructor(t,i,n,r,s,a,o,c,l,d){super(),this.mediaConnection=t,this.mainStream=i,this.contextStream=n,this.mediaType=r,this.serialQueue=s,this.logger=a,this.configProvider=o,this.isAlwaysActive=c,this.encStreamsManager=l,this.simulcastContext=d,this.isMuted=!1,this.isHold=!1,this.previousParameters=[],this.state=new BL(e.transitionStates,"NotStarted",this.logger),this.pendingStream=null,this.pendingParams=null,this.subscribeOnQualityUpdates(this.mainStream)}async start(){this.state.setState("Started")&&(this.sender=this.createSenderModel(),await this.sender.init(),this.notifyMaxVideoSendCapabilitiesChanged(),this.configProvider.config.deactiveAudioSender&&"Audio"===this.mediaType&&await this.sender.stop(),this.subscribeForSenderEvents())}async activate(){this.state.setState("Active")&&(this.pendingStream&&(await this.updateStreamInternal(this.pendingStream),this.pendingStream=null),this.isAlwaysActive&&!this.isMuted&&"Audio"===this.mediaType&&await this.sender.start(),this.isAlwaysActive?(this.event("onSendersChanged").raise(this,!0),this.logger.safe.info("Sender set to always active. Do not stopping")):await this.capabilitiesManager.stop(),this.configProvider.config.enableCachingFMTP&&this.pendingParams&&(this.logger.safe.info("Apply pending parameters"),await this.updateParametersInternal(this.pendingParams),this.pendingParams=null))}updateStream(e){return this.updateStreamInternal(e)}async addAdditionalStream(e){return this.sender.addAdditionalStream(e)}async updateParameters(e){if(this.state.isCurrentStateMatchedWith("Active"))return this.updateParametersInternal(e);this.configProvider.config.enableCachingFMTP?(this.logger.safe.info("Postpone params update until sender is activated"),this.pendingParams=e):this.logger.safe.warn("Ignore params update as sender is not activate")}async terminateAsync(){this.state.setState("Disposed")&&(this.logger.safe.info("Terminating async"),await this.sender.terminateAsync(),this.cleanUp())}dispose(){this.state.setState("Disposed")&&(this.logger.safe.info("Disposing"),this.sender.dispose(),this.cleanUp())}async setHold(e,t){if(this.isHold!==e)return this.logger.safe.info(`[${t}] Setting hold to: ${e}`),this.isHold=e,this.sender.setHold(e,t);this.logger.safe.info(`[${t}] Already in hold=${e} state`)}setMuted(e,t,i){this.logger.safe.info(`[${t}] Setting muted to: ${e}`),this.isMuted=e,this.sender.setMuted(this.isMuted,t,i),!this.isMuted&&"Audio"===this.mediaType&&this.state.isCurrentStateMatchedWith("Active")&&this.sender.start()}getActiveStreamIndexes(){return this.sender?this.sender.getActiveStreamIndexes():[]}getTrackInfo(){return{modality:lm(this.mediaType),trackId:this.sender.trackId}}applyCallConstraints(e){return this.capabilitiesManager.applyCallConstraints(e)}createSenderModel(){if(this.configProvider.config.useSenderV2){const e=new KL(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("SenderV2"),this.configProvider,this.encStreamsManager,this.getCapabilitiesManagerV2(this.simulcastContext));return this.capabilitiesManager=e,e}const e=new JL(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("Sender"),this.configProvider,this.encStreamsManager);return this.capabilitiesManager=this.getCapabilitiesManager(e,this.simulcastContext),e}subscribeForSenderEvents(){this.sender.on("onNewStreamNeeded",(()=>this.event("onNewStreamNeeded").raise()))}getCapabilitiesManager(e,t){return t?.shouldUseSimulcast()?new kL(e,this.mainStream.getResolution(),t.config.layerScaleFactors.length,this.logger.createChild("SimCapMgr"),this.configProvider):new NL(e,this.logger.createChild("SnglCapMgr"),this.configProvider)}getCapabilitiesManagerV2(e){return e?.shouldUseSimulcast()?new FL(e.config.layerScaleFactors.length,this.configProvider,this.logger.createChild("SimCapMgrV2")):new VL(this.configProvider,this.logger.createChild("SnglCapMgrV2"))}async updateStreamInternal(e){return this.state.isCurrentStateMatchedWith("Active")?this.mainStream!==e?(this.logger.safe.debug(`Switching streams: ${this.mainStream.parentId}:${this.mainStream.id} -> ${e.parentId}:${e.id}`),this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=e,this.subscribeOnQualityUpdates(this.mainStream),this.notifyMaxVideoSendCapabilitiesChanged(),await this.sender.setMainStream(this.mainStream),this.capabilitiesManager.updateStreamQualityParams(this.mainStream.getResolution(),this.mainStream.getFrameRate(),1)):void this.logger.safe.info("Stream has not been changed. Skipping update"):(this.logger.safe.info("Postponing stream update until sender is activated"),void this.setPendingStream(e))}async updateParametersInternal(e){await this.capabilitiesManager.setCapabilities(e),function(e,t,i){const n=[];return e.forEach((e=>{t.some((t=>i(e,t)))||n.push(e)})),0===n.length&&e.length===t.length}(this.previousParameters,e,((e,t)=>e.ssrc===t.ssrc))||(this.previousParameters=e,this.event("onSendersChanged").raise(this,!0))}setPendingStream(e){this.pendingStream=e;const t=e.on("onStreamClientDisposing",(()=>{this.pendingStream===e&&(this.pendingStream=null,t.dispose())}))}subscribeOnQualityUpdates(e){this.sub=e.on("onStreamQualityChanged",((e,t,i,n)=>this.updateStreamQualityParams(t,i,n)))}updateStreamQualityParams(e,t,i){return i===fu.EffectQualityChangeReason.Performance&&this.notifyMaxVideoSendCapabilitiesChanged({resolution:e,fps:t}),this.capabilitiesManager.updateStreamQualityParams(e,t,2)}unsubscribeFromQualityEvents(){this.sub?.dispose(),this.sub=null}notifyMaxVideoSendCapabilitiesChanged(e){if(!["Video","ScreenShare"].includes(this.mediaType))return;const{width:t,height:i}=e?.resolution??this.mainStream.getResolution(),n=e?.fps??this.mainStream.getFrameRate();if(!t||!i||!n)return;const r=new QA(t,i),s={maxFs:r.fs,maxMbps:r.fs*n,maxFps:n,maxWidth:r.width,maxHeight:r.height};this.logger.safe.info(`Capabilities for ${this.mediaType} stream: ${JSON.stringify(s)}`),this.event("onMaxVideoSendCapabilitiesChanged").raise(s)}cleanUp(){this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=null,this.pendingStream&&this.pendingStream.dispose(),this.pendingStream=null,this.sender=null,this.contextStream=null,this.event("onSendersChanged").raise(this,!1),super.dispose()}};YL.transitionStates={NotStarted:["Started","Disposed"],Started:["Active","Disposed"],Active:["NotStarted","Disposed"],Disposed:[]},S([dw()],YL.prototype,"start",1),S([dw()],YL.prototype,"activate",1),S([dw()],YL.prototype,"updateStream",1),S([dw()],YL.prototype,"addAdditionalStream",1),S([dw()],YL.prototype,"updateParameters",1),S([dw()],YL.prototype,"terminateAsync",1),S([dw()],YL.prototype,"setHold",1),S([dw()],YL.prototype,"updateStreamQualityParams",1);var QL=YL,XL=class extends ze{constructor(e,t,i,n,r,s,a,o){super(t),this.mediaManager=e,this.logger=t,this.callDeviceManager=i,this.configProvider=n,this.statisticsGatherer=r,this.diagnostics=s,this.isMultiparty=a,this.encStreamsManager=o,this.senders=new Map,this.previousMediaModalitites={Audio:!1,Video:!1,ScreenShare:!1},this.serialQueue=new $A(this.logger),this.muted=new Map([["Audio",!1],["Video",!1]]),this.subs=new Map,this.senderId=0,this.callConstraintsCauseId=void 0,this.streamsProvider=new pL(i,n,this.serialQueue,this.logger.createChild("StreamsProvider")),this.subscribeToStreamProviderEvents(),this.localVideoStreamWatcher=new BN(this.logger,this.configProvider,this.callDeviceManager),this.statisticsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e))),this.statisticsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e))),this.subscribeToStreamWatcherEvents(),this.configProvider.config.useMediaQualityController&&(this.mediaQualityController=new ML(this.configProvider,this.logger.createChild("MQC")),this.mediaQualityController.on("onLayoutsUpdated",(e=>this.updateLayouts(e))))}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.mediaQualityController?.onStatisticsChanged(e),this.configProvider.config.diagnostics.features.useNewStatsForLocalVideoStreamWatcher||this.localVideoStreamWatcher?.onStatisticsChanged(e)}onDiagnosticUpdated(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation&&this.mediaQualityController?.onDiagnosticUpdated(e),this.configProvider.config.diagnostics.features.useNewStatsForLocalVideoStreamWatcher&&this.localVideoStreamWatcher?.onDiagnosticUpdated(e)}dispose(){this.senders.forEach(((e,t)=>{this.event("onSendStreamChanged").raise(null,t),this.configProvider.config.disposeSendersSync?e.dispose():e.terminateAsync()})),this.senders.clear(),this.subs.forEach((e=>e.forEach((e=>e.dispose())))),this.subs.clear(),this.mediaConnection=null,this.unsubscribeFromStreamProviderEvents(),this.configProvider.config.disposeStreamsSync?this.streamsProvider.stop():this.streamsProvider.stopAsync(),this.streamsProvider=null,this.localVideoStreamWatcherSubs?.dispose(),this.localVideoStreamWatcher?.dispose(),this.localVideoStreamWatcher=null,this.mediaManager=null,this.logger=this.logger.createChild("DISPOSED"),this.mediaQualityController?.dispose(),this.mediaQualityController=null,super.dispose()}registerRtpSenderManager(e){this.mediaConnection=e}useNullAudioStreamClient(){this.streamsProvider.useNullAudioStreamClient()}async update(e,t,i,n){n?.mark("startUpdateStreams");const r=am(e),s=await this.updateStreams(r,t);return n?.markAndMeasure("startUpdateStreams","updateStreamsWithModalities"),await this.updateSenders(),n?.markAndMeasure("updateStreamsWithModalities","updateSenders"),this.applyMuteState(i,!0),this.setAndUpdateLocalTracksInfo(!1),this.previousMediaModalitites=ot(s),om(e,this.previousMediaModalitites)}async activate(e){this.logger.info(`[${e}] activate senders`),await Promise.all([...this.senders.values()].map((async e=>e.activate())))}applyCallConstraints(e){const t=this.senders.get("Video");return t?t.applyCallConstraints(e):(this.logger.info(`[${e}] Caching call constraints until sender is created`),this.callConstraintsCauseId=e,this.applyCallConstraintsDeferred=Om(),this.applyCallConstraintsDeferred.promise)}async applyCapabilities(e,t,i){this.logger.safe.info(`[${e}] Applying incoming ${t} FMTP: ${JSON.stringify(i)}`);const n=cm(t);this.lastCauseId=e;let r=i;return this.mediaQualityController&&(this.mediaQualityController.addReceiver(n,i),r=this.mediaQualityController.getLayouts(n)),this.updateParameters(e,n,r)}getLocalMediaSources(){const e=this.getTracksInfo(),t=[];return e.forEach((e=>{t.some((t=>t.modality===e.modality))||t.push({sourceId:this.getSourceIdForTrack(e),modality:e.modality})})),t}setMuted(e,t,i){this.muted.set(e,t),this.applyMuteState(i,!1)}async setHold(e,t){await Promise.all([...this.senders.values()].map((async i=>i.setHold(e,t))))}async updateParameters(e,t,i){try{await this.applyCapabilitiesForMediaType(t,i),this.logger.safe.debug(`[${e}] Capabilities completed`);const n={modality:lm(t),causeId:e,capabilities:i};this.statisticsGatherer.onMaxCapabilitiesApplied(n),this.diagnostics?.onMaxCapabilitiesApplied(n)}catch(n){const r=Ve(n);this.logger.safe.error(`[${e}] Error applying capabilities ${r}`);const s={modality:lm(t),causeId:e,capabilities:i,error:r};this.statisticsGatherer.onMaxCapabilitiesApplied(s),this.diagnostics?.onMaxCapabilitiesApplied(s)}}async applyCapabilitiesForMediaType(e,t){const i=this.senders.get(e);if(i)return i.updateParameters(t);this.logger.safe.info(`[${this.lastCauseId}] Capabilities ignored ${JSON.stringify(t)} ignored, no sender for media type ${JSON.stringify(e)}`)}applyMuteState(e,t){for(const[i,n]of this.muted)this.senders.get(i)&&this.senders.get(i).setMuted(n,e,t)}setAndUpdateLocalTracksInfo(e){const t=this.getTracksInfo();this.mediaManager.setLocalTracksInfo(t),e&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statisticsGatherer.updateStatsWithLocalSsrcTrackInfo())}getTracksInfo(){const e=[];return this.senders.forEach((t=>{e.push(t.getTrackInfo())})),e}async updateStreams(e,t){const i=await this.streamsProvider.update(e,t);return this.logger.safe.info(`Streams updated, modalities requested: ${JSON.stringify(e)}, result: ${JSON.stringify(i)}`),i}async updateSenders(){await this.streamsProvider.ensureUpdateCompleted();const e=dm(this.streamsProvider.streams);await Promise.all(at(e).map((async t=>{const i=e[t];if(i===this.previousMediaModalitites[t])return void this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(t)} are not changed. enabled=${i}`);if(!i)return this.logger.safe.info(`Removing sender for mediaType: ${JSON.stringify(t)}`),void await this.removeSender(t);const n=this.streamsProvider.streams[t];if(await this.createAndStartSender(n,t),this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(t)} is added`),this.applyCallConstraintsDeferred&&"Video"===t){const e=this.senders.get("Video");try{await e.applyCallConstraints(this.callConstraintsCauseId),this.applyCallConstraintsDeferred.resolve()}catch(e){this.applyCallConstraintsDeferred.reject(e)}this.applyCallConstraintsDeferred=void 0,this.callConstraintsCauseId=void 0}await this.addAudioSharingStream(n),this.event("onSendStreamChanged").raise(n,t)}))),this.logger.safe.info("Senders updated")}createAndStartSender(e,t){if(this.senders.get(t))return this.logger.safe.error(`Sender already created, modality: ${JSON.stringify(t)}`),this.senders.get(t).start();const i=this.mediaManager.getMediaEntitiesByModality(lm(t))[0],n=i?.getSimulcastContext(),r="Audio"===t||!this.isMultiparty||!!n?.shouldUseSimulcast(),s=new QL(this.mediaConnection,e,new MediaStream,t,this.serialQueue,this.logger.createChild(`Sender_${JSON.stringify(t)}:${this.senderId++}`),this.configProvider,r,this.encStreamsManager,n);this.senders.set(t,s);const a=[s.on("onSendersChanged",((e,t)=>this.onSenderStateChanged(e,t))),s.on("onNewStreamNeeded",(()=>this.streamsProvider.requestStreamUpdate(t,!0))),s.on("onMaxVideoSendCapabilitiesChanged",(e=>this.event("onMaxVideoSendCapabilitiesChanged").raise(t,e)))];return this.subs.set(s,a),s.start()}async removeSender(e){const t=this.senders.get(e);t&&(this.senders.delete(e),this.event("onSendStreamChanged").raise(null,e),await t.terminateAsync(),this.subs.get(t).forEach((e=>e.dispose())),this.subs.delete(t),this.logger.safe.info(`Removed sender with mediaType: ${JSON.stringify(e)}`)),this.mediaQualityController?.removeReceiver(e)}async updateLayouts(e){const t=this.mediaQualityController.getLayouts(e);return this.logger.safe.debug(`Update layouts for ${e}: ${JSON.stringify(t)}`),this.updateParameters(this.lastCauseId,e,t)}getSourceIdForTrack(e){const t=e.trackId,i=this.mediaManager.getMediaEntityByLocalTrackId(t);return i?(this.logger.safe.info(`Media entity found: ${JSON.stringify(i.getXSourceStreamId())}`),i.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(t)}`),0)}subscribeToStreamProviderEvents(){this.streamProviderSubscriptions=[this.streamsProvider.on("onStreamAdded",(e=>this.onStreamUpdated(e,!1))),this.streamsProvider.on("onStreamUpdated",(e=>this.onStreamUpdated(e,!0)))]}unsubscribeFromStreamProviderEvents(){this.streamProviderSubscriptions.forEach((e=>e.dispose())),this.streamProviderSubscriptions=null}subscribeToStreamWatcherEvents(){this.localVideoStreamWatcherSubs=this.localVideoStreamWatcher.on("onVideoCaptureFreeze",((e,t)=>{e||(t?this.diagnostics.registerWebcamFreeze():this.diagnostics.registerProcessedStreamFreeze()),this.event("onVideoCaptureFreeze").raise(e)}))}async onStreamUpdated(e,t){if(!this.senders.has(e))return void this.logger.safe.warn(`Sender with media type ${e} does not exist, do not update media stream`);let i=this.streamsProvider.streams[e];if(i||(this.logger.safe.info(`Stream is missing for mediaType: ${e}, using fake stream...`),i=new uL(e,this.logger.createChild("NullStreamClient"))),i.isDisposed())return void this.logger.safe.info(`Stream is already disposed for mediaType: ${e}`);this.event("onSendStreamChanged").raise(i,e);const n=this.senders.get(e);await this.addAudioSharingStream(i),await n.updateStream(i),this.setAndUpdateLocalTracksInfo(t)}onSenderStateChanged(e,t){if(this.mediaManager&&this.mediaManager.updateMediaEntitiesWithActivityState(e.mediaType,e.getActiveStreamIndexes()),this.statisticsGatherer.onSendersChanged(e.mediaType,t),"Video"===e.mediaType)if(t){const e=this.getTracksInfo().filter((e=>e.modality===Qe.MODALITY.video));this.localVideoStreamWatcher.startWatching(e)}else this.localVideoStreamWatcher.stopWatching()}async addAudioSharingStream(e){"ScreenShare"===e.mediaType&&e.hasAudio()&&(this.logger.safe.info("Adding audio stream from sharing to audio sender"),await(this.senders.get("Audio")?.addAdditionalStream(e)))}},ZL=class{constructor(e,t,i,n,r){this.pc=e,this.cryptoMethod=t,this.logger=i,this.configProvider=n,this.stateChangedCallback=r,this.logger=i.createChild("TransportStateProvider"),this.subscribeForConnectionState()}get hasPcConnectionState(){return"connectionState"in this.pc&&this.configProvider.config.useConnectionState}subscribeForConnectionState(){this.pc.oniceconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection oniceconnectionstatechange iceConnectionState: ${this.pc.iceConnectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(0)&&this.stateChangedCallback(this.pc.iceConnectionState)},1===this.cryptoMethod&&this.hasPcConnectionState&&(this.pc.onconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection onconnectionStatechange connectionState: ${this.pc.connectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(1)&&this.stateChangedCallback(this.pc.connectionState)})}subscribeForDtlsTransportState(){if(!this.configProvider.config.useDtlsTrasportConnectionCheck||this.transport||1!==this.cryptoMethod||this.hasPcConnectionState)return;const e=this.pc.getReceivers().find((e=>!!e.transport));this.transport=e&&e.transport,this.transport&&(this.transport.onstatechange=()=>{this.logger.safe.info(`RTCDtlsTransport onstatechange state: ${this.transport.state} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(2)&&this.stateChangedCallback(this.transport.state)})}dispose(){this.pc.oniceconnectionstatechange=null,this.transport&&(this.transport.onstatechange=null,this.transport=null),this.pc.onconnectionstatechange&&(this.pc.onconnectionstatechange=null),this.pc=null,this.stateChangedCallback=null}shouldRaise(e){switch(e){case 2:if(1!==this.cryptoMethod)throw new Error(`DTLS transport is used with cryptoMethod=${this.cryptoMethod}`);return!this.configProvider.config.ignoreClosedDtlsTransportState||"closed"!==this.transport.state;case 1:return 1===this.cryptoMethod&&!this.transport;case 0:return!(!this.configProvider.config.ignoreClosedDtlsTransportState||!this.transport||"closed"!==this.pc.iceConnectionState)||0===this.cryptoMethod||!this.transport&&!this.hasPcConnectionState||this.transport&&"disconnected"===this.pc.iceConnectionState||"connected"===this.transport?.state&&"connected"===this.pc.iceConnectionState;default:return this.logger.safe.error(`unknown StateMethod=${e}`),!1}}},ex=class{constructor(e,t,i,n,r){this.recvStream=e,this.mainTrack=t,this.receiveStreamCollection=i,this.logger=n,this.settings=r,this.removeOtherTracks(t),this.subscribeOnStreamEvents()}get stream(){return this.recvStream.getMediaStream()}dispose(){this.unsubscribeFromStreamEvents(),this.receiveStreamCollection=null,this.mainTrack=null,this.recvStream.dispose()}getId(){return this.recvStream.getId()}getModality(){return this.recvStream.getModality()}getMsi(){return this.recvStream.getMsi()}getMediaStream(){return this.stream}getReceiver(){return this.recvStream.getReceiver()}requestSource(e){return this.recvStream.requestSource(e)}getSourceStreamId(){return this.recvStream.getSourceStreamId()}removeOtherTracks(e){this.settings.onAddTrackRemoveOtherTracks&&this.stream.getTracks().forEach((t=>{t.id!==e.id&&this.stream.removeTrack(t)}))}subscribeOnStreamEvents(){const e=e=>this.logger.safe.info(`${e} track: ${this.mainTrack.id}, stream: ${this.stream.id}`);this.stream.onremovetrack=()=>{e("onremovetrack"),this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onended=()=>{e("onended"),this.settings.removeRecvStreamOnEnded&&this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onmute=()=>e("onmute"),this.mainTrack.onunmute=()=>e("onunmute")}unsubscribeFromStreamEvents(){this.stream.onremovetrack=null,this.mainTrack.onended=null,this.mainTrack.onmute=null,this.mainTrack.onunmute=null}},tx=class{constructor(e){this.startTimestamp=0,this.totalTime=0,this.lastActiveTime=0,this.id=e}},ix=class{constructor(e){this.speakersHistory=[],this.sources=[],this.configProvider=e.configProvider,this.ping=this.setupTimer()}setSources(e=[]){const t=e.map(this.getOrCreateSource.bind(this)),i=this.excludeSources(this.sources,t);t.forEach((e=>{this.isAlreadyActive(e)||this.updateSourceTimestamp(e),this.updateSourceLastActiveTime(e)})),i.forEach((e=>{this.updateTotalTime(e),this.resetStartTimestamp(e)})),this.ping||(this.ping=this.setupTimer())}setOnDominantSpeakerChanged(e){this.callback=e}dispose(){this.clearTimer(),this.sources=null,this.callback=null}excludeSources(e,t){return e.filter((e=>!t.some((t=>e.id===t.id))))}trigger(){if(!this.hasAnyoneSpoken())return void this.clearTimer();const e=this.sources.map(this.updateTotalTime).sort(((e,t)=>t.totalTime-e.totalTime||t.lastActiveTime-e.lastActiveTime)).map((e=>e.id)).slice(0,this.configProvider.config.ovcMaxCount);e.length&&!ht(this.speakersHistory,e)&&(this.speakersHistory=e,this.callback&&this.callback(this.speakersHistory,"client")),this.sources.map(this.resetTotalTime).filter(this.isAlreadyActive).forEach(this.updateSourceTimestamp)}isAlreadyActive(e){return!!e.startTimestamp}setupTimer(){return window.setInterval(this.trigger.bind(this),this.configProvider.config.activeSpeaker.timeToPromote)}clearTimer(){this.ping&&(clearInterval(this.ping),this.ping=null)}getOrCreateSource(e){if(this.isExist(e))return this.sourceById(e);{const t=new tx(e);return this.sources.push(t),t}}isExist(e){return this.sources.some((t=>e===t.id))}hasAnyoneSpoken(){return this.sources.some((e=>0!==e.startTimestamp||0!==e.totalTime))}sourceById(e){return this.sources.find((t=>e===t.id))}updateSourceTimestamp(e){e.startTimestamp=Date.now()}updateSourceLastActiveTime(e){e.lastActiveTime=Date.now()}updateTotalTime(e){return e.startTimestamp&&(e.totalTime+=Date.now()-e.startTimestamp),e}resetStartTimestamp(e){return e.startTimestamp=0,e}resetTotalTime(e){return e.totalTime=0,e}},nx=class{constructor(e){this.modifierList=e}modify(e){for(const t of this.modifierList)t.modify(e)}},rx=class{constructor(e,t,i,n){this.context=e,this.mediaManager=t,this.modalities=i,this.cname=n}build(e){switch(e.sdpSource){case 0:return new nx([new JP(this.context.configProvider),new wP(this.context.configProvider),new rM(this.mediaManager,this.context.configProvider),new nM(this.mediaManager),new FP(this.context.configProvider),new NP(this.context.configProvider),new DP(this.mediaManager,this.context.configProvider,e.sdpType),new MP(this.mediaManager,this.context.configProvider),new pM(this.context.configProvider,e.sdpType)]);case 2:return new nx([new dP(this.mediaManager,this.modalities),new PP,new hP(this.mediaManager,!0),new XP(this.context.configProvider,this.mediaManager),new vP(this.modalities,this.mediaManager),new HP,new UP,new VP,new BP(this.context.configProvider),new xP(this.context.configProvider),new zP(this.context.configProvider),new CP,new cP(this.context),new tM(this.mediaManager),new RP(this.context.configProvider),new lM,new cM(this.context.configProvider),new sM(this.context.configProvider),new TP(this.mediaManager,this.modalities,this.context.configProvider),new SP(this.context),new dM(this.context.configProvider),new mP(this.context.configProvider),new DP(this.mediaManager,this.context.configProvider,e.sdpType),new OP(this.mediaManager,this.context.configProvider,e.sdpType),new GP(this.context.configProvider,this.context.getLogger()),new EP,new uM(this.context.configProvider),new YP(this.context.configProvider)]);case 1:return new nx([new gP(this.context,this.modalities.data),new hP(this.mediaManager,!1),new IP(this.context.configProvider),new dP(this.mediaManager,this.modalities),new _P(this.mediaManager),new UP,new LP(this.context.configProvider),new lP(this.mediaManager,"offer"===e.sdpType,this.context.configProvider),new iM(this.mediaManager,this.context.getLogger()),new oM(this.context.configProvider,this.mediaManager),new yP(this.context.config.isConference,this.cname),new bP(this.mediaManager),new AP,new KP(this.context.configProvider),new fP(this.context.configProvider),new hM(this.context.configProvider),new gM(this.context.configProvider),new OP(this.mediaManager,this.context.configProvider,e.sdpType),new WP(this.mediaManager,this.context.configProvider,e.sdpType),new YP(this.context.configProvider)])}}},sx=class{constructor(e){this.context=e,this.cname=dt()}toLocal(e,t,i){return this.modify({sdpSource:0,sdpType:i},e,t)}toOffer(e,t,i){return this.modify({sdpSource:1,sdpType:"offer"},e,t,i)}toAnswer(e,t,i){return this.modify({sdpSource:1,sdpType:"answer"},e,t,i)}toRemote(e,t,i,n){return this.modify({sdpSource:2,sdpType:n},e,t,i)}modify(e,t,i,n){const r=new rx(this.context,i,n,this.cname).build(e),s=ct(t);return r.modify(s),s}},ax=class{get sdp(){return this.originalDescription.sdp}set sdp(e){this.originalDescription=new Vp.window.RTCSessionDescription({sdp:e,type:this.originalDescription.type})}get type(){return this.originalDescription.type}set type(e){this.originalDescription=new Vp.window.RTCSessionDescription({sdp:this.originalDescription.sdp,type:e})}constructor(e){this.originalDescription=new Vp.window.RTCSessionDescription(e)}toJSON(){return this.originalDescription.toJSON()}},ox=p,cx=class{constructor(e,t,i){this.mediaEntity=e,this.logger=t,this.configProvider=i,this.activeRids=[],this.isLocalDescSet=!1,this.enabledLocally=!1,this.enabledRemotely=!1;const n=cm(this.mediaEntity.getModality());this.config=_m(n,this.configProvider),this.config?this.logger.safe.debug(`Adding simulcast info to ${e.getModality()} with mid: ${e.getMid()}, config: ${JSON.stringify(this.config)}`):this.logger.safe.debug(`Simulast is disabled for ${e.getModality()}`)}get ridList(){return this.config?(0,ox.times)(this.config.layerScaleFactors.length,(e=>e+1)):[]}localDescriptionIsApplied(){this.isLocalDescSet=!0}enableInLocalDesc(){this.enabledLocally=!0}shouldBeEnabledInLocalDesc(){return!!this.config&&(this.config.enableLocally||this.enabledRemotely)}enableInRemoteDesc(){this.enabledRemotely=!0}shouldBeEnabledInRemoteDesc(){return!!this.config&&(this.enabledLocally||this.config.allowEnableRemotely&&this.isMidRidHeaderExtPresented()&&!this.isLocalDescSet)}shouldUseSimulcast(){return this.shouldBeEnabledInLocalDesc()}getSsrcRange(){return this.shouldUseSimulcast()?99:0}isMidRidHeaderExtPresented(){const e=this.mediaEntity.getRtpHeaderExtensions();return e?.some((e=>"mid"===e.headerType||"rid"===e.headerType||"rrid"===e.headerType))}},lx={toffset:"toffset","abs-send-time":"abs-send-time","video-orientation":"video-orientation","draft-holmer-rmcat-transport-wide-cc-extensions-01":"transport-cc","video-content-type":"video-content-type","video-timing":"video-timing","color-space":"color-space","video-layers-allocation00":"vla","video-layers-allocation00-non-advertised":"non-adv-vla",mid:"mid","rtp-stream-id":"rid","repaired-rtp-stream-id":"rrid","fast_bandwidth_feedback#version_3":"fast_bandwidth_feedback#version_3","frame-counters-gvc":"frame-counters-gvc"},dx=class{constructor(e){this.context=e,this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.ssrcGenerator=new qD,this.rollbackHandlers=[],this.logger=e.logger.createChild("MM2"),this.configProvider=e.configProvider}fromOffer(e,t,i=!1){this.updateMediaEntitiesFromModel(e,i),this.updateSharingEntity(!!t.sharing),e.media.forEach((e=>{const t=this.getMediaEntityByMid(e.mid);t&&this.saveLocalSsrc(t,e)}))}fromRemote(e,t){const i=0===this.mediaEntities.length;this.updateMediaEntitiesFromModel(e,!1,t),e.media.forEach(((e,t)=>{const i=this.getMediaEntityByMid(e.mid);i&&(this.saveRemoteMsid(i,e),this.saveRemoteSsrc(i,e),this.saveRtpHeaderExtensions(i,e),i.setXSourceStreamId(e.xSourceStreamId||this.generateSourceStreamId(t)),i.setRemoteRecvCapabilities(zw(e)),i.setSubStreamIndex(e.subStreamIndex))})),i&&this.updateReinvitelessState(e)}isEmpty(){return 0===this.mediaEntities.length}createMediaEntity(e,t){const i=IN.create(this.configProvider,e,t);return this.context.useSimulcast&&!this.mediaEntities.find((t=>t.getModality()===e))&&this.setSimulcastContext(i),i.setExtension("reinviteless",!1),this.mediaEntities.push(i),i}getMediaEntities(){return this.mediaEntities}getMediaEntity(e){return this.mediaEntities[e]}getMediaEntityByMid(e){return this.mediaEntities.find((t=>t.getMid()===e))}getMediaEntitiesByModality(e){return this.mediaEntities.filter((t=>t.getModality()===e))}getMediaEntitiesByMediaType(e){const t=cm(e);return this.getMediaEntitiesByModality(t)}getMediaEntityByRemoteStreamId(e){return this.mediaEntities.find((t=>t.getRemoteStreamId()===e))}getMediaEntityByLocalTrackId(e){return this.mediaEntities.find((t=>t.getLocalTrackId()===e))}getMediaEntityByXSourceStreamId(e){return this.mediaEntities.find((t=>t.getXSourceStreamId()===e))}reset(){this.mediaEntities=[],this.rollbackHandlers=[]}syncModalities(e,t,i=!1){this.fromOffer(e,t,i)}setLocalTracksInfo(e){this.mediaTracks=e}getLocalTracksInfo(){return this.mediaTracks}backup(){this.logger.safe.debug("backup"),this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{this.mediaEntitiesBackup.push(e.clone())}))}commit(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{e.setExtension("unnegotiatedModality",!1)}))}rollback(){this.logger.safe.debug(`rollback, if backup exists: ${!!this.mediaEntitiesBackup.length}`),this.mediaEntitiesBackup.length&&(this.rollbackHandlers.forEach((e=>e(this.mediaEntities,this.mediaEntitiesBackup))),this.mediaEntities.forEach(((e,t)=>{this.mediaEntitiesBackup[t]?this.mediaEntities[t]=this.mediaEntitiesBackup[t]:(e.disable(),e.setExtension("rollback",!0))})))}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((e=>e.setLocalTrackId(null))),this.mediaTracks.forEach((e=>{const t=this.getMediaEntitiesByModality(e.modality)[0];t?t.setLocalTrackId(e.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(e.modality)}`)})))}updateMediaEntitiesWithActivityState(e,t){this.logger.safe.debug(`Updating activity indexes for ${e} to ${JSON.stringify(t)}`);const i=lm(e),n=this.getMediaEntitiesByModality(i)[0];if(!n)return void this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(i)}`);const r=n.getSimulcastContext();r&&(r.activeRids=t)}setRollbackUpdateHandler(e){this.rollbackHandlers.push(e)}saveRtpHeaderExtensions(e,t){if(e.isDisabled())return void e.setRtpHeaderExtensions(void 0);const i=t.ext?.map((e=>this.getHeaderExtension(e)));this.logger.safe.debug(`RTP header ext for mid=${t.mid}, modality=${e.getModality()}: ${JSON.stringify(i)}`),e.setRtpHeaderExtensions(i)}getHeaderExtension(e){let t="unknown";for(const[i,n]of Object.entries(lx))if(e.uri.endsWith(i)){t=n;break}return{headerType:t,value:e.value}}saveRemoteMsid(e,t){if(Ww(t))e.setRemoteStreamId(null);else if(t.msid)e.setRemoteStreamId(t.msid.split(" ")[0]);else if(t.ssrcs){const i=t.ssrcs.find((e=>"msid"===e.attribute));i?e.setRemoteStreamId(i.value.split(" ")[0]):this.logger.safe.warn(`No ssrc msid for media of type ${t.type} with mid ${t.mid}`)}}saveRemoteSsrc(e,t){if(t.ssrcs?.length){const i=t.ssrcs[0];e.setRemoteSsrc(i.id)}}saveLocalSsrc(e,t){const i=t.ssrcs?.[0]?.id;if(!zp(t.direction))return void e.setLocalSsrc(i);const n=i||e.getLocalSsrc()||this.ssrcGenerator.nextVideoStreamSsrc().min;e.setLocalSsrc(n)}updateMediaEntitiesFromModel(e,t,i){e.media.forEach(((e,n)=>{this.mediaEntities[n]?Ww(e)?this.mediaEntities[n].disable():this.mediaEntities[n].update(this.mediaEntities[n].getModality(),e.mid||this.mediaEntities[n].getMid()):t||this.createMediaEntity($w(e),e.mid||n.toString()),this.mediaEntities[n]&&i&&!(this.mediaEntities[n].getModality()in i)&&this.mediaEntities[n].disable()}))}updateSharingEntity(e){if(e&&!this.getMediaEntitiesByModality(Qe.MODALITY.sharing).length){const e=this.getMediaEntitiesByModality(Qe.MODALITY.video).pop();e.update(Qe.MODALITY.sharing,e.getMid())}}setSimulcastContext(e){if(!e||e.getSimulcastContext())return;const t=new cx(e,this.logger.createChild(`SimContext:${e.getModality()}`),this.configProvider);e.setSimulcastContext(t)}generateSourceStreamId(e){return e+10}updateReinvitelessState(e){const t={[Qe.MODALITY.audio]:0,[Qe.MODALITY.video]:0,[Qe.MODALITY.sharing]:0};for(const i of e.media){const e=$w(i);void 0!==t[e]&&t[e]++;const n=this.getMediaEntityByMid(i.mid);if(n){const r=this.context.reinviteltessContext?.maxStreamsForModality[e]>=t?.[e]&&(!i.direction||"sendrecv"===i.direction);n.setExtension("reinviteless",r)}}}};var hx=class extends KN{constructor(e,t,i){super(e,t,2,i)}init(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[e]}})}setCodec(e,t){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[e,t]}})}passWriteableStreams(e,t){const i=e.concat(t);this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"passWriteableStreams",args:[e,t]}},i)}setAvailableStreams(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setAvailableStreams",args:[e]}})}setRecvPayloads(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setRecvPayloads",args:[e]}})}debugLogging(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[e]}})}sendApiRecordingData(){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"sendApiRecordingData",args:[]}})}},ux=class{constructor(e){this.logger=e,this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination()}get stream(){return this.destination.stream}isSingleInputStream(){return 0===this.mixerImp?.mixerType}dispose(){this.audioContext.close(),this.audioContext=null}setMixerType(e,t){this.mixerImp?.mixerType!==e&&(this.mixerImp?.reset(),this.mixerImp=this.createMixer(e),this.mixerImp.setupMixer(this.audioContext,this.destination,t))}setStreamSources(e){this.mixerImp.setStreamSources?.(e)}setParticipantSpatialAudioPositions(e){this.mixerImp.setParticipantSpatialAudioPositions?.(e)}createMixer(e){switch(e){case 0:return new px;case 1:return new mx(this.logger.createChild("MixingStreamsMixer"));case-1:return new gx;default:throw new Error(`unknown mixer type: ${e}`)}}},gx=class{constructor(){this.mixerType=-1}reset(){}setupMixer(e,t,i){}},px=class{constructor(){this.mixerType=0}reset(){this.sourceNode.disconnect()}setupMixer(e,t,i){this.sourceNode=e.createMediaStreamSource(i[0]),this.sourceNode.connect(t)}},mx=class{constructor(e){this.logger=e,this.sourcePositions=new Map,this.pannerNodes=[],this.mixerType=1}reset(){for(const e of this.pannerNodes)e.disconnect();this.pannerNodes=[]}setupMixer(e,t,i){for(const n of i){const i=e.createMediaStreamSource(n),r=new PannerNode(e,{panningModel:"HRTF"});i.connect(r),r.connect(t),this.pannerNodes.push(r)}this.logger.safe.info(`setupMixer is done for ${i.length} streams.`)}setStreamSources(e){for(let t=0;t<e.length;t++)this.setStreamPosition(t,e[t])}setParticipantSpatialAudioPositions(e){this.sourcePositions=new Map(e.map((e=>[e.sourceId,e])))}setStreamPosition(e,t){const i=this.sourcePositions.get(t)??{sourceId:t,x:0,y:0},n=this.pannerNodes[e];n.positionX.value=i.x,n.positionY.value=i.y}},fx=class extends We{constructor(e){super(),this.logger=e,this.mediaStreams=[],this.cnStream=null,this.isActive=!1}get active(){return this.isActive}get streams(){return this.mediaStreams}get comfortNoiseStream(){return this.cnStream}setupStreams(e,t){this.logger.safe.debug(`setup ${e} streams with extra Comfort Noise stream: ${t}`),this.mediaStreams=[];const i=[];for(;e--;){const e=new MediaStreamTrackGenerator({kind:"audio"});i.push(e),this.streams.push(new MediaStream([e]))}const n=t?new MediaStreamTrackGenerator({kind:"audio"}):null;return this.cnStream=n?new MediaStream([n]):null,this.event("onStreamsChanged").raise(),{streams:i.map((e=>e.writable)),cnStream:n?.writable}}setStreamSources(e){this.isActive&&this.event("onStreamSourcesUpdated").raise(e)}activateUnmixedProvider(e){this.isActive!==e&&(this.isActive=e,this.event("onActiveStateChanged").raise())}},Sx=class extends ze{constructor(e,t){super(),this.logger=e,this.maxNumOfStreamsFactor=t,this.statsProvider=new vx,this.streamMixer=new ux(this.logger),this.unmixedAudioProvider=new fx(this.logger),this.codec="None",this.recvPayloads=[],this.initCompleted=!1,this.enabledApiRecording=!1;try{this.enabledApiRecording="true"===localStorage.getItem("enableApiRecording")}catch{}this.injectWebMA()}get stream(){return this.streamMixer.stream}dispose(){super.dispose(),this.streamMixer.dispose(),this.removeWebMA()}activateTransform(e){this.logger.safe.debug("Activating WASM decoder transform"),e.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM decoder transform"),this.imp=null,this.initCompleted=!1,this.codec="None",this.streamMixer.setMixerType(-1,[])}createBaseInstanse(e){this.logger.warn("WASM decoder could only be instantiated in worker")}createWorkerInstanse(e,t){this.imp=function(e,t,i){return new hx(e,t,i)}(e,t,this),this.imp.init(this.enabledApiRecording)}setCodec(e){if(this.logger.safe.debug(`Setting codec to ${e}`),!this.initCompleted)return this.logger.safe.debug("Decoder is not initialized yet, postponing codec setting"),void(this.codec=e);this.codec!==e&&(this.codec=e,this.setCodecInternal())}setRecvPayloads(e){this.recvPayloads=e,this.imp?.setRecvPayloads(e)}negotiationCompleted(e){this.logger.safe.debug(`Negotiation completed, negotiated=${e}`),e||(this.codec="None",this.imp?.setCodec(this.codec,this.streamMixer.isSingleInputStream()))}setParticipantSpatialAudioPositions(e){this.streamMixer.setParticipantSpatialAudioPositions(e)}getStatsProvider(){return this.statsProvider}getUnmixedAudioProvider(){return this.unmixedAudioProvider}async storeApiRecording(){if(this.enabledApiRecording&&this.initCompleted)return this.recordingCompletePromise?.resolve(),this.recordingCompletePromise=new Yu,this.imp.sendApiRecordingData(),this.recordingCompletePromise.promise}initDone(e,t){if(this.healerCapabilities=t,this.logger.safe.info(`Init done, errorCode=${e}`),0!==e)return void this.event("initFailed").raise(e);this.logger.safe.info(`healerCapabilities=${JSON.stringify(t)}`),this.initCompleted=!0;const i=Math.floor(this.healerCapabilities.maxNumStreamsPerPacket*this.maxNumOfStreamsFactor),n=this.unmixedAudioProvider.setupStreams(i,!0);this.imp.passWriteableStreams(n.streams,n.cnStream),this.setCodecInternal(),this.imp.setRecvPayloads(this.recvPayloads)}usedDecoderChanged(e){this.logger.safe.info(`Used decoder changed to custom=${e}, configured codec=${this.codec}`),this.event("usedDecoderChanged").raise(e),this.unmixedAudioProvider.activateUnmixedProvider(e&&"MUCHv2"===this.codec)}packetReceived(e,t,i){this.statsProvider.ssrc=t,this.statsProvider.addPushStats(e,i)}newDataWrittenToStreams(e){const t=Array.from(new Int32Array(e));this.unmixedAudioProvider.setStreamSources(t),this.streamMixer.setStreamSources(t);const i=t.reduce(((e,t,i)=>(0===t&&e.push(i),e)),[]);this.imp?.setAvailableStreams(i)}packetDecoded(e,t,i){this.statsProvider.addPullStats(e,t,i,i.extra.samplingRatekHz*this.healerCapabilities.frameLengthMs)}apiRecordingAvailable(e,t,i){if(this.logger.safe.debug(`API recording available: errorCode=${e}, name=${t}, buffer length=${i.byteLength}`),this.recordingCompletePromise?.resolve(),0===i.byteLength)return;const n=new Blob([i],{type:"application/octet-stream"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=t,s.click()}setCodecInternal(){this.streamMixer.setMixerType(function(e){switch(e){case"SatinFB":return 0;case"MUCHv2":return 1;case"None":return-1;default:throw new Error(`unknown codec: ${e}`)}}(this.codec),this.unmixedAudioProvider.streams),this.imp.setCodec(this.codec,this.streamMixer.isSingleInputStream()),this.statsProvider.codecName=this.codec}injectWebMA(){const e=window.webMA;e&&(e.wasmDecoder={debugLogging:e=>this.imp?.debugLogging(e),sendApiRecordingData:()=>this.imp?.sendApiRecordingData()})}removeWebMA(){const e=window.webMA;e&&delete e.wasmDecoder}};var vx=class{constructor(){this.customHealerStats={numSamplesPerFrame:0,FECPayloadDecodedSamples:0,concealSamples:0,stretchSamples:0,healedSamples:0,decodedSamples:0,redPacketsCount:0,pushProcessingTimes:{},pullProcessingTimes:{},pullProcessingTimePerStreamNumber:{},pullNumOfStreamsCounter:{}},this.inboudStats={silentConcealedSamples:0,concealedSamples:0,totalSamplesReceived:0,audioLevel:0,jitterBufferDelay:0,jitterBufferEmittedCount:0},this.decoderStats={pushCount:0,pushErrCount:0,pullCount:0,pullErrCount:0},this.packetPushProccesingTimes=new yx(0,1e3),this.packetPullProccesingTimes=new yx(0,1e3),this.numOfStreamsCounter=new yx(0,10),this.pullProcessingTimePerStreamNumber={}}get codecName(){return this.codec}set codecName(e){this.codec=e}addPushStats(e,t){this.decoderStats.pushCount++,this.decoderStats.pushErrCount+=0!==e?1:0,this.inboudStats.jitterBufferDelay+=t.webrtc.jitterBufferDelay,this.customHealerStats.packetDurationInMs=t.extra.packetDurationInMs,this.packetPushProccesingTimes.addSample(t.extra.processingTime),this.customHealerStats.pushProcessingTimes=this.packetPushProccesingTimes.getFrequencies(),this.customHealerStats.cnpPushCount=t.extra.totalCountCNPackets,this.customHealerStats.redPacketsCount+=0!==t.extra.redundancyTimestampOffset?1:0}addPullStats(e,t,i,n){var r;this.decoderStats.pullCount++,this.decoderStats.pullErrCount+=0!==e?1:0,this.inboudStats.audioLevel=i.webrtc.audioLevel,this.inboudStats.totalAudioEnergy=i.webrtc.totalAudioEnergy,this.inboudStats.jitterBufferEmittedCount=i.webrtc.jitterBufferEmittedCount,this.inboudStats.totalSamplesReceived=i.webrtc.totalSamplesReceived,this.inboudStats.concealedSamples=i.webrtc.concealedSamples,this.inboudStats.silentConcealedSamples=i.webrtc.silentConcealedSamples,this.numOfStreamsCounter.addSample(t),this.customHealerStats.FECPayloadDecodedSamples=i.extra.FECPayloadDecodedSamples,this.customHealerStats.numSamplesPerFrame=n,this.customHealerStats.pullAdspPayloadType=i.extra.pullAdspPayloadType,this.customHealerStats.concealSamples=i.extra.concealSamples,this.customHealerStats.stretchSamples=i.extra.stretchSamples,this.customHealerStats.healedSamples=i.extra.healedSamples,this.customHealerStats.decodedSamples=i.extra.decodeSamples,this.packetPullProccesingTimes.addSample(i.extra.processingTime),this.customHealerStats.pullProcessingTimes=this.packetPullProccesingTimes.getFrequencies(),this.customHealerStats.cnpPullCount=i.extra.totalCountCNGeneratedFrames,this.customHealerStats.cngSamples=i.extra.cngSamples,this.customHealerStats.pullNumOfStreamsCounter=this.numOfStreamsCounter.getFrequencies(),(r=this.pullProcessingTimePerStreamNumber)[t]??(r[t]=new yx(0,200)),this.pullProcessingTimePerStreamNumber[t].addSample(i.extra.processingTime);for(const e of Object.keys(this.pullProcessingTimePerStreamNumber))this.customHealerStats.pullProcessingTimePerStreamNumber[e]=this.pullProcessingTimePerStreamNumber[e].getFrequencies()}getWebRtcCompatibaleStats(){return this.inboudStats}getWasmStats(){return this.customHealerStats}getDecoderStats(){return this.decoderStats}},yx=class{constructor(e,t){this.minSample=e,this.maxSample=t,this.frequencyDict={}}addSample(e){if(void 0===e)return;const t=Math.min(this.maxSample,Math.max(this.minSample,e));this.frequencyDict[t]=(this.frequencyDict[t]??0)+1}getFrequencies(){return{...this.frequencyDict}}};var Cx=class extends KN{constructor(e,t,i){super(e,t,3,i)}init(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[e]}})}setCodec(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[e]}})}debugLogging(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[e]}})}},_x=["SatinFB"],Ex=class extends ze{constructor(e){super(),this.logger=e,this.codec="None",this.injectWebMA()}dispose(){super.dispose(),this.removeWebMA()}activateTransform(e){this.logger.safe.debug("Activating WASM encoder transform"),e.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM encoder transform"),this.imp=null,this.encodersInitCodes=void 0,this.codec="None"}createBaseInstanse(e){this.logger.warn("WASM encoder could only be instantiated in worker")}createWorkerInstanse(e,t){this.imp=function(e,t,i){return new Cx(e,t,i)}(e,t,this),this.imp.init(_x)}setCodec(e){if(this.logger.safe.debug(`Setting codec to ${e}`),!this.encodersInitCodes)return this.logger.safe.debug("Encoder is not initialized yet, postponing codec setting"),void(this.codec=e);this.codec!==e&&(this.codec=e,this.setCodecInternal())}isCodecAllowed(e){return _x.includes(e)}negotiationCompleted(e){e||(this.codec="None",this.imp?.setCodec(this.codec))}initDone(e){this.logger.safe.info(`initDone: ${JSON.stringify(e)}`),this.encodersInitCodes=e,this.setCodecInternal()}packetEncoded(e){0!==e&&this.logger.safe.info(`encode failed: ${e}`)}setCodecInternal(){const e=this.encodersInitCodes[this.codec]??-2147024809;if("None"!==this.codec&&0!==e)return this.logger.safe.error(`WASM encoder is failed to init codec ${this.codec}, err code: ${e}`),void this.event("initCodecFailed").raise(e);this.imp.setCodec(this.codec)}injectWebMA(){const e=window.webMA;e&&(e.wasmEncoder={debugLogging:e=>this.imp?.debugLogging(e)})}removeWebMA(){const e=window.webMA;e&&delete e.wasmEncoder}},Tx=p,Ix=class extends ze{constructor(e,t,i){super(),this.encStreamsManager=e,this.logger=t,this.configProvider=i,this.isEnabled=!1,this.sessionStats=new Ax,this.subs=[],this.codecContext=this.configProvider.mediaConfig.audioCodecContext,this.codecConfig=this.configProvider.config.useInsertableStreams?.audioWasmCodec}get decoder(){return this.decoderImp}get encoder(){return this.encoderImp}init(e){if(!e||!this.codecContext||!this.codecConfig?.enable)return;this.isEnabled=!0;const t=this.codecConfig.maxNumOfStreamsFactor||1;this.decoderImp=new Sx(this.logger.createChild("AudioWasmDecoder"),t),this.codecConfig.enableSend&&(this.encoderImp=new Ex(this.logger.createChild("AudioWasmEncoder"))),this.subscribeToStreamManagerEvents(this.encStreamsManager),this.subscribeToCodecsEvents()}dispose(){super.dispose(),this.unsubscribeFromEvents(),this.decoderImp?.dispose(),this.encoderImp?.dispose()}getSessionEvents(){return this.sessionStats.getSessionEvents()}prepareForNegotiation(e){if(!this.isEnabled)return;const t=this.configProvider.mediaConfig.spatialAudioEnabled?"MUCHv2":this.codecConfig.codec||"None";this.codecContext.codec!==t&&(this.codecContext.initSendFailed=!1),this.codecContext.lastUsedCodec=this.codecContext.codec,this.codecContext.codec=t,this.codecContext.enabledLocally=!this.codecContext.initFailed&&"None"!==t,this.codecContext.enabledForSend=this.codecContext.enabledLocally&&!this.codecContext.initSendFailed&&!!this.codecConfig?.enableSend&&this.encoder?.isCodecAllowed(t),this.logger.safe.info(`Audio codec state: context=${JSON.stringify(this.codecContext)}`),this.codecContext.initFailed||!e&&this.codecContext.disabledRemotely||(this.sessionStats.toggleState("None"!==t),this.decoderImp?.setCodec(t),this.encoderImp?.setCodec(this.codecContext.enabledForSend?t:"None"))}negotiationCompleted(){if(!this.isEnabled)return!1;const e=this.codecContext.enabledLocally&&!this.codecContext.disabledRemotely;return this.decoderImp?.negotiationCompleted(e),this.encoderImp?.negotiationCompleted(e),this.sessionStats.negotiationCompleted(e,this.codecContext.enabledForSend),e}configureSpatialAudio(e,t){return!!this.isEnabled&&((e&&"MUCHv2"!==this.codecContext.codec||!e&&"MUCHv2"===this.codecContext.codec)&&this.event("negotiationNeeded").raise(t),!0)}subscribeToStreamManagerEvents(e){this.subs.push(e.on("onTransformsCollectionCreated",(e=>this.handleTransformsCollectionCreated(e))),e.on("onTransformsCollectionCleared",(e=>this.handleTransformsCollectionCleared(e))))}handleTransformsCollectionCreated(e){"Audio"===e.mediaType&&(this.decoderImp&&"Receiver"===e.objType?this.decoderImp.activateTransform(e.collection):this.encoderImp&&"Sender"===e.objType&&this.encoderImp.activateTransform(e.collection))}handleTransformsCollectionCleared(e){"Audio"===e.mediaType&&(this.decoderImp&&"Receiver"===e.objType?this.decoderImp.deactivateTransform():this.encoderImp&&"Sender"===e.objType&&this.encoderImp.deactivateTransform())}subscribeToCodecsEvents(){this.decoderImp&&this.subs.push(this.decoderImp.on("initFailed",(e=>this.handleCodecInitFailed("decoder",e)))),this.encoderImp&&this.subs.push(this.encoderImp.on("initCodecFailed",(e=>this.handleCodecInitFailed("encoder",e))))}unsubscribeFromEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}handleCodecInitFailed(e,t){"decoder"===e?this.codecContext.initFailed=!0:this.codecContext.initSendFailed=!0;const i=Te();this.logger.safe.warn(`[${i}] Audio ${e} init failed ${t}`),this.sessionStats.initFailed(t,e),this.event("negotiationNeeded").raise(i)}},bx=class e{constructor(){this.sessionEvents={negotiationAttempts:[],toggleCount:0,negotiatedCount:0,failedNegotiationCount:0,decoderInitError:0,encoderInitError:0}}toggleState(t){this.sessionEvents.toggleCount++,this.inProgressNegotiation={ts:Date.now(),enabled:t,negotiated:!1,sendEnabled:!1},Tt(this.sessionEvents.negotiationAttempts,this.inProgressNegotiation,e.maxStoreNegotiations)}negotiationCompleted(e,t){this.inProgressNegotiation&&(this.sessionEvents.negotiatedCount+=e?1:0,this.sessionEvents.failedNegotiationCount+=this.inProgressNegotiation.enabled&&!e?1:0,this.inProgressNegotiation.negotiated=e,this.inProgressNegotiation.sendEnabled=t,this.inProgressNegotiation=void 0)}initFailed(e,t){"decoder"===t?this.sessionEvents.decoderInitError=e:this.sessionEvents.encoderInitError=e}getSessionEvents(){return(0,Tx.clone)(this.sessionEvents)}};bx.maxStoreNegotiations=5;var Ax=bx,Rx=class extends ze{constructor(e,t){super(),this.configProvider=e,this.logger=t,this.bandwidthEstimationAvailable=!1,this.smoothingWindow=[],this.totalSamples=0,this.isStarted=!1,this.maxCountStatic=this.configProvider.config.ovcMaxCount,this.previousParticipantsCount=0;const i=window.navigator;this.updateStaticConstraint(i.hardwareConcurrency,this.configProvider.config.ovcAvailableConcurrencyForBiggerGrid,4),this.updateStaticConstraint(i.deviceMemory,this.configProvider.config.ovcMemoryForBiggerGrid,4),this.throttler=new wx(this.logger.createChild("ovcThrottler"),this.configProvider.config.ovcRampDownCooldown,this.configProvider.config.ovcRampUpCooldown)}start(){this.isStarted=!0,this.throttler.changed((()=>this.event("calculatorStateChanged").raise(2,{ovc:this.throttler.value,ovcPayload:this.payload})))}stop(){this.isStarted=!1}dispose(){super.dispose(),this.throttler.dispose()}processEstimatedBandwidth(e){const t=this.getOVCEstimate(e),i=Math.max(1,Math.min(t,this.maxCountStatic));this.payload={bandwidth:e,reason:0},this.throttler.setValue(i,0)}updateParticipantCount(e){if(!this.configProvider||e===this.previousParticipantsCount)return;const t=this.configProvider.config.ovcXLParticipantsCount;e>t&&this.previousParticipantsCount<=t&&(this.maxCountStatic=this.configProvider.config.ovcMaxCountXL),e<=t&&this.previousParticipantsCount>t&&(this.maxCountStatic=this.configProvider.config.ovcMaxCount),this.previousParticipantsCount=e;let i=this.maxCountStatic;this.payload?.bandwidth&&(i=this.getOVCEstimate(this.payload.bandwidth),this.payload.reason=1),this.throttler.setValue(Math.max(1,Math.min(i,this.maxCountStatic)),1)}getOVCEstimate(e){this.bandwidthEstimationAvailable||(this.bandwidthEstimationAvailable=this.isStarted&&e>0&&(this.totalSamples++>=this.configProvider.config.ovcIgnoreFirstSamples||Math.floor(e)/this.configProvider.config.ovcBandwidthPerVideoReceiver>=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount));let t=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount;return this.bandwidthEstimationAvailable&&(t=Math.floor(this.sampleSmoothed(e)/this.configProvider.config.ovcBandwidthPerVideoReceiver)),t}sampleSmoothed(e){if(this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples?this.smoothingWindow.shift():this.smoothingWindow.length===this.configProvider.config.ovcSlidingWindowSamples-1&&(this.smoothingWindow=this.smoothingWindow.map((()=>e))),this.smoothingWindow.push(e),this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples){const e=this.smoothingWindow.slice().sort(),t=it(e);return e[e.length-1]-(e[e.length-1]-t*(1-this.configProvider.config.ovcSlidingWindowPercentile))}return e}updateStaticConstraint(e,t,i){e&&e<t&&(this.maxCountStatic=Math.min(this.maxCountStatic,i))}},wx=class extends ze{constructor(e,t,i){super(e),this.logger=e,this.throttleDownCooldown=t,this.throttleUpCooldown=i,this.wasRampingUp=!0,this.lastUpdateTime=0}get value(){return this.lastValue}setValue(e,t){if(e===this.lastValue)return;const i=e>this.lastValue,n=void 0!==this.lastValue&&i!==this.wasRampingUp?i?this.throttleUpCooldown:this.throttleDownCooldown:-1,r=Date.now();r-this.lastUpdateTime<n&&(1!==t||i)||(void 0!==this.lastValue&&(this.lastUpdateTime=r,this.wasRampingUp=i),this.logger.safe.info(`optimal video receivers count updated ${this.lastValue} -> ${e}`),this.lastValue=e,this.raiseChanged())}},Px=class e{constructor(e,t=30){this.logger=e,this.maxEventNum=t,this.report=[],this.started=!1}isSupported(){return Boolean(window.chrome?.runtime?.connect)}start(){this.isSupported?(this.started=!0,this.logger.debug("Starting collecting CPU metric"),this.port=window.chrome.runtime.connect(e.extensionID,{name:e.extensionName}),this.port.onMessage.addListener((e=>{e&&Tt(this.report,{timeStamp:Date.now(),value:e},this.maxEventNum)}))):this.logger.debug("Chrome runtime is not supported")}stop(){this.port?.disconnect(),this.port=null,this.started=!1}getSamples(){return this.report}getLastSample(){return bt(this.report)}getCurrentCpuSample(){return new Promise(((t,i)=>{this.started&&t(bt(this.report)),this.isSupported()||i("Not supported"),this.port=window.chrome.runtime.connect(e.extensionID,{name:e.extensionName}),this.port.onMessage.addListener((e=>{this.stop(),e||i("Not supported"),t({timeStamp:Date.now(),value:e})}))}))}clearStats(){this.report=[]}};Px.extensionID="nkeimhogjdpnpccoofpliimaahmaaome",Px.extensionName="processCpu";var Mx=Px,Dx=class{constructor(e){this.logger=e,this.started=!1}static isSupported(){return void 0!==globalThis.PressureObserver}get cpuState(){return this.currentCpuState}start(){if(this.logger.safe.debug("Starting CPU pressure observer"),this.started)this.logger.safe.debug("CPU pressure observer is already started");else{try{this.cpuObserver=new globalThis.PressureObserver((e=>{e.forEach((t=>{"cpu"===t.source&&this.currentCpuState!==t.state&&(this.logger.safe.debug(`CPU pressure state changed: ${JSON.stringify(e)}`),this.currentCpuState=t.state)}))}),{sampleRate:1})}catch(e){throw this.logger.safe.error(`Error while creating pressure observer: ${e}`),e}this.started=!0,this.cpuObserver?.observe("cpu")}}stop(){this.started=!1,this.cpuObserver?.disconnect()}},Ox=class{static getStrategy(e){switch(e.config.diagnostics.performanceMonitoring.monitoringStrategy){case"decodeTime":default:return new kx(e);case"renderedFps":return new Nx(e);case"rendererVolatility":return new Lx(e)}}},kx=class{constructor(e){this.configProvider=e,this.decodeThresholds=this.configProvider.config.diagnostics.performanceMonitoring.decodeThresholds,this.defaultThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultThrehold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.decodeThresholds[e.frameHeight]||this.defaultThreshold,r=e.decodeTimeTracker.getReport();return r.median>n.maxDecodeTime&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),r.median<n.maxDecodeTime&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},Nx=class{constructor(e){this.configProvider=e,this.fpsDiffThresholds=this.configProvider.config.diagnostics.performanceMonitoring.fpsDiffThresholds,this.defaultFpsDiffThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultFpsDiffThreshold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.fpsDiffThresholds[e.frameHeight]||this.defaultFpsDiffThreshold,r=e.incomingFps.getReport(),s=e.rendererFps.getReport(),a=r.median-s.median;return a>=n.fpsDiff&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),a<n.fpsDiff&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},Lx=class{constructor(e){this.configProvider=e,this.volatilityThresholds=this.configProvider.config.diagnostics.performanceMonitoring.volatilityThresholds,this.defaultVolatilityThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultVolatilityThreshold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.volatilityThresholds[e.frameHeight]||this.defaultVolatilityThreshold,r=e.rendererFps.getReport(),s=e.incomingFps.getReport(),a=Math.abs(r.volatilityPercent-s.volatilityPercent);return n&&a>=n&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),a<n&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},xx=class extends ze{constructor(e,t,i,n){super(),this.statsGatherer=e,this.diagnostics=t,this.configProvider=i,this.logger=n,this.paused=!1,this.started=!1,this.cpuMetricCollector=new Mx(this.logger,this.configProvider.config.diagnostics.performanceMonitoring.cpuMetricCollector),this.trackInterval=this.configProvider.config.diagnostics.performanceMonitoring.remoteVideoTrackInterval,this.badPerfIds=new Set,this.perfTrackerMap=new Map,this.subs=[],this.rendererFpsCap=40,this.configProvider.config.diagnostics.performanceMonitoring.useComputePressure&&Dx.isSupported()&&(this.cpuPressureObserver=new Dx(this.logger))}start(){this.logger.safe.debug("Starting RemoteVideoPerformanceCalculator"),this.started?this.logger.safe.debug("RemoteVideoPerformanceCalculator already running. Do nothing."):(this.calculatorStrategy=Ox.getStrategy(this.configProvider),this.started=!0,this.cpuPressureObserver?.start(),this.subs.push(this.statsGatherer.on("onDiagnosticUpdated",(e=>this.processStats(e)))))}stop(){this.logger.safe.debug("Stopping RemoteVideoPerformanceCalculator"),this.started=!1,this.subs.forEach((e=>{e.dispose()})),this.cpuMetricCollector.stop(),this.cpuPressureObserver?.stop()}dispose(){this.logger.safe.debug("Disposing RemoteVideoPerformanceCalculator"),this.cleanupMaps(),this.stop()}cleanupMaps(){this.badPerfIds.clear(),this.perfTrackerMap.clear()}async processStats(e){this.paused||e.video?.recv?.length&&e.video?.recv?.forEach((async t=>{const i=t.renderer?.msi;if(!this.perfTrackerMap.has(i)){const e={id:t.mediaEntity.remoteTrackId,decodeTimeTracker:new CO(this.trackInterval),macroblockLossTracker:new CO(this.trackInterval),macroblockMaxLossTracker:0,freezeDurationPercent:0,frameHeight:0,rendererFps:new CO(this.trackInterval),incomingFps:new CO(this.trackInterval),framesReceived:0,framesDecoded:0,decoder:"",msi:i};this.perfTrackerMap.set(i,e)}const n=this.perfTrackerMap.get(i);if(t.inboundRTP.totalDecodeTime&&t.inboundRTP.framesDecoded){const e=Ct(t.inboundRTP.totalDecodeTime/t.inboundRTP.framesDecoded*1e3,2);n.decodeTimeTracker.captureSample(e)}const r=t.extensions.macroblockRateStats?.macroblockRateDecoderLossPercent;n.macroblockLossTracker.captureSample(r),n.macroblockMaxLossTracker=t.extensions.macroblockRateStats?.macroblockRateMaxDecoderLossPercent,t.extensions.duration&&(n.freezeDurationPercent=t.extensions.totalFreezeDuration/t.extensions.duration*100),n.frameHeight=t.inboundRTP.frameHeight||0,void 0!==t.extensions.frameRateDecoded&&void 0!==t.inboundRTP.framesPerSecond&&t.extensions.frameRateDecoded<=this.rendererFpsCap&&t.inboundRTP.framesPerSecond<=this.rendererFpsCap&&(n.rendererFps.captureSample(t.extensions.frameRateDecoded),n.incomingFps.captureSample(t.inboundRTP.framesPerSecond)),t.inboundRTP.framesReceived&&t.inboundRTP.framesDecoded&&(n.framesReceived=t.inboundRTP.framesReceived,n.framesDecoded=t.inboundRTP.framesDecoded),n.decoder=t.inboundRTP.decoderImplementation,n.rendererFps.isReportComplete()&&n.incomingFps.isReportComplete()&&n.decodeTimeTracker.isReportComplete()&&(this.paused=!0,await this.checkQuality(n,e.perfCounters),this.paused=!1)}))}async checkQuality(e,t){const i=[];let n;try{n=await this.cpuMetricCollector.getCurrentCpuSample()}catch{this.logger.safe.debug("CPU sampling is not supported")}const r={ts:Date.now(),trackId:e.id,decodeTime:e.decodeTimeTracker.getReport(),macroblockLossPercent:e.macroblockLossTracker.getReport(),macroblockMaxLossPercent:e.macroblockMaxLossTracker,freezeDurationPercent:e.freezeDurationPercent,perfCounters:t,cpuUsage:n,rendererFps:e.rendererFps.getReport(),incomingFps:e.incomingFps.getReport(),framesDecoded:e.framesDecoded,framesReceived:e.framesReceived,msi:e.msi,frameHeight:e.frameHeight,decoder:e.decoder};i.push(r);const s=this.calculatorStrategy.checkQuality(e);0===s&&(this.diagnostics.registerVideoPerformanceEvent(i,1),this.logger.safe.debug(`Bad perf detected for msi ${e.msi}: ${JSON.stringify(i)}`),this.event("calculatorStateChanged").raise(1,{msi:e.msi})),2===s&&(this.diagnostics.registerVideoPerformanceEvent(i,0),this.logger.safe.debug(`Good perf detected for msi ${e.msi}: ${JSON.stringify(i)}`),this.event("calculatorStateChanged").raise(0,{msi:e.msi})),this.perfTrackerMap.delete(e.msi)}},Ux=class extends ze{constructor(e,t,i,n){super(),this.statsGatherer=e,this.diagnostics=t,this.configProvider=i,this.logger=n,this.calculators=new Map,this.subs=[]}on(e,t){switch(e){case"onIncomingVideoQualityChanged":this.addCalculator(0),this.startCalculator(0);break;case"onOptimalVideoCountChanged":this.addCalculator(2),this.startCalculator(2)}return this.subscribe({changed:void 0,on:{name:String(e),handler:t}})}addCalculator(e){let t=this.calculators.get(e);if(!t){switch(e){case 0:if(!this.configProvider.config.diagnostics.performanceMonitoring.enableRemoteVideoCalculator)return;t=new xx(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("RemoteVideoPerformanceCalculator"));break;case 2:if(!this.configProvider.config.enableOptimalVideoCount)return;t=new Rx(this.configProvider,this.logger.createChild("OptimalVideoCountCalculator"));break;case 1:throw new Error("Not implemented")}this.subs.push(t.on("calculatorStateChanged",((t,i)=>{this.handleChanged(e,t,i)}))),this.calculators.set(e,t)}}startCalculator(e){this.logger.safe.debug(`adding calculator with id ${e}`);const t=this.calculators.get(e);t&&t.start()}stopCalculator(e){this.logger.safe.debug(`stopping calculator with id ${e}`);const t=this.calculators.get(e);t&&t.stop()}processNotification(e,t){switch(e){case"BandwithNotification":this.calculators.get(2)?.processEstimatedBandwidth(t.bw);break;case"ParticipantCountChanged":this.calculators.get(2)?.updateParticipantCount(t.count);break;default:this.logger.safe.info(`Notification message handler not found for type: ${e}`)}}dispose(){super.dispose(),this.calculators.forEach((e=>{e.dispose()})),this.subs.forEach((e=>{e.dispose()}))}handleChanged(e,t,i){switch(this.logger.info(`calculatorStateChanged  ${t}: calculatorType ${e} ${JSON.stringify(i)}`),e){case 0:this.configProvider.config.diagnostics.performanceMonitoring.enableLowerResolution&&this.event("onIncomingVideoQualityChanged").raise(t,i?.msi);break;case 2:this.event("onOptimalVideoCountChanged").raise(i?.ovc,i?.ovcPayload)}}},Fx=p,Vx=class{constructor(e){this.configProvider=e,this.outboundNetworkQuality="Good",this.inboundNetworkQuality="Good",this.jitterAccumulator=new uw(this.configProvider.config.webrtcJitterWindowSize),this.healedRatioAccumulator=new uw(this.configProvider.config.webrtcHealedRatioWindowSize),this.jitterStateProcessor=new Tk(e.config.webrtcJitterLowThreshold,e.config.webrtcJitterHighThreshold,!0,e.config.webrtcJitterSticknessTime),this.lossRateStateProcessor=new Tk(e.config.webrtcLossRateLowThreshold,e.config.webrtcLossRateHighThreshold,!0,e.config.webrtcLossRateSticknessTime)}processReport(e){e.audio?.recv?.length&&(this.inboundNetworkQuality=this.processInboundSample((0,Fx.last)(e.audio.recv))),e.audio?.send?.length&&(this.outboundNetworkQuality=this.processOutboundSample((0,Fx.last)(e.audio.send)))}getInboundNetworkQuality(){return this.inboundNetworkQuality}getOutboundNetworkQuality(){return this.outboundNetworkQuality}processInboundSample(e){const t=this.inboundNetworkQuality,{totalSamplesReceived:i}=e.inboundRTP,{healedRatio:n}=e.extensions??{};null!=n&&this.healedRatioAccumulator.add(n);const r=(0,Fx.mean)(this.healedRatioAccumulator.items);return!i||i<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality?t:r&&this.healedRatioAccumulator.isFull?this.determineInboundQualityLevel(r):t}determineInboundQualityLevel(e){const t=this.inboundNetworkQuality,i=this.configProvider.config.webrtcStatNetworkDetectionHysteresis,n=this.configProvider.config.webrtcStatNetworkDetectionBadLevel,r=this.configProvider.config.webrtcStatNetworkDetectionGoodLevel;return e<r-i/2?"Good":e<r+i/2?"Good"===t?"Good":"Poor":e<n-i/2?"Poor":e<n+i/2?"Bad"===t?"Bad":"Poor":"Bad"}processOutboundSample(e){const t=this.outboundNetworkQuality,{packetsSent:i,timestamp:n}=e.outboundRTP,{jitter:r}=e.remoteInboundRTP??{},{lossRate:s}=e.extensions??{};if(!i||i<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return t;null!=r&&this.jitterAccumulator.add(r);const a=(0,Fx.mean)(this.jitterAccumulator.items),o=this.jitterAccumulator.isFull?this.jitterStateProcessor.onSample(a,n):"Good",c=s?this.lossRateStateProcessor.onSample(s,n):"Good";return"Good"===o&&"Good"===c?"Good":"Bad"}},Bx=p,Hx=class{constructor(e){this.configProvider=e,this.speechWindow=new uw(e.config.webrtcSpeakingWhileMutedDetectionWindow)}processReport(e){if(!e.audio?.send?.length)return!1;const t=e.audio.send[0],{rawInputVolume:i,callIsMuted:n}=t.extensions??{},{audioLevel:r}=t.mediaSource??{},{useAudioAnalyzer:s,webrtcSpeakingWhileMutedDetectionLevel:a}=this.configProvider.config;if(!n)return this.speechWindow.clear(),!1;const o=s?i:r;return null!=o&&this.speechWindow.add(o),!!this.speechWindow.isFull&&(0,Bx.mean)(this.speechWindow.items)>a}},$x=0,Gx=class e{constructor(e,t,i){this.context=e,this.callId=t,this.callback=i,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc2-"+ ++$x),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.capabilityGatherer=oN({global:this.context.maContext},this.configProvider.config.useSdpCapabilities,this.configProvider.config.noRequiredCodecsWorkaround),this.reinvitelessContext=wm(this.context.config.reinvitelessConfig,this.multiParty),this.iceHostCandidateOnly=this.multiParty&&ft("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new dx({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:this.multiParty,reinviteltessContext:this.reinvitelessContext}),this.sessionDescription=EM.build({sdpTransform:new sx(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=ft("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new zD({streamAdded:e=>this.streamAdded(e),streamRemoved:e=>this.streamRemoved(e)}),this.diagnostics=this.context.diagnostics,this.qmDiagnostics=this.diagnostics?.newQualityManagerDiagnostics(),this.statsGatherer=new Jk(this.logger.createChild("stats"),this.configProvider,this.diagnostics,this.mediaManager,this.multiParty),this.networkQualityDiagnostics=new Vx(this.configProvider),this.speechDetectionDiagnostics=new Hx(this.configProvider),this.qualityManager=new NN(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,customBwEstimationEnabled:this.configProvider.config.webrtcEnabledCustomBwEstimationForVideo,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},this,this.statsGatherer,this.qmDiagnostics,this.configProvider),this.activeSpeakerManager=new GD(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,this.diagnostics?.dshDiagnostics,this.logger.createChild("ActiveSpeakerManager")),this.negotiationQueue=new $A(this.logger),this.negotiationEmulator=new RN(this.logger.createChild("negotiationEmulator"),ax,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.wasConnected=!1,this.toBeCalledAfterConnected=[],this.peerConnection=null,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Yu,this.iceCandidatesTimer=null,this.relayCandidateGathered=!1,this.iceCandidateReceived=!1,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.reinvitelessRequestedModalities={},this.reinvitelessAppliedModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({type:"WebRtcMediaStats",data:{}}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=jN({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=ft("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new YD(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:e=>this.streamsChangedListener=e},this.diagnostics?.newSubscriptionManagerDiagnostics()),this.remoteVideoResolutionManager=new LN(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.statsGatherer,this.diagnostics),this.remoteVideoManager=new VN(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.statsGatherer,this.diagnostics,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.transceiverManager=null,this.encStreamsManager=new cL(this.configProvider,this.context.maContext.getEncodedStreamsWorkerProvider?.(),this.logger.createChild("EncodedStreamsManager")),this.streamSendersManager=new XL(this.mediaManager,this.logger.createChild("SSM"),this.context.callDeviceManager,this.configProvider,this.statsGatherer,this.qmDiagnostics,this.multiParty,this.encStreamsManager),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Yu,this.transportStateProvider=null,this.deviceManagerSubs=[],this.isMuteHold=!1,this.rawIncomingAudioStreamManager=new Lg(this.logger.createChild("rawIncomingAudioStream")),this.useNullAudioStream=!1,this.audioCodecManager=new Ix(this.encStreamsManager,this.logger,this.configProvider),this.perfMonitorSubs=[],this.ufdManager=e.getUfdManager(),this.statsGatherer.on("onDiagnosticUpdated",(e=>this.processStatsReport(e))),this.statsGatherer.on("onStatisticsChanged",(e=>this.processLegacyStats(e))),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((e,t,i)=>this.requestSource(e,t,i))),this.performanceMonitor=new Ux(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("PerformanceMonitor")),this.setSubsForSubscriptionManager(),this.setSubsForStreamManagerEvents(),this.configProvider.mediaConfig.maxBandwidthInKbps&&(this.statsGatherer.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.diagnostics&&(this.diagnostics.maxSessionBandwidth=this.configProvider.mediaConfig.maxBandwidthInKbps)),this.createAudioRenderer(),this.setSubsForDeviceManager(),this.context.callDeviceManager.isVirtualDeviceEnabled&&this.setupCallDeviceManagerSubs(),this.configProvider.config.enableActiveSpeakerBasedDSH&&this.activeSpeakerManager.setStrategy(new ix({configProvider:this.configProvider})),this.perfMonitorSubs.push(this.performanceMonitor.on("onIncomingVideoQualityChanged",((e,t)=>{this.onIncomingVideoQualityChanged(e,t)}))),this.configProvider.config.webrtcVideoScaling&&(this.perfMonitorSubs.push(this.performanceMonitor.on("onOptimalVideoCountChanged",((e,t)=>{this.onOptimalVideoCountChanged(e,t)}))),this.onOptimalVideoCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount))}get iceTransportPolicy(){return this.configProvider.getIceTransportPolicy()}getAcceptedTypes(){return this.allowedMediaContentType}clone(t,i){const n=ot(this.context);n.config=ot(this.context.config),n.config.webrtcMediaContentType=this.mediaContentType,n.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,n.configProvider=i,n.diagnostics=this.context.diagnostics?.newNativeSession(!1),t?(n.config.isConference=!0,n.config.isPstnCall=!1):(n.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(n.config.webrtcIceGatheringTimeoutIncreased=!0));const r=new e(n,this.callId,this.callback);return this.useNullAudioStream&&r.useNullAudioStreamClient(),this.relayManagerProvider&&(r.relayManagerProvider=this.relayManagerProvider),r.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,r}async setCallConstraints(e,t){const i=this.configProvider.setCallConstraints(e);if(this.logger.safe.info(`[${t}] Setting call constraints ${JSON.stringify(i)}, enableDynamicCallConstraints: ${this.configProvider.config.enableDynamicCallConstraints}`),this.configProvider.config.enableDynamicCallConstraints)try{await this.streamSendersManager.applyCallConstraints(t),this.configProvider.addCallConstraintsTelemetryEvent(i,"applied")}catch(e){throw this.logger.safe.error(`Error while applying constraints: ${e}`),e}else this.configProvider.addCallConstraintsTelemetryEvent(i,"applied");return i}setInternals(e,t){if(this.logger.safe.info(`[${t}] Setting internals from previous session`),this.diagnostics?.commitNativeSession(),e.extensionsManager&&this.extensionsManager){const t=e.extensionsManager.getExtension("videoStreamControl");t?.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",t.getOptions())}e.subscriptionManager&&(this.subscriptionManager?.dispose(),this.subscriptionManager=e.subscriptionManager,this.subscriptionManager.setDiagnostics(this.diagnostics?.newSubscriptionManagerDiagnostics()),this.subscriptionManager.setStreamProvider({getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:e=>this.streamsChangedListener=e}),this.subscriptionManager.setLogger(this.logger.createChild("subs")),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),e.audioRenderer&&(e.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=e.audioRenderer),e.remoteVideoManager?.moveRenderers(this.remoteVideoManager),e.rawIncomingAudioStreamManager&&this.rawIncomingAudioStreamManager.updateHandlers(e.rawIncomingAudioStreamManager.handlerMap),this.audioRenderer.getStream()&&this.rawIncomingAudioStreamManager.streamChanged(this.audioRenderer.getStream())}setSubsForDeviceManager(){const e=this.getVideoDeviceManager();this.deviceManagerSubs=[e.on("onLocalRendererStarted",(e=>e.setStatsProvider(this.statsGatherer)))],this.configProvider.config.enablePlayVideoOnStreamUnmuteWorkaround&&this.deviceManagerSubs.push(e.on("onAudioStreamMuted",(e=>{e||this.remoteVideoManager.playVideo()})))}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(e=>this.statsGatherer.setSubscribedTrackIds(e))),this.subscriptionManager.on("onTrackSsrcChanged",(e=>this.statsGatherer.setSubscribedTrackSsrc(e))),this.subscriptionManager.on("onSubscriptionChanged",((e,t,i,n,r,s)=>this.onSubscriptionChanged(e,t,i,n,r,s))),this.subscriptionManager.on("onSubscriptionFailed",((e,t,i,n,r)=>this.statsGatherer.addSubscriptionEvent(e,t,i,n,r)))]}onSubscriptionChanged(e,t,i,n,r,s){t===Qe.MODALITY.video&&(2===e&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount()),3===e&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount())),this.statsGatherer.addSubscriptionEvent(e,t,i,n,null,r,s)}setSubsForStreamManagerEvents(){this.streamSendersManager.on("onSendStreamChanged",((e,t)=>{this.statsGatherer.updateSendStream(e,t),e?.hasAudio()&&this.diagnostics?.setAudioSendStream(e,t),this.diagnostics?.setPresentationAudioOnScreenSharing(e,t)})),this.streamSendersManager.on("onVideoCaptureFreeze",(e=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",e?"Bad":"Good","Video")})),this.streamSendersManager.on("onMaxVideoSendCapabilitiesChanged",((e,t)=>this.onMaxVideoSendCapabilitiesChanged(e,t)))}move(e,t){this.logger.safe.info(`[${t}] moving to new session`),e.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager,rawIncomingAudioStreamManager:this.rawIncomingAudioStreamManager},t),e.muteHold(this.isMuteHold,t),this.doAudioMute?e.muteInputAsync(t):e.unmuteInputAsync(t),this.subscriptionManager=null,this.audioRenderer=null,this.rawIncomingAudioStreamManager=null,this.callbacks.onTerminated=null}setMute(e,t,i){this.logger.safe.info(`[${i}] call setMute for ${e} with mute state ${t}`),this.streamSendersManager.setMuted(e,t,i),this.processLegacyStats(this.statsGatherer.getLastStatistics())}configureModalitiesAsync(e,t){const i=(async()=>{if(await this.configuredModalitiesPromise,!e||!e.audio&&!e.video&&!e.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(e)}`);const i=ot(e),n=ot(this.negotiatedModalities);this.configProvider.config.alwaysNegotiateDataChannel&&(delete i.data,delete n.data);const r=!this.configuredModalities||!em(i,n);this.configuredModalities=e,this.logger.safe.info(`[${t}] configure modalities`,`audio: ${e.audio}`,`video: ${e.video}`,`sharing: ${e.sharing}`,`data: ${e.data}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?.signalingState??"-"}`,`needNewRenegotiation: ${r}`),r&&(this.updateSendStreamsReinviteless(t)||(this.configProvider.config.removeSendersOnConfigureModalities&&!Yp(this.configuredModalities)&&await this.streamSendersManager.update(this.configuredModalities,!0,t),this.triggerRenegotiation(!1,t)))})();return this.configuredModalitiesPromise=i.catch((e=>{this.logger.safe.warn(`[${t}] Error during configuring modalities: ${Ve(e)}`)})),i}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}createAudioElement(e){this.audioRenderer.assureAudioElement(e)}useNullAudioStreamClient(){this.useNullAudioStream=!0,this.streamSendersManager.useNullAudioStreamClient()}createOfferAsync(e){const t=this.negotiationQueue.add((()=>this.doCreateOfferAsync(e)),e);return this.resetNegotiationQueue(e),t}getTimerTracker(e,t){return this.diagnostics?this.diagnostics.getTimerTracker(e,t):this.statsGatherer.getTimerTracker(e,t)}async doCreateOfferAsync(e){const t=this.getTimerTracker("createOfferAsync",{first:!0});t.mark("start"),this.logger.safe.info(`[${e}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,await this.assurePeerConnectionAsync(e,t.clone("assurePeerConnectionAsync")),t.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${e}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),Yp(this.negotiatingModalities)&&!st(this.negotiatedModalities)&&Object.keys(this.negotiatingModalities).forEach((e=>{void 0===this.negotiatedModalities[e]&&delete this.negotiatingModalities[e]})),this.transceiverManager.assureTransceivers(this.negotiatingModalities);const i=await this.assureStreamsAndDataChannel(this.negotiatingModalities,e,t.clone("assureStreamsAndDataChannel"));t.markAndMeasure("assurePeerConnectionAsync","assureStreamsAndDataChannel"),this.offeredModalities=i,!vm(this.context)&&this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[Qe.MODALITY.data]&&this.multiParty&&(this.offeredModalities[Qe.MODALITY.data]=Qe.MEDIA_STATE.inactive),this.configureAudioCodec(),this.logger.safe.info(`[${e}] create [offer] offered: ${JSON.stringify(this.offeredModalities)}`);const n=await this.peerConnection.createOffer();t.markAndMeasure("assureStreamsAndDataChannel","createOffer"),this.logger.unsafe.debug(`[${e}] create [offer] offer from peer connection, sdp: ${n.sdp}`);const r=this.sessionDescription.createLocalOffer(n.sdp);this.hasIceCandidates(r)||this.resetCandidateGathering(e),this.statsGatherer.startWaitingForStreamStart(this.offeredModalities),this.diagnostics&&(this.diagnostics.offeredModalities=i),this.setupIceGatheringTimeout(e);const s=r.toLocal();this.logger.unsafe.debug(`[${e}] create [offer] set local description`,"sdp:",s),await this.peerConnection.setLocalDescription({sdp:s,type:"offer"}),t.markAndMeasure("createOffer","sLD"),await this.iceCandidatesDeferred.promise,t.markAndMeasure("sLD","candidates");const a=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(a),a.updateModalities(this.offeredModalities),this.checkIceCandidates(a);const o=a.toOffer();this.logger.unsafe.debug(`[${e}] CREATE OFFER`,"sdp:",o);const c={blob:o,contentType:this.mediaContentType};return""===this.configProvider.mediaConfig.webrtcRequiredFeatures||this.multiParty||(c.requiredFeatures=this.configProvider.mediaConfig.webrtcRequiredFeatures),this.audioCodecManager.decoder?.setRecvPayloads(a.getPayloadsForMedia(Qe.MEDIA_TYPE.audio)),this.configProvider.countryCode&&(c.clientLocation=this.configProvider.countryCode),this.mediaManager.getMediaEntities().forEach((e=>{e.setExtension("midApplied",!0)})),this.doRetargetIfNeeded(c,r,e),this.reinvitelessContext.enabled&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),c.mediaDescriptions=this.getMediaDescriptions(this.offeredModalities)),this.setBWSeed(c),t.markAndMeasure("start","createOfferAsync"),c}processOfferAsync(e,t){const i=this.negotiationQueue.add((()=>this.doProcessOfferAsync(e,t)),t);return this.resetNegotiationQueue(t),i}async doProcessOfferAsync(e,t){const i=this.getTimerTracker("processOfferAsync",{first:!0});i.mark("start"),this.mediaManager.backup();const n=e.blob;if(this.logger.unsafe.debug(`[${t}] process [offer]`,"sdp:",n),this.configProvider.config.webrtcCompareContentTypeInOffer&&(ut(e.contentType,this.allowedMediaContentType),this.mediaContentType=e.contentType),this.checkOfferOriginator(e),this.offerOriginator=e.originator,e.requiredFeatures){const t=this.configProvider.mediaConfig.webrtcRejectedFeatures.split(",");gt(e.requiredFeatures.split(","),t)}if(this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(n),this.configProvider.config.multiStreamSupported){const e=function(e){const t=e.match(/a=x-multi-stream:(\d+)/);if(t)return parseInt(t[1])}(n),i=this.configProvider.config.numVideoChannelsGvc-this.configProvider.config.nonMultiStreamChannels;this.context.configProvider.mediaConfig.multiStreamChannelsOffered=e,e&&e<i&&(this.logger.safe.info(`Received ${e} multi stream channels, ${i} channels supported`),this.triggerRenegotiation(!0,t))}this.canTriggerRenegotiation=!1,this.offeredModalities=qp(this.offeredDescription.getModalities()),this.assignUnbundledTransport();let r=this.configProvider.config.removeUnsupportedVideoModality?this.offeredModalities:ot(this.offeredModalities);if(zp(this.offeredModalities.video)||Jp(this.offeredModalities.video)||zp(this.offeredModalities.sharing)||Jp(this.offeredModalities.sharing)){const n=this.offeredDescription.getVideoCodecs();try{i.mark("startGetCapabilities");const e=await this.capabilityGatherer.getCapabilities("video");i.markAndMeasure("startGetCapabilities","getCapabilities"),e.codecs.some((e=>n.some((t=>e.mimeType===t&&this.configProvider.config.primaryVideoCodecs.includes(t)))))||(this.logger.safe.warn(`[${t}] offer doesn't contain any supported video codecs`),this.disabledModalities.video=r.video,this.disabledModalities.sharing=r.sharing,delete r.video,delete r.sharing)}catch(e){this.logger.safe.error(`[${t}] failed to get video capability ${Ve(e)}`)}}return(!vm(this.context)&&(zp(this.offeredModalities.data)||Jp(this.offeredModalities.data))||this.dataChannel&&"Failed"===this.dataChannel.state)&&(this.logger.safe.info(`[${t}] Supressing data modality as data channel is not possible`),r=ot(r),delete r.data),i.markAndMeasure("start","processOfferAsync"),this.logger.safe.info(`[${t}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(r)}`),r}assignUnbundledTransport(){this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled())}checkOfferOriginator(e){if(this.offerOriginator&&this.offerOriginator!==e.originator&&this.configProvider.config.rejectIncompatibleOriginator)throw{detail:"mediaContent.originator is different on renegotiation",type:Qe.MEDIA_ERROR.incompatibleOriginator}}async createAnswerAsync(e,t){if(e)return{blob:"",contentType:this.mediaContentType};const i=this.getTimerTracker("createAnswerAsync",{first:!0});i.mark("start"),this.logger.safe.info(`[${t}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for");const n=this.configuredModalities;let r=this.negotiatingModalities=Qp(this.offeredModalities,n);await this.assurePeerConnectionAsync(t,i.clone("assurePeerConnectionAsync")),i.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${t}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),await this.handleCodecSwitchUnsupported(t),i.markAndMeasure("assurePeerConnectionAsync","handleCodecSwitchUnsupported"),this.configureAudioCodec();const s=this.offeredDescription.toRemote(r);this.logger.unsafe.info(`[${t}] create [answer] set remote description', 'negotiated:`,r,"sdp:",s),await this.peerConnection.setRemoteDescription({sdp:s,type:"offer"}),i.markAndMeasure("handleCodecSwitchUnsupported","setRemoteDescription"),this.transceiverManager.syncTransceivers(r),this.mediaManager.getMediaEntities().forEach((e=>{e.setExtension("midApplied",!0)})),await this.assureStreamsAndDataChannel(r,t,i.clone("assureStreamsAndDataChannel")),i.markAndMeasure("setRemoteDescription","assureStreamsAndDataChannel"),this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized();const a=await this.peerConnection.createAnswer();i.markAndMeasure("assureStreamsAndDataChannel","createAnswer"),this.logger.unsafe.debug(`[${t}] create [answer] answer from peer connection`,"sdp:",a.sdp);const o=this.sessionDescription.createLocalAnswer(a.sdp);this.hasIceCandidates(o)||this.resetCandidateGathering(t),this.statsGatherer.startWaitingForStreamStart(r),this.diagnostics&&(this.diagnostics.offeredModalities=r),this.setupIceGatheringTimeout(t);const c=o.toLocal();this.logger.unsafe.debug(`[${t}] create [answer] set local description`,"sdp:",c),await this.peerConnection.setLocalDescription({sdp:c,type:"answer"}),i.markAndMeasure("createAnswer","sLD"),await this.iceCandidatesDeferred.promise,i.markAndMeasure("sLD","candidates");const l=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(l),l.updateModalities(r),this.checkIceCandidates(l);const d=l.toAnswer();this.audioCodecManager.decoder?.setRecvPayloads(l.getPayloadsForMedia(Qe.MEDIA_TYPE.audio)),this.checkAudioCodecNegotiated(t),await this.streamSendersManager.activate(t),i.markAndMeasure("candidates","streamSendersManagerActivate"),this.updateLocalMediaSources(),this.applyReceiveCapabilities(),r=l.getModalities(),this.reinvitelessContext.enabled&&(r=nm(this.negotiatingModalities,r)),Zp(this.configuredModalities,this.negotiatingModalities,r)||this.triggerRenegotiation(!0,t),this.setNegotiatedModalities(r),this.statsGatherer.sessionInfo.setBweType(l.getBweType()),this.diagnostics&&(this.diagnostics.bweType=l.getBweType()),this.logger.unsafe.debug(`[${t}] CREATE ANSWER`,"sdp:",d);const h={blob:d,contentType:this.mediaContentType};return this.configProvider.countryCode&&(h.clientLocation=this.configProvider.countryCode),this.reinvitelessContext.enabled&&(h.mediaDescriptions=this.getMediaDescriptions(r)),this.setBWSeed(h),i.markAndMeasure("start","createAnswerAsync"),h}async processAnswerAsync(e,t,i,n=!1){const r=e.blob;this.logger.unsafe.debug(i?`[${t}] PROCESS PRANSWER`:`[${t}] PROCESS ANSWER`,"sdp:",r);const s=i?"pranswer":"answer";if(i&&(!Tm(this.context,n)||"have-local-offer"!==this.peerConnection.signalingState))return void this.logger.safe.info(`[${t}] process [${s}] ignored`);const a=this.getTimerTracker(i?"processProvisionalAnswerAsync":"processAnswerAsync",{first:!0});a.mark("start");const o=this.sessionDescription.createRemoteAnswer(r);let c=qp(o.getModalities());this.reinvitelessContext.enabled&&(c=nm(this.offeredModalities,c));const l=o.toRemote(c);i||(this.mediaContentType=e.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType),Yp(c)||(await this.streamSendersManager.update(c,!0,t),a.markAndMeasure("start","streamSendersManagerUpdate"),zp(this.offeredModalities.data)&&!c.data&&this.dataChannel?.disable()),this.setNegotiatedModalities(c),this.updateLocalMediaSources(),this.statsGatherer.sessionInfo.setBweType(o.getBweType()),this.diagnostics&&(this.diagnostics.bweType=o.getBweType())),this.callbacks.onTransportInitialized?.(),this.logger.unsafe.info(`[${t}] process [${s}] set remote description`,"negotiated:",c,"sdp:",l),a.mark("startSetRemoteDescription"),await this.peerConnection.setRemoteDescription({sdp:l,type:s}),a.markAndMeasure("startSetRemoteDescription","setRemoteDescription"),i||(await this.streamSendersManager.activate(t),a.markAndMeasure("setRemoteDescription","streamSendersManagerActivate"),this.applyReceiveCapabilities(),this.checkAudioCodecNegotiated(t),this.transceiverManager.syncTransceivers(c),a.markAndMeasure("start","processAnswerAsync"))}async completeNegotiationAsync(e){this.mediaManager.commit();const t=this.configuredModalities,i=this.forceMediaStreamUpdate&&!Yp(this.negotiatedModalities)||!Zp(t,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,n=!i;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${e}] negotiation completed isComplete: ${n} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),i&&this.triggerRenegotiation(!1,e);for(const e of this.getVideoDeviceManager().getLocalVideoRenderers())e.setStatsProvider(this.statsGatherer);return this.negotiationCompletedPromise.resolve(),{isComplete:n,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator}}async rejectNegotiationAsync(e,t,i=!1){let n;this.mediaManager.rollback(),this.logger.safe.warn(`[${t}] negotiation rejected isComplete: ${!i} error: ${Ve(e)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.qualityManager.clearPendingCapabilities();const r=this.getModalitiesForRollback(t);if(this.transceiverManager?.syncTransceivers(r),await this.assureStreamsAndDataChannel(r,t),"have-local-offer"===this.peerConnection?.signalingState){n={},this.logger.safe.info(`[${t}] rolling back local description`);try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRollback){n.type="LocalRN",this.logger.safe.info(`[${t}] rolling back using local renegotiation`);const e=[new ZD(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(e,!0),this.logger.safe.info(`[${t}] rolling back using local complete`)}else this.logger.safe.info(`[${t}] rolling back using rollback`),n.type="Rollback",await this.peerConnection.setLocalDescription({type:"rollback"})}catch(e){this.logger.safe.error(`[${t}] rollback error`,e),n.error=e}}else if("have-remote-offer"===this.peerConnection?.signalingState){n={};try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRemoteRollback){n.type="RemoteRN",this.logger.safe.info(`[${t}] applying answer for remote renegotiation`);const e=[new ZD(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(e,!0,"remote")}else this.logger.safe.info(`[${t}] rolling back using rollback on remote description`),n.type="Rollback",await this.peerConnection.setRemoteDescription({type:"rollback"})}catch(e){this.logger.safe.error(`[${t}] rollback error`,e),n.error=e}}else this.peerConnection&&this.logger.safe.error(`[${t}] cannot rollback local description in current state: ${this.peerConnection.signalingState}`);return this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),i&&(this.logger.safe.info(`[${t}] retrying failed negotiation`),this.triggerRenegotiation(!1,t)),{isComplete:!i,activeModalities:r,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator,rollback:n}}async startMediaDescriptionsUpdateAsync(e){return this.reinvitelessAppliedModalities=await this.assureStreamsAndDataChannel(this.reinvitelessRequestedModalities,e),this.updateLocalMediaSources(),await this.streamSendersManager.activate(e),this.getMediaDescriptions(this.reinvitelessAppliedModalities)}async completeMediaDescriptionsUpdateAsync(e){this.logger.safe.info(`[${e}] complete media descriptions update`),this.setNegotiatedModalities(this.reinvitelessAppliedModalities);const t=this.reinvitelessAppliedModalities,i=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:t,requestedModalities:i}}async rejectMediaDescriptionsUpdateAsync(e,t=!1){this.logger.safe.info(`[${e}] reject media descriptions update`),t&&(this.logger.safe.info(`[${e}] trigger renegotiation after failed media descriptions update`),this.triggerRenegotiation(!1,e));const i=await this.streamSendersManager.update(this.negotiatedModalities,!0,e),n=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:i,requestedModalities:n}}createRemoteRenderer(e){return this.remoteVideoManager.createRenderer(e,this.subscriptionManager,this.logger)}getStatsAsync(e){if(this.statsGatherer&&!this.statsGatherer.isDisposed){if(this.audioCodecManager){const e=this.audioCodecManager.getSessionEvents();this.statsGatherer.sessionInfo.setAudiocCodecEvents(e),this.diagnostics&&(this.diagnostics.audioCodecEvents=e)}this.statisticsReport=this.statisticsReport.then((()=>this.statsGatherer.getReport(e))).catch((e=>(this.logger.safe.error(`getting statistics should never fail: ${e.error}`),e.partialReport)))}return this.statisticsReport}getLastKnownStats(e){return this.statsGatherer.getReport(!1,e)}muteHold(e,t){this.logger.safe.info(`[${t}] set muteHold state ${e}`),this.isMuteHold=e;const i=[Qe.MODALITY.audio,Qe.MODALITY.video,Qe.MODALITY.sharing].filter((e=>zp(this.negotiatedModalities[e])&&(e!==Qe.MODALITY.audio||!this.doAudioMute)));for(const n of i)this.setMute(cm(n),e,t)}async muteInputAsync(e){this.doAudioMute=!0,this.setMute("Audio",!0,e)}async unmuteInputAsync(e){this.doAudioMute=!1,this.setMute("Audio",!1,e)}muteOutputAsync(e){return this.audioRenderer.setMuted(!0,e)}unmuteOutputAsync(e){return this.audioRenderer.setMuted(!1,e)}sendDtmf(e){return this.dtmfSender.sendDtmf(this.peerConnection,e)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(e=Te()){const t=new Yu;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(t,e)})),t}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(e){this.statsGatherer.onDeviceEvent(e)}deviceSelectionChanged(){this.peerConnection&&this.audioRenderer?.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId())}async terminate(e,t,i=!0){this.logger.safe.info(`[${e}] terminate`),this.statsGatherer.setTerminated(),this.diagnostics?.terminate(),this.perfMonitorSubs.forEach((e=>e?.dispose())),this.performanceMonitor.dispose(),this.terminated=!0,this.canTriggerRenegotiation=!1,await(this.audioCodecManager.decoder?.storeApiRecording()),this.cleanUp(e);try{i&&await this.getStatsAsync(!1)}catch(t){this.logger.safe.error(`[${e}] Error while gathering stats ${Ve(t)}`)}finally{this.statsGatherer.dispose()}}getIncomingRawAudioStream(){this.logger.info("IRawStream for incoming audio stream requested");const e=this.audioRenderer.getStream();return this.rawIncomingAudioStreamManager.createIRawStreamClient(e)}getUnmixedAudioProvider(){return this.audioCodecManager.decoder?.getUnmixedAudioProvider()}configureSpatialAudio(e,t){this.configProvider.mediaConfig.spatialAudioEnabled=e,this.audioCodecManager.configureSpatialAudio(e,t)||this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable","Bad","Audio",!0,t)}setParticipantSpatialAudioPositions(e,t){if(!this.configProvider.mediaConfig.spatialAudioEnabled||!this.audioCodecManager?.decoder)throw this.logger.safe.error(`[${t}] setParticipantSpatialAudioPositions is called while MUCH audio decoder is not created or not enabled`),"setParticipantSpatialAudioPositions not allowed";this.audioCodecManager.decoder?.setParticipantSpatialAudioPositions(e)}processNotification(e,t){this.performanceMonitor.processNotification(e,t)}cleanUp(e){this.negotiationQueue.dispose(),this.rawIncomingAudioStreamManager?.dispose(),this.remoteVideoManager.dispose(),this.dataChannel&&(this.dataChannel.dispose(),this.dataChannel=null),this.deviceManager.effectsManager.setAecRefStream(null),this.resetPeerConnection(e),this.subscriptionManagerSubs.forEach((e=>e.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.deviceManagerSubs.forEach((e=>e.dispose())),this.callDeviceManagerSub?.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(e){this.logger.safe.info(`[${e}] reset peer connection`),this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.qualityManager?.dispose(),this.qualityManager=null,this.audioRenderer?.dispose(),this.dtmfSender?.dispose(),this.dtmfSender=null,this.streamSendersManager?.dispose(),this.streamSendersManager=null,this.transceiverManager=null,this.encStreamsManager.dispose(),this.receiveStreamCollection.clear(),this.transportStateProvider?.dispose(),this.transportStateProvider=null,this.audioCodecManager.dispose(),this.mediaManager.reset(),this.peerConnection?.close(),this.peerConnection=null,this.toBeCalledAfterConnected=[],this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(e),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(e){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Yu,e)}setNegotiationPromise(e,t=Te()){this.terminated||(this.negotiationCompletedPromise=e,this.negotiationQueue.add(this.negotiationCompletedPromise,t))}setupExtensionsManager(){const e=new LO(this.logger.createChild("ExtMgr"));return e.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),e.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,diagnostics:this.qmDiagnostics,configProvider:this.configProvider,statisticsGatherer:this.statsGatherer}),e.addExtension("bandwidthTelemetry",{statisticsGatherer:this.statsGatherer,diagnostics:this.diagnostics}),this.configProvider.config.setBWSeed&&e.addExtension("bandwidthCache",{logger:this.logger,configProvider:this.configProvider}),e}processStatsReport(e){if(this.remoteVideoManager.processStatsReport(e),this.configProvider.config.diagnostics.features.useNewNetworkUFD){this.networkQualityDiagnostics.processReport(e);const t=this.networkQualityDiagnostics.getInboundNetworkQuality();this.ufdManager.signalEvent("NetworkRecvQuality",t);const i=this.networkQualityDiagnostics.getOutboundNetworkQuality();this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":i)}this.configProvider.config.diagnostics.features.useNewSpeakingWhileMutedUFD&&this.ufdManager.signalEvent("DeviceSpeakWhileMuted",this.speechDetectionDiagnostics.processReport(e)?"Bad":"Good")}processLegacyStats(e){if(e&&(this.remoteVideoManager.processLegacyStats(e),this.hwSilent!==e.audioHwSilent&&(this.hwSilent=e.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.configProvider.config.diagnostics.features.useNewNetworkUFD||(this.ufdManager.signalEvent("NetworkRecvQuality",e.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:e.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":e.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:e.networkSendLevel})),!this.configProvider.config.diagnostics.features.useNewSpeakingWhileMutedUFD)){const t=!(!e.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",t?"Bad":"Good")}}triggerRenegotiation(e,t=Te()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${t}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(t)):e&&(this.logger.safe.info(`[${t}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(e){if(!this.configuredModalities)throw new Error(e)}async handleCodecSwitchUnsupported(e){if(!this.offeredDescription.isCodecSwitchSupported())try{const e=(await this.capabilityGatherer.getCapabilities(Qe.MEDIA_TYPE.audio)).codecs.map((e=>e.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(e)}catch(t){this.logger.safe.error(`[${e}] failed to set primary codec based on audio capability ${Ve(t)}`)}}assurePeerConnectionAsync(e,t){return this.peerConnectionPromise??(this.peerConnectionPromise=this.getPeerConnectionPromise(e,t)),this.peerConnectionPromise}async getPeerConnectionPromise(e,t){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info(`[${e}] fetching relay details from RelayManager...`);const i={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};t.mark("startQueryRelaysAsync");const n=await this.relayManagerProvider.getRelayManager().queryRelaysAsync(i);if(t.markAndMeasure("startQueryRelaysAsync","queryRelaysAsync"),this.terminated)throw new Error("session already disposed");const r={optional:[]},s=DD(n,this.configProvider.config),a=this.configureCrypto(r);this.configureCpuThreshold(r),this.logger.safe.info("create peer connection");const o="unified-plan",c=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle";try{this.peerConnection=new Vp.window.RTCPeerConnection({iceServers:s,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,iceCandidatePoolSize:this.configProvider.config.iceCandidatePoolSize,bundlePolicy:c,sdpSemantics:o,audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===a,encodedInsertableStreams:!!this.configProvider.config.useInsertableStreams},r)}catch(e){throw e.code===DOMException.INVALID_STATE_ERR&&this.ufdManager.signalEvent("NoNetwork","Bad"),e}const l=this.peerConnection;this.isRollbackSupported=1===a&&this.context.configProvider.userAgentConfig.isBrowserRollbackSupported,this.negotiationEmulator.configure(l),this.statsGatherer.initialize(l),this.statsGatherer.sessionInfo.setIceServers(s),this.statsGatherer.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.statsGatherer.sessionInfo.setSdpSemantics(o),this.statsGatherer.sessionInfo.setBundlePolicy(c),this.diagnostics&&(this.diagnostics.iceServers=s,this.diagnostics.iceTransportPolicy=this.iceTransportPolicy,this.diagnostics.sdpSemantics=o,this.diagnostics.bundlePolicy=c),await this.checkVideoCodecsSupport(),t.markAndMeasure("queryRelaysAsync","checkVideoCodecsSupport"),l.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${l.signalingState}`)},l.onsignalingstatechange=()=>{const e=Te();this.statsGatherer.sessionInfo.setSignalingConnectionState(l.signalingState),this.diagnostics&&(this.diagnostics.signalingConnectionState=l.signalingState),this.logger.safe.info(`[${e}] onsignalingstatechange signalingState: ${l.signalingState}`),this.transportStateProvider&&this.transportStateProvider.subscribeForDtlsTransportState(),this.configProvider.config.reconnectOnPcClose&&!this.terminated&&"closed"===l.signalingState&&this.isTransportConnected()&&this.raiseError({type:Qe.MEDIA_ERROR.unexpectedClose,detail:"PeerConnection is closed"},e)},l.onicecandidateerror=e=>{const t=e,[i,n]=[t.address,t.port];if(this.logger.safe.warn(`On ICE candidate error ${t.url} | ${i}:${n}: code ${t.errorCode}: ${t.errorText}`),!this.isConnected()||this.iceCandidatesDeferred.isPending){const e={address:i,port:+n,url:t.url,errorCode:t.errorCode,errorText:t.errorText};this.statsGatherer.addIceCandidateError(e),this.diagnostics?.addIceCandidateError(e)}};const d=e=>{const{track:t,receiver:i,transceiver:n}=e,r=e.streams[0]??new MediaStream([t]);if(!(this.configProvider.config.addAudioStreamBeforeConnection&&Qe.TRACK_KIND.audio===t.kind||this.isConnected()))return this.logger.safe.info("ontrack handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>d(e)));this.logger.safe.info(`ontrack track ${t.id}, stream: ${r?.id}, transceiver=${n?.mid}`);let s=r?.active;if(!s&&this.configProvider.config.useInactiveAudioTrack&&"audio"===t.kind&&(this.logger.safe.warn("ontrack override forcing to use inactive audio stream"),s=!0),!s||"stopped"===n?.currentDirection||n?.stopped)return void this.logger.safe.info("ontrack ignore non active stream");let a=this.mediaManager.getMediaEntityByRemoteStreamId(r.id);if(a||(this.logger.safe.info(`cannot find media entity with stream id ${r.id} trying to fallback`),r.getAudioTracks()[0]&&(a=this.mediaManager.getMediaEntitiesByModality(Qe.MODALITY.audio)[0])),a){const e=this.createReceiveStream(r,i,t,a);a.setRemoteTrackId(t.id),this.addReceiveStreamTransforms(i,a.getModality()),this.receiveStreamCollection.add(e)}else this.logger.safe.error(`could not find media entity for an added stream: ${r.id}`)};l.onaddstream=e=>{this.logger.safe.info(`onaddstream stream: ${e.stream.id}`)},l.ontrack=d;const h=e=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>h(e)));this.logger.safe.info(`onremovestream stream: ${e.stream.id}`),this.receiveStreamCollection.remove(e.stream.id)};l.onremovestream=h,l.onicecandidate=t=>{const i=t.candidate;if(i){const t=rm(i.candidate);if(this.logger.safe.info(`[${e}] onicecandidate candidate: component:${t.component} protocol:${t.protocol} prio:${t.priority} type:${t.type} port:${t.port}`),this.logger.unsafe.info(`[${e}] candidate details: ${i.candidate}`),"1"!==t.component)return;if(this.iceCandidateReceived=!0,this.statsGatherer.sessionInfo.setCandidateDetails(t),this.diagnostics?.setCandidateDetails(t),!this.relayCandidateGathered&&i.candidate.indexOf("typ relay")>-1){const e={priority:i.priority?.toString()||t.priority,time:Date.now()-this.iceRelayCandidatesGatherStartTime};this.statsGatherer.sessionInfo.setRelayCandidateInfo(e),this.diagnostics&&(this.diagnostics.relayCandidateInfo=e),this.relayCandidateGathered=!0}}else this.logger.safe.info(`[${e}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const n=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,r=this.iceHostCandidateOnly||0===s.length;if(!i&&n||r){i&&this.logger.safe.info(`[${e}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${e}] Is connected:`,this.isConnected(),l.iceConnectionState,l.signalingState);let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&i&&(t=this.sessionDescription.createLocalOffer(l.localDescription.sdp).hasUnbundledIceCandidates()),t&&this.completeCandidateGathering(e)}else if(this.relayCandidateGathered){let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&(t=this.sessionDescription.createLocalOffer(l.localDescription.sdp).hasUnbundledRelayIceCandidates()),t&&(this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),this.completeCandidateGathering(e))}},l.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${l.iceGatheringState}`)};const u=i=>{if(this.terminated)return;const n=this.wasConnected?Te():e,r=this.lastTransportConnectionState;if(this.lastTransportConnectionState=i,this.statsGatherer.sessionInfo.setIceConnectionState(i),this.diagnostics&&(this.diagnostics.iceConnectionState=i),"connecting"===i&&t.mark("transportConnecting"),"connected"===i||"completed"===i)t.markAndMeasure("transportConnecting","transportConnected"),this.onTransportConnected(n);else if("failed"===i||"closed"===i&&"failed"!==r){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${n}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(n);this.raiseError({type:Qe.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},n),this.configProvider.config.webrtcCloseAfterIceFailure&&l.close(),this.callbacks.onTransportFailed?.()}"disconnected"===i?(this.callbacks.onTransportDisconnected?.(e),this.startIceDisconnectedTimer(n)):this.clearIceDisconnectedTimer()};this.transportStateProvider=new ZL(l,a,this.logger,this.configProvider,(e=>u(e))),this.transceiverManager=new tL(this.logger,this.peerConnection,this.mediaManager,this.context,this.reinvitelessContext),this.streamSendersManager.registerRtpSenderManager(this.transceiverManager),vm(this.context)&&!this.dataChannel&&(this.dataChannel=new sp(this.peerConnection,this.statsGatherer,this.logger,this.configProvider),this.callback.onDataChannelUpdated(this.dataChannel)),this.multiParty&&(this.contributingSources=new yN(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new CN(this.logger.createChild("ContributingSourcesProvider"),l))),t.mark("startInitialize"),await this.encStreamsManager.initialize(),t.markAndMeasure("startInitialize","encStreamsManagerInitialize");const g=this.encStreamsManager.isWorkerLoaded();this.initAudioCodec(g),this.statsGatherer.sessionInfo.setEncodedStreamWorkerLoaded(g),this.diagnostics&&(this.diagnostics.encodedStreamWorker=g)}configureCrypto(e){let t=!1;const i=fm(this.context);if(this.offeredDescription){const e=this.offeredDescription.getSrtpInfo();this.statsGatherer.sessionInfo.setOfferedSrtpInfo(e),this.diagnostics&&(this.diagnostics.offeredSrtp=e),t=!e.dtls||e.sdes&&i}else t=i;t&&(this.logger.safe.info("configuring peer connection to use sdes"),e.optional.push({DtlsSrtpKeyAgreement:!1}));const n={dtls:!t,sdes:!!t};return this.statsGatherer.sessionInfo.setNegotiatedSrtpInfo(n),this.diagnostics&&(this.diagnostics.negotiatedSrtp=n),t?0:1}configureCpuThreshold(e){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&e.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(e){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${e}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(e){if(this.logger.safe.info(`[${e}] audio transport connected`),this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),!this.terminated)for(this.wasConnected=!0,this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval&&"have-remote-pranswer"===this.peerConnection.signalingState?this.handleEarlyMediaAudioState(e):this.callbacks.onAudioStateChanged?.(Qe.STREAMING_STATE.active,e),this.callbacks.onTransportConnected?.(e);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}handleEarlyMediaAudioState(e){const t=this.peerConnection.getReceivers().filter((e=>"audio"===e.track.kind))[0];if(!t)return this.logger.safe.warn(`[${e}] Connected transport with provisional answer with no audio receiver`),void this.callbacks.onAudioStateChanged?.(Qe.STREAMING_STATE.active,e);this.callbacks.onAudioStateChanged?.(Qe.STREAMING_STATE.started,e);const i=setInterval((async()=>{try{let n;this.logger.safe.debug(`[${e}] Polling audio receiver stats to detect early media start`);const r=await t.getStats();this.diagnostics?.registerEarlyMediaPoll();for(const e of r.values())if("inbound-rtp"===e.type){n=e;break}(this.terminated||!n||n.bytesReceived>0||"have-remote-pranswer"!==this.peerConnection.signalingState)&&(this.logger.safe.debug(`[${e}] Finished polling early media audio stats ${!this.terminated}`),this.terminated||this.callbacks.onAudioStateChanged?.(Qe.STREAMING_STATE.active,e),clearInterval(i))}catch(t){const n=Ve(t);this.logger.safe.error(`[${e}] Error polling stats for pranswer: ${n}`),this.diagnostics?.addStatsError("WebrtcSession::earlyMediaPolling",n),this.callbacks.onAudioStateChanged?.(Qe.STREAMING_STATE.active,e),clearInterval(i)}}),this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval)}startIceDisconnectedTimer(e){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${e}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise ${Qe.MEDIA_ERROR.iceConnectionError}`),this.raiseError({type:Qe.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},e)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(e,t=Te()){this.logger.safe.error(`[${t}] Media error occurred type: ${e.type} detail: ${e.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(e,t)}resetCandidateGathering(e){this.logger.safe.info(`[${e}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Yu,this.iceCandidateReceived=!1}checkIceCandidates(e){const t=this.hasIceCandidates(e);if(t===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:Qe.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(t){const t=this.hasRelayIceCandidates(e);if(t===this.noRelayIceCandidates){if(!t&&this.isIceConnected())return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledIceCandidates():e.hasIceCandidates()}hasRelayIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledRelayIceCandidates():e.hasRelayIceCandidates()}doRetargetIfNeeded(e,t,i){const n=t.isIceRestart();this.logger.safe.info(`[${i}] ICE restart: ${n}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription&&this.offeredDescription.isMSRTC()&&n&&!this.multiParty&&t.getSrtpInfo().sdes&&(e.newOffer=!0)}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}async streamAdded(e){if(Qe.MODALITY.audio===e.getModality()&&(this.webrtcAudioRecvStream=e.getMediaStream(),await this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),await this.updateAudioRendererStream(this.webrtcAudioRecvStream)),this.configProvider.config.mapSsrcToTrackForStats){const t=this.mediaManager.getMediaEntityByRemoteStreamId(e.getMediaStream().id);this.statsGatherer.setSsrcTrackPair(t.getRemoteSsrc(),t.getRemoteTrackId())}this.notifyStreamsChanged()}async updateAudioRendererStream(e){await this.audioRenderer.play(e),await this.deviceManager.effectsManager.setAecRefStream(e),this.rawIncomingAudioStreamManager.streamChanged(e)}streamRemoved(e){if(Qe.MODALITY.audio===e.getModality())this.audioRenderer.getStream()===e.getMediaStream()&&(this.audioRenderer.stop(),this.rawIncomingAudioStreamManager.streamChanged(null)),this.deviceManager.effectsManager.setAecRefStream(null),this.webrtcAudioRecvStream=null;else if(Qe.MODALITY.video===e.getModality()){const t=this.mediaManager.getMediaEntityByRemoteStreamId(e.getMediaStream().id);t?.getLocalRecvCapabilities()?.resetToInitial()}this.clearReceiveStreamTransforms(e.getReceiver()),e.dispose(),this.notifyStreamsChanged()}setNegotiatedModalities(e){this.logger.safe.info(`setNegotiatedModalities ${JSON.stringify(e)}`),this.negotiatedModalities=e,this.statsGatherer.sessionInfo.setNegotiatedModalities(e),this.diagnostics&&(this.diagnostics.negotiatedModalities=e)}setupIceGatheringTimeout(e){this.iceRelayCandidatesGatherStartTime=Date.now();const t=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!t)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const i=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,i.isPending&&(this.logger.safe.warn(`[${e}] ICE candidates gathering terminated due to timeout ${t}`),i.resolve())}),t)}isConnected(){return this.isTransportConnected()&&"closed"!==this.peerConnection.signalingState}isFailed(){return this.peerConnection&&("failed"===this.lastTransportConnectionState||"closed"===this.lastTransportConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}isIceConnected(){return"connected"===this.peerConnection?.iceConnectionState||"completed"===this.peerConnection?.iceConnectionState}isTransportConnected(){return this.peerConnection&&("connected"===this.lastTransportConnectionState||"completed"===this.lastTransportConnectionState)}createReceiveStream(e,t,i,n){const r=this.configProvider.config.addFmtpToInitialSubscription?n.getLocalRecvCapabilities():null,s=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&n.getModality()!==Qe.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null,a=new HN(e,t,n.getModality(),+n.getXSourceStreamId(),this,r,s);return new ex(a,i,this.receiveStreamCollection,this.logger.createChild("RecvStream"),this.configProvider.config)}async requestSource(e,t,i){if(!this.multiParty)return;const n=this.mediaManager.getMediaEntityByRemoteStreamId(e);if((this.isMuteHold||this.negotiatedModalities[n.getModality()]===Qe.MEDIA_STATE.inactive)&&t!==WD.SourceNone)return await km(10),this.requestSource(e,t);if(this.negotiationCompletedPromise.isPending)try{await this.negotiationCompletedPromise.promise}catch{this.logger.safe.error("source request should be sent even if negotiation rejected")}if(!this.isConnected()){this.logger.safe.info("requestSource is postponed till transport is connected");const e=Om();this.toBeCalledAfterConnected.push((()=>e.resolve())),await e.promise}return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(n.getXSourceStreamId(),t,n?.getMid(),i,n.getSubstreamIndex())}async assureStreamsAndDataChannel(e,t,i){this.logger.safe.info(`[${t}] assureStreamsAndDataChannel `,this.negotiatedModalities,"offered",this.offeredModalities," mod ",e),this.dataChannel&&this.dataChannel.updateDataModalityState(e.data),i?.mark("startConfigureHold");const n=await this.configureHold(this.negotiatedModalities,e,t);if(i?.markAndMeasure("startConfigureHold","configureHold"),n)return this.logger.safe.info(`[${t}] Hold is configured. Not updating streams`),e;const r=await this.streamSendersManager.update(e,!1,t,i?.clone("updateStreams"));return i?.markAndMeasure("configureHold","updateStreams"),this.dataChannel&&e.data&&(r.data=e.data),r}async configureHold(e,t,i){const n=Yp(e),r=Yp(t);return n!==r&&await this.streamSendersManager.setHold(r,i),r}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!0,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}applyReceiveCapabilities(){const e=this.mediaManager.getMediaEntities().map((e=>e.getRemoteRecvCapabilities()));this.multiParty?this.qualityManager.setPendingCapabilities():this.qualityManager.setMaxCapabilities(e)}async onReceiveCapabilitiesChanged(e,t,i){if(!this.streamSendersManager)return!1;try{return await this.streamSendersManager.applyCapabilities(t,e,i),!0}catch(e){return!1}}onOptimalVideoCountChanged(e,t){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(e),this.diagnostics.addOvcSubscriptionReport(e,this.subscriptionManager?.getSubscriptionsCount(),t)}async onSendBandwidthChanged(e){if(!this.isConnected())return;const t=this.extensionsManager.getExtension("videoStreamControl"),i=this.mediaManager.getMediaEntities().filter((e=>[Qe.MODALITY.video,Qe.MODALITY.sharing].indexOf(e.getModality())>-1)).filter((e=>e.isEnabled())).map((e=>e.getMid()));0!==i.length&&(await t.sendBandwidthInfo(i,e),this.statsGatherer.setReportedSendBandwidth(e),this.diagnostics&&(this.diagnostics.reportedSendBandwidth=e))}onMaxVideoSendCapabilitiesChanged(e,t){if("Video"===e&&this.configProvider.config.maxSendVideoCapabilitiesReportingForVideoEnabled||"ScreenShare"===e&&this.configProvider.config.maxSendVideoCapabilitiesReportingForSharingEnabled)return this.isConnected()?void this.notifyMaxVideoCapabilitiesChanged(e,t):(this.logger.safe.info("sendMaxVideoSendCapabilities is postponed till transport is connected"),void this.toBeCalledAfterConnected.push((()=>this.notifyMaxVideoCapabilitiesChanged(e,t))))}notifyMaxVideoCapabilitiesChanged(e,t){const i=this.extensionsManager.getExtension("videoStreamControl"),n=lm(e),r=this.mediaManager.getMediaEntitiesByModality(n)[0];if(!r)return;const s=r.getMid();i.sendMaxVideoSendCapabilities([s],t)}createAudioRenderer(){this.audioRenderer=new HA(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved),this.audioRenderer.on("onAudioPlaybackError",((e,t,i)=>this.onAudioPlaybackError(e,t,i)))}onAudioPlaybackError(e,t,i){const n={type:t,detail:i,isAudio:!0};this.deviceManager.raiseTelemetryEvent("reconnect_on_audio_playback_error",{error:e,mediaError:t,message:i}),this.context.reconnectRetry&&this.configProvider.config.audioRendererFailedRetryCodes?.includes(e)&&(this.logger.warn(`Reconnect required, attempt No: ${this.context.reconnectRetry}`),this.context.reconnectRetry--,this.raiseError(n))}getModalitiesForRollback(e){const t=nm(this.negotiatedModalities,this.negotiatingModalities);return this.logger.safe.debug(`[${e}] configured modalities for rollback: ${JSON.stringify(t)}`),t}fixLocalDescription(e){this.configProvider.config.insertFakeCandidateIfNeeded&&(this.iceCandidateReceived||!this.iceCandidateReceived&&this.isIceConnected())&&e.insertFakeCandidateIfNeeded(this.statsGatherer.sessionInfo,this.diagnostics),e.fixDataModality()}getSessionConfig(){return this.configProvider}getLocalMediaTrackId(e){const t=this.mediaManager.getLocalTracksInfo(),i=lm(e),n=t.find((e=>e.modality===i));return n?n.trackId:null}addReceiveStreamTransforms(e,t){const i=this.encStreamsManager.initTransformsCollection(e,"Receiver",cm(t));i&&t!==Qe.MODALITY.audio&&this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&i.addTransform(new YN(this.logger.createChild(`RecvStreamAnalyzer [${t}/${e.track.id}]`)))}clearReceiveStreamTransforms(e){this.encStreamsManager.clearTransformsCollection(e)}async checkVideoCodecsSupport(){try{const e=await this.capabilityGatherer.getCapabilities("video");this.statsGatherer.setH264AvailableProfiles(e);const t=await Bp.isCodecsSupported(this.configProvider.config.hevcCodecs);this.diagnostics&&(this.diagnostics.videoCapabilities=e,this.diagnostics.isCodecsSupported=t);const i=new Set(e?.codecs?.map((e=>e.mimeType.toLocaleLowerCase()))||[]);for(const e of this.configProvider.config.requiredVideoCodecs)if(!i.has(e)){this.ufdManager.signalEvent("NoRequiredVideoCodecs","Bad","Video");break}}catch(e){this.logger.safe.error(`failed to get video capability ${Ve(e)}`)}}getMediaDescriptions(e){if(Yp(e))return{};const t=[];for(const i of this.mediaManager.getMediaEntities()){if(!i.getExtension("reinviteless"))continue;const n=e[i.getModality()],r={mid:i.getMid(),direction:!i.getLocalTrackId()&&zp(n)?Wp(n):n};t.push(r)}return{descriptions:t}}updateSendStreamsReinviteless(e){if(st(this.negotiatedModalities)||Yp(this.negotiatedModalities)||Yp(this.configuredModalities))return!1;this.reinvitelessRequestedModalities=ot(this.negotiatedModalities);for(const[e,t]of Object.entries(this.configuredModalities)){const i=this.mediaManager.getMediaEntitiesByModality(e)[0];i?.getExtension("reinviteless")&&(this.reinvitelessRequestedModalities[e]=t)}return!ht(this.reinvitelessRequestedModalities,this.negotiatedModalities)&&(this.callbacks?.onUpdateMediaDescriptionsRequired?.(e),ht(this.reinvitelessRequestedModalities,this.configuredModalities))}setBWSeed(e){if(!this.configProvider.config.setBWSeed)return;const t=this.extensionsManager.getExtension("bandwidthCache").getBWSeed();e.applyChannelParameters={multiChannelParameter:{mids:this.configProvider.config.bwSeedOptions.mids,mediaParameter:JSON.stringify({sendSideBWSeed:{seedValueBitsPerSec:t}})}},this.diagnostics.sentBWSeed=t}getSubscriptionManager(){return this.subscriptionManager}initAudioCodec(e){this.audioCodecManager.init(e);const t=this.audioCodecManager.decoder;t&&(t.on("usedDecoderChanged",(e=>{this.updateAudioRendererStream(e?t.stream:this.webrtcAudioRecvStream),this.statsGatherer.setAudioDecoderStatsProvider(e?t.getStatsProvider():void 0)})),this.audioCodecManager.on("negotiationNeeded",(e=>this.triggerRenegotiation(!0,e))))}configureAudioCodec(){this.audioCodecManager.prepareForNegotiation(this.initiator)}checkAudioCodecNegotiated(e){const t=this.audioCodecManager.negotiationCompleted();if(this.configProvider.mediaConfig.spatialAudioEnabled){const i=t?"Good":"Bad";this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable",i,"Audio",!0,e)}}onIncomingVideoQualityChanged(e,t){1===e&&this.remoteVideoResolutionManager.limitResolutionOnPoorPerformance(t)}getVideoDeviceManager(){return this.context.callDeviceManager.getDeviceManager("Video")}setupCallDeviceManagerSubs(){this.callDeviceManagerSub=this.context.callDeviceManager.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, disposing deviceManager subscriptions"),this.deviceManagerSubs.forEach((e=>e.dispose())),this.logger.info("New subscriptions for deviceManager created"),this.setSubsForDeviceManager()}))}updateLocalMediaSources(){this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statsGatherer.updateStatsWithLocalSsrcTrackInfo();const e=this.streamSendersManager.getLocalMediaSources();this.qualityManager.updateRegisteredSources(e)}},jx={build:(e,t,i)=>new Gx(e,t,i)},qx=class{constructor(e,t,i,n,r,s,a,o){this.logger=e,this.context=t,this.configProvider=i,this.diagnostics=n,this.ufdManager=r,this.deviceManager=s,this.capabilities=a,this.midCallTelemetry=o,this.activeSessions=[],this.pendingDeviceTelemetryEvents=[],this.pendingVideoEffectsTelemetryEvents=[],this.pendingAudioEffectsTelemetryEvents=[],this.callsCount=0,this.mediaConfig={},this.configProvider.on("configUpdated",(()=>this.configApplied())),this.deviceManager.on("onDeviceTelemetryEvent",(e=>this.onDeviceTelemetryEvent(e))),this.deviceManager.on("onVideoEffectsTelemetryEvent",(e=>this.onVideoEffectsTelemetryEvent(e))),this.deviceManager.on("onAudioEffectsTelemetryEvent",(e=>this.onAudioEffectsTelemetryEvent(e)))}createSession(e,t,i,n){this.configProvider.setMediaConfiguration(this.mediaConfig);const r=this.configProvider.getConfigView(i?.isConference),s=this.logger,a=this.diagnostics.newSession(r,t,this.logger.createChild("sessionDiagnostics")),o={getLogger:()=>s,getUfdManager:()=>this.ufdManager,maContext:this.context,config:i??{},configProvider:r,diagnostics:a.newNativeSessionDiag(),reconnectRetry:r.config.audioRendererFailedReconnectTimes,callDeviceManager:n},c=(r.mediaConfig.simulcastSessionEnabled?jx:JN).build(o,t,e),l=new $D(r,++this.callsCount,a);l.setMediaQosEnabled(!!this.mediaConfig.enableMediaQoS),l.setPortRangeConfigured(!!this.mediaConfig.mediaPortRanges);const d=new xD(c,t,o,e,l,this.configProvider,a);for(d.on("onTerminated",(e=>this.onSessionTerminated(e))),this.activeSessions.push(d),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector=_D.getInstance(this.logger.createChild("WebRtcInternals"),r),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length);this.pendingDeviceTelemetryEvents.length>0;)d.registerDeviceTelemetryEvent(this.pendingDeviceTelemetryEvents.pop());for(;this.pendingVideoEffectsTelemetryEvents.length>0;)d.registerVideoEffectsTelemetryEvent(this.pendingVideoEffectsTelemetryEvents.pop());for(;this.pendingAudioEffectsTelemetryEvents.length>0;)d.registerAudioEffectsTelemetryEvent(this.pendingAudioEffectsTelemetryEvents.pop());return d}getDeviceManager(){return this.deviceManager}getCapabilities(){return this.capabilities}getScreenSharingManager(){return new ID(this.deviceManager)}updateConfig(e,t,i,n){this.configProvider.updateConfig(e,t,i,n)}getConfig(){return this.configProvider.config}getConfigProvider(){return this.configProvider}setMediaConfig(e){(0,vD.merge)(this.mediaConfig,e),this.diagnostics.mediaConfig=this.mediaConfig}getMediaLogs(){return this.webRtcInternalsCollector?this.webRtcInternalsCollector.collect():Promise.resolve("")}dispose(e){return Promise.all([this.deviceManager.dispose(),this.capabilities.dispose(),...this.activeSessions.map((async t=>{await t.terminate(e,{}).catch((()=>{})),t.dispose()}))]).then((()=>{}),(()=>{}))}handleSendMidCallTelemetry(e){this.midCallTelemetry?.on("sendMidCallTelemetry",e)}configApplied(){window&&(this.configProvider.config.enableDevtoolsAPI?window.webMA||this.injectDevtoolsAPI():window.webMA&&delete window.webMA)}injectDevtoolsAPI(){const e={config:{addOverride:(e,t)=>this.configProvider.setConsoleOverride(e,t),setOverrides:e=>this.configProvider.setConsoleOverrides(e),clearOverride:e=>this.configProvider.clearConsoleOverride(e),clearAllOverrides:()=>this.configProvider.clearAllConsoleOverrides(),setConstraints:e=>this.configProvider.setCallConstraints(e),setRelayConfigOverride:e=>this.context.getRelayManager().setRelayOverride(e)},diagnosticsReport:this.diagnostics.reportGenerator,deviceManager:{setAudioProcessingFlags:e=>this.deviceManager.setAudioProcessingFlags(e)}};window.webMA=e}onDeviceTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerDeviceTelemetryEvent(e))):this.pendingDeviceTelemetryEvents.push(e)}onVideoEffectsTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerVideoEffectsTelemetryEvent(e))):this.pendingVideoEffectsTelemetryEvents.push(e)}onAudioEffectsTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerAudioEffectsTelemetryEvent(e))):this.pendingAudioEffectsTelemetryEvents.push(e)}onSessionTerminated(e){nt(this.activeSessions,(t=>t===e)),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length),0===this.activeSessions.length&&this.ufdManager.reset()}},Wx=class{static build(e,t,i,n,r,s,a,o){return new qx(e,t,i,n,r,s,a,o)}};Wx.constants=Qe,Wx.helper=Dp;var zx=class{constructor(e,t){this.getWorker=e,this.logger=t,this.createWasmCVWorker=()=>(this.logger.info("Creating wasmcv worker"),this.create({msg:"wasmcv"})),this.createEncodedStreamsWorker=()=>(this.logger.info("Creating encoded-stream worker"),this.create({msg:"encoded-stream"}))}get audioWorklet(){return null}create(e){const t=this.getWorker();return t.onerror=t=>{this.logger.error(`Worker ${JSON.stringify(e)} error: ${t.message}`)},t.onmessage=t=>{this.logger.info(`Worker ${JSON.stringify(e)} event: ${JSON.stringify(t.data)}`)},t.postMessage(e),t}},Jx=class{constructor(e,t,i){e.logger??(e.logger=new of),e.domOverrides??(e.domOverrides={}),this.config=e;const n=e.mediaSettings;xp(e.clientInformation),this.logger=new SD(e.safeLogger?.createChild("MA",n.debug),e.logger.createChild("MA",n.debug)),this.configProvider=new FA(this.logger.createChild("configProvider"),i,n);const r=new Cw(this.configProvider);this.mediaAgentDiagnostics=new fD(this.configProvider,r),this.ufdManager=new df(this.logger.createChild("UFD"),this.configProvider),this.configProvider.config.useGenericWorkerLoader&&e.createWasmWorkerCbs.createGenericWebRTCWorker&&(this.wasmLoader=new zx(e.createWasmWorkerCbs.createGenericWebRTCWorker,this.logger.createChild("WasmLoader"))),this.deviceManager=new yw(this.logger.createChild("DeviceManager"),this.configProvider,r,e.domOverrides,this.ufdManager,e.webcvProvider,e.wasmdnsProvider,e.wasmaecProvider,e.wasmVqeProvider,this.wasmLoader||e.createWasmWorkerCbs),this.capabilities=new cf(this.configProvider),ZA.initialize(this.configProvider),t.on("OnECSChanged",(()=>{const e=t.getEcsConfig("SkypeWebMedia","mediaAgent");e?this.configProvider.updateConfig(e,t.ETag,t.getEcsConfig("ConfigIDs","SkypeWebMedia"),t.getEcsConfig("Headers","CountryCode")):this.logger.warn("No SkypeWebMedia.mediaAgent config.")}))}getDeviceManager(){return this.deviceManager}async buildAgent(e,t,i){if(!Bp.hasMediaApi())throw[new Kx(`${e} not supported by media agent provider`,"not_supported")];if(this.config?.detectH264Support&&!await Bp.hasH264CodecSupport(this.config.logger))throw[new Kx("H264 is not supported","not_supported")];const n=await async function(e,t){if(e?.createEncodedStreamsWorker)return{getWorker:()=>e.createEncodedStreamsWorker()};if(t){const e=await t.getWorkerUrl();return{getWorker:()=>new Worker(e)}}return null}(this.config.createWasmWorkerCbs,this.config.encodedStreamsWorkerProvider),r=t.createRelayManager(this.configProvider),s={getRelayManager:()=>r,getWebCVProvider:()=>this.config.webcvProvider,getWasmDnsProvider:()=>this.config.wasmdnsProvider,getWasmAecProvider:()=>this.config.wasmaecProvider,getWasmVqeProvider:()=>this.config.wasmVqeProvider,getEncodedStreamsWorkerProvider:()=>n,domOverrides:this.config.domOverrides,configProvider:this.configProvider};s.getRelayManager().initialize();const a=Wx.build(this.logger,s,this.configProvider,this.mediaAgentDiagnostics,this.ufdManager,this.deviceManager,this.capabilities,i);return a.constants=Wx.constants,a}},Kx=class extends Error{constructor(e,t="failure"){super(e),this.reason=t}};var Yx=class{constructor(){this.supportedPlatforms=new Map([["Chrome","59.0"],["EdgeAnaheim","79.0"],["Safari","13.1"],["Electron","3.0"],["Firefox","96.0"],["WebView2","1.0"]]),this.experimentalPlatforms=new Map}getPlatformSupportLevel(e){const t=ri(),i=this.supportedPlatforms.get(t.name);if(e&&i&&Cm(t.version,i))return 1;if(e&&!i){if("Chromium"===t.engine||"ChromiumAVD"===t.engine)return 2;const e=this.experimentalPlatforms.get(t.name);if(e&&Cm(t.version,e))return 2}return 0}},Qx=class extends We{constructor(e){super(),this.ecsFilters=e,this.config=null}get ETag(){return this.etag}async setEcsConfig(e){this.config=JSON.parse(e.ecsBlob),this.etag=e.etag,this.event("OnECSChanged").raise()}async setUserEcsServerUrl(e,t){throw new Error("Not implemented")}async getUserEcsServerUrl(e){throw new Error("Not implemented")}async setActiveUserForEcs(e){throw new Error("Not implemented")}async getEcsQueryParameters(){const e={CLRelease:"2024.14.01.41"},t="_TS_BUILC_VERSION_".replace("C","D"),i=this.ecsFilters?.["UserInfo.Ring"]?.value,n=this.getTeamsExperience();e.CLRelease===t&&(e.CLRelease="9999.99"),i&&(e.audienceGroup=i,e.teamsRing=i),n&&(e.Experience=n);const r=ri();return e.BrowserName=r.name,e.BrowserEngine=r.engine,e.BrowserVersion=r.version,e.FormFactor=r.formFactor,Bp.hardwareConcurrency&&(e.CPUCount=Bp.hardwareConcurrency),JSON.stringify(e)}async ecsGetUserQueryParameters(e){return this.getEcsQueryParameters()}async shouldTriggerCQF(e,t,i){throw new Error("Not implemented")}getEcsConfig(e,t){const i=this.config&&this.config[e];return t?i&&i[t]:i}createEcsConfiguration(){return new class{constructor(e){this.provider=e}getBoolean(e,t){return this.provider.getEcsConfig(e,t)}getNumber(e,t){return this.provider.getEcsConfig(e,t)}getString(e,t){const i=this.provider.getEcsConfig(e,t);return JSON.stringify(i)}}(this)}getTeamsExperience(){return!0===this.ecsFilters?.isTeams2?.value?"teams2":!1===this.ecsFilters?.isTeams2?.value?"teams1":void 0}},Xx=class{constructor(e){this._sharingSource=e}getId(){return this._sharingSource.getId()}getDeviceId(){return this._sharingSource.getDeviceId()}getType(){return this.mapSharingSourceType(this._sharingSource.getType())}getPreview(e,t,i){return Promise.reject("not implemented")}getPreviewAsync(e,t){return this._sharingSource.getPreviewAsync(e,t)}getDescription(){return this._sharingSource.getDescription()}getIcon(e,t){return this._sharingSource.getIcon(e,t)}getBounds(){}mapSharingSourceType(e){switch(e){case 1:return 1;case 2:return 2;case 3:return 3;default:throw new Error("Invalid sharing source type")}}},Zx=class extends We{constructor(e){super(),this._screenSharingManager=e,this._screenSharingManager.onScreensChanged((()=>{this.event("screensChanged").raise()}))}enumerateScreensAsync(){return this._screenSharingManager.enumerateScreensAsync().then((e=>e.map((e=>new Xx(e)))))}enumerateWindowsAsync(){return this._screenSharingManager.enumerateWindowsAsync().then((e=>e.map((e=>new Xx(e)))))}enumerateCamerasAsync(){return this._screenSharingManager.enumerateCamerasAsync().then((e=>e.map((e=>new Xx(e)))))}},eU=g;function tU(e,t){return null==e?t:e}function iU(e,t){return e||t}var nU,rU,sU=class{constructor(e,t,i,n){this.signalingAgentConfig=e,this.ecsProvider=t,this.logger=i,this.telemetryLogger=n,this.ecsProvider.on("OnECSChanged",(()=>this.onEcsUpdate())),this.signalingAgentConfig.clientInformation+="/TsCallingVersion=2024.14.01.41/Ovb=a7c1622acc37a0ab89ed93e9fad06dfff1477239",this.signalingAgentConfig.piiScrubber={omit:eU.pii.Omit,mri:eU.pii.Mri},this.signalingAgent=new ou(this.getSignalingAgentConfig())}getSignalingAgent(){return this.signalingAgent}onEcsUpdate(){const e=this.ecsProvider.getEcsConfig("SkypeCalling");this.logger.info(`onEcsUpdate, ecsTag=${this.ecsProvider.ETag||""}, ecsConfig=${JSON.stringify(e)}`),this.signalingAgentConfig=((e,t)=>{if(!t)return e;const i={...e};if(t.ngIncoming&&t.ngOutgoing){const n=function(e,t){return t&&e?"enabled":e?"recvOnly":!1===e&&!1===t?"disabled":void 0}(t.ngIncoming.isVBSSEnabled,t.ngOutgoing.isVBSSEnabled);i.cloudScreenSharingFlag=tU(n,e.cloudScreenSharingFlag)}return t.ngOutgoing&&(i.emergencyCallCountry=function(e,t){return!1===e?"":t}(t.ngOutgoing.isEmergencyCallingEnabled,e.emergencyCallCountry),i.isGVCOutgoingEnabled=tU(t.ngOutgoing.isGVCEnabled,e.isGVCOutgoingEnabled),i.brokerEnabledOutgoing=tU(t.ngOutgoing.isBrokerEnabled,e.brokerEnabledOutgoing)),t.ngIncoming&&(i.isGVCJoiningEnabled=tU(t.ngIncoming.isGVCEnabled,e.isGVCJoiningEnabled),i.brokerEnabledIncoming=tU(t.ngIncoming.isBrokerEnabled,e.brokerEnabledIncoming)),i.conversationServiceUrl=iU(t.conversationServiceUrl,e.conversationServiceUrl),i.uploadLogRequestUrl=iU(t.uploadLogRequestUrl,e.uploadLogRequestUrl),i.isConversationServiceUrlFromEcs=!!t.conversationServiceUrl,i.isUploadLogRequestUrlFromEcs=!!t.uploadLogRequestUrl,i.callingTokenLogicalUrl=iU(t.callingTokenLogicalUrl,e.callingTokenLogicalUrl),i.doHostlessCalling=tU(t.allowHostlessCalls,e.doHostlessCalling),i.supportsCompressedServicePayload=tU(t.supportCompressedTrouterPayload,e.supportsCompressedServicePayload),i.brokerRequestBatching=tU(t.allowBrokerSubscribeBatching,e.brokerRequestBatching),i.brokerExclusively=tU(t.brokerExclusively,e.brokerExclusively),i.handleMediaOfferFromPushNotification=tU(t.handleMediaOfferFromPushNotification,e.handleMediaOfferFromPushNotification),i.handleNewOfferRequest=tU(t.handleNewOfferRequest,e.handleNewOfferRequest),i.sendProgressFromCC=tU(t.sendProgressFromCC,e.sendProgressFromCC),i.useInternalHttpDispatcher=tU(t.webInternalHttpDispatcher,e.useInternalHttpDispatcher),(t.webInternalHttpDispatcherConfigNetworkRequest||e.requestTypeHttpDispatcherConfigMap)&&(t.webInternalHttpDispatcherConfigNetworkRequest=t.webInternalHttpDispatcherConfigNetworkRequest||{},e.requestTypeHttpDispatcherConfigMap=e.requestTypeHttpDispatcherConfigMap||{},i.requestTypeHttpDispatcherConfigMap={...e.requestTypeHttpDispatcherConfigMap,...t.webInternalHttpDispatcherConfigNetworkRequest}),(t.operationTypeHttpDispatcherConfigMap||e.operationTypeHttpDispatcherConfigMap)&&(t.operationTypeHttpDispatcherConfigMap=t.operationTypeHttpDispatcherConfigMap||{},e.operationTypeHttpDispatcherConfigMap=e.operationTypeHttpDispatcherConfigMap||{},i.operationTypeHttpDispatcherConfigMap={...e.operationTypeHttpDispatcherConfigMap,...t.operationTypeHttpDispatcherConfigMap}),(t.csaTimeoutConfiguration||e.csaTimeoutConfiguration)&&(t.csaTimeoutConfiguration=t.csaTimeoutConfiguration||{},e.csaTimeoutConfiguration=e.csaTimeoutConfiguration||{},i.csaTimeoutConfiguration={...e.csaTimeoutConfiguration,...t.csaTimeoutConfiguration}),i.autoJoinOnConflict=tU(t.autoJoinOnConflict,e.autoJoinOnConflict),i.enableQuickSendAcceptanceAck=tU(t.enableQuickSendAcceptanceAck,e.enableQuickSendAcceptanceAck),i.supportMediaRetargetWhileIncomingRenegotiation=tU(t.supportMediaRetargetWhileIncomingRenegotiation,e.supportMediaRetargetWhileIncomingRenegotiation),i.enableCallEstablishmentTimeoutsForStartJoinCall=tU(t.enableCallEstablishmentTimeoutsForStartJoinCall,e.enableCallEstablishmentTimeoutsForStartJoinCall),i.callingServiceSupportsCAETokens=tU(t.callingServiceSupportsCAETokens,e.callingServiceSupportsCAETokens),i.callingServiceSupportsAADTokens=tU(t.callingServiceSupportsAADTokens,e.callingServiceSupportsAADTokens),i.aadTokenExpirationTimeInSeconds=tU(t.aadTokenExpirationTimeInSeconds,e.aadTokenExpirationTimeInSeconds),i.caeTokenExpirationTimeInSeconds=tU(t.caeTokenExpirationTimeInSeconds,e.caeTokenExpirationTimeInSeconds),i.disableTokenMigrationHeader=tU(t.disableTokenMigrationHeader,e.disableTokenMigrationHeader),i.enablePublishTokenTelemetry=tU(t.enablePublishTokenTelemetry,e.enablePublishTokenTelemetry),i.refreshTimeBeforeTokenTimeoutInSeconds=tU(t.refreshTimeBeforeTokenTimeoutInSeconds,e.refreshTimeBeforeTokenTimeoutInSeconds),i.forceClearExpiredTokens=tU(t.forceClearExpiredTokens,e.forceClearExpiredTokens),i.enableRefreshToken=tU(t.enableRefreshToken,e.enableRefreshToken),i.enableAsyncDisablePreheat=tU(t.enableAsyncDisablePreheat,e.enableAsyncDisablePreheat),i.forceLowercaseHttpHeaders=tU(t.forceLowercaseHttpHeaders,e.forceLowercaseHttpHeaders),i.enableResolveScreenSharingWhenNegotiationComplete=tU(t.enableResolveScreenSharingWhenNegotiationComplete,e.enableResolveScreenSharingWhenNegotiationComplete),i.maxReinvitelessMediaForVideoForWeb=tU(t.maxReinvitelessMediaForVideoForWeb,e.maxReinvitelessMediaForVideoForWeb),i.maxReinvitelessMediaForVBSSForWeb=tU(t.maxReinvitelessMediaForVBSSForWeb,e.maxReinvitelessMediaForVBSSForWeb),i.enableRefreshTokenRetry=tU(t.enableRefreshTokenRetry,e.enableRefreshTokenRetry),i.enableRefreshTokenRetryInSeconds=tU(t.enableRefreshTokenRetryInSeconds,e.enableRefreshTokenRetryInSeconds),i.enableConversationTypeUpdateOnCallEnd=tU(t.enableConversationTypeUpdateOnCallEnd,e.enableConversationTypeUpdateOnCallEnd),i.supportMissingTokenTypesInResponse=tU(t.supportMissingTokenTypesInResponse,e.supportMissingTokenTypesInResponse),i.useSkypeTokenWhenNoAuthenticateHeader=tU(t.useSkypeTokenWhenNoAuthenticateHeader,e.useSkypeTokenWhenNoAuthenticateHeader),i.enableAutoPromotion=tU(t.enableAutoPromotion,e.enableAutoPromotion),i.enableTokenCache=tU(t.enableTokenCache,e.enableTokenCache),i.enableBatchedSendMessageStatus=tU(t.enableBatchedSendMessageStatus,e.enableBatchedSendMessageStatus),i.enableBatchedReceiveMessage=tU(t.enableBatchedReceiveMessage,e.enableBatchedReceiveMessage),i.enableTokenCacheForGenericTokenAPI=tU(t.enableTokenCacheForGenericTokenAPI,e.enableTokenCacheForGenericTokenAPI),i.disableRealTimeModeFromRoster=tU(t.disableRealTimeModeFromRoster,e.disableRealTimeModeFromRoster),i.enableLongOutgoing1To1SetupTimeoutForWeb=tU(t.enableLongOutgoing1To1SetupTimeoutForWeb,e.enableLongOutgoing1To1SetupTimeoutForWeb),i})(this.signalingAgentConfig,e),this.signalingAgentConfig.ecsEtag=this.ecsProvider.ETag,this.signalingAgent.updateSignalingAgentConfig(this.getSignalingAgentConfig())}getSignalingAgentConfig(){return this.signalingAgentConfig.oneDsTelemetryLogger=this.telemetryLogger,this.signalingAgentConfig}},aU=(e,t,i,n)=>new sU(e,t,i,n);function oU(e){return Iy(e)&&e>=1&&e<=2}(rU=nU||(nU={}))[rU.LocalStorage=1]="LocalStorage",rU[rU.SessionStorage=2]="SessionStorage",rU[rU.IndexedDb=3]="IndexedDb";var cU="result",lU="DBError: Unable to open database",dU="Database is not open",hU="DBError: Failed to delete the database",uU=["indexedDB"],gU=fy,pU=Ty;function mU(e,t){mC("QUnit")&&console&&console.log("IndexedDbHelper ["+e+"] "+t)}function fU(e,t,i){e&&e.warnToConsole("IndexedDbHelper ["+t+"] "+i)}function SU(e,t,i,n){return function(r){i(new Error(t)),mU(e,"["+n+"] event rejected")}}var vU=[];function yU(e,t){for(var i=null,n=0;n<vU.length;n++)if((i=vU[n]).name===e)return i;return i={name:e,sch:new qT("IndexedDbHelper["+e+"]",t),dbHdl:[],add:function(t){i.dbHdl.push(t),mU(e,"- dbOpened (add) -- hdls ["+i.dbHdl.length+"]")},remove:function(t){for(var n=i.dbHdl,r=0;r<n.length;r++)if(n[r]===t){n.splice(r,1);break}mU(e,"- dbClosed (remove) -- hdls ["+i.dbHdl.length+"]")},isOpen:function(){return i.dbHdl.length>0},openHdl:function(){return i.dbHdl.length>0?i.dbHdl[0]:null}},vU.push(i),i}var CU=function(){function e(t){bS(e,this,(function(e){var i=function(){var e=Vf()||{},t=null;if(e)try{for(var i=0;i<uU.length;i++)if((t=e[uU[i]])&&gU(t.open))return t}catch(e){t=null}return t||null}()||null;function n(e,i){var n=e.db.transaction(i,"readwrite");return n.onabort=function(){fU(t,e.dbName,"txn.onabort")},n.onerror=function(){fU(t,e.dbName,"txn.onerror")},n.oncomplete=function(){mU(e.dbName,"txn.oncomplete")},{db:e,store:n.objectStore(i),tx:n,tbl:i,openCursor:function(t,n){return s(e,i,t,n)},newTransaction:function(t){return r(e,i,t)}}}function r(e,t,i){if(!e||!e.db)return FT.reject(new Error(dU));try{var r=i(n(e,t));return r instanceof FT?r:FT.resolve(r)}catch(e){return FT.reject(e)}}function s(e,t,i,r){if(!e||!e.db)return FT.reject(new Error(dU));var s=null;return i&&pU(i)?s=new _U(i):i&&i.isMatch&&(s=i),new FT((function(i,a){var o=[],c=null,l=null;s&&s.keyRange&&(l=s.keyRange());var d=n(e,t);(c=l?d.store.openCursor(l):d.store.openCursor()).onerror=SU(d.db.dbName,"DBError: Failed to Open Cursor",a,"openCursor"),c.onsuccess=function(e){var t=e.target[cU];if(t){var n={store:d,cursor:t,continue:function(){t.continue()},done:function(){i(o)}},c=t.value;if(!s||s.isMatch(c))if(r)try{switch(r(n,c,o)){case 2:i(o);break;case 1:break;default:n.continue()}}catch(e){a(e)}else o.push(c),n.continue();else n.continue()}else i(o)}}))}function a(e,t,i,n){return yU(e).sch.scheduleEvent(i,t,n)}e.isAvailable=function(){return!!i},e.openDb=function(e,n,o,c){return a(e,"openDb",(function(a){return new FT((function(l,d){var h=!1;function u(t,i,a,o,c){var l={db:i,dbName:e,dbVersion:n,ctx:null,isNew:o,txn:a?a.transaction:null};return c||(l.openStore=function(e,t){return r(l,e,t)},l.openCursor=function(e,t,i){return s(l,e,t,i)}),l}function g(i,n){var r=yU(e);r.add(i),i.onabort=function(n){fU(t,e,"onabort -- closing the Db"),r.remove(i)},i.onerror=function(n){fU(t,e,"onerror -- closing the Db"),r.remove(i)},i.onclose=function(n){fU(t,e,"onclose -- closing the Db"),r.remove(i)},i.onversionchange=function(n){fU(t,e,"onversionchange -- force closing the Db"),i.close(),r.remove(i)};var s,a=null;r.dbHdl.length>0&&(a=r.dbHdl[0]),s=u(0,a,n,h);try{o(s).then((function(e){l(e)}),d)}catch(e){d(e)}}var p=yU(e);if(null==i)d(new Error("No available storage factory"));else if(p.isOpen()){var m=u(0,p.openHdl(),null,!1);o(m).then(l,d)}else{var f=i.open(e,n);f.onblocked=function(i){fU(t,e,"Db Open Blocked event ["+a+"] - "+(f.error||"")),d(new Error(lU))},f.onerror=function(i){fU(t,e,"Db Open Error event ["+a+"] - "+(f.error||"")),d(new Error(lU))},f.onupgradeneeded=function(t){mU(e,"Db Open Create/Upgrade needed event ["+a+"]");try{var i=t.target[cU];if(!i)return void d(new Error(lU));!function(e,t){var i=u(0,e,t,!0,!0);if(c)h=!0,c(i).then((function(){i.txn||(i.txn=t.transaction)}),(function(e){try{t.transaction&&t.transaction.abort()}finally{d(e)}}));else try{t.transaction&&t.transaction.abort()}finally{d(new Error("DBError: Database upgrade required"))}}(i,f)}catch(t){SU(e,lU,d,a)(t)}},f.onsuccess=function(e){var t=e.target[cU];t?g(t,f):d(new Error(lU))}}}))}))},e.closeDb=function(e){a(e,"closeDb",(function(t){var i=yU(e),n=i.dbHdl,r=n.length;if(r>0){for(var s=0;s<r;s++)n[s].close();i.dbHdl=[]}return FT.resolve(1)}))},e.deleteDb=function(e){return null==i?FT.resolve(!1):a(e,"deleteDb",(function(n){var r=yU(e),s=r.dbHdl,a=s.length;if(a>0){fU(t,e,"Db is open ["+a+"] force closing");for(var o=0;o<a;o++)s[o].close();r.dbHdl=[]}return new FT((function(r,s){setTimeout((function(){try{mU(e,"["+n+"] starting");var a=i.deleteDatabase(e);a.onerror=function(i){fU(t,e,"["+n+"] error!!"),s(new Error(hU))},a.onblocked=function(i){fU(t,e,"["+n+"] blocked!!"),s(new Error(hU))},a.onupgradeneeded=function(i){fU(t,e,"["+n+"] upgrade needed!!"),s(new Error(hU))},a.onsuccess=function(t){mU(e,"["+n+"] complete"),r(!0)},mU(e,"["+n+"] started")}catch(i){fU(t,e,"["+n+"] threw - "+i),s(new Error(hU+" - "+i))}}),0)}))}))},e.getDbDetails=function(e){return a(e,"getDbDetails",(function(t){return null!=i&&i.databases?new FT((function(t,n){i.databases().then((function(i){for(var r=0;r<i.length;r++)if(i[r].name===e)return void t(i[r]);n(new Error("DBError: Database does not exist"))}),n)})):FT.reject(new Error("DBError: Feature not supported"))}),2e3)}}))}return e.__ieDyn=1,e}(),_U=function(){function e(t){var i=[],n=null;bS(e,this,(function(e){e.keyRange=function(){return n},e.parseQuery=function(t){if(i=[],t)for(var r=t.split(";"),s=0;s<r.length;s++){var a=r[s],o=a.indexOf("=");if(-1!==o){var c=a.substring(0,o),l=a.substring(o+1);0===c.indexOf("#")&&(c=c.substring(1),n||(n=IDBKeyRange.bound(l,l+""))),e.startsWith(c,l)}}},e.startsWith=function(e,t){i.push({name:e,value:t,type:0})},e.contains=function(e,t){i.push({name:e,value:t,type:1})},e.isMatch=function(e){if(!i||0===i.length)return!0;if(!e)return!1;for(var t=0;t<i.length;t++){var n=i[t],r=e[n.name];if(r)if(0===n.type){if(0!==r.indexOf(n.value))return!1}else if(1===n.type&&-1===r.indexOf(n.value))return!1}return!0},t&&e.parseQuery(t)}))}return e.__ieDyn=1,e}(),EU=6e5,TU=1008e4,IU="DBError: Unable to add event",bU="Evts",AU="iKey",RU=oU;function wU(){return(new Date).getTime()}function PU(e){return e.openStore(AU,(function(t){return new FT((function(i,n){var r={iKey:e.ctx.iKey,tm:wU()},s=t.store.put(r);s.onsuccess=function(e){i(s.result.toString())},s.onerror=function(e){n(new Error(IU))},s.onerror=function(e,t){return function(i){return t(new Error(e))}}("DBError: Unable to update iKey",n)}))}))}function MU(e){for(var t=[],i=2;i>=1;i--)for(var n=0;n<e.length;n++){var r=e[n];r&&r.evt.persistence===i&&t.push(r.evt)}return t}function DU(e){return function(t){return e.continue()}}function OU(e){var t=e.cursor.delete();return t.onerror=DU(e),t.onsuccess=DU(e),1}function kU(e,t,i){return e.openCursor(bU,t,(function(e,t,n){return i(t)?(n.push(t),OU(e)):0}))}function NU(e){return e.openCursor(bU,"#key="+e.ctx.iKeyPrefix(),(function(t,i){var n=i.key;if(0===n.indexOf(e.ctx.iKeyPrefix())&&-1===n.indexOf(e.ctx.evtKeyPrefix())&&function(e,t){var i=e.tm;return wU()-i>t}(i,EU)){i.key=e.ctx.evtKeyPrefix()+i.id;var r=t.store.store.put(i);return r.onerror=DU(t),r.onsuccess=function(e){try{OU(t)}catch(e){t.continue()}},1}return 0}))}function LU(e){return new FT((function(t,i){(function(e){return new FT((function(t,i){var n=!1;e.openCursor(AU,null,(function(e,t,i){var r=t.tm;return wU()-r<TU?0:(n=!0,2)})).then((function(){if(n){var r={};kU(e,null,(function(e){if(!e||!e.evt||!e.evt.iKey)return!0;var t=e.tm;return wU()-t>TU||(r[e.evt.iKey]=1,!1)})).then((function(){var n=[];e.openCursor(AU,null,(function(e,t,i){var s=t.tm;return wU()-s<TU||r[t.iKey]?0:(n.push(t),OU(e))})).then((function(){t(n)}),i)}),i)}else t([])}),i)}))})(e).then((function(){NU(e).then(t,t)}),i)}))}var xU=function(){function e(t){bS(e,this,(function(e){var i=null,n=null,r="Unknown",s=null,a=null,o=null,c=-1,l=0;function d(e){return i.openDb(n,1,(function(t){return new FT((function(i,n){var c={iKey:r,storageId:s,iKeyPrefix:function(){return a},evtKeyPrefix:function(){return o}};t.ctx=c,PU(t).then((function(){e(t).then(i,n)}),n)}))}),(function(e){return new FT((function(t,i){(function(e){e.objectStoreNames.contains(bU)||e.createObjectStore(bU,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1}),e.objectStoreNames.contains(AU)||e.createObjectStore(AU,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})})(e.db),t()}))}))}function h(e,t,i){return new FT((function(n,r){function s(t,i){(function(e,t){return new FT((function(i,n){var r=0,s=e.ctx.evtKeyPrefix();function a(){i(r)}function o(e,t){return new FT((function(i){var n=e.store.delete(t.key);n.onsuccess=function(e){r++,i()},n.onerror=function(e){i()}}))}e.openCursor(bU,"#key="+s,(function(e,i,n){return i.evt.persistence<=t&&0===i.key.indexOf(s)&&(function(e,t){for(var i=0;i<e.length;i++)if(t.tm<e[i].tm)return void e.splice(i,0,t);e.push(t)}(n,i),n.length>10&&n.splice(n.length-1,1)),0})).then((function(t){0!==t.length?e.openStore(bU,(function(e){for(var i=[],n=0;n<t.length;n++)i.push(o(e,t[n]));return FT.all(i).then(a,a)})):a()}),(function(){i(0)}))}))})(e,t).then((function(e){e>0&&(l-=e),i(e)}),(function(e){i(0)}))}function a(e){n(t.evt)}function o(){e.openStore(bU,(function(o){var c=o.store.put(t);c.onsuccess=function(r){i&&PU(e).then(a,a),l++,n(t.evt)},c.onerror=function(a){function o(i){0===i&&r(new Error(IU)),h(e,t,!1).then((function(e){n(t.evt)}),(function(){r(new Error(IU))}))}i?s(1,(function(e){e>0?o(e):t.evt.persistence>=2?s(2,(function(e){o(e)})):r(new Error(IU))})):r(new Error(IU))}}))}c>0&&l>=c?s(1,(function(e){0===e?t.evt.persistence>=2?s(2,(function(e){o()})):r(new Error(IU)):o()})):o()}))}e.id=t,e.initialize=function(t){var l=t.itemCtx.diagLog();if(!(i=new CU(l)).isAvailable())return i=null,!1;var h=t.itemCtx.getCfg(),u=t.storageConfig||{};return n=u.indexedDbName||"AppInsightEvents.1",r=h.instrumentationKey||r,s=e.id||t.id||pE(),o=(a=r+"::")+s+"::",c=u.maxStorageItems>0?u.maxStorageItems:c,d((function(e){return e.isNew?FT.resolve(!0):LU(e)})).then((function(e){}),(function(e){l.warnToConsole("IndexedDbProvider failed to initialize - "+(e||"<unknown>")),i=null})),!0},e.supportsSyncRequests=function(){return!1},e.getAllEvents=function(){return null!=i&&i.isAvailable()?d((function(e){return new FT((function(t,i){(function(e,t){return e.openCursor(bU,t,(function(e,t,i){return i.push(t),0}))})(e,"#key="+e.ctx.evtKeyPrefix()).then((function(e){l=e.length,t(MU(e))}),i)}))})):FT.resolve([])},e.addEvent=function(e,t,n){return null!=i&&i.isAvailable()?(t.id=t.id||pE(),RU(t.persistence)||(t.persistence=1),d((function(i){var n=e||t.id,r={key:i.ctx.evtKeyPrefix()+n,id:n,evt:t,tm:wU(),v:1};return h(i,r,!0)}))):FT.resolve(t)},e.removeEvents=function(e){if(null==i||!i.isAvailable())return FT.resolve([]);var t=[];return new FT((function(i,n){d((function(i){return i.openCursor(bU,"#key="+i.ctx.iKey,(function(i,n,r){if(-1!==function(e,t){for(var i=t.length,n=0;n<i;n++)if(e===t[n].id)return n;return-1}(n.id,e)){var s=i.cursor.delete();return s.onerror=DU(i),s.onsuccess=function(){t.push(n.evt),i.continue()},1}return 0}))})).then((function(e){l-=t.length,i(t)}),(function(e){l-=t.length,i(t)}))}))},e.clear=function(){return null!=i&&i.isAvailable()?new FT((function(e,t){d((function(e){return kU(e,"#key="+e.ctx.evtKeyPrefix(),(function(t){return 0===t.key.indexOf(e.ctx.evtKeyPrefix())}))})).then((function(t){l=0,e(MU(t))}),t)})):FT.resolve([])},e.teardown=function(){i&&i.closeDb(n)}}))}return e.__ieDyn=1,e}(),UU="AWTEvents";function FU(e){var t=Vf()||{},i=null;try{if(i=t[e]){var n="__storage_test__";i.setItem(n,n),i.removeItem(n)}}catch(e){(function(e,t){var i=!1;return t instanceof DOMException&&(22!==t.code&&"QuotaExceededError"!==t.name&&1014!==t.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||e&&0!==e.length&&(i=!0)),i})(i,e)||(i=null)}return i}function VU(e,t){if(e)for(var i=ky(e),n=0;n<i.length;n++){var r=i[n];if(!t(e[r],r))break}}function BU(e){var t=!0;return VU(e,(function(e,i){return e&&(t=!1),t})),t}function HU(e,t){for(var i=1,n=0,r=function(){var e=[],r=t[i];if(VU(r,(function(t,i){return e.push(i),++n<10})),n>0){for(var s=0;s<e.length;s++)delete r[e[s]];return{value:!0}}i++};i<=e&&n<10;){var s=r();if("object"==typeof s)return s.value}return n>0}var $U=oU,GU=function(){function e(t,i){bS(e,this,(function(e){var n=null,r=UU,s=null,a=null,o=null,c=5e6,l=null,d=null;function h(e,t){return{key:e,db:t}}function u(e,t){void 0===t&&(t=!0);var i=null;if(n){var r=n.getItem(e);if(r)try{i=JSON.parse(r)}catch(t){n.removeItem(e)}}return t&&!i&&(i={events:{1:{},2:{},3:{}},lastAccessTime:0}),h(e,i)}function g(e,t){void 0===t&&(t=!0);var i=!0,r=e.db;if(r){t&&(r.lastAccessTime=(new Date).getTime());for(var s=1;s<=2;s++)if(!BU(r.events[s])){i=!1;break}}try{if(i)n&&n.removeItem(e.key);else{var a=JSON.stringify(r);if(a.length>c)return!1;n&&n.setItem(e.key,a)}}catch(e){return!1}return!0}function p(e){var t=[],i=u(e,!1),r=i.db;if(r){var s=r.events;try{for(var a=1;a<=2;a++)VU(s[a],(function(e,i){return e&&t.push(e),!0}))}catch(e){}n&&n.removeItem(i.key)}return t}e.id=i,n=FU(t)||null,e.initialize=function(t){if(!n)return!1;var i=t.storageConfig||{};return c=i.maxStorageSizeInBytes>0?i.maxStorageSizeInBytes:c,r=i.storageKey||UU,s=e.id||t.id||pE(),d=r+"."+s,l=r+"Version",a=t.itemCtx.getCfg().instrumentationKey,o=bT(a)||a,function(){if(n){for(var e=n.getItem(l),t=[],i=u(d),s=!1,a=0;a<n.length;a++){var c=n.key(a);if(0===c.indexOf(r)&&c!==l){if("3"!==e){t.push(h(c,null));continue}var p=u(c,!1),m=p.db;if(m){if((new Date).getTime()-m.lastAccessTime>6e5){for(var f=1,S=function(){var e=m.events[f],t=i.db.events[f];VU(e,(function(i,n){return(bT(i.iKey)||i.iKey)===o&&(t[n]=i,delete e[n]),!0})),f++};f<=2;)S();s=!0,t.push(p)}}else t.push(h(c,null))}}for(a=0;a<t.length;a++)g(t[a],!1);s&&g(i),n.setItem(l,"3")}}(),!0},e.supportsSyncRequests=function(){return!0},e.getAllEvents=function(){try{var e=[],t=u(d,!1).db;if(t)for(var i=t.events,n=2;n>=1;n--)VU(i[n],(function(t){return t&&(bT(t.iKey)||t.iKey)===o&&e.push(t),!0}));return FT.resolve(e)}catch(e){return FT.reject(e)}},e.addEvent=function(e,t,i){try{var n=u(d);t.id=t.id||pE(),$U(t.persistence)||(t.persistence=1);for(var r=t.persistence,s=t.id,a=n.db.events;;){if(a[r][s]=t,g(n))return FT.resolve(t);if(delete a[r][s],!HU(r,a))return FT.reject(new Error("Unable to free up event space"))}}catch(e){return FT.reject(e)}},e.removeEvents=function(e){try{var t=u(d,!1),i=t.db;if(i){var n=i.events;try{for(var r=0;r<e.length;++r){var s=e[r];delete n[s.persistence][s.id]}if(g(t))return FT.resolve(e)}catch(e){}e=p(t.key)}return FT.resolve(e)}catch(e){return FT.reject(e)}},e.clear=function(){try{var e=[],t=u(d,!1),i=t.db;if(i){for(var n=i.events,r=function(t){var i=n[t];VU(i,(function(t){return t&&(bT(t.iKey)||t.iKey)===o&&(delete i[t.id],e.push(t)),!0}))},s=2;s>=1;s--)r(s);g(t)}return FT.resolve(e)}catch(e){return FT.reject(e)}},e.teardown=function(){try{var e=u(d,!1),t=e.db;t&&(t.lastAccessTime=0,g(e,!1))}catch(e){}}}))}return e.__ieDyn=1,e}(),jU=oU,qU=function(e){function t(){var i=e.call(this)||this;return i.identifier="LocalStorage",i.priority=1009,i.version="3.2.9",bS(t,i,(function(e,t){var i,n,r,s;function a(){i=!1,n=!1,r=null,s=[]}function o(e,t){r||(r=new qT("LocalStorage")),r.scheduleEvent((function(e){return t(e)}),e)}function c(t){YC(e.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){o("sendToNext",(function(i){return t.provider.getAllEvents().then((function(i){for(var n=0;n<i.length;n++)try{var r=i[n];(bT(r.iKey)||r.iKey)===t.tenantId&&e.processNext(r,t.coreRootCtx.createNew())}catch(e){}}))}))}),(function(){return{iKeyConfig:t}}))}function l(t,i){YC(e.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){o("removeEvents",(function(e){var n=[];return wy(i,(function(e){(bT(e.iKey)||e.iKey)===t.tenantId&&n.push(e)})),n.length>0?t.provider.removeEvents(n).then((function(e){})).catch((function(e){})):FT.resolve()}))}),(function(){return{iKeyConfig:t,events:i}}))}function d(e){var t=new xU;return t.initialize(e)||(t=null),t}function h(e,t){var i=new GU(e);return i.initialize(t)||(i=null),i}function u(t,i,n,r){var a=e.identifier,o=t.extensionConfig=t.extensionConfig||[],u=o[a]=o[a]||{};u.providers||(u.providers=[nU.LocalStorage,nU.IndexedDb]);var g=function(t,i,n,r){t&&(t.extensionConfig=t.extensionConfig||[]),!r&&i&&(r=i.getProcessTelContext().getNext());var s=null,a=e._getTelCtx().getNext();return a&&(s=a.getPlugin()),new NE(r,t,i,s)}(t,i,0,r),p={itemCtx:g,storageConfig:u,id:e.id},m=function(e){for(var t=e.storageConfig.providers,i=null,n=0;!i&&n<t.length&&n<5;)switch(t[n++]){case nU.LocalStorage:i=h("localStorage",e);break;case nU.SessionStorage:i=h("sessionStorage",e);break;case nU.IndexedDb:i=d(e)}return i}(p);if(m){var f={iKey:t.instrumentationKey,tenantId:bT(t.instrumentationKey)||t.instrumentationKey,minPersistenceCacheLevel:1,coreRootCtx:g,providerContext:p,provider:m};jU(u.minPersistenceLevel||-1)&&(f.minPersistenceCacheLevel=u.minPersistenceLevel),s.push(f),i.addNotificationListener({eventsSent:function(e){l(f,e)},eventsDiscarded:function(e,t){l(f,e)}}),c(f)}}a(),e.initialize=function(e,n,s,a){YC(n,(function(){return"LocalStorageChannel.initialize"}),(function(){i||(t.initialize(e,n,s),t.setInitialized(!1),i=!0,r=new qT("LocalStorage",n.logger)),u(e,n,0,a)}),(function(){return{coreConfig:e,core:n,extensions:s,pluginChain:a}}))},e.processTelemetry=function(t,r){var a=t;if(i&&!n){r=e._getTelCtx(r),DT(t,e.identifier);var c=null;wy(s,(function(e){e.iKey===t.iKey&&(c=e)}));var l=c?c.provider:null;if(a.sync||!l)return void e.processNext(a,r);a.id=a.id||pE(),oU(a.persistence)||(a.persistence=1),function(e,t){return!(t.sync||t.persistence<e.minPersistenceCacheLevel)}(c,a)&&o("processTelemetry",(function(e){return l.addEvent(a.id,a,r)}))}e.processNext(a,r)},e.pause=function(){n=!0},e.resume=function(){YC(e.core,(function(){return"LocalStorageChannel:resume"}),(function(){n=!1,wy(s,(function(e){e.provider&&c(e)}))}))},e._doTeardown=function(e,t){wy(s,(function(e){var t=e.provider;t&&t.teardown()})),a()},e.flush=function(e,t){}})),i}return qf(t,e),t.__ieDyn=1,t}(BE),WU=qU,zU=class{constructor(e,t,i,n,r,s,a){this.logger=e,this.configProvider=t,this.clientInfo=i,this.eventLatency=n,this.contextProvider=r,this.accountCollectorURL=s,this.envOverride=a,this.manager=new RA,this.managerConfig=this.createConfigForManager(),this.currentTransmitProfile=Qe.REPORTING_PROFILE.RT_PROFILE,this.initManager(),this.uiVersion=this.getUiVersion(),this.configProvider.on("configUpdated",(()=>this.updateChannelConfig()))}createLogger(e){return new JU(e,this.manager,this.logger,this.configProvider,this.uiVersion,this.eventLatency,this.contextProvider,this.envOverride)}createConfigForManager(){const e={extensionConfig:{LocalStorage:{storageKey:"TsCalling"}},propertyConfiguration:{populateBrowserInfo:!0,populateOperatingSystemInfo:!0},channelConfiguration:{eventsLimitInMem:this.configProvider.config.eventsLimitInMem},endpointUrl:this.accountCollectorURL,enableCompoundKey:this.configProvider.config.enableCompoundKey};if(this.configProvider.config.useLocalStorageForOneDs){const t=new WU;e.channels=[[t]]}return e}getUiVersion(){const e=this.clientInfo.match(/^.*?\/(\d+\/)(.*?)\/.*$/);return e?e[1]+e[2]:this.clientInfo}updateChannelConfig(){this.configProvider.config.eventsLimitInMem!==this.managerConfig.channelConfiguration.eventsLimitInMem&&this.manager.getPostChannel().setEventQueueLimits(this.configProvider.config.eventsLimitInMem),this.setTransmitProfile()}initManager(){this.manager.create(this.managerConfig,[]),this.manager.getPostChannel()._notificationManager.addNotificationListener({eventsDiscarded:(e,t)=>this.logDiscardedEvents(e,t),eventsSent:e=>this.logSentEvents(e)}),this.setTransmitProfile()}logDiscardedEvents(e,t){let i="discarded events:";e.forEach((e=>i=`${i+e.name};`)),this.logger.info(`${i} reason:${t}`)}logSentEvents(e){let t=`sent events: ${e[0]?.data?.CorrelationId&&ft("value",e[0].data.CorrelationId)}:`;e.forEach((e=>{t=`${t+e.name};`})),this.logger.info(`${t}`)}setTransmitProfile(){this.configProvider.config.transmitProfileTimings.length&&this.manager.getPostChannel()._loadTransmitProfiles({[this.configProvider.config.transmitProfileName]:this.configProvider.config.transmitProfileTimings}),this.configProvider.config.transmitProfileName!==this.currentTransmitProfile&&this.manager.getPostChannel()._setTransmitProfile(this.configProvider.config.transmitProfileName),this.currentTransmitProfile=this.configProvider.config.transmitProfileName}},JU=class{constructor(e,t,i,n,r,s,a,o){this.tenant=e,this.manager=t,this.logger=i,this.configProvider=n,this.uiVersion=r,this.eventLatency=s,this.contextProvider=a,this.envOverride=o,this.instanceConfig={extensions:[],extensionConfig:[]}}sendEvent(e){this.setEnvPropertiesToEveryEvent();const t=this.configProvider.config.telemetryTenants[this.tenant],i=this.manager.getInst(t)??this.manager.newInst(t,this.instanceConfig,[]),n=e.props,r={};switch(this.logger.info(`preparing event for delievery: ${e.props?.CorrelationId??""}/${e.eventName}`),this.tenant){case"signaling":n.SkypeId&&(r.user_id={value:n.SkypeId,kind:10},r.Skype_InitiatingUser_Username={value:n.SkypeId,kind:10},r.SkypeId={value:n.SkypeId,kind:10},delete n.SkypeId),this.uiVersion&&(r.ui_version={value:this.uiVersion,kind:0});break;case"media":case"tlePlayer":this.uiVersion&&(r.uiVersion={value:this.uiVersion,kind:0});break;case"realtimeMedia":this.uiVersion&&(r["AppInfo.Version"]={value:this.uiVersion,kind:0})}for(const e of Object.keys(n)){const t=n[e];r[e]={value:t?.value??t,kind:t?.piiKind??0}}const s={name:e.eventName,data:r,latency:this.eventLatency,persistence:ST.Normal};this.configProvider.config.useSendBeaconSync&&(s.sync=2),this.logger.info(`about to send event ${JSON.stringify(s)}`),i.track(s)}setEnvPropertiesToEveryEvent(){const e=this.contextProvider?.();if(!ht(this.ctx,e)&&(this.ctx=e,this.ctx))if(this.envOverride){for(const e of Object.keys(this.envOverride||{}))if(this.ctx[e]){const t=this.ctx[e].piiKind??0,i=xt(this.ctx[e].value);this.manager.getPropertyManager().setProperty(this.envOverride[e],{value:i,kind:t})}}else for(const e of Object.keys(this.ctx)){const t=this.ctx[e].piiKind??0,i=xt(this.ctx[e].value);this.manager.getPropertyManager().setProperty(e,{value:i,kind:t})}}},KU=class extends We{constructor(e,t,i){super(),this.relayManager=e,this.configProvider=t,this.logger=i,this.currentInfo={},this.currentAreaContent={},this.isEnabled=!1,this.isEnabled=this.configProvider.config.enableE911,t.on("configUpdated",(()=>{const e=this.isEnabled;this.isEnabled=this.configProvider.config.enableE911,!this.isEnabled||e===this.isEnabled&&this.prober||(this.prober?.dispose(),this.prober=void 0,this.configProvider.config.probeE911OnInit&&this.probeForIP("config"))}))}get info(){return this.currentInfo}get areaContent(){return this.currentAreaContent}async getInfo(){return this.isEnabled&&!this.prober&&await this.probeForIP("publicGetInfo"),this.currentInfo}setClientInfo(e,t){if(this.isEnabled)switch(this.logger.info(`Client info for ${e} set`),e){case 3:this.mergeClientAreaInfo(JSON.parse(t));break;case 1:break;case 2:this.mergeClientNetworkInfo(JSON.parse(t))}}mergeClientAreaInfo(e){const t=JSON.stringify(this.currentAreaContent);this.currentAreaContent.geoCoordinates=e.geoCoordinates,lt(this.currentAreaContent),JSON.stringify(this.currentAreaContent)!==t&&this.raiseChanged()}mergeClientNetworkInfo(e){if(0===Object.keys(e).length){const e=Object.keys(this.currentInfo).length+Object.keys(this.currentAreaContent).length;return this.currentInfo={},this.currentAreaContent={},void(e>0&&this.raiseChanged())}const t=this.currentInfo.bssid!==e.bssid||this.currentInfo.bssidv6!==e.bssidv6||this.currentInfo.mac!==e.mac||this.currentInfo.macv6!==e.macv6||this.currentInfo.subnetLengthIpv4!==e.subnetLengthIpv4||this.currentInfo.subnetLengthIpv6!==e.subnetLengthIpv6,i=this.currentInfo.e911;this.currentInfo.bssid=e.bssid,this.currentInfo.bssidv6=e.bssidv6,this.currentInfo.e911=e.e911,this.currentInfo.mac=e.mac,this.currentInfo.macv6=e.macv6,this.currentInfo.subnetLengthIpv4=e.subnetLengthIpv4,this.currentInfo.subnetLengthIpv6=e.subnetLengthIpv6,lt(this.currentInfo),t?this.probeForIP("clientNetworkInfoChanged").then((e=>{e||this.raiseChanged()})):JSON.stringify(i)!==JSON.stringify(e.e911)&&this.raiseChanged()}async probeForIP(e){return this.probingPromise?(this.logger.info(`Probing already in progress, tried to start for: ${e}`),this.probingPromise):(this.probingPromise=this.probeForIPInternal(e),this.probingPromise.then((e=>(this.probingPromise=void 0,e))).catch((e=>(this.probingPromise=void 0,this.logger.error(`E911 probing failed: ${Ve(e)}`),!1))))}async probeForIPInternal(e){this.logger.info(`Probing for public IP address: ${e}`);const t=await this.ensureProber();if(await t.ensureOnline(),t.ipFromRelay){if((this.currentInfo.ipv4||this.currentInfo.ipv6)!==t.ipFromRelay)return delete this.currentInfo.ipv4,delete this.currentInfo.ipv6,this.currentInfo[Hp.test(t.ipFromRelay)?"ipv4":"ipv6"]=t.ipFromRelay,this.raiseChanged(),!0}else if(0!==Object.keys(this.currentInfo).length)return this.currentInfo={},this.raiseChanged(),!0;return!1}async ensureProber(){if(this.prober)return this.prober;const e=OD(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config);return this.prober=new MD(e,new SD(this.logger.createChild("Prober"),this.logger.createChild("ProberUnsafe"))),this.prober}};var YU=class{constructor(){this.reports={}}watch(e){const t={time:Date.now(),duration:-1};return this.reports[e]&&(e=`${e}_last`),this.reports[e]=t,{end:e=>{e?t.error=e:t.duration=Date.now()-t.time}}}getReports(){return this.reports}},QU="trapTokenFetch",XU=class{constructor(e){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new YU,this.context=e,this.logger=e.logger.createChild("RM"),this.request=e.request}initialize(){this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setRelayOverride(e){this.relaysOverride=e}setDefaultRelayConfig(e){this.config??(this.config=e)}async queryRelaysAsync(e={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const t=await this.updateRelaysPromise;return t?"turn"===e.relayType?t.Turn:e.isRemoteClientLync?t.Lync:t.Skype:[]}getAuthTokenStats(){}getStats(){return this.timers.getReports()}updateRelaysFromConfigAsync(e=!1){const t=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((e=>(this.updateRelaysPromise=t,e))).catch((t=>(this.updateRelaysPromise=null,e?this.logger.warn("failed to retrieve relays",Ve(t)):this.logger.error("failed to retrieve relays",Ve(t)),null)));return t}refreshRelaysFromConfig(){this.request.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}updateRelaysAsync(){const e=this.config.Service.tokenUrl;let t;const i=this.context.trapTokenCredentialsProvider?async()=>(t=this.timers.watch(QU),this.context.trapTokenCredentialsProvider()):async()=>{const i=this.timers.watch("skypeTokenFetch");let n="";try{n=await this.context.tokenProvider(),this.logger.info("fetching skypeToken")}catch(e){throw i.end(Ve(e)),e}return i.end(),t=this.timers.watch(QU),(await this.request.get(e,{headers:{"X-Skypetoken":n,"api-version":2}})).response};return this.logger.info("Fetch TRAP token "+(this.context.trapTokenCredentialsProvider?"with provider":"directly")),i().then((e=>{t.end();let i=0;const n=this.config.Token.earlyRefreshMinutes,r=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(e),i=Math.max(e.expires-60*n,e.expires*r/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*i);const s=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:'"rtcmedia"',a=function(e){return{expires:e.expires,username:e.username,password:e.password,realm:e.realm}}(this.getTrapToken(s)),o={Skype:[{addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",...a}],Lync:[{addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",...a}],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",...a}]};return this.logger.info("relays from trap",o),o})).catch((e=>{throw t&&t.end(Ve(e)),e}))}storeTrapTokens(e){if(!e?.tokens)return void this.logger.error("failed to get tokens from trap response");const t={};e.tokens.forEach((i=>{t[i.realm]={expires:e.expires,username:i.username,password:i.password,realm:i.realm}})),this.trapTokens=t}getTrapToken(e){if("string"==typeof e){const t=e.replace(/^"|"$/g,""),i=`"${t}"`,n=this.trapTokens[i]||this.trapTokens[t];if(n)return n}throw new Error(`token for relay not found, realm: ${e}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const e=this.timers.watch("configFetch");try{const t=await this.context.configProvider();e.end(),this.logger.info("retrieved configuration:",t),t&&(this.config=t),this.logger.info("applied configuration:",this.config)}catch(t){this.logger.warn("failed to retrieve configuration",Ve(t)),e.end(Ve(t))}}};var ZU=class{constructor(){this.reports={}}watch(e){const t={time:Date.now(),duration:-1};return this.reports[e]&&(e=`${e}_last`),this.reports[e]=t,{end:e=>{e?t.error=e:t.duration=Date.now()-t.time}}}getReports(){return this.reports}},eF=class{constructor(e){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new ZU,this.context=e,this.authTokenFetcher=this.context.authTokenFetcher,this.logger=e.logger.createChild("RM2")}initialize(){}setRelayOverride(e){this.relaysOverride=e}setDefaultRelayConfig(e){this.config??(this.config=e),this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setClientSupportsGenericTokenApi(e){this.authTokenFetcher.supportsGenericTokenApi=e}async queryRelaysAsync(e={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const t=await this.updateRelaysPromise;return t?"turn"===e.relayType?t.Turn:e.isRemoteClientLync?t.Lync:t.Skype:[]}getStats(){return this.timers.getReports()}getAuthTokenStats(){return this.context.authTokenFetcher.getStats()}updateRelaysFromConfigAsync(e=!1){const t=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((e=>(this.updateRelaysPromise=t,e))).catch((t=>(this.updateRelaysPromise=null,e?this.logger.warn("failed to retrieve relays",Ve(t)):this.logger.error("failed to retrieve relays",Ve(t)),null)));return t}refreshRelaysFromConfig(){this.context.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}async updateRelaysAsync(){const e=this.context.configProvider?.useNewTokenApi?"aadTokenFetch":"skypeTokenFetch",t=this.timers.watch(e),i=Te();this.logger.info(`${i}[RM2] Fetch TRAP token`);try{const e=await this.context.authTokenFetcher.fetchTrapToken(i,this.config);t.end();let n=0;const r=this.config.Token.earlyRefreshMinutes,s=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(e),n=Math.max(e.expires-60*r,e.expires*s/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*n);const a=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:'"rtcmedia"',o=function(e){return{expires:e.expires,username:e.username,password:e.password,realm:e.realm}}(this.getTrapToken(a)),c={Skype:[{addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",...o}],Lync:[{addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",...o}],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",...o}]};return this.logger.info("relays from trap",c),c}catch(e){throw this.logger.info(`Fetch TRAP token failed with error ${e}`),t&&t.end(Ve(e)),e}}storeTrapTokens(e){const t={};if(e?.tokens)e.tokens.forEach((i=>{t[i.realm]={expires:e.expires,username:i.username,password:i.password,realm:i.realm}}));else{if(!e.realm)return void this.logger.error("failed to get tokens from trap response");t[e.realm]=e}this.trapTokens=t}getTrapToken(e){if("string"==typeof e){const t=e.replace(/^"|"$/g,""),i=`"${t}"`,n=this.trapTokens[i]||this.trapTokens[t];if(n)return n}throw new Error(`token for relay not found, realm: ${e}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const e=this.timers.watch("configFetch");try{const t=await this.context.relayConfigProvider();e.end(),this.logger.info("retrieved configuration:",t),t&&(this.config=t),this.logger.info("applied configuration:",this.config)}catch(t){this.logger.warn("failed to retrieve configuration",Ve(t)),e.end(Ve(t))}}};var tF=class{constructor(e,t,i,n,r){this.signalingAgentProvider=t,this.request=i,this.tokenProviders=n,this.configProvider=r,this.errors=[],this.clientSupportsGenericTokenAPI=!1,this.logger=e.createChild("AuthTokenFetcher")}set supportsGenericTokenApi(e){this.clientSupportsGenericTokenAPI=e}buildHeaders(e,t){const i={"api-version":2};switch(this.configProvider?.useTokenMigrationHeader&&(i["X-MS-Migration"]="True"),e){case 4:case 8:return i.Authorization=`Bearer ${t}`,i;case 1:return i["X-Skypetoken"]=t,i;default:throw new Error(`TokenType ${e} is not supported`)}}serviceSupportedTokenTypes(e){let t=null;if(void 0===e)t=this.clientSupportedTokenTypes();else{const i=e?.toLowerCase();t=this.constructTokenType(i)}return null===t&&this.configProvider?.useSkypeTokenWhenNoAuthenticateHeader&&(t|=1),t}extractWwwauthenticateHeaders(e){let t={};if(e){const i=Ft(e,"www-authenticate");i&&(t={authenticationHeaders:[i]})}return t}convertStringToTokenType(e){switch(e){case"cae":return 8;case"aad":return 4;case"skype":return 1;default:return this.logger.info("[authTokenFetcher][convertStringToTokenType]unexpected: unrecognized token type ${tokenType}"),null}}getTokenTypeFromHeaders(e,t){if(!this.clientSupportsGenericTokenAPI)return 1;let i=null;const n=t?.authenticationHeaders;if(!n&&e)this.configProvider?.useSkypeTokenWehnNoAuthHeader?(this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),i=1):(this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),i=this.clientSupportedTokenTypes());else if(n||e){if(n&&e)for(const e of n){const t=Vt(e);if(this.configProvider?.supportMissingTokenTypesInResponse&&0===t.length)this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),i=this.clientSupportedTokenTypes();else for(const e of t){const t=this.convertStringToTokenType(e.toLowerCase());this.configProvider?.clientSupportsCaeToken&&8===t&&(i|=8),this.configProvider?.clientSupportsAadToken&&4===t&&(i|=4),this.configProvider?.clientSupportsSkypeToken&&1===t&&(i|=1)}}}else this.logger.info("[authTokenFetcher][getTokenTypeFromHeaders] retrying to fetch token woth client supported tokens"),i=this.clientSupportedTokenTypes();return i}constructTokenType(e){let t=null;return e.includes("aad")&&this.configProvider?.clientSupportsAadToken&&(t|=4),e.includes("cae")&&this.configProvider?.clientSupportsCaeToken&&(t|=8),e.includes("skype")&&this.configProvider?.clientSupportsSkypeToken&&(t|=1),t}getTokenMetadataForTrapService(e,t,i){const n={verb:"POST",path:e},r=JSON.stringify(n);let s=null;const a=this.extractWwwauthenticateHeaders(i),o=!!a?.authenticationHeaders;return s=i?this.getTokenTypeFromHeaders(o,a):this.serviceSupportedTokenTypes(t),this.logger.info(`[authTokenFetcher][getTokenMetadata] return token type=${s}, factoJson=${r}`),{tokenType:s,factorsJson:r,requestMetadataJson:a,isUnauthorized:o}}clientSupportedTokenTypes(){let e=null;return this.configProvider?.clientSupportsAadToken&&(e|=4),this.configProvider?.clientSupportsCaeToken&&(e|=8),this.configProvider?.clientSupportsSkypeToken&&(e|=1),e}async handleAuthTokenFailure(e,t,i,n){this.logger.info("[authTokenFetcher][handleAuthTokenFailure] failed to fetch token, retrying");try{const r=this.getTokenMetadataForTrapService(t,void 0,i);return this.logger.info(`[authTokenFetcher][handleAuthTokenFailure] token request options=${r}`),r.invalidToken=n,await this.signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(e,!1,r)}catch(e){this.errors.push(Ve(e)),this.logger.error(`[authTokenFetcher] failed to fetch token trough new api with error: ${Ve(e)}, quiting`)}}getRequestToken(e){const t=Ft(e,"X-Skypetoken");if(t)return t;const i=Ft(e,"Authorization");if(i){const e=i.split(" ");if(2===e.length)return e[1]}}async fetchTrapCredentials(e,t,i){const n=this.buildHeaders(t,e),r=await this.request.get(i,{headers:n});return r?.response}async fetchTrapTokenWithNewTokenApi(e,t,i){let n;this.logger.info(`${i}[authTokenFetcher] fetching token through fetchTrapTokenWithNewTokenApi`);const r=this.getTokenMetadataForTrapService(e,t);try{return n=await this.signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(i,!1,r),this.tokenTypeFetched=this.signalingAgentProvider.getSignalingAgent().authTokenManager.getLastTokenType(i),await this.fetchTrapCredentials(n,this.tokenTypeFetched,e)}catch(t){this.errors.push(Ve(t)),this.logger.error(`${i}[authTokenFetcher] fetchTrapTokenWithNewTokenApi failed with ${Ve(t)}, retrying...`);const r=t?.response?.headers;if(r){const t=this.getRequestToken(r);return n=await this.handleAuthTokenFailure(i,e,r,t),this.tokenTypeFetched=this.signalingAgentProvider.getSignalingAgent().authTokenManager.getLastTokenType(i),await this.fetchTrapCredentials(n,this.tokenTypeFetched,e)}throw t}}async fetchTrapTokenThroughProvider(){return this.logger.info("[authTokenFetcher][authTokenFetcher] fetching token through fetchTrapTokenThroughProvider"),this.tokenProviders.trapTokenCredentialsProvider()}async fetchTrapTokensWithLegacyTokenFetcher(e,t){this.logger.info(`${t}[authTokenFetcher][authTokenFetcher] fetching token through fetchTrapTokensWithLegacyTokenFetcher`);try{this.tokenTypeFetched=1;const t=await this.tokenProviders.skypeTokenProvider();return(await this.request.get(e,{headers:{"X-Skypetoken":t,"api-version":2}})).response}catch(e){throw this.errors.push(Ve(e)),this.logger.error(`${t}[authTokenFetcher] fetchTrapTokensWithLegacyTokenFetcher failed with ${Ve(e)}`),e}}getStats(){return{tokenType:this.tokenTypeFetched,errors:this.errors}}async fetchTrapToken(e,t){let i;this.logger.info(`${e}[AuthTokenFetcher] Start fetching token`);const n=t.Service.tokenUrl,r=t.Service.supportedTokenTypes;return i=this.configProvider?.useNewTokenApi?this.fetchTrapTokenWithNewTokenApi(n,r,e):this.tokenProviders.trapTokenCredentialsProvider?this.fetchTrapTokenThroughProvider():this.fetchTrapTokensWithLegacyTokenFetcher(n,e),i}},iF=class{constructor(e,t,i){this.config=e,this.signalingAgentProvider=t,this.logger=i}createRelayManager(e){return this.relayManager||(this.configProvider=e,this.relayManager=this.config.relayManager||this.buildRelayManager(this.config.httpRequestDispatcher,this.config.tokenProvider,this.config.configProvider,this.config.appStateProvider,this.config.trapTokenCredentialsProvider,e)),this.relayManager}getRelayManager(){return this.relayManager}buildRelayManager(e,t,i,n,r,s){const a=e||new Be(this.logger),o={get:(e,t)=>a.getAsync(e,a.getRequestOptions("GET",t?.headers,null,t?.timeout)),isOnline:n.isOnline};if(this.configProvider.config.useNewTokenApi){const e=new tF(this.logger,this.signalingAgentProvider,o,{skypeTokenProvider:t,trapTokenCredentialsProvider:r},s?.config);return function(e){return new eF(e)}({logger:this.logger,relayConfigProvider:()=>i.getRelayConfig(),isOnline:n.isOnline,authTokenFetcher:e,configProvider:this.configProvider?.config})}return function(e){return new XU(e)}({logger:this.logger,tokenProvider:t,trapTokenCredentialsProvider:r,configProvider:()=>i.getRelayConfig(),request:{get:(e,t)=>a.getAsync(e,a.getRequestOptions("GET",t?.headers,null,t?.timeout)),isOnline:n.isOnline}})}},nF=class extends Error{constructor(e,t=1){super(e),this.callSupport=t}};function rF(e){let t={};return e.telemetryLoggers?t=e.telemetryLoggers:e.telemetryService?.getGenericTelemetryLogger&&e.telemetryTenants?Object.keys(e.telemetryTenants).forEach((i=>t[i]=e.telemetryService.getGenericTelemetryLogger(e.telemetryTenants[i]))):e.telemetryService&&(e.telemetryService.sendEvents||e.telemetryService.getCallingAdapter)&&(e.telemetryService.sendEvents&&(t.media={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendEvents([t])}},t.tlePlayer={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendEvents([t])}}),e.telemetryService?.sendRealTimeEvents&&(t.realtimeMedia={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendRealTimeEvents([t])}}),e.telemetryService.getCallingAdapter&&(t.signaling={sendEvent(t){e.telemetryService.getCallingAdapter().sendEvent(t.eventName,t.props)}})),t}var sF=class e extends We{constructor(e,t){super(),this._config=e,this._ecsProvider=t,this.callRegistries=[],this._logger=new Qt(this._config.logger).createChild("PluginlessStack"),this._platformManager=new Yx,this._waitForAccountConfiguration=new Yu,this.platformCallConstraintsProvider=new Yt(this._logger.createChild("PlatformConstraintsProvider"))}async initializeMediaAgent(e){let t,i=null;if(!this._mediaAgentProvider)throw new nF("PluginlessStack initialize MediaAgent error, Media Stack not initialized",i);try{this._relayManagerFactory=new iF(e,this._signalingAgentProvider,this._logger),t=await this._mediaAgentProvider.buildAgent(this._config.platformType,this._relayManagerFactory,this._midCallTelemetry)}catch(e){i=e.some((e=>"incompatible_version"===e.reason))?2:1}if(!this._config.usePlatformSupportApi&&!this._config.callSettings?.useLwjForAllCalls){if(i)throw new nF("PluginlessStack initialization failed",i);{const e=(new Yx).getPlatformSupportLevel(!0);if(1!==e&&2!==e)throw new nF("PluginlessStack initialization failed",1)}}t?(this._screenSharingManager=new Zx(t.getScreenSharingManager()),this._waitForAccountConfigurationTimeout=window.setTimeout((()=>{this._waitForAccountConfiguration.resolve(void 0),this._waitForAccountConfigurationTimeout=void 0}),3e4),this._oneDsTelemetryLoggers=function(e,t,i,n,r,s){const a={signaling:[],media:[],tlePlayer:[],realtimeMedia:[]};let o={signaling:{sendEvent:e=>a.signaling.push(e)},media:{sendEvent:e=>a.media.push(e)},tlePlayer:{sendEvent:e=>a.tlePlayer.push(e)},realtimeMedia:{sendEvent:e=>a.realtimeMedia.push(e)}};return t.getConfigReceivedOrTimeout().then((async()=>{let c=(await r)?.serviceUrls?.OneDsCollectorUrl;if(c=c??t.config.collectorUrl,c){const r=new zU(e,t,i,t.config.eventLatency,n,c);o.signaling=r.createLogger("signaling"),o.media=r.createLogger("media"),o.tlePlayer=r.createLogger("tlePlayer");const s=new zU(e,t,i,t.config.eventLatencyRealTime,n,c,{"UserInfo.Ring":"Ring","UserInfo.TenantId":"TenantId","AppInfo.ClientType":"client_type","UserInfo.ETag":"AppInfo.EcsEtag",appversion:"First/Second Client VDI Desktop Version",vdiMode:"First/Second Client VDI Mode",vdiConnectedState:"First/Second Client VDI Connected State",vdiShimVersion:"First/Second Client VDI Shim Version",vdiProvider:"First/Second Client VDI Provider Version"});o.realtimeMedia=s.createLogger("realtimeMedia")}else o=rF(s);for(const[e,t]of Object.entries(a))for(const i of t)o[e].sendEvent(i)})),o}(this._logger.createChild("OneDsLogger"),t.getConfigProvider(),e.clientInformation,this._config.telemetryContextProvider,this._waitForAccountConfiguration.promise,this._config),t.getConfigProvider().config.useOneDsLogger&&(this.signalingLoggerAdapter={sendEvent:(e,t)=>{const i={eventName:e,props:t};this._oneDsTelemetryLoggers.signaling.sendEvent(i)}}),this._mediaAgent=t,this._e911=new KU(this._relayManagerFactory.getRelayManager(),this._mediaAgent.getConfigProvider(),this._logger.createChild("E911")),this._e911?.changed((()=>{this.event("e911InfoChanged").raise(this._e911?.info,this._e911?.areaContent)}))):this._deviceManager=new en}async initializeSignalingAgentProvider(e){this._trouterService=e.trouterService,this._signalingAgentProvider=aU(e.signalingAgentConfig,this._ecsProvider,this._config.logger,this.signalingLoggerAdapter)}static async build(t,i,n){try{const r=new e({detectH264Support:t.mediaAgentFactoryConfig.detectH264Support,domOverrides:t.mediaAgentFactoryConfig.domOverrides,mediaSettings:t.mediaAgentFactoryConfig.settings,logger:t.logger,telemetryLoggers:t.telemetryLoggers,telemetryService:t.telemetryService,telemetryTenants:t.telemetryTenants,telemetryContextProvider:t.telemetryContextProvider,platformType:t.platformType,callSettings:t.callSettings,usePlatformSupportApi:t.usePlatformSupportApi,clientInformation:t.signalingAgentConfig.clientInformation},i);return r.initializeMediaProvider({detectH264Support:t.mediaAgentFactoryConfig.detectH264Support,domOverrides:t.mediaAgentFactoryConfig.domOverrides,mediaSettings:t.mediaAgentFactoryConfig.settings,logger:t.mediaAgentFactoryConfig.logger,safeLogger:t.mediaAgentFactoryConfig.safeLogger,webcvProvider:t.mediaAgentFactoryConfig.webcvProvider,wasmdnsProvider:t.mediaAgentFactoryConfig.wasmdnsProvider,wasmaecProvider:t.mediaAgentFactoryConfig.wasmaecProvider,wasmVqeProvider:t.mediaAgentFactoryConfig.wasmVqeProvider,createWasmWorkerCbs:t.mediaAgentFactoryConfig.createWasmWorkerCbs,encodedStreamsWorkerProvider:t.mediaAgentFactoryConfig.encodedStreamsWorkerProvider,clientInformation:t.signalingAgentConfig.clientInformation}),r.setMidCallTelemetry(n),r.initializeSignalingAgentProvider({signalingAgentConfig:t.signalingAgentConfig,trouterService:t.trouterService}),await r.initializeMediaAgent({httpRequestDispatcher:t.mediaAgentFactoryConfig.httpRequestDispatcher,tokenProvider:t.mediaAgentFactoryConfig.tokenProvider,configProvider:t.mediaAgentFactoryConfig.configProvider,appStateProvider:t.mediaAgentFactoryConfig.appStateProvider,clientInformation:t.signalingAgentConfig.clientInformation,trapTokenCredentialsProvider:t.mediaAgentFactoryConfig.trapTokenCredentialsProvider,relayManager:t.mediaAgentFactoryConfig.relayManager}),r}catch(t){throw t instanceof nF?t:new nF(`${t}`)}}static async buildBaseStack(t,i){const n=new e(t,i);return n.initializeMediaProvider({detectH264Support:t.detectH264Support,domOverrides:t.domOverrides,mediaSettings:t.mediaSettings,logger:t.logger,safeLogger:t.safeLogger,webcvProvider:t.webcvProvider,wasmdnsProvider:t.wasmdnsProvider,wasmaecProvider:t.wasmaecProvider,wasmVqeProvider:t.wasmVqeProvider,createWasmWorkerCbs:t.createWasmWorkerCbs,encodedStreamsWorkerProvider:t.encodedStreamsWorkerProvider,clientInformation:t.clientInformation}),n}async init(){}async dispose(e=Te()){const t=this._logger.createFnLogger("dispose",e);t.info("Dispose"),this._ecsProvider.dispose(),this._e911?.dispose();const i=e=>{t.warn("Failed:",e)},n=this.callRegistries.map((t=>t.dispose(e).catch(i)));await Promise.all(n),await this._mediaAgent.dispose(e).catch(i),t.info("media agent is disposed"),this.callRegistries=[],t.info("call registries are disposed"),this._screenSharingManager&&(this._screenSharingManager.dispose(e),this._screenSharingManager=void 0,t.info("screensharing manager is disposed")),this._deviceManager=void 0,super.dispose()}getCallRegistry(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()}async createCallRegistry(e,t=Te()){const i=e?Pe(e.id):void 0,n=this._logger.createFnLogger(`createCallRegistry[identity=${i}]`,t),r=this.callRegistries.find((t=>t.identity===e.id));return r&&!r.isDisposing?(n.info(`callRegistry already exists for ${Pe(e.id)}`),r):(r?.isDisposing&&await r.disposePromise,this._createCallRegistry(e))}createCompositor(e){throw new Error("Method not implemented.")}_createCallRegistry(e){if(!this._trouterService)throw new nF("Unable to create call registry, trouter service undefined");if(!this._mediaAgent)throw new nF("Unable to create call registry, media agent undefined");if(!this._signalingAgentProvider)throw new nF("Unable to create call registry, signaling agent undefined");const t=new qm(this._trouterService,this._signalingAgentProvider,this._mediaAgent,this._logger,rF(this._config),this._ecsProvider,e,this._oneDsTelemetryLoggers);return t.on("disposed",(()=>{this.callRegistries.splice(this.callRegistries.indexOf(t),1)})),t.on("accountConfigurationReceived",(e=>{0===this._waitForAccountConfiguration.state&&(this._waitForAccountConfiguration.resolve(e),window.clearTimeout(this._waitForAccountConfigurationTimeout)),this._relayManagerFactory.getRelayManager().setDefaultRelayConfig(e.relayConfig),this._relayManagerFactory.getRelayManager().setClientSupportsGenericTokenApi(e.clientSupportsGenericTokenAPI)})),t.on("locationInfoSet",((e,t)=>{this._e911?.setClientInfo(e,t)})),this.callRegistries.push(t),t}initializeMediaProvider(e){const t=(0,$e.assign)({},e);this._mediaAgentProvider=new Jx(t,this._ecsProvider,this.platformCallConstraintsProvider),this._deviceManager=new Km(this._mediaAgentProvider.getDeviceManager())}setMidCallTelemetry(e){this._midCallTelemetry=e}getDeviceManager(){return this._deviceManager}async getDeviceManagerAsync(){return this._deviceManager}createDeviceManager(e){return this._deviceManager}getScreenSharingManager(){return this._screenSharingManager}getSetup(){}getEcsProvider(){return this._ecsProvider}async getEcsProviderAsync(){return this._ecsProvider}getCallFeedback(){return null}getAiMdp(){return null}fireIntent(e,t){}getVersion(){return{build:"2024.14.01.41",ovb:"a7c1622acc37a0ab89ed93e9fad06dfff1477239"}}getMediaStatus(){return null}getVideoCapabilityLimits(){return null}async setMediaConfig(e){this._mediaAgent.setMediaConfig(e)}async getE911Info(){return this._e911?.getInfo()}setPlatformCallConstraints(e){this.platformCallConstraintsProvider.setConstraints(e)}getPlatformSupportLevel(){return this._platformManager.getPlatformSupportLevel(!!this._mediaAgent)}getLiveStreamClient(){return new Zi(this._ecsProvider.createEcsConfiguration(),this._logger.createChild("LiveStreamClient"),(()=>rF(this._config).tlePlayer))}createVoipCallCoordinator(){}async setLogFileName(e,t,i){throw new Error("not supported")}aggregateDiagnosticLogs(e){return Promise.reject("not supported")}extendBrbFeedback(e,t){return Promise.reject("not supported")}async addOcclusion(e,t,i,n,r,s){}async removeOcclusion(e,t,i,n){}async flushLogs(){throw new Error("not supported")}async getStageCapability(){throw new Error("not supported")}},aF={build(e){const t=e.telemetryContextProvider?.(),i=new Qx(t),n=new rf;return function(e,t,i){if(!Ym.RootToolsManager.isDelegateSet()){const n=new sf(e.telemetryService,t);if(Ym.RootToolsManager.setDelegate(n),n.on("onMidCallTelemetry",(e=>i.send(e))),e.logger){const t=new Xm(e.logger);Ym.LogFactory.instance().addAppender(t)}}e.logger=new Ae("JS.TsCalling.Pluginless",!0),e.mediaAgentFactoryConfig.logger=new Ae("JS.TsCalling.MediaAgentUnsafe",!1),e.mediaAgentFactoryConfig.safeLogger=new Ae("JS.TsCalling.MediaAgent",!0),e.signalingAgentConfig.logger=new Ae("JS.TsCalling.SignalingAgent",!0)}(e,i,n),sF.build(e,i,n)},buildBaseStack(e){const t=e.telemetryContextProvider?.(),i=new Qx(t);return sF.buildBaseStack(e,i)},getVersion:()=>({build:"2024.14.01.41",ovb:"a7c1622acc37a0ab89ed93e9fad06dfff1477239"})};if("object"==typeof r.exports&&"object"==typeof n){r.exports=((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,r)||r===i||Object.defineProperty(e,r,{get:()=>t[r],enumerable:!(n=Object.getOwnPropertyDescriptor(t,r))||n.enumerable});return e})(r.exports,n)}return r.exports}))}));const f={CALL_CLIENT:{INIT_CALL_CLIENT:{message:"Failed to initialize CallClient. Please try again, if issue persists, gather browser console logs, and contact Azure Communication Services support.",code:500,subCode:4e4,resultCategories:["UnexpectedClientError"]},CREATE_CALL_AGENT:{message:"Failed to create CallAgent. Please try again, if issue persists, gather browser console logs, and contact Azure Communication Services support.",code:409,subCode:40001,resultCategories:["UnexpectedClientError"]},CREATE_TEAMS_CALL_AGENT:{message:"Failed to create TeamsCallAgent. Please try again, if issue persists, gather browser console logs, and contact Azure Communication Services support.",code:409,subCode:40002,resultCategories:["UnexpectedClientError"]},RELAY_INFO:{message:"Failed to create a URL object with the ICE server URL provided.",code:400,subCode:40003,resultCategories:["ExpectedError"]},RELAY_UNRECOGNIZED_SCHEMA:{message:"The ICE server url must contain 'turn', 'turns', or 'stun'.",code:400,subCode:40004,resultCategories:["ExpectedError"]},PROXY_SHORT_URL:{message:"Failed setup proxy, the url is too short",code:400,subCode:40005,resultCategories:["ExpectedError"]},PROXY_PROTOCOL:{message:"Failed setup proxy, the protocol is not https or http",code:400,subCode:40006,resultCategories:["ExpectedError"]},SETUP_PROXY:{message:"Failed to create a URL object with the proxy URL provided.",code:400,subCode:40007,resultCategories:["ExpectedError"]},ONE_CALL_AGENT_PER_CALL_CLIENT:{message:"CallClient instance can support only one CallAgent or TeamsCallAgent create new CallClient instance to create new CallAgent or TeamsCallAgent",code:400,subCode:40008,resultCategories:["ExpectedError"]},EMERGENCY_CODE_TOO_LONG:{message:"EmergencyCountryCode is invalid, max length is 10",code:400,subCode:40009,resultCategories:["ExpectedError"]}},CALL_STACK:{BAD_PROTOCOL:{message:"ACS Web Calling SDK must be used through https, file:, or localhost",code:400,subCode:40100,resultCategories:["ExpectedError"]},BASE_STACK_INIT_TIMEOUT:{message:"Failed to create CallAgent, timeout during initialization of the calling base stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:408,subCode:40101,resultCategories:["UnexpectedClientError"]},BASE_STACK_INIT_FAILED:{message:"Failed to create CallAgent, failure during initialization of the calling base stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40102,resultCategories:["UnexpectedClientError"]},USER_STACK_NO_BASE_STACK:{message:"Failed to create CallAgent, failure to initialize calling user stack because calling base stack failed to create. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40103,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_TIMEOUT:{message:"Failed to create CallAgent, timeout during initialization of the calling user stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:408,subCode:40104,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_FAILED:{message:"Failed to create CallAgent, failure during initialization of the calling user stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40105,resultCategories:["UnexpectedClientError"]},PARSE_CONFIG:{message:"Failed to set configurations for the calling stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40106,resultCategories:["UnexpectedClientError"]},SET_STACK_CONFIG:{message:"Failed to set user configurations for calling stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40107,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager due to internal call stack undefined. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40108,resultCategories:["UnexpectedClientError"]},SET_STACK_PARAMS:{message:"Failed to set configuration parameters for the calling stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40109,resultCategories:["UnexpectedClientError"]},FOUND_UNDEFINED_CONFIGS:{message:"Fetched undefined configurations for the calling stack. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40110,resultCategories:["UnexpectedClientError"]},SIGNALING_SERVICE_CREATE_FAIL:{message:"Failed to connect to Azure Communication Services infrastructure. Please try again and check the browser's network requests. If the requests keep failing, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40111,resultCategories:["UnexpectedClientError"]},SIGNALING_INIT_FAIL:{message:"Failed to initialize connection to Azure Communication Services infrastructure. Please try again and check the browser's network requests. If the requests keep failing, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40112,resultCategories:["UnexpectedClientError"]},SIGNALING_SERVICE_ALREADY_INITIALIZED:{message:"Already connected to Azure Communication Services infrastructure. Please try again, if issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:40113,resultCategories:["ExpectedError"]},SIGNALING_SERVICE_CREATE_TIMEOUT:{message:"Failed to connect to Azure Communication Services infrastructure, timeout during initialization. Please try again and check the browser's network requests. If the requests keep failing, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:408,subCode:40114,resultCategories:["UnexpectedClientError"]},SIGNALING_UNINITIALIZED:{message:"Failed to create CallAgent, unable to initialize connection to Azure Communication Services infrastructure. Please try again and check the browser's network requests. If the requests keep failing, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:412,subCode:40115,resultCategories:["UnexpectedClientError"]}},CALL_AGENT:{PROXY_CUSTOM_TURN_FORBIDDEN:{message:"Using proxy or custom TURN for calls involving Teams is disabled",code:403,subCode:40200,resultCategories:["ExpectedError"]},PARSE_ACCESSTOKEN:{message:"Failed to parse AccessToken",code:500,subCode:40201,resultCategories:["UnexpectedClientError"]},CANT_CALL_YOURSELF:{message:"Call to yourself is not supported.",code:400,subCode:40202,resultCategories:["ExpectedError"]},ACS_ALREADY_DISPOSED:{message:"Call Agent is already disposed",code:409,subCode:40203,resultCategories:["ExpectedError"]},CTE_ALREADY_DISPOSED:{message:"Teams Call Agent is already disposed",code:409,subCode:40204,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to CallAgent event, unknown event name.",code:422,subCode:40205,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from CallAgent event, unknown event name.",code:422,subCode:40206,resultCategories:["ExpectedError"]},MESH_DEVICETYPE_V2:{message:"Device type must be msft-acs-mesh-deviceType-v2 to join immersive call",code:400,subCode:40207,resultCategories:["ExpectedError"]},STACK_NOT_INIT:{message:"Failed to start or join call, call stack did not initialize",code:500,subCode:40208,resultCategories:["UnexpectedClientError"]},INVALID_JOIN_LOCATOR:{message:"Invalid join locator specified.",code:400,subCode:40209,resultCategories:["ExpectedError"]},INVALID_MEETING_LINK:{message:"The provided Teams meeting link is invalid.",code:400,subCode:40210,resultCategories:["ExpectedError"]},INVALID_TFL_MEETING_LINK:{message:"The provided Teams For Life meeting link is invalid.",code:400,subCode:40211,resultCategories:["ExpectedError"]},GROUPCALL_THREADID:{message:"Starting a group call must include thread ID in StartTeamsGroupCallOptions.",code:400,subCode:40212,resultCategories:["ExpectedError"]},ONE_TO_ONE_THREADID:{message:"Starting a one to one with thread ID is invalid.",code:400,subCode:40213,resultCategories:["ExpectedError"]},CTE_DISPLAY_NAME:{message:"Display name is not allowed to be set for Teams users.",code:400,subCode:40214,resultCategories:["ExpectedError"]},DISPLAY_NAME_TOO_LONG:{message:"Display name is too long.",code:400,subCode:40215,resultCategories:["ExpectedError"]},INIT_FAIL:{message:"Failed to create CallAgent. Please try again, if issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:40216,resultCategories:["UnexpectedClientError"]},GET_TOKEN_BEFORE_INIT:{message:"Attempted to get AccessToken before initialization",code:422,subCode:40217,resultCategories:["UnexpectedClientError"]},INVALID_PUSH_NOTIFICAITON_DATA:{message:"Invalid push notification data provided. No 'incomingCallContext' key found in the PushNotificatitonData.",code:400,subCode:40218,resultCategories:["ExpectedError"]},PUSH_NOTIFICAITON_FAIL:{message:"Failed to handle push notification",code:500,subCode:40219,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_PAYLOAD_TOO_MANY_KEYS:{message:"Incoming Call push notification payload provided has too many keys. Only 'incomingCallContext' key is expected in the PushNotificatitonData.",code:400,subCode:40220,resultCategories:["ExpectedError"]},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED:{message:"Invalid push notification data provided. No 'incomingCallContext' key found in the PushNotificatitonData.",code:400,subCode:40221,resultCategories:["ExpectedError"]},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD:{message:"The decoded 'incomingCallContext' data is invalid.",code:400,subCode:40222,resultCategories:["ExpectedError"]},INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED:{message:"Incoming Call is already being processed",code:400,subCode:40223,resultCategories:["ExpectedError"]},INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS:{message:"Failed to handle Incoming Call push notification",code:500,subCode:40224,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_CALL_MISSED:{message:"Missed call",code:400,subCode:40225,resultCategories:["ExpectedError"]},USERIDS_MUST_BE_OBJECTS:{message:"AssertIsObject failed. : userIds must be object",code:400,subCode:40226,resultCategories:["ExpectedError"]},USERIDS_CANNOT_BE_NULL:{message:"AssertNotNull failed. : userIds cannot be null",code:400,subCode:40227,resultCategories:["ExpectedError"]},ACS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create CallAgent, an instance of CallAgent associated with this identity already exists. Please dispose the existing CallAgent, or create a new one with a different identity.",code:409,subCode:40228,resultCategories:["ExpectedError"]},ACS_CALLAGENT_TOKEN_ONLY:{message:"CallAgent must be created only with ACS token",code:403,subCode:40229,resultCategories:["ExpectedError"]},TEAMS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create TeamsCallAgent, an instance of TeamsCallAgent associated with this identity already exists. Please dispose the existing TeamsCallAgent before creating a new one.",code:409,subCode:40230,resultCategories:["ExpectedError"]},TEAMS_CALLAGENT_TOKEN_ONLY:{message:"TeamsCallAgent must be created only with Teams token",code:403,subCode:40231,resultCategories:["ExpectedError"]},FAILED_TO_GET_TOKEN:{message:"Failed to get token",code:409,subCode:40232,resultCategories:["UnexpectedClientError"]},REFRESHED_TOKEN_INVALID_USERID:{message:"Refreshed AccessToken User Id doesnt match initial User Id.",code:400,subCode:40233,resultCategories:["ExpectedError"]},REFRESHED_TOKEN_RETRIES:{message:"Access token is expired and failed to fetch a valid one after retries.",code:400,subCode:40234,resultCategories:["ExpectedError"]},ACCESSTOKEN_EXPIRED:{message:"AccessToken expired",code:401,subCode:40235,resultCategories:["ExpectedError"]},ACTION_BLOCKED:{message:"Action not allowed.",code:403,subCode:40236,resultCategories:["ExpectedError"]},HANGUP_FAILED:{message:"Failed to hangup call",code:500,subCode:40237,resultCategories:["UnexpectedServerError"]},UNSUPPORTED_TFL_MEETING_JOIN:{message:"Joining a Teams for life meeting is not supported",code:400,subCode:40238,resultCategories:["ExpectedError"],webConfig:{use:!0}}},DEVICE_MANAGER:{GET_MEDIA_STREAM_TRACK:{message:"Failed to get raw device stream track",code:500,subCode:40600,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM_DEVICE_UNAVAILABLE:{message:"Failed to get raw device stream track, make sure there is available device",code:412,subCode:40601,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager.",code:500,subCode:40602,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to DeviceManager event, unknown event name.",code:422,subCode:40603,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from DeviceManager event, unknown event name.",code:422,subCode:40604,resultCategories:["ExpectedError"]},ACCESS_DM:{message:"Unable to access device manager",code:500,subCode:40605,resultCategories:["UnexpectedClientError"]},SPEAKER_ENUMERATION_UNSUPPORTED:{message:"Failed to enumerate speakers, it is not supported to enumerate/select speakers on Android Chrome, iOS Safari, nor MacOS Safari.",code:405,subCode:40606,resultCategories:["ExpectedError"]},SELECT_MICROPHONE_TIMEOUT:{message:"Microphone selection timed out.",code:408,subCode:40607,resultCategories:["UnexpectedClientError"]},SELECT_MICROPHONE_FAIL:{message:"There was an issue with selecting the microphone",code:500,subCode:40608,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_TIMEOUT:{message:"Speaker selection timed out.",code:408,subCode:40609,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_FAIL:{message:"There was an issue with selecting the speaker",code:500,subCode:40610,resultCategories:["UnexpectedClientError"]},SPEAKER_SELECTION_UNSUPPORTED:{message:"This device does not support speaker selection.",code:405,subCode:40611,resultCategories:["ExpectedError"]},ONE_PERMISSION_ATLEAST:{message:"At least one permission must be requested",code:400,subCode:40612,resultCategories:["ExpectedError"]},PERMISSION_NOT_GRANTED_OR_FAILED:{message:"Failed to obtain permission to use microphone and/or camera, it was denied or it failed. Please ensure to allow the permissions in the browser's setttings and in the OS setttings.",code:400,subCode:40613,resultCategories:["ExpectedError"]},ADP_FAIL:{message:"Failed to ask for device permissions Please ensure to allow the permissions in the browser's setttings and in the OS setttings and try again. If issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:40614,resultCategories:["UnexpectedClientError"]},INVALID_DEVICE:{message:"Invalid AudioDeviceInfo object passed in. Ensure it has an Id.",code:400,subCode:40615,resultCategories:["ExpectedError"]},DEVICE_NOT_SELECTABLE:{message:"The device is not selectable",code:400,subCode:40616,resultCategories:["ExpectedError"]}},CALL:{OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL:{message:"Attempted invalid operation during Emergency Call.",code:500,subCode:41e3,resultCategories:["ExpectedError"]},OPERATION_FAILED:{message:"{0} failed",code:500,subCode:41001,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED:{message:"Unable to get remote audio stream, getMediaStream returned undefined",code:500,subCode:41002,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR:{message:"Unable to get remote audio stream, getMediaStream returned error",code:500,subCode:41003,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED:{message:"Getting raw audio media stream is currently disabled by Azure Communication Services.",code:409,subCode:41004,resultCategories:["ExpectedError"]},ACCEPT_INCOMING_CALL:{message:"Failed to accept the Incoming Call",code:500,subCode:41005,resultCategories:["UnexpectedClientError"]},ACCEPT_NOT_RINGING:{message:"Failed to accept the incoming call, it is not in the Ringing state. Subcscribe to CallAgent's 'incomingCall' event to accept the incoming call.",code:400,subCode:41006,resultCategories:["ExpectedError"]},REJECT_NOT_RINGING:{message:"Failed to reject the incoming call, it is not in the Ringing state. Subcscribe to CallAgent's 'incomingCall' event to reject the incoming call.",code:400,subCode:41007,resultCategories:["ExpectedError"]},LOCAL_AUDIO_GET_MEDIA_STREAM:{message:"Failed to get raw stream from local audio stream",code:500,subCode:41008,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_SET_MEDIA_STREAM:{message:"Failed to set raw input audio stream",code:500,subCode:41009,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNSET_MEDIA_STREAM:{message:"Failed to unset raw input audio stream",code:500,subCode:41010,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNDEFINED_STACK:{message:"Failed to process audio because the calling stack is undefined. Please collect browser console logs and contact Azure Communication Services support.",code:500,subCode:41011,resultCategories:["UnexpectedClientError"]},REMOVE_LOCAL_VIDEO_ON_BAD_UFD:{message:"Removing local video stream due to video fail UFD being raised before call connected. Please ensure to allow video permissions in the browser's setttings and in the OS setttings, and ensure the camera device is not being used by another process.",code:409,subCode:41012,resultCategories:["UnexpectedClientError"]},STOP_AUDIO_ON_BAD_UFD:{message:"Failed to stop audio on microphone device not functioning or capture mute event {0} with value {1}",code:400,subCode:41013,resultCategories:["UnexpectedClientError"]},INSTANTIATE_CALL:{message:"Failed to instantiate the Call",code:500,subCode:41014,resultCategories:["UnexpectedClientError"]},MIC_MUTE:{message:"Failed to mute microphone. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41015,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE:{message:"Failed to unmute microphone. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:400,subCode:41016,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE_AND_STARTAUDIO:{message:"Failed to recover the microphone audio after bad microphone UFD recovered. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:410,subCode:41017,resultCategories:["UnexpectedClientError"]},MUTE_ALL_PARTICIPANTS_DISABLED:{message:"Mute other participants is currently disabled by ACS service.",code:403,subCode:41018,resultCategories:["ExpectedError"]},MUTE_ALL_PARTICIPANTS:{message:"Failed to mute all remote participants",code:500,subCode:41019,resultCategories:["UnexpectedClientError"]},MUTE_INCOMING_AUDIO:{message:"Failed to mute incoming audio",code:500,subCode:41020,resultCategories:["UnexpectedClientError"]},UNMUTE_INCOMING_AUDIO:{message:"Failed to unmute incoming audio",code:500,subCode:41021,resultCategories:["UnexpectedClientError"]},DTMF_TONE:{message:"Failed to send DTMF tone",code:400,subCode:41022,resultCategories:["UnexpectedClientError"]},INVALID_DTMF_TONE:{message:"Invalid value passed to DtfmTone",code:422,subCode:41023,resultCategories:["ExpectedError"]},START_AUDIO_BEFORE_VIDEO:{message:"Failed to start audio before starting video",code:500,subCode:41024,resultCategories:["UnexpectedClientError"]},STREAM_NULL:{message:"Failed to start video, LocalVideoStream instance is invalid or empty. Please pass in a LocalVideoStream instance.",code:400,subCode:41025,resultCategories:["ExpectedError"]},STREAM_IS_NOT_LVS:{message:"Failed to start video, localVideoStream is not an instance of LocalVideoStream",code:400,subCode:41026,resultCategories:["ExpectedError"]},VIDEO_ALREADY_ON:{message:"Failed to start video, video is already started.",code:400,subCode:41027,resultCategories:["ExpectedError"]},VIDEO_SET_MEDIA_STREAM:{message:"Failed to set media stream",code:500,subCode:41028,resultCategories:["UnexpectedClientError"]},START_VIDEO:{message:"Failed to start video",code:500,subCode:41029,resultCategories:["UnexpectedClientError"]},VIDEO_ALREADY_OFF:{message:"Failed to stop video, video is already stopped.",code:400,subCode:41030,resultCategories:["ExpectedError"]},VIDEO_UNDEFINED_STACK:{message:"Failed to start video because the calling stack is undefined. Please gether browser console logs, .HAR files, and contact Aure Communication Services support.",code:500,subCode:41031,resultCategories:["UnexpectedClientError"]},STOP_WRONG_STREAM:{message:"Failed to stop video, invalid argument. LocalVideoStream used as an input is currently not being sent.",code:400,subCode:41032,resultCategories:["ExpectedError"]},HOLD_CALL:{message:"Failed to hold the call. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41033,resultCategories:["UnexpectedClientError"]},RESUME_CALL:{message:"Failed to resume the call.Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41034,resultCategories:["UnexpectedClientError"]},SS_ALREADY_ON:{message:"Failed to start screen share, screen share is already started.",code:400,subCode:41035,resultCategories:["ExpectedError"]},SS_RAW_STREAM_IS_NOT_LVS:{message:"Failed to start raw screen sharing, localVideoStream is not an instance of LocalVideoStream",code:400,subCode:41036,resultCategories:["ExpectedError"]},SS_RAW_STREAM_UNDEFINED:{message:"Unable to get media stream from local video stream for raw media screen sharing. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41037,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_SET:{message:"Failed to set raw media stream for screen sharing. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:422,subCode:41038,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_GET:{message:"Failed to get raw screen sharing stream. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:422,subCode:41039,resultCategories:["UnexpectedClientError"]},START_SS:{message:"Failed to start screen sharing",code:500,subCode:41040,resultCategories:["UnexpectedClientError"]},SS_ALREADY_OFF:{message:"Failed to stop screen share, screen share is already stopped.",code:400,subCode:41041,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to Call event, unknown event name.",code:422,subCode:41042,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from Call event, unknown event name.",code:422,subCode:41043,resultCategories:["ExpectedError"]},ONLY_SINGLE_VIDEO_STREAM:{message:"Only single LocalVideoStream is supported currently",code:400,subCode:41044,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LVS:{message:"Stream is not an instance of LocalVideoStream",code:400,subCode:41045,resultCategories:["ExpectedError"]},ONLY_SINGLE_AUDIO_STREAM:{message:"Only single LocalAudioStream is supported currently",code:400,subCode:41046,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LAS:{message:"Stream is not an instance of LocalAudioStream",code:400,subCode:41047,resultCategories:["ExpectedError"]},VIDEO_FAILED_TO_START:{message:"Failed to start video during call setup process. Please ensure to allow video permissions in the browser's setttings and in the OS setttings, and ensure the camera device is not being used by another process.",code:410,subCode:41048,resultCategories:["UnexpectedClientError"]},AUDIO_FAILED_TO_START:{message:"Failed to start audio during call setup process. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:400,subCode:41049,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_FORCE_ISAVAILABLE:{message:"Failed to force isAvailable flag to false during large meeting",code:500,subCode:41050,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_DISPOSE_VIEW:{message:"Failed to dispose view in large meeting",code:500,subCode:41051,resultCategories:["UnexpectedClientError"]},ADD_UNKNOWN:{message:"Not able to add unkown participant.",code:400,subCode:41052,resultCategories:["ExpectedError"]},PARTICIPANT_ALREADY_IN_CALL:{message:"{0} is already in the call",code:400,subCode:41053,resultCategories:["ExpectedError"]},PARTICIPANT_NOT_IN_CALL:{message:"Failed to remove the specified participant. The participant is not in the call.",code:400,subCode:41054,resultCategories:["ExpectedError"]},CTE_ADDPARTICIPANT_NO_THREAD_ID:{message:"Add participant failed: thread ID is missing in options.",code:400,subCode:41055,resultCategories:["ExpectedError"]},CTE_VOICE_NOT_ENABLED:{message:"Failed to start or join to the call, Teams Enterprise voice policy is not enabled for this Azure Communication Services resource. Follow the tutorial online to enable it.",code:412,subCode:41056,resultCategories:["ExpectedError"]},SERVER_CALL_ID:{message:"Failed to get server call Id",code:500,subCode:41057,resultCategories:["UnexpectedClientError"]},VOLUME_TRACK:{message:"Failed to get the MediaStream to initialize the Volume indicator. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41058,resultCategories:["UnexpectedClientError"]},VOLUME_INIT:{message:"Failed to setup volume calcualtor using AudioContext, please retry getVolumeindicator on a working audio stream with exponential backoff",code:500,subCode:41059,resultCategories:["UnexpectedClientError"]},VOLUME_EVENT_SUBSCRIBE:{message:"Not able to subscribe to Volume Indicator event, unknown event name.",code:400,subCode:41060,resultCategories:["ExpectedError"]},VOLUME_EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from Volume Indicator event, unknown event name.",code:400,subCode:41061,resultCategories:["ExpectedError"]},VOLUME_GET:{message:"Failed to setup volume calculator, please retry after exponential backoff",code:500,subCode:41062,resultCategories:["UnexpectedClientError"]},GET_SERVER_CALL_ID:{message:"Failed to get serverCallId, serverCallId is empty",code:404,subCode:41063,resultCategories:["UnexpectedClientError"]},MEDIA_CONSTRAINTS_DISABLED:{message:"Setting call constraint is currently disabled by ACS service.",code:409,subCode:41064,resultCategories:["ExpectedError"]},SET_CONSTRAINTS_START_OR_ACCEPT:{message:"Error setting call constraints at call setup. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41065,resultCategories:["UnexpectedClientError"]},SET_CONSTRAINTS_MID_CALL:{message:"Error setting call constraints during mid-call",code:500,subCode:41066,resultCategories:["UnexpectedClientError"]},SET_CONSTRAINTS:{message:"Error settting video constraints during call settup or mid-call. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:41067,resultCategories:["UnexpectedClientError"]},ACCEPT_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call accept",code:500,subCode:41068,resultCategories:["UnexpectedClientError"]},CALLSTART_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call start",code:500,subCode:41069,resultCategories:["UnexpectedClientError"]},SET_VIDEO_CONSTRAINTS:{message:"Failed to set call constraints during mid call",code:500,subCode:41070,resultCategories:["UnexpectedClientError"]},START_SS_CALL_NOT_CONNECTED:{message:"Failed to start screen share, call is not in Connected state. Subscribe to the Call's 'statteChanged' event to know when the call is connected.",code:412,subCode:41071,resultCategories:["ExpectedError"]},STOP_SS_CALL_NOT_CONNECTED:{message:"Failed to stop screen sharing. Call must be in connected state",code:412,subCode:41072,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_DISABLED:{message:"Failed to get or set custom MediaStream, this functionality is currently disabled by Azure Communication Services.",code:412,subCode:41073,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC:{message:"The raw media stream function is currently not available",code:500,subCode:41074,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA:{message:"Failed to start raw screen sharing, localVideoStream doesn't contain a raw media stream",code:400,subCode:41075,resultCategories:["ExpectedError"]},START_AUDIO_STREAM_FAILED:{message:"Failed to start audio stream",code:500,subCode:41076,resultCategories:["UnexpectedClientError"]},STOP_VIDEO_FAILED:{message:"Failed to stop video",code:500,subCode:41077,resultCategories:["UnexpectedClientError"]},INCOMING_CALL_ALREADY_UNPLACED:{message:"Incoming call is already unplaced",code:400,subCode:41078,resultCategories:["ExpectedError"]},REJECT_CALL_FAILED:{message:"Failed to reject call",code:500,subCode:41079,resultCategories:["UnexpectedServerError"]},START_AUDIO_FAIL_TO_START_LOCAL_DEVICE:{message:"Failed to start local audio device",code:400,subCode:41080,resultCategories:["UnexpectedClientError"]},START_AUDIO_SELECT_VIRTUAL_DEVICE:{message:"Failed to Select Virtual Device.",code:400,subCode:41081,resultCategories:["UnexpectedClientError"]},START_AUDIO_UNSELECT_VIRTUAL_DEVICE:{message:"Failed to Unselect Virtual Device.",code:400,subCode:41082,resultCategories:["UnexpectedClientError"]},START_AUDIO_LAS_NOT_RAW_MEDIA:{message:"Failed to start raw audio, localAudioStream doesn't contain a raw media stream. To start raw audio, the LocalAudioStream passed in, must be constructed with a MediaStream object.",code:400,subCode:41083,resultCategories:["ExpectedError"]},STOP_AUDIO_LAS_NOT_RAW_MEDIA:{message:"Failed to stop raw audio, localAudioStream doesn't contain a raw media stream. To stop raw audio, the current LocalAudioStream in the call must have a MediaStream as the source.",code:400,subCode:41084,resultCategories:["ExpectedError"]},TEAMS_INVALID_THREAD_ID:{message:"Thread ID is invalid.",code:400,subCode:41085,resultCategories:["ExpectedError"]}},LOBBY:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to Lobby event, unknown event name.",code:422,subCode:41800,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from Lobby event, unknown event name.",code:422,subCode:41801,resultCategories:["ExpectedError"]},CONV_UNSUPPORTED:{message:"Current conversation type doesn't support lobby admit and reject",code:400,subCode:41802,resultCategories:["ExpectedError"]},ALREADY_IN_MEETING:{message:"Participant is already in the meeting.",code:400,subCode:41803,resultCategories:["ExpectedError"]},NOT_IN_LOBBY:{message:"Participant is not in the lobby.",code:400,subCode:41804,resultCategories:["ExpectedError"]},UNAUTHORIZED_ADMIT_REJECT:{message:"only Organizer, Co-organizer or Presenter can admit/reject participants from lobby",code:403,subCode:41805,resultCategories:["ExpectedError"]},ADMIT_FAILED:{message:"Failed to admit participants in the lobby",code:500,subCode:41806,resultCategories:["UnexpectedServerError"]},EMPTY_PARTICIPANT_LIST:{message:"Participant list is empty",code:400,subCode:41807,resultCategories:["ExpectedError"]},LOBBY_NOT_ENABLED:{message:"Lobby is not enabled for this meeting",code:400,subCode:41808,resultCategories:["ExpectedError"]},REJECT_FAILED:{message:"Failed to reject participants from the lobby",code:500,subCode:41809,resultCategories:["UnexpectedServerError"]}},CTE_MID_TIER_POLICY_SERVICE:{TEAMS_USER_ID_NOT_PROVIDED:{message:"Failed to fetch Teams user policies and settings cannot proceed, because teams user Id was not found in the AccessToken.",code:400,subCode:41900,resultCategories:["ExpectedError"]},FETCH_POLICY:{message:"Error Fetching Teams user policy from ACS MiddleTier Service",code:500,subCode:41901,resultCategories:["UnexpectedServerError"]},DERIVE_EMERGENCY_POLICY:{message:"Unable to derive emergency policy from ACS MiddleTier Service response",code:500,subCode:41902,resultCategories:["UnexpectedServerError"]},TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch Teams calling policy from ACS MiddleTier Service response. Please try again, if the issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:41903,resultCategories:["UnexpectedServerError"]},TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch Teams meeting policy from ACS MiddleTier Service response. Please try again, if the issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:41904,resultCategories:["UnexpectedServerError"]},TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED:{message:"Unable to fetch feature types from ACS MiddleTier Service response. Please try again, if the issue persists, gather browser console logs, .HAR file, and contact Azure Communication Services support.",code:500,subCode:41905,resultCategories:["UnexpectedServerError"]},CREATETHREAD_FAILED:{message:"Unable to create thread for the Teams User groupcall from ACS MiddleTier Service response",code:500,subCode:41906,resultCategories:["UnexpectedServerError"]},ADD_PARTICIPANTS_TO_THREAD_FAILED:{message:"Unable to add particpant for the thread for Teams groupcall from ACS MiddleTier Service",code:500,subCode:41907,resultCategories:["UnexpectedServerError"]}},REMOTE_PARTICIPANT:{MUTE_PARTICIPANT_DISABLED:{message:"Mute other participants is disabled by ACS service.",code:403,subCode:42e3,resultCategories:["ExpectedError"]},MUTE_PARTICIPANT_FAILED:{message:"Failed to mute specific participant",code:500,subCode:42001,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to RemoteParticipant event, unknown event name.",code:422,subCode:42002,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from RemoteParticipant event, unknown event name.",code:422,subCode:42003,resultCategories:["ExpectedError"]}},LOCAL_VIDEO_STREAM:{SOURCE_UNAVAILABLE:{message:"Failed to start video, video device is being used by another process/application. Stop your camera from being used in the other process/application and try again.",code:412,subCode:43e3,resultCategories:["ExpectedError"]},PERMISSION_DENIED:{message:"Failed to start video, permission was not granted to use selected video device. Ensure video device permissions are allowed in the browser's settings and in the system's setttings.",code:403,subCode:43001,resultCategories:["ExpectedError"]},UNKNOWN:{message:"Failed to start video, unknown error. Please try again. If the issue persists, contact Azure Communication Services support.",code:500,subCode:43002,resultCategories:["UnexpectedClientError"]},WRONG_STREAM_TYPE:{message:"Failed to create local video stream, source was not of type VideoDeviceInfo or MediaStream",code:400,subCode:43003,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to switch video device, invalid input. Input must be of a VideoDeviceInfo type.",code:400,subCode:43004,resultCategories:["ExpectedError"]},SWITCH_SAME_SOURCE:{message:"Failed to switch video device, unable to switch to the same video device, it's already selected.",code:400,subCode:43005,resultCategories:["ExpectedError"]},CANT_GET_DEVICE_TYPE:{message:"Unable to get device type",code:500,subCode:43006,resultCategories:["UnexpectedClientError"]},VIDEO_GET_MEDIA_STREAM:{message:"Failed to get raw video stream. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:43007,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to set media stream source is not MediaStream",code:400,subCode:43008,resultCategories:["ExpectedError"]},SET_MEDIA_STREAM_UNDEFINED_FUNC:{message:"Failed to set raw video stream. Found undefined function. Gather browser console logs and contact Azure Communication Services support.",code:500,subCode:43009,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM:{message:"Failed to set raw video stream. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:43010,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to LocalVideoStream event, unknown event name.",code:422,subCode:43011,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from LocalVideoStream event, unknown event name.",code:422,subCode:43012,resultCategories:["ExpectedError"]},DEVICES_NOT_FOUND:{message:"Failed to start video, no video devices found. Ensure video devices are plugged in and enabled in the system settings.",code:412,subCode:43013,resultCategories:["ExpectedError"]},MEDIA_STREAM_REQUEST_ERROR:{message:"Failed to start video, error requesting media stream. Please try again, if issue persists, contact Azure Communication Services support.",code:412,subCode:43014,resultCategories:["UnexpectedClientError"]},MEDIA_STREAM_REQUEST_TIMEDOUT:{message:"Failed to start video, media stream request timed out. PLease allow permission on the browser's prompt to access the camera and try again.",code:412,subCode:43015,resultCategories:["ExpectedError"]},PERMISSION_DENIED_BY_SYSTEM:{message:"Failed to start video, permissions denied by system. Ensure video device permissions are allowed in the browser's settings and in the system's setttings.",code:412,subCode:43016,resultCategories:["ExpectedError"]},UNSUPPORTED_STREAM:{message:"Failed to start video, unsupported stream. Please try again, if issue persists, contact Azure Communication Services support.",code:412,subCode:43017,resultCategories:["UnexpectedClientError"]},CONSTRAINT_NOT_SATISFIED:{message:"Failed to start video, failed to set constraints. Please try again, if issue persists, contact Azure Communication Services support.",code:412,subCode:43018,resultCategories:["UnexpectedClientError"]},NO_DEVICE_SELECTED:{message:"Failed to start video, no device selected. Please ensure to pass a LocalVideoStream constructed with a VideoDeviceInfo and try again. If issue persists, contact Azure Communication Services support.",code:412,subCode:43019,resultCategories:["UnexpectedClientError"]}},REMOTE_VIDEO_STREAM:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to RemoteVideoStream event, unknown event name.",code:422,subCode:43100,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from RemoteVideoStream event, unknown event name.",code:422,subCode:43101,resultCategories:["ExpectedError"]},GET_RAW_MEDIA_STREAM:{message:"Not able to get media stream",code:500,subCode:43102,resultCategories:["UnexpectedClientError"]},RAWMEDIA_LVS_NOT_AVAILABLE:{message:"The remote video stream is currently not available, subscribe to the stream's isAvailable property to get notified when it is ready to get the raw media stream.",code:400,subCode:43103,resultCategories:["ExpectedError"]},SUBSCRIBE_MEDIA_STREAM_TIMEOUT:{message:"Failed to subscribe to media stream, timeout",code:408,subCode:43104,resultCategories:["UnexpectedClientError"]},GET_TRACK:{message:"Failed to get media stream",code:500,subCode:43105,resultCategories:["UnexpectedClientError"]},TRACK_UNMUTED_TIMEOUT:{message:"Failed to subscribe to media stream, muted",code:408,subCode:43106,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM:{message:"Failed to get raw media stream",code:500,subCode:43107,resultCategories:["UnexpectedClientError"]}},VIEW:{ISAVAILABLE_FALSE:{message:"Failed to render video stream, this stream is not available. Subscribe to the stream's isAvailable property to get notified when the remote participant has their video on and the stream is available for rendering.",code:412,subCode:43200,resultCategories:["ExpectedError"]},START_ALREADY_DISPOSED:{message:"Failed to start stream, already disposed",code:405,subCode:43201,resultCategories:["ExpectedError"]},STREAM_BECAME_UNAVAILABLE:{message:"Failed to render video stream, this stream is not longer available. Remote participant turned their video off.",code:404,subCode:43202,resultCategories:["ExpectedError"]},TIMEOUT:{message:"Failed to render video stream, rendering timed out while waiting for video frames. Please try again, if issue persists, contact Azure Communication Services support.",code:408,subCode:43203,resultCategories:["UnexpectedClientError"]},SUBSCRIBE:{message:"Failed to render video stream, failed to subscribe to video on the Azure Communication Services infrastructure. Please try again, if issue persists, contact Azure Communication Services support.",code:500,subCode:43204,resultCategories:["UnexpectedClientError"]},START:{message:"Failed to start stream, internal error",code:500,subCode:43205,resultCategories:["UnexpectedClientError"]},SCALING_MODE:{message:"Failed to updateScalingMode, failed to update",code:500,subCode:43206,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_VIEW_DISPOSED:{message:"Failed to start stream, disposing stream because participant is not a dominant speaker in the large meeting",code:405,subCode:43207,resultCategories:["ExpectedError"]},REMOTE_VIDEO_STREAM_DISPOSED:{message:"Failed to start stream, disposing stream because remote video stream is disposing",code:405,subCode:43208,resultCategories:["ExpectedError"]},APP_VIEW_DISPOSED:{message:"Failed to render video stream, VideoStreamRenderer was disposed during initialization process.",code:405,subCode:43209,resultCategories:["ExpectedError"]},RENDERER_DISPOSE_ALREADY_DISPOSED:{message:"Failed to dispose VideoStreamRenderer, it is already disposed.",code:400,subCode:43210,resultCategories:["ExpectedError"]},REMOTE_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose remote renderer",code:500,subCode:43211,resultCategories:["UnexpectedClientError"]},VIEW_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRendererView, videoStream must be either LocalVideoStream or RemoteVideoStream type",code:400,subCode:43212,resultCategories:["ExpectedError"]},VIEW_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is disposed",code:400,subCode:43213,resultCategories:["ExpectedError"]},RENDER_FAIL_STREAM_DISPOSED:{message:"Failed to render, stream disposed",code:400,subCode:43214,resultCategories:["ExpectedError"]},SCALING_MODE_DISPOSED:{message:"Failed to updateScalingMode, VideoStreamRendererView is disposed",code:400,subCode:43215,resultCategories:["ExpectedError"]},SCALING_MODE_WRONG_VAL:{message:"Failed to updateScalingMode, wrong scalingMode value",code:400,subCode:43216,resultCategories:["ExpectedError"]},DISPOSE_FAIL:{message:"Failed to dispose view",code:500,subCode:43217,resultCategories:["UnexpectedClientError"]},RENDERER_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRenderer, videoStream must be either LocalVideoStream or RemoteVideoStreamCommon type",code:400,subCode:43218,resultCategories:["ExpectedError"]},RENDERER_DISPOSED:{message:"Failed to create view, VideoStreamRenderer is disposed",code:400,subCode:43219,resultCategories:["ExpectedError"]},MAX_NUM_OF_VIEWS_REACHED:{message:"Failed to create view, maximum number of active RemoteVideoStream views has been reached. You can dispose of a previous one in order to create new one.",code:400,subCode:43220,resultCategories:["ExpectedError"]},CREATE_VIEW_FAILED:{message:"Failed to create view",code:500,subCode:43221,resultCategories:["UnexpectedClientError"]},RENDERER_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is already disposed",code:400,subCode:43222,resultCategories:["ExpectedError"]},UNKNOWN_STREAM_TYPE:{message:"Unknown stream type",code:400,subCode:43223,resultCategories:["ExpectedError"]},LOCAL_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose local renderer",code:500,subCode:43224,resultCategories:["UnexpectedClientError"]}},LOCAL_AUDIO_STREAM:{WRONG_STREAM_TYPE:{message:"Failed to create local audio stream, source is not of type AudioDeviceInfo or MediaStream",code:400,subCode:43600,resultCategories:["ExpectedError"]},SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:400,subCode:43601,resultCategories:["ExpectedError"]},GET_MEDIA_STREAM:{message:"Failed to get media stream source is not AudioDeviceInfo or MediaStream",code:500,subCode:43602,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to switch stream on local audio, source is not of type MediaStream",code:400,subCode:43603,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:400,subCode:43604,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to LocalAudioStream event, unknown event name.",code:422,subCode:43605,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from LocalAudioStream event, unknown event name.",code:422,subCode:43606,resultCategories:["ExpectedError"]},SWITCH_SAME_SOURCE:{message:"Failed to switch audio device, unable to switch to the same audio device, it's already selected.",code:400,subCode:43607,resultCategories:["ExpectedError"]},UNKNOWN:{message:"Failed to start audio, unknown error. Please try again. If the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:43608,resultCategories:["UnexpectedClientError"]}},REMOTE_AUDIO_STREAM:{},IDENTIFIER:{PARSE_PHONENUMBER:{message:"Unable to parse PhoneNumberIdentifier object",code:422,subCode:44e3,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_USER:{message:"Unable to parse MicrosoftTeamsUserIdentifier object",code:422,subCode:44001,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_APP:{message:"Unable to parse MicrosoftTeamsAppIdentifier object",code:422,subCode:44002,resultCategories:["ExpectedError"]},PARSE_IDENTIFIER:{message:"Unable to parse Identifier object, please check the syntax",code:422,subCode:44003,resultCategories:["ExpectedError"]},INVALID_COMM_USER:{message:"Invalid CommunicationUser identifier specified",code:422,subCode:44004,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_RAWID:{message:"Invalid MicrosoftTeamsUser rawId specified",code:422,subCode:44005,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_USERID:{message:"Invalid MicrosoftTeamsUser microsoftTeamsUserId specified",code:422,subCode:44006,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_RAWID:{message:"Invalid MicrosoftTeamsApp rawId specified",code:422,subCode:44007,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_APPID:{message:"Invalid MicrosoftTeamsApp teamsAppId specified",code:422,subCode:44008,resultCategories:["ExpectedError"]},INVALID_UNKNOWN_IDENTIFIER:{message:"Invalid identifier specified, please specify an id",code:422,subCode:44009,resultCategories:["ExpectedError"]},PARSE_INVALID_IDENTIFIER:{message:"Unable to parse Identifier object",code:422,subCode:44010,resultCategories:["ExpectedError"]},INVALID_IDENTIFIER_ARRAY:{message:"AssertIsArrayOfIdentifiers failed. : userIds must be array of CommunicationIdentifier",code:422,subCode:44011,resultCategories:["ExpectedError"]},NO_CLOUD_PREFIX_FOUND:{message:"No cloud prefix found in identity",code:409,subCode:44012,resultCategories:["ExpectedError"]}},INTERNAL:{ECS_CONFIG_EMPTY:{message:"Config is empty",code:500,subCode:44100,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MISSING_ACS:{message:"Missing ACS config key",code:500,subCode:44101,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MERGING_ERROR:{message:"Error while merging config",code:500,subCode:44102,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE:{message:"Failed to initialize telemetry",code:500,subCode:44103,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED:{message:"Failed to initialize telemetry",code:500,subCode:44104,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE:{message:"Failed to create and initialize telemetry logger for tenant. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:44105,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_FLUSH:{message:"Failed to flush telemetry",code:500,subCode:44106,resultCategories:["UnexpectedClientError"]},TELEMETRY_LOGGER_INIT_FAIL:{message:"Failed to initialize telemetry logger",code:500,subCode:44107,resultCategories:["UnexpectedClientError"]},NO_TOKEN_PROVIDED:{message:"No CommunicationTokenCredential provided",code:401,subCode:44108,resultCategories:["ExpectedError"]},EMPTY_TOKEN:{message:"AccessToken is empty",code:401,subCode:44109,resultCategories:["ExpectedError"]},GET_TOKEN:{message:"Failed to get AccessToken",code:401,subCode:44110,resultCategories:["UnexpectedClientError"]},TOKEN_PAYLOAD_UNDEFINED:{message:"Invalid token",code:401,subCode:44111,resultCategories:["ExpectedError"]},TOKEN_UNDEFINED:{message:"Failed to parse AccessToken",code:401,subCode:44112,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE:{message:"AccessToken does not contain 'voip' or 'voip.join' scope",code:401,subCode:44113,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE_FORMAT:{message:"Wrong AccessToken scope format. Scope is expected to be a string that contains 'voip'",code:401,subCode:44114,resultCategories:["ExpectedError"]},RESOURCE_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS resource Id",code:401,subCode:44115,resultCategories:["ExpectedError"]},USERID_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS user Id",code:401,subCode:44116,resultCategories:["ExpectedError"]},PARSE_TOKEN_FAIL:{message:"Failed to parse AccessToken",code:401,subCode:44117,resultCategories:["UnexpectedClientError"]},OPERATION_TIMEDOUT:{message:"Operation timed out",code:408,subCode:44118,resultCategories:["UnexpectedClientError"]}},FEATURES:{AUDIO_EFFECTS:{SET_ECHO_CANCELLATION:{message:"Error while trying to start or stop echo cancellation. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:45e3,resultCategories:["UnexpectedClientError"]},SET_NOISE_SUPPRESSION:{message:"Error while trying to start or stop noise suppression. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:45001,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to AudioEffects event, unknown event name.",code:400,subCode:45002,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from AudioEffects event, unknown event name.",code:400,subCode:45003,resultCategories:["ExpectedError"]},DISABLED:{message:"Setting audio effects is currently disabled by Azure Communication Services.",code:403,subCode:45004,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:400,subCode:45005,resultCategories:["ExpectedError"]},SOURCE_UNSUPPORTED:{message:"Current source is not supported",code:415,subCode:45006,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:500,subCode:45007,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:400,subCode:45008,resultCategories:["ExpectedError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:500,subCode:45009,resultCategories:["UnexpectedClientError"]},FAILED_TO_GET_DM:{message:"Internal error - DM missing",code:500,subCode:45010,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:500,subCode:45011,resultCategories:["UnexpectedClientError"]},AEC_PROVIDER_MISSING:{message:"Internal error - stack aec provider missing",code:500,subCode:45012,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:400,subCode:45013,resultCategories:["ExpectedError"]},INVALID_EFFECT_ECHO:{message:"Invalid or no echo cancellation effect provided",code:400,subCode:45014,resultCategories:["ExpectedError"]},INVALID_EFFECT_NOISE_SUPP:{message:"Invalid or no noise suppression effect provided",code:400,subCode:45015,resultCategories:["ExpectedError"]},UNSUPPORTED_EFFECT:{message:"Unsupported effect specified. Please specify a supported audio effect.",code:415,subCode:45016,resultCategories:["UnexpectedClientError"]},SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:501,subCode:45017,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT_GAINCONTROL:{message:"Invalid or no auto gain control effect provided",code:400,subCode:45018,resultCategories:["ExpectedError"]},SET_AUTO_GAIN_CONTROL:{message:"Error while trying to start or stop auto gain control. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:500,subCode:45019,resultCategories:["UnexpectedClientError"]},AUDIO_FLAGS:{message:"Error setting browser audio processing flags",code:500,subCode:45020,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting audio effects.",code:500,subCode:45021,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping audio effects.",code:500,subCode:45022,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing audio effects feature.",code:500,subCode:45023,resultCategories:["UnexpectedClientError"]}},AUDIO_ZONES:{},CALL_SURVEY:{INVALID_SURVEY:{message:"Invalid call survey. Please submit a survey options.",code:400,subCode:45100,resultCategories:["ExpectedError"]},SUBMIT_TIMEOUT:{message:"Failed to submit survery, timedout. Please try again, if issue persists, gather browser console logs and contact Azure Communication Services support.",code:408,subCode:45101,resultCategories:["UnexpectedClientError"]}},CAPABILITIES:{},CAPTIONS:{INITIALIZE:{message:"Failed to initialize Captions.",code:500,subCode:45200,resultCategories:["UnexpectedClientError"]},DISABLED:{message:"Captions feature is currently disabled by Azure Communication services.",code:412,subCode:45201,resultCategories:["ExpectedError"]},SPOKEN_LANG_UNSUPPORTED:{message:"Spoken language requested is not supported.",code:400,subCode:45202,resultCategories:["ExpectedError"]},MEETING_POLICY_DISABLED:{message:"Captions feature is disabled in meeting policy.",code:403,subCode:45203,resultCategories:["ExpectedError"]},CALLING_POLICY_DISABLED:{message:"Captions feature is disabled in calling policy.",code:403,subCode:45204,resultCategories:["ExpectedError"]},START_FAILED:{message:"Could not start captions.",code:500,subCode:45205,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_NOT_STARTED:{message:"Cannot update spoken language as captions has not started.",code:400,subCode:45206,resultCategories:["ExpectedError"]},SPOKEN_LANG_DISABLED:{message:"Set spoken language is currently disabled by Azure Communication Services.",code:412,subCode:45207,resultCategories:["ExpectedError"]},UPDATE_LANGUAGE_GET_TOKEN:{message:"Unable to update spoken language. Failed to get token.",code:401,subCode:45208,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_FAILED:{message:"Unable to update spoken language.",code:500,subCode:45209,resultCategories:["UnexpectedClientError"]},UPDATE_CAPTIONS_NOT_STARTED:{message:"Cannot update caption language as captions has not started.",code:400,subCode:45210,resultCategories:["ExpectedError"]},CAPTIONS_LANG_DISABLED:{message:"Set caption language is currently disabled by Azure Communication Services.",code:412,subCode:45211,resultCategories:["ExpectedError"]},CAPTIONS_LANG_TEAMS_LICENSE:{message:"Set caption language failed. Teams premium license is needed to use this feature.",code:401,subCode:45212,resultCategories:["ExpectedError"]},CAPTIONS_LANG_UNSUPPORTED:{message:"Caption language requested is not supported.",code:400,subCode:45213,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_GET_TOKEN:{message:"Null token",code:401,subCode:45214,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_FAILED:{message:"Unable to update caption language.",code:500,subCode:45215,resultCategories:["UnexpectedClientError"]},CTE_POLICY_FETCH_FAIL:{message:"Failed to fetch policy for Teams Captions.",code:500,subCode:45216,resultCategories:["UnexpectedClientError"]},ALREADY_ACTIVE:{message:"Captions already active",code:400,subCode:45217,resultCategories:["ExpectedError"]},STOP_NOT_ACTIVE:{message:"Captions feature is not active.",code:400,subCode:45218,resultCategories:["ExpectedError"]},ALREADY_STARTING:{message:"Operation in progress",code:400,subCode:45219,resultCategories:["ExpectedError"]},SPOKEN_LANGUAGE_ALREADY_SET:{message:"Spoken language already set",code:400,subCode:45220,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_NOT_ACTIVE:{message:"Unable to update caption language as Captions is not active.",code:400,subCode:45221,resultCategories:["ExpectedError"]},CAPTIONS_LANG_ALREADY_SET:{message:"Caption language already set.",code:400,subCode:45222,resultCategories:["ExpectedError"]},CAPTIONS_STATUS_ALREADY_SET:{message:"Captions status already set.",code:400,subCode:45223,resultCategories:["ExpectedError"]},CAPTIONS_NOT_SUPPORTED:{message:"Captions is not supported.",code:400,subCode:45224,resultCategories:["ExpectedError"]}},COMPOSED_STREAM:{},DATA_CHANNEL:{DISPOSED:{message:"DataChannel has been disposed",code:500,subCode:45300,resultCategories:["UnexpectedClientError"]},SENDER_NOT_READY:{message:"Sender is not ready",code:500,subCode:45301,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_CHANNEL_ID:{message:"No available channel id",code:500,subCode:45302,resultCategories:["UnexpectedClientError"]},INVALID_CHANNEL_ID:{message:"Invalid channel id",code:400,subCode:45303,resultCategories:["ExpectedError"]},INVALID_BITRATE_IN_KBPS:{message:"Invalid bitrateInKbps",code:400,subCode:45304,resultCategories:["ExpectedError"]},INVALID_PARTICIPANTS:{message:"Invalid participants",code:400,subCode:45305,resultCategories:["ExpectedError"]},TOO_MANY_PARTICIPANTS:{message:"Too many participants",code:400,subCode:45306,resultCategories:["ExpectedError"]},NO_VALID_PARTICIPANT:{message:"No valid participant",code:400,subCode:45307,resultCategories:["ExpectedError"]},MSG_DATA_EMPTY:{message:"Message data is empty",code:400,subCode:45308,resultCategories:["ExpectedError"]},MSG_DATA_TOO_LARGE:{message:"The size of message data is too large",code:400,subCode:45309,resultCategories:["ExpectedError"]},INVALID_MSG_LENGTH:{message:"Invalid message length",code:500,subCode:45310,resultCategories:["UnexpectedClientError"]},BUFFER_FULL:{message:"The buffer is full. Please wait and try again",code:500,subCode:45311,resultCategories:["UnexpectedClientError"]},SENDER_CLOSED:{message:"The sender has been closed",code:400,subCode:45312,resultCategories:["ExpectedError"]},NO_AVAILABLE_RELIABLE_CHANNEL:{message:"Currently there is no available reliable channel",code:500,subCode:45313,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_UNRELIABLE_CHANNEL:{message:"Currently there is no available unreliable channel",code:500,subCode:45314,resultCategories:["UnexpectedClientError"]},CHANNEL_ALREADY_ALLOCATED:{message:"Unable allocate the channel because a channel with the same channelId has already been allocated",code:500,subCode:45315,resultCategories:["UnexpectedClientError"]},INVALID_BITRATE:{message:"Invalid bitrate",code:400,subCode:45316,resultCategories:["ExpectedError"]},TRAFFIC_LIMITED:{message:"Traffic is limited",code:400,subCode:45317,resultCategories:["ExpectedError"]},SEND_FAIL:{message:"Failed to send message.",code:500,subCode:45318,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to DataChannel event, unknown event name.",code:422,subCode:45319,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_TYPE:{message:"Wrong argument type specified.",code:400,subCode:45320,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_VALUE:{message:"Wrong value specified.",code:400,subCode:45321,resultCategories:["ExpectedError"]},CANT_FIND_CHANNEL_ID:{message:"Cannot find the channelId specified.",code:400,subCode:45322,resultCategories:["ExpectedError"]},FAILED_TO_CREATE_SENDER:{message:"Failed to create the sender.",code:500,subCode:45323,resultCategories:["UnexpectedClientError"]}},DEBUG_INFO:{},DIAGNOSTICS:{INCORRECT_VALUETYPE_MAPPED:{message:"Mapped to an incorrect value type. Please gather browser console logs and contact Azure Communication Services support.",code:500,subCode:45400,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to UserFacingDiagnostics event, unknown event name.",code:422,subCode:45401,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from UserFacingDiagnostics event, unknown event name.",code:422,subCode:45402,resultCategories:["ExpectedError"]},INCORRECT_VALUE_MAPPED:{message:"Failed to map diagnostic quality level. Please gather browser console logs and contact Azure Communication Services support.",code:500,subCode:45403,resultCategories:["UnexpectedClientError"]}},DOMINANT_SPEAKER:{},LIVE_STREAM:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to LiveStream event, unknown event name.",code:422,subCode:45500,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribefrom LiveStream event, unknown event name.",code:422,subCode:45501,resultCategories:["ExpectedError"]},INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:400,subCode:45502,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:400,subCode:45503,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:400,subCode:45504,resultCategories:["ExpectedError"]}},MEDIA_STATS:{INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:400,subCode:45550,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:400,subCode:45551,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:400,subCode:45552,resultCategories:["ExpectedError"]}},OPTIMAL_VIDEO_COUNT:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to OptimalVideoCount event, unknown event name.",code:422,subCode:45600,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from OptimalVideoCount event, unknown event name.",code:422,subCode:45601,resultCategories:["ExpectedError"]}},PPTLIVE:{},PRECALL_DIAGNOSTICS:{SET_DEVICE_FAIL:{message:"Failed to set default microphone or speaker with error",code:412,subCode:45700,resultCategories:["UnexpectedClientError"]},GET_DIAGNOSTICS_INFO:{message:"Unable to return call diagnostic information.",code:500,subCode:45701,resultCategories:["UnexpectedClientError"]},VIDEO_STREAM_TIMEOUT:{message:"Timeout in checking media stream status",code:500,subCode:45702,resultCategories:["UnexpectedClientError"]},GET_CALL_AGENT:{message:"Failed to get existing call agent or create a new one",code:500,subCode:45703,resultCategories:["UnexpectedClientError"]},CONNECT_FAIL:{message:"Test call failed to connect",code:500,subCode:45704,resultCategories:["UnexpectedClientError"]},RENDER_VIDEO:{message:"Call failed to render video.",code:500,subCode:45705,resultCategories:["UnexpectedClientError"]},HANGUP_FAIL:{message:"Test call failed hang up the call",code:500,subCode:45706,resultCategories:["UnexpectedClientError"]},VIDEO_MEDIASTATS:{message:"Failed to get video call media stats",code:500,subCode:45707,resultCategories:["UnexpectedClientError"]},CALL_CONNECT_TIMEOUT:{message:"Call timed out to connect. Please try again, if the issue persists, gather browser console logs and contact Azure Communication Services support.",code:408,subCode:45708,resultCategories:["UnexpectedClientError"]}},RAISE_HAND:{INITIALIZE:{message:"Could not initialize raise hand feature.",code:500,subCode:45750,resultCategories:["UnexpectedClientError"]},RAISE_HAND_PUBLISH_STATE:{message:"Could not change a participant state.",code:500,subCode:45751,resultCategories:["UnexpectedServerError"]},RAISE_HAND_FAIL:{message:"Could not change a participant state.",code:500,subCode:45752,resultCategories:["UnexpectedServerError"]},LOWER_HAND_FAIL:{message:"Could not change a participant state.",code:500,subCode:45753,resultCategories:["UnexpectedServerError"]},LOWER_REMOTEPARTICIPANTS_HANDS_FAIL:{message:"Could not change a participant state.",code:500,subCode:45754,resultCategories:["UnexpectedServerError"]},LOWER_ALL_HANDS_FAIL:{message:"Could not change a participant state.",code:500,subCode:45755,resultCategories:["UnexpectedServerError"]},LOWER_HANDS_EMPTY_PARTICIPANT_LIST:{message:"Lower hands request failed because participant list is empty.",code:400,subCode:45756,resultCategories:["ExpectedError"]},RAISE_HANDS_EMPTY_PARTICIPANT_LIST:{message:"Raise hands request failed because participant list is empty.",code:400,subCode:45757,resultCategories:["ExpectedError"]}},REACTION:{CALL_NOT_CONNECTED:{message:"Call is not connected yet to send reaction",code:400,subCode:45800,resultCategories:["ExpectedError"]},NOT_SUPPORTED_1TO1_CTE:{message:"Reaction send is not supported for 1:1 direct calling with teams identity",code:400,subCode:45801,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE_FAIL_POLICY:{message:"Unable to register listener due to meeting policy",code:403,subCode:45802,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE_FAIL_POLICY:{message:"Unable to deregister listener due to meeting policy",code:403,subCode:45803,resultCategories:["ExpectedError"]},SEND_FAIL_POLICY:{message:"Unable to send reaction due to meeting policy",code:403,subCode:45804,resultCategories:["ExpectedError"]},STATE_SERVICE_CONNECT_FAIL:{message:"Could not create state service proxy web-socket connection",code:500,subCode:45805,resultCategories:["UnexpectedServerError"]},MAP_CREATE_FAIL:{message:"Could not create sync map to exchange reaction",code:500,subCode:45806,resultCategories:["UnexpectedServerError"]},NOT_INIT_YET:{message:"Unable to handle send reaction",code:400,subCode:45807,resultCategories:["ExpectedError"]},SEND_REACTION_FAIL:{message:"Unable to handle send reaction",code:500,subCode:45808,resultCategories:["UnexpectedClientError"]},RECEIVE_REACTION_FAIL:{message:"Unable to parse reaction",code:500,subCode:45809,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to Reation event, unknown event name.",code:422,subCode:45810,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from Reaction event, unknown event name.",code:422,subCode:45811,resultCategories:["ExpectedError"]}},RECORDING:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to Recording event, unknown event name.",code:422,subCode:45850,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from Recording event, unknown event name.",code:422,subCode:45851,resultCategories:["ExpectedError"]},RECORDING_STATUS_ALREADY_SET:{message:"Recording status already set.",code:400,subCode:45852,resultCategories:["ExpectedError"]}},SPOTLIGHT:{ALREADY_SPOTLIGHTED:{message:"Bad request. All participants are already spotlighted",code:400,subCode:45900,resultCategories:["ExpectedError"]},START_SPOTLIGHT_FAILED:{message:"Internal Error. Start spotlight for participants failed",code:500,subCode:45901,resultCategories:["UnexpectedServerError"]},SPOTLIGHT_LIGHT_MAX_REACHED:{message:"Failed to start spotlight. Reached the maximum number of participants that can be Spotlighted.",code:400,subCode:45902,resultCategories:["ExpectedError"]},UNSUPPORTED_ROLE_TYPE:{message:"Failed to spotlight. User does not have a Presenter or Organizer role.",code:403,subCode:45903,resultCategories:["ExpectedError"]},FEATURE_NOT_ENABLED:{message:"Spotlight feature is not enabled",code:400,subCode:45904,resultCategories:["ExpectedError"]},PARTICIPANT_LIST_EMPTY:{message:"StartSpotlight failed. Participant list is empty",code:400,subCode:45905,resultCategories:["ExpectedError"]}},TEAMS_MEETING_AUDIO_CONFERENCING:{ONLY_AVAILABLE_IN_MEETINGS:{message:"Teams meeting audio conferencing feature is only available in meetings",code:400,subCode:45950,resultCategories:["ExpectedError"]},DISABLED:{message:"The Teams meeting audio conferencing details feature is disabled by ACS service.",code:405,subCode:45951,resultCategories:["ExpectedError"]},UNAVAILABLE_BEFORE_JOINING:{message:"Teams meeting audio conferencing details are not available before joining the Teams meeting",code:400,subCode:45952,resultCategories:["ExpectedError"]},UNVAILABLE_IN_LOBBY:{message:"Teams meeting audio conferencing details are not available in Lobby",code:400,subCode:45953,resultCategories:["ExpectedError"]},DETAILS_NOT_CONFIGURED:{message:"Teams meeting audio conferencing details is not configured",code:400,subCode:45954,resultCategories:["UnexpectedClientError"]},GET_DETAILS_FAILED:{message:"Error retrieving Teams meeting audio conferencing details",code:500,subCode:45955,resultCategories:["UnexpectedServerError"]}},TRANSCRIPTION:{TRANSCRIPTION_STATUS_ALREADY_SET:{message:"Transcription status already set.",code:400,subCode:46e3,resultCategories:["ExpectedError"]}},TRANSFER:{TRANSFER_TO_TARGET_FAILED:{message:"Transfer to target failed",code:500,subCode:46050,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_CALL_TYPE:{message:"Transfer is not supported in this call.",code:400,subCode:46051,resultCategories:["ExpectedError"]},TARGET_NOT_RECOGNIZED:{message:"Transfer target is not recognized.",code:400,subCode:46052,resultCategories:["ExpectedError"]},INVALID_TARGET_TYPE:{message:"Invalid target participant type detected.",code:400,subCode:46053,resultCategories:["ExpectedError"]}},UNMIXED_AUDIO:{UNAVAILABLE:{message:"UnmixedAudio is not available.",code:500,subCode:46100,resultCategories:["UnexpectedClientError"]},PENDING_OPERATION:{message:"The operation cannot be done because there is a pending operation",code:400,subCode:46101,resultCategories:["ExpectedError"]},UNSUPPORTED_OPERATION:{message:"The operation is not supported in peer-to-peer call",code:400,subCode:46102,resultCategories:["ExpectedError"]},ENABLED:{message:"Unmixed audio has been enabled",code:400,subCode:46103,resultCategories:["ExpectedError"]},DISABLED:{message:"Unmixed audio has been disabled",code:400,subCode:46104,resultCategories:["ExpectedError"]},DISPOSED:{message:"Unmixed audio has been disposed",code:400,subCode:46105,resultCategories:["ExpectedError"]},EVENT_SUBSCIBE_UNSUBSCRIBE:{message:"Not able to subscribe or unsubscibe to UnmixedAudio event, unknown event name.",code:422,subCode:46106,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_TYPE:{message:"Wrong argument type specified.",code:400,subCode:46107,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_VALUE:{message:"Wrong value specified.",code:400,subCode:46108,resultCategories:["ExpectedError"]},INVALID_STATE:{message:"Invalid state.",code:400,subCode:46109,resultCategories:["ExpectedError"]},UNKNOWN_ERROR:{message:"Unknown error",code:500,subCode:46110,resultCategories:["UnexpectedClientError"]},FAILED_TO_ENABLE:{message:"Failed to enable unmixed audio: AudioContext={0}, UnmixedAudio={1}",code:500,subCode:46111,resultCategories:["UnexpectedClientError"]},FAILED_TO_DISABLE:{message:"Failed to disable unmixed audio: AudioContext={0}, UnmixedAudio={1}",code:500,subCode:46112,resultCategories:["UnexpectedClientError"]},FAILED_TO_INITIALIZE:{message:"Failed to initialize unmixed audio.",code:500,subCode:46113,resultCategories:["UnexpectedClientError"]}},VIDEO_EFFECTS:{DISABLED:{message:"Video effects feature is currently disabled by Azure Communication Services.",code:403,subCode:46150,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:400,subCode:46151,resultCategories:["ExpectedError"]},UNSUPPORTED_SOURCE:{message:"Current source is unsupported to use effects",code:415,subCode:46152,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:500,subCode:46153,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:500,subCode:46154,resultCategories:["UnexpectedClientError"]},WEBCV_PROVIDER_FAILED:{message:"Failed to get WebCV provider.",code:500,subCode:46155,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_EFFECT:{message:"Effect is not supported.",code:501,subCode:46156,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:400,subCode:46157,resultCategories:["UnexpectedClientError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:500,subCode:46158,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:400,subCode:46159,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {event}, unknown event name",code:400,subCode:46160,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {event}, unknown event name",code:400,subCode:46161,resultCategories:["ExpectedError"]},EFFECT_PROVIDER_TIMEOUT:{message:"Timed promise; rejected.",code:408,subCode:46162,resultCategories:["UnexpectedClientError"]},SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:501,subCode:46163,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting video effects",code:500,subCode:46164,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping video effects",code:500,subCode:46165,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing video effects feature",code:500,subCode:46166,resultCategories:["UnexpectedClientError"]},EFFECT_NOT_SUPPORTED:{message:"Effect is not supported. The hardware does not support the effect.",code:400,subCode:46167,resultCategories:["UnexpectedClientError"]},EFFECT_NOT_AVAILABLE:{message:"Effect is not available. Try again when the effect is initialized and available",code:500,subCode:46168,resultCategories:["UnexpectedClientError"]},EFFECT_DISABLED_BY_POLICY:{message:"Effect can not be enabled because of Teams Policy",code:403,subCode:46169,resultCategories:["ExpectedError"]},ENABLE_EFFECT_FAILED:{message:"Failed to enable the effect",code:500,subCode:46170,resultCategories:["UnexpectedClientError"]}},LOCAL_RECORDING:{ONLY_AVAILABLE_IN_MEETINGS:{message:"Local Recording feature is only available in meetings",code:400,subCode:46200,resultCategories:["ExpectedError"]},DISABLED:{message:"Local Recording feature is currently disabled by Azure Communication Service.",code:405,subCode:46201,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to LocalRecording event, unknown event name.",code:422,subCode:46202,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe from LocalRecording event, unknown event name.",code:422,subCode:46203,resultCategories:["ExpectedError"]}}}},S=400,v=408,y=412,C=422,_=500,E="19:preview-",T={Date:!0,RegExp:!0,String:!0,Number:!0};class I extends Error{constructor(e){if(super(),this._code=0,this._subCode=0,this._resultCategories=[],this.name="CallingCommunicationError",e.originalError instanceof I)return this._code=e.originalError.code,this._subCode=e.originalError.subCode,this._resultCategories=e.originalError.resultCategories,this.message=e.originalError.message,void(this.stack=e.originalError.stack);this.message=e.defaultError.message,this._code=e.defaultError.code,this._subCode=e.defaultError.subCode,this._resultCategories=e.defaultError.resultCategories,e.originalError instanceof Error&&(this.stack=e.originalError.stack)}get code(){return this._code}get subCode(){return this._subCode}get resultCategories(){return this._resultCategories}}const b=Symbol("loggerKeySymbol");var A,R,w;function P(e){return O(e||"",!1)}function M(e){return O(e||"",!0)}(A=e.CallAgentKind||(e.CallAgentKind={})).CallAgent="CallAgent",A.TeamsCallAgent="TeamsCallAgent",(R=e.CallKind||(e.CallKind={})).Call="Call",R.TeamsCall="TeamsCall",(w=e.IncomingCallKind||(e.IncomingCallKind={})).IncomingCall="IncomingCall",w.TeamsIncomingCall="TeamsIncomingCall";const D=t=>(i,n,r)=>{const s=r.value;return r.value=function(...i){if(this.kind===e.CallKind.TeamsCall&&this.isEmergencyCallInProgress())throw new I({defaultError:f.CALL.OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL,defaultErrorMessageArgs:[t]});return s.apply(this,i)},r},O=(e,t)=>t?(t,i,n)=>{const r=n.value;return n.value=async function(...t){let i;const n=+new Date;k(this,e,"started");try{i=await r.apply(this,t),k(this,e,"succeeded",n)}catch(t){const i=new I({defaultError:f.CALL.OPERATION_FAILED,defaultErrorMessageArgs:[e],originalError:t});throw N(this,e,t,n),i}return i},n}:(t,i,n)=>{const r=n.value;return n.value=function(...t){let i;const n=+new Date;k(this,e,"started");try{i=r.apply(this,t),k(this,e,"succeeded",n)}catch(t){const i=new I({defaultError:f.CALL.OPERATION_FAILED,defaultErrorMessageArgs:[e],originalError:t});throw N(this,e,t,n),i}return i},n};function k(e,t,i,n){const r=L(e);if(r){const e=n?`in ${(+new Date-n)/1e3}s`:"";r.info(`op:${t}, ${i} ${e}`)}}function N(e,t,i,n){const r=L(e);try{if(r){const e=n?`in ${(+new Date-n)/1e3}s`:"";r.error(`op:${t} failed, message=${i.message}, code=${i.code}${i.subCode?`, subCode=${i.subCode}`:""} ${e}`),i&&r.error(`op:${t} failed, message=${i.message}, code=${i.code}, subCode=${i.subCode}, resultCategories=${i.resultCategories}, time elapsed=${e}`)}}catch(i){}}function L(e){try{const t=Reflect.getMetadata(b,e);if(t)return e[t]}catch(e){}}function x(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var U="function",F="object",V="undefined",B="prototype",H="hasOwnProperty",$=Object,G=$[B],j=$.assign,q=$.create,W=$.defineProperty,z=G[H];function J(){return typeof globalThis!==V&&globalThis?globalThis:typeof self!==V&&self?self:typeof window!==V&&window?window:typeof i.g!==V&&i.g?i.g:null}function K(e){throw new TypeError(e)}function Y(e){if(q)return q(e);if(null==e)return{};var t=typeof e;function i(){}return t!==F&&t!==U&&K("Object prototype may only be an Object:"+e),i[B]=e,new i}(J()||{}).Symbol,(J()||{}).Reflect;var Q=j||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])G[H].call(t,r)&&(e[r]=t[r]);return e},X=function(e,t){return X=$.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t[H](i)&&(e[i]=t[i])},X(e,t)};function Z(e,t){function i(){this.constructor=e}typeof t!==U&&null!==t&&K("Class extends value "+String(t)+" is not a constructor or null"),X(e,t),e[B]=null===t?Y(t):(i[B]=t[B],new i)}var ee,te=0,ie=1,ne=2,re=4,se=5,ae="undefined",oe="constructor",ce="prototype",le="function",de="_dynInstFuncs",he="_isDynProxy",ue="_dynClass",ge="_dynInstChk",pe=ge,me="_dfOpts",fe="_unknown_",Se="__proto__",ve="_dyn"+Se,ye="__dynProto$Gbl",Ce="_dynInstProto",_e="useBaseInst",Ee="setInstFuncs",Te=Object,Ie=Te.getPrototypeOf,be=Te.getOwnPropertyNames;var Ae,Re=function(){var e;return typeof globalThis!==ae&&(e=globalThis),e||typeof self===ae||(e=self),e||typeof window===ae||(e=window),e||typeof i.g===ae||(e=i.g),e||{}}(),we=Re[ye]||(Re[ye]={o:(ee={},ee[Ee]=!0,ee[_e]=!0,ee),n:1e3});function Pe(e,t){return e&&Te[ce].hasOwnProperty.call(e,t)}function Me(e){return e&&(e===Te[ce]||e===Array[ce])}function De(e){return Me(e)||e===Function[ce]}function Oe(e){var t;if(e){if(Ie)return Ie(e);var i=e[Se]||e[ce]||(e[oe]?e[oe][ce]:null);t=e[ve]||i,Pe(e,ve)||(delete e[Ce],t=e[ve]=e[Ce]||e[ve],e[Ce]=i)}return t}function ke(e,t){var i=[];if(be)i=be(e);else for(var n in e)"string"==typeof n&&Pe(e,n)&&i.push(n);if(i&&i.length>0)for(var r=0;r<i.length;r++)t(i[r])}function Ne(e,t,i){return t!==oe&&typeof e[t]===le&&(i||Pe(e,t))}function Le(e){throw new TypeError("DynamicProto: "+e)}function xe(e,t){for(var i=e.length-1;i>=0;i--)if(e[i]===t)return!0;return!1}function Ue(e,t,i,n,r){function s(e,t){var i=function(){return(function(e,t,i,n){var r=null;if(e&&Pe(i,ue)){var s=e[de]||{};if((r=(s[i[ue]]||{})[t])||Le("Missing ["+t+"] "+le),!r[ge]&&!1!==s[pe]){for(var a=!Pe(e,t),o=Oe(e),c=[];a&&o&&!De(o)&&!xe(c,o);){var l=o[t];if(l){a=l===n;break}c.push(o),o=Oe(o)}try{a&&(e[t]=r),r[ge]=1}catch(e){s[pe]=!1}}}return r}(this,t,e,i)||function(e,t,i){var n=t[e];return n===i&&(n=Oe(t)[e]),typeof n!==le&&Le("["+e+"] is not a "+le),n}(t,e,i)).apply(this,arguments)};return i[he]=1,i}if(!Me(e)){var a=i[de]=i[de]||{},o=a[t]=a[t]||{};!1!==a[pe]&&(a[pe]=!!r),ke(i,(function(t){Ne(i,t,!1)&&i[t]!==n[t]&&(o[t]=i[t],delete i[t],(!Pe(e,t)||e[t]&&!e[t][he])&&(e[t]=s(e,t)))}))}}function Fe(e,t){return Pe(e,ce)?e.name||t||fe:((e||{})[oe]||{}).name||t||fe}function Ve(e,t,i,n){Pe(e,ce)||Le("theClass is an invalid class definition.");var r=e[ce];(function(e,t){if(Ie){for(var i=[],n=Oe(t);n&&!De(n)&&!xe(i,n);){if(n===e)return!0;i.push(n),n=Oe(n)}return!1}return!0})(r,t)||Le("["+Fe(e)+"] not in hierarchy of ["+Fe(t)+"]");var s=null;Pe(r,ue)?s=r[ue]:(s="_dynCls$"+Fe(e,"_")+"$"+we.n,we.n++,r[ue]=s);var a=Ve[me],o=!!a[_e];o&&n&&void 0!==n[_e]&&(o=!!n[_e]);var c=function(e){var t={};return ke(e,(function(i){!t[i]&&Ne(e,i,!1)&&(t[i]=e[i])})),t}(t);i(t,function(e,t,i,n){function r(e,t,i){var r=t[i];if(r[he]&&n){var s=e[de]||{};!1!==s[pe]&&(r=(s[t[ue]]||{})[i]||r)}return function(){return r.apply(e,arguments)}}var s={};ke(i,(function(e){s[e]=r(t,i,e)}));for(var a=Oe(e),o=[];a&&!De(a)&&!xe(o,a);)ke(a,(function(e){!s[e]&&Ne(a,e,!Ie)&&(s[e]=r(t,a,e))})),o.push(a),a=Oe(a);return s}(r,t,c,o));var l=!!Ie&&!!a[Ee];l&&n&&(l=!!n[Ee]),Ue(r,s,t,c,!1!==l)}Ve[me]=we.o,function(e){e[e.CRITICAL=1]="CRITICAL",e[e.WARNING=2]="WARNING"}(Ae||(Ae={}));var Be={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},He="on",$e="attachEvent",Ge="addEventListener",je="detachEvent",qe="removeEventListener",We=W;function ze(e){return G.toString.call(e)}function Je(e){return void 0===e||typeof e===V}function Ke(e){return null===e||Je(e)}function Ye(e){return!Ke(e)}function Qe(e){return typeof e===F}function Xe(e){return typeof e===U}function Ze(e,t,i,n){void 0===n&&(n=!1);var r=!1;if(!Ke(e))try{Ke(e[Ge])?Ke(e[$e])||(e[$e](He+t,i),r=!0):(e[Ge](t,i,n),r=!0)}catch(e){}return r}function et(e,t,i,n){if(void 0===n&&(n=!1),!Ke(e))try{Ke(e[qe])?Ke(e[je])||e[je](He+t,i):e[qe](t,i,n)}catch(e){}}function tt(e,t){if(e)for(var i in e)z.call(e,i)&&t.call(e,i,e[i])}function it(e,t){var i=!1;if(e&&t){var n=t.length;if(e===t)return!0;if(e.length>=n){for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;i=!0}}return i}function nt(e,t){return!(!e||!t)&&-1!==e.indexOf(t)}function rt(e){return"[object Array]"===ze(e)}function st(e){return"string"==typeof e}function at(e){return"number"==typeof e}function ot(e){return"boolean"==typeof e}function ct(e){if(function(e){return"[object Date]"===ze(e)}(e)){var t=function(e){var t=String(e);return 1===t.length&&(t="0"+t),t};return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}function lt(e,t,i){for(var n=e.length,r=0;r<n&&(!(r in e)||-1!==t.call(i||e,e[r],r,e));r++);}function dt(e,t,i){for(var n=e.length,r=i||0,s=Math.max(r>=0?r:n-Math.abs(r),0);s<n;s++)if(s in e&&e[s]===t)return s;return-1}function ht(e){return"string"!=typeof e?e:e.replace(/^\s+|\s+$/g,"")}var ut=!{toString:null}.propertyIsEnumerable("toString"),gt=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function pt(e){var t=typeof e;t===U||t===F&&null!==e||K("objKeys called on non-object");var i=[];for(var n in e)e&&z.call(e,n)&&i.push(n);if(ut)for(var r=gt.length,s=0;s<r;s++)e&&z.call(e,gt[s])&&i.push(gt[s]);return i}function mt(e,t,i,n){if(We)try{var r={enumerable:!0,configurable:!0};return i&&(r.get=i),n&&(r.set=n),We(e,t,r),!0}catch(e){}return!1}function ft(){var e=Date;return e.now?e.now():(new e).getTime()}function St(e){return function(e){return"[object Error]"===ze(e)}(e)?e.name:""}function vt(e,t,i,n,r){var s=i;return e&&((s=e[t])===i||r&&!r(s)||n&&!n(i)||(s=i,e[t]=s)),s}function yt(e){return!e}function Ct(e){return!!e}function _t(e){throw new Error(e)}function Et(e){return e&&(e=$(j?j({},e):e)),e}var Tt="window",It="document",bt="navigator",At="location",Rt="performance",wt="JSON",Pt="crypto",Mt="msCrypto",Dt="msie",Ot="trident/",kt=null,Nt=null,Lt=!1;function xt(e){var t=J();return t&&t[e]?t[e]:e===Tt&&Ut()?window:null}function Ut(){return Boolean(typeof window===F&&window)}function Ft(){return Ut()?window:xt(Tt)}function Vt(){return Boolean(typeof document===F&&document)?document:xt(It)}function Bt(){return Boolean(typeof navigator===F&&navigator)}function Ht(){return Bt()?navigator:xt(bt)}function $t(e){if(e&&Lt){var t=xt("__mockLocation");if(t)return t}return typeof location===F&&location?location:xt(At)}function Gt(){return Boolean(typeof JSON===F&&JSON||null!==xt(wt))}function jt(){return Gt()?JSON||xt(wt):null}function qt(){var e=Ht();return!(!e||!e.product)&&"ReactNative"===e.product}function Wt(){var e=Ht();if(e&&(e.userAgent!==Nt||null===kt)){var t=((Nt=e.userAgent)||"").toLowerCase();kt=nt(t,Dt)||nt(t,Ot)}return kt}function zt(e){var t=Object[B].toString.call(e),i="";return"[object Error]"===t?i="{ stack: '"+e.stack+"', message: '"+e.message+"', name: '"+e.name+"'":Gt()&&(i=jt().stringify(e)),t+i}function Jt(e){return e?'"'+e.replace(/\"/g,"")+'"':""}var Kt=function(){function e(e,t,i,n){void 0===i&&(i=!1);var r=this;r.messageId=e,r.message=(i?"AI: ":"AI (Internal): ")+e;var s="";Gt()&&(s=jt().stringify(n));var a=(t?" message:"+Jt(t):"")+(n?" props:"+Jt(s):"");r.message+=a}return e.dataType="MessageData",e}();function Yt(e,t){return(e||{}).logger||new Qt(t)}var Qt=function e(t){this.identifier="DiagnosticLogger",this.queue=[];var i=0,n={};Ve(e,this,(function(e){function r(e,i){var n=t[e];return Ke(n)?i:n}Ke(t)&&(t={}),e.consoleLoggingLevel=function(){return r("loggingLevelConsole",0)},e.telemetryLoggingLevel=function(){return r("loggingLevelTelemetry",1)},e.maxInternalMessageLimit=function(){return r("maxMessageLimit",25)},e.enableDebugExceptions=function(){return r("enableDebugExceptions",!1)},e.throwInternal=function(t,i,r,s,a){void 0===a&&(a=!1);var o=new Kt(i,r,a,s);if(e.enableDebugExceptions())throw o;if(!Je(o)&&o&&!Je(o.message)){var c=e.consoleLoggingLevel();if(a){var l=+o.messageId;!n[l]&&c>=Ae.WARNING&&(e.warnToConsole(o.message),n[l]=!0)}else c>=Ae.WARNING&&e.warnToConsole(o.message);e.logInternalMessage(t,o)}},e.warnToConsole=function(e){var t=typeof console!==V?console:xt("console");if(t){var i="log";t.warn&&(i="warn"),Xe(t[i])&&t[i](e)}},e.resetInternalMessageCount=function(){i=0,n={}},e.logInternalMessage=function(t,r){if(!(i>=e.maxInternalMessageLimit())){var s=!0,a="AITR_"+r.messageId;if(n[a]?s=!1:n[a]=!0,s&&(t<=e.telemetryLoggingLevel()&&(e.queue.push(r),i++),i===e.maxInternalMessageLimit())){var o="Internal events throttle limit per PageView reached for this app.",c=new Kt(Be.MessageLimitPerPVExceeded,o,!1);e.queue.push(c),e.warnToConsole(o)}}}}))},Xt="ctx",Zt=function(){function e(t,i,n){var r,s=this,a=!1;s.start=ft(),s.name=t,s.isAsync=n,s.isChildEvt=function(){return!1},Xe(i)&&(a=mt(s,"payload",(function(){return!r&&Xe(i)&&(r=i(),i=null),r}))),s.getCtx=function(t){return t?t===e.ParentContextKey||t===e.ChildrenContextKey?s[t]:(s[Xt]||{})[t]:null},s.setCtx=function(t,i){t&&(t===e.ParentContextKey?(s[t]||(s.isChildEvt=function(){return!0}),s[t]=i):t===e.ChildrenContextKey?s[t]=i:(s[Xt]=s[Xt]||{})[t]=i)},s.complete=function(){var t=0,n=s.getCtx(e.ChildrenContextKey);if(rt(n))for(var r=0;r<n.length;r++){var o=n[r];o&&(t+=o.time)}s.time=ft()-s.start,s.exTime=s.time-t,s.complete=function(){},!a&&Xe(i)&&(s.payload=i())}}return e.ParentContextKey="parent",e.ChildrenContextKey="childEvts",e}(),ei=function e(t){this.ctx={},Ve(e,this,(function(e){e.create=function(e,t,i){return new Zt(e,t,i)},e.fire=function(e){e&&(e.complete(),t&&t.perfEvent(e))},e.setCtx=function(t,i){t&&((e[Xt]=e[Xt]||{})[t]=i)},e.getCtx=function(t){return(e[Xt]||{})[t]}}))},ti="CoreUtils.doPerf";function ii(e,t,i,n,r){if(e){var s=e;if(s&&Xe(s.getPerfMgr)&&(s=s.getPerfMgr()),s){var a=void 0,o=s.getCtx(ti);try{if(a=s.create(t(),n,r)){if(o&&a.setCtx&&(a.setCtx(Zt.ParentContextKey,o),o.getCtx&&o.setCtx)){var c=o.getCtx(Zt.ChildrenContextKey);c||(c=[],o.setCtx(Zt.ChildrenContextKey,c)),c.push(a)}return s.setCtx(ti,a),i(a)}}catch(e){a&&a.setCtx&&a.setCtx("exception",e)}finally{a&&s.fire(a),s.setCtx(ti,o)}}}return i()}var ni=function(e,t){var i=this,n=null,r=Xe(e.processTelemetry),s=Xe(e.setNextPlugin);i._hasRun=!1,i.getPlugin=function(){return e},i.getNext=function(){return n},i.setNext=function(e){n=e},i.processTelemetry=function(a,o){o||(o=t);var c=e?e.identifier:"TelemetryPluginChain";ii(o?o.core():null,(function(){return c+":processTelemetry"}),(function(){if(e&&r){i._hasRun=!0;try{o.setNext(n),s&&e.setNextPlugin(n),n&&(n._hasRun=!1),e.processTelemetry(a,o)}catch(i){var t=n&&n._hasRun;n&&t||o.diagLog().throwInternal(Ae.CRITICAL,Be.PluginException,"Plugin ["+e.identifier+"] failed during processTelemetry - "+i),n&&!t&&n.processTelemetry(a,o)}}else n&&(i._hasRun=!0,n.processTelemetry(a,o))}),(function(){return{item:a}}),!a.sync)}};function ri(e,t){var i=[];if(e&&e.length>0)for(var n=null,r=0;r<e.length;r++){var s=e[r];if(s&&Xe(s.processTelemetry)){var a=new ni(s,t);i.push(a),n&&n.setNext(a),n=a}}return i.length>0?i[0]:null}var si=function e(t,i,n,r){var s=this,a=null;null!==r&&(t&&Xe(t.getPlugin)?a=function(e,t,i){var n=[],r=!i;if(e)for(;e;){var s=e.getPlugin();(r||s===i)&&(r=!0,n.push(s)),e=e.getNext()}return r||n.push(i),ri(n,t)}(t,s,r||t.getPlugin()):r?a=function(e,t,i){var n=e,r=!1;return i&&e&&(n=[],lt(e,(function(e){(r||e===i)&&(r=!0,n.push(e))}))),i&&!r&&(n||(n=[]),n.push(i)),ri(n,t)}(t,s,r):Je(r)&&(a=ri(t,s))),s.core=function(){return n},s.diagLog=function(){return Yt(n,i)},s.getCfg=function(){return i},s.getExtCfg=function(e,t){var n;if(void 0===t&&(t={}),i){var r=i.extensionConfig;r&&e&&(n=r[e])}return n||t},s.getConfig=function(e,t,n){var r;void 0===n&&(n=!1);var a=s.getExtCfg(e,null);return a&&!Ke(a[t])?r=a[t]:i&&!Ke(i[t])&&(r=i[t]),Ke(r)?n:r},s.hasNext=function(){return null!=a},s.getNext=function(){return a},s.setNext=function(e){a=e},s.processNext=function(e){var t=a;t&&(a=t.getNext(),t.processTelemetry(e,s))},s.createNew=function(t,r){return void 0===t&&(t=null),new e(t||a,i,n,r)}},ai="extensionConfig",oi="getPlugin",ci=function(){function e(){var e=this,t=!1,i=null,n=null;e.core=null,e.diagLog=function(t){return e._getTelCtx(t).diagLog()},e.isInitialized=function(){return t},e.setInitialized=function(e){t=e},e.setNextPlugin=function(e){n=e},e.processNext=function(e,t){t?t.processNext(e):n&&Xe(n.processTelemetry)&&n.processTelemetry(e,null)},e._getTelCtx=function(t){void 0===t&&(t=null);var r=t;if(!r){var s=i||new si(null,{},e.core);r=n&&n[oi]?s.createNew(null,n[oi]):s.createNew(null,n)}return r},e._baseTelInit=function(r,s,a,o){r&&vt(r,ai,[],null,Ke),!o&&s&&(o=s.getProcessTelContext().getNext());var c=n;n&&n[oi]&&(c=n[oi]()),e.core=s,i=new si(o,r,s,c),t=!0}}return e.prototype.initialize=function(e,t,i,n){this._baseTelInit(e,t,i,n)},e}(),li="processTelemetry",di="priority",hi="setNextPlugin",ui="isInitialized";function gi(e,t){for(var i=[],n=null,r=e.getNext();r;){var s=r.getPlugin();s&&(n&&Xe(n[hi])&&Xe(s[li])&&n[hi](s),Xe(s[ui])&&s[ui]()||i.push(s),n=s,r=r.getNext())}lt(i,(function(i){i.initialize(e.getCfg(),e.core(),t,e.getNext())}))}function pi(e){return e.sort((function(e,t){var i=0,n=Xe(t[li]);return Xe(e[li])?i=n?e[di]-t[di]:1:n&&(i=-1),i}))}var mi=function(e){function t(){var i,n=e.call(this)||this;function r(e){e&&e.length>0&&(function(e){lt(e,(function(e){e.priority<500&&_t("Channel has invalid priority"+e.identifier)}))}(e=e.sort((function(e,t){return e.priority-t.priority}))),i.push(e))}return n.identifier="ChannelControllerPlugin",n.priority=500,Ve(t,n,(function(e,t){e.setNextPlugin=function(e){},e.processTelemetry=function(e,t){i&&lt(i,(function(i){i.length>0&&n._getTelCtx(t).createNew(i).processNext(e)}))},e.getChannelControls=function(){return i},e.initialize=function(n,s,a){e.isInitialized()||(t.initialize(n,s,a),function(e,t){if(i=[],e&&lt(e,(function(e){return r(e)})),t){var n=[];lt(t,(function(e){e.priority>500&&n.push(e)})),r(n)}}((n||{}).channels,a),lt(i,(function(e){return gi(new si(e,n,s),a)})))}})),n}var i;return Z(t,e),t._staticInit=(mt(i=t.prototype,"ChannelControls",i.getChannelControls),void mt(i,"channelQueue",i.getChannelControls)),t}(ci),fi="toGMTString",Si="toUTCString",vi="cookie",yi="expires",Ci="enabled",_i="isCookieUseDisabled",Ei="disableCookiesUsage",Ti="_ckMgr",Ii="",bi=null,Ai=null,Ri=null,wi=Vt(),Pi={},Mi={};function Di(e){return!e||e.isEnabled()}function Oi(e,t){var i;if(e)i=e.getCookieMgr();else if(t){var n=(t||{}).cookieCfg;i=n[Ti]?n[Ti]:ki(t)}return i||(i=function(e,t){var i=ki[Ti]||Mi[Ti];return i||(i=ki[Ti]=ki(e,t),Mi[Ti]=i),i}(t,(e||{}).logger)),i}function ki(e,t){var i=function(e){var t=e.cookieCfg=e.cookieCfg||{};if(vt(t,"domain",e.cookieDomain,Ye,Ke),vt(t,"path",e.cookiePath||"/",null,Ke),Ke(t[Ci])){var i=void 0;Je(e[_i])||(i=!e[_i]),Je(e[Ei])||(i=!e[Ei]),t[Ci]=i}return t}(e||Mi),n=i.path||"/",r=i.domain,s=!1!==i[Ci],a={isEnabled:function(){var e=s&&Ni(t),i=Mi[Ti];return e&&i&&a!==i&&(e=Di(i)),e},setEnabled:function(e){s=!1!==e},set:function(e,t,s,o,c){if(Di(a)){var l={},d=ht(t||Ii),h=d.indexOf(";");if(-1!==h&&(d=ht(t.substring(0,h)),l=Li(t.substring(h+1))),vt(l,"domain",o||r,Ct,Je),!Ke(s)){var u=Wt();if(Je(l[yi])){var g=ft()+1e3*s;if(g>0){var p=new Date;p.setTime(g),vt(l,yi,xi(p,u?fi:Si)||xi(p,u?fi:Si)||Ii,Ct)}}u||vt(l,"max-age",Ii+s,null,Je)}var m=$t();m&&"https:"===m.protocol&&(vt(l,"secure",null,null,Je),null===Ai&&(Ai=!function(e){return!(!st(e)||!nt(e,"CPU iPhone OS 12")&&!nt(e,"iPad; CPU OS 12")&&!(nt(e,"Macintosh; Intel Mac OS X 10_14")&&nt(e,"Version/")&&nt(e,"Safari"))&&(!nt(e,"Macintosh; Intel Mac OS X 10_14")||!function(e,t){if(e&&t){var i=t.length,n=e.length;if(e===t)return!0;if(n>=i){for(var r=n-1,s=i-1;s>=0;s--){if(e[r]!=t[s])return!1;r--}return!0}}return!1}(e,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))&&!nt(e,"Chrome/5")&&!nt(e,"Chrome/6")&&(!nt(e,"UnrealEngine")||nt(e,"Chrome"))&&!nt(e,"UCBrowser/12")&&!nt(e,"UCBrowser/11"))}((Ht()||{}).userAgent)),Ai&&vt(l,"SameSite","None",null,Je)),vt(l,"path",c||n,null,Je),(i.setCookie||Vi)(e,Ui(d,l))}},get:function(e){var t=Ii;return Di(a)&&(t=(i.getCookie||Fi)(e)),t},del:function(e,t){Di(a)&&a.purge(e,t)},purge:function(e,n){if(Ni(t)){var r=((s={}).path=n||"/",s[yi]="Thu, 01 Jan 1970 00:00:01 GMT",s);Wt()||(r["max-age"]="0"),(i.delCookie||Vi)(e,Ui(Ii,r))}var s}};return a[Ti]=a,a}function Ni(e){if(null===bi){bi=!1;try{bi=void 0!==(wi||{})[vi]}catch(t){e&&e.throwInternal(Ae.WARNING,Be.CannotAccessCookie,"Cannot access document.cookie - "+St(t),{exception:zt(t)})}}return bi}function Li(e){var t={};return e&&e.length&&lt(ht(e).split(";"),(function(e){if(e=ht(e||Ii)){var i=e.indexOf("=");-1===i?t[e]=null:t[ht(e.substring(0,i))]=ht(e.substring(i+1))}})),t}function xi(e,t){return Xe(e[t])?e[t]():null}function Ui(e,t){var i=e||Ii;return tt(t,(function(e,t){i+="; "+e+(Ke(t)?Ii:"="+t)})),i}function Fi(e){var t=Ii;if(wi){var i=wi[vi]||Ii;Ri!==i&&(Pi=Li(i),Ri=i),t=ht(Pi[e]||Ii)}return t}function Vi(e,t){wi&&(wi[vi]=e+"="+t)}var Bi="_notificationManager",Hi=function e(){var t,i,n,r,s,a=!1;Ve(e,this,(function(e){e._extensions=new Array,i=new mi,e.logger=Y({throwInternal:function(e,t,i,n,r){},warnToConsole:function(e){},resetInternalMessageCount:function(){}}),t=[],e.isInitialized=function(){return a},e.initialize=function(t,r,s,o){e.isInitialized()&&_t("Core should not be initialized more than once"),t&&!Ke(t.instrumentationKey)||_t("Please provide instrumentation key"),n=o,e[Bi]=o,e.config=t||{},t.extensions=Ke(t.extensions)?[]:t.extensions,(function(e,t,i){var n;return e?!(n=e[t])&&Ke(n)&&(n=Je(i)?{}:i,e[t]=n):n=Je(i)?{}:i,n}(t,ai)).NotificationManager=o,s&&(e.logger=s);var c=[];c.push.apply(c,r.concat(t.extensions)),c=pi(c);var l=[],d={};lt(c,(function(e){(Ke(e)||Ke(e.initialize))&&_t("Extensions must provide callback to initialize");var t=e.priority,n=e.identifier;e&&t&&(Ke(d[t])?d[t]=n:s.warnToConsole("Two extensions have same priority #"+t+" - "+d[t]+", "+n)),(!t||t<i.priority)&&l.push(e)})),c.push(i),l.push(i),c=pi(c),e._extensions=c,gi(new si([i],t,e),c),gi(new si(l,t,e),c),e._extensions=l,0===e.getTransmissionControls().length&&_t("No channels available"),a=!0,e.releaseQueue()},e.getTransmissionControls=function(){return i.getChannelControls()},e.track=function(i){vt(i,"iKey",e.config.instrumentationKey,null,yt),vt(i,"time",ct(new Date),null,yt),vt(i,"ver","4.0",null,Ke),e.isInitialized()?e.getProcessTelContext().processNext(i):t.push(i)},e.getProcessTelContext=function(){var t=e._extensions,n=t;return t&&0!==t.length||(n=[i]),new si(n,e.config,e)},e.getNotifyMgr=function(){return n||(n=Y({addNotificationListener:function(e){},removeNotificationListener:function(e){},eventsSent:function(e){},eventsDiscarded:function(e,t){},eventsSendRequest:function(e,t){}}),e[Bi]=n),n},e.getCookieMgr=function(){return s||(s=ki(e.config,e.logger)),s},e.setCookieMgr=function(e){s=e},e.getPerfMgr=function(){return r||e.config&&e.config.enablePerfMgr&&(r=new ei(e.getNotifyMgr())),r},e.setPerfMgr=function(e){r=e},e.eventCnt=function(){return t.length},e.releaseQueue=function(){t.length>0&&(lt(t,(function(t){e.getProcessTelContext().processNext(t)})),t=[])}}))},$i=function e(t){this.listeners=[];var i=!!(t||{}).perfEvtsSendAll;Ve(e,this,(function(e){e.addNotificationListener=function(t){e.listeners.push(t)},e.removeNotificationListener=function(t){for(var i=dt(e.listeners,t);i>-1;)e.listeners.splice(i,1),i=dt(e.listeners,t)},e.eventsSent=function(t){lt(e.listeners,(function(e){e&&e.eventsSent&&setTimeout((function(){return e.eventsSent(t)}),0)}))},e.eventsDiscarded=function(t,i){lt(e.listeners,(function(e){e&&e.eventsDiscarded&&setTimeout((function(){return e.eventsDiscarded(t,i)}),0)}))},e.eventsSendRequest=function(t,i){lt(e.listeners,(function(e){if(e&&e.eventsSendRequest)if(i)setTimeout((function(){return e.eventsSendRequest(t,i)}),0);else try{e.eventsSendRequest(t,i)}catch(e){}}))},e.perfEvent=function(t){t&&(!i&&t.isChildEvt()||lt(e.listeners,(function(e){if(e&&e.perfEvent)if(t.isAsync)setTimeout((function(){return e.perfEvent(t)}),0);else try{e.perfEvent(t)}catch(e){}})))}}))},Gi=function(e){function t(){var i=e.call(this)||this;return Ve(t,i,(function(e,t){function i(t){var i=e.getNotifyMgr();i&&i.eventsDiscarded([t],ne)}e.initialize=function(e,i,n,r){t.initialize(e,i,n||new Qt(e),r||new $i(e))},e.track=function(n){ii(e.getPerfMgr(),(function(){return"AppInsightsCore:track"}),(function(){null===n&&(i(n),_t("Invalid telemetry item")),function(e){if(Ke(e.name))throw i(e),Error("telemetry name required")}(n),t.track(n)}),(function(){return{item:n}}),!n.sync)},e.addNotificationListener=function(t){var i=e.getNotifyMgr();i&&i.addNotificationListener(t)},e.removeNotificationListener=function(t){var i=e.getNotifyMgr();i&&i.removeNotificationListener(t)},e.pollInternalLogs=function(t){var i=e.config.diagnosticLogInterval;return i&&i>0||(i=1e4),setInterval((function(){var i=e.logger?e.logger.queue:[];lt(i,(function(i){var n={name:t||"InternalMessageId: "+i.messageId,iKey:e.config.instrumentationKey,time:ct(new Date),baseType:Kt.dataType,baseData:{message:i.message}};e.track(n)})),i.length=0}),i)}})),i}return Z(t,e),t}(Hi),ji=4294967296,qi=4294967295,Wi=!1,zi=123456789,Ji=987654321;function Ki(){try{var e=2147483647&ft();!function(e){e<0&&(e>>>=0),zi=123456789+e&qi,Ji=987654321-e&qi,Wi=!0}((Math.random()*ji^e)+e)}catch(e){}}function Yi(e){var t,i=xt(Pt)||xt(Mt);return i&&i.getRandomValues?t=i.getRandomValues(new Uint32Array(1))[0]&qi:Wt()?(Wi||Ki(),t=function(e){var t=((Ji=36969*(65535&Ji)+(Ji>>16)&qi)<<16)+(65535&(zi=18e3*(65535&zi)+(zi>>16)&qi))>>>0&qi;return e||(t>>>=0),t}()&qi):t=Math.floor(ji*Math.random()|0),e||(t>>>=0),t}function Qi(e,t){var i=!1,n=Ft();n&&(i=Ze(n,e,t),i=Ze(n.body,e,t)||i);var r=Vt();return r&&(i=nn.Attach(r,e,t)||i),i}function Xi(){function e(){return function(e){return e>0?Math.floor(Yi()/qi*(e+1))>>>0:0}(15)}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(tn,(function(t){var i=0|e();return("x"===t?i:3&i|8).toString(16)}))}function Zi(e){void 0===e&&(e=22);for(var t=Yi()>>>0,i=0,n="";n.length<e;)i++,n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&t),t>>>=6,5===i&&(t=(Yi()<<2&4294967295|3&t)>>>0,i=0);return n}var en,tn=/[xy]/g,nn={Attach:Ze,AttachEvent:Ze,Detach:et,DetachEvent:et},rn={NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32},sn=1,an=2,on=3,cn=4,ln={Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9},dn=Q(Q({},Be),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),hn="1DS-Web-JS-3.1.2",un=((en={})[0]=ln.Unspecified,en[2]=ln.Double,en[1]=ln.String,en[3]=ln.Bool,en[4098]=ln.Double,en[4097]=ln.String,en[4099]=ln.Bool,en),gn=null,pn=(Boolean(Vt()),Boolean(Ft()));function mn(e){return!(""===e||Ke(e))}function fn(){return null===gn&&(gn=Bt()&&Boolean(Ht().sendBeacon)),gn}function Sn(e,t,i){if(!t&&!mn(t)||"string"!=typeof e)return null;var n=typeof t;if("string"===n||"number"===n||"boolean"===n||rt(t))t={value:t};else if("object"!==n||t.hasOwnProperty("value")){if(Ke(t.value)||""===t.value||!st(t.value)&&!at(t.value)&&!ot(t.value)&&!rt(t.value))return null}else t={value:i?JSON.stringify(t):t};if(rt(t.value)&&!function(e){return e.length>0}(t.value))return null;if(!Ke(t.kind)){if(rt(t.value)||!function(e){return e===rn.NotSet||e>rn.NotSet&&e<=rn.Pii_IPV4AddressLegacy||e===rn.CustomerContent_GenericContent}(t.kind))return null;t.value=t.value.toString()}return t}function vn(){if(void 0!==typeof XMLHttpRequest){var e=xt("XMLHttpRequest");if(e){var t=new e;return Boolean(Je(t.withCredentials)&&void 0!==typeof XDomainRequest)}}}function yn(e,t,i){var n=-1;if(!Je(e))if(t>0&&(32===t?n=8192:t<=13&&(n=t<<5)),function(e){return e>=0&&e<=9}(i))-1===n&&(n=0),n|=i;else{var r=un[bn(e)]||-1;-1!==n&&-1!==r?n|=r:r===ln.Double&&(n=r)}return n}function Cn(e,t,i){var n;return void 0===i&&(i=!0),e&&(n=e.get(t),i&&n&&decodeURIComponent&&(n=decodeURIComponent(n))),n||""}function _n(e){void 0===e&&(e="D");var t=Xi();return"B"===e?t="{"+t+"}":"P"===e?t="("+t+")":"N"===e&&(t=t.replace(/-/g,"")),t}function En(e,t,i,n,r){var s={},a=!1,o=0,c=arguments.length,l=arguments;for("[object Boolean]"===Object[B].toString.call(l[0])&&(a=l[0],o++);o<c;o++)tt(l[o],(function(e,t){a&&t&&Qe(t)?rt(t)?(s[e]=s[e]||[],lt(t,(function(t,i){t&&Qe(t)?s[e][i]=En(!0,s[e][i],t):s[e][i]=t}))):s[e]=En(!0,s[e],t):s[e]=t}));return s}var Tn=function(){var e=xt(Rt);return e&&e.now?e.now():ft()};function In(e,t){var i=e;i.timings=i.timings||{},i.timings.processTelemetryStart=i.timings.processTelemetryStart||{},i.timings.processTelemetryStart[t]=Tn()}function bn(e){var t=0;if(null!=e){var i=typeof e;"string"===i?t=1:"number"===i?t=2:"boolean"===i?t=3:i===F&&(t=4,rt(e)?(t=4096,e.length>0&&(t|=bn(e[0]))):function(e,t){return e&&z.call(e,t)}(e,"value")&&(t=8192|bn(e.value)))}return t}var An="version",Rn="properties",wn=function(e){function t(){var i=e.call(this)||this;return i.pluginVersionStringArr=[],i.pluginVersionString="",Ve(t,i,(function(e,t){e.initialize=function(i,n,r,s){ii(e,(function(){return"AppInsightsCore.initialize"}),(function(){if(i){i.endpointUrl||(i.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var a=i.propertyStorageOverride;if(a&&(!a.getProperty||!a.setProperty))throw new Error("Invalid property storage override passed.");i.channels&&lt(i.channels,(function(t){t&&lt(t,(function(t){if(t.identifier&&t.version){var i=t.identifier+"="+t.version;e.pluginVersionStringArr.push(i)}}))}))}e.getWParam=function(){return"undefined"!=typeof document?0:-1},n&&lt(n,(function(t){if(t&&t.identifier&&t.version){var i=t.identifier+"="+t.version;e.pluginVersionStringArr.push(i)}})),e.pluginVersionString=e.pluginVersionStringArr.join(";");try{t.initialize(i,n,r,s)}catch(t){e.logger.throwInternal(Ae.CRITICAL,dn.ErrorProvidedChannels,"Channels must be provided through config.channels only")}e.pollInternalLogs("InternalLog")}),(function(){return{config:i,extensions:n,logger:r,notificationManager:s}}))},e.track=function(i){ii(e,(function(){return"AppInsightsCore.track"}),(function(){var n=i;if(n){n.timings=n.timings||{},n.timings.trackStart=Tn(),function(e){return!!(e&&at(e)&&e>=sn&&e<=cn)}(n.latency)||(n.latency=sn);var r=n.ext=n.ext||{};r.sdk=r.sdk||{},r.sdk.ver=hn;var s=n.baseData=n.baseData||{};s[Rn]||(s[Rn]={});var a=s[Rn];a[An]||(a[An]=""),""!==e.pluginVersionString&&(a[An]=e.pluginVersionString)}t.track(n)}),(function(){return{item:i}}),!i.sync)}})),i}return Z(t,e),t}(Gi),Pn="function",Mn="object",Dn="undefined",On="prototype",kn="hasOwnProperty",Nn=Object,Ln=Nn[On],xn=Nn.assign,Un=Nn.create,Fn=Nn.defineProperty,Vn=Ln[kn];function Bn(){return typeof globalThis!==Dn&&globalThis?globalThis:typeof self!==Dn&&self?self:typeof window!==Dn&&window?window:typeof i.g!==Dn&&i.g?i.g:null}function Hn(e){throw new TypeError(e)}(Bn()||{}).Symbol,(Bn()||{}).Reflect;var $n,Gn=xn||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Ln[kn].call(t,r)&&(e[r]=t[r]);return e},jn=function(e,t){return jn=Nn.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t[kn](i)&&(e[i]=t[i])},jn(e,t)};function qn(e,t){function i(){this.constructor=e}typeof t!==Pn&&null!==t&&Hn("Class extends value "+String(t)+" is not a constructor or null"),jn(e,t),e[On]=null===t?function(e){if(Un)return Un(e);if(null==e)return{};var t=typeof e;function i(){}return t!==Mn&&t!==Pn&&Hn("Object prototype may only be an Object:"+e),i[On]=e,new i}(t):(i[On]=t[On],new i)}!function(e){e[e.CRITICAL=1]="CRITICAL",e[e.WARNING=2]="WARNING"}($n||($n={}));var Wn={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},zn=Fn;function Jn(e){return void 0===e||typeof e===Dn}function Kn(e){return null===e||Jn(e)}function Yn(e){return typeof e===Pn}function Qn(e,t){return!(!e||!t)&&-1!==e.indexOf(t)}function Xn(e){return"[object Array]"===function(e){return Ln.toString.call(e)}(e)}function Zn(e,t,i){for(var n=e.length,r=0;r<n&&(!(r in e)||-1!==t.call(i||e,e[r],r,e));r++);}var er=!{toString:null}.propertyIsEnumerable("toString"),tr=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function ir(){var e=Date;return e.now?e.now():(new e).getTime()}var nr="window",rr="navigator",sr="performance",ar="JSON",or="crypto",cr="msCrypto",lr="msie",dr="trident/",hr=null,ur=null;function gr(e){var t=Bn();return t&&t[e]?t[e]:e===nr&&pr()?window:null}function pr(){return Boolean(typeof window===Mn&&window)}function mr(){return Boolean(typeof navigator===Mn&&navigator)?navigator:gr(rr)}function fr(){return Boolean(typeof JSON===Mn&&JSON||null!==gr(ar))}function Sr(e){return e?'"'+e.replace(/\"/g,"")+'"':""}var vr=function(){function e(e,t,i,n){void 0===i&&(i=!1);var r=this;r.messageId=e,r.message=(i?"AI: ":"AI (Internal): ")+e;var s="";fr()&&(s=(fr()?JSON||gr(ar):null).stringify(n));var a=(t?" message:"+Sr(t):"")+(n?" props:"+Sr(s):"");r.message+=a}return e.dataType="MessageData",e}();var yr=function e(t){this.identifier="DiagnosticLogger",this.queue=[];var i=0,n={};Ve(e,this,(function(e){function r(e,i){var n=t[e];return Kn(n)?i:n}Kn(t)&&(t={}),e.consoleLoggingLevel=function(){return r("loggingLevelConsole",0)},e.telemetryLoggingLevel=function(){return r("loggingLevelTelemetry",1)},e.maxInternalMessageLimit=function(){return r("maxMessageLimit",25)},e.enableDebugExceptions=function(){return r("enableDebugExceptions",!1)},e.throwInternal=function(t,i,r,s,a){void 0===a&&(a=!1);var o=new vr(i,r,a,s);if(e.enableDebugExceptions())throw o;if(!Jn(o)&&o&&!Jn(o.message)){var c=e.consoleLoggingLevel();if(a){var l=+o.messageId;!n[l]&&c>=$n.WARNING&&(e.warnToConsole(o.message),n[l]=!0)}else c>=$n.WARNING&&e.warnToConsole(o.message);e.logInternalMessage(t,o)}},e.warnToConsole=function(e){var t=typeof console!==Dn?console:gr("console");if(t){var i="log";t.warn&&(i="warn"),Yn(t[i])&&t[i](e)}},e.resetInternalMessageCount=function(){i=0,n={}},e.logInternalMessage=function(t,r){if(!(i>=e.maxInternalMessageLimit())){var s=!0,a="AITR_"+r.messageId;if(n[a]?s=!1:n[a]=!0,s&&(t<=e.telemetryLoggingLevel()&&(e.queue.push(r),i++),i===e.maxInternalMessageLimit())){var o="Internal events throttle limit per PageView reached for this app.",c=new vr(Wn.MessageLimitPerPVExceeded,o,!1);e.queue.push(c),e.warnToConsole(o)}}}}))},Cr="ctx",_r=function(){function e(t,i,n){var r,s=this,a=!1;s.start=ir(),s.name=t,s.isAsync=n,s.isChildEvt=function(){return!1},Yn(i)&&(a=function(e,t,i,n){if(zn)try{var r={enumerable:!0,configurable:!0};return i&&(r.get=i),n&&(r.set=n),zn(e,t,r),!0}catch(e){}return!1}(s,"payload",(function(){return!r&&Yn(i)&&(r=i(),i=null),r}))),s.getCtx=function(t){return t?t===e.ParentContextKey||t===e.ChildrenContextKey?s[t]:(s[Cr]||{})[t]:null},s.setCtx=function(t,i){t&&(t===e.ParentContextKey?(s[t]||(s.isChildEvt=function(){return!0}),s[t]=i):t===e.ChildrenContextKey?s[t]=i:(s[Cr]=s[Cr]||{})[t]=i)},s.complete=function(){var t=0,n=s.getCtx(e.ChildrenContextKey);if(Xn(n))for(var r=0;r<n.length;r++){var o=n[r];o&&(t+=o.time)}s.time=ir()-s.start,s.exTime=s.time-t,s.complete=function(){},!a&&Yn(i)&&(s.payload=i())}}return e.ParentContextKey="parent",e.ChildrenContextKey="childEvts",e}(),Er="CoreUtils.doPerf";function Tr(e,t,i,n,r){if(e){var s=e;if(s&&Yn(s.getPerfMgr)&&(s=s.getPerfMgr()),s){var a=void 0,o=s.getCtx(Er);try{if(a=s.create(t(),n,r)){if(o&&a.setCtx&&(a.setCtx(_r.ParentContextKey,o),o.getCtx&&o.setCtx)){var c=o.getCtx(_r.ChildrenContextKey);c||(c=[],o.setCtx(_r.ChildrenContextKey,c)),c.push(a)}return s.setCtx(Er,a),i(a)}}catch(e){a&&a.setCtx&&a.setCtx("exception",e)}finally{a&&s.fire(a),s.setCtx(Er,o)}}}return i()}var Ir=function(e,t){var i=this,n=null,r=Yn(e.processTelemetry),s=Yn(e.setNextPlugin);i._hasRun=!1,i.getPlugin=function(){return e},i.getNext=function(){return n},i.setNext=function(e){n=e},i.processTelemetry=function(a,o){o||(o=t);var c=e?e.identifier:"TelemetryPluginChain";Tr(o?o.core():null,(function(){return c+":processTelemetry"}),(function(){if(e&&r){i._hasRun=!0;try{o.setNext(n),s&&e.setNextPlugin(n),n&&(n._hasRun=!1),e.processTelemetry(a,o)}catch(i){var t=n&&n._hasRun;n&&t||o.diagLog().throwInternal($n.CRITICAL,Wn.PluginException,"Plugin ["+e.identifier+"] failed during processTelemetry - "+i),n&&!t&&n.processTelemetry(a,o)}}else n&&(i._hasRun=!0,n.processTelemetry(a,o))}),(function(){return{item:a}}),!a.sync)}};function br(e,t){var i=[];if(e&&e.length>0)for(var n=null,r=0;r<e.length;r++){var s=e[r];if(s&&Yn(s.processTelemetry)){var a=new Ir(s,t);i.push(a),n&&n.setNext(a),n=a}}return i.length>0?i[0]:null}var Ar=function e(t,i,n,r){var s=this,a=null;null!==r&&(t&&Yn(t.getPlugin)?a=function(e,t,i){var n=[],r=!i;if(e)for(;e;){var s=e.getPlugin();(r||s===i)&&(r=!0,n.push(s)),e=e.getNext()}return r||n.push(i),br(n,t)}(t,s,r||t.getPlugin()):r?a=function(e,t,i){var n=e,r=!1;return i&&e&&(n=[],Zn(e,(function(e){(r||e===i)&&(r=!0,n.push(e))}))),i&&!r&&(n||(n=[]),n.push(i)),br(n,t)}(t,s,r):Jn(r)&&(a=br(t,s))),s.core=function(){return n},s.diagLog=function(){return function(e,t){return(e||{}).logger||new yr(t)}(n,i)},s.getCfg=function(){return i},s.getExtCfg=function(e,t){var n;if(void 0===t&&(t={}),i){var r=i.extensionConfig;r&&e&&(n=r[e])}return n||t},s.getConfig=function(e,t,n){var r;void 0===n&&(n=!1);var a=s.getExtCfg(e,null);return a&&!Kn(a[t])?r=a[t]:i&&!Kn(i[t])&&(r=i[t]),Kn(r)?n:r},s.hasNext=function(){return null!=a},s.getNext=function(){return a},s.setNext=function(e){a=e},s.processNext=function(e){var t=a;t&&(a=t.getNext(),t.processTelemetry(e,s))},s.createNew=function(t,r){return void 0===t&&(t=null),new e(t||a,i,n,r)}},Rr="getPlugin",wr=function(){function e(){var e=this,t=!1,i=null,n=null;e.core=null,e.diagLog=function(t){return e._getTelCtx(t).diagLog()},e.isInitialized=function(){return t},e.setInitialized=function(e){t=e},e.setNextPlugin=function(e){n=e},e.processNext=function(e,t){t?t.processNext(e):n&&Yn(n.processTelemetry)&&n.processTelemetry(e,null)},e._getTelCtx=function(t){void 0===t&&(t=null);var r=t;if(!r){var s=i||new Ar(null,{},e.core);r=n&&n[Rr]?s.createNew(null,n[Rr]):s.createNew(null,n)}return r},e._baseTelInit=function(r,s,a,o){r&&function(e,t,i,n,r){var s=i;e&&((s=e[t])===i||r&&!r(s)||n&&!n(i)||(s=i,e[t]=s))}(r,"extensionConfig",[],null,Kn),!o&&s&&(o=s.getProcessTelContext().getNext());var c=n;n&&n[Rr]&&(c=n[Rr]()),e.core=s,i=new Ar(o,r,s,c),t=!0}}return e.prototype.initialize=function(e,t,i,n){this._baseTelInit(e,t,i,n)},e}(),Pr=4294967296,Mr=4294967295,Dr=!1,Or=123456789,kr=987654321;function Nr(){try{var e=2147483647&ir();!function(e){e<0&&(e>>>=0),Or=123456789+e&Mr,kr=987654321-e&Mr,Dr=!0}((Math.random()*Pr^e)+e)}catch(e){}}function Lr(e){return e>0?Math.floor(function(e){var t,i=gr(or)||gr(cr);return i&&i.getRandomValues?t=i.getRandomValues(new Uint32Array(1))[0]&Mr:function(){var e=mr();if(e&&(e.userAgent!==ur||null===hr)){var t=((ur=e.userAgent)||"").toLowerCase();hr=Qn(t,lr)||Qn(t,dr)}return hr}()?(Dr||Nr(),t=function(e){var t=((kr=36969*(65535&kr)+(kr>>16)&Mr)<<16)+(65535&(Or=18e3*(65535&Or)+(Or>>16)&Mr))>>>0&Mr;return e||(t>>>=0),t}()&Mr):t=Math.floor(Pr*Math.random()|0),e||(t>>>=0),t}()/Mr*(e+1))>>>0:0}function xr(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(Fr,(function(e){var t=0|Lr(15);return("x"===e?t:3&t|8).toString(16)}))}var Ur,Fr=/[xy]/g,Vr=0,Br=1,Hr=6,$r=7,Gr=1,jr=2;function qr(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return""}Gn(Gn({},Wn),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),(Ur={})[0]=Vr,Ur[2]=Hr,Ur[1]=Br,Ur[3]=$r,Ur[4098]=Hr,Ur[4097]=Br,Ur[4099]=$r,Boolean(Boolean(typeof document===Mn&&document)?document:gr("document")),Boolean(pr()?window:gr(nr));var Wr=function(){var e=gr(sr);return e&&e.now?e.now():ir()};var zr=Yn;function Jr(e,t,i){return function(n){e[t]=n,i()}}var Kr=function(){function e(t){var i=0,n=null,r=[];function s(t,s,o,c){r.push((function(){var r;try{(r=1===i?zr(t)?t(n):n:zr(s)?s(n):n)instanceof e?r.then(o,c):2!==i||zr(s)?o(r):c(r)}catch(e){return void c(e)}})),0!==i&&a()}function a(){if(r.length>0){var e=r.slice();r=[],setTimeout((function(){for(var t=0,i=e.length;t<i;++t)try{e[t]()}catch(e){}}),0)}}function o(e){0===i&&(n=e,i=1,a())}function c(e){0===i&&(n=e,i=2,a())}Ve(e,this,(function(t){t.then=function(t,i){return new e((function(e,n){s(t,i,e,n)}))},t.catch=function(e){return t.then(null,e)}})),function(){if(!zr(t))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{t(o,c)}catch(e){c(e)}}()}return e.resolve=function(t){return t instanceof e?t:t&&zr(t.then)?new e((function(e,i){try{t.then(e,i)}catch(e){i(e)}})):new e((function(e){e(t)}))},e.reject=function(t){return new e((function(e,i){i(t)}))},e.all=function(t){if(t&&t.length)return new e((function(e,i){try{for(var n=[],r=0,s=0;s<t.length;s++){var a=t[s];a&&zr(a.then)?(r++,a.then(Jr(n,s,(function(){0==--r&&e(n)})),i)):n[s]=a}0===r&&setTimeout((function(){e(n)}),0)}catch(e){i(e)}}))},e.race=function(t){return new e((function(e,i){if(t&&t.length)try{for(var n=function(n){var r=t[n];r&&zr(r.then)?r.then(e,i):setTimeout((function(){e(r)}),0)},r=0;r<t.length;r++)n(r)}catch(e){i(e)}}))},e}(),Yr=0,Qr=[],Xr=[],Zr=[];function es(){return(new Date).getTime()}var ts,is=function(){function e(t,i){var n=0,r=(t||"<unnamed>")+"."+Yr;function s(e){var t=Bn();t&&t.QUnit&&console&&console.log("ESPromiseScheduler["+r+"] "+e)}function a(e){i&&i.warnToConsole("ESPromiseScheduler["+r+"] "+e)}Yr++,Ve(e,this,(function(e){var t=null,i=0;function o(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return e.splice(i,1)[0];return null}e.scheduleEvent=function(e,c,l){var d=r+"."+i;i++,c&&(d+="-("+c+")");var h=d+"{"+n+"}";n++;var u={evt:null,tm:es(),id:h,isRunning:!1,isAborted:!1};return u.evt=t?function(e,t){var i=new Kr((function(i,n){var r=es()-t.tm,a=t.id;s("["+d+"] is waiting for ["+a+":"+r+" ms] to complete before starting -- ["+Xr.length+"] waiting and ["+Qr.length+"] running"),e.abort=function(t){e.abort=null,o(Xr,d),e.isAborted=!0,n(new Error(t))},t.evt.then((function(t){o(Xr,d),v(e).then(i,n)}),(function(t){o(Xr,d),v(e).then(i,n)}))}));return Xr.push(e),i}(u,t):v(u),(t=u).evt._schId=h,u.evt;function g(e){for(var t=es(),i=t-6e5,n=e.length,r=0;r<n;){var s=e[r];if(s&&s.tm<i){var o=null;s.abort?(o="Aborting ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",s.abort(o)):o="Removing ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",a(o),e.splice(r,1),n--}else r++}}function p(e,i){var n=!1,r=o(Qr,e);if(r||(r=o(Zr,e),n=!0),r){r.to&&(clearTimeout(r.to),r.to=null);var c=es()-r.tm;i?n?a("Timed out event ["+e+"] finally complete -- "+c+" ms"):s("Promise ["+e+"] Complete -- "+c+" ms"):(Zr.push(r),a("Event ["+e+"] Timed out and removed -- "+c+" ms"))}else s("Failed to remove ["+e+"] from running queue");t&&t.id===e&&(t=null),g(Qr),g(Xr),g(Zr)}function m(e,t){return function(i){return p(e,!0),t&&t(i),i}}function f(e,t,i,n){t.then((function(t){return t instanceof Kr?(s("Event ["+e+"] returned a promise -- waiting"),f(e,t,i,n),t):m(e,i)(t)}),m(e,n))}function S(e,t){var i=e.id;return new Kr((function(n,r){s("Event ["+i+"] Starting -- waited for "+(e.wTm||"--")+" ms"),e.isRunning=!0,e.abort=function(t){e.abort=null,e.isAborted=!0,p(i,!1),r(new Error(t))};var a=t(i);a instanceof Kr?(l&&(e.to=setTimeout((function(){p(i,!1),r(new Error("Timed out after ["+l+"] ms"))}),l)),f(i,a,(function(t){s("Event ["+i+"] Resolving after "+(es()-e.tm)+" ms"),n(t)}),r)):(s("Promise ["+i+"] Auto completed as the start action did not return a promise"),n())}))}function v(t){var i=es();return t.wTm=i-t.tm,t.tm=i,t.isAborted?Kr.reject(new Error("["+d+"] was aborted")):(Qr.push(t),S(t,e))}}}))}return e.incomplete=function(){return Qr},e.waitingToStart=function(){return Xr},e}();function ns(e){return function(e){return"number"==typeof e}(e)&&e>=Gr&&e<=jr}!function(e){e[e.LocalStorage=1]="LocalStorage",e[e.SessionStorage=2]="SessionStorage",e[e.IndexedDb=3]="IndexedDb"}(ts||(ts={}));var rs="AWTEvents";function ss(e){var t=Bn()||{},i=null;try{if(i=t[e]){var n="__storage_test__";i.setItem(n,n),i.removeItem(n)}}catch(e){(function(e,t){var i=!1;return t instanceof DOMException&&(22!==t.code&&"QuotaExceededError"!==t.name&&1014!==t.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||e&&0!==e.length&&(i=!0)),i})(i,e)||(i=null)}return i}function as(e,t){if(e)for(var i=function(e){var t=typeof e;t===Pn||t===Mn&&null!==e||Hn("objKeys called on non-object");var i=[];for(var n in e)e&&Vn.call(e,n)&&i.push(n);if(er)for(var r=tr.length,s=0;s<r;s++)e&&Vn.call(e,tr[s])&&i.push(tr[s]);return i}(e),n=0;n<i.length;n++){var r=i[n];if(!t(e[r],r))break}}function os(e){var t=!0;return as(e,(function(e,i){return e&&(t=!1),t})),t}function cs(e,t){for(var i=1,n=0,r=function(){var e=[],r=t[i];if(as(r,(function(t,i){return e.push(i),++n<10})),n>0){for(var s=0;s<e.length;s++)delete r[e[s]];return{value:!0}}i++};i<=e&&n<10;){var s=r();if("object"==typeof s)return s.value}return n>0}var ls=ns,ds=function e(t,i){Ve(e,this,(function(e){var n=null,r=rs,s=null,a=null,o=null,c=5e6,l=null,d=null;function h(e,t){return{key:e,db:t}}function u(e,t){void 0===t&&(t=!0);var i=null;if(n){var r=n.getItem(e);if(r)try{i=JSON.parse(r)}catch(t){n.removeItem(e)}}return t&&!i&&(i={events:{1:{},2:{},3:{}},lastAccessTime:0}),h(e,i)}function g(e,t){void 0===t&&(t=!0);var i=!0,r=e.db;if(r){t&&(r.lastAccessTime=(new Date).getTime());for(var s=1;s<=2;s++)if(!os(r.events[s])){i=!1;break}}try{if(i)n&&n.removeItem(e.key);else{var a=JSON.stringify(r);if(a.length>c)return!1;n&&n.setItem(e.key,a)}}catch(e){return!1}return!0}function p(e){var t=[],i=u(e,!1),r=i.db;if(r){var s=r.events;try{for(var a=1;a<=2;a++)as(s[a],(function(e,i){return e&&t.push(e),!0}))}catch(e){}n&&n.removeItem(i.key)}return t}e.id=i,n=ss(t)||null,e.initialize=function(t){if(!n)return!1;var i=t.storageConfig||{};return c=i.maxStorageSizeInBytes>0?i.maxStorageSizeInBytes:c,r=i.storageKey||rs,s=e.id||t.id||xr(),d=r+"."+s,l=r+"Version",a=t.itemCtx.getCfg().instrumentationKey,o=qr(a)||a,function(){if(n){for(var e=n.getItem(l),t=[],i=u(d),s=!1,a=0;a<n.length;a++){var c=n.key(a);if(0===c.indexOf(r)&&c!==l){if("3"!==e){t.push(h(c,null));continue}var p=u(c,!1),m=p.db;if(m){if((new Date).getTime()-m.lastAccessTime>6e5){for(var f=1,S=function(){var e=m.events[f],t=i.db.events[f];as(e,(function(i,n){return(qr(i.iKey)||i.iKey)===o&&(t[n]=i,delete e[n]),!0})),f++};f<=2;)S();s=!0,t.push(p)}}else t.push(h(c,null))}}for(a=0;a<t.length;a++)g(t[a],!1);s&&g(i),n.setItem(l,"3")}}(),!0},e.supportsSyncRequests=function(){return!0},e.getAllEvents=function(){try{var e=[],t=u(d,!1).db;if(t)for(var i=t.events,n=2;n>=1;n--)as(i[n],(function(t){return t&&(qr(t.iKey)||t.iKey)===o&&e.push(t),!0}));return Kr.resolve(e)}catch(e){return Kr.reject(e)}},e.addEvent=function(e,t,i){try{var n=u(d);t.id=t.id||xr(),ls(t.persistence)||(t.persistence=1);for(var r=t.persistence,s=t.id,a=n.db.events;;){if(a[r][s]=t,g(n))return Kr.resolve(t);if(delete a[r][s],!cs(r,a))return Kr.reject(new Error("Unable to free up event space"))}}catch(e){return Kr.reject(e)}},e.removeEvents=function(e){try{var t=u(d,!1),i=t.db;if(i){var n=i.events;try{for(var r=0;r<e.length;++r){var s=e[r];delete n[s.persistence][s.id]}if(g(t))return Kr.resolve(e)}catch(e){}e=p(t.key)}return Kr.resolve(e)}catch(e){return Kr.reject(e)}},e.clear=function(){try{var e=[],t=u(d,!1),i=t.db;if(i){for(var n=i.events,r=function(t){var i=n[t];as(i,(function(t){return t&&(qr(t.iKey)||t.iKey)===o&&(delete i[t.id],e.push(t)),!0}))},s=2;s>=1;s--)r(s);g(t)}return Kr.resolve(e)}catch(e){return Kr.reject(e)}},e.teardown=function(){try{var e=u(d,!1),t=e.db;t&&(t.lastAccessTime=0,g(e,!1))}catch(e){}}}))},hs="result",us="DBError: Unable to open database",gs="Database is not open",ps="DBError: Failed to delete the database",ms=["indexedDB"],fs=Yn,Ss=function(e){return"string"==typeof e};function vs(e,t){gr("QUnit")&&console&&console.log("IndexedDbHelper ["+e+"] "+t)}function ys(e,t,i){e&&e.warnToConsole("IndexedDbHelper ["+t+"] "+i)}function Cs(e,t,i,n){return function(r){i(new Error(t)),vs(e,"["+n+"] event rejected")}}var _s=[];function Es(e,t){for(var i=null,n=0;n<_s.length;n++)if((i=_s[n]).name===e)return i;return i={name:e,sch:new is("IndexedDbHelper["+e+"]",t),dbHdl:[],add:function(t){i.dbHdl.push(t),vs(e,"- dbOpened (add) -- hdls ["+i.dbHdl.length+"]")},remove:function(t){for(var n=i.dbHdl,r=0;r<n.length;r++)if(n[r]===t){n.splice(r,1);break}vs(e,"- dbClosed (remove) -- hdls ["+i.dbHdl.length+"]")},isOpen:function(){return i.dbHdl.length>0},openHdl:function(){return i.dbHdl.length>0?i.dbHdl[0]:null}},_s.push(i),i}var Ts=function e(t){Ve(e,this,(function(e){var i=function(){var e=Bn()||{},t=null;if(e)try{for(var i=0;i<ms.length;i++)if((t=e[ms[i]])&&fs(t.open))return t}catch(e){t=null}return t||null}()||null;function n(e,i){var n=e.db.transaction(i,"readwrite");return n.onabort=function(){ys(t,e.dbName,"txn.onabort")},n.onerror=function(){ys(t,e.dbName,"txn.onerror")},n.oncomplete=function(){vs(e.dbName,"txn.oncomplete")},{db:e,store:n.objectStore(i),tx:n,tbl:i,openCursor:function(t,n){return s(e,i,t,n)},newTransaction:function(t){return r(e,i,t)}}}function r(e,t,i){if(!e||!e.db)return Kr.reject(new Error(gs));try{var r=i(n(e,t));return r instanceof Kr?r:Kr.resolve(r)}catch(e){return Kr.reject(e)}}function s(e,t,i,r){if(!e||!e.db)return Kr.reject(new Error(gs));var s=null;return i&&Ss(i)?s=new Is(i):i&&i.isMatch&&(s=i),new Kr((function(i,a){var o=[],c=null,l=null;s&&s.keyRange&&(l=s.keyRange());var d=n(e,t);(c=l?d.store.openCursor(l):d.store.openCursor()).onerror=Cs(d.db.dbName,"DBError: Failed to Open Cursor",a,"openCursor"),c.onsuccess=function(e){var t=e.target[hs];if(t){var n={store:d,cursor:t,continue:function(){t.continue()},done:function(){i(o)}},c=t.value;if(!s||s.isMatch(c))if(r)try{switch(r(n,c,o)){case 2:i(o);break;case 1:break;default:n.continue()}}catch(e){a(e)}else o.push(c),n.continue();else n.continue()}else i(o)}}))}function a(e,t,i,n){return Es(e).sch.scheduleEvent(i,t,n)}e.isAvailable=function(){return!!i},e.openDb=function(e,n,o,c){return a(e,"openDb",(function(a){return new Kr((function(l,d){var h=!1;function u(t,i,a,o,c){var l={db:i,dbName:e,dbVersion:n,ctx:null,isNew:o,txn:a?a.transaction:null};return c||(l.openStore=function(e,t){return r(l,e,t)},l.openCursor=function(e,t,i){return s(l,e,t,i)}),l}function g(i,n){var r=Es(e);r.add(i),i.onabort=function(n){ys(t,e,"onabort -- closing the Db"),r.remove(i)},i.onerror=function(n){ys(t,e,"onerror -- closing the Db"),r.remove(i)},i.onclose=function(n){ys(t,e,"onclose -- closing the Db"),r.remove(i)},i.onversionchange=function(n){ys(t,e,"onversionchange -- force closing the Db"),i.close(),r.remove(i)};var s,a=null;r.dbHdl.length>0&&(a=r.dbHdl[0]),s=u(0,a,n,h);try{o(s).then((function(e){l(e)}),d)}catch(e){d(e)}}var p=Es(e);if(null==i)d(new Error("No available storage factory"));else if(p.isOpen()){var m=u(0,p.openHdl(),null,!1);o(m).then(l,d)}else{var f=i.open(e,n);f.onblocked=function(i){ys(t,e,"Db Open Blocked event ["+a+"] - "+(f.error||"")),d(new Error(us))},f.onerror=function(i){ys(t,e,"Db Open Error event ["+a+"] - "+(f.error||"")),d(new Error(us))},f.onupgradeneeded=function(t){vs(e,"Db Open Create/Upgrade needed event ["+a+"]");try{var i=t.target[hs];if(!i)return void d(new Error(us));!function(e,t){var i=u(0,e,t,!0,!0);if(c)h=!0,c(i).then((function(){i.txn||(i.txn=t.transaction)}),(function(e){try{t.transaction&&t.transaction.abort()}finally{d(e)}}));else try{t.transaction&&t.transaction.abort()}finally{d(new Error("DBError: Database upgrade required"))}}(i,f)}catch(t){Cs(e,us,d,a)(t)}},f.onsuccess=function(e){var t=e.target[hs];t?g(t,f):d(new Error(us))}}}))}))},e.closeDb=function(e){a(e,"closeDb",(function(t){var i=Es(e),n=i.dbHdl,r=n.length;if(r>0){for(var s=0;s<r;s++)n[s].close();i.dbHdl=[]}return Kr.resolve(1)}))},e.deleteDb=function(e){return null==i?Kr.resolve(!1):a(e,"deleteDb",(function(n){var r=Es(e),s=r.dbHdl,a=s.length;if(a>0){ys(t,e,"Db is open ["+a+"] force closing");for(var o=0;o<a;o++)s[o].close();r.dbHdl=[]}return new Kr((function(r,s){setTimeout((function(){try{vs(e,"["+n+"] starting");var a=i.deleteDatabase(e);a.onerror=function(i){ys(t,e,"["+n+"] error!!"),s(new Error(ps))},a.onblocked=function(i){ys(t,e,"["+n+"] blocked!!"),s(new Error(ps))},a.onupgradeneeded=function(i){ys(t,e,"["+n+"] upgrade needed!!"),s(new Error(ps))},a.onsuccess=function(t){vs(e,"["+n+"] complete"),r(!0)},vs(e,"["+n+"] started")}catch(i){ys(t,e,"["+n+"] threw - "+i),s(new Error(ps+" - "+i))}}),0)}))}))},e.getDbDetails=function(e){return a(e,"getDbDetails",(function(t){return null!=i&&i.databases?new Kr((function(t,n){i.databases().then((function(i){for(var r=0;r<i.length;r++)if(i[r].name===e)return void t(i[r]);n(new Error("DBError: Database does not exist"))}),n)})):Kr.reject(new Error("DBError: Feature not supported"))}),2e3)}}))},Is=function e(t){var i=[],n=null;Ve(e,this,(function(e){e.keyRange=function(){return n},e.parseQuery=function(t){if(i=[],t)for(var r=t.split(";"),s=0;s<r.length;s++){var a=r[s],o=a.indexOf("=");if(-1!==o){var c=a.substring(0,o),l=a.substring(o+1);0===c.indexOf("#")&&(c=c.substring(1),n||(n=IDBKeyRange.bound(l,l+""))),e.startsWith(c,l)}}},e.startsWith=function(e,t){i.push({name:e,value:t,type:0})},e.contains=function(e,t){i.push({name:e,value:t,type:1})},e.isMatch=function(e){if(!i||0===i.length)return!0;if(!e)return!1;for(var t=0;t<i.length;t++){var n=i[t],r=e[n.name];if(r)if(0===n.type){if(0!==r.indexOf(n.value))return!1}else if(1===n.type&&-1===r.indexOf(n.value))return!1}return!0},t&&e.parseQuery(t)}))},bs=6e5,As=1008e4,Rs="DBError: Unable to add event",ws="Evts",Ps="iKey",Ms=ns;function Ds(){return(new Date).getTime()}function Os(e){return e.openStore(Ps,(function(t){return new Kr((function(i,n){var r={iKey:e.ctx.iKey,tm:Ds()},s=t.store.put(r);s.onsuccess=function(e){i(s.result.toString())},s.onerror=function(e){n(new Error(Rs))},s.onerror=function(e,t){return function(i){return t(new Error(e))}}("DBError: Unable to update iKey",n)}))}))}function ks(e){for(var t=[],i=jr;i>=Gr;i--)for(var n=0;n<e.length;n++){var r=e[n];r&&r.evt.persistence===i&&t.push(r.evt)}return t}function Ns(e){return function(t){return e.continue()}}function Ls(e){var t=e.cursor.delete();return t.onerror=Ns(e),t.onsuccess=Ns(e),1}function xs(e,t,i){return e.openCursor(ws,t,(function(e,t,n){return i(t)?(n.push(t),Ls(e)):0}))}function Us(e){return e.openCursor(ws,"#key="+e.ctx.iKeyPrefix(),(function(t,i){var n=i.key;if(0===n.indexOf(e.ctx.iKeyPrefix())&&-1===n.indexOf(e.ctx.evtKeyPrefix())&&function(e,t){var i=e.tm;return Ds()-i>t}(i,bs)){i.key=e.ctx.evtKeyPrefix()+i.id;var r=t.store.store.put(i);return r.onerror=Ns(t),r.onsuccess=function(e){try{Ls(t)}catch(e){t.continue()}},1}return 0}))}function Fs(e){return new Kr((function(t,i){(function(e){return new Kr((function(t,i){var n=!1;e.openCursor(Ps,null,(function(e,t,i){var r=t.tm;return Ds()-r<As?0:(n=!0,2)})).then((function(){if(n){var r={};xs(e,null,(function(e){if(!e||!e.evt||!e.evt.iKey)return!0;var t=e.tm;return Ds()-t>As||(r[e.evt.iKey]=1,!1)})).then((function(){var n=[];e.openCursor(Ps,null,(function(e,t,i){var s=t.tm;return Ds()-s<As||r[t.iKey]?0:(n.push(t),Ls(e))})).then((function(){t(n)}),i)}),i)}else t([])}),i)}))})(e).then((function(){Us(e).then(t,t)}),i)}))}var Vs=function e(t){Ve(e,this,(function(e){var i=null,n=null,r="Unknown",s=null,a=null,o=null,c=-1,l=0;function d(e){return i.openDb(n,1,(function(t){return new Kr((function(i,n){var c={iKey:r,storageId:s,iKeyPrefix:function(){return a},evtKeyPrefix:function(){return o}};t.ctx=c,Os(t).then((function(){e(t).then(i,n)}),n)}))}),(function(e){return new Kr((function(t,i){(function(e){e.objectStoreNames.contains(ws)||e.createObjectStore(ws,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1}),e.objectStoreNames.contains(Ps)||e.createObjectStore(Ps,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})})(e.db),t()}))}))}function h(e,t,i){return new Kr((function(n,r){function s(t,i){(function(e,t){return new Kr((function(i,n){var r=0,s=e.ctx.evtKeyPrefix();function a(){i(r)}function o(e,t){return new Kr((function(i){var n=e.store.delete(t.key);n.onsuccess=function(e){r++,i()},n.onerror=function(e){i()}}))}e.openCursor(ws,"#key="+s,(function(e,i,n){return i.evt.persistence<=t&&0===i.key.indexOf(s)&&(function(e,t){for(var i=0;i<e.length;i++)if(t.tm<e[i].tm)return void e.splice(i,0,t);e.push(t)}(n,i),n.length>10&&n.splice(n.length-1,1)),0})).then((function(t){0!==t.length?e.openStore(ws,(function(e){for(var i=[],n=0;n<t.length;n++)i.push(o(e,t[n]));return Kr.all(i).then(a,a)})):a()}),(function(){i(0)}))}))})(e,t).then((function(e){e>0&&(l-=e),i(e)}),(function(e){i(0)}))}function a(e){n(t.evt)}function o(){e.openStore(ws,(function(o){var c=o.store.put(t);c.onsuccess=function(r){i&&Os(e).then(a,a),l++,n(t.evt)},c.onerror=function(a){function o(i){0===i&&r(new Error(Rs)),h(e,t,!1).then((function(e){n(t.evt)}),(function(){r(new Error(Rs))}))}i?s(Gr,(function(e){e>0?o(e):t.evt.persistence>=jr?s(jr,(function(e){o(e)})):r(new Error(Rs))})):r(new Error(Rs))}}))}c>0&&l>=c?s(Gr,(function(e){0===e?t.evt.persistence>=jr?s(jr,(function(e){o()})):r(new Error(Rs)):o()})):o()}))}e.id=t,e.initialize=function(t){var l=t.itemCtx.diagLog();if(!(i=new Ts(l)).isAvailable())return i=null,!1;var h=t.itemCtx.getCfg(),u=t.storageConfig||{};return n=u.indexedDbName||"AppInsightEvents.1",r=h.instrumentationKey||r,s=e.id||t.id||xr(),o=(a=r+"::")+s+"::",c=u.maxStorageItems>0?u.maxStorageItems:c,d((function(e){return e.isNew?Kr.resolve(!0):Fs(e)})).then((function(e){}),(function(e){l.warnToConsole("IndexedDbProvider failed to initialize - "+(e||"<unknown>")),i=null})),!0},e.supportsSyncRequests=function(){return!1},e.getAllEvents=function(){return null!=i&&i.isAvailable()?d((function(e){return new Kr((function(t,i){(function(e,t){return e.openCursor(ws,t,(function(e,t,i){return i.push(t),0}))})(e,"#key="+e.ctx.evtKeyPrefix()).then((function(e){l=e.length,t(ks(e))}),i)}))})):Kr.resolve([])},e.addEvent=function(e,t,n){return null!=i&&i.isAvailable()?(t.id=t.id||xr(),Ms(t.persistence)||(t.persistence=Gr),d((function(i){var n=e||t.id,r={key:i.ctx.evtKeyPrefix()+n,id:n,evt:t,tm:Ds(),v:1};return h(i,r,!0)}))):Kr.resolve(t)},e.removeEvents=function(e){if(null==i||!i.isAvailable())return Kr.resolve([]);var t=[];return new Kr((function(i,n){d((function(i){return i.openCursor(ws,"#key="+i.ctx.iKey,(function(i,n,r){if(-1!==function(e,t){for(var i=t.length,n=0;n<i;n++)if(e===t[n].id)return n;return-1}(n.id,e)){var s=i.cursor.delete();return s.onerror=Ns(i),s.onsuccess=function(){t.push(n.evt),i.continue()},1}return 0}))})).then((function(e){l-=t.length,i(t)}),(function(e){l-=t.length,i(t)}))}))},e.clear=function(){return null!=i&&i.isAvailable()?new Kr((function(e,t){d((function(e){return xs(e,"#key="+e.ctx.evtKeyPrefix(),(function(t){return 0===t.key.indexOf(e.ctx.evtKeyPrefix())}))})).then((function(t){l=0,e(ks(t))}),t)})):Kr.resolve([])},e.teardown=function(){i&&i.closeDb(n)}}))},Bs=ns,Hs=function(e){function t(){var i=e.call(this)||this;return i.identifier="LocalStorage",i.priority=1009,i.version="3.1.3",Ve(t,i,(function(e,t){var i=!1,n=!1,r=null,s=[];function a(e,t){r||(r=new is("LocalStorage")),r.scheduleEvent((function(e){return t(e)}),e)}function o(t){Tr(e.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){a("sendToNext",(function(i){return t.provider.getAllEvents().then((function(i){for(var n=0;n<i.length;n++)try{var r=i[n];(qr(r.iKey)||r.iKey)===t.tenantId&&e.processNext(r,t.coreRootCtx.createNew())}catch(e){}}))}))}),(function(){return{iKeyConfig:t}}))}function c(t,i){Tr(e.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){a("removeEvents",(function(e){var n=[];return Zn(i,(function(e){(qr(e.iKey)||e.iKey)===t.tenantId&&n.push(e)})),n.length>0?t.provider.removeEvents(n).then((function(e){})).catch((function(e){})):Kr.resolve()}))}),(function(){return{iKeyConfig:t,events:i}}))}function l(e){var t=new Vs;return t.initialize(e)||(t=null),t}function d(e,t){var i=new ds(e);return i.initialize(t)||(i=null),i}function h(t,i,n,r){var a=e.identifier,h=t.extensionConfig=t.extensionConfig||[],u=h[a]=h[a]||{};u.providers||(u.providers=[ts.LocalStorage,ts.IndexedDb]);var g=function(t,i,n,r){t&&(t.extensionConfig=t.extensionConfig||[]),!r&&i&&(r=i.getProcessTelContext().getNext());var s=null,a=e._getTelCtx().getNext();return a&&(s=a.getPlugin()),new Ar(r,t,i,s)}(t,i,0,r),p={itemCtx:g,storageConfig:u,id:e.id},m=function(e){for(var t=e.storageConfig.providers,i=null,n=0;!i&&n<t.length&&n<5;)switch(t[n++]){case ts.LocalStorage:i=d("localStorage",e);break;case ts.SessionStorage:i=d("sessionStorage",e);break;case ts.IndexedDb:i=l(e)}return i}(p);if(m){var f={iKey:t.instrumentationKey,tenantId:qr(t.instrumentationKey)||t.instrumentationKey,minPersistenceCacheLevel:Gr,coreRootCtx:g,providerContext:p,provider:m};Bs(u.minPersistenceLevel||-1)&&(f.minPersistenceCacheLevel=u.minPersistenceLevel),s.push(f),i.addNotificationListener({eventsSent:function(e){c(f,e)},eventsDiscarded:function(e,t){c(f,e)}}),o(f)}}e.initialize=function(e,n,s,a){Tr(n,(function(){return"LocalStorageChannel.initialize"}),(function(){i||(t.initialize(e,n,s),t.setInitialized(!1),i=!0,r=new is("LocalStorage",n.logger)),h(e,n,0,a)}),(function(){return{coreConfig:e,core:n,extensions:s,pluginChain:a}}))},e.processTelemetry=function(t,i){i=e._getTelCtx(i),function(e,t){var i=e;i.timings=i.timings||{},i.timings.processTelemetryStart=i.timings.processTelemetryStart||{},i.timings.processTelemetryStart[t]=Wr()}(t,e.identifier);var r=null;Zn(s,(function(e){e.iKey===t.iKey&&(r=e)}));var o=n,c=r?r.provider:null,l=t;!l.sync&&c?(l.id=l.id||xr(),ns(l.persistence)||(l.persistence=1),function(e,t){return!(t.sync||t.persistence<e.minPersistenceCacheLevel)}(r,l)&&a("processTelemetry",(function(e){return c.addEvent(l.id,l,i)})),o||e.processNext(l,i)):e.processNext(l,i)},e.pause=function(){n=!0},e.resume=function(){Tr(e.core,(function(){return"LocalStorageChannel:resume"}),(function(){n=!1,Zn(s,(function(e){e.provider&&o(e)}))}))},e.teardown=function(){Zn(s,(function(e){var t=e.provider;t&&t.teardown()})),s=[]},e.flush=function(e,t){}})),i}return qn(t,e),t}(wr),$s="function",Gs="object",js="undefined",qs="prototype",Ws=Object,zs=Ws.create,Js=null;function Ks(e){void 0===e&&(e=!0);var t=!1===e?null:Js;return t||(typeof globalThis!==js&&(t=globalThis),t||typeof self===js||(t=self),t||typeof window===js||(t=window),t||typeof i.g===js||(t=i.g),Js=t),t}function Ys(e){throw new TypeError(e)}(Ks()||{}).Symbol,(Ks()||{}).Reflect;var Qs=function(e,t){return Qs=Ws.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},Qs(e,t)};function Xs(e,t){function i(){this.constructor=e}typeof t!==$s&&null!==t&&Ys("Class extends value "+String(t)+" is not a constructor or null"),Qs(e,t),e[qs]=null===t?function(e){if(zs)return zs(e);if(null==e)return{};var t=typeof e;function i(){}return t!==Gs&&t!==$s&&Ys("Object prototype may only be an Object:"+e),i[qs]=e,new i}(t):(i[qs]=t[qs],new i)}var Zs="REAL_TIME",ea=function(){function e(t,i){var n=i?[].concat(i):[],r=this;r.iKey=function(){return t},r.count=function(){return n.length},r.events=function(){return n},r.addEvents=function(e,t){return void 0===t&&(t=!0),e&&e.length>0?(n=t?n.concat(e):e.concat(n),e.length):0},r.split=function(i,r){var s=new e(t);if(i<n.length){var a=n.length-i;Ke(r)||(a=r<a?r:a),s.addEvents(n.splice(i,a),!0)}return s}}return e.create=function(t,i){return new e(t,i)},e}(),ta=2e6,ia=Math.min(ta,65e3),na="metadata",ra="f",sa=/\./,aa=function e(t,i,n,r){var s="data",a="baseData",o=!!r,c=!0,l=i,d={};Ve(e,this,(function(e){function i(e,t){var i=d[e];return void 0===i&&(e.length>=7&&(i=it(e,"ext.metadata")||it(e,"ext.web")),d[e]=i),i}function r(e,t,s,a,c,d,h){tt(e,(function(e,u){var g=null;if(u||mn(u)){var p=s,m=e,f=c,S=t;if(o&&!a&&sa.test(e)){var v=e.split("."),y=v.length;if(y>1){f&&(f=f.slice());for(var C=0;C<y-1;C++){var _=v[C];S=S[_]=S[_]||{},p+="."+_,f&&f.push(_)}m=v[y-1]}}if(g=a&&i(p)||!l||!l.handleField(p,m)?Sn(m,u,n):l.value(p,m,u,n)){var E=g.value;if(S[m]=E,d&&d(f,m,g),h&&"object"==typeof E&&!rt(E)){var T=f;T&&(T=T.slice()).push(m),r(u,E,p+"."+m,a,T,d,h)}}}}))}e.createPayload=function(e,t,i,n,r){return{apiKeys:[],payloadBlob:"",overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:e,isTeardown:t,isSync:i,isBeacon:n,sendReason:r}},e.appendPayload=function(i,n,r){var s=i&&n&&!i.overflow;return s&&ii(t,(function(){return"Serializer:appendPayload"}),(function(){for(var t=n.events(),s=i.payloadBlob,a=i.numEvents,o=!1,c=[],l=[],d=i.isBeacon,h=d?65e3:3984588,u=d?ia:ta,g=0,p=0;g<t.length;){var m=t[g];if(m){if(a>=r){i.overflow=n.split(g);break}var f=e.getEventBlob(m);if(f&&f.length<=u){var S=f.length;if(s.length+S>h){i.overflow=n.split(g);break}s&&(s+="\n"),s+=f,++p>20&&(s.substr(0,1),p=0),o=!0,a++}else f?c.push(m):l.push(m),t.splice(g,1),g--}g++}if(c&&c.length>0&&i.sizeExceed.push(ea.create(n.iKey(),c)),l&&l.length>0&&i.failedEvts.push(ea.create(n.iKey(),l)),o){i.batches.push(n),i.payloadBlob=s,i.numEvents=a;var v=n.iKey();-1===dt(i.apiKeys,v)&&i.apiKeys.push(v)}}),(function(){return{payload:i,theBatch:{iKey:n.iKey(),evts:n.events()},max:r}})),s},e.getEventBlob=function(e){try{return ii(t,(function(){return"Serializer.getEventBlob"}),(function(){var t={};t.name=e.name,t.time=e.time,t.ver=e.ver,t.iKey="o:"+function(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return""}(e.iKey);var i={},n=e.ext;n&&(t.ext=i,tt(n,(function(e,t){r(t,i[e]={},"ext."+e,!0,null,null,!0)})));var o=t[s]={};o.baseType=e.baseType;var l=o[a]={};return r(e.baseData,l,a,!1,[a],(function(e,t,n){oa(i,e,t,n)}),c),r(e.data,o,s,!1,[],(function(e,t,n){oa(i,e,t,n)}),c),JSON.stringify(t)}),(function(){return{item:e}}))}catch(e){return null}}}))};function oa(e,t,i,n){if(n&&e){var r=yn(n.value,n.kind,n.propertyType);if(r>-1){var s=e[na];s||(s=e[na]={f:{}});var a=s[ra];if(a||(a=s[ra]={}),t)for(var o=0;o<t.length;o++){var c=t[o];a[c]||(a[c]={f:{}});var l=a[c][ra];l||(l=a[c][ra]={}),a=l}a=a[i]={},rt(n.value)?a.a={t:r}:a.t=r}}}var ca,la=function(){function e(){}return e.shouldRetryForStatus=function(e){return!(e>=300&&e<500&&408!==e&&429!==e||501===e||505===e)},e.getMillisToBackoffForRetry=function(e){var t,i=Math.floor(1200*Math.random())+2400;return t=Math.pow(2,e)*i,Math.min(t,6e5)},e}(),da=function e(){var t={};Ve(e,this,(function(e){e.setKillSwitchTenants=function(e,i){if(e&&i)try{var n=function(e){var t=[];return e&&lt(e,(function(e){t.push(ht(e))})),t}(e.split(","));if("this-request-only"===i)return n;for(var r=1e3*parseInt(i,10),s=0;s<n.length;++s)t[n[s]]=ft()+r}catch(e){return[]}return[]},e.isTenantKilled=function(e){var i=t,n=ht(e);return void 0!==i[n]&&i[n]>ft()||(delete i[n],!1)}}))},ha=function e(){var t=!0,i=!0,n=!0,r="use-collector-delta",s=!1;Ve(e,this,(function(e){e.allowRequestSending=function(){return t},e.firstRequestSent=function(){n&&(n=!1,s||(t=!1))},e.shouldAddClockSkewHeaders=function(){return i},e.getClockSkewHeaderValue=function(){return r},e.setClockSkew=function(e){s||(e?(r=e,i=!0,s=!0):i=!1,t=!0)}}))},ua="POST",ga="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",pa="drop",ma="send",fa="requeue",Sa="rspFail",va="kill-duration",ya="time-delta-millis",Ca=((ca={})[1]=fa,ca[100]=fa,ca[200]="sent",ca[8004]=pa,ca[8003]=pa,ca);function _a(e){try{return e.responseText}catch(e){}return""}var Ea=function e(t,i,n,r){this._responseHandlers=[];var s,a,o,c,l,d="?cors=true&content-type=application/x-json-stream&client-id=NO_AUTH&client-version="+hn,h=new da,u=!1,g=new ha,p=!1,m=0,f=!0,S=[],v={},y=[],C=null,_=!1;Ve(e,this,(function(e){var E=!0;function T(e){for(var t=0,i=null,n=0;null==i&&n<e.length;)1===(t=e[n])?vn()?i=I:"undefined"!=typeof XMLHttpRequest&&(i=A):2===t?i=b:p&&3===t&&fn()&&(i=w),n++;return i?{_transport:t,sendPOST:i}:null}function I(e,t,i){var n=new XDomainRequest;n.open(ua,e.urlString),n.onload=function(){var e=_a(n);R(t,200,{},e),$(e)},n.onerror=function(){R(t,400,{})},n.ontimeout=function(){R(t,500,{})},n.onprogress=function(){},i?n.send(e.data):s._setTimeoutOverride((function(){n.send(e.data)}),0)}function b(e,t){var i,n=((i={body:e.data,method:ua})[ga]=!0,i);E&&(n.credentials="include"),e.headers&&pt(e.headers).length>0&&(n.headers=e.headers),fetch(e.urlString,n).then((function(e){var i={},n="";e.headers&&e.headers.forEach((function(e,t){i[t]=e})),e.body&&e.text().then((function(e){n=e})),R(t,e.status,i,n),$(n)})).catch((function(e){R(t,0,{})}))}function A(e,t,i){function n(e,t,i){if(!e[i]&&t&&t.getResponseHeader){var n=t.getResponseHeader(i);n&&(e[i]=ht(n))}return e}function r(e){var t={};return e.getAllResponseHeaders?t=function(e){var t={};return st(e)&&lt(ht(e).split(/[\r\n]+/),(function(e){if(e){var i=e.indexOf(": ");if(-1!==i){var n=ht(e.substring(0,i)).toLowerCase(),r=ht(e.substring(i+1));t[n]=r}else t[ht(e)]=1}})),t}(e.getAllResponseHeaders()):(t=n(t,e,ya),t=n(t,e,va),t=n(t,e,"kill-duration-seconds")),t}function s(e,i){R(t,e.status,r(e),i)}var a=new XMLHttpRequest;try{a[ga]=!0}catch(e){}E&&(a.withCredentials=!0),a.open(ua,e.urlString,!i),tt(e.headers,(function(e,t){a.setRequestHeader(e,t)})),a.onload=function(){var e=_a(a);s(a,e),$(e)},a.onerror=function(){s(a)},a.ontimeout=function(){s(a)},a.send(e.data)}function R(e,t,i,n){try{e(t,i,n)}catch(e){s.diagLog().throwInternal(Ae.WARNING,dn.SendPostOnCompleteFailure,zt(e))}}function w(e,t,i){var n=200,r=e._thePayload;try{var a=Ht();if(!a.sendBeacon(e.urlString,e.data))if(r){var o=[];lt(r.batches,(function(t){if(o&&t&&t.count()>0){for(var i=t.events(),n=0;n<i.length;n++)if(!a.sendBeacon(e.urlString,C.getEventBlob(i[n]))){o.push(t.split(n));break}}else o.push(t.split(0))})),G(o,8003,r.isSync,!0)}else n=0}catch(e){s.diagLog().warnToConsole("Failed to send telemetry using sendBeacon API. Ex:"+e),n=0}finally{R(t,n,{},"")}}function P(){return!u&&m<i}function M(){var e=y;return y=[],e}function D(e,t,i){var n=!1;return e&&e.length>0&&!u&&a&&C&&(n=t||P()&&(i>0||g.allowRequestSending())),n}function O(e){var t={};return e&&lt(e,(function(e,i){t[i]={iKey:e.iKey(),evts:e.events()}})),t}function k(e,i,n,r,o,l){if(e&&0!==e.length)if(u)G(e,1,r);else try{var d=e;ii(c,(function(){return"HttpManager:_sendBatches"}),(function(s){s&&(e=e.slice(0));for(var c=[],d=null,u=Tn(),g=(l||a&&3===a._transport)&&L();D(e,r,i);){var p=e.shift();p&&p.count()>0&&(h.isTenantKilled(p.iKey())?c.push(p):(d=d||C.createPayload(i,n,r,g,o),C.appendPayload(d,p,t)?null!==d.overflow&&(e=[d.overflow].concat(e),d.overflow=null,U(d,u,Tn(),o),u=Tn(),d=null):(U(d,u,Tn(),o),u=Tn(),e=[p].concat(e),d=null)))}d&&U(d,u,Tn(),o),e.length>0&&(y=e.concat(y)),G(c,8004,r)}),(function(){return{batches:O(d),retryCount:i,isTeardown:n,isSynchronous:r,sendReason:o,useSendBeacon:l}}),!r)}catch(e){s.diagLog().throwInternal(Ae.WARNING,dn.CannotSerializeObject,"Unexpected Exception sending batch: "+zt(e))}}function N(e){var t=d,i="";lt(e.apiKeys,(function(e){i.length>0&&(i+=","),i+=e})),i.length>0&&(t+="&apikey="+i),t+="&upload-time="+ft().toString();var n=function(e){for(var t=0;t<e.batches.length;t++)for(var i=e.batches[t].events(),n=0;n<i.length;n++){var r=(i[n].ext||{}).intweb||{};if(mn(r.msfpc))return encodeURIComponent(r.msfpc)}return""}(e);if(mn(n)&&(t=t+"&ext.intweb.msfpc="+n),g.shouldAddClockSkewHeaders()&&(t+="&time-delta-to-apply-millis="+g.getClockSkewHeaderValue()),c.getWParam){var r=c.getWParam();r>=0&&(t+="&w="+r)}for(var s=0;s<S.length;s++)t+="&"+S[s].name+"="+S[s].value;return t}function L(){return!f&&p&&fn()}function x(e,t,i){e[t]=e[t]||{},e[t][s.identifier]=i}function U(t,i,n,r){if(t&&t.payloadBlob&&t.payloadBlob.length>0){var l=N(t),d=Tn(),h="sendAttempt";ii(c,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var u=0;u<t.batches.length;u++)for(var p=t.batches[u].events(),S=0;S<p.length;S++){var y=p[S];if(_){var C=y.timings=y.timings||{};x(C,"sendEventStart",d),x(C,"serializationStart",i),x(C,"serializationCompleted",n)}y[h]>0?y[h]++:y[h]=1}G(t.batches,1e3+(r||0),t.isSync,!0);var E={data:t.payloadBlob,urlString:l,headers:En({},v),_thePayload:t,_sendReason:r},T=null,I=!!e.sendHook,b=a;o&&t.isBeacon&&2===t.sendReason&&(b=o),b&&(T=function(i){g.firstRequestSent();var n=function(e,i){F(e,i,t,r)};try{b.sendPOST(i,n,t.isTeardown||t.isSync),e.sendListener&&e.sendListener(E,i,t.isSync||t.isTeardown,t.isBeacon)}catch(e){s.diagLog().warnToConsole("Unexpected exception sending payload. Ex:"+zt(e)),R(n,0,{})}}),ii(c,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(T)if(t.isSync||t.isBeacon||m++,I&&!t.isBeacon&&3!==b._transport){var i={data:E.data,urlString:E.urlString,headers:E.headers},n=!1;ii(c,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{e.sendHook(i,(function(e){n=!0,f||e._thePayload||(e._thePayload=e._thePayload||E._thePayload,e._sendReason=e._sendReason||E._sendReason),T(e)}),t.isSync||t.isTeardown)}catch(e){n||T(E)}}))}else T(E)}))}),(function(){return{thePayload:t,serializationStart:i,serializationCompleted:n,sendReason:r}}),t.isSync)}t.sizeExceed&&t.sizeExceed.length>0&&G(t.sizeExceed,8003,t.isSync),t.failedEvts&&t.failedEvts.length>0&&G(t.failedEvts,8002,t.isSync)}function F(e,t,i,r){var s=9e3,a=null,o=!1,c=!1;try{var l=!0;if(typeof e!==V){if(t){g.setClockSkew(t[ya]);var d=t[va]||t["kill-duration-seconds"];lt(h.setKillSwitchTenants(t["kill-tokens"],d),(function(e){lt(i.batches,(function(t){if(t.iKey()===e){a=a||[];var n=t.split(0);i.numEvents-=n.count(),a.push(n)}}))}))}if(200===e)return void(s=200);(!la.shouldRetryForStatus(e)||i.numEvents<=0)&&(l=!1),s=9e3+e%1e3}if(l){s=100;var u=i.retryCnt;i.isSync||i.isBeacon||(u<n?(o=!0,H((function(){i.isSync||i.isBeacon||m--,k(i.batches,u+1,i.isTeardown,i.isSync,5,i.isBeacon)}),!0,la.getMillisToBackoffForRetry(u))):c=!0)}}finally{o||(g.setClockSkew(),B(i,s,r,c)),G(a,8004,i.isSync)}}function B(t,i,n,r){try{r&&s._backOffTransmission(),200===i&&(r||t.isSync||s._clearBackOff(),function(e){if(_){var t=Tn();lt(e,(function(e){e&&e.count()>0&&function(e,t){_&&lt(e,(function(e){x(e.timings=e.timings||{},"sendEventCompleted",t)}))}(e.events(),t)}))}}(t.batches)),G(t.batches,i,t.isSync,!0)}finally{t.isSync||t.isBeacon||(m--,5!==n&&e.sendQueuedRequests(n,!t.isSync,t.isBeacon))}}function H(e,t,i){t?e():s._setTimeoutOverride(e,i)}function $(t){var i=e._responseHandlers;try{for(var n=0;n<i.length;n++)try{i[n](t)}catch(t){s.diagLog().throwInternal(Ae.CRITICAL,dn.PostResponseHandler,"Response handler failed: "+t)}if(t){var r=JSON.parse(t);mn(r.webResult)&&mn(r.webResult.msfpc)&&l.set("MSFPC",r.webResult.msfpc,31536e3)}}catch(t){}}function G(e,t,i,n){if(e&&e.length>0&&r){var a=r[function(e){var t=Ca[e];return mn(t)||(t="oth",e>=9e3&&e<=9999?t=Sa:e>=8e3&&e<=8999?t=pa:e>=1e3&&e<=1999&&(t=ma)),t}(t)];a&&ii(c,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){H((function(){try{a.call(r,e,t,i)}catch(e){s.diagLog().throwInternal(Ae.CRITICAL,dn.NotificationException,"send request notification failed: "+e)}}),n||i,0)}),(function(){return{batches:O(e),reason:t,isSync:i,sendSync:n}}),!i)}}e.initialize=function(e,t,i,n,r){r||(r={}),d=e+d,c=t,l=t.getCookieMgr(),_=!c.config.disableEventTimings;var h=!!c.config.enableCompoundKey;s=i;var u=r.valueSanitizer,g=r.stringifyObjects;if(Je(r.enableCompoundKey)||(h=!!r.enableCompoundKey),p=!qt(),C=new aa(c,u,g,h),o=T([3]),!(a=n)){f=!1;var m=$t();m&&m.protocol&&"file:"===m.protocol.toLowerCase()&&(E=!1);var S=[];S=qt()?[2,1]:[1,2,3];var v=r.transports;v&&(at(v)?S=[v].concat(S):rt(v)&&(S=v.concat(S))),(a=T(S))||s.diagLog().warnToConsole("No available transport to send events")}},e._getDbgPlgTargets=function(){return[a,h,C]},e.addQueryStringParameter=function(e,t){for(var i=0;i<S.length;i++)if(S[i].name===e)return void(S[i].value=t);S.push({name:e,value:t})},e.addHeader=function(e,t){v[e]=t},e.canSendRequest=function(){return P()&&g.allowRequestSending()},e.sendQueuedRequests=function(e,t,i){var n=!Ke(t)&&!t;D(y,n,0)&&k(M(),0,!1,n,e||0,!!i)},e.isCompletelyIdle=function(){return!u&&0===m&&0===y.length},e.addBatch=function(e){if(e&&e.count()>0){if(h.isTenantKilled(e.iKey()))return!1;y.push(e)}return!0},e.teardown=function(){y.length>0&&k(M(),0,!0,!0,2,!0)},e.pause=function(){u=!0},e.resume=function(){u=!1,e.sendQueuedRequests(4,!1)},e.sendSynchronousBatch=function(e,t,i){e&&e.count()>0&&k([e],0,!1,!0,t||0,!!i)}}))},Ta=pn?window:void 0,Ia="eventsDiscarded",ba="overrideInstrumentationKey",Aa=function(e){function t(){var i,n=e.call(this)||this;n.identifier="PostChannel",n.priority=1011,n.version="3.1.2";var r,s,a,o,c,l=!1,d=[],h=null,u=!1,g=0,p=500,m=0,f=1e4,S={},v=Zs,y=null,C=null,_=0,E=0,T={},I=-1,b=!0;return Ve(t,n,(function(e,t){function n(e,t){if(e.sendAttempt||(e.sendAttempt=0),e.latency||(e.latency=sn),e.ext&&e.ext.trace&&delete e.ext.trace,e.ext&&e.ext.user&&e.ext.user.id&&delete e.ext.user.id,b&&(e.ext=Et(e.ext),e.baseData&&(e.baseData=Et(e.baseData)),e.data&&(e.data=Et(e.data))),e.sync)if(_||u)e.latency=on,e.sync=!1;else if(s)return b&&(e=Et(e)),void s.sendSynchronousBatch(ea.create(e.iKey,[e]),3);var i=e.latency,n=m,r=f;i===cn&&(n=g,r=p);var a=!1;if(n<r)a=!N(e,t);else{var o=sn,c=20;i===cn&&(o=cn,c=1),a=!0,function(e,t,i,n){for(;i<=t;){var r=O(e,t,!0);if(r&&r.count()>0){var s=r.split(0,n),a=s.count();if(a>0)return i===cn?g-=a:m-=a,$(Ia,[s],se),!0}i++}return L(),!1}(e.iKey,e.latency,o,c)&&(a=!N(e,t))}a&&H(Ia,[e],se)}function A(e,t,i,n){var r=x(e,t,i);return s.sendQueuedRequests(t,i,n),r}function R(){return m>0}function w(){if(I>=0&&x(I,c,!0)&&s.sendQueuedRequests(c,!0,!1),g>0&&!C&&!u){var e=S[v][2];e>=0&&(C=P((function(){C=null,A(cn,1,!0),w()}),e))}var t=S[v][1];!y&&!h&&t>=0&&!u&&(R()?y=P((function(){y=null,A(0===E?on:sn,1,!0),E++,E%=2,w()}),t):E=0)}function P(t,i){0===i&&_&&(i=1);var n=1e3;return _&&(n=la.getMillisToBackoffForRetry(_-1)),e._setTimeoutOverride(t,i*n)}function M(){null!==y&&(e._clearTimeoutOverride(y),y=null,E=0)}function D(t,i){M(),h&&(e._clearTimeoutOverride(h),h=null),u||A(sn,t,i,!0)}function O(e,t,i){var n=T[t];n||(n=T[t=sn]);var r=n.iKeyMap[e];return!r&&i&&(r=ea.create(e),n.batches.push(r),n.iKeyMap[e]=r),r}function k(t,i){s.canSendRequest()&&!_&&(a>0&&m>a&&(i=!0),i&&null==h&&e.flush(t,null,20))}function N(e,t){b&&(e=Et(e));var i=e.latency,n=O(e.iKey,i,!0);return!!n.addEvents([e],t)&&(i!==cn?(m++,t&&0===e.sendAttempt&&k(!e.sync,o>0&&n.count()>=o)):g++,!0)}function L(){for(var e=0,t=0,i=function(i){var n=T[i];n&&n.batches&&lt(n.batches,(function(n){i===cn?e+=n.count():t+=n.count()}))},n=sn;n<=cn;n++)i(n);m=t,g=e}function x(t,i,n){var r=!1;return!n||s.canSendRequest()?ii(e.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var e=[],i=cn;i>=t;){var n=T[i];n&&n.batches&&(lt(n.batches,(function(t){s.addBatch(t)?r=r||t&&t.count()>0:e=e.concat(t.events()),i===cn?g-=t.count():m-=t.count()})),n.batches=[],n.iKeyMap={}),i--}e.length>0&&H(Ia,e,re),r&&I>=t&&(I=-1,c=0)}),(function(){return{latency:t,sendReason:i}}),n):(I=I>=0?Math.min(I,t):t,c=Math.max(c,i)),r}function U(e,t){A(sn,t,!0),F((function(){e&&e(),d.length>0?h=P((function(){return U(d.shift(),t)}),0):(h=null,R()&&w())}))}function F(e){s.isCompletelyIdle()?e():h=P((function(){F(e)}),.25)}function V(){(S={})[Zs]=[2,1,0],S.NEAR_REAL_TIME=[6,3,0],S.BEST_EFFORT=[18,9,0]}function B(t,i){var n=e._notificationManager||{},r=n[t];if(r)try{r.apply(n,i)}catch(i){e.diagLog().throwInternal(Ae.CRITICAL,dn.NotificationException,t+" notification failed: "+i)}}function H(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&B(e,[t].concat(i))}function $(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&lt(t,(function(t){t&&t.count()>0&&B(e,[t.events()].concat(i))}))}function G(){o=i&&i.disableAutoBatchFlushLimit?0:Math.max(1500,f/6)}V(),T[cn]={batches:[],iKeyMap:{}},T[on]={batches:[],iKeyMap:{}},T[an]={batches:[],iKeyMap:{}},T[sn]={batches:[],iKeyMap:{}},G(),s=new Ea(500,2,1,{requeue:function(t,i){var r=[];lt(t,(function(t){t&&t.count()>0&&lt(t.events(),(function(t){t&&(t.sync&&(t.latency=on,t.sync=!1),t.sendAttempt<6?(In(t,e.identifier),n(t,!1)):r.push(t))}))})),r.length>0&&H(Ia,r,ie)},send:function(e,t,i){e&&e.length>0&&B("eventsSendRequest",[t>=1e3&&t<=1999?t-1e3:0,!0!==i])},sent:function(e,t){$("eventsSent",e,t),w()},drop:function(e,t){$(Ia,e,t>=8e3&&t<=8999?t-8e3:te)},rspFail:function(e){$(Ia,e,ie),w()},oth:function(e,t){$(Ia,e,te),w()}}),e._getDbgPlgTargets=function(){return[s]},e.initialize=function(n,o,c){ii(o,(function(){return"PostChannel:initialize"}),(function(){var l=o;t.initialize(n,o,c),e.setInitialized(!1);var d=e._getTelCtx();n.extensionConfig[e.identifier]=n.extensionConfig[e.identifier]||{},i=d.getExtCfg(e.identifier),e._setTimeoutOverride=i.setTimeoutOverride?i.setTimeoutOverride:setTimeout.bind(Ta),e._clearTimeoutOverride=i.clearTimeoutOverride?i.clearTimeoutOverride:clearTimeout.bind(Ta),b=!i.disableOptimizeObj&&!!xt("chrome");var h=l.getWParam;l.getWParam=function(){var e=0;return i.ignoreMc1Ms0CookieProcessing&&(e|=2),e|h()},i.eventsLimitInMem>0&&(f=i.eventsLimitInMem),i.immediateEventLimit>0&&(p=i.immediateEventLimit),i.autoFlushEventsLimit>0&&(a=i.autoFlushEventsLimit),G(),i.httpXHROverride&&i.httpXHROverride.sendPOST&&(r=i.httpXHROverride),mn(n.anonCookieName)&&s.addQueryStringParameter("anoncknm",n.anonCookieName),s.sendHook=i.payloadPreprocessor,s.sendListener=i.payloadListener;var u=i.overrideEndpointUrl?i.overrideEndpointUrl:n.endpointUrl;e._notificationManager=n.extensionConfig.NotificationManager,s.initialize(u,e.core,e,r,i),function(e){var t=Qi("beforeunload",e);t=Qi("unload",e)||t,Qi("pagehide",e)}((function(){D(2,!1)})),e.setInitialized(!0)}),(function(){return{coreConfig:n,core:o,extensions:c}}))},e.processTelemetry=function(t,r){In(t,e.identifier);var s=(r=e._getTelCtx(r)).getExtCfg(e.identifier),a=!!i.disableTelemetry;s&&(a=a||!!s.disableTelemetry);var o=t;a||l||(i[ba]&&(o.iKey=i[ba]),s&&s[ba]&&(o.iKey=s[ba]),n(o,!0),w()),e.processNext(o,r)},e.setEventQueueLimits=function(e,t){f=e>0?e:1e4,a=t>0?t:0,G();var i=m>e;if(!i&&o>0)for(var n=sn;!i&&n<=on;n++){var r=T[n];r&&r.batches&&lt(r.batches,(function(e){e&&e.count()>=o&&(i=!0)}))}k(!0,i)},e.teardown=function(){D(2,!1),l=!0,s.teardown()},e.pause=function(){M(),u=!0,s.pause()},e.resume=function(){u=!1,s.resume(),w()},e.addResponseHandler=function(e){s._responseHandlers.push(e)},e._loadTransmitProfiles=function(e){M(),V(),v=Zs,w(),tt(e,(function(e,t){var i=t.length;if(i>=2){var n=i>2?t[2]:0;if(t.splice(0,i-2),t[1]<0&&(t[0]=-1),t[1]>0&&t[0]>0){var r=t[0]/t[1];t[0]=Math.ceil(r)*t[1]}n>=0&&t[1]>=0&&n>t[1]&&(n=t[1]),t.push(n),S[e]=t}}))},e.flush=function(e,t,i){void 0===e&&(e=!0),u||(M(),i=i||1,e?(x(sn,i,e),L(),null==h?h=P((function(){U(t,i)}),0):d.push(t)):(A(sn,i,!1),null!=t&&t()))},e.setMsaAuthTicket=function(e){s.addHeader("AuthMsaDeviceTicket",e)},e.hasEvents=R,e._setTransmitProfile=function(e){v!==e&&void 0!==S[e]&&(M(),v=e,w())},e._backOffTransmission=function(){_<4&&(_++,M(),w())},e._clearBackOff=function(){_&&(_=0,M(),w())}})),n}return Xs(t,e),t}(ci),Ra=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function wa(e,t){void 0===t&&(t=Ra);var i=null;if(e)for(var n=e.split(","),r=0;r<n.length;r++)Pa(n[r],t)&&(i?i+=","+n[r]:i=n[r]);return i}function Pa(e,t){if(void 0===t&&(t=Ra),!e||e.length<4)return!1;for(var i=!1,n=e.substring(0,3).toString().toUpperCase(),r=0;r<t.length;r++)if(t[r]+":"===n&&e.length<=256){i=!0;break}return i}var Ma=function(){function e(e,t){this.core=t,this.appExpId=null,this.flightIdNameSpaces=Ra.slice(0),this.expIdCookieName="Treatments",this._cookieMgr=Oi(t),this._propertiesConfig=e;var i=Vt();if(i){var n=i.documentElement;i&&(this.locale=n.lang)}this.env=e.env?e.env:this._getMetaDataFromDOM("awa-").env}return e.prototype.getExpId=function(){return this._propertiesConfig.expId?this._readExpIdFromCoreData(this._propertiesConfig.expId):this._readExpIdFromCookie()},e.prototype._getMetaDataFromDOM=function(e){var t,i={},n=Vt();if(n){t=n&&n.querySelectorAll("meta");for(var r=0;r<t.length;r++){var s=t[r];s.name&&0===s.name.toLowerCase().indexOf(e)&&(i[s.name.replace(e,"")]=s.content)}}return i},e.prototype._setAppExpId=function(e){e!==this.appExpId&&(this.appExpId=wa(e,this.flightIdNameSpaces))},e.prototype._getAppExpId=function(){return this.appExpId},e.prototype._readExpIdFromCookie=function(){var e=Cn(this._cookieMgr,this.expIdCookieName);return this._setAppExpId(e),this._getAppExpId()},e.prototype._readExpIdFromCoreData=function(e){return this._setAppExpId(e),this._getAppExpId()},e.validateAppExpId=wa,e._staticInit=void mt(e.prototype,"expId",e.prototype.getExpId),e}(),Da=function(){},Oa=function(){function e(t,i,n){this.core=n;var r=this._cookieMgr=Oi(n,t);if(r&&r.isEnabled()){var s=Cn(r,"MUID");if(s&&this.setLocalId("t:"+s),i.enableApplicationInsightsUser){var a=Cn(r,e.userCookieName);if(a){var o=a.split(e.cookieSeparator);o.length>0&&(this.id=o[0])}if(!this.id){this.id=Zi(t&&!Je(t.idLength)?t.idLength:22);var c=ct(new Date);this.accountAcquisitionDate=c;var l=[this.id,c],d=i.cookieDomain?i.cookieDomain:void 0;r.set(e.userCookieName,l.join(e.cookieSeparator),31536e3,d)}}}if("undefined"!=typeof navigator){var h=navigator;this.locale=h.userLanguage||h.language}}return e.prototype.getLocalId=function(){if(this._customLocalId)return this._customLocalId;var e=Cn(this._cookieMgr,"MUID");e&&this.setLocalId("t:"+e)},e.prototype.setLocalId=function(e){this._customLocalId=e},e.cookieSeparator="|",e.userCookieName="ai_user",e._staticInit=void mt(e.prototype,"localId",e.prototype.getLocalId,e.prototype.setLocalId),e}(),ka="MSIE",Na="Chrome",La="Firefox",xa="Safari",Ua="Edge",Fa="Electron",Va="SkypeShell",Ba="PhantomJS",Ha="Opera",$a="([\\d,.]+)",Ga="Unknown",ja="Edg/",qa=function(){function e(e,t){this._cookieMgr=Oi(t),this._propertiesConfig=e;var i=$t();if(i){var n=i.hostname;n&&(this.domain="file:"===i.protocol?"local":n)}var r="undefined"!=typeof navigator?navigator.userAgent:"";if(e.userAgent&&(r=e.userAgent),e.populateBrowserInfo){if(r){var s=this._getBrowserName(r);this.browser=s,this.browserVer=this._getBrowserVersion(r,s)}var a=this._getScreenResolution();this.screenRes=a.w+"X"+a.h}}return e.prototype.getUserConsent=function(){return this._propertiesConfig.userConsented||!!Cn(this._cookieMgr,this._propertiesConfig.userConsentCookieName||"MSCC")},e.prototype.getUserConsentDetails=function(){try{if(this._propertiesConfig.callback&&this._propertiesConfig.callback.userConsentDetails){var e=this._propertiesConfig.callback.userConsentDetails();if(e)return JSON.stringify({Required:!!e.Required&&e.Required,Analytics:!!e.Analytics&&e.Analytics,SocialMedia:!!e.SocialMedia&&e.SocialMedia,Advertising:!!e.Advertising&&e.Advertising})}}catch(e){}return null},e.prototype._getBrowserName=function(e){return this._userAgentContainsString("OPR/",e)?Ha:this._userAgentContainsString(Ba,e)?Ba:this._userAgentContainsString(Ua,e)||this._userAgentContainsString(ja,e)?Ua:this._userAgentContainsString(Fa,e)?Fa:this._userAgentContainsString(Na,e)?Na:this._userAgentContainsString("Trident",e)?ka:this._userAgentContainsString(La,e)?La:this._userAgentContainsString(xa,e)?xa:this._userAgentContainsString(Va,e)?Va:Ga},e.prototype._userAgentContainsString=function(e,t){return t.indexOf(e)>-1},e.prototype._getBrowserVersion=function(e,t){return t===ka?this._getIeVersion(e):this._getOtherVersion(t,e)},e.prototype._getIeVersion=function(e){var t=e.match(new RegExp(ka+" "+$a));if(t)return t[1];var i=e.match(new RegExp("rv:"+$a));return i?i[1]:void 0},e.prototype._getOtherVersion=function(e,t){e===xa?e="Version":e===Ua&&this._userAgentContainsString(ja,t)&&(e="Edg");var i=t.match(new RegExp(e+"/"+$a));return i?i[1]:Ga},e.prototype._getScreenResolution=function(){var e={h:0,w:0},t=Ft();return t&&t.screen&&(e.h=screen.height,e.w=screen.width),e},e._staticInit=void mt(e.prototype,"userConsent",e.prototype.getUserConsent),e}(),Wa="Windows",za="Mac OS X",Ja="Android",Ka="iOS",Ya=/(windows|win32)/i,Qa=/ arm;/i,Xa=/windows\sphone\s\d+\.\d+/i,Za=/(macintosh|mac os x)/i,eo=/(ipad|iphone|ipod)(?=.*like mac os x)/i,to=/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,io=/android/i,no=/CrOS/i,ro={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},so="([\\d,_,.]+)",ao="Unknown",oo=function(){function e(e){var t="undefined"!=typeof navigator?navigator.userAgent:"";if(e.userAgent&&(t=e.userAgent),t&&e.populateOperatingSystemInfo){var i=this._getOsName(t.toLowerCase());this.name=i,this.ver=this._getOsVersion(t,i)}}return e.prototype._getOsName=function(e){return e.match(Xa)?"Windows Phone":e.match(Qa)?"Windows RT":e.match(Ya)?Wa:e.match(eo)?Ka:e.match(io)?Ja:e.match(to)?"Linux":e.match(no)?"Chrome OS":-1!==e.indexOf("x11")?"Unix":-1!==e.indexOf("blackberry")?"BlackBerry":-1!==e.indexOf("symbian")?"Symbian":-1!==e.indexOf("nokia")?"Nokia":e.match(Za)?za:ao},e.prototype._getOsVersion=function(e,t){return t===Wa?this._getGenericOsVersion(e,"Windows NT"):t===Ja?this._getGenericOsVersion(e,t):t===za?this._getMacOsxVersion(e):t===Ka?this._getIosVersion(e):ao},e.prototype._getGenericOsVersion=function(e,t){var i=e.match(new RegExp(t+" ([\\d,.]+)"));return i?ro[i[1]]?ro[i[1]]:i[1]:ao},e.prototype._getMacOsxVersion=function(e){var t=e.match(new RegExp(za+" "+so));if(t){var i=t[1].replace(/_/g,".");if(i){var n=this._getDelimiter(i);return n?i.split(n)[0]:i}}return ao},e.prototype._getIosVersion=function(e){var t=e.match(new RegExp("OS "+so));if(t){var i=t[1].replace(/_/g,".");if(i){var n=this._getDelimiter(i);return n?i.split(n)[0]:i}}return ao},e.prototype._getDelimiter=function(e){return e.indexOf(".")>-1?".":e.indexOf("_")>-1?"_":null},e}(),co=function(){function e(e,t){this.core=t,e.serviceName&&(this.serviceName=e.serviceName),this._cookieMgr=Oi(t)}return e.prototype.getMsfpc=function(){return Cn(this._cookieMgr,"MSFPC")},e.prototype.getAnid=function(){return Cn(this._cookieMgr,"ANON").slice(0,34)},e._staticInit=(mt(e.prototype,"msfpc",e.prototype.getMsfpc),void mt(e.prototype,"anid",e.prototype.getAnid)),e}(),lo=function(e){this.popSample=100,this.eventFlags=0,e.hashIdentifiers&&(this.eventFlags=1048576|this.eventFlags),e.dropIdentifiers&&(this.eventFlags=2097152|this.eventFlags)},ho=function(){var e=(new Date).getTimezoneOffset(),t=e%60,i=(e-t)/60,n="+";i>0&&(n="-"),i=Math.abs(i),t=Math.abs(t),this.tz=n+(i<10?"0"+i:i.toString())+":"+(t<10?"0"+t:t.toString())},uo=function(){},go=function(){function e(){}return e.prototype.setId=function(e){this.customId=e},e.prototype.getId=function(){return st(this.customId)?this.customId:this.automaticId},e._staticInit=void mt(e.prototype,"id",e.prototype.getId,e.prototype.setId),e}(),po=function(e,t,i,n){if(e.enableApplicationInsightsTrace){this.traceId=t||function(){for(var e,t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i="",n=0;n<4;n++)i+=t[15&(e=Yi())]+t[e>>4&15]+t[e>>8&15]+t[e>>12&15]+t[e>>16&15]+t[e>>20&15]+t[e>>24&15]+t[e>>28&15];var r=t[8+(3&Yi())|0];return i.substr(0,8)+i.substr(9,4)+"4"+i.substr(13,3)+r+i.substr(16,3)+i.substr(19,12)}(),this.parentId=i,this.name=n;var r=$t();r&&r.pathname&&(this.name=r.pathname)}},mo=function(){function e(){}return e.id="id",e.ver="ver",e.appName="name",e.locale="locale",e.expId="expId",e.env="env",e}(),fo=function(){function e(){}return e.domain="domain",e.browser="browser",e.browserVer="browserVer",e.screenRes="screenRes",e.userConsent="userConsent",e.consentDetails="consentDetails",e}(),So=function(){function e(){}return e.locale="locale",e.localId="localId",e.id="id",e}(),vo=function(){function e(){}return e.osName="name",e.ver="ver",e}(),yo=function(){function e(){}return e.ver="ver",e.seq="seq",e.installId="installId",e.epoch="epoch",e}(),Co=function(){function e(){}return e.msfpc="msfpc",e.anid="anid",e.serviceName="serviceName",e}(),_o=function(){function e(){}return e.popSample="popSample",e.eventFlags="eventFlags",e}(),Eo=function(){function e(){}return e.tz="tz",e}(),To=function(){function e(){}return e.sessionId="sesId",e}(),Io=function(){function e(){}return e.localId="localId",e.deviceClass="deviceClass",e.make="make",e.model="model",e}(),bo=function(){function e(){}return e.role="role",e.roleInstance="roleInstance",e.roleVer="roleVer",e}(),Ao=function(){function e(){}return e.traceId="traceID",e.traceName="name",e.parentId="parentID",e}(),Ro=function(){function e(){}return e.UserExt="user",e.DeviceExt="device",e.TraceExt="trace",e.WebExt="web",e.AppExt="app",e.OSExt="os",e.SdkExt="sdk",e.IntWebExt="intweb",e.UtcExt="utc",e.LocExt="loc",e.CloudExt="cloud",e}(),wo="MicrosoftApplicationsTelemetryDeviceId";var Po,Mo,Do=function(){function e(e,t){this._sequenceId=0;var i=e.propertyStorageOverride;this.seq=this._sequenceId,this.epoch=Yi(!1).toString();var n=Oi(t,e);if(n.isEnabled()||i){var r=function(e,t,i){return t?t.getProperty(i)||"":Cn(e,i)}(n,i,wo);r||(r=Xi()),function(e,t,i,n){t?t.setProperty(i,n):e.set(i,n,31536e3)}(n,i,wo,r),this.installId=r}else n.purge(wo)}return e.prototype.getSequenceId=function(){return++this._sequenceId},e}();function Oo(){return void 0===Po&&(Po=!!No(Mo.LocalStorage)),Po}function ko(){return Oo()?No(Mo.LocalStorage):null}function No(e){var t,i,n=null;try{var r=J();if(!r)return null;i=new Date,(n=e===Mo.LocalStorage?r.localStorage:r.sessionStorage)&&Xe(n.setItem)&&(n.setItem(i,i),t=n.getItem(i)!==i,n.removeItem(i),t&&(n=null))}catch(e){n=null}return n}!function(e){e[e.LocalStorage=0]="LocalStorage",e[e.SessionStorage=1]="SessionStorage"}(Mo||(Mo={}));var Lo=function(){function e(t,i){var n,r,s=Yt(t),a=Oi(t);Ve(e,this,(function(t){var o=function(e){return{sessionRenewalMs:e.sessionRenewalMs&&function(){return e.sessionRenewalMs},sessionExpirationMs:e.sessionExpirationMs&&function(){return e.sessionExpirationMs},cookieDomain:e.cookieDomain&&function(){return e.cookieDomain},namePrefix:e.namePrefix&&function(){return e.namePrefix},sessionAsGuid:function(){return e.sessionAsGuid},idLength:function(){return e.idLength?e.idLength:22}}}(i);function c(){var e=function(e){return Ni(null)?Cn(Oi(null),e):""}(r());if(e&&Xe(e.split))l(e);else{var i=function(e,t){var i=ko();if(null!==i)try{return i.getItem(t)}catch(t){Po=!1,e.throwInternal(Ae.CRITICAL,dn.BrowserCannotReadLocalStorage,"Browser failed read of local storage. "+t)}return null}(s,r());i&&l(i)}t.automaticSession.getId()||d()}function l(e){var i=t.automaticSession,n=e.split("|");n.length>0&&i.setId(n[0]);try{if(n.length>1){var r=+n[1];i.acquisitionDate=+new Date(r),i.acquisitionDate=i.acquisitionDate>0?i.acquisitionDate:0}if(n.length>2){var a=+n[2];i.renewalDate=+new Date(a),i.renewalDate=i.renewalDate>0?i.renewalDate:0}}catch(e){s.throwInternal(Ae.CRITICAL,dn.ErrorParsingAISessionCookie,"Error parsing ai_session cookie, session will be reset: "+e)}0===i.renewalDate&&s.throwInternal(Ae.WARNING,dn.SessionRenewalDateIsZero,"AI session renewal date is 0, session will be reset.")}function d(){var e=t.automaticSession,i=(new Date).getTime(),n=t.config.sessionAsGuid();!Je(n)&&n?ot(n)?e.setId(_n()):e.setId(_n(n)):e.setId(Zi(o&&o.idLength?o.idLength():22)),e.acquisitionDate=i,e.renewalDate=i,h(e.getId(),e.acquisitionDate,e.renewalDate),Oo()||s.throwInternal(Ae.WARNING,dn.BrowserDoesNotSupportLocalStorage,"Browser does not support local storage. Session durations will be inaccurate.")}function h(e,i,s){var o=i+t.config.sessionExpirationMs(),c=s+t.config.sessionRenewalMs(),l=new Date,d=[e,i,s];o<c?l.setTime(o):l.setTime(c);var h=t.config.cookieDomain?t.config.cookieDomain():null;a.set(r(),d.join("|")+";expires="+l.toUTCString(),null,h),n=(new Date).getTime()}function u(e,t,i){!function(e,t,i){var n=ko();if(null!==n)try{return n.setItem(t,i),!0}catch(t){Po=!1,e.throwInternal(Ae.CRITICAL,dn.BrowserCannotWriteLocalStorage,"Browser failed write to local storage. "+t)}}(s,r(),[e,t,i].join("|"))}Xe(i.sessionExpirationMs)||(o.sessionExpirationMs=function(){return e.acquisitionSpan}),Xe(i.sessionRenewalMs)||(o.sessionRenewalMs=function(){return e.renewalSpan}),t.config=o,r=function(){return t.config.namePrefix&&t.config.namePrefix()?e.cookieNameConst+t.config.namePrefix():e.cookieNameConst},t.automaticSession=new go,t.update=function(){t.automaticSession.getId()||c();var i=t.automaticSession,r=t.config,s=(new Date).getTime(),a=s-i.acquisitionDate>r.sessionExpirationMs(),o=s-i.renewalDate>r.sessionRenewalMs();a||o?d():(!n||s-n>e.cookieUpdateInterval)&&(i.renewalDate=s,h(i.getId(),i.acquisitionDate,i.renewalDate))},t.backup=function(){var e=t.automaticSession;u(e.getId(),e.acquisitionDate,e.renewalDate)}}))}return e.acquisitionSpan=864e5,e.renewalSpan=18e5,e.cookieUpdateInterval=6e4,e.cookieNameConst="ai_session",e}(),xo=st,Uo=function(){function e(e,t,i){this.app=new Ma(t,i),this.cloud=new Da,this.user=new Oa(e,t,i),this.os=new oo(t),this.web=new qa(t,i),this.sdk=new Do(e,i),this.intWeb=new co(t,i),this.utc=new lo(t),this.loc=new ho,this.device=new uo,this.telemetryTrace=new po(t),this.sessionManager=new Lo(i,t),this.session=new go}return e.prototype.getSessionId=function(){var e=this.session;if(e&&xo(e.customId))return e.customId;var t=this.sessionManager;t.update();var i=t.automaticSession;if(i){var n=i.getId();n&&xo(n)&&(e.automaticId=n)}return e.automaticId},e.prototype.applyApplicationContext=function(e){var t=this.app;xo(t.id)&&(e.ext[Ro.AppExt][mo.id]=t.id),xo(t.ver)&&(e.ext[Ro.AppExt][mo.ver]=t.ver),xo(t.name)&&(e.ext[Ro.AppExt][mo.appName]=t.name),xo(t.locale)&&(e.ext[Ro.AppExt][mo.locale]=t.locale);var i=t.getExpId();xo(i)&&(e.ext[Ro.AppExt][mo.expId]=i),xo(t.env)&&(e.ext[Ro.AppExt][mo.env]=t.env)},e.prototype.applyUserContext=function(e){var t=this.user,i=t.getLocalId();xo(i)&&(e.ext[Ro.UserExt][So.localId]=i),xo(t.locale)&&(e.ext[Ro.UserExt][So.locale]=t.locale),xo(t.id)&&(e.ext[Ro.UserExt][So.id]=t.id)},e.prototype.applyWebContext=function(e){var t=this.web;xo(t.domain)&&(e.ext[Ro.WebExt][fo.domain]=t.domain),xo(t.browser)&&(e.ext[Ro.WebExt][fo.browser]=t.browser),xo(t.browserVer)&&(e.ext[Ro.WebExt][fo.browserVer]=t.browserVer),xo(t.screenRes)&&(e.ext[Ro.WebExt][fo.screenRes]=t.screenRes),e.ext[Ro.WebExt][fo.userConsent]=t.getUserConsent(),e.ext[Ro.WebExt][fo.consentDetails]=t.getUserConsentDetails()},e.prototype.applyOsContext=function(e){var t=this.os;xo(t.name)&&(e.ext[Ro.OSExt][vo.osName]=t.name),xo(t.ver)&&(e.ext[Ro.OSExt][vo.ver]=t.ver)},e.prototype.applySdkContext=function(e){var t=this.sdk;e.ext[Ro.SdkExt][yo.seq]=t.getSequenceId(),e.ext[Ro.SdkExt][yo.epoch]=t.epoch,xo(t.installId)&&(e.ext[Ro.SdkExt][yo.installId]=t.installId)},e.prototype.applyIntWebContext=function(e){var t=this.intWeb,i=t.getMsfpc();xo(i)&&(e.ext[Ro.IntWebExt][Co.msfpc]=i);var n=t.getAnid();xo(n)&&(e.ext[Ro.IntWebExt][Co.anid]=n),xo(t.serviceName)&&(e.ext[Ro.IntWebExt][Co.serviceName]=t.serviceName)},e.prototype.applyUtcContext=function(e){var t=this.utc;e.ext[Ro.UtcExt][_o.popSample]=t.popSample,t.eventFlags>0&&(e.ext[Ro.UtcExt][_o.eventFlags]=t.eventFlags)},e.prototype.applyLocContext=function(e){e.ext[Ro.LocExt][Eo.tz]=this.loc.tz},e.prototype.applySessionContext=function(e){e.ext[Ro.AppExt][To.sessionId]=this.getSessionId()},e.prototype.applyDeviceContext=function(e){var t=this.device;xo(t.localId)&&(e.ext[Ro.DeviceExt][Io.localId]=t.localId),xo(t.make)&&(e.ext[Ro.DeviceExt][Io.make]=t.make),xo(t.model)&&(e.ext[Ro.DeviceExt][Io.model]=t.model),xo(t.deviceClass)&&(e.ext[Ro.DeviceExt][Io.deviceClass]=t.deviceClass)},e.prototype.applyCloudContext=function(e){var t=this.cloud;xo(t.role)&&(e.ext[Ro.CloudExt][bo.role]=t.role),xo(t.roleInstance)&&(e.ext[Ro.CloudExt][bo.roleInstance]=t.roleInstance),xo(t.roleVer)&&(e.ext[Ro.CloudExt][bo.roleVer]=t.roleVer)},e.prototype.applyAITraceContext=function(e){var t=this.telemetryTrace;xo(t.traceId)&&(e.ext[Ro.TraceExt][Ao.traceId]=t.traceId),xo(t.name)&&(e.ext[Ro.TraceExt][Ao.traceName]=t.name),xo(t.parentId)&&(e.ext[Ro.TraceExt][Ao.parentId]=t.parentId)},e}(),Fo=function(e){function t(){var i,n=e.call(this)||this;n.identifier="SystemPropertiesCollector",n.priority=3,n.version="3.1.2";var r={};return Ve(t,n,(function(t,s){t.initialize=function(r,s,a){e.prototype.initialize.call(n,r,s,a),i=new Uo(r,t._getTelCtx().getExtCfg(t.identifier),s)},t.processTelemetry=function(e,n){In(e,t.identifier),n=t._getTelCtx(n);var s=e.ext=e.ext?e.ext:{};e.data=e.data?e.data:{},s[Ro.AppExt]=s[Ro.AppExt]||{},s[Ro.UserExt]=s[Ro.UserExt]||{},s[Ro.WebExt]=s[Ro.WebExt]||{},s[Ro.OSExt]=s[Ro.OSExt]||{},s[Ro.SdkExt]=s[Ro.SdkExt]||{},s[Ro.IntWebExt]=s[Ro.IntWebExt]||{},s[Ro.UtcExt]=s[Ro.UtcExt]||{},s[Ro.LocExt]=s[Ro.LocExt]||{},s[Ro.DeviceExt]=s[Ro.DeviceExt]||{},s[Ro.TraceExt]=s[Ro.TraceExt]||{},s[Ro.CloudExt]=s[Ro.CloudExt]||{},i.applyApplicationContext(e),i.applyUserContext(e),i.applyWebContext(e),i.applyOsContext(e),i.applySdkContext(e),i.applyIntWebContext(e),i.applyUtcContext(e),i.applyLocContext(e),i.applySessionContext(e),i.applyDeviceContext(e),i.applyAITraceContext(e),i.applyCloudContext(e),lt(pt(s),(function(e){0===pt(s[e]).length&&delete s[e]})),function(e,t){e&&tt(e,(function(e,i){t[e]||(t[e]=i)}))}(r,e.data),t.processNext(e,n)},t.getPropertiesContext=function(){return i},t.setProperty=function(e,t){r[e]=t}})),n}return Xs(t,e),t}(ci);const Vo="https://ic3.events.data.microsoft.com/OneCollector/1.0/",Bo="https://eu-ic3.events.data.microsoft.com/OneCollector/1.0/",Ho="https://tb.events.data.microsoft.com/OneCollector/1.0/",$o="https://pf.events.data.microsoft.com/OneCollector/1.0/",Go="https://collector.azure.eaglex.ic.gov/OneCollector/1.0/",jo="https://collector.azure.microsoft.scloud/OneCollector/1.0/",qo="https://teams.events.data.microsoft.com/OneCollector/1.0",Wo="https://eu-teams.events.data.microsoft.com/OneCollector/1.0";var zo,Jo;!function(e){e.Public="Public",e.GccHigh="GCCHigh",e.Dod="DoD",e.AirGap08="AirGap08",e.AirGap09="AirGap09"}(zo||(zo={})),function(e){e.OrgId="orgid",e.Acs="acs",e.Spool="spool",e.GccHigh="gcch",e.GccHighAcs="gcch-acs",e.Dod="dod",e.DodAcs="dod-acs",e.AirGap08="ag08",e.AirGap08Acs="ag08-acs",e.AirGap09="ag09",e.AirGap09Acs="ag09-acs"}(Jo||(Jo={}));var Ko;!function(e){e.Public_ConversationServiceUrl_EUDB="https://api.flightproxy.skype.com/api/v2/cpconv",e.Public_TrouterServiceUrl_EUDB="https://go-eu.trouter.communication.microsoft.com/v4/a",e.Public_RegistrarServiceUrl_EUDB="https://emea.prod.registrar.skype.com/v3/registrations",e.Public_MdnTrapServiceUrl_EUDB="https://edge.skype.com/trap",e.Public_MdnTrapServiceTokenUrl_EUDB="https://edge.skype.com/trap/tokens",e.Public_MdnTrapRelaySkypeFqdns_EUDB="eu.relay.skype.com",e.Public_MdnTrapRelayTurnFqdns_EUDB="eu.relay.skype.com",e.Public_MdnTrapRelayTurnUrl_EUDB="",e.Enterprise_ConversationServiceUrl_EUDB="https://api.flightproxy.teams.microsoft.com/api/v2/epconv",e.Enterprise_TrouterServiceUrl_EUDB="https://go-eu.trouter.teams.microsoft.com/v4/a",e.Enterprise_RegistrarServiceUrl_EUDB="https://teams.microsoft.com/registrar/prod/v3/registrations",e.Enterprise_MdnTrapServiceUrl_EUDB="https://teams.microsoft.com/trap",e.Enterprise_MdnTrapServiceTokenUrl_EUDB="https://teams.microsoft.com/trap/tokens",e.Enterprise_MdnTrapRelaySkypeFqdns_EUDB="euaz.relay.teams.microsoft.com",e.Enterprise_MdnTrapRelayTurnFqdns_EUDB="euaz.relay.teams.microsoft.com",e.Enterprise_MdnTrapRelayTurnUrl_EUDB=""}(Ko||(Ko={}));const Yo={Public_ConversationServiceUrl:"https://api.flightproxy.skype.com/api/v2/cpconv",Public_TrouterServiceUrl:"https://go.trouter.communication.microsoft.com/v4/a",Public_RegistrarServiceUrl:"https://prod.registrar.skype.com/v3/registrations",Public_MdnTrapServiceUrl:"https://edge.skype.com/trap",Public_MdnTrapServiceTokenUrl:"https://edge.skype.com/trap/tokens",Public_MdnTrapRelaySkypeFqdns:"worldaz.tr.skype.com",Public_MdnTrapRelayTurnFqdns:"turn.azure.com",Public_MdnTrapRelayTurnUrl:"",GccHigh_ConversationServiceUrl:"https://api.cc.gov.teams.microsoft.us/conv/",GccHigh_TrouterServiceUrl:"https://go.trouter.gov.teams.microsoft.us/v4/a",GccHigh_RegistrarServiceUrl:"https://registrar.gov.teams.microsoft.us/v3/registrations",GccHigh_MdnTrapServiceUrl:"https://trap.gov.teams.microsoft.us",GccHigh_MdnTrapServiceTokenUrl:"https://trap.gov.teams.microsoft.us/tokens",GccHigh_MdnTrapRelaySkypeFqdns:"tr.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnFqdns:"turn.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnUrl:"https://turn.gov.teams.microsoft.us/relay",Dod_ConversationServiceUrl:"https://api.cc.dod.teams.microsoft.us/conv/",Dod_TrouterServiceUrl:"https://go.trouter.dod.teams.microsoft.us/v4/a",Dod_RegistrarServiceUrl:"https://registrar.dod.teams.microsoft.us/v3/registrations",Dod_MdnTrapServiceUrl:"https://trap.dod.teams.microsoft.us",Dod_MdnTrapServiceTokenUrl:"https://trap.dod.teams.microsoft.us/tokens",Dod_MdnTrapRelaySkypeFqdns:"tr.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnFqdns:"turn.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnUrl:"https://turn.dod.teams.microsoft.us/relay",AirGap08_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap08_TrouterServiceUrl:"https://go.trouter.teams.eaglex.ic.gov/v4/a",AirGap08_RegistrarServiceUrl:"https://api.registrar.teams.eaglex.ic.gov/v3/registrations",AirGap09_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap09_TrouterServiceUrl:"https://go.trouter.teams.microsoft.scloud/v4/a",AirGap09_RegistrarServiceUrl:"https://api.registrar.teams.microsoft.scloud/v3/registrations",Enterprise_ConversationServiceUrl:"https://api.flightproxy.teams.microsoft.com/api/v2/epconv",Enterprise_TrouterServiceUrl:"https://go.trouter.teams.microsoft.com/v4/a",Enterprise_RegistrarServiceUrl:"https://teams.microsoft.com/registrar/prod/v3/registrations",Enterprise_MdnTrapServiceUrl:"https://teams.microsoft.com/trap",Enterprise_MdnTrapServiceTokenUrl:"https://teams.microsoft.com/trap/tokens",Enterprise_MdnTrapRelaySkypeFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnUrl:"",Public_EcsServer_Url:"https://ecs.communication.microsoft.com",GccHigh_EcsServer_Url:"https://config.ecs.gov.teams.microsoft.us",Dod_EcsServer_Url:"https://config.ecs.dod.teams.microsoft.us",AirGap08_EcsServer_Url:"https://config.ecs.teams.eaglex.ic.go",AirGap09_EcsServer_Url:"https://config.ecs.teams.microsoft.scloud",Enterprise_Ecs_ServerUrl:"https://config.teams.microsoft.com"},Qo="https://global.mtgw.prod.communication.microsoft.com/",Xo="acsmt/v1/useraggregatepolicysettings/",Zo="acsmt/v2/useraggregatepolicysettings/",ec="acsmt/v2/threads/",tc="acsmt/v2/addParticipantsToThread/";var ic;!function(e){e.Consumer="consumer",e.Enterprise="enterprise"}(ic||(ic={}));const nc=["europe","france","germany","norway","switzerland","sweden"],rc=["emea","fr","de","se"],sc=Array.from(new Set(nc.concat(["qatar","uae","africa","uk"]))),ac=["asiapacific","india","japan","korea","australia"],oc=["unitedstates","brazil","canada"];var cc,lc;!function(e){e.EU="EU",e.RoW="RoW"}(cc||(cc={})),function(e){e.APAC="APAC",e.NOAM="NOAM",e.EMEA="EMEA",e.UNKNOWN=""}(lc||(lc={}));const dc={AUDIO:{JITTER:{GOOD:30,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},VIDEO:{JITTER:{GOOD:20,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},BANDWIDTH:{GOOD:1500,AVERAGE:500},CALL:{DURATION_IN_SEC:30,GROUP_ID:x(),AGGREGATION:{INTERVAL:1e3,DATAPOINTS:1},VIDEO_SIZE:{heigth:720,width:1280},MEDIASTREAM_TIMEOUT_IN_SEC:15,CONNECT_TIMEOUT_IN_SEC:10}};var hc;!function(e){e.AcsOrganizerRole="acsorganizer",e.AcsPresenterRole="acspresenter",e.AcsAttendeeRole="acsattendee",e.AcsConsumerRole="acsconsumer",e.TeamsOrganizer="organizer",e.TeamsAttendee="attendee",e.TeamsPresenter="presenter",e.TeamsCoorganizer="coorganizer"}(hc||(hc={}));const uc="4cf9ed87f7dc4e148f77855cd1f2fdca-61fb83a7-6672-4264-806f-7aded29f9b49-7618",gc="53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",pc="1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",mc="28:8133db4c-c049-4346-9edd-273f164a9227",fc="28:b1902c3e-b9f7-4650-9b23-5772bd429747",Sc="ACS-Public",vc=["en-us"],yc="setLanguage",Cc="transcription",_c=["scheduledMeeting","adhocMeeting"],Ec="0.0",Tc=!0,Ic=Symbol("global_telemetry_logger"),bc=Symbol("global_call_client_index"),Ac="orgid",Rc="gcch",wc="8:",Pc="28:",Mc="4:",Dc=":",Oc="Unknown",kc=wc+(Ac+Dc),Nc="8:dod:",Lc=wc+(Rc+Dc),xc="8:teamsvisitor:",Uc="8:acs:",Fc="8:spool:",Vc="8:dod-acs:",Bc="8:gcch-acs:",Hc=Pc+(Ac+Dc),$c=Pc+(Rc+Dc),Gc=Pc+"dod:",jc={audioBitrate:{aggregation_needed:!1,raw_data_reduction:!0},videoBitrate:{aggregation_needed:!1,raw_data_reduction:!0},downloadBitrate:{aggregation_needed:!0,multiplier:8,integer:!0,calculation_method:"rate"},bufferLengthInMs:{aggregation_needed:!0},mediaDelayInMs:{aggregation_needed:!0,is_internal:!0},videoHeight:{aggregation_needed:!1,raw_data_reduction:!0},videoWidth:{aggregation_needed:!1,raw_data_reduction:!0},playerHeight:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},playerWidth:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},currentPlayPosition:{aggregation_needed:!1,raw_data_reduction:!0}};var qc,Wc;!function(e){e.GroupCall="joinGroupId",e.GroupChatCall="joinThreadId",e.TeamsCoordinates="joinMeetingCoordinates",e.TeamsMeetingId="joinMeetingId",e.TeamsMeetingLink="joinMeetingLink",e.RoomCall="joinRoom",e.Unknown="Unknown"}(qc||(qc={})),function(e){e.Organizer="Organizer",e.Coorganizer="Co-organizer",e.Attendee="Attendee",e.Presenter="Presenter",e.Consumer="Consumer",e.Unknown="Unknown"}(Wc||(Wc={}));const zc={"msft-acs-room-deviceType":"room","msft-acs-3proom-deviceType":"3proom","msft-acs-mesh-deviceType":"mesh","msft-acs-mesh-deviceType-v2":"meshV2"};var Jc,Kc;!function(e){e.onlyUsedProxy="onlyUsedProxy",e.onlyUsedNonMsftTurn="onlyUsedNonMsftTurn",e.usedProxyAndNonMsftTurn="usedProxyAndNonMsftTurn",e.noCustomProxyAndTurnUsed="noCustomProxyAndTurnUsed"}(Jc||(Jc={})),function(e){e.RoleRestricted="RoleRestricted",e.FeatureNotSupported="FeatureNotSupported",e.ClientRestricted="ClientRestricted",e.MeetingRestricted="MeetingRestricted",e.UserPolicyRestricted="UserPolicyRestricted",e.NotInitialized="NotInitialized",e.Capable="Capable",e.NotCapable="NotCapable",e.CapabilityNotApplicableForTheCallType="CapabilityNotApplicableForTheCallType"}(Kc||(Kc={}));const Yc="roomsRoleBasedCapabilities",Qc="teamsRoleBasedCapabilities",Xc=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,Zc=/(\:[0-9]{1,6})(?=$|\/|\?)/;var el,tl;!function(e){e.TeamsProMgmt="TeamsProMgmt"}(el||(el={})),function(e){e.Disabled="Disabled",e.DisabledUserOverride="DisabledUserOverride"}(tl||(tl={}));const il="ScreenSharing";var nl;function rl(e){const t=n.getIdentifierKind(e);switch(t.kind){case nl.communicationUser:return t.communicationUserId;case nl.phoneNumber:if(t.rawId)return`${t.rawId}`;if(t.phoneNumber)return`${Mc}${t.phoneNumber}`;throw new I({defaultError:f.IDENTIFIER.PARSE_PHONENUMBER});case nl.microsoftTeamsUser:if(t.rawId)return t.rawId;if(t.microsoftTeamsUserId){if(t.isAnonymous)return`${xc}${t.microsoftTeamsUserId}`;if("public"===t.cloud)return`${kc}${t.microsoftTeamsUserId}`;if("dod"===t.cloud)return`${Nc}${t.microsoftTeamsUserId}`;if("gcch"===t.cloud)return`${Lc}${t.microsoftTeamsUserId}`;if(!t.cloud)return`${kc}${t.microsoftTeamsUserId}`}throw new I({defaultError:f.IDENTIFIER.PARSE_MSFT_TEAMS_USER});case nl.microsoftTeamsApp:if(t.rawId)return t.rawId;if(t.teamsAppId){if("public"===t.cloud)return`${Hc}${t.teamsAppId}`;if("dod"===t.cloud)return`${Gc}${t.teamsAppId}`;if("gcch"===t.cloud)return`${$c}${t.teamsAppId}`;if(!t.cloud)return`${Hc}${t.teamsAppId}`}throw new I({defaultError:f.IDENTIFIER.PARSE_MSFT_TEAMS_APP});case"unknown":return t.id;default:throw new I({defaultError:f.IDENTIFIER.PARSE_IDENTIFIER})}}function sl(e){return e.startsWith(kc)?{kind:nl.microsoftTeamsUser,rawId:e,microsoftTeamsUserId:e.substring(8),isAnonymous:!1,cloud:"public"}:e.startsWith(Nc)?{kind:nl.microsoftTeamsUser,rawId:e,microsoftTeamsUserId:e.substring(6),isAnonymous:!1,cloud:"dod"}:e.startsWith(Lc)?{kind:nl.microsoftTeamsUser,rawId:e,microsoftTeamsUserId:e.substring(7),isAnonymous:!1,cloud:"gcch"}:e.startsWith(xc)?{kind:nl.microsoftTeamsUser,rawId:e,microsoftTeamsUserId:e.substring(15),isAnonymous:!0}:e.startsWith(Mc)?{kind:nl.phoneNumber,rawId:e,phoneNumber:e.substring(2)}:e.startsWith(Uc)||e.startsWith(Fc)||e.startsWith(Bc)||e.startsWith(Vc)?{kind:nl.communicationUser,communicationUserId:e}:e.startsWith(Hc)?{kind:nl.microsoftTeamsApp,rawId:e,teamsAppId:e.substring(9),cloud:"public"}:e.startsWith($c)?{kind:nl.microsoftTeamsApp,rawId:e,teamsAppId:e.substring(8),cloud:"gcch"}:e.startsWith(Gc)?{kind:nl.microsoftTeamsApp,rawId:e,teamsAppId:e.substring(7),cloud:"dod"}:{kind:nl.unknown,id:e}}function al(e){return!!e.startsWith(Pc)}function ol(e){const t=n.getIdentifierKind(e);switch(t.kind){case nl.communicationUser:if(!(t.communicationUserId.startsWith(Uc)||t.communicationUserId.startsWith(Fc)||t.communicationUserId.startsWith(Bc)||t.communicationUserId.startsWith(Vc)))throw new I({defaultError:f.IDENTIFIER.INVALID_COMM_USER});return t;case"phoneNumber":return t;case nl.microsoftTeamsUser:if(t.rawId&&!t.rawId.startsWith(kc)&&!t.rawId.startsWith(Nc)&&!t.rawId.startsWith(Lc)&&!t.rawId.startsWith(xc))throw new I({defaultError:f.IDENTIFIER.INVALID_MSFT_TEAMS_USER_RAWID});if(!t.microsoftTeamsUserId)throw new I({defaultError:f.IDENTIFIER.INVALID_MSFT_TEAMS_USER_USERID});return t;case nl.microsoftTeamsApp:if(t.rawId&&!t.rawId.startsWith(Pc))throw new I({defaultError:f.IDENTIFIER.INVALID_MSFT_TEAMS_APP_RAWID});if(!t.teamsAppId)throw new I({defaultError:f.IDENTIFIER.INVALID_MSFT_TEAMS_APP_APPID});return t;case nl.unknown:if(!t.id)throw new I({defaultError:f.IDENTIFIER.INVALID_UNKNOWN_IDENTIFIER});return t;default:throw new I({defaultError:f.IDENTIFIER.PARSE_INVALID_IDENTIFIER})}}!function(e){e.communicationUser="communicationUser",e.microsoftTeamsUser="microsoftTeamsUser",e.microsoftTeamsApp="microsoftTeamsApp",e.phoneNumber="phoneNumber",e.unknown="unknown",e.group="group"}(nl||(nl={}));const cl="1.24.1.0_stable",ll="1.24.1";function dl(){const e="ACS_CLIENT_INTERNAL_SZK_VERSION".replace("Z","D");return cl===e?"1.0.0.0":cl}function hl(){const e="ACS_CLIENT_SZK_VERSION".replace("Z","D");return ll===e?"1.0.0.0":ll}function ul(e,t){if(Array.isArray(e))return t.slice()}function gl(e){return Array.isArray(e)&&0!==e.length}function pl(e){return null==e||void 0===e}function ml(e,t){return void 0!==e?e:t}function fl(e){try{return JSON.stringify(e,null,2)}catch(t){return`failed to stringify obj ${e}`}}let Sl,vl={telemetry:{callStatsFlushTimeout:6e3,discardedTelemetryRetryTimeout:5e3,discardedEventsBufferMaxLength:1e3,discardedEventsMaxRetries:3,telemetryFlushTimeout:2e3,allowedEvents:[],blockedEvents:["acs_calling_feature_usage","acs_calling_call_client_init"],limit:{outSideCall:{enabled:!1,deltaTimeInMs:15e3,includedEvents:[],excludedEvents:[]},rates:[]},telemetryBeforeUnload:!1,gzipTelemetryPayload:!0,localStorageEnable:!1,mediaStatsConfig:{enabled:!0,throttleTelemetry:1,aggregationInterval:10,dataPointsPerAggregation:6,metricsProperties:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},liveStreamStatsConfig:{enabled:!1,fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",additionalStats:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},reportSdkUaToService:!1,reportEnvToService:!1,sendNetworkChangedTelemetry:!1,deviceChangedEvents:{enabled:!1,piiSafeWordsMode:"merge",piiSafeWords:["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"]},maxExistingReportedParticipants:25},mediaStats:{blockMetrics:{},transformMetrics:{},fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",timerThrottlingFilter:{enabled:!1,delayRatio:0,filterRange:{"audio.send":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"audio.receive":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"video.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:66},frameRateEncoded:{min:0,max:66},frameRateSent:{min:0,max:66}},"video.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:66},frameRateDecoded:{min:0,max:66},frameRateReceived:{min:0,max:66}},"screenShare.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:33},frameRateEncoded:{min:0,max:33},frameRateSent:{min:0,max:33}},"screenShare.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:33},frameRateDecoded:{min:0,max:33},frameRateReceived:{min:0,max:33}}}}},debugInfo:{broadcastChannelName:"acs_broadcast_channel",tabsBroadcastDelay:5e3,tabsUpdateDelay:500,enableLogDump:!1,maxLogDumpLength:500,includeList:[],excludeList:[]},volumeIndicator:{fftSize:512,minDecibels:-127,maxDecibels:0,smoothingConstant:.4,microphoneVolumeSampleIntervalMs:200,normalisedMaxVolume:100,maxAvailableVolume:255},telemetryEvents:{eventNameToPriority:{eventName:["acs_calling_call_stats"],priority:[cn]}},rendering:{remoteVideo:{createViewTimeout:6e3,createViewUnsubscribeTimeout:2500,debounceTimeout:1500,createViewSendMediaStats:!0,createViewSendMediaStatsMaxLength:120,createViewSendMediaStatsInitialMaxLength:1,createViewFailureNetworkUfdCheckWindowInMs:2e3,forceCheckIfVideoWasAttachedToDom:!0,checkIfVideoAttachedToDom_poll:!0,checkIfVideoAttachedToDom_intervalTime:5e3,checkIfVideoAttachedToDom_intervalMaxTries:12,checkIfVideoAttachedToDom_timeout:2e4,createViewSenderStatsDuration:6e4,registeredViewIdsMaxLength:0,getMediaStreamTimeout:6e3,largeMeeting:{handleVideoRendering:!0,participantCountThreshold:100,dominantSpeakersWithVideoOn_topCount:4}}},captions:{acsBotMri:mc,teamsBotMri:fc,clientInfo:Sc,availableLanguages:vc,enabled:!0,acs:{botMri:mc,clientInfo:{ring:Sc},spokenLanguages:{enabled:!0,languages:vc}},teams:{botMri:fc,clientInfo:{ring:"Teams-Public"},spokenLanguages:{enabled:!0,languages:vc},captionLanguages:{enabled:!1,languages:["en"]}}},audioEffects:{enableAudioEffects:!1,maxStringLengthForTelemetry:250},videoEffects:{enableVideoEffects:!1,effectInitTimeThresholdInMs:2e4,fpsWarningThreshold:5,waitTimeToInitiateFpsChecksInMs:2e4,fpsCheckIntervalTimeInMs:3e3},calling:{enableMuteOthers:!0,enableSmePassFakeConversation:!1,doNotWaitForTrouter:!1,hangUpCallOnPageHide:!1,maxNumberOfTokenFetchRetries:10,deviceSelectionTimeoutInMs:3e3,deviceNotFunctioningMuted:!0,muteUnmuteOnMicrophoneNotFunctioning:!1,unmuteDelayForMicrophoneNotFunctioningInMs:0,preventStopAudio:!1,preventFakeMute:!1,osAutoRecoverAudio:!1,deviceCaptureMuteRecover:!1,allowMuteOnBadUfd:!0,preventStopVideo:!0,mediaMetricsDeviceEventsEnabled:!1,allowAccessRawMediaStream:!1,applyViewLimit:!1,deviceCaptureMutedVideo:!0,removeLvsCheckOnCallStartAndCallAccept:!1,removeLocalAudioStreamCheckOnCallStartAndCallAccept:!1,constraints:{enabled:!1,maxOutgoingResolution:0,maxOutgoingFrameRate:0,maxOutgoingVideoBitrate:0},supportLiveStreaming:!1,liveStreamingBotIds:["28:f4693563-c70b-4e4d-bda6-01792aa21440","28:e32c9418-a835-4eb1-bfb9-733fa74dd6e8"],composedStreamBotIds:["28:5f2511f1-6da9-41d9-80d9-af7da23a2c27","28:accb0009-8d12-4cfe-969c-39b204e3ed0c"],setDeviceType:!1,devicePermissions:{splitAskAudioVideo:!1,timeoutInBetween:0,getCurrentState:!0},applicationSettingsUrls:{Public_ConversationServiceUrl:Yo.Public_ConversationServiceUrl,Public_TrouterServiceUrl:Yo.Public_TrouterServiceUrl,Public_RegistrarServiceUrl:Yo.Public_RegistrarServiceUrl,Public_MdnTrapServiceUrl:Yo.Public_MdnTrapServiceUrl,Public_MdnTrapServiceTokenUrl:Yo.Public_MdnTrapServiceTokenUrl,Public_MdnTrapRelaySkypeFqdns:Yo.Public_MdnTrapRelaySkypeFqdns,Public_MdnTrapRelayTurnFqdns:Yo.Public_MdnTrapRelayTurnFqdns,Public_MdnTrapRelayTurnUrl:Yo.Public_MdnTrapRelayTurnUrl,GccHigh_ConversationServiceUrl:Yo.GccHigh_ConversationServiceUrl,GccHigh_TrouterServiceUrl:Yo.GccHigh_TrouterServiceUrl,GccHigh_RegistrarServiceUrl:Yo.GccHigh_RegistrarServiceUrl,GccHigh_MdnTrapServiceUrl:Yo.GccHigh_MdnTrapServiceUrl,GccHigh_MdnTrapServiceTokenUrl:Yo.GccHigh_MdnTrapServiceTokenUrl,GccHigh_MdnTrapRelaySkypeFqdns:Yo.GccHigh_MdnTrapRelaySkypeFqdns,GccHigh_MdnTrapRelayTurnFqdns:Yo.GccHigh_MdnTrapRelayTurnFqdns,GccHigh_MdnTrapRelayTurnUrl:Yo.GccHigh_MdnTrapRelayTurnUrl,Dod_ConversationServiceUrl:Yo.Dod_ConversationServiceUrl,Dod_TrouterServiceUrl:Yo.Dod_TrouterServiceUrl,Dod_RegistrarServiceUrl:Yo.Dod_RegistrarServiceUrl,Dod_MdnTrapServiceUrl:Yo.Dod_MdnTrapServiceUrl,Dod_MdnTrapServiceTokenUrl:Yo.Dod_MdnTrapServiceTokenUrl,Dod_MdnTrapRelaySkypeFqdns:Yo.Dod_MdnTrapRelaySkypeFqdns,Dod_MdnTrapRelayTurnFqdns:Yo.Dod_MdnTrapRelayTurnFqdns,Dod_MdnTrapRelayTurnUrl:Yo.Dod_MdnTrapRelayTurnUrl,AirGap08_ConversationServiceUrl:Yo.AirGap08_ConversationServiceUrl,AirGap08_TrouterServiceUrl:Yo.AirGap08_TrouterServiceUrl,AirGap08_RegistrarServiceUrl:Yo.AirGap08_RegistrarServiceUrl,AirGap09_ConversationServiceUrl:Yo.AirGap09_ConversationServiceUrl,AirGap09_TrouterServiceUrl:Yo.AirGap09_TrouterServiceUrl,AirGap09_RegistrarServiceUrl:Yo.AirGap09_RegistrarServiceUrl,Enterprise_ConversationServiceUrl:Yo.Enterprise_ConversationServiceUrl,Enterprise_TrouterServiceUrl:Yo.Enterprise_TrouterServiceUrl,Enterprise_RegistrarServiceUrl:Yo.Enterprise_RegistrarServiceUrl,Enterprise_MdnTrapServiceUrl:Yo.Enterprise_MdnTrapServiceUrl,Enterprise_MdnTrapServiceTokenUrl:Yo.Enterprise_MdnTrapServiceTokenUrl,Enterprise_MdnTrapRelaySkypeFqdns:Yo.Enterprise_MdnTrapRelaySkypeFqdns,Enterprise_MdnTrapRelayTurnFqdns:Yo.Enterprise_MdnTrapRelayTurnFqdns,Enterprise_MdnTrapRelayTurnUrl:Yo.Enterprise_MdnTrapRelayTurnUrl},applicationSettingsEudbUrls:{Public_ConversationServiceUrl_EUDB:Ko.Public_ConversationServiceUrl_EUDB,Public_TrouterServiceUrl_EUDB:Ko.Public_TrouterServiceUrl_EUDB,Public_RegistrarServiceUrl_EUDB:Ko.Public_RegistrarServiceUrl_EUDB,Public_MdnTrapServiceUrl_EUDB:Ko.Public_MdnTrapServiceUrl_EUDB,Public_MdnTrapServiceTokenUrl_EUDB:Ko.Public_MdnTrapServiceTokenUrl_EUDB,Public_MdnTrapRelaySkypeFqdns_EUDB:Ko.Public_MdnTrapRelaySkypeFqdns_EUDB,Public_MdnTrapRelayTurnFqdns_EUDB:Ko.Public_MdnTrapRelayTurnFqdns_EUDB,Public_MdnTrapRelayTurnUrl_EUDB:Ko.Public_MdnTrapRelayTurnUrl_EUDB,Enterprise_ConversationServiceUrl_EUDB:Ko.Enterprise_ConversationServiceUrl_EUDB,Enterprise_TrouterServiceUrl_EUDB:Ko.Enterprise_TrouterServiceUrl_EUDB,Enterprise_RegistrarServiceUrl_EUDB:Ko.Enterprise_RegistrarServiceUrl_EUDB,Enterprise_MdnTrapServiceUrl_EUDB:Ko.Enterprise_MdnTrapServiceUrl_EUDB,Enterprise_MdnTrapServiceTokenUrl_EUDB:Ko.Enterprise_MdnTrapServiceTokenUrl_EUDB,Enterprise_MdnTrapRelaySkypeFqdns_EUDB:Ko.Enterprise_MdnTrapRelaySkypeFqdns_EUDB,Enterprise_MdnTrapRelayTurnFqdns_EUDB:Ko.Enterprise_MdnTrapRelayTurnFqdns_EUDB,Enterprise_MdnTrapRelayTurnUrl_EUDB:Ko.Enterprise_MdnTrapRelayTurnUrl_EUDB},maxDisplayNameLength:256,callDiagnostics:dc,eudb:{isEnabled:!0,countries:nc,regions:rc,defaultDataLocationEurope:!1,EmeaTenants:sc,ApacTenants:ac,NoamTenants:oc,acsCompliantEvents:{},isRgnClaimEnabledForACS:!0,sendRegionToNgc:!0},tfl:{isEnabled:!1,hosts:["teams.live.com"]},lobbyAdmitAndReject:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},localRecording:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},enableCustomTurnUsage:!1,allowProxyForTeamsCalls:!1,allowCustomTurnForTeamsCalls:!1,spotlight:{enabled:!0,maxSpotlightParticipants:7,supportedRoles:["presenter","organizer","coorganizer"],meetingTypes:["scheduledMeeting"]},teamsMeetingAudioConferencing:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},transfer:{autoAccept:!0},reaction:{enabled:!0,telemetryEventAggregationIntervalInSecond:3,enableStateServiceConsoleLogs:!0,StateServiceProxySettings:{batchedRequestsEnabled:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,pingTimeoutInMs:2e4,pongTimeoutInMs:5e3,maxSessionRetries:2,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheLength:64,maxOfflineMessageCacheTimeInMs:2e4,autoRoutingEnabled:!0}},pptlive:{enabled:!0,wdParams:{wdModernSlideShowInTeams:!0,wdPresenterViewInTeams:!1,wdForceModernSlideShowInTeams:!1,isMovePrivateViewingToPPTEnabled:!0},appSettings:{takeFocusOnBoot:!0,enableAdvanceOnClick:!1,enableAdvanceOnTap:!1},stateServiceProxySettings:{batchedRequestsEnabled:!1,maxRoundtripRaw:300,pingTimeoutInMs:15e3,pongTimeoutInMs:15e3,retryIntervalsInMs:[1e3,2e3,4e3],verbose:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,autoRoutingEnabled:!0,useServiceGeneratedClientId:!0,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheTimeInMs:2e4,maxOfflineMessageCacheLength:64,allowReconnectOnSendMessage:!0},enableStateServiceInPreviewerFeatures:'["Ink","Media","Nav","NavSync","PresUrl","PresUrlBoot"]',featureGates:'{"ModernSlideShowAllowListForFileType":"pptx;ppsx;potx;pptm;ppsm;pot;ppt;odp;pps"}'},blacklistedBots:[],musicOnHoldEnabled:!0,customContext:{userToUser:{headerKey:"User-To-User"},xHeaders:{headerKeyPrefix:"X-MS-Custom-",headerKeyRegex:"^[a-zA-Z0-9.!%*_+~-]{1,64}$",headerValueRegex:"^[a-zA-Z0-9.!%*_+~=;-]{1,256}$",maxCount:5}}},teamsMeetingShortUrlJoin:{validatePattern:!0,regexPattern:"https:\\/\\/teams\\.(live|microsoft)\\.com\\/meet\\/\\d+(\\?p=[a-zA-Z0-9]+)?"},dataChannel:{maxReceiveBufferSize:2097152,receiveTimeoutInMs:12e4,maxSendBandwidth:5e5,maxBroadcastPacketRate:80,defaultBitrate:32e3,maxMessageSize:32768,enableBroadcastLimitOnReliableChannel:!1,dataIdConfigs:[]},unmixedAudio:{maxStreamSize:7,operationTimeoutInMs:1e4,skipProviderStateCheck:!1},roles:{acsOrganizer:hc.AcsOrganizerRole,acsPresenter:hc.AcsPresenterRole,acsAttendee:hc.AcsAttendeeRole,acsConsumer:hc.AcsConsumerRole,teamsAttendee:hc.TeamsAttendee,teamsOrganizer:hc.TeamsOrganizer,teamsPresenter:hc.TeamsPresenter,teamsCoorganizer:hc.TeamsCoorganizer},roomsRoleBasedCapabilities:{presenter:_l("roomJoin","Presenter"),attendee:_l("roomJoin","Attendee"),consumer:_l("roomJoin","Consumer")},teamsRoleBasedCapabilities:{organizer:_l("teamsMeetingJoin","Organizer"),coorganizer:_l("teamsMeetingJoin","Co-organizer"),presenter:_l("teamsMeetingJoin","Presenter"),attendee:_l("teamsMeetingJoin","Attendee")},environments:{android:{chrome:{minVersion:Ec,isSupportedOnSdkVersion:Tc},edgeanaheim:{minVersion:Ec,isSupportedOnSdkVersion:Tc}},ios:{safari:{minVersion:Ec,isSupportedOnSdkVersion:Tc},chrome:{minVersion:Ec,isSupportedOnSdkVersion:!hl().includes("stable")},applewebview:{minVersion:Ec,isSupportedOnSdkVersion:Tc}},mac:{chrome:{minVersion:Ec,isSupportedOnSdkVersion:Tc},safari:{minVersion:Ec,isSupportedOnSdkVersion:Tc},edgeanaheim:{minVersion:Ec,isSupportedOnSdkVersion:Tc},firefox:{minVersion:Ec,isSupportedOnSdkVersion:!hl().includes("stable")}},windows:{chrome:{minVersion:Ec,isSupportedOnSdkVersion:Tc},chromium:{minVersion:Ec,isSupportedOnSdkVersion:Tc},edgeanaheim:{minVersion:Ec,isSupportedOnSdkVersion:Tc},firefox:{minVersion:Ec,isSupportedOnSdkVersion:!hl().includes("stable")}},linux:{chrome:{minVersion:Ec,isSupportedOnSdkVersion:Tc},firefox:{minVersion:Ec,isSupportedOnSdkVersion:!hl().includes("stable")}}},MiddleTier:{enabled:!1,maxRetry:3,baseServiceUrl:Qo,policyUrlSuffix:Xo,policyUrlSuffixV2:Zo,userPolicySettingsApi:!1,serverManagedThreadIdApiConfiguration:{allowServerThreadCreation:!0,decoupleChatThreadFromCalls:!0,createThreadSuffix:ec,addParticipantSuffix:tc}},PowerPointStateServiceUrl:{public:{amer:"https://usc.pptservicescast.officeapps.live.com",apac:"https://apac.pptservicescast.officeapps.live.com",emea:"https://emea.pptservicescast.officeapps.live.com",uk:"https://ukc.pptservicescast.officeapps.live.com",eu:"https://euc.pptservicescast.officeapps.live.com",in:"https://inc.pptservicescast.officeapps.live.com",au:"https://auc.pptservicescast.officeapps.live.com",ca:"https://canc.pptservicescast.officeapps.live.com",fr:"https://fr.pptservicescast.officeapps.live.com",jp:"https://jpc.pptservicescast.officeapps.live.com",ae:"https://ae.pptservicescast.officeapps.live.com",kr:"https://krc.pptservicescast.officeapps.live.com",sg:"https://sg.pptservicescast.officeapps.live.com",za:"https://za.pptservicescast.officeapps.live.com",de:"https://de.pptservicescast.officeapps.live.com",ch:"https://ch.pptservicescast.officeapps.live.com",no:"https://no.pptservicescast.officeapps.live.com",br:"https://pptservicescast.officeapps.live.com",se:"https://se.pptservicescast.officeapps.live.com",qa:"https://qa.pptservicescast.officeapps.live.com",gallatin:"https://pptservicescast.osi.microsoftonline.cn",pl:"https://pl.pptservicescast.officeapps.live.com",it:"https://euc.pptservicescast.officeapps.live.com",il:"https://pptservicescast.officeapps.live.com",mx:"https://pptservicescast.officeapps.live.com"},gcc:"https://pptservicescast.gcc.osi.office365.us",gcch:"https://pptservicescast.osi.office365.us",dod:"https://pptservicescast.osi.apps.mil",ag08:"https://pptservicescast.osi.eaglex.ic.gov",ag09:"https://pptservicescast.osi.microsoft.scloud"}};function yl(){return vl}function Cl(){return Sl}function _l(e,t){let i={turnVideoOn:!0,unmuteMic:!0,shareScreen:!0,removeParticipant:!0,hangUpForEveryOne:!0,addCommunicationUser:!0,addTeamsUser:!0,addPhoneNumber:!0,manageLobby:!0,spotlightParticipant:!0,removeParticipantsSpotlight:!0,blurBackground:!0,startLiveCaptions:!0,stopLiveCaptions:!0,raiseHand:!0,pstnDialOut:!0,muteOthers:!0,useReactions:!0,viewAttendeeNames:!0};if("teamsMeetingJoin"==e){if("Presenter"==t||"Co-organizer"==t||"Organizer"==t)return{...i};if("Attendee"==t){let e={...i};return e.removeParticipant=!1,e.manageLobby=!1,e.spotlightParticipant=!1,e.removeParticipantsSpotlight=!1,e.shareScreen=!1,e.muteOthers=!1,e}}if("roomJoin"==e){let e={...i};if(e.removeParticipant=!1,e.hangUpForEveryOne=!1,e.addCommunicationUser=!1,e.addTeamsUser=!1,e.manageLobby=!1,e.spotlightParticipant=!1,e.removeParticipantsSpotlight=!1,e.blurBackground=!1,e.startLiveCaptions=!1,e.stopLiveCaptions=!1,e.raiseHand=!1,"Presenter"==t)return{...e};if("Attendee"==t){let t={...e};return t.shareScreen=!1,t.muteOthers=!1,t.addPhoneNumber=!1,t.pstnDialOut=!1,t}if("Consumer"==t){let t={...e};return t.turnVideoOn=!1,t.unmuteMic=!1,t.shareScreen=!1,t.muteOthers=!1,t.addPhoneNumber=!1,t.pstnDialOut=!1,t}}return i}const El=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function Tl(e){switch(e){case"Crop":return 1;case"Fit":return 2;default:return 0}}function Il(e){return e.toString===Object.prototype.toString?JSON.stringify(e):e.toString()}function bl(e,t){try{return"string"==typeof e?new Blob([e]).size:e.byteLength}catch(e){return t.error(e),0}}function Al(e){let t={};return e.forEach(((e,i)=>{t[i]=e})),Object.freeze(t)}function Rl(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)},dispose:()=>{i&&(t("disposed"),i=!1)}}}function wl(e,t="Timed promise; rejected."){let i,n,r,s=!0;const a=()=>{window.clearTimeout(r)};let o=new Promise(((e,t)=>{i=t=>{a(),s=!1,e(t)},n=e=>{a(),s=!1,t(e)}}));return{timerStart:()=>{r=window.setTimeout((()=>{n(new I({defaultError:f.FEATURES.VIDEO_EFFECTS.EFFECT_PROVIDER_TIMEOUT}))}),e)},timerStop:a,deferredPromise:{promise:o,resolve:i,reject:n,isPending:()=>s,dispose:()=>{n("disposed")}}}}function Pl(e,t){if(null==e)throw new I({defaultError:t})}function Ml(e,t){if("object"!=typeof e)throw new I({defaultError:t})}function Dl(e){let[,t]=e?.split(".");if(void 0===t)throw new I({defaultError:f.INTERNAL.TOKEN_PAYLOAD_UNDEFINED});return t=t.replace(/-/g,"+").replace(/_/g,"/"),JSON.parse(decodeURIComponent(escape(atob(t))))}function Ol(e,t){throw t.error(`CallingCommunicationError: Message={${e.message},Code={${e.code}}, SubCode={${e.subCode}}, ResultCategories={${e.resultCategories}}`),new I({defaultError:e})}function kl(){}function Nl(e,t){const i=function(e){return xl(e)?yl().calling.eudb.regions:yl().calling.eudb.countries}(e);return!!t&&!!i.find((e=>e===t))}function Ll(e,t){return yl().calling.eudb.isEnabled&&Nl(e,t||"")}function xl(e){return yl().calling.eudb.isRgnClaimEnabledForACS||!!e&&e===ic.Enterprise||!1}async function Ul(e,t,i){let n;try{if(!e)throw new I({defaultError:f.INTERNAL.NO_TOKEN_PROVIDED});try{n=(await e.getToken(i))?.token}catch(e){throw new I("The token returned from the tokenRefresher is expired."===e.message?{defaultError:f.CALL_AGENT.ACCESSTOKEN_EXPIRED}:{defaultError:f.INTERNAL.GET_TOKEN})}if(!n)throw new I({defaultError:f.INTERNAL.EMPTY_TOKEN})}catch(e){throw new I({defaultError:f.INTERNAL.GET_TOKEN,originalError:e})}try{let e=Dl(n);if(!e)throw new I({defaultError:f.INTERNAL.TOKEN_UNDEFINED});if("string"!=typeof e.acsScope)throw new I({defaultError:f.INTERNAL.INVALID_TOKEN_SCOPE_FORMAT});if(!e.acsScope.split(",").find((e=>"voip"===e||"voip.join"===e)))throw new I({defaultError:f.INTERNAL.INVALID_TOKEN_SCOPE});const i=e.resourceId,r=sl(`8:${e.skypeid}`);if(!i&&"microsoftTeamsUser"!==r?.kind)throw new I({defaultError:f.INTERNAL.RESOURCE_NOT_FOUND_IN_TOKEN});let s=e.skypeid;if(!s)throw new I({defaultError:f.INTERNAL.USERID_NOT_FOUND_IN_TOKEN});const a=function(e){const t=e.substring(0,e.indexOf(":"));if(!t)throw new I({defaultError:f.IDENTIFIER.NO_CLOUD_PREFIX_FOUND});switch(t){case Jo.OrgId:case Jo.Acs:case Jo.Spool:return zo.Public;case Jo.GccHigh:case Jo.GccHighAcs:return zo.GccHigh;case Jo.Dod:case Jo.DodAcs:return zo.Dod;case Jo.AirGap08:case Jo.AirGap08Acs:return zo.AirGap08;case Jo.AirGap09:case Jo.AirGap09Acs:return zo.AirGap09;default:return zo.Public}}(s),o=!!e.tid,c=!!e.rgn;return{jwtToken:n,acsResourceId:i,identityMri:s,cloudType:a,isCte:o,region:(o||t?e.rgn:e.resourceLocation)||"",rgnClaimExists:c,exp:1e3*e.exp}}catch(e){throw new I({defaultError:f.INTERNAL.PARSE_TOKEN_FAIL,originalError:e})}}function Fl(e,t=!1){if(void 0===e)return"void";if(e instanceof Error)return e.toString();if(e instanceof String||e instanceof Number||e instanceof Boolean)return e.toString();try{return e.stack&&(e.stack=(e=>{try{return e.split("\n")[0]}catch(e){return"invalid stack"}})(e.stack)),(t?JSON.stringify(e):JSON.stringify(e,El,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(t){return`failed to get error information:${e&&"function"==typeof e.toString&&e.toString()} ${e&&e.response&&JSON.stringify(e.response)}`}}function Vl(e,t){return t.info("permission state to boolean",e),"granted"===e}function Bl(e,t,i=[]){let n=[];try{const r=Array.isArray(e);for(const s in e){const a=e[s],o=r?+s:s;if(!(s in t)){n.push({type:"REMOVE",path:[o],oldValue:e[s]});continue}const c=t[s],l="object"==typeof a&&"object"==typeof c;if(a&&c&&l&&!T[Object.getPrototypeOf(a).constructor.name]&&!i.includes(a)){const e=Bl(a,c);n.push.apply(n,e.map((e=>(e.path.unshift(o),e))))}else a===c||l&&(isNaN(a)?a+""==c+"":+a==+c)||n.push({path:[o],type:"CHANGE",value:c,oldValue:a})}const s=Array.isArray(t);for(const i in t)i in e||n.push({type:"CREATE",path:[s?+i:i],value:t[i]})}catch(e){}return n}function Hl(e,t){const i={[e.roles.acsOrganizer.toLowerCase()]:Wc.Organizer,[e.roles.teamsOrganizer.toLowerCase()]:Wc.Organizer,[e.roles.acsPresenter.toLowerCase()]:Wc.Presenter,[e.roles.teamsPresenter.toLowerCase()]:Wc.Presenter,[e.roles.acsAttendee.toLowerCase()]:Wc.Attendee,[e.roles.teamsAttendee.toLowerCase()]:Wc.Attendee,[e.roles.acsConsumer.toLowerCase()]:Wc.Consumer,[e.roles.teamsCoorganizer.toLowerCase()]:Wc.Coorganizer};return t&&i[t.toString().toLowerCase()]?i[t.toString().toLowerCase()]:Wc.Unknown}function $l(e,t,i,n,r){if(i||n&&"microsoftTeamsUser"===n.kind||r&&function(e){return!!(e.meetingId||e.meetingLink||e.messageId||e.organizerId||e.tenantId||e.threadId)}(r)){const i=yl().calling.allowProxyForTeamsCalls,n=e.proxyInUse,r=yl().calling.allowCustomTurnForTeamsCalls,s=t.customRelayManagerInUse;if(n&&!i)return!1;if(s&&!r)return!1}return!0}function Gl(e){return!!e.find((e=>"microsoftTeamsUser"===n.getIdentifierKind(e).kind))}function jl(e){if(!e||!e.customContext)return;const t={};if(e.customContext.userToUser&&(t[yl().calling.customContext.userToUser.headerKey]=e.customContext.userToUser),e.customContext.xHeaders){const i=yl().calling.customContext.xHeaders.headerKeyPrefix,n=new RegExp(yl().calling.customContext.xHeaders.headerKeyRegex),r=new RegExp(yl().calling.customContext.xHeaders.headerValueRegex);e.customContext.xHeaders.forEach((e=>{const t=e.key.toLowerCase().startsWith(i.toLowerCase());e.key=t?`${i}${e.key.slice(i.length)}`:`${i}${e.key}`})),e.customContext.xHeaders.filter((e=>n.test(e.key)&&r.test(e.value))).slice(0,yl().calling.customContext.xHeaders.maxCount).forEach((e=>t[e.key]=e.value))}return Object.keys(t).length>0?{sipHeaders:t}:void 0}function ql(e){return Wl(e.customHeaderContext)||Wl(e.clientTransferContext)}function Wl(e){if(!e)return;const t=e.sipHeaders||e.customContext?.sipHeaders;if(!t)return;const i=yl().calling.customContext.userToUser.headerKey,n=yl().calling.customContext.xHeaders.headerKeyPrefix,r={userToUser:t[i],xHeaders:Object.entries(t).filter((e=>e[0]?.startsWith(n))).map((e=>({key:e[0],value:e[1]})))};return void 0===r.userToUser&&0===r.xHeaders?.length?void 0:r}var zl=a((function(e,t){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,i,n,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),r);else for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){var t,i,n,r,s,a;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(a=new Uint8Array(n),r=0,t=0,i=e.length;t<i;t++)s=e[t],a.set(s,r),r+=s.length;return a}},r={arraySet:function(e,t,i,n,r){for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,n)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,r))},t.setTyped(i)})),Jl=0,Kl=1;function Yl(e){for(var t=e.length;--t>=0;)e[t]=0}var Ql=0,Xl=29,Zl=256,ed=Zl+1+Xl,td=30,id=19,nd=2*ed+1,rd=15,sd=16,ad=7,od=256,cd=16,ld=17,dd=18,hd=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ud=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],gd=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],pd=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],md=new Array(2*(ed+2));Yl(md);var fd=new Array(2*td);Yl(fd);var Sd=new Array(512);Yl(Sd);var vd=new Array(256);Yl(vd);var yd=new Array(Xl);Yl(yd);var Cd,_d,Ed,Td=new Array(td);function Id(e,t,i,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}function bd(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function Ad(e){return e<256?Sd[e]:Sd[256+(e>>>7)]}function Rd(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function wd(e,t,i){e.bi_valid>sd-i?(e.bi_buf|=t<<e.bi_valid&65535,Rd(e,e.bi_buf),e.bi_buf=t>>sd-e.bi_valid,e.bi_valid+=i-sd):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function Pd(e,t,i){wd(e,i[2*t],i[2*t+1])}function Md(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function Dd(e,t,i){var n,r,s=new Array(rd+1),a=0;for(n=1;n<=rd;n++)s[n]=a=a+i[n-1]<<1;for(r=0;r<=t;r++){var o=e[2*r+1];0!==o&&(e[2*r]=Md(s[o]++,o))}}function Od(e){var t;for(t=0;t<ed;t++)e.dyn_ltree[2*t]=0;for(t=0;t<td;t++)e.dyn_dtree[2*t]=0;for(t=0;t<id;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*od]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function kd(e){e.bi_valid>8?Rd(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function Nd(e,t,i,n){var r=2*t,s=2*i;return e[r]<e[s]||e[r]===e[s]&&n[t]<=n[i]}function Ld(e,t,i){for(var n=e.heap[i],r=i<<1;r<=e.heap_len&&(r<e.heap_len&&Nd(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!Nd(t,n,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=n}function xd(e,t,i){var n,r,s,a,o=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],r=e.pending_buf[e.l_buf+o],o++,0===n?Pd(e,r,t):(Pd(e,(s=vd[r])+Zl+1,t),0!==(a=hd[s])&&wd(e,r-=yd[s],a),Pd(e,s=Ad(--n),i),0!==(a=ud[s])&&wd(e,n-=Td[s],a))}while(o<e.last_lit);Pd(e,od,t)}function Ud(e,t){var i,n,r,s=t.dyn_tree,a=t.stat_desc.static_tree,o=t.stat_desc.has_stree,c=t.stat_desc.elems,l=-1;for(e.heap_len=0,e.heap_max=nd,i=0;i<c;i++)0!==s[2*i]?(e.heap[++e.heap_len]=l=i,e.depth[i]=0):s[2*i+1]=0;for(;e.heap_len<2;)s[2*(r=e.heap[++e.heap_len]=l<2?++l:0)]=1,e.depth[r]=0,e.opt_len--,o&&(e.static_len-=a[2*r+1]);for(t.max_code=l,i=e.heap_len>>1;i>=1;i--)Ld(e,s,i);r=c;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Ld(e,s,1),n=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=n,s[2*r]=s[2*i]+s[2*n],e.depth[r]=(e.depth[i]>=e.depth[n]?e.depth[i]:e.depth[n])+1,s[2*i+1]=s[2*n+1]=r,e.heap[1]=r++,Ld(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,n,r,s,a,o,c=t.dyn_tree,l=t.max_code,d=t.stat_desc.static_tree,h=t.stat_desc.has_stree,u=t.stat_desc.extra_bits,g=t.stat_desc.extra_base,p=t.stat_desc.max_length,m=0;for(s=0;s<=rd;s++)e.bl_count[s]=0;for(c[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<nd;i++)(s=c[2*c[2*(n=e.heap[i])+1]+1]+1)>p&&(s=p,m++),c[2*n+1]=s,n>l||(e.bl_count[s]++,a=0,n>=g&&(a=u[n-g]),o=c[2*n],e.opt_len+=o*(s+a),h&&(e.static_len+=o*(d[2*n+1]+a)));if(0!==m){do{for(s=p-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[p]--,m-=2}while(m>0);for(s=p;0!==s;s--)for(n=e.bl_count[s];0!==n;)(r=e.heap[--i])>l||(c[2*r+1]!==s&&(e.opt_len+=(s-c[2*r+1])*c[2*r],c[2*r+1]=s),n--)}}(e,t),Dd(s,l,e.bl_count)}function Fd(e,t,i){var n,r,s=-1,a=t[1],o=0,c=7,l=4;for(0===a&&(c=138,l=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)r=a,a=t[2*(n+1)+1],++o<c&&r===a||(o<l?e.bl_tree[2*r]+=o:0!==r?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[2*cd]++):o<=10?e.bl_tree[2*ld]++:e.bl_tree[2*dd]++,o=0,s=r,0===a?(c=138,l=3):r===a?(c=6,l=3):(c=7,l=4))}function Vd(e,t,i){var n,r,s=-1,a=t[1],o=0,c=7,l=4;for(0===a&&(c=138,l=3),n=0;n<=i;n++)if(r=a,a=t[2*(n+1)+1],!(++o<c&&r===a)){if(o<l)do{Pd(e,r,e.bl_tree)}while(0!=--o);else 0!==r?(r!==s&&(Pd(e,r,e.bl_tree),o--),Pd(e,cd,e.bl_tree),wd(e,o-3,2)):o<=10?(Pd(e,ld,e.bl_tree),wd(e,o-3,3)):(Pd(e,dd,e.bl_tree),wd(e,o-11,7));o=0,s=r,0===a?(c=138,l=3):r===a?(c=6,l=3):(c=7,l=4)}}Yl(Td);var Bd=!1;function Hd(e,t,i,n){wd(e,(Ql<<1)+(n?1:0),3),function(e,t,i,n){kd(e),n&&(Rd(e,i),Rd(e,~i)),zl.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}(e,t,i,!0)}var $d={_tr_init:function(e){Bd||(function(){var e,t,i,n,r,s=new Array(rd+1);for(i=0,n=0;n<Xl-1;n++)for(yd[n]=i,e=0;e<1<<hd[n];e++)vd[i++]=n;for(vd[i-1]=n,r=0,n=0;n<16;n++)for(Td[n]=r,e=0;e<1<<ud[n];e++)Sd[r++]=n;for(r>>=7;n<td;n++)for(Td[n]=r<<7,e=0;e<1<<ud[n]-7;e++)Sd[256+r++]=n;for(t=0;t<=rd;t++)s[t]=0;for(e=0;e<=143;)md[2*e+1]=8,e++,s[8]++;for(;e<=255;)md[2*e+1]=9,e++,s[9]++;for(;e<=279;)md[2*e+1]=7,e++,s[7]++;for(;e<=287;)md[2*e+1]=8,e++,s[8]++;for(Dd(md,ed+1,s),e=0;e<td;e++)fd[2*e+1]=5,fd[2*e]=Md(e,5);Cd=new Id(md,hd,Zl+1,ed,rd),_d=new Id(fd,ud,0,td,rd),Ed=new Id(new Array(0),gd,0,id,ad)}(),Bd=!0),e.l_desc=new bd(e.dyn_ltree,Cd),e.d_desc=new bd(e.dyn_dtree,_d),e.bl_desc=new bd(e.bl_tree,Ed),e.bi_buf=0,e.bi_valid=0,Od(e)},_tr_stored_block:Hd,_tr_flush_block:function(e,t,i,n){var r,s,a=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return Jl;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return Kl;for(t=32;t<Zl;t++)if(0!==e.dyn_ltree[2*t])return Kl;return Jl}(e)),Ud(e,e.l_desc),Ud(e,e.d_desc),a=function(e){var t;for(Fd(e,e.dyn_ltree,e.l_desc.max_code),Fd(e,e.dyn_dtree,e.d_desc.max_code),Ud(e,e.bl_desc),t=id-1;t>=3&&0===e.bl_tree[2*pd[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=r&&(r=s)):r=s=i+5,i+4<=r&&-1!==t?Hd(e,t,i,n):4===e.strategy||s===r?(wd(e,2+(n?1:0),3),xd(e,md,fd)):(wd(e,4+(n?1:0),3),function(e,t,i,n){var r;for(wd(e,t-257,5),wd(e,i-1,5),wd(e,n-4,4),r=0;r<n;r++)wd(e,e.bl_tree[2*pd[r]+1],3);Vd(e,e.dyn_ltree,t-1),Vd(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),xd(e,e.dyn_ltree,e.dyn_dtree)),Od(e),n&&kd(e)},_tr_tally:function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(vd[i]+Zl+1)]++,e.dyn_dtree[2*Ad(t)]++),e.last_lit===e.lit_bufsize-1},_tr_align:function(e){wd(e,2,3),Pd(e,od,md),function(e){16===e.bi_valid?(Rd(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}};var Gd=function(e,t,i,n){for(var r=65535&e,s=e>>>16&65535,a=0;0!==i;){i-=a=i>2e3?2e3:i;do{s=s+(r=r+t[n++]|0)|0}while(--a);r%=65521,s%=65521}return r|s<<16};var jd=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();var qd,Wd=function(e,t,i,n){var r=jd,s=n+i;e^=-1;for(var a=n;a<s;a++)e=e>>>8^r[255&(e^t[a])];return~e},zd={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Jd=0,Kd=4,Yd=0,Qd=-2,Xd=-1,Zd=4,eh=2,th=8,ih=9,nh=286,rh=30,sh=19,ah=2*nh+1,oh=15,ch=3,lh=258,dh=lh+ch+1,hh=42,uh=103,gh=113,ph=666,mh=1,fh=2,Sh=3,vh=4;function yh(e,t){return e.msg=zd[t],t}function Ch(e){return(e<<1)-(e>4?9:0)}function _h(e){for(var t=e.length;--t>=0;)e[t]=0}function Eh(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(zl.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function Th(e,t){$d._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Eh(e.strm)}function Ih(e,t){e.pending_buf[e.pending++]=t}function bh(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function Ah(e,t,i,n){var r=e.avail_in;return r>n&&(r=n),0===r?0:(e.avail_in-=r,zl.arraySet(t,e.input,e.next_in,r,i),1===e.state.wrap?e.adler=Gd(e.adler,t,r,i):2===e.state.wrap&&(e.adler=Wd(e.adler,t,r,i)),e.next_in+=r,e.total_in+=r,r)}function Rh(e,t){var i,n,r=e.max_chain_length,s=e.strstart,a=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-dh?e.strstart-(e.w_size-dh):0,l=e.window,d=e.w_mask,h=e.prev,u=e.strstart+lh,g=l[s+a-1],p=l[s+a];e.prev_length>=e.good_match&&(r>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(i=t)+a]===p&&l[i+a-1]===g&&l[i]===l[s]&&l[++i]===l[s+1]){s+=2,i++;do{}while(l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&s<u);if(n=lh-(u-s),s=u-lh,n>a){if(e.match_start=t,a=n,n>=o)break;g=l[s+a-1],p=l[s+a]}}}while((t=h[t&d])>c&&0!=--r);return a<=e.lookahead?a:e.lookahead}function wh(e){var t,i,n,r,s,a=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=a+(a-dh)){zl.arraySet(e.window,e.window,a,a,0),e.match_start-=a,e.strstart-=a,e.block_start-=a,t=i=e.hash_size;do{n=e.head[--t],e.head[t]=n>=a?n-a:0}while(--i);t=i=a;do{n=e.prev[--t],e.prev[t]=n>=a?n-a:0}while(--i);r+=a}if(0===e.strm.avail_in)break;if(i=Ah(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=i,e.lookahead+e.insert>=ch)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+ch-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<ch)););}while(e.lookahead<dh&&0!==e.strm.avail_in)}function Ph(e,t){for(var i,n;;){if(e.lookahead<dh){if(wh(e),e.lookahead<dh&&t===Jd)return mh;if(0===e.lookahead)break}if(i=0,e.lookahead>=ch&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+ch-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-dh&&(e.match_length=Rh(e,i)),e.match_length>=ch)if(n=$d._tr_tally(e,e.strstart-e.match_start,e.match_length-ch),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=ch){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+ch-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=$d._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(Th(e,!1),0===e.strm.avail_out))return mh}return e.insert=e.strstart<ch-1?e.strstart:ch-1,t===Kd?(Th(e,!0),0===e.strm.avail_out?Sh:vh):e.last_lit&&(Th(e,!1),0===e.strm.avail_out)?mh:fh}function Mh(e,t){for(var i,n,r;;){if(e.lookahead<dh){if(wh(e),e.lookahead<dh&&t===Jd)return mh;if(0===e.lookahead)break}if(i=0,e.lookahead>=ch&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+ch-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=ch-1,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-dh&&(e.match_length=Rh(e,i),e.match_length<=5&&(1===e.strategy||e.match_length===ch&&e.strstart-e.match_start>4096)&&(e.match_length=ch-1)),e.prev_length>=ch&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-ch,n=$d._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-ch),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+ch-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=ch-1,e.strstart++,n&&(Th(e,!1),0===e.strm.avail_out))return mh}else if(e.match_available){if((n=$d._tr_tally(e,0,e.window[e.strstart-1]))&&Th(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return mh}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=$d._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<ch-1?e.strstart:ch-1,t===Kd?(Th(e,!0),0===e.strm.avail_out?Sh:vh):e.last_lit&&(Th(e,!1),0===e.strm.avail_out)?mh:fh}function Dh(e,t,i,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=r}function Oh(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=th,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new zl.Buf16(2*ah),this.dyn_dtree=new zl.Buf16(2*(2*rh+1)),this.bl_tree=new zl.Buf16(2*(2*sh+1)),_h(this.dyn_ltree),_h(this.dyn_dtree),_h(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new zl.Buf16(oh+1),this.heap=new zl.Buf16(2*nh+1),_h(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new zl.Buf16(2*nh+1),_h(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function kh(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=eh,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?hh:gh,e.adler=2===t.wrap?0:1,t.last_flush=Jd,$d._tr_init(t),Yd):yh(e,Qd)}function Nh(e){var t=kh(e);return t===Yd&&function(e){e.window_size=2*e.w_size,_h(e.head),e.max_lazy_match=qd[e.level].max_lazy,e.good_match=qd[e.level].good_length,e.nice_match=qd[e.level].nice_length,e.max_chain_length=qd[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=ch-1,e.match_available=0,e.ins_h=0}(e.state),t}function Lh(e,t,i,n,r,s){if(!e)return Qd;var a=1;if(t===Xd&&(t=6),n<0?(a=0,n=-n):n>15&&(a=2,n-=16),r<1||r>ih||i!==th||n<8||n>15||t<0||t>9||s<0||s>Zd)return yh(e,Qd);8===n&&(n=9);var o=new Oh;return e.state=o,o.strm=e,o.wrap=a,o.gzhead=null,o.w_bits=n,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=r+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+ch-1)/ch),o.window=new zl.Buf8(2*o.w_size),o.head=new zl.Buf16(o.hash_size),o.prev=new zl.Buf16(o.w_size),o.lit_bufsize=1<<r+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new zl.Buf8(o.pending_buf_size),o.d_buf=o.lit_bufsize>>1,o.l_buf=3*o.lit_bufsize,o.level=t,o.strategy=s,o.method=i,Nh(e)}qd=[new Dh(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(wh(e),0===e.lookahead&&t===Jd)return mh;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+i;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,Th(e,!1),0===e.strm.avail_out))return mh;if(e.strstart-e.block_start>=e.w_size-dh&&(Th(e,!1),0===e.strm.avail_out))return mh}return e.insert=0,t===Kd?(Th(e,!0),0===e.strm.avail_out?Sh:vh):(e.strstart>e.block_start&&(Th(e,!1),e.strm.avail_out),mh)})),new Dh(4,4,8,4,Ph),new Dh(4,5,16,8,Ph),new Dh(4,6,32,32,Ph),new Dh(4,4,16,16,Mh),new Dh(8,16,32,32,Mh),new Dh(8,16,128,128,Mh),new Dh(8,32,128,256,Mh),new Dh(32,128,258,1024,Mh),new Dh(32,258,258,4096,Mh)];var xh={deflateInit:function(e,t){return Lh(e,t,th,15,8,0)},deflateInit2:Lh,deflateReset:Nh,deflateResetKeep:kh,deflateSetHeader:function(e,t){return e&&e.state?2!==e.state.wrap?Qd:(e.state.gzhead=t,Yd):Qd},deflate:function(e,t){var i,n,r,s;if(!e||!e.state||t>5||t<0)return e?yh(e,Qd):Qd;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||n.status===ph&&t!==Kd)return yh(e,0===e.avail_out?-5:Qd);if(n.strm=e,i=n.last_flush,n.last_flush=t,n.status===hh)if(2===n.wrap)e.adler=0,Ih(n,31),Ih(n,139),Ih(n,8),n.gzhead?(Ih(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Ih(n,255&n.gzhead.time),Ih(n,n.gzhead.time>>8&255),Ih(n,n.gzhead.time>>16&255),Ih(n,n.gzhead.time>>24&255),Ih(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),Ih(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Ih(n,255&n.gzhead.extra.length),Ih(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=Wd(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(Ih(n,0),Ih(n,0),Ih(n,0),Ih(n,0),Ih(n,0),Ih(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),Ih(n,3),n.status=gh);else{var a=th+(n.w_bits-8<<4)<<8;a|=(n.strategy>=2||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(a|=32),a+=31-a%31,n.status=gh,bh(n,a),0!==n.strstart&&(bh(n,e.adler>>>16),bh(n,65535&e.adler)),e.adler=1}if(69===n.status)if(n.gzhead.extra){for(r=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),Eh(e),r=n.pending,n.pending!==n.pending_buf_size));)Ih(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){r=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),Eh(e),r=n.pending,n.pending===n.pending_buf_size)){s=1;break}s=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Ih(n,s)}while(0!==s);n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),0===s&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){r=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),Eh(e),r=n.pending,n.pending===n.pending_buf_size)){s=1;break}s=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Ih(n,s)}while(0!==s);n.gzhead.hcrc&&n.pending>r&&(e.adler=Wd(e.adler,n.pending_buf,n.pending-r,r)),0===s&&(n.status=uh)}else n.status=uh;if(n.status===uh&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&Eh(e),n.pending+2<=n.pending_buf_size&&(Ih(n,255&e.adler),Ih(n,e.adler>>8&255),e.adler=0,n.status=gh)):n.status=gh),0!==n.pending){if(Eh(e),0===e.avail_out)return n.last_flush=-1,Yd}else if(0===e.avail_in&&Ch(t)<=Ch(i)&&t!==Kd)return yh(e,-5);if(n.status===ph&&0!==e.avail_in)return yh(e,-5);if(0!==e.avail_in||0!==n.lookahead||t!==Jd&&n.status!==ph){var o=2===n.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(wh(e),0===e.lookahead)){if(t===Jd)return mh;break}if(e.match_length=0,i=$d._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(Th(e,!1),0===e.strm.avail_out))return mh}return e.insert=0,t===Kd?(Th(e,!0),0===e.strm.avail_out?Sh:vh):e.last_lit&&(Th(e,!1),0===e.strm.avail_out)?mh:fh}(n,t):3===n.strategy?function(e,t){for(var i,n,r,s,a=e.window;;){if(e.lookahead<=lh){if(wh(e),e.lookahead<=lh&&t===Jd)return mh;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=ch&&e.strstart>0&&(n=a[r=e.strstart-1])===a[++r]&&n===a[++r]&&n===a[++r]){s=e.strstart+lh;do{}while(n===a[++r]&&n===a[++r]&&n===a[++r]&&n===a[++r]&&n===a[++r]&&n===a[++r]&&n===a[++r]&&n===a[++r]&&r<s);e.match_length=lh-(s-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=ch?(i=$d._tr_tally(e,1,e.match_length-ch),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=$d._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(Th(e,!1),0===e.strm.avail_out))return mh}return e.insert=0,t===Kd?(Th(e,!0),0===e.strm.avail_out?Sh:vh):e.last_lit&&(Th(e,!1),0===e.strm.avail_out)?mh:fh}(n,t):qd[n.level].func(n,t);if(o!==Sh&&o!==vh||(n.status=ph),o===mh||o===Sh)return 0===e.avail_out&&(n.last_flush=-1),Yd;if(o===fh&&(1===t?$d._tr_align(n):5!==t&&($d._tr_stored_block(n,0,0,!1),3===t&&(_h(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),Eh(e),0===e.avail_out))return n.last_flush=-1,Yd}return t!==Kd?Yd:n.wrap<=0?1:(2===n.wrap?(Ih(n,255&e.adler),Ih(n,e.adler>>8&255),Ih(n,e.adler>>16&255),Ih(n,e.adler>>24&255),Ih(n,255&e.total_in),Ih(n,e.total_in>>8&255),Ih(n,e.total_in>>16&255),Ih(n,e.total_in>>24&255)):(bh(n,e.adler>>>16),bh(n,65535&e.adler)),Eh(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?Yd:1)},deflateEnd:function(e){var t;return e&&e.state?(t=e.state.status)!==hh&&69!==t&&73!==t&&91!==t&&t!==uh&&t!==gh&&t!==ph?yh(e,Qd):(e.state=null,t===gh?yh(e,-3):Yd):Qd},deflateSetDictionary:function(e,t){var i,n,r,s,a,o,c,l,d=t.length;if(!e||!e.state)return Qd;if(2===(s=(i=e.state).wrap)||1===s&&i.status!==hh||i.lookahead)return Qd;for(1===s&&(e.adler=Gd(e.adler,t,d,0)),i.wrap=0,d>=i.w_size&&(0===s&&(_h(i.head),i.strstart=0,i.block_start=0,i.insert=0),l=new zl.Buf8(i.w_size),zl.arraySet(l,t,d-i.w_size,i.w_size,0),t=l,d=i.w_size),a=e.avail_in,o=e.next_in,c=e.input,e.avail_in=d,e.next_in=0,e.input=t,wh(i);i.lookahead>=ch;){n=i.strstart,r=i.lookahead-(ch-1);do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[n+ch-1])&i.hash_mask,i.prev[n&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=n,n++}while(--r);i.strstart=n,i.lookahead=ch-1,wh(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=ch-1,i.match_available=0,e.next_in=o,e.input=c,e.avail_in=a,i.wrap=s,Yd},deflateInfo:"pako deflate (from Nodeca project)"},Uh=!0,Fh=!0;try{String.fromCharCode.apply(null,[0])}catch(e){Uh=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){Fh=!1}for(var Vh=new zl.Buf8(256),Bh=0;Bh<256;Bh++)Vh[Bh]=Bh>=252?6:Bh>=248?5:Bh>=240?4:Bh>=224?3:Bh>=192?2:1;Vh[254]=Vh[254]=1;function Hh(e,t){if(t<65537&&(e.subarray&&Fh||!e.subarray&&Uh))return String.fromCharCode.apply(null,zl.shrinkBuf(e,t));for(var i="",n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i}var $h={string2buf:function(e){var t,i,n,r,s,a=e.length,o=0;for(r=0;r<a;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),o+=i<128?1:i<2048?2:i<65536?3:4;for(t=new zl.Buf8(o),s=0,r=0;s<o;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t},buf2binstring:function(e){return Hh(e,e.length)},binstring2buf:function(e){for(var t=new zl.Buf8(e.length),i=0,n=t.length;i<n;i++)t[i]=e.charCodeAt(i);return t},buf2string:function(e,t){var i,n,r,s,a=t||e.length,o=new Array(2*a);for(n=0,i=0;i<a;)if((r=e[i++])<128)o[n++]=r;else if((s=Vh[r])>4)o[n++]=65533,i+=s-1;else{for(r&=2===s?31:3===s?15:7;s>1&&i<a;)r=r<<6|63&e[i++],s--;s>1?o[n++]=65533:r<65536?o[n++]=r:(r-=65536,o[n++]=55296|r>>10&1023,o[n++]=56320|1023&r)}return Hh(o,n)},utf8border:function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Vh[e[i]]>t?i:t}};var Gh=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},jh=Object.prototype.toString,qh=0,Wh=-1,zh=0,Jh=8;function Kh(e){if(!(this instanceof Kh))return new Kh(e);this.options=zl.assign({level:Wh,method:Jh,chunkSize:16384,windowBits:15,memLevel:8,strategy:zh,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gh,this.strm.avail_out=0;var i=xh.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==qh)throw new Error(zd[i]);if(t.header&&xh.deflateSetHeader(this.strm,t.header),t.dictionary){var n;if(n="string"==typeof t.dictionary?$h.string2buf(t.dictionary):"[object ArrayBuffer]"===jh.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(i=xh.deflateSetDictionary(this.strm,n))!==qh)throw new Error(zd[i]);this._dict_set=!0}}function Yh(e,t){var i=new Kh(t);if(i.push(e,!0),i.err)throw i.msg;return i.result}Kh.prototype.push=function(e,t){var i,n,r=this.strm,s=this.options.chunkSize;if(this.ended)return!1;n=t===~~t?t:!0===t?4:0,"string"==typeof e?r.input=$h.string2buf(e):"[object ArrayBuffer]"===jh.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new zl.Buf8(s),r.next_out=0,r.avail_out=s),1!==(i=xh.deflate(r,n))&&i!==qh)return this.onEnd(i),this.ended=!0,!1;0!==r.avail_out&&(0!==r.avail_in||4!==n&&2!==n)||("string"===this.options.to?this.onData($h.buf2binstring(zl.shrinkBuf(r.output,r.next_out))):this.onData(zl.shrinkBuf(r.output,r.next_out)))}while((r.avail_in>0||0===r.avail_out)&&1!==i);return 4===n?(i=xh.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===qh):2!==n||(this.onEnd(qh),r.avail_out=0,!0)},Kh.prototype.onData=function(e){this.chunks.push(e)},Kh.prototype.onEnd=function(e){e===qh&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=zl.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Qh={Deflate:Kh,deflate:Yh,deflateRaw:function(e,t){return(t=t||{}).raw=!0,Yh(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,Yh(e,t)}},Xh=function(e,t){var i,n,r,s,a,o,c,l,d,h,u,g,p,m,f,S,v,y,C,_,E,T,I,b,A;i=e.state,n=e.next_in,b=e.input,r=n+(e.avail_in-5),s=e.next_out,A=e.output,a=s-(t-e.avail_out),o=s+(e.avail_out-257),c=i.dmax,l=i.wsize,d=i.whave,h=i.wnext,u=i.window,g=i.hold,p=i.bits,m=i.lencode,f=i.distcode,S=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{p<15&&(g+=b[n++]<<p,p+=8,g+=b[n++]<<p,p+=8),y=m[g&S];t:for(;;){if(g>>>=C=y>>>24,p-=C,0==(C=y>>>16&255))A[s++]=65535&y;else{if(!(16&C)){if(!(64&C)){y=m[(65535&y)+(g&(1<<C)-1)];continue t}if(32&C){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}_=65535&y,(C&=15)&&(p<C&&(g+=b[n++]<<p,p+=8),_+=g&(1<<C)-1,g>>>=C,p-=C),p<15&&(g+=b[n++]<<p,p+=8,g+=b[n++]<<p,p+=8),y=f[g&v];i:for(;;){if(g>>>=C=y>>>24,p-=C,!(16&(C=y>>>16&255))){if(!(64&C)){y=f[(65535&y)+(g&(1<<C)-1)];continue i}e.msg="invalid distance code",i.mode=30;break e}if(E=65535&y,p<(C&=15)&&(g+=b[n++]<<p,(p+=8)<C&&(g+=b[n++]<<p,p+=8)),(E+=g&(1<<C)-1)>c){e.msg="invalid distance too far back",i.mode=30;break e}if(g>>>=C,p-=C,E>(C=s-a)){if((C=E-C)>d&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(T=0,I=u,0===h){if(T+=l-C,C<_){_-=C;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}}else if(h<C){if(T+=l+h-C,(C-=h)<_){_-=C;do{A[s++]=u[T++]}while(--C);if(T=0,h<_){_-=C=h;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}}}else if(T+=h-C,C<_){_-=C;do{A[s++]=u[T++]}while(--C);T=s-E,I=A}for(;_>2;)A[s++]=I[T++],A[s++]=I[T++],A[s++]=I[T++],_-=3;_&&(A[s++]=I[T++],_>1&&(A[s++]=I[T++]))}else{T=s-E;do{A[s++]=A[T++],A[s++]=A[T++],A[s++]=A[T++],_-=3}while(_>2);_&&(A[s++]=A[T++],_>1&&(A[s++]=A[T++]))}break}}break}}while(n<r&&s<o);n-=_=p>>3,g&=(1<<(p-=_<<3))-1,e.next_in=n,e.next_out=s,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=s<o?o-s+257:257-(s-o),i.hold=g,i.bits=p},Zh=15,eu=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],tu=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],iu=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],nu=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],ru=function(e,t,i,n,r,s,a,o){var c,l,d,h,u,g,p,m,f,S=o.bits,v=0,y=0,C=0,_=0,E=0,T=0,I=0,b=0,A=0,R=0,w=null,P=0,M=new zl.Buf16(16),D=new zl.Buf16(16),O=null,k=0;for(v=0;v<=Zh;v++)M[v]=0;for(y=0;y<n;y++)M[t[i+y]]++;for(E=S,_=Zh;_>=1&&0===M[_];_--);if(E>_&&(E=_),0===_)return r[s++]=20971520,r[s++]=20971520,o.bits=1,0;for(C=1;C<_&&0===M[C];C++);for(E<C&&(E=C),b=1,v=1;v<=Zh;v++)if(b<<=1,(b-=M[v])<0)return-1;if(b>0&&(0===e||1!==_))return-1;for(D[1]=0,v=1;v<Zh;v++)D[v+1]=D[v]+M[v];for(y=0;y<n;y++)0!==t[i+y]&&(a[D[t[i+y]]++]=y);if(0===e?(w=O=a,g=19):1===e?(w=eu,P-=257,O=tu,k-=257,g=256):(w=iu,O=nu,g=-1),R=0,y=0,v=C,u=s,T=E,I=0,d=-1,h=(A=1<<E)-1,1===e&&A>852||2===e&&A>592)return 1;for(;;){p=v-I,a[y]<g?(m=0,f=a[y]):a[y]>g?(m=O[k+a[y]],f=w[P+a[y]]):(m=96,f=0),c=1<<v-I,C=l=1<<T;do{r[u+(R>>I)+(l-=c)]=p<<24|m<<16|f}while(0!==l);for(c=1<<v-1;R&c;)c>>=1;if(0!==c?(R&=c-1,R+=c):R=0,y++,0==--M[v]){if(v===_)break;v=t[i+a[y]]}if(v>E&&(R&h)!==d){for(0===I&&(I=E),u+=C,b=1<<(T=v-I);T+I<_&&!((b-=M[T+I])<=0);)T++,b<<=1;if(A+=1<<T,1===e&&A>852||2===e&&A>592)return 1;r[d=R&h]=E<<24|T<<16|u-s}}return 0!==R&&(r[u+R]=v-I<<24|64<<16),o.bits=E,0},su=1,au=2,ou=0,cu=-2,lu=1,du=12,hu=30,uu=852,gu=592;function pu(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function mu(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new zl.Buf16(320),this.work=new zl.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function fu(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=lu,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new zl.Buf32(uu),t.distcode=t.distdyn=new zl.Buf32(gu),t.sane=1,t.back=-1,ou):cu}function Su(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,fu(e)):cu}function vu(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?cu:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,Su(e))):cu}function yu(e,t){var i,n;return e?(n=new mu,e.state=n,n.window=null,(i=vu(e,t))!==ou&&(e.state=null),i):cu}var Cu,_u,Eu=!0;function Tu(e){if(Eu){var t;for(Cu=new zl.Buf32(512),_u=new zl.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(ru(su,e.lens,0,288,Cu,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;ru(au,e.lens,0,32,_u,0,e.work,{bits:5}),Eu=!1}e.lencode=Cu,e.lenbits=9,e.distcode=_u,e.distbits=5}function Iu(e,t,i,n){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new zl.Buf8(s.wsize)),n>=s.wsize?(zl.arraySet(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((r=s.wsize-s.wnext)>n&&(r=n),zl.arraySet(s.window,t,i-n,r,s.wnext),(n-=r)?(zl.arraySet(s.window,t,i-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}var bu={inflateReset:Su,inflateReset2:vu,inflateResetKeep:fu,inflateInit:function(e){return yu(e,15)},inflateInit2:yu,inflate:function(e,t){var i,n,r,s,a,o,c,l,d,h,u,g,p,m,f,S,v,y,C,_,E,T,I,b,A=0,R=new zl.Buf8(4),w=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return cu;(i=e.state).mode===du&&(i.mode=13),a=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,n=e.input,o=e.avail_in,l=i.hold,d=i.bits,h=o,u=c,T=ou;e:for(;;)switch(i.mode){case lu:if(0===i.wrap){i.mode=13;break}for(;d<16;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(2&i.wrap&&35615===l){i.check=0,R[0]=255&l,R[1]=l>>>8&255,i.check=Wd(i.check,R,2,0),l=0,d=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",i.mode=hu;break}if(8!=(15&l)){e.msg="unknown compression method",i.mode=hu;break}if(d-=4,E=8+(15&(l>>>=4)),0===i.wbits)i.wbits=E;else if(E>i.wbits){e.msg="invalid window size",i.mode=hu;break}i.dmax=1<<E,e.adler=i.check=1,i.mode=512&l?10:du,l=0,d=0;break;case 2:for(;d<16;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(i.flags=l,8!=(255&i.flags)){e.msg="unknown compression method",i.mode=hu;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=hu;break}i.head&&(i.head.text=l>>8&1),512&i.flags&&(R[0]=255&l,R[1]=l>>>8&255,i.check=Wd(i.check,R,2,0)),l=0,d=0,i.mode=3;case 3:for(;d<32;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.head&&(i.head.time=l),512&i.flags&&(R[0]=255&l,R[1]=l>>>8&255,R[2]=l>>>16&255,R[3]=l>>>24&255,i.check=Wd(i.check,R,4,0)),l=0,d=0,i.mode=4;case 4:for(;d<16;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.head&&(i.head.xflags=255&l,i.head.os=l>>8),512&i.flags&&(R[0]=255&l,R[1]=l>>>8&255,i.check=Wd(i.check,R,2,0)),l=0,d=0,i.mode=5;case 5:if(1024&i.flags){for(;d<16;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.length=l,i.head&&(i.head.extra_len=l),512&i.flags&&(R[0]=255&l,R[1]=l>>>8&255,i.check=Wd(i.check,R,2,0)),l=0,d=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((g=i.length)>o&&(g=o),g&&(i.head&&(E=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),zl.arraySet(i.head.extra,n,s,g,E)),512&i.flags&&(i.check=Wd(i.check,n,g,s)),o-=g,s+=g,i.length-=g),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===o)break e;g=0;do{E=n[s+g++],i.head&&E&&i.length<65536&&(i.head.name+=String.fromCharCode(E))}while(E&&g<o);if(512&i.flags&&(i.check=Wd(i.check,n,g,s)),o-=g,s+=g,E)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===o)break e;g=0;do{E=n[s+g++],i.head&&E&&i.length<65536&&(i.head.comment+=String.fromCharCode(E))}while(E&&g<o);if(512&i.flags&&(i.check=Wd(i.check,n,g,s)),o-=g,s+=g,E)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;d<16;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(l!==(65535&i.check)){e.msg="header crc mismatch",i.mode=hu;break}l=0,d=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=du;break;case 10:for(;d<32;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}e.adler=i.check=pu(l),l=0,d=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=o,i.hold=l,i.bits=d,2;e.adler=i.check=1,i.mode=du;case du:if(5===t||6===t)break e;case 13:if(i.last){l>>>=7&d,d-=7&d,i.mode=27;break}for(;d<3;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}switch(i.last=1&l,d-=1,3&(l>>>=1)){case 0:i.mode=14;break;case 1:if(Tu(i),i.mode=20,6===t){l>>>=2,d-=2;break e}break;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=hu}l>>>=2,d-=2;break;case 14:for(l>>>=7&d,d-=7&d;d<32;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",i.mode=hu;break}if(i.length=65535&l,l=0,d=0,i.mode=15,6===t)break e;case 15:i.mode=16;case 16:if(g=i.length){if(g>o&&(g=o),g>c&&(g=c),0===g)break e;zl.arraySet(r,n,s,g,a),o-=g,s+=g,c-=g,a+=g,i.length-=g;break}i.mode=du;break;case 17:for(;d<14;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(i.nlen=257+(31&l),l>>>=5,d-=5,i.ndist=1+(31&l),l>>>=5,d-=5,i.ncode=4+(15&l),l>>>=4,d-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=hu;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;d<3;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.lens[w[i.have++]]=7&l,l>>>=3,d-=3}for(;i.have<19;)i.lens[w[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,I={bits:i.lenbits},T=ru(0,i.lens,0,19,i.lencode,0,i.work,I),i.lenbits=I.bits,T){e.msg="invalid code lengths set",i.mode=hu;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;S=(A=i.lencode[l&(1<<i.lenbits)-1])>>>16&255,v=65535&A,!((f=A>>>24)<=d);){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(v<16)l>>>=f,d-=f,i.lens[i.have++]=v;else{if(16===v){for(b=f+2;d<b;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(l>>>=f,d-=f,0===i.have){e.msg="invalid bit length repeat",i.mode=hu;break}E=i.lens[i.have-1],g=3+(3&l),l>>>=2,d-=2}else if(17===v){for(b=f+3;d<b;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}d-=f,E=0,g=3+(7&(l>>>=f)),l>>>=3,d-=3}else{for(b=f+7;d<b;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}d-=f,E=0,g=11+(127&(l>>>=f)),l>>>=7,d-=7}if(i.have+g>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=hu;break}for(;g--;)i.lens[i.have++]=E}}if(i.mode===hu)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=hu;break}if(i.lenbits=9,I={bits:i.lenbits},T=ru(su,i.lens,0,i.nlen,i.lencode,0,i.work,I),i.lenbits=I.bits,T){e.msg="invalid literal/lengths set",i.mode=hu;break}if(i.distbits=6,i.distcode=i.distdyn,I={bits:i.distbits},T=ru(au,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,I),i.distbits=I.bits,T){e.msg="invalid distances set",i.mode=hu;break}if(i.mode=20,6===t)break e;case 20:i.mode=21;case 21:if(o>=6&&c>=258){e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=o,i.hold=l,i.bits=d,Xh(e,u),a=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,n=e.input,o=e.avail_in,l=i.hold,d=i.bits,i.mode===du&&(i.back=-1);break}for(i.back=0;S=(A=i.lencode[l&(1<<i.lenbits)-1])>>>16&255,v=65535&A,!((f=A>>>24)<=d);){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(S&&!(240&S)){for(y=f,C=S,_=v;S=(A=i.lencode[_+((l&(1<<y+C)-1)>>y)])>>>16&255,v=65535&A,!(y+(f=A>>>24)<=d);){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}l>>>=y,d-=y,i.back+=y}if(l>>>=f,d-=f,i.back+=f,i.length=v,0===S){i.mode=26;break}if(32&S){i.back=-1,i.mode=du;break}if(64&S){e.msg="invalid literal/length code",i.mode=hu;break}i.extra=15&S,i.mode=22;case 22:if(i.extra){for(b=i.extra;d<b;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.length+=l&(1<<i.extra)-1,l>>>=i.extra,d-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;S=(A=i.distcode[l&(1<<i.distbits)-1])>>>16&255,v=65535&A,!((f=A>>>24)<=d);){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(!(240&S)){for(y=f,C=S,_=v;S=(A=i.distcode[_+((l&(1<<y+C)-1)>>y)])>>>16&255,v=65535&A,!(y+(f=A>>>24)<=d);){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}l>>>=y,d-=y,i.back+=y}if(l>>>=f,d-=f,i.back+=f,64&S){e.msg="invalid distance code",i.mode=hu;break}i.offset=v,i.extra=15&S,i.mode=24;case 24:if(i.extra){for(b=i.extra;d<b;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}i.offset+=l&(1<<i.extra)-1,l>>>=i.extra,d-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=hu;break}i.mode=25;case 25:if(0===c)break e;if(g=u-c,i.offset>g){if((g=i.offset-g)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=hu;break}g>i.wnext?(g-=i.wnext,p=i.wsize-g):p=i.wnext-g,g>i.length&&(g=i.length),m=i.window}else m=r,p=a-i.offset,g=i.length;g>c&&(g=c),c-=g,i.length-=g;do{r[a++]=m[p++]}while(--g);0===i.length&&(i.mode=21);break;case 26:if(0===c)break e;r[a++]=i.length,c--,i.mode=21;break;case 27:if(i.wrap){for(;d<32;){if(0===o)break e;o--,l|=n[s++]<<d,d+=8}if(u-=c,e.total_out+=u,i.total+=u,u&&(e.adler=i.check=i.flags?Wd(i.check,r,u,a-u):Gd(i.check,r,u,a-u)),u=c,(i.flags?l:pu(l))!==i.check){e.msg="incorrect data check",i.mode=hu;break}l=0,d=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;d<32;){if(0===o)break e;o--,l+=n[s++]<<d,d+=8}if(l!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=hu;break}l=0,d=0}i.mode=29;case 29:T=1;break e;case hu:T=-3;break e;case 31:return-4;default:return cu}return e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=o,i.hold=l,i.bits=d,(i.wsize||u!==e.avail_out&&i.mode<hu&&(i.mode<27||4!==t))&&Iu(e,e.output,e.next_out,u-e.avail_out),h-=e.avail_in,u-=e.avail_out,e.total_in+=h,e.total_out+=u,i.total+=u,i.wrap&&u&&(e.adler=i.check=i.flags?Wd(i.check,r,u,e.next_out-u):Gd(i.check,r,u,e.next_out-u)),e.data_type=i.bits+(i.last?64:0)+(i.mode===du?128:0)+(20===i.mode||15===i.mode?256:0),(0===h&&0===u||4===t)&&T===ou&&(T=-5),T},inflateEnd:function(e){if(!e||!e.state)return cu;var t=e.state;return t.window&&(t.window=null),e.state=null,ou},inflateGetHeader:function(e,t){var i;return e&&e.state&&2&(i=e.state).wrap?(i.head=t,t.done=!1,ou):cu},inflateSetDictionary:function(e,t){var i,n=t.length;return e&&e.state?0!==(i=e.state).wrap&&11!==i.mode?cu:11===i.mode&&Gd(1,t,n,0)!==i.check?-3:Iu(e,t,n,n)?(i.mode=31,-4):(i.havedict=1,ou):cu},inflateInfo:"pako inflate (from Nodeca project)"},Au={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};var Ru=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},wu=Object.prototype.toString;function Pu(e){if(!(this instanceof Pu))return new Pu(e);this.options=zl.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gh,this.strm.avail_out=0;var i=bu.inflateInit2(this.strm,t.windowBits);if(i!==Au.Z_OK)throw new Error(zd[i]);this.header=new Ru,bu.inflateGetHeader(this.strm,this.header)}function Mu(e,t){var i=new Pu(t);if(i.push(e,!0),i.err)throw i.msg;return i.result}Pu.prototype.push=function(e,t){var i,n,r,s,a,o,c=this.strm,l=this.options.chunkSize,d=this.options.dictionary,h=!1;if(this.ended)return!1;n=t===~~t?t:!0===t?Au.Z_FINISH:Au.Z_NO_FLUSH,"string"==typeof e?c.input=$h.binstring2buf(e):"[object ArrayBuffer]"===wu.call(e)?c.input=new Uint8Array(e):c.input=e,c.next_in=0,c.avail_in=c.input.length;do{if(0===c.avail_out&&(c.output=new zl.Buf8(l),c.next_out=0,c.avail_out=l),(i=bu.inflate(c,Au.Z_NO_FLUSH))===Au.Z_NEED_DICT&&d&&(o="string"==typeof d?$h.string2buf(d):"[object ArrayBuffer]"===wu.call(d)?new Uint8Array(d):d,i=bu.inflateSetDictionary(this.strm,o)),i===Au.Z_BUF_ERROR&&!0===h&&(i=Au.Z_OK,h=!1),i!==Au.Z_STREAM_END&&i!==Au.Z_OK)return this.onEnd(i),this.ended=!0,!1;c.next_out&&(0!==c.avail_out&&i!==Au.Z_STREAM_END&&(0!==c.avail_in||n!==Au.Z_FINISH&&n!==Au.Z_SYNC_FLUSH)||("string"===this.options.to?(r=$h.utf8border(c.output,c.next_out),s=c.next_out-r,a=$h.buf2string(c.output,r),c.next_out=s,c.avail_out=l-s,s&&zl.arraySet(c.output,c.output,r,s,0),this.onData(a)):this.onData(zl.shrinkBuf(c.output,c.next_out)))),0===c.avail_in&&0===c.avail_out&&(h=!0)}while((c.avail_in>0||0===c.avail_out)&&i!==Au.Z_STREAM_END);return i===Au.Z_STREAM_END&&(n=Au.Z_FINISH),n===Au.Z_FINISH?(i=bu.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===Au.Z_OK):n!==Au.Z_SYNC_FLUSH||(this.onEnd(Au.Z_OK),c.avail_out=0,!0)},Pu.prototype.onData=function(e){this.chunks.push(e)},Pu.prototype.onEnd=function(e){e===Au.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=zl.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Du={Inflate:Pu,inflate:Mu,inflateRaw:function(e,t){return(t=t||{}).raw=!0,Mu(e,t)},ungzip:Mu},Ou={};(0,zl.assign)(Ou,Qh,Du,Au);var ku=Ou;function Nu(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)}}}function Lu(e){return new Promise((t=>xu(t,e)))}function xu(e,t){return globalThis.setTimeout(e,t)}function Uu(e){globalThis.clearTimeout(e)}function Fu(e,t){const i=Nu();let n;try{n=e()}catch(e){return Promise.reject(i.reject(e))}if(t<0)return n.finally((()=>{i.resolve(n)})),i.promise;const r=xu((()=>{i.isPending()&&i.reject(new I({defaultError:f.INTERNAL.OPERATION_TIMEDOUT}))}),t);return n.catch((e=>{Uu(r),i.isPending()&&i.reject(e)})).finally((()=>{Uu(r),i.isPending()&&i.resolve(n)})),i.promise}var Vu=function(e,t){var i=e.toString(),n=t.toString();return i>n?1:i<n?-1:0};function Bu(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Hu(e,t,i){return t&&Bu(e.prototype,t),i&&Bu(e,i),e}var $u=function(){function e(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).comparator,i=void 0===t?Vu:t;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(this,"comparator",void 0),this.comparator=i}return Hu(e,null,[{key:"from",value:function(e,t){throw new Error("not implemented")}}]),Hu(e,[{key:"clear",value:function(){throw new Error("not implemented")}},{key:"toArray",value:function(){throw new Error("not implemented")}},{key:"push",value:function(e){throw new Error("not implemented")}},{key:"enqueue",value:function(e){return this.push(e)}},{key:"top",value:function(){throw new Error("not implemented")}},{key:"peek",value:function(){return this.top()}},{key:"pop",value:function(){throw new Error("not implemented")}},{key:"dequeue",value:function(){return this.pop()}},{key:"merge",value:function(e){throw new Error("not implemented")}},{key:"isEmpty",value:function(){throw new Error("not implemented")}},{key:"length",get:function(){throw new Error("not implemented")}}]),e}();function Gu(e){return Gu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Gu(e)}function ju(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function qu(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Wu(e){return Wu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Wu(e)}function zu(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ju(e,t){return Ju=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Ju(e,t)}function Ku(e,t,i){var n=function(e,t,i){var n=2*t,r=2*t+1,s=t;return n<e.length&&i(e[s],e[n])<0&&(s=n),r<e.length&&i(e[s],e[r])<0&&(s=r),s}(e,t,i);if(n!==t){var r=e[t];e[t]=e[n],e[n]=r,Ku(e,n,i)}}function Yu(e){for(var t=Math.floor(e.collection.length/2)-1;t>=0;--t)Ku(e.collection,t,e.comparator)}var Qu,Xu,Zu,eg,tg,ig,ng,rg=function(e){function t(){var e,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];return function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(zu(i=function(e,t){return!t||"object"!==Gu(t)&&"function"!=typeof t?zu(e):t}(this,(e=Wu(t)).call.apply(e,[this].concat(r)))),"collection",[]),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ju(e,t)}(t,e),function(e,t,i){t&&qu(e.prototype,t),i&&qu(e,i)}(t,[{key:"clear",value:function(){this.collection.length=0}},{key:"toArray",value:function(){return ju(this.collection).sort(this.comparator)}},{key:"top",value:function(){if(0===this.length)throw new Error("invalid operation: top() called for empty BinaryHeap");return this.collection[0]}},{key:"pop",value:function(){if(0===this.length)throw new Error("invalid operation: pop() called for empty BinaryHeap");var e=this.collection[0];return this.collection.length>1?(this.collection[0]=this.collection.pop(),Ku(this.collection,0,this.comparator)):this.collection.pop(),e}},{key:"push",value:function(e){this.collection.push(e);for(var t=this.collection,i=t.length-1,n=Math.floor(i/2);i>0&&this.comparator(t[n],t[i])<0;i=n,n=Math.floor(n/2)){var r=t[i];t[i]=t[n],t[n]=r}}},{key:"merge",value:function(e){this.collection=e instanceof t?this.collection.concat(e.collection):this.collection.concat(e.toArray()),Yu(this),e.clear()}},{key:"isEmpty",value:function(){return!this.collection.length}},{key:"length",get:function(){return this.collection.length}}],[{key:"from",value:function(e){var i=new t(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return i.collection=Array.from(e),Yu(i),i}}]),t}($u),sg=rg;class ag{constructor(e,t){this._tenantId=e,this.listeners=[],this._logger=t.createChild(`TelemetryLogger[${e}]`);const i=this._tenantId;t.log(`Notification Manager Notification Manager logger initialized for tenant ${i}`),this._discardedEventsBufferPQ=new sg({comparator:(e,t)=>t.latency-e.latency})}addNotificationListener(e){this.listeners.find((t=>t===e))||this.listeners.push(e)}removeNotificationListener(e){this.listeners=this.listeners.filter((t=>t!==e))}eventsSent(e){const t=JSON.stringify(e);this._logger.log(`Notification Manager sent telemetry events ${t}`),this.listeners.forEach((t=>t.eventsSent&&t.eventsSent(e)))}eventsDiscarded(e,t){this._logger.log(`Notification Manager discarded telemetry events ${JSON.stringify(e)}, reason ${t} adding to retry buffer`),e.forEach((e=>{e.latency=e.latency||sn;const t=e;(t.sendAttempt||0)<=yl().telemetry.discardedEventsMaxRetries?this._discardedEventsBufferPQ.push(t):this._logger.log(`Notification Manager dropping event due to too many retries ${JSON.stringify(e)}`)}));const i=yl().telemetry.discardedEventsBufferMaxLength;for(;this._discardedEventsBufferPQ.length>i;)this._logger.log(` dropping event from retry buffer ${this._discardedEventsBufferPQ.dequeue()} due to overflow`);this.listeners.forEach((i=>i.eventsDiscarded&&i.eventsDiscarded(e,t)))}getDiscardedEvents(){const e=[],t=this._discardedEventsBufferPQ.length;for(let i=0;i<t;i++)e.push(this._discardedEventsBufferPQ.dequeue());return e}}class og{constructor(e,t,i,n){this._telemetryLoggers=new Map,this._eventsBufferMap=new Map,this._initialized=!1,this.sdkDiagnosticInformation="",this._telemetryRateLimit=new Map,this._mediaEventsReportedForTheCall={},this._logger=e.createChild("TelemetryLogManager"),this.sdkDiagnosticInformation=t,this._sdkInternaVersion=dl(),this._acsProxy=i,this._acsCustomRelayManager=n,yl().telemetry.limit.rates.forEach((e=>{this._telemetryRateLimit.set(e.eventName,{...e,windowStartTime:Date.now(),eventCount:0})}))}getTelemetryLoggers(){return this._telemetryLoggers}getEventsBufferMap(){return this._eventsBufferMap}isInitialized(){return this._initialized}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}initialize(e){if(!e.cloudType)throw this._logger.error("Failed to initialize telemetry loggers, invalid cloud type provided."),new I({defaultError:f.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE});if(this._initialized)throw this._logger.error("Failed to initialize telemetry loggers, telemetry log manager is already initialized."),new I({defaultError:f.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED});this._telemetryLoggers.forEach(((t,i)=>{try{t.initialize(e),this._logger.log(`Initialized and flushed buffered telemetry logger for ${i}`)}catch(e){this._logger.warn(`Failed to initialize and flush buffered telemetry logger for ${i}`),this._telemetryLoggers.delete(i)}})),this._initialized=!0,this._caConfigBag=e,this._logger.log(`Telemetry log manager has been initialized for Call Client: ${this._caConfigBag.clientId}`)}clearTelemetryLoggers(){const e=this._telemetryLoggers.size;return this._telemetryLoggers=new Map,this._caConfigBag=void 0,this._initialized=!1,e}getMediaEventReportedPromise(e){if(!this._mediaEventsReportedForTheCall[e]){const t=Rl();t.promise.catch(kl),this._mediaEventsReportedForTheCall[e]=t}return this._mediaEventsReportedForTheCall[e].promise}_reportMediaEventForTheCall(e){if(this._mediaEventsReportedForTheCall[e])this._mediaEventsReportedForTheCall[e].resolve();else{const t=Rl();t.promise.catch(kl),t.resolve(),this._mediaEventsReportedForTheCall[e]=t}}_getEventDataWithoutPii(e){const t={};if(e.properties)for(const i of Object.keys(e.properties)){const n=e.properties[i];t[i]={value:n?.value??n,kind:n?.piiKind??0}}return t}sendEvent(e,t){try{if(this._logger.debug(`sending event=${e.name}`),this.checkIfEventIsBlocked(e.name)||this.shouldLimitSendingTelemetry(e.name)||this.isRateLimitExceeded(e.name))return void this._logger.debug(`event=${e.name} is blocked`);const i={name:e.name,data:e.properties};i?.name in gg&&(i.data=this._getEventDataWithoutPii(e)),void 0===i.data&&(i.data={}),i?.name===gg.mdsc_webrtc_session&&this._reportMediaEventForTheCall(i?.data?.CorrelationId),void 0!==typeof e.priority?i.latency=e.priority:i.latency=sn;const n=yl().telemetryEvents.eventNameToPriority.eventName.indexOf(e.name);-1!==n&&(i.latency=yl().telemetryEvents.eventNameToPriority.priority[n]),i.data.sdkVersion=this._sdkInternaVersion,i.data.platformId="3617";const r=`3617/${this._sdkInternaVersion}`;i.data.uiVersion=r,i.data.ui_version=r,i.data.Platform_Uiversion=r,i.data.userAgent=`${this.sdkDiagnosticInformation} ${navigator.userAgent}`,i.data.clientTimestamp=+new Date,i.data.customProxyAndRelayUsage=this.getCustomProxyAndRelayTag();const s=e.tenant;let a=this._eventsBufferMap.get(s);a||(a=this._eventsBufferMap.set(s,[]).get(s));let o=this._telemetryLoggers.get(s);if(o||(o=new cg(s,this._logger,a,this._acsProxy),this._telemetryLoggers.set(s,o),this._logger.log(`Created telemetry logger for ${s}`)),this._initialized){if(!o.isInitialized())try{o.initialize(this._caConfigBag),this._logger.log(`Created and initialized telemetry logger for ${s}`)}catch(e){throw this._telemetryLoggers.delete(s),a?.push(i),this._logger.error(`Failed to create and initialize telemetry logger for ${s}`),new I({defaultError:f.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE,defaultErrorMessageArgs:[s]})}t&&o.getAppInsightsCore()?.addNotificationListener(t),o.sendEvent(i)}else a?.push(i)}catch(t){this._logger.warn(`Failed to send event ${e?.name}`)}}async flushAllEvents(e){if(this._logger.debug(`flushing events: ${this._telemetryLoggers.size}`),-1!==yl().telemetry.telemetryFlushTimeout){const t=(t,i)=>{try{const n=Rl();n.promise.catch(kl);const r=Fu((async()=>(i===pc&&await this.getMediaEventReportedPromise(e),n.promise)),yl().telemetry.telemetryFlushTimeout);return t.flushEvents((()=>{this._logger.debug("events flushed"),n.resolve()})),r.then(kl)}catch(e){throw new I({defaultError:f.INTERNAL.TELEMETRY_FAILED_TO_FLUSH})}},i=[];return this._telemetryLoggers.forEach(((e,n)=>{i.push(t(e,n).catch((()=>{this._logger.warn("Failed to flush telemetry")})))})),Promise.all(i)}this._telemetryLoggers.forEach((e=>{try{e.flushEvents()}catch(e){this._logger.warn("Failed to flush telemetry")}}))}checkIfEventIsBlocked(e){if(Array.isArray(yl()?.telemetry?.blockedEvents)){const t=yl()?.telemetry?.blockedEvents;return Array.isArray(t)&&t?.indexOf(e)>-1||!1}return!1}shouldLimitSendingTelemetry(e){return yl().telemetry.limit.outSideCall.enabled&&(0===yl().telemetry.limit.outSideCall.includedEvents.length||yl().telemetry.limit.outSideCall.includedEvents.includes(e))&&!yl().telemetry.limit.outSideCall.excludedEvents.includes(e)&&og.callEndTimestamp!==Number.MAX_SAFE_INTEGER&&og.callEndTimestamp+yl().telemetry.limit.outSideCall.deltaTimeInMs-Date.now()<0}isRateLimitExceeded(e){const t=this._telemetryRateLimit.get(e);if(t){const i=Date.now();if(i-t.windowStartTime>t.windowSizeInMs&&(t.windowStartTime=i,t.eventCount=0),t.eventCount++,t.eventCount>t.maxEventPerWindow)return this._logger.info(`Telemetry event ${e} is rate limited`),!0}return!1}getCustomProxyAndRelayTag(){const e=this._acsProxy?.proxyInUse??!1,t=this._acsCustomRelayManager?.hasRelayConfig??!1;return e&&t?Jc.usedProxyAndNonMsftTurn:e?Jc.onlyUsedProxy:t?Jc.onlyUsedNonMsftTurn:Jc.noCustomProxyAndTurnUsed}}og.telemetryPayloadBytesOriginal=0,og.telemetryPayloadBytesCompressed=0,og.callEndTimestamp=0;class cg{constructor(e,t,i,n){this._tenantId=e,this._eventsBuffer=i,this._initialized=!1,this._networkOnline=!0,this._telemetryRetryIntervalRunning=!1,this._logger=t.createChild(`TelemetryLogger[${e}]`),this._acsProxy=n,window.addEventListener("online",(e=>{this._networkOnline=e.detail,this._networkOnline&&this._initialized&&!this._telemetryRetryIntervalRunning&&(this._logger.log("browser network back online starting telemetry send retry"),this.scheduleDiscardedTelemetryRetry())}))}initialize(e){if(this._initialized)this._logger.warn(`Telemetry logger for tenant: ${this._tenantId}, already initialized`);else try{const t=new Fo;this._appInsightsCore=new wn,this._postChannel=new Aa;const i={instrumentationKey:this._tenantId,extensions:[this._postChannel,t],disableCookiesUsage:!0},n={populateBrowserInfo:!0,populateOperatingSystemInfo:!0};void 0===i.extensionConfig&&(i.extensionConfig={}),i.extensionConfig[t.identifier]=n;const r={overrideEndpointUrl:this.getAriaCollectorUrl(e),payloadPreprocessor:yl().telemetry.gzipTelemetryPayload?(e,t)=>{this.gzipPayload(e,t)}:void 0};if(i.extensionConfig[this._postChannel.identifier]=r,Object.keys(yl().calling?.eudb?.acsCompliantEvents).length>0&&(lg={...lg,...yl().calling.eudb.acsCompliantEvents}),yl().telemetry.localStorageEnable){const e=new Hs;i.extensions?.push(e);const t={storageKey:"WebSdkTelemetry"};i.extensionConfig[e.identifier]=t}this._NotificationManager=new ag(this._tenantId,this._logger),this._appInsightsCore.initialize(i,[],void 0,this._NotificationManager),this._caConfigBag=e,this.scheduleDiscardedTelemetryRetry(),this._initialized=!0,this._eventsBuffer.forEach((e=>{this.sendEvent(e)})),this._eventsBuffer.splice(0,this._eventsBuffer.length)}catch(e){throw this._logger.error(`Failed to initialize telemetry logger for tenant: ${this._tenantId}`),new I({defaultError:f.INTERNAL.TELEMETRY_LOGGER_INIT_FAIL})}}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}isInitialized(){return this._initialized}getAppInsightsCore(){return this._appInsightsCore}sendEvent(e){this._initialized&&(e?.name in lg&&this.appendEudbComplianceRegionToEvent(e),e?.data&&(e.data.clientId=this._caConfigBag?.clientId||"",0===e?.name?.indexOf("mdsc_webrtc")?e.data.metrics_AcsResourceId=this._caConfigBag?.acsResourceId||"":e.data.AcsResourceId=this._caConfigBag?.acsResourceId||"",e.data.cloudType=this._caConfigBag?.cloudType||"",e.data.identityType=this._caConfigBag?.identityType||""),this.sendAppInsightsCoreEvent(e))}scheduleDiscardedTelemetryRetry(){const e=yl().telemetry.discardedTelemetryRetryTimeout;let t=setInterval((async()=>{this._networkOnline?(this._NotificationManager?.getDiscardedEvents().forEach((e=>{this.sendEvent(e)})),this._telemetryRetryIntervalRunning=!0):(this._logger.log("browser lost network access stopping telemetry send retry"),clearInterval(t),this._telemetryRetryIntervalRunning=!1)}),e)}sendAppInsightsCoreEvent(e){this._appInsightsCore?.track(e)}flushEvents(e){this._initialized&&this._postChannel&&this._postChannel.flush(!1,e)}getAriaCollectorUrl(e){const t=Ll(e.identityType,e.region);let i;if(e.identityType===ic.Enterprise)i=t?Wo:qo;else switch(e.cloudType){case zo.Public:i=t?Bo:Vo;break;case zo.GccHigh:i=Ho;break;case zo.Dod:i=$o;break;case zo.AirGap08:i=Go;break;case zo.AirGap09:i=jo;break;default:i=Vo}return this._acsProxy?this._acsProxy.proxyfyUrl(i):i}gzipPayload(e,t){try{og.telemetryPayloadBytesOriginal+=bl(e.data,this._logger),e.data=ku.gzip(e.data),e.urlString+="&content-encoding=gzip",og.telemetryPayloadBytesCompressed+=bl(e.data,this._logger)}catch(e){this._logger.warn("Failed to gzip with pako: ",e)}t(e)}getRegion(e){if(this._caConfigBag&&xl(this._caConfigBag.identityType))switch(e){case"emea":case"de":return lc.EMEA;case"apac":return lc.APAC;case"noam":case"amer":return lc.NOAM;default:return this._logger.log(`Unable to map region \`${e}\`, to EudbTenantRegion`),lc.UNKNOWN}return e&&sc.includes(e)?lc.EMEA:e&&ac.includes(e)?lc.APAC:e&&oc.includes(e)?lc.NOAM:(this._logger.log(`Unable to map region \`${e}\`, to EudbTenantRegion`),lc.UNKNOWN)}appendEudbComplianceRegionToEvent(e){let t=this.getTenantComplianceRegion();const i=this.getRegion(this._caConfigBag?.region);if(e.data){let n={};n[dg]=t,n[ug]=i,e.data[hg]=n}}getTenantComplianceRegion(){return this._caConfigBag&&Ll(this._caConfigBag.identityType,this._caConfigBag.region)?cc.EU:cc.RoW}}!function(e){e.remote_view="remote_view",e.remote_stream="remote_stream",e.network_quality="network_quality",e.video_device_issue="video_device_issue",e.other_diagnostic="other_diagnostic",e.logger_event="logger_event",e.number_of_participants="number_of_participants",e.media_metrics_device_events="media_metrics_device_events",e.sdk_active_in_another_tab="sdk_active_in_another_tab",e.network_changed="network_changed"}(Qu||(Qu={})),function(e){e.acs_calling_call_attempt="acs_calling_call_attempt",e.acs_calling_call_connected="acs_calling_call_connected",e.acs_calling_call_failed="acs_calling_call_failed",e.acs_calling_call_accept_attempt="acs_calling_call_accept_attempt",e.acs_calling_call_accept_connected="acs_calling_call_accept_connected",e.acs_calling_call_accept_failed="acs_calling_call_accept_failed",e.acs_calling_call_reject_attempt="acs_calling_call_reject_attempt",e.acs_calling_call_reject_success="acs_calling_call_reject_success",e.acs_calling_call_reject_failed="acs_calling_call_reject_failed",e.acs_calling_call_hangup_attempt="acs_calling_call_hangup_attempt",e.acs_calling_call_hangup_success="acs_calling_call_hangup_success",e.acs_calling_call_hangup_failure="acs_calling_call_hangup_failure",e.acs_calling_call_progress="acs_calling_call_progress",e.acs_calling_stack_init="acs_calling_stack_init",e.acs_calling_get_device_manager="acs_calling_get_device_manager",e.acs_calling_config_fetched_attempt="acs_calling_config_fetched_attempt",e.acs_calling_config_fetched_success="acs_calling_config_fetched_success",e.acs_calling_config_fetched_failure="acs_calling_config_fetched_failure",e.acs_calling_signaling_init="acs_calling_signaling_init",e.acs_calling_call_agent="acs_calling_call_agent",e.acs_calling_call_agent_init_attempt="acs_calling_call_agent_init_attempt",e.acs_calling_call_agent_init_success="acs_calling_call_agent_init_success",e.acs_calling_call_agent_init_failure="acs_calling_call_agent_init_failure",e.acs_calling_create_view_attempt="acs_calling_create_view_attempt",e.acs_calling_create_view_success="acs_calling_create_view_success",e.acs_calling_create_view_failure="acs_calling_create_view_failure",e.acs_calling_dispose_view_attempt="acs_calling_dispose_view_attempt",e.acs_calling_dispose_view_success="acs_calling_dispose_view_success",e.acs_calling_dispose_view_failure="acs_calling_dispose_view_failure",e.acs_calling_start_video_attempt="acs_calling_start_video_attempt",e.acs_calling_start_video_success="acs_calling_start_video_success",e.acs_calling_start_video_failure="acs_calling_start_video_failure",e.acs_calling_stop_video_on_ufd_attempt="acs_calling_stop_video_on_ufd_attempt",e.acs_calling_stop_video_attempt="acs_calling_stop_video_attempt",e.acs_calling_stop_video_success="acs_calling_stop_video_success",e.acs_calling_stop_video_failure="acs_calling_stop_video_failure",e.acs_calling_call_hold_and_resume="acs_calling_call_hold_and_resume",e.acs_calling_start_screen_share="acs_calling_start_screen_share",e.acs_calling_stop_screen_share="acs_calling_stop_screen_share",e.acs_calling_audio_stream_volume="acs_calling_audio_stream_volume",e.acs_calling_call_stats="acs_calling_call_stats",e.acs_calling_participant_added_or_removed="acs_calling_participant_added_or_removed",e.acs_calling_adp_attempt="acs_calling_adp_attempt",e.acs_calling_adp_success="acs_calling_adp_success",e.acs_calling_adp_failure="acs_calling_adp_failure",e.acs_calling_client_operations="acs_calling_client_operations",e.acs_calling_device_permission_changed="acs_calling_device_permission_changed",e.acs_calling_local_audio_source_changed="acs_calling_local_audio_source_changed",e.acs_calling_start_audio_stream_track="acs_calling_start_audio_stream_track",e.acs_calling_stop_audio_stream_track="acs_calling_stop_audio_stream_track",e.acs_calling_get_remote_audio_stream_track="acs_calling_get_remote_audio_stream_track",e.acs_calling_get_raw_device_media_stream="acs_calling_get_raw_device_media_stream",e.acs_calling_media_stream="acs_calling_media_stream",e.acs_calling_page_hidden="acs_calling_page_hidden",e.acs_calling_orientation_changed="acs_calling_orientation_changed",e.acs_calling_token_expiration_changed="acs_calling_token_expiration_changed",e.acs_calling_token_expiration_changed_failure="acs_calling_token_expiration_changed_failure",e.acs_calling_token_expired="acs_calling_token_expired",e.acs_calling_token_has_no_data_location="acs_calling_token_has_no_data_location",e.acs_calling_mute_on_ufd_attempt="acs_calling_mute_on_ufd_attempt",e.acs_calling_mute_attempt="acs_calling_mute_attempt",e.acs_calling_mute_success="acs_calling_mute_success",e.acs_calling_mute_failure="acs_calling_mute_failure",e.acs_calling_unmute_attempt="acs_calling_unmute_attempt",e.acs_calling_unmute_success="acs_calling_unmute_success",e.acs_calling_unmute_failure="acs_calling_unmute_failure",e.acs_calling_start_audio_attempt="acs_calling_start_audio_attempt",e.acs_calling_start_audio_success="acs_calling_start_audio_success",e.acs_calling_start_audio_failure="acs_calling_start_audio_failure",e.acs_calling_unmute_speaker_attempt="acs_calling_unmute_speaker_attempt",e.acs_calling_unmute_speaker_success="acs_calling_unmute_speaker_success",e.acs_calling_unmute_speaker_failure="acs_calling_unmute_speaker_failure",e.acs_calling_stop_audio_attempt="acs_calling_stop_audio_attempt",e.acs_calling_stop_audio_success="acs_calling_stop_audio_success",e.acs_calling_stop_audio_failure="acs_calling_stop_audio_failure",e.acs_calling_prevent_stop_audio="acs_calling_prevent_stop_audio",e.acs_calling_captions="acs_calling_captions",e.acs_calling_mid_call_media_stats="acs_calling_mid_call_media_stats",e.acs_calling_mid_call_new_media_stats="acs_calling_mid_call_new_media_stats",e.acs_calling_mid_call_raw_media_stats="acs_calling_mid_call_raw_media_stats",e.acs_calling_datachannel="acs_calling_datachannel",e.acs_calling_datachannel_stats="acs_calling_datachannel_stats",e.acs_calling_unmixed_audio="acs_calling_unmixed_audio",e.acs_calling_livestream_stats="acs_calling_livestream_stats",e.acs_calling_livestream_raw_stats="acs_calling_livestream_raw_stats",e.acs_calling_survey="acs_calling_survey",e.acs_calling_switch_video_source_attempt="acs_calling_switch_video_source_attempt",e.acs_calling_switch_video_source_success="acs_calling_switch_video_source_success",e.acs_calling_switch_video_source_failure="acs_calling_switch_video_source_failure",e.acs_calling_diagnostics_attempt="acs_calling_diagnostics_attempt",e.acs_calling_diagnostics_result="acs_calling_diagnostics_result",e.acs_calling_feature_usage="acs_calling_feature_usage",e.acs_calling_middletier_gateway_fetch_policy="acs_calling_middletier_gateway_fetch_policy",e.acs_calling_middletier_gateway_emergency_content="acs_calling_middletier_gateway_emergency_content",e.acs_calling_middletier_gateway_fetch_user_policies_for_captions="acs_calling_middletier_gateway_fetch_user_policies_for_captions",e.acs_calling_middletier_gateway_api="acs_calling_middletier_gateway_api",e.acs_calling_call_client_init="acs_calling_call_client_init",e.acs_calling_tab_events="acs_calling_tab_events",e.acs_calling_lobby_events="acs_calling_lobby_events",e.acs_calling_handle_push_notification="acs_calling_handle_push_notification"}(Xu||(Xu={})),function(e){e.attempt="attempt",e.success="success",e.failure="failure",e.getter="getter",e.setter="setter",e.subscribe="subscribe",e.unsubscribe="unsubscribe",e.initialize="initialize",e.event="event"}(Zu||(Zu={})),function(e){e.lobbyAdmit="lobbyAdmit",e.lobbyAdmitAll="lobbyAdmitAll",e.lobbyReject="lobbyReject"}(eg||(eg={})),function(e){e.MuteMicrophone="MuteMicrophone",e.MuteAllRemoteParticipants="MuteAllRemoteParticipants",e.MuteSpecificParticipant="MuteSpecificParticipant",e.UnmuteMicrophone="UnmuteMicrophone",e.MuteIncomingAudio="MuteIncomingAudio",e.UnmuteIncomingAudio="UnmuteIncomingAudio"}(tg||(tg={})),function(e){e.Expected="expected",e.Unexpected="unexpected",e.Unknown="unknown"}(ig||(ig={})),function(e){e.CaptionsKindChanged="CaptionsKindChanged",e.FirstCaptionReceived="FirstCaptionReceived",e.FirstCaptionParsingError="FirstCaptionParsingError",e.InitializeCaptions="InitializeCaptions",e.LanguageChanged="LanguageChanged",e.SetSpokenLanguage="SetSpokenLanguage",e.SetCaptionLanguage="SetCaptionLanguage",e.SpokenLanguageChanged="SpokenLanguageChanged",e.StartCaptions="StartCaptions",e.StopCaptions="StopCaptions",e.UpdateIsActive="UpdateIsActive"}(ng||(ng={}));let lg={...Xu,skypecosi_concore_web_csa_conversation_callmodality:"skypecosi_concore_web_csa_conversation_callmodality",skypecosi_concore_web_pluginless_modality_session:"skypecosi_concore_web_pluginless_modality_session",skypecosi_concore_web_pluginless_call_session:"skypecosi_concore_web_pluginless_call_session",skypecosi_concore_web_csa_conversation_httprequest:"skypecosi_concore_web_csa_conversation_httprequest"};const dg="tenantComplianceRegion",hg="acsCompliancePayload",ug="tenantRegion";var gg,pg,mg,fg,Sg,vg,yg,Cg,_g,Eg,Tg,Ig,bg,Ag,Rg,wg,Pg,Mg,Dg,Og,kg,Ng,Lg;function xg(e){const t=new URL(e),i=t.pathname.split("/"),n=decodeURIComponent(i[3]);return!!t.searchParams.get("context")&&!!n}function Ug(e,t){let i=!0;try{const t=new URL(e);if(yl().teamsMeetingShortUrlJoin.validatePattern){const e=new RegExp(yl().teamsMeetingShortUrlJoin.regexPattern);i=!!t.toString().trim().match(e)}}catch(e){t.error(`Teams Meeting url validation failed with error= ${JSON.stringify(e)}`),i=!1}return i}function Fg(e,t){return t.some((t=>e.includes(t.trim().toLocaleLowerCase())))}function Vg(e){try{const t=new URL(e),i=t.pathname.split("/"),n=decodeURIComponent(i[3]),r=i[4],s=JSON.parse(decodeURIComponent(t.search.replace("?context=","")));return{threadId:n,messageId:r,organizerId:s.Oid,tenantId:s.Tid}}catch(e){throw new I({defaultError:f.CALL_AGENT.INVALID_MEETING_LINK,originalError:e})}}!function(e){e.mdsc_webrtc_session="mdsc_webrtc_session",e.mdsc_webrtc_session_initial="mdsc_webrtc_session_initial"}(gg||(gg={})),function(e){e.Outgoing="Outgoing",e.Incoming="Incoming",e.TransferOutgoing="TransferOutgoing"}(pg||(pg={})),function(e){e.CreateCallAgent="CreateCallAgent",e.CreateTeamsCallAgent="CreateTeamsCallAgent",e.GetDeviceManager="GetDeviceManager",e.GetEnvironmentInfo="GetEnvironmentInfo",e.GetSDKVersion="GetSDKVersion",e.Feature="Feature"}(mg||(mg={})),function(e){e.StartCall="StartCall",e.Join="Join",e.HandlePushNotification="HandlePushNotification",e.Initialize="Initialize",e.Dispose="Dispose",e.CreateCall="CreateCall",e.Feature="Feature"}(fg||(fg={})),function(e){e.Call="Call",e.StartCall="StartCall",e.CallGroup="CallGroup",e.JoinGroup="JoinGroup",e.Accept="Accept",e.Reject="Reject",e.Mute="Mute",e.Unmute="Unmute",e.MuteAllRemoteParticipants="MuteAllRemoteParticipants",e.MuteIncomingAudio="MuteIncomingAudio",e.UnmuteIncomingAudio="UnmuteIncomingAudio",e.SendDtmf="SendDtmf",e.HangUp="HangUp",e.StartVideo="StartVideo",e.startAudio="startAudio",e.StopVideo="StopVideo",e.AddParticipant="AddParticipant",e.RemoveParticipant="RemoveParticipant",e.LobbyAdmitParticipant="LobbyAdmitParticipant",e.LobbyRejectParticipant="LobbyRejectParticipant",e.LobbyAdmitAll="LobbyAdmitAll",e.Hold="Hold",e.Resume="Resume",e.StartScreenShare="StartScreenShare",e.StopScreenShare="StopScreenShare",e.Transfer="Transfer",e.BindToCall="BindToCall",e.Feature="Feature",e.SetConstraints="SetConstraints"}(Sg||(Sg={})),function(e){e.Mute="Mute"}(vg||(vg={})),function(e){e.GetServerCallId="GetServerCallId"}(yg||(yg={})),function(e){e.CreateStackBase="CreateStackBase",e.GetDeviceManager="GetDeviceManager",e.InitializeStackForUser="InitializeStackForUser",e.InitializeEcsBase="InitializeEcsBase",e.InitializeEcsForUser="InitializeEcsForUser",e.Dispose="Dispose"}(Cg||(Cg={})),function(e){e.GetDeviceManager="GetDeviceManager",e.GetCameras="GetCameras",e.GetMicrophones="GetMicrophones",e.GetSpeakers="GetSpeakers",e.GetCamera="GetCamera",e.SelectCamera="SelectCamera",e.GetSelectedMicrophone="GetSelectedMicrophone",e.SelectMicrophone="SelectMicrophone",e.GetSelectedSpeaker="GetSelectedSpeaker",e.SelectSpeaker="SelectSpeaker",e.RenderPreviewVideo="RenderPreviewVideo",e.AskDevicePermission="AskDevicePermission"}(_g||(_g={})),function(e){e.Dispose="Dispose",e.UpdateScalingMode="UpdateScalingMode",e.Render="Render",e.RenderRemoteStream="RenderRemoteStream",e.RenderLocalStream="RenderLocalStream"}(Eg||(Eg={})),function(e){e.Dispose="Dispose",e.CreateView="CreateView"}(Tg||(Tg={})),function(e){e.SwitchSource="SwitchSource",e.Render="Render",e.GetMediaStream="GetMediaStream",e.SetMediaStream="SetMediaStream",e.SwitchVideo="SwitchVideo",e.Feature="Feature"}(Ig||(Ig={})),function(e){e.SwitchSource="SwitchSource",e.GetMediaStream="GetMediaStream",e.SetMediaStream="SetMediaStream",e.Feature="Feature"}(bg||(bg={})),function(e){e.SetScalingMode="SetScalingMode",e.Start="Start",e.Stop="Stop",e.SwitchDevice="SwitchDevice",e.Dispose="Dispose"}(Ag||(Ag={})),function(e){e.Render="Render",e.GetMediaStream="GetMediaStream"}(Rg||(Rg={})),function(e){e.Start="Start",e.Resume="Resume",e.Pause="Pause",e.SetScalingMode="SetScalingMode",e.Dispose="Dispose"}(wg||(wg={})),function(e){e.Start="Start",e.Resume="Resume",e.Pause="Pause",e.SetScalingMode="SetScalingMode",e.Dispose="Dispose",e.SetSourceObject="SetSourceObject"}(Pg||(Pg={})),function(e){e.SourceUnavailableError="SourceUnavailableError",e.permissionDeniedError="permissionDeniedError",e.PermissionDeniedError="PermissionDeniedError",e.DevicesNotFoundError="DevicesNotFoundError",e.MediaStreamRequestError="MediaStreamRequestError",e.PermissionsDeniedBySystem="PermissionsDeniedBySystem",e.UnknownFailureForVideoOperation="UnknownFailureForVideoOperation",e.noDeviceSelected="noDeviceSelected",e.NoDeviceSelected="NoDeviceSelected",e.MediaStreamRequestTimedout="MediaStreamRequestTimedout",e.UnsupportedStream="UnsupportedStream",e.ConstraintNotSatisfiedError="ConstraintNotSatisfiedError"}(Mg||(Mg={})),function(e){e.BrowserNotSupported="BrowserNotSupported",e.IncompatibleVersions="IncompatibleVersions"}(Dg||(Dg={})),function(e){e.P2P="P2P",e.Multiparty="Multiparty",e.Unknown="Unknown"}(Og||(Og={})),function(e){e.GroupJoin="groupJoin",e.RoomJoin="roomJoin",e.TeamsMeetingJoin="teamsMeetingJoin",e.TransferToParticipant="transferToParticipant",e.TransferToCall="transferToCall",e.NoContext=""}(kg||(kg={})),function(e){e.Enabled="Enabled",e.UserOverride="UserOverride",e.Disabled="Disabled"}(Ng||(Ng={})),function(e){e.Standard="standard",e.MusicOnHold="musicOnHold"}(Lg||(Lg={}));var Bg,Hg,$g,Gg,jg,qg,Wg=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class zg{get threadId(){return this._threadId}get participantId(){return this._tsCall.participantId}constructor(e){this._tsCall=e,this._threadId=this._tsCall.threadId}setThreadId(e){this._threadId=e}initialize(e,t,i){this._logger=t,this._eventEmitter=e,this._threadId=this._tsCall.threadId,this._tsCallChangedListener=this._tsCall.changed((()=>this.threadIdChanged(this._tsCall)))}async getServerCallId(){const e=JSON.parse(await this._tsCall.getJoinBlob()),t=e?.conversationUrl;if(!t)throw new I({defaultError:f.CALL.GET_SERVER_CALL_ID});return function(e){let t=btoa(e).replace(/=/g,"");t=t.replace(/\+/g,"-"),t=t.replace(/\//g,"_");for(const e of t)if(e.match(/[^A-Za-z0-9-_]/))throw new I({defaultError:f.CALL.SERVER_CALL_ID});return t}(t)}threadIdChanged(e){this._tsCall.threadId!==this._threadId&&(this._logger.log(`threadId changed from ${this._threadId} to ${e?.threadId}`),this._threadId=this._tsCall.threadId,this._eventEmitter.emit("threadIdChanged"))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._tsCallChangedListener?.dispose(),this._eventEmitter.removeAllListeners()}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([M(yg.GetServerCallId),Wg("design:type",Function),Wg("design:paramtypes",[]),Wg("design:returntype",Promise)],zg.prototype,"getServerCallId",null);class Jg extends zg{get groupId(){return this._groupId}get roomId(){return this._roomId}get callScenario(){const e=this._tsCall.callType;return 1!==e&&2!==e?Og.Unknown:1===e?Og.P2P:Og.Multiparty}get direction(){return this._config?.isIncoming?pg.Incoming:pg.Outgoing}get initiatorKind(){return sl(this._tsCall.callerMri?this._tsCall.callerMri:"").kind}get targetKind(){return this._tsCall.groupId?this._tsCall.groupId:this._config?.roomId?this._config.roomId:this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.meetingCode?"TeamsMeetingJoinLink":this._tsCall.transferorMri?"Transferee":1===this._tsCall.participants.length?sl(this._tsCall.participants[0].id).kind:this._tsCall.participants.filter((e=>e.id!==this._tsCall.callerMri)).map((e=>sl(e.id).kind)).toString()}get transferorKind(){return this._tsCall.transferorMri?sl(this._tsCall.transferorMri||"").kind:""}get context(){if(this._tsCall.groupId)return kg.GroupJoin;if(this._config?.roomId||this._roomId)return kg.RoomJoin;if(this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.passcode||this._tsCall.threadId)return kg.TeamsMeetingJoin;if("unknown"!==this.transferorKind){if("transfer"===this._tsCall.incomingCallType)return kg.TransferToParticipant;if("replaces"===this._tsCall.incomingCallType)return kg.TransferToCall}return kg.NoContext}constructor(e,t={}){super(e);const i=this._tsCall.groupId;this._groupId=!i||i.startsWith("19:")||i.startsWith("99:")?void 0:i,this._roomId=t.roomId,this._config=t.config}}!function(e){e.AudioRaw="AudioRaw",e.VideoRaw="VideoRaw",e.ScreenSharingRaw="ScreenSharingRaw",e.VideoRawOrScreenSharingRaw="VideoRawOrScreenSharingRaw",e.Audio="Audio",e.Video="Video"}(Bg||(Bg={})),function(e){e.Local="Local",e.Remote="Remote"}(Hg||(Hg={})),function(e){e.getMediaStream="getMediaStream",e.setMediaStream="setMediaStream",e.startEffects="startEffects",e.stopEffects="stopEffects",e.isSupported="isSupported",e.subscribe="subscribe",e.fpsWarningThresholdReached="fpsWarningThresholdReached",e.timeForEffectsWarningReached="timeForEffectsWarningReached",e.effectsError="effectsError",e.switchSource="switchSource",e.render="render"}($g||($g={})),function(e){e.stun="stun",e.turn="turn",e.turns="turns"}(Gg||(Gg={})),function(e){e.tcp="tcp",e.tls="tls",e.udp="udp"}(jg||(jg={})),function(e){e.Public_App="Public_App",e.Internal_LargeMeetingVideoRendering="Internal_LargeMeetingVideoRendering",e.Internal_RemoteVideoStreamDisposed="Internal_RemoteVideoStreamDisposed"}(qg||(qg={}));var Kg,Yg="object"==typeof Reflect?Reflect:null,Qg=Yg&&"function"==typeof Yg.apply?Yg.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};Kg=Yg&&"function"==typeof Yg.ownKeys?Yg.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var Xg=Number.isNaN||function(e){return e!=e};function Zg(){Zg.init.call(this)}var ep=Zg,tp=function(e,t){return new Promise((function(i,n){function r(){void 0!==s&&e.removeListener("error",s),i([].slice.call(arguments))}var s;"error"!==t&&(s=function(i){e.removeListener(t,r),n(i)},e.once("error",s)),e.once(t,r)}))};Zg.EventEmitter=Zg,Zg.prototype._events=void 0,Zg.prototype._eventsCount=0,Zg.prototype._maxListeners=void 0;var ip=10;function np(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function rp(e){return void 0===e._maxListeners?Zg.defaultMaxListeners:e._maxListeners}function sp(e,t,i,n){var r,s,a;if(np(i),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),s=e._events),a=s[t]),void 0===a)a=s[t]=i,++e._eventsCount;else if("function"==typeof a?a=s[t]=n?[i,a]:[a,i]:n?a.unshift(i):a.push(i),(r=rp(e))>0&&a.length>r&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=a.length,function(e){console&&console.warn&&console.warn(e)}(o)}return e}function ap(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function op(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=ap.bind(n);return r.listener=i,n.wrapFn=r,r}function cp(e,t,i){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(r):dp(r,r.length)}function lp(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function dp(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}Object.defineProperty(Zg,"defaultMaxListeners",{enumerable:!0,get:function(){return ip},set:function(e){if("number"!=typeof e||e<0||Xg(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");ip=e}}),Zg.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Zg.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||Xg(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},Zg.prototype.getMaxListeners=function(){return rp(this)},Zg.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var o=r[e];if(void 0===o)return!1;if("function"==typeof o)Qg(o,this,t);else{var c=o.length,l=dp(o,c);for(i=0;i<c;++i)Qg(l[i],this,t)}return!0},Zg.prototype.addListener=function(e,t){return sp(this,e,t,!1)},Zg.prototype.on=Zg.prototype.addListener,Zg.prototype.prependListener=function(e,t){return sp(this,e,t,!0)},Zg.prototype.once=function(e,t){return np(t),this.on(e,op(this,e,t)),this},Zg.prototype.prependOnceListener=function(e,t){return np(t),this.prependListener(e,op(this,e,t)),this},Zg.prototype.removeListener=function(e,t){var i,n,r,s,a;if(np(t),void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){a=i[s].listener,r=s;break}if(r<0)return this;0===r?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,r),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,a||t)}return this},Zg.prototype.off=Zg.prototype.removeListener,Zg.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,s=Object.keys(i);for(n=0;n<s.length;++n)"removeListener"!==(r=s[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},Zg.prototype.listeners=function(e){return cp(this,e,!0)},Zg.prototype.rawListeners=function(e){return cp(this,e,!1)},Zg.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):lp.call(e,t)},Zg.prototype.listenerCount=lp,Zg.prototype.eventNames=function(){return this._eventsCount>0?Kg(this._events):[]},ep.once=tp;class hp{constructor(e){this.disposed=!1,this.callAgent=e.callAgent,this.callClient=e.callClient,this.eventEmitter=new ep.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class up{constructor(e){this.disposed=!1,this.callClient=e.callClient,this.eventEmitter=new ep.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class gp{constructor(e){this.disposed=!1,this.call=e.call,this.callAgent=e.callAgent,this.callInfo=e.callInfo,this.eventEmitter=new ep.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class pp{constructor(e){this.disposed=!1,this.streamInstance=e.streamInstance,this.eventEmitter=new ep.EventEmitter}}class mp{constructor(e){this._logger=e,this._queue=Promise.resolve()}add(e){this._queue||(this._queue=Promise.resolve());let t=e;const i=this._queue?.then(t);return i&&(this._queue=i?.catch((e=>{throw e instanceof I?(this._logger?.error(`Error from promiseQueue! ${JSON.stringify(e)}`),e):new Error(`Error from promiseQueue! ${JSON.stringify(e)}`)}))),i}dispose(){this._queue=null}}const fp=()=>(e,t,i)=>{const n=i.value;return i.value=function(...e){return this.serialQueue.add(n.bind(this,...e))},i};class Sp{constructor(e){this.disposed=!1,this.streamInstance=e.streamInstance,this.eventEmitter=new ep.EventEmitter,this.serialQueue=new mp(this.streamInstance.logger)}}var vp,yp;!function(e){e[e.CallClientFeature=0]="CallClientFeature",e[e.CallAgentFeature=1]="CallAgentFeature",e[e.CallFeature=2]="CallFeature"}(vp||(vp={}));class Cp extends gp{}class _p extends hp{}class Ep extends up{}class Tp extends pp{}class Ip extends Sp{}!function(e){e.Transfer="Transfer",e.StartCaptions="StartCaptions",e.StopCaptions="StopCaptions",e.SetSpokenLanguage="SetSpokenLanguage",e.SetCaptionLanguage="SetCaptionLanguage",e.getMediaStatsCollector="getMediaStatsCollector",e.disposeAllCollectors="disposeAllCollectors"}(yp||(yp={}));class bp{constructor(e,t,i){this._logger=e,this._featureCtorContext=t,this._featureInitContext=i,this._apiObjInstances=new Map}getApiObjectInstance(e){if(!this._apiObjInstances.has(e)){const t=new e(this._featureCtorContext);return(t instanceof Cp||t instanceof _p||t instanceof Ep||t instanceof Tp||t instanceof Ip)&&t.initialize(this._featureInitContext,this._logger),this._apiObjInstances.set(e,t),t}return this._apiObjInstances.get(e)}dispose(){for(const[,e]of this._apiObjInstances)e.dispose()}}const Ap={commandUrl:"",processingModes:{closedCaptions:{state:"Inactive"},realTimeTranscript:{state:"Inactive"}},spokenLanguage:""};var Rp,wp;!function(e){e.Acs="acs",e.Teams="teams",e.Unknown="unknown"}(Rp||(Rp={})),function(e){e.Captions="captions",e.TeamsCaptions="teams_captions"}(wp||(wp={}));class Pp{constructor(e){this._eventEmitter=e,this._captionsModeKey="closedCaptions",this._transcriptModeKey="realTimeTranscript",this._transcriptionDataId=3,this._isCaptionsBot=e=>e.id===this._captionsBotMri,this._getBotMetadata=e=>e?.endpoints?.endpointDetails[0]?.endpointMetadata??void 0,this._getBotDataMediaStreamSourceId=e=>{if(e?.endpoints?.endpointDetails[0]?.mediaStreams){let t=e?.endpoints?.endpointDetails[0]?.mediaStreams;if(t.length>0)for(let e in t)if("data"===t[e].type)return t[e].sourceId}},this._isCaptionsEnabled=e=>"Active"===e?.processingModes?.[this._captionsModeKey]?.state,this._isTranscriptionEnabled=e=>"Active"===e?.processingModes?.[this._transcriptModeKey]?.state,this._copyBotMetaData=e=>{const t=this._getBotMetadata(e)||Ap;return JSON.parse(JSON.stringify(t))},this._isSpokenLanguageChanged=e=>e?.spokenLanguage===this._acsMetadata?.spokenLanguage}dispose(){this._acsMetadata=void 0}}function Mp(e,t={activationEvent:"OnFeatureAccess"}){return{get callApiCtor(){return e},activationOptions:t,isCallFeature:!0}}function Dp(e,t={activationEvent:"OnFeatureAccess"}){return{get callClientApiCtor(){return e},activationOptions:t,isCallClientFeature:!0}}function Op(e,t,i){try{const i={correlationId:e.correlationId||"",callId:e.callId,localParticipantId:e.localParticipantId,featureName:e.featureName,featureType:e.featureType,initializationType:e.initializationType,featureDetails:e.featureDetails,additionalDetails:e.additionalDetails||{}};t.sendEvent({name:Xu.acs_calling_feature_usage,tenant:uc,properties:i})}catch(t){i.debug(`Unable to send ${e.featureName} feature usage telemtery`)}}function kp(e,t,i){try{const i={featureName:e.featureName,featureType:e.featureType,initializationType:e.initializationType,featureDetails:e.featureDetails};t.sendEvent({name:Xu.acs_calling_feature_usage,tenant:uc,properties:i})}catch(t){i.debug(`Unable to send ${e.featureName} feature usage telemetry`)}}const Np={0:"",1:"Success",2:"NoNgcEndpoint",3:"NetworkError",4:"MediaDroppedError",5:"BadRequest",6:"CallEstablishmentTimeout",7:"CallSetupError",8:"NoPermission",9:"Missed",10:"Declined",11:"Busy",12:"Cancelled",13:"Dropped",14:"PstnInsufficientFunds",15:"PstnSkypeoutAccountBlocked",16:"PstnCouldNotConnectToSkypeProxy",17:"PstnBlockedByUs",18:"PstnBlockedRegulatoryIndia",19:"PstnInvalidNumber",20:"PstnNumberForbidden",21:"PstnCallTerminated",22:"PstnNumberUnavailable",23:"PstnEmergencyCallDenied",24:"CallNotFound",25:"LocalError",26:"NotAcceptableHere",27:"CallForwarded",28:"CallForwardedToVoicemail",29:"SkypeTokenError",30:"CallAccepted",31:"LocalHttpStackError",32:"UnknownError",33:"PstnNoSubscriptionCover",34:"SessionNotFound",35:"SessionTimedOut",36:"PstnCreditExpired",37:"PstnCreditExpiredButEnough",38:"RetargetNotSupported",39:"EnterprisePstnInternalError",40:"EnterprisePstnUnavailable",41:"EnterprisePstnForbidden",42:"EnterprisePstnInvalidNumber",43:"EnterprisePstnMiscError",44:"Kicked",45:"NetworkRequestTimeoutError",46:"CallDoesNotExist",47:"MediaSetupFailure",48:"ServiceUnavailable",49:"SignalingError",50:"ConversationEstablishmentFailed",51:"TemporarilyUnavailable",52:"CannotConnectToNetworkError",53:"MediaRelayWhiteListingIssue",54:"NoSignalingFromPeer",55:"DeniedInLobby",56:"TimedOutInLobby",57:"CallFailedConflict",58:"DevicePermissionDenied",59:"ConfParticipantCountLimitReached",60:"ActionNotAllowed",61:"Abandoned",62:"ForbiddenDueToPolicy",63:"InsufficientCapabilitiesForCallee",64:"UserBlocked",65:"AccessDenied",66:"AnonymousJoinDisabledByPolicy",67:"NoLobbyForBroadcastJoin",68:"NotAllowedDueToInformationBarrier",69:"BroadcastLimitReached",70:"TeamParkPolicyDisabled",71:"B2bJoinDisabledByPolicy",72:"LocationBasedRoutingError",73:"ConfLobbyParticipantCountLimitReached",74:"DowngradeToStreamingClient",75:"CallRedirected",76:"CallIsEndToEndEncrypted",77:"Suspended"},Lp=e=>"number"==typeof e&&Np[e]||"UnknownError",xp={0:"",1:"AddingFailed",2:"NoResponse",3:"Declined",4:"NotReachable",5:"Blocked",6:"NotFriendOrAuthorized",7:"CallLimitReached",8:"CallNotFound",9:"NetworkError",10:"MediaDroppedError",11:"OtherError",12:"PstnInsufficientFunds",13:"PstnSkypeoutAccountBlocked",14:"PstnCouldNotConnectToSkypeProxy",15:"PstnBlockedByUs",16:"PstnBlockedRegulatoryIndia",17:"PstnInvalidNumber",18:"PstnNumberForbidden",19:"Busy",20:"PstnCallTerminated",21:"PstnNumberUnavailable",22:"PstnEmergencyCallDenied",23:"Cancelled",24:"Dropped",25:"PstnNoSubscriptionCover",26:"PstnCreditExpired",27:"PstnCreditExpiredButEnough",28:"EnterprisePstnInternalError",29:"EnterprisePstnUnavailable",30:"EnterprisePstnForbidden",31:"EnterprisePstnInvalidNumber",32:"EnterprisePstnMiscError",33:"Kicked",34:"NetworkRequestTimeoutError",35:"CallDoesNotExist",36:"MediaSetupFailure",37:"ServiceUnavailable",38:"SignalingError",39:"ConversationEstablishmentFailed",40:"TemporarilyUnavailable",41:"CannotConnectToNetworkError",42:"NoSignalingFromPeer",43:"ParticipantDoesNotExist",44:"DeniedInLobby",45:"TimedOutInLobby",46:"ConfParticipantCountLimitReached",47:"Abandoned",48:"ActionNotAllowed",49:"ForbiddenDueToPolicy",50:"InsufficientCapabilitiesForCallee",51:"AccessDenied",52:"NoPermission",53:"AnonymousJoinDisabledByPolicy",54:"NoLobbyForBroadcastJoin",55:"NotAllowedDueToInformationBarrier",56:"BroadcastLimitReached",57:"B2bJoinDisabledByPolicy",58:"LocationBasedRoutingError",59:"ConfLobbyParticipantCountLimitReached",60:"LobbyUserLeft"},Up=e=>"number"==typeof e&&xp[e]||"UnknownError",Fp={0:"None",1:"Incoming Call",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",10:"InLobby",9:"EarlyMedia",6:"Disconnecting",7:"Disconnected",8:"Unknown",11:"Unknown",12:"Unknown",13:"Unknown",14:"Unknown",15:"Unknown"},Vp={0:"None",1:"RealTime",2:"Streaming"};function Bp(e,t){let i=0,n=0,r=Oc,s=[];return e.tsCall&&(i=e.tsCall.callEndDiagnosticsInfo&&e.tsCall.callEndDiagnosticsInfo.callControllerCode||0,n=e.tsCall.callEndDiagnosticsInfo&&e.tsCall.callEndDiagnosticsInfo.callControllerSubCode||0,s=e.tsCall.callEndDiagnosticsInfo&&e.tsCall.callEndDiagnosticsInfo.resultCategories||["Success"]),r=Lp(t||e.tsCall?.terminatedReason||0),e.logger.error(`Call end reason=${r}, code=${i}, subCode=${n}, resultCategories=${s.toString()}`),{callEndReason:{message:r,code:i,subCode:n,resultCategories:s},callingCommunicationError:new I({defaultError:{message:r,code:i,subCode:n,resultCategories:s}})}}function Hp(e,t,i){let n=0,r=0,s=Oc,a=[];if(t?.callEndDiagnosticsInfo)s=Up(i||t.stateReason||0),n=t.callEndDiagnosticsInfo&&t.callEndDiagnosticsInfo.callControllerCode||0,r=t.callEndDiagnosticsInfo&&t.callEndDiagnosticsInfo.callControllerSubCode||0,a=t.callEndDiagnosticsInfo&&t.callEndDiagnosticsInfo.resultCategories||[];else{let t=Bp(e,i);n=t.callEndReason.code,r=t.callEndReason.subCode||0,a=t.callEndReason.resultCategories,s=t.callEndReason.message}return e.logger[0===n?"info":"error"](`Participant call end reason=${s}, code=${n}, subCode=${r}, resultCategories=${a.toString()}`),{callEndReason:{message:s,code:n,subCode:r,resultCategories:a},callingCommunicationError:new I({defaultError:{message:s,code:n,subCode:r,resultCategories:a}})}}function $p(e,t){let i;switch(t?.type?t.type:Mg.UnknownFailureForVideoOperation){case Mg.DevicesNotFoundError:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.DEVICES_NOT_FOUND});break;case Mg.MediaStreamRequestError:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.MEDIA_STREAM_REQUEST_ERROR});break;case Mg.MediaStreamRequestTimedout:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.MEDIA_STREAM_REQUEST_TIMEDOUT});break;case Mg.PermissionsDeniedBySystem:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.PERMISSION_DENIED_BY_SYSTEM});break;case Mg.UnsupportedStream:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.UNSUPPORTED_STREAM});break;case Mg.ConstraintNotSatisfiedError:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.CONSTRAINT_NOT_SATISFIED});break;case Mg.noDeviceSelected:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.NO_DEVICE_SELECTED});break;case Mg.SourceUnavailableError:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.SOURCE_UNAVAILABLE});break;case Mg.PermissionDeniedError:case Mg.permissionDeniedError:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.PERMISSION_DENIED});break;default:i=new I({defaultError:f.LOCAL_VIDEO_STREAM.UNKNOWN})}return i}function Gp(e,t){return new I({defaultError:{message:t.message,code:e?.response?.status||t.code,subCode:t.subCode,resultCategories:t.resultCategories},originalError:e})}function jp(e){return{communicationServicesError:{message:e.message||"Unknown error",code:void 0===e.code?_:e.code,subCode:e.subCode||0,resultCategories:void 0===e.resultCategories||0===e.resultCategories.length?["UnexpectedClientError"]:e.resultCategories}}}function qp(e){return{callEndReason:{message:e.message,code:void 0===e.code?_:e.code,subCode:e.subCode||0,resultCategories:void 0===e.resultCategories||0===e.resultCategories.length?["UnexpectedClientError"]:e.resultCategories}}}var Wp=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},zp=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const Jp=Date.UTC(1900,0,1);class Kp{constructor(e,t){this._eventEmitter=t,this._impl=e}async startCaptions(e){await this._impl.startCaptions(e)}async stopCaptions(){await this._impl.stopCaptions()}async setSpokenLanguage(e){await this._impl.setSpokenLanguage(e)}get supportedSpokenLanguages(){return this._impl.supportedSpokenLanguages}get isCaptionsFeatureActive(){return this._impl.isCaptionsFeatureActive}get activeSpokenLanguage(){return this._impl.activeSpokenLanguage}get kind(){return this._impl.kind}}class Yp extends Kp{constructor(e,t){super(e,t)}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}}class Qp extends Kp{constructor(e,t){super(e,t)}get supportedCaptionLanguages(){return this._impl.supportedCaptionLanguages}get activeCaptionLanguage(){return this._impl.activeCaptionLanguage}async setCaptionLanguage(e){await this._impl.setCaptionLanguage(e)}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}}class Xp extends Pp{constructor(e,t,i,n){super(e),this._botParticipantId="",this._isCteUser=!1,this._isCaptionsActive=!1,this._firstTimeActive=!1,this._ecsCaptionsEnabled=!1,this._ecsSpokenLanguagesEnabled=!1,this._ecsSpokenLanguages=[],this._ecsCaptionLanguagesEnabled=!1,this._ecsCaptionLanguages=[],this._ecsAmtPolicyUrlSuffix="",this._hasReportedCaptionParseFailure=!1,this._hasReceivedFirstCaption=!1,this._currentLanguage="",this._currentCaptionLanguage="",this._participantSequenceIdMap={},this._addParticipantPromise=null,this._dataChannelHandler={onStarted:async(e,t)=>{},onStopped:async e=>{},onDataReceived:async(e,t,i)=>{let n;try{n=JSON.parse(t.toString())}catch(e){try{if(void 0===this._textDecoder)throw new Error("TextDecoder undefined.");n=JSON.parse(this._textDecoder.decode(t))}catch(e){return this._logger.error("Failed to parse Captions result",e),void(this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(ng.FirstCaptionParsingError,Zu.failure,"",0,ig.Unexpected,"Could not decode data packet.")))}}if(n){let e=[];n.textTracks?e=n.textTracks:n.recognitionResults&&(e=n.recognitionResults),e.forEach((e=>{try{const[t,n]=e.id.split("/");let r=parseInt(n,10);if(this._participantSequenceIdMap[e.userId]&&this._botParticipantId==t&&this._participantSequenceIdMap[e.userId]>r)return;this._botParticipantId=t,this._participantSequenceIdMap[e.userId]=r;const s=this._tsCall.participants.find((t=>t.id===e.userId))?.displayName||(this._internalCallAgent.getUserMri()===e.userId?this._internalCallAgent?.displayName:void 0),a={resultType:e.isFinal?"Final":"Partial",captionText:e.text,spokenText:e.originalText??e.text,timestamp:new Date(new Date(e.timestampAudioSent/1e4).getTime()+Jp),speaker:{identifier:sl(e.userId),displayName:s},spokenLanguage:e.spokenLanguage,captionLanguage:e.trackLanguage};if(this._currentLanguage!=e.spokenLanguage&&(this._currentLanguage=e.spokenLanguage,this._eventEmitter.emit("SpokenLanguageChanged")),!this.isCaptionsFeatureActive||this._mediaStreamSourceId!==i)return;this._hasReceivedFirstCaption||(this._hasReceivedFirstCaption=!0,this._sendCaptionsEvent(ng.FirstCaptionReceived,Zu.success,"",0)),this._eventEmitter.emit("CaptionsReceived",a)}catch(e){this._logger.error("Failed to parse Captions result",e),this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(ng.FirstCaptionParsingError,Zu.failure,"",0,ig.Unexpected,"Error thrown during incoming caption result mapping."))}}))}}},this._handleBotRemoved=e=>{this._acsMetadata&&this._isCaptionsBot(e)&&(this.isCaptionsFeatureActive&&(this._isCaptionsActive=!1,this._eventEmitter.emit("CaptionsActiveChanged")),this._acsMetadata=void 0,this._firstTimeActive=!1)},this._telemetryStartTime=Date.now()}get isCaptionsFeatureActive(){return!!this._acsMetadata&&this._isCaptionsEnabled(this._acsMetadata)&&this._isCaptionsActive}get supportedSpokenLanguages(){return this._ecsSpokenLanguages}get supportedCaptionLanguages(){return this._ecsCaptionLanguages}get captions(){return this._captions}get kind(){return this._name===wp.TeamsCaptions?"TeamsCaptions":"Captions"}get activeSpokenLanguage(){return this._currentLanguage}get activeCaptionLanguage(){return this._currentCaptionLanguage}get isTeamsConversationType(){return _c.indexOf(this._tsCall.conversationType)>-1}get isTeamsUserInCall(){for(let e of this._tsCall.participants)if("microsoftTeamsUser"===sl(e.id).kind)return!0;return!1}get isTeamsCallKind(){return this._call.kind===e.CallKind.TeamsCall}get isTeamsCaptionsBotInCall(){for(let e of this._tsCall.participants)if(e.id===yl().captions.teams.botMri)return!0;return!1}updateParticipantTranscriptionPrefsMetadata(e){let t;for(let e in this._tsCall.endpoints?.endpointDetails)if(this._tsCall.endpoints?.endpointDetails[e].participantId===this._tsCall.participantId){t=this._tsCall.endpoints?.endpointDetails[e];break}const i=t?.endpointMetadata??{transcriptionPrefs:{}};e?i.transcriptionPrefs?.closedCaptions?i.transcriptionPrefs.closedCaptions=e:i.transcriptionPrefs={closedCaptions:e}:i.transcriptionPrefs?.closedCaptions&&delete i.transcriptionPrefs.closedCaptions,this._tsCall.updateEndpointMetadata(JSON.stringify(i))}initialize(e,t,i,n,r,s,a,o){this._logger=s.createChild((()=>`CaptionsFeature::Call(id='${e.callId}', state='${e.state}')`)),this._tsCall=e,this._call=t,this._internalCallAgent=i,this._httpRequestHelper=n,this._telemetryLogManager=r,this._telemetryStartTime=a,this._isCteUser=i.isCteUser(),this._ecsCaptionsEnabled=yl().captions.enabled,this._name=this.isTeamsConversationType||this._isCteUser||this.isTeamsUserInCall||this.isTeamsCaptionsBotInCall||this.isTeamsCallKind?wp.TeamsCaptions:wp.Captions,this.updateCaptionsData(this._name),this._sendCaptionsEvent(ng.InitializeCaptions,Zu.initialize,o,this._telemetryStartTime),this._initializationPromise=new Promise(((e,t)=>{this._initializeAsync(o).then((t=>e())).catch((e=>t(e)))}))}async _initializeAsync(e){try{this._textDecoder=new TextDecoder,this._tsCall.on("participantAdded",(async t=>{if(this._captions&&"Captions"===this._captions.kind&&"microsoftTeamsUser"===sl(t.id).kind){if(this._captionsBotMri)try{await this._tsCall.removeParticipant(this._captionsBotMri)}catch(i){const n=new I({defaultError:{message:Up(i),code:t.callEndDiagnosticsInfo?.callControllerCode||0,subCode:t.callEndDiagnosticsInfo?.callControllerSubCode||0,resultCategories:t.callEndDiagnosticsInfo?.resultCategories||["UnexpectedClientError"]},originalError:i});this._sendCaptionsEvent(ng.CaptionsKindChanged,Zu.failure,e,this._telemetryStartTime,ig.Unexpected,n.message,n.code,n.subCode,jp(n))}this.updateCaptionsData(wp.TeamsCaptions),this._isCaptionsActive&&(this._currentLanguage&&this._ecsSpokenLanguages.includes(this._currentLanguage)?await this._captions.startCaptions({spokenLanguage:this._currentLanguage}):await this._captions.startCaptions()),this._eventEmitter.emit("CaptionsKindChanged"),this._sendCaptionsEvent(ng.CaptionsKindChanged,Zu.success,e,this._telemetryStartTime)}})),this._tsCall.on("participantAdded",(async e=>{this._isCaptionsBot(e)&&(this._acsMetadata||(this._acsMetadata=this._copyBotMetaData(e),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(e),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler)))})),this._tsCall.on("participantRemoved",(async e=>{this._isCaptionsBot(e)&&this._handleBotRemoved(e)})),this._tsCall.on("participantUpdated",(async e=>{this._getBotMetadata(e)&&this._isCaptionsBot(e)&&this._acsMetadata&&(this._acsMetadata=this._copyBotMetaData(e),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(e),!this._firstTimeActive&&this.isCaptionsFeatureActive&&(this._firstTimeActive=!0,this._eventEmitter.emit("CaptionsActiveChanged")))}));const t=this._tsCall.participants.find((e=>e.id===this._captionsBotMri));t&&(this._acsMetadata=this._copyBotMetaData(t),this._mediaStreamSourceId=t.getSourceIdForMediaType(3),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler))}catch(t){const i=new I({defaultError:f.FEATURES.CAPTIONS.INITIALIZE});throw this._sendCaptionsEvent(ng.InitializeCaptions,Zu.failure,e,this._telemetryStartTime,ig.Unexpected,i.message,i.code,i.subCode,jp(i)),this._logger.error(i.message),i}}updateCaptionsData(e){e===wp.Captions?(this._name=wp.Captions,this._captionsBotMri=yl().captions.acs.botMri,this._clientInfo=yl().captions.acs.clientInfo.ring,this._ecsSpokenLanguagesEnabled=yl().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=yl().captions.teams.spokenLanguages.languages,this._captions=new Yp(this,this._eventEmitter)):e===wp.TeamsCaptions&&(this._name=wp.TeamsCaptions,this._captionsBotMri=yl().captions.teams.botMri,this._clientInfo=yl().captions.teams.clientInfo.ring,this._ecsSpokenLanguagesEnabled=yl().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=yl().captions.teams.spokenLanguages.languages,this._ecsCaptionLanguagesEnabled=yl().captions.teams.captionLanguages.enabled,this._ecsCaptionLanguages=yl().captions.teams.captionLanguages.languages,this._ecsAmtPolicyUrlSuffix=yl().MiddleTier.policyUrlSuffixV2,this._captions=new Qp(this,this._eventEmitter))}async startCaptions(e){this._telemetryStartTime=+Date.now();const t=x(),i=e?.spokenLanguage||"en-us";if(this._sendFeatureUsage("startCaptions",Zu.attempt),this._sendCaptionsEvent(ng.StartCaptions,Zu.attempt,t,0),this._addParticipantPromise){const e=new I({defaultError:f.FEATURES.CAPTIONS.ALREADY_STARTING});return this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),void this._sendFeatureUsage("startCaptions",Zu.failure)}if(await this._initializationPromise,!this._ecsCaptionsEnabled){const e=new I({defaultError:f.FEATURES.CAPTIONS.DISABLED});return this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("startCaptions",Zu.failure),void this._logger.error("Feature is not enabled.")}if(!this._ecsSpokenLanguages.includes(i)){const e=new I({defaultError:f.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),this._logger.error("Spoken language requested is not supported."),e}if(this._name===wp.TeamsCaptions&&(this._mtPolicy=this._internalCallAgent.mtPolicyService,this._isCteUser)){try{this._mtPolicy.initialize({localParticipant:this._internalCallAgent.getUserMri(),skypeToken:await this._internalCallAgent.tokenProvider(),telemetryLogManager:this._telemetryLogManager}),await this._mtPolicy.fetchUserPoliciesFromAcsMiddleTier(this._tsCall.callId,this._tsCall.participantId,{policyUrlSuffix:this._ecsAmtPolicyUrlSuffix,userPolicies:["TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata"]}),this._mtCaptionsPolicyResult=JSON.parse(this._mtPolicy.getTeamsUserCaptionsPoliciesData())}catch(e){const i=new I({defaultError:f.FEATURES.CAPTIONS.CTE_POLICY_FETCH_FAIL,originalError:e});this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,i.message,i.code,i.subCode,jp(i)),this._logger.error("Unable to fetch policies")}if(this._mtCaptionsPolicyResult)if(this.isTeamsConversationType){if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForMeeting){const e=new I({defaultError:f.FEATURES.CAPTIONS.MEETING_POLICY_DISABLED});throw this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("startCaptions",Zu.failure),this._logger.error(e.message),e}}else if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForCalling){const e=new I({defaultError:f.FEATURES.CAPTIONS.CALLING_POLICY_DISABLED});throw this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("startCaptions",Zu.failure),this._logger.error(e.message),e}}if(this._acsMetadata){if(this._isCaptionsEnabled(this._acsMetadata))if(this._isCaptionsActive){const e=new I({defaultError:f.FEATURES.CAPTIONS.ALREADY_ACTIVE});this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("startCaptions",Zu.failure)}else this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(ng.StartCaptions,Zu.success,t,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Zu.success),this._eventEmitter.emit("CaptionsActiveChanged");else if("Captions"===this._captions.kind)if(this._isCaptionsActive){const e=new I({defaultError:f.FEATURES.CAPTIONS.ALREADY_ACTIVE});this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("startCaptions",Zu.failure)}else this._isCaptionsActive=!0,this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(ng.StartCaptions,Zu.success,t,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Zu.success),this._eventEmitter.emit("CaptionsActiveChanged")}else try{const e={participantInvitationData:{botData:{clientInfo:this._clientInfo,consumerType:"ACS",initiatorUserToken:this._name===wp.TeamsCaptions?"":await this._internalCallAgent.tokenProvider(),spokenLanguage:i,mode:Cc,transcriptionModes:[this._captionsModeKey]}}};this._addParticipantPromise=this._tsCall.addParticipant(this._captionsBotMri,e),await this._addParticipantPromise,this._addParticipantPromise=null,this._currentLanguage!==i&&(this._currentLanguage=i,this._eventEmitter.emit("SpokenLanguageChanged")),this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(ng.StartCaptions,Zu.success,t,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Zu.success)}catch(e){this._addParticipantPromise=null;const i=new I({defaultError:f.FEATURES.CAPTIONS.START_FAILED});throw this._sendCaptionsEvent(ng.StartCaptions,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,i.message,i.code,i.subCode,jp(i)),this._sendFeatureUsage("startCaptions",Zu.failure),this._logger.error(i.message),i}}async stopCaptions(){this._telemetryStartTime=+Date.now();const e=x();if(this._sendFeatureUsage("stopCaptions",Zu.attempt),this._sendCaptionsEvent(ng.StopCaptions,Zu.attempt,e,0),this.isCaptionsFeatureActive)this._isCaptionsActive=!1,this._sendCaptionsEvent(ng.StopCaptions,Zu.success,e,this._telemetryStartTime),this._sendFeatureUsage("stopCaptions",Zu.success),this._eventEmitter.emit("CaptionsActiveChanged"),"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata();else{const t=new I({defaultError:f.FEATURES.CAPTIONS.STOP_NOT_ACTIVE});this._sendCaptionsEvent(ng.StopCaptions,Zu.failure,e,this._telemetryStartTime,ig.Expected,t.message,t.code,t.subCode,jp(t)),this._logger.warn(t.message)}this._isCaptionsActive=!1}async setSpokenLanguage(e){this._telemetryStartTime=+Date.now();const t=x();if(this._sendFeatureUsage("setSpokenLanguage",Zu.attempt),this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.attempt,t,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),this._logger.error(e.message),e}if(!this._isCaptionsActive){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED});return this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),void this._logger.warn(e.message)}if(!this._ecsSpokenLanguagesEnabled){const e=new I({defaultError:f.FEATURES.CAPTIONS.SPOKEN_LANG_DISABLED});return this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),void this._logger.error(e.message)}if(e==this._currentLanguage){const e=new I({defaultError:f.FEATURES.CAPTIONS.SPOKEN_LANGUAGE_ALREADY_SET});return this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),void this._sendFeatureUsage("setSpokenLanguage",Zu.failure)}if(!this._ecsSpokenLanguages.includes(e)){const e=new I({defaultError:f.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),this._logger.error(e.message),e}try{const i=await this._internalCallAgent.tokenProvider();if(!i){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_LANGUAGE_GET_TOKEN});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,e.message,e.code,e.subCode,jp(e)),e}await this._sendSetLanguageRequest(e,"",i,this._acsMetadata.commandUrl),this._currentLanguage!==e&&(this._currentLanguage=e,this._eventEmitter.emit("SpokenLanguageChanged")),this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.success,t,this._telemetryStartTime),this._sendFeatureUsage("setSpokenLanguage",Zu.success)}catch(e){const i=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_LANGUAGE_FAILED,originalError:e});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,i.message,i.code,i.subCode,jp(i)),this._sendFeatureUsage("setSpokenLanguage",Zu.failure),this._logger.error(i.message),i}}async setCaptionLanguage(e){this._telemetryStartTime=+Date.now();const t=x();if(this._sendFeatureUsage("setCaptionLanguage",Zu.attempt),this._sendCaptionsEvent(ng.SetCaptionLanguage,Zu.attempt,t,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_STARTED});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),this._logger.error(e.message),e}if(!this._isCaptionsActive){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_ACTIVE});return this._sendCaptionsEvent(ng.SetCaptionLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),void this._logger.warn(e.message)}if(!this._ecsCaptionLanguagesEnabled){const e=new I({defaultError:f.FEATURES.CAPTIONS.CAPTIONS_LANG_DISABLED});return this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),void this._logger.error(e.message)}if(this._isTranslatedCaptionsAllowed||this._tsCall.meetingDetails?.meetingCapability&&this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions&&(this._isTranslatedCaptionsAllowed=this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions),!(this.isTeamsConversationType&&this._isTranslatedCaptionsAllowed||this._mtCaptionsPolicyResult?.isTeamsProMgmtSkuAvailable)){const e=new I({defaultError:f.FEATURES.CAPTIONS.CAPTIONS_LANG_TEAMS_LICENSE});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),this._logger.error(e.message),e}if(e==this._currentCaptionLanguage){const e=new I({defaultError:f.FEATURES.CAPTIONS.CAPTIONS_LANG_ALREADY_SET});return this._sendCaptionsEvent(ng.SetCaptionLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),void this._sendFeatureUsage("setCaptionLanguage",Zu.failure)}if(!this._ecsCaptionLanguages.includes(e)){const e=new I({defaultError:f.FEATURES.CAPTIONS.CAPTIONS_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Expected,e.message,e.code,e.subCode,jp(e)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),this._logger.error(e.message),e}try{const i=await this._internalCallAgent.tokenProvider();if(!i){const e=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_CAPTIONS_GET_TOKEN});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,e.message,e.code,e.subCode,jp(e)),e}await this._sendSetLanguageRequest("",e,i,this._acsMetadata.commandUrl),this._currentCaptionLanguage!==e&&(this._currentCaptionLanguage=e,this._eventEmitter.emit("CaptionLanguageChanged")),this._sendCaptionsEvent(ng.SetCaptionLanguage,Zu.success,t,this._telemetryStartTime),this._sendFeatureUsage("setCaptionLanguage",Zu.success)}catch(e){const i=new I({defaultError:f.FEATURES.CAPTIONS.UPDATE_CAPTIONS_FAILED,originalError:e});throw this._sendCaptionsEvent(ng.SetSpokenLanguage,Zu.failure,t,this._telemetryStartTime,ig.Unexpected,i.message,i.code,i.subCode,jp(i)),this._sendFeatureUsage("setCaptionLanguage",Zu.failure),this._logger.error(i.message),i}}dispose(){this._acsMetadata=void 0,this._textDecoder=void 0}_sendCaptionsEvent(e,t,i,n,r,s,a,o,c){let l={eventName:Xu.acs_calling_captions,callId:this._call.id,correlationId:i,isExpected:r??"",localParticipantId:this._call.tsCall.participantId,featureType:this._name,featureDetails:{step:e},kindOfEvent:t,timestampInfo:n?{deltaTimeInMs:+Date.now()-n}:"",additionalDetails:{failureReason:s,code:a,subCode:o,...c}};try{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_captions,tenant:uc,properties:l})}catch(e){this._logger.debug(`Unable to send ${this._name} feature usage telemtery`)}}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this._name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}async _sendSetLanguageRequest(e,t,i,n){const r=e?{type:yc,spokenLanguage:e}:{type:yc,subtitleLanguages:[t]},s={timestamp:(new Date).toISOString(),participantMri:this._internalCallAgent.getUserMri(),participantLegId:this._tsCall.participantId,action:yc,mode:Cc,actionParameters:r},a={headers:{"X-Microsoft-Skype-Chain-ID":this._tsCall.callId,Authorization:`Bearer ${i}`,"x-skypetoken":i},withCredentials:!0};return this._httpRequestHelper.sendRequestWithRetry("post",n,s,a,3)}}Wp([M(yp.StartCaptions),zp("design:type",Function),zp("design:paramtypes",[Object]),zp("design:returntype",Promise)],Xp.prototype,"startCaptions",null),Wp([M(yp.StopCaptions),zp("design:type",Function),zp("design:paramtypes",[]),zp("design:returntype",Promise)],Xp.prototype,"stopCaptions",null),Wp([M(yp.SetSpokenLanguage),zp("design:type",Function),zp("design:paramtypes",[String]),zp("design:returntype",Promise)],Xp.prototype,"setSpokenLanguage",null),Wp([M(yp.SetCaptionLanguage),zp("design:type",Function),zp("design:paramtypes",[String]),zp("design:returntype",Promise)],Xp.prototype,"setCaptionLanguage",null);class Zp{constructor(e){this.typeRankComparator=(e,t)=>void 0===e.publishedState?-1:void 0===t.publishedState?1:e.publishedState.typeRank-t.publishedState.typeRank,this._eventEmitter=e,this._currentRaiseHandStates=new Map}initialize(e,t,i,n){this._logger=n.createChild((()=>`RaiseHandFeature::Call(id='${e.callId}')`)),this._tsCall=e,this._telemetryLogManager=i,this._internalCallAgent=t,this._sendFeatureUsage("initialize",Zu.initialize);try{let e=e=>new Map(this.getPublishedState(e).sort(this.typeRankComparator).map((e=>[e.id,e])));this._tsCall.on("publishedStatesChanged",(async t=>{let i=e(t),n=this._currentRaiseHandStates;this._currentRaiseHandStates=i,this._currentRaiseHandStates.forEach(((e,t)=>{n.has(t)||this._eventEmitter.emit("raisedHandEvent",{identifier:sl(t)})})),n.forEach(((e,t)=>{this._currentRaiseHandStates.has(t)||this._eventEmitter.emit("loweredHandEvent",{identifier:sl(t)})}))})),this._tsCall.publishedStates&&(this._currentRaiseHandStates=e(this._tsCall.publishedStates)),this._sendFeatureUsage("initialize",Zu.success)}catch(e){throw this._logger.error("Could not initialize raise hand feature.",e),this._sendFeatureUsage("initialize",Zu.failure),new I({defaultError:f.FEATURES.RAISE_HAND.INITIALIZE,originalError:e})}}async raiseHand(){this._sendFeatureUsage("raiseHand",Zu.attempt);try{if(void 0!==this.getLocalRaiseHandState())return void this._sendFeatureUsage("raiseHand",Zu.failure);const e={level:"user",type:"raiseHands",content:"{}"};if(!await this._tsCall.publishState(e,m.generateCauseId()))throw new I({defaultError:f.FEATURES.RAISE_HAND.RAISE_HAND_PUBLISH_STATE});this._sendFeatureUsage("raiseHand",Zu.success)}catch(e){throw this._logger.error("Could not change a participant state. Code: ",e?.response?.status),this._sendFeatureUsage("raiseHand",Zu.failure),Gp(e,f.FEATURES.RAISE_HAND.RAISE_HAND_FAIL)}}async lowerHand(){this._sendFeatureUsage("lowerHand",Zu.attempt);try{const e=this.getLocalRaiseHandState();if(void 0===e)return void this._sendFeatureUsage("lowerHand",Zu.failure);const t={stateIds:[e]};await this._tsCall.removeState(t,m.generateCauseId()),this._sendFeatureUsage("lowerHand",Zu.success)}catch(e){throw this._logger.error("Could not change a participant state. Code: ",e?.response?.status),this._sendFeatureUsage("lowerHand",Zu.failure),Gp(e,f.FEATURES.RAISE_HAND.LOWER_HAND_FAIL)}}async lowerHands(e){this._sendFeatureUsage("lowerHands",Zu.attempt);try{if(0===e.length)return void this._sendFeatureUsage("lowerHands",Zu.failure);if(0===this._currentRaiseHandStates.size)return void this._sendFeatureUsage("lowerHands",Zu.failure);const t=e.map((e=>rl(e))),i=this.findStateIdsForParticipantIds(t);await this._tsCall.removeState({stateIds:i},m.generateCauseId()),this._sendFeatureUsage("lowerHands",Zu.success)}catch(e){throw this._logger.error("Could not change a participant state.",e),this._sendFeatureUsage("lowerHands",Zu.failure),Gp(e,f.FEATURES.RAISE_HAND.LOWER_REMOTEPARTICIPANTS_HANDS_FAIL)}}async lowerAllHands(){this._sendFeatureUsage("lowerAllHands",Zu.attempt);try{await this._tsCall.removeStatesForEveryone({type:"raiseHands"},m.generateCauseId()),this._sendFeatureUsage("lowerAllHands",Zu.success)}catch(e){throw this._logger.error("Could not change a participant state.",e),this._sendFeatureUsage("lowerAllHands",Zu.failure),Gp(e,f.FEATURES.RAISE_HAND.LOWER_ALL_HANDS_FAIL)}}get raisedHands(){return 0===this._currentRaiseHandStates.size?[]:Array.from(this._currentRaiseHandStates.keys()).map(((e,t)=>({identifier:sl(e),order:t+1})))}getLocalRaiseHandState(){const e=this.findStateIdsForParticipantIds([this._internalCallAgent.getUserMri()]);if(e&&e.length>0)return e[0]}findStateIdsForParticipantIds(e){return e&&0!==this._currentRaiseHandStates.size?Array.from(this._currentRaiseHandStates.entries()).filter((t=>e.includes(t[0]))).map((e=>e[1]?.publishedState?.stateId)).filter((e=>!!e)):[]}getPublishedState(e){return e.typeStates.filter((e=>"raiseHands"===e.type)).map((e=>e.participantStates)).flat()}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}}var em;!function(e){e.turnVideoOn="turnVideoOn",e.unmuteMic="unmuteMic",e.shareScreen="shareScreen",e.removeParticipant="removeParticipant",e.hangUpForEveryOne="hangUpForEveryOne",e.addCommunicationUser="addCommunicationUser",e.addTeamsUser="addTeamsUser",e.addPhoneNumber="addPhoneNumber",e.manageLobby="manageLobby",e.spotlightParticipant="spotlightParticipant",e.removeParticipantsSpotlight="removeParticipantsSpotlight",e.blurBackground="blurBackground",e.startLiveCaptions="startLiveCaptions",e.stopLiveCaptions="stopLiveCaptions",e.raiseHand="raiseHand",e.pstnDialOut="pstnDialOut",e.muteOthers="muteOthers",e.useReactions="useReactions",e.viewAttendeeNames="viewAttendeeNames"}(em||(em={}));class tm{constructor(e){this._logger=e,this._ecsConfig=yl()}getResolvedCapabilitiesBasedOnRole(e,t){let i={...t},n=e.toLocaleLowerCase();return n!==Wc.Attendee.toLocaleLowerCase()&&n!==Wc.Presenter.toLocaleLowerCase()&&n!==Wc.Consumer.toLocaleLowerCase()&&n!==Wc.Organizer.toLocaleLowerCase()||(this._ecsConfig[Yc][n][em.turnVideoOn]?i.turnVideoOn={isPresent:this._ecsConfig[Yc][n][em.turnVideoOn],reason:Kc.Capable}:i.turnVideoOn={isPresent:this._ecsConfig[Yc][n][em.turnVideoOn],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.unmuteMic]?i.unmuteMic={isPresent:this._ecsConfig[Yc][n][em.unmuteMic],reason:Kc.Capable}:i.unmuteMic={isPresent:this._ecsConfig[Yc][n][em.unmuteMic],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.shareScreen]?i.shareScreen={isPresent:this._ecsConfig[Yc][n][em.shareScreen],reason:Kc.Capable}:i.shareScreen={isPresent:this._ecsConfig[Yc][n][em.shareScreen],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.removeParticipant]?i.removeParticipant={isPresent:this._ecsConfig[Yc][n][em.removeParticipant],reason:Kc.Capable}:i.removeParticipant={isPresent:this._ecsConfig[Yc][n][em.removeParticipant],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.muteOthers]?i.muteOthers={isPresent:this._ecsConfig[Yc][n][em.muteOthers],reason:Kc.Capable}:i.muteOthers={isPresent:this._ecsConfig[Yc][n][em.muteOthers],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.pstnDialOut]?i.pstnDialOut={isPresent:this._ecsConfig[Yc][n][em.pstnDialOut],reason:Kc.Capable}:i.pstnDialOut={isPresent:this._ecsConfig[Yc][n][em.pstnDialOut],reason:Kc.RoleRestricted},this._ecsConfig[Yc][n][em.addPhoneNumber]?i.addPhoneNumber={isPresent:this._ecsConfig[Yc][n][em.addPhoneNumber],reason:Kc.Capable}:i.addPhoneNumber={isPresent:this._ecsConfig[Yc][n][em.addPhoneNumber],reason:Kc.RoleRestricted}),i.removeParticipant={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.hangUpForEveryOne={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.addCommunicationUser={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.addTeamsUser={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.manageLobby={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.spotlightParticipant={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.removeParticipantsSpotlight={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.blurBackground={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.startLiveCaptions={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.stopLiveCaptions={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.raiseHand={isPresent:!1,reason:Kc.CapabilityNotApplicableForTheCallType},i.useReactions={isPresent:!0,reason:Kc.Capable},i.viewAttendeeNames={isPresent:!0,reason:Kc.Capable},this._logger.log(`Capabilities resolved to : ${JSON.stringify(i)} on role change to ${e}`),i}}class im{constructor(e){this._logger=e,this._ecsConfig=yl()}getResolvedCapabilitiesBasedOnRole(e,t){let i={...t},n=e.toLocaleLowerCase();return n!==Wc.Attendee.toLocaleLowerCase()&&n!==Wc.Presenter.toLocaleLowerCase()&&n!==Wc.Consumer.toLocaleLowerCase()&&n!==Wc.Organizer.toLocaleLowerCase()&&n!==Wc.Coorganizer.toLocaleLowerCase()||(n=n.replace("-",""),t.turnVideoOn.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.turnVideoOn]?i.turnVideoOn={isPresent:!0,reason:Kc.Capable}:i.turnVideoOn={isPresent:!1,reason:Kc.RoleRestricted}),t.unmuteMic.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.unmuteMic]?i.unmuteMic={isPresent:!0,reason:Kc.Capable}:i.unmuteMic={isPresent:!1,reason:Kc.RoleRestricted}),t.shareScreen.reason!=Kc.UserPolicyRestricted&&(this._ecsConfig[Qc][n][em.shareScreen]?i.shareScreen={isPresent:!0,reason:Kc.Capable}:i.shareScreen={isPresent:!1,reason:Kc.RoleRestricted}),this._ecsConfig[Qc][n][em.removeParticipant]?i.removeParticipant={isPresent:!0,reason:Kc.Capable}:i.removeParticipant={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.hangUpForEveryOne]?i.hangUpForEveryOne={isPresent:!0,reason:Kc.Capable}:i.hangUpForEveryOne={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.addCommunicationUser]?i.addCommunicationUser={isPresent:!0,reason:Kc.Capable}:i.addCommunicationUser={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.addTeamsUser]?i.addTeamsUser={isPresent:!0,reason:Kc.Capable}:i.addTeamsUser={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.addPhoneNumber]?i.addPhoneNumber={isPresent:!0,reason:Kc.Capable}:i.addPhoneNumber={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.manageLobby]?i.manageLobby={isPresent:!0,reason:Kc.Capable}:i.manageLobby={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.spotlightParticipant]?i.spotlightParticipant={isPresent:!0,reason:Kc.Capable}:i.spotlightParticipant={isPresent:!1,reason:Kc.RoleRestricted},this._ecsConfig[Qc][n][em.removeParticipantsSpotlight]?i.removeParticipantsSpotlight={isPresent:!0,reason:Kc.Capable}:i.removeParticipantsSpotlight={isPresent:!1,reason:Kc.RoleRestricted},t.blurBackground.reason!=Kc.UserPolicyRestricted&&(this._ecsConfig[Qc][n][em.blurBackground]?i.blurBackground={isPresent:!0,reason:Kc.Capable}:i.blurBackground={isPresent:!1,reason:Kc.RoleRestricted}),t.startLiveCaptions.reason!=Kc.UserPolicyRestricted&&(this._ecsConfig[Qc][n][em.startLiveCaptions]?i.startLiveCaptions={isPresent:!0,reason:Kc.Capable}:i.startLiveCaptions={isPresent:!1,reason:Kc.RoleRestricted}),t.stopLiveCaptions.reason!=Kc.UserPolicyRestricted&&(this._ecsConfig[Qc][n][em.stopLiveCaptions]?i.stopLiveCaptions={isPresent:!0,reason:Kc.Capable}:i.stopLiveCaptions={isPresent:!1,reason:Kc.RoleRestricted}),t.raiseHand.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.raiseHand]?i.raiseHand={isPresent:!0,reason:Kc.Capable}:i.raiseHand={isPresent:!1,reason:Kc.RoleRestricted}),t.pstnDialOut.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.pstnDialOut]?i.pstnDialOut={isPresent:!0,reason:Kc.Capable}:i.pstnDialOut={isPresent:!1,reason:Kc.RoleRestricted}),t.muteOthers.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.muteOthers]?i.muteOthers={isPresent:!0,reason:Kc.Capable}:i.muteOthers={isPresent:!1,reason:Kc.RoleRestricted}),t.useReactions.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.useReactions]?i.useReactions={isPresent:!0,reason:Kc.Capable}:i.useReactions={isPresent:!1,reason:Kc.RoleRestricted}),t.viewAttendeeNames.reason!=Kc.MeetingRestricted&&(this._ecsConfig[Qc][n][em.viewAttendeeNames]?i.viewAttendeeNames={isPresent:!0,reason:Kc.Capable}:i.viewAttendeeNames={isPresent:!1,reason:Kc.RoleRestricted})),this._logger.log(`Capabilities resolved to : ${JSON.stringify(i)} on role change to ${e}`),i}getResolvedCapabilitiesBasedOnMeetingCapabilities(e,t){let i={...t};return null!=e.attendeeRestrictions&&("DisableVideo"!=e.attendeeRestrictions&&"DisableAv"!=e.attendeeRestrictions?i.turnVideoOn={isPresent:!0,reason:Kc.Capable}:i.turnVideoOn={isPresent:!1,reason:Kc.MeetingRestricted}),null!=e.attendeeRestrictions&&("DisableAv"!=e.attendeeRestrictions?i.unmuteMic={isPresent:!0,reason:Kc.Capable}:i.unmuteMic={isPresent:!1,reason:Kc.MeetingRestricted}),null!=e.allowRaiseHands&&(e.allowRaiseHands?i.raiseHand={isPresent:!0,reason:Kc.Capable}:i.raiseHand={isPresent:!1,reason:Kc.MeetingRestricted}),null!=e.allowPstnConferencing&&(e.allowPstnConferencing?i.pstnDialOut={isPresent:!0,reason:Kc.Capable}:i.pstnDialOut={isPresent:!1,reason:Kc.MeetingRestricted}),null!=e.allowTeamsMeetingReactions&&(e.allowTeamsMeetingReactions?i.useReactions={isPresent:!0,reason:Kc.Capable}:i.useReactions={isPresent:!1,reason:Kc.MeetingRestricted}),null!=e.maskIdentitiesForRole&&(e.maskIdentitiesForRole?i.viewAttendeeNames={isPresent:!1,reason:Kc.MeetingRestricted}:i.viewAttendeeNames={isPresent:!0,reason:Kc.Capable}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(i)} on meeting details change to ${e}`),i}getResolvedCapabilitiesBasedOnUserPolicy(e,t){let i={...t};return null!=e.teamsMeetingPolicy?.screenSharingMode&&("Disabled"==e.teamsMeetingPolicy?.screenSharingMode?i.shareScreen={isPresent:!1,reason:Kc.UserPolicyRestricted}:i.shareScreen={isPresent:!0,reason:Kc.Capable}),null!=e.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==e.teamsMeetingPolicy?.liveCaptionsEnabledType?i.startLiveCaptions={isPresent:!1,reason:Kc.UserPolicyRestricted}:i.startLiveCaptions={isPresent:!0,reason:Kc.Capable}),null!=e.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==e.teamsMeetingPolicy?.liveCaptionsEnabledType?i.stopLiveCaptions={isPresent:!1,reason:Kc.UserPolicyRestricted}:i.stopLiveCaptions={isPresent:!0,reason:Kc.Capable}),null!=e.teamsMeetingPolicy?.videoFiltersMode&&("NoFilters"==e.teamsMeetingPolicy?.videoFiltersMode?i.blurBackground={isPresent:!1,reason:Kc.UserPolicyRestricted}:i.blurBackground={isPresent:!0,reason:Kc.Capable}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(i)} on user policy update to ${e}`),i}}class nm{constructor(e,t,i,n,r,s){this._eventEmitter=e,this._logger=t,this._callInfo=n,this._tsCall=s,this._call=i,this._callAgent=r,this._capabilities=this.initializeCapabilities(),("roomJoin"==this._callInfo.context||"teamsMeetingJoin"==this._callInfo.context)&&this.doInitialCapabilityResolutionBasedOnRole(),"teamsMeetingJoin"==this._callInfo.context&&this.doInitialCapabilityResolutionBasedOnUserPolicy(),"teamsMeetingJoin"==this._callInfo.context&&this.doInitialCapabilityResolutionBasedOnMeetingCapabilities()}initializeCapabilities(){return this._logger.info("initializing capabilities"),"roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context?{turnVideoOn:{isPresent:!1,reason:Kc.FeatureNotSupported},unmuteMic:{isPresent:!1,reason:Kc.FeatureNotSupported},shareScreen:{isPresent:!1,reason:Kc.FeatureNotSupported},removeParticipant:{isPresent:!1,reason:Kc.FeatureNotSupported},hangUpForEveryOne:{isPresent:!1,reason:Kc.FeatureNotSupported},addCommunicationUser:{isPresent:!1,reason:Kc.FeatureNotSupported},addTeamsUser:{isPresent:!1,reason:Kc.FeatureNotSupported},addPhoneNumber:{isPresent:!1,reason:Kc.FeatureNotSupported},manageLobby:{isPresent:!1,reason:Kc.FeatureNotSupported},spotlightParticipant:{isPresent:!1,reason:Kc.FeatureNotSupported},removeParticipantsSpotlight:{isPresent:!1,reason:Kc.FeatureNotSupported},blurBackground:{isPresent:!1,reason:Kc.FeatureNotSupported},startLiveCaptions:{isPresent:!1,reason:Kc.FeatureNotSupported},stopLiveCaptions:{isPresent:!1,reason:Kc.FeatureNotSupported},raiseHand:{isPresent:!1,reason:Kc.FeatureNotSupported},pstnDialOut:{isPresent:!1,reason:Kc.FeatureNotSupported},muteOthers:{isPresent:!1,reason:Kc.FeatureNotSupported},useReactions:{isPresent:!1,reason:Kc.FeatureNotSupported},viewAttendeeNames:{isPresent:!1,reason:Kc.FeatureNotSupported}}:{turnVideoOn:{isPresent:!1,reason:Kc.NotInitialized},unmuteMic:{isPresent:!1,reason:Kc.NotInitialized},shareScreen:{isPresent:!1,reason:Kc.NotInitialized},removeParticipant:{isPresent:!1,reason:Kc.NotInitialized},hangUpForEveryOne:{isPresent:!1,reason:Kc.NotInitialized},addCommunicationUser:{isPresent:!1,reason:Kc.NotInitialized},addTeamsUser:{isPresent:!1,reason:Kc.NotInitialized},addPhoneNumber:{isPresent:!1,reason:Kc.NotInitialized},manageLobby:{isPresent:!1,reason:Kc.NotInitialized},spotlightParticipant:{isPresent:!1,reason:Kc.NotInitialized},removeParticipantsSpotlight:{isPresent:!1,reason:Kc.NotInitialized},blurBackground:{isPresent:!1,reason:Kc.NotInitialized},startLiveCaptions:{isPresent:!1,reason:Kc.NotInitialized},stopLiveCaptions:{isPresent:!1,reason:Kc.NotInitialized},raiseHand:{isPresent:!1,reason:Kc.NotInitialized},pstnDialOut:{isPresent:!1,reason:Kc.NotInitialized},muteOthers:{isPresent:!1,reason:Kc.NotInitialized},useReactions:{isPresent:!1,reason:Kc.NotInitialized},viewAttendeeNames:{isPresent:!1,reason:Kc.NotInitialized}}}doInitialCapabilityResolutionBasedOnRole(){this.resolveCapabilitiesBasedOnRole()}doInitialCapabilityResolutionBasedOnUserPolicy(){this.getCapabilityResolver()instanceof im&&"roomJoin"!=this._callInfo.context&&this.resolveCapabilitiesBasedOnUserPolicy()}doInitialCapabilityResolutionBasedOnMeetingCapabilities(){this.resolveCapabilitiesBasedOnMeetingCapabilities()}getCapabilityResolver(){return this._callInfo.context?.match("roomJoin")?new tm(this._logger):(this._callInfo.context?.match("teamsMeetingJoin"),new im(this._logger))}getCapabilities(){return this._capabilities}resolveCapabilitiesBasedOnRole(){if("roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context)return;let e=this._call.role;e==Wc.Unknown&&(e="roomJoin"==this._callInfo.context?Wc.Consumer:Wc.Attendee);let t=this.getCapabilityResolver();if(t){let i=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=t.getResolvedCapabilitiesBasedOnRole(e,this._capabilities),!p.isEqual(i,this._capabilities)){const t=this.getChangedCapabilitiesInfo(i,this._capabilities,"RoleChanged");this._logger.info(`Capabilities has changed based on role update to ${e}, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(t)}`),this._eventEmitter.emit("capabilitiesChanged",t)}}}resolveCapabilitiesBasedOnMeetingCapabilities(){if("teamsMeetingJoin"!=this._callInfo.context)return;let e={};e={...this._tsCall.meetingDetails?.capabilities,...this._tsCall.meetingDetails?.meetingCapability};let t=this.getCapabilityResolver();if(t&&t){const i=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=t.getResolvedCapabilitiesBasedOnMeetingCapabilities(e,this._capabilities),!p.isEqual(i,this._capabilities)){const e=this.getChangedCapabilitiesInfo(i,this._capabilities,"MeetingOptionOrOrganizerPolicyChanged");this._logger.info(`Capabilities has changed due to meeting capabilities, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(e)}`),this._eventEmitter.emit("capabilitiesChanged",e)}}}resolveCapabilitiesBasedOnUserPolicy(){if("teamsMeetingJoin"!=this._callInfo.context)return;let e=this._callAgent.getUserPolicy(),t=this.getCapabilityResolver();if(t&&t&&e){let i=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=t.getResolvedCapabilitiesBasedOnUserPolicy(e,this._capabilities),!p.isEqual(i,this._capabilities)){const e=this.getChangedCapabilitiesInfo(i,this._capabilities,"UserPolicyChanged");this._logger.info(`Capabilities has changed due to user policy, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(e)}`),this._eventEmitter.emit("capabilitiesChanged",e)}}}getChangedCapabilitiesInfo(e,t,i){let n={},r={};return Object.keys(e).forEach((i=>{e[i].isPresent!=t[i].isPresent&&(n[i]=e[i],r[i]=t[i])})),{oldValue:n,newValue:r,reason:i}}}class rm{constructor(e){this._eventEmitter=e}get capabilities(){return this._capabilityResolver.getCapabilities()}initialize(e,t,i,n,r,s){this._logger=s.createChild((()=>`CapabilitiesFeature::Call(id='${e.callId}')`)),this._tsCall=e,this._call=i,this._callInfo=n,this._internalCallAgent=t,this._timeToInitialize=new Date,this._capabilityResolver=new nm(this._eventEmitter,this._logger,this._call,this._callInfo,this._internalCallAgent,this._tsCall),this._call.on("roleChanged",(()=>{this._capabilityResolver.resolveCapabilitiesBasedOnRole();let e=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after role set is "+e)})),this._call.onMeetingCapabilitiesChanged("meetingCapabilitiesChanged",(()=>{this._capabilityResolver.resolveCapabilitiesBasedOnMeetingCapabilities();let e=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after meeting set up is"+e)}))}}var sm,am,om=function(e){var t=typeof e;if("string"===t||"number"===t)return function(e,t){var i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";t=t||62;var n,r=[],s="",a=e<0?"-":"";for(e=Math.abs(e);e>=t;)n=e%t,e=Math.floor(e/t),r.push(i[n]);e>0&&r.push(i[e]);for(var o=r.length-1;o>=0;o--)s+=r[o];return a+s}(function(e){var t=0;if(0==e.length)return t;for(var i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t&=t;return t}(String(e)),61).replace("-","Z");throw new Error("Unexpected input type")};!function(e){e.ping="ping",e.pong="pong"}(sm||(sm={}));class cm{get diagnosticInformation(){return this._sdkDiagnosticInformation}get logDump(){return this._logger.log("Log dump requested"),this._logger.dumpAllLogs()}get AcsResourceId(){return this._callAgent?.getAcsResourceId()}get lastLocalParticipantId(){return this._lastLocalParticipantId}get localParticipantIdMap(){return this._localParticipantIdMap}get incommingCallIdMap(){return this._incommingCallIdMap}get clientId(){return this._callAgent?.getClientId()}constructor(){this._localParticipantIdMap={},this._incommingCallIdMap={}}initialize(e,t){this._logger=t,this._callAgent=e?.callClient?.callAgent,this._sdkDiagnosticInformation=e?.callClient.sdkDiagnosticInformation,this._logger.info("waiting for call agent to be created");e?.callClient.on("callAgentCreated",(()=>{this._callAgent=e?.callClient.callAgent,this.subscribeToCallAgentEvents()}))}dispose(){}subscribeToCallAgentEvents(){try{this._callAgent?.on("callsUpdated",(e=>{[...e.added,...e.removed].forEach((e=>{this.updateLocalParticipantIdMap(e),e.on("idChanged",(()=>{this.updateLocalParticipantIdMap(e)}))}))})),this._callAgent?.on("incomingCall",(e=>{let t=e.incomingCall;t.on("callEnded",(e=>{try{this._incommingCallIdMap[t.id]=JSON.stringify(e.callEndReason)}catch(e){this._incommingCallIdMap[t.id]="callEnd reason unknown"}}));try{this._incommingCallIdMap[t.id]=JSON.stringify(e.incomingCall.callerInfo.identifier?.kind)}catch(e){this._incommingCallIdMap[t.id]="identifier kind unknown"}}))}catch(e){this._logger.info("failed to subscribe to call agent events, due to non initialized call agent")}}updateLocalParticipantIdMap(e){try{let t=this._localParticipantIdMap[e.tsCall.participantId]?.callIds.filter((t=>t!==e.tsCall.callId)).concat([e.tsCall.callId])??[e.tsCall.callId],i=[],n=[],r=e.callEndReason?JSON.stringify(e.callEndReason):e.state,s=e.state;this._localParticipantIdMap[e.tsCall.participantId]?.callEndReasons?(this._localParticipantIdMap[e.tsCall.participantId].callEndReasons.slice(-1)[0]!==r?(this._localParticipantIdMap[e.tsCall.participantId].callEndReasons.push(r),i=this._localParticipantIdMap[e.tsCall.participantId].callEndReasons):i=this._localParticipantIdMap[e.tsCall.participantId].callEndReasons,this._localParticipantIdMap[e.tsCall.participantId].stateTransitions.slice(-1)[0]!==s?(this._localParticipantIdMap[e.tsCall.participantId].stateTransitions.push(s),n=this._localParticipantIdMap[e.tsCall.participantId].stateTransitions):n=this._localParticipantIdMap[e.tsCall.participantId].stateTransitions):(i=[r],n=[e.state]),this._localParticipantIdMap[e.tsCall.participantId]={callIds:t,callEndReasons:i,stateTransitions:n},this._logger.info(`localParticipantIdMap: ${JSON.stringify(this._localParticipantIdMap)}`),e.on("stateChanged",(()=>{"Connected"===e.state&&(this._lastLocalParticipantId=e.tsCall.participantId,this._logger.info(`last patricipant id: ${this._lastLocalParticipantId}`)),this._localParticipantIdMap[e.tsCall.participantId].stateTransitions.slice(-1)[0]!==e.state&&this.localParticipantIdMap[e.tsCall.participantId].stateTransitions.push(e.state)}))}catch(e){this._logger.error(`exception occured while updating localParticipantId map: ${e}`)}}}class lm{get isCallClientActiveInAnotherTab(){return this._isCallClientActiveInAnotherTab}get isAnotherCallClientActiveInSameTab(){return this._isAnotherCallClientActiveInSameTab}constructor(e){this._eventEmitter=e,this._tabGroupId=lm.tabId,this._isCallClientActiveInAnotherTab=!1,this._isAnotherCallClientActiveInSameTab=!1,this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._isTabFirstLoadFlag=!0,this._intervalId=void 0,this._timeoutId=void 0,this._channel=new BroadcastChannel(yl().debugInfo.broadcastChannelName)}initialize(e,t,i){this._callClient=e,this._logger=t,this._telemetryLogManager=i;const n=yl().debugInfo.tabsBroadcastDelay,r=yl().debugInfo.tabsUpdateDelay;this.tabsCheck(),this._channel.postMessage({action:sm.ping,tabId:lm.tabId,groupId:this._tabGroupId}),this._timeoutId=setTimeout((()=>{this._areThereMultipleTabs&&(this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs),this._manyCallClientInSameTab&&(this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab),this.sendTabUpdateEvent(),this._isTabFirstLoadFlag=!1}),10),this._intervalId=setInterval((()=>{this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._channel.postMessage({action:sm.ping,tabId:lm.tabId,groupId:this._tabGroupId}),setTimeout((()=>{null===this._areThereMultipleTabs&&(this._areThereMultipleTabs=!1),null===this._manyCallClientInSameTab&&(this._manyCallClientInSameTab=!1),this.tabsUpdate()}),r)}),n)}tabsCheck(){this._channel.addEventListener("message",(e=>{e.data?.action!==sm.ping&&e.data?.action!==sm.pong||(e.data?.action===sm.ping&&(lm.tabId===e.data.tabId?this._manyCallClientInSameTab=!0:lm.tabId!==e.data.tabId&&(this._areThereMultipleTabs=!0),this._channel.postMessage({action:sm.pong,tabId:lm.tabId,groupId:this._tabGroupId})),e.data?.action===sm.pong&&(lm.tabId===e.data.tabId?this._manyCallClientInSameTab=!0:lm.tabId!==e.data.tabId&&(this._areThereMultipleTabs=!0),this._tabGroupId!==e.data.groupId&&(this._tabGroupId=e.data.groupId)),this.tabsUpdate())}))}sendTabUpdateToCallEvent(){this._callClient.callAgent?._calls?.forEach((e=>e?.stats?.recordEvent({name:Qu.sdk_active_in_another_tab,callId:e.id,localParticipantId:e.tsCall.participantId,data:{tabId:lm.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab}})))}sendTabUpdateEvent(){const e={tabId:lm.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_tab_events,tenant:uc,properties:e})}tabsUpdate(){this._isTabFirstLoadFlag||null===this._manyCallClientInSameTab||null===this._areThereMultipleTabs||this._isCallClientActiveInAnotherTab===this._areThereMultipleTabs&&this._isAnotherCallClientActiveInSameTab===this._manyCallClientInSameTab||(this._isAnotherCallClientActiveInSameTab!==this._manyCallClientInSameTab&&(this._logger.log(`isAnotherCallClientActiveInSameTab changed from ${this._isAnotherCallClientActiveInSameTab} to ${this._manyCallClientInSameTab}`),this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab,this._eventEmitter.emit("isAnotherCallClientActiveInSameTabChanged")),this._isCallClientActiveInAnotherTab!==this._areThereMultipleTabs&&(this._logger.log(`isCallClientActiveInAnotherTab changed from ${this._isCallClientActiveInAnotherTab} to ${this._areThereMultipleTabs}`),this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs,this._eventEmitter.emit("isCallClientActiveInAnotherTabChanged")),this.sendTabUpdateEvent(),this.sendTabUpdateToCallEvent())}dispose(){this._channel.close(),void 0!==this._timeoutId&&clearTimeout(this._timeoutId),void 0!==this._intervalId&&clearInterval(this._intervalId)}}lm.tabId=x(),(am=e.DiagnosticQuality||(e.DiagnosticQuality={}))[am.Good=1]="Good",am[am.Poor=2]="Poor",am[am.Bad=3]="Bad";const dm="networkReconnect",hm="networkReceiveQuality",um="networkSendQuality",gm="networkRelaysNotReachable",pm="noNetwork",mm="noSpeakerDevicesEnumerated",fm="noMicrophoneDevicesEnumerated",Sm="microphoneNotFunctioning",vm="microphoneMuteUnexpectedly",ym="cameraStoppedUnexpectedly",Cm="capturerStoppedUnexpectedly",_m="speakingWhileMicrophoneIsMuted",Em="cameraFreeze",Tm="cameraStartFailed",Im="capturerStartFailed",bm="cameraStartTimedOut",Am="screenshareRecordingDisabled",Rm="microphonePermissionDenied",wm="cameraPermissionDenied";class Pm{get network(){return this._network}get media(){return this._media}constructor(){}initialize(e,t){this._network=new Dm(e,t),this._media=new Om(e,t)}dispose(){}}class Mm{constructor(t,i){this.logger=i,this._tsUfdUnknownValue=0,this.tsQualityToAcsQualityMap={1:e.DiagnosticQuality.Good,2:e.DiagnosticQuality.Poor,3:e.DiagnosticQuality.Bad},this.tssQualityToAcsBooleanMap={3:!0,1:!1},this._tsCall=t.tsCall,this.eventEmitter=new ep.EventEmitter,this._tsCall.on("callQualityChanged",(t=>{try{const i=this.mapTSQualityEventType(t.type,t.mediaType);if(i){if(t.value===this._tsUfdUnknownValue)return;const n=i,r=this.mapTSQualityLevel(i,t.value);let s;if("number"!=typeof r||r!==e.DiagnosticQuality.Good&&r!==e.DiagnosticQuality.Poor&&r!==e.DiagnosticQuality.Bad){if("boolean"!=typeof r)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.INCORRECT_VALUETYPE_MAPPED,defaultErrorMessageArgs:[typeof r,r,n]});s="DiagnosticFlag"}else s="DiagnosticQuality";let a={diagnostic:n,value:r,valueType:s};this.logger.log(`Call diagnostic changed, diagnostic='${a.diagnostic}', value='${a.value}'`);const o="DiagnosticFlag"===a.valueType&&!0===a.value,c="DiagnosticQuality"===a.valueType&&(a.value===e.DiagnosticQuality.Bad||a.value===e.DiagnosticQuality.Poor);(o||c)&&this.logger.warn(`Call diagnostic error raised!, diagnostic='${a.diagnostic}', value='${a.value}', value type='${a.valueType}'`),this.eventEmitter.emit("diagnosticChanged",a)}}catch(e){this.logger.error(`${e?.message})`)}}))}}class Dm extends Mm{constructor(e,t){super(e,t.createChild((()=>`[UserFacingDiagnosticsFeature:NetworkDiagnostics:Call(id='${e.tsCall.callId}', state='${e.tsCall.state}')]`))),this.latestNetworkDiagnostics=new Map}on(e,t){if("diagnosticChanged"!==e)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("diagnosticChanged"!==e&&"diagnosticFlagChanged"!==e)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}getLatest(){try{return Al(this.latestNetworkDiagnostics)}catch(e){return this.logger.error("Failed to get latest network diagnostics"),{}}}mapTSQualityEventType(e){return{5:dm,2:hm,1:um,32:gm,37:pm}[e]}mapTSQualityLevel(e,t){let i,n;switch(e){case dm:case hm:case um:n="DiagnosticQuality",i=this.tsQualityToAcsQualityMap[t];break;case gm:case pm:n="DiagnosticFlag",i=this.tssQualityToAcsBooleanMap[t]}if(void 0===i)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED,defaultErrorMessageArgs:[t,e]});return this.latestNetworkDiagnostics.set(e,{value:i,valueType:n}),i}}class Om extends Mm{constructor(e,t){super(e,t.createChild((()=>`[UserFacingDiagnosticsFeature:MediaDiagnostics:Call(id='${e.tsCall.callId}', state='${e.tsCall.state}')]`))),this.latestMediaDiagnostics=new Map}on(e,t){if("diagnosticChanged"!==e)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("diagnosticChanged"!==e&&"diagnosticFlagChanged"!==e)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}getLatest(){try{return Al(this.latestMediaDiagnostics)}catch(e){return this.logger.error("Failed to get latest media diagnostics"),{}}}mapTSQualityEventType(e,t){const i={44:mm,43:fm,9:Sm,25:vm,27:_m,45:Em,33:Tm,34:bm,55:Am,26:Rm,47:wm};return this.overrideQualityEventsForMediaType(i[e],t)}overrideQualityEventsForMediaType(e,t){if(e===vm)switch(t){case 1:return ym;case 2:return Cm}return e===Tm&&2===t?Im:e}mapTSQualityLevel(e,t){let i,n;switch(e){case mm:case fm:case Sm:case vm:case _m:case Em:case Tm:case bm:case Am:case Rm:case wm:case ym:case Cm:case Im:n="DiagnosticFlag",i=this.tssQualityToAcsBooleanMap[t]}if(void 0===i)throw new I({defaultError:f.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED,defaultErrorMessageArgs:[t,e]});return this.latestMediaDiagnostics.set(e,{value:i,valueType:n}),i}}class km{constructor(e){this._eventEmitter=e,this.localDominantList=[]}initialize(e,t,i,n,r=!1){this._logger=n.createChild((()=>`DominantSpeakersFeature${r?"Internal":""}::Call(id='${e.callId}')`)),this._tsCall=e,this.localDominantList=this._tsCall.dominantSpeakerInfo?.speakerList||[],this._tsCallChangedListener=this._tsCall.changed((()=>{let e=!1;if(this.localDominantList.length!=this._tsCall.dominantSpeakerInfo.speakerList.length)e=!0;else for(let t in this._tsCall.dominantSpeakerInfo.speakerList)if(this._tsCall.dominantSpeakerInfo.speakerList[t]!==this.localDominantList[t]){e=!0;break}e&&(this._logger.info("Dominant speakers list change detected"),this.localDominantList=this._tsCall.dominantSpeakerInfo.speakerList,this._eventEmitter.emit("dominantSpeakersChanged"))}))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}get dominantSpeakers(){let e=Array();return this._tsCall.dominantSpeakerInfo.speakerList.map((t=>{e.push(sl(t))})),{speakersList:e,timestamp:this._tsCall.dominantSpeakerInfo.timestamp||new Date}}dispose(){this._eventEmitter.removeAllListeners(),this._tsCallChangedListener?.dispose()}}class Nm extends ep.EventEmitter{constructor(e,t){super(),this._options={enableLogOn:!0,enableLogOff:!0,enableLogOnce:!0,enableLogEmit:!0},this._logger=e.createChild("CallingEventEmitter"),t&&(this._options=t)}on(e,t){return!1!==this._options.enableLogOn&&this._logger.info(`event:subscribe to ${e.toString()}`),super.on(e,t)}once(e,t){return!1!==this._options.enableLogOnce&&this._logger.info(`event:subscribe once to ${e.toString()}`),super.once(e,t)}off(e,t){return!1!==this._options.enableLogOff&&this._logger.info(`event:unsubscribed ${e.toString()}`),super.off(e,t)}emit(e,...t){try{return!1!==this._options.enableLogEmit&&this._logger.info(`event:emit ${e.toString()}`),super.emit(e,...t)}catch(t){return this._logger.warn(`Application threw an error while it handled the ${e.toString()} event`),!1}}}function Lm(){return{audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}}}function xm(e){let t=e.length>0?e[0]:0;return e.forEach((e=>{e>t&&(t=e)})),t}function Um(e){let t=e.length>0?e[0]:0;return e.forEach((e=>{e<t&&(t=e)})),t}function Fm(e){let t=0,i=0;return e.forEach((e=>{const n=e-i,r=t+n;i=r-t-n,t=r})),t}const Vm=Lm;class Bm{constructor(e){this._metricsProperties=e,this._originalValues={},this._aggregateValues={},this._events=[],this._currentValues={}}addStats(e,t){const i=this._metricsProperties[e];if(void 0!==i&&!0!==i.skip){if(i.events){const n=i.output_key??e;t!==this._currentValues[n]&&(this._currentValues[n]=t,this._events.push({name:n,value:t,timestamp:Date.now()}))}else{let i=this._originalValues[e];void 0===i&&(i={raw:[],beginTime:Date.now()},this._originalValues[e]=i),i.raw.push(t)}return t}}aggregate(){for(const[e,t]of Object.entries(this._originalValues)){const i=this._metricsProperties[e],n=i.output_key??e;let r=this._aggregateValues[n];void 0===r&&(r={raw:[],timestamp:new Date(t.beginTime)},i.aggregable&&(r.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[n]=r);const s=t.raw;let a=s;if(i.aggregable&&r.aggregation){const e=s.filter((e=>"number"==typeof e&&!isNaN(e)));r.aggregation.count.push(e.length),r.aggregation.sum.push(Fm(e)),r.aggregation.max.push(xm(e)),r.aggregation.min.push(Um(e)),a=e}i.raw_data_reduction&&a.length>0&&(r.reduced=r.reduced||[],r.reduced.push(a[a.length-1])),a.forEach((e=>r.raw.push(e)))}this._originalValues={}}popAggregates(){const e=this._aggregateValues;return this._aggregateValues={},e}popEvents(){const e=this._events;return this._events=[],e}}class Hm{constructor(e,t){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=Vm(),this._isActive=!1,t.aggregationInterval<1)throw new Error("invalid aggregationInterval value range");if(t.dataPointsPerAggregation<1)throw new Error("invalid dataPointsPerAggregation value range");this._metricsProperties=t.metricsPropertics,this._logger=e.createChild("TelemetryCollector"),this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1}),this._callStateChanged=Nu(),this._aggregationInterval=t.aggregationInterval,this._dataPointsPerAggregation=t.dataPointsPerAggregation,this._run()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(e){this._mediaStatsSource=e}onReport(e){this._processMediaStatsReport(e)}onAdded(e){this._isActive!==e&&(this._isActive=e,this._callStateChanged.resolve(e))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(e){try{const t=[[e.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send,"send"],[e.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive,"recv"],[e.video.send,this._calculators.video.send,this._metricsProperties.video.send,"send"],[e.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive,"recv"],[e.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send,"send"],[e.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive,"recv"],[e.dataChannel,this._calculators.dataChannel,this._metricsProperties.dataChannel,""],[e.transports,this._calculators.transports,this._metricsProperties.transports,""]];for(const[i,n,r,s]of t){const t=[],a=Object.keys(n);Object.keys(i).forEach((a=>{const o=i[a],c=o.id;t.push(c),void 0===n[c]&&(n[c]=new Bm(r));const l=(e,t)=>n[c].addStats(e,t);if(Object.keys(o).forEach((e=>l(e,o[e]))),"send"==s||"recv"==s){const t=o.transportId;if(void 0!==t){const i=e.transports[t];void 0!==i.rtt&&l("pairRttInMs",i.rttInMs),void 0!==i.availableIncomingBitrate&&"recv"==s&&l("availableBitrate",i.availableIncomingBitrate),void 0!==i.availableOutgoingBitrate&&"send"==s&&l("availableBitrate",i.availableOutgoingBitrate)}}})),a.filter((e=>!t.includes(e))).forEach((e=>{delete n[e]}))}}catch(e){this._logger.error(e)}}async _run(){let e=0;const t=()=>{if(0===e)return;const t={audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}},i=[[t.audio.send,this._calculators.audio.send],[t.audio.receive,this._calculators.audio.receive],[t.video.send,this._calculators.video.send],[t.video.receive,this._calculators.video.receive],[t.screenShare.send,this._calculators.screenShare.send],[t.screenShare.receive,this._calculators.screenShare.receive],[t.dataChannel,this._calculators.dataChannel],[t.transports,this._calculators.transports]];for(const[e,t]of i)for(const[i,n]of Object.entries(t))e[i]={id:i,...n.popAggregates(),events:n.popEvents()};this._eventEmitter.emit("data",t),e=0};let i=1e3*this._aggregationInterval;for(;!this._disposed;){const n=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.dataChannel];if(this._isActive){i>0&&await Fu((()=>this._callStateChanged.promise),i).catch((e=>{}));const r=Date.now();for(const e of n)for(const[,t]of Object.entries(e))t.aggregate();e++,e===this._dataPointsPerAggregation&&t();const s=Date.now();i=r+1e3*this._aggregationInterval-s}else t(),this._calculators=Vm(),await this._callStateChanged.promise.catch((e=>{})),i=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=Nu())}t()}}function $m(e){const t=[];return e.sort(((e,t)=>e.id>t.id?1:e.id<t.id?-1:0)),e.forEach((e=>{const i=/^([^.]+)\.?([^.]+)?$/.exec(e.id);if(i&&i[2]){e.id=p.toString(i[2]);const n=p.toString(i[1]);if(t.length>0&&t[t.length-1].id===n){const i=t[t.length-1].altLayouts??[];i.push(e),t[t.length-1].altLayouts=i}else t.push(e)}else t.push(e)})),t}class Gm{constructor(e,t){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=Vm(),this._isActive=!1,t.aggregationInterval<1)throw new I({defaultError:f.FEATURES.MEDIA_STATS.INVALID_AGGREGATION_INTERVAL_RANGE});if(t.dataPointsPerAggregation<1)throw new I({defaultError:f.FEATURES.MEDIA_STATS.INVALID_DATAPOINTS_AGGREGATION_RANGE});this._metricsProperties=t.metricsPropertics,this._logger=e.createChild("MediaStatsCollector"),this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1}),this._callStateChanged=Nu(),this._aggregationInterval=t.aggregationInterval,this._dataPointsPerAggregation=t.dataPointsPerAggregation,this._run()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(e){this._mediaStatsSource=e}onReport(e){this._processMediaStatsReport(e)}onAdded(e){this._isActive!==e&&(this._isActive=e,this._callStateChanged.resolve(e))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(e){const t={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};try{const i=[[e.audio.send,t.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send],[e.audio.receive,t.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive],[e.video.send,t.video.send,this._calculators.video.send,this._metricsProperties.video.send],[e.video.receive,t.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive],[e.screenShare.send,t.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send],[e.screenShare.receive,t.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive],[e.transports,t.transports,this._calculators.transports,this._metricsProperties.transports]];let n=!1;for(const[e,t,r,s]of i){const i=[],a=Object.keys(r);Object.keys(e).forEach((a=>{const o=e[a];let c=o.id;o.groupId&&(c=`${o.groupId}.${c}`,n=!0);const l={id:c};i.push(c),void 0===r[c]&&(r[c]=new Bm(s)),Object.keys(o).forEach((e=>{const t=s[e];if(t&&!0!==t.skip){const i=r[c].addStats(e,o[e]),n=t.output_key??e;l[n]=i}})),t.push(l)})),a.filter((e=>!i.includes(e))).forEach((e=>{delete r[e]}))}n&&(t.video.send=$m(t.video.send),t.screenShare.send=$m(t.screenShare.send))}catch(e){this._logger.error(e)}this._eventEmitter.emit("sampleReported",t)}async _run(){let e=0;const t=()=>{if(0===e)return;const t={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};for(const[e,i]of Object.entries(this._calculators.audio.send))t.audio.send.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.audio.receive))t.audio.receive.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.video.send))t.video.send.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.video.receive))t.video.receive.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.screenShare.send))t.screenShare.send.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.screenShare.receive))t.screenShare.receive.push({id:e,...i.popAggregates()});for(const[e,i]of Object.entries(this._calculators.transports))t.transports.push({id:e,...i.popAggregates()});t.video.send=$m(t.video.send),t.screenShare.send=$m(t.screenShare.send),this._eventEmitter.emit("summaryReported",t),e=0};let i=1e3*this._aggregationInterval;for(;!this._disposed;){const n=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.transports];if(this._isActive){i>0&&await Fu((()=>this._callStateChanged.promise),i).catch((e=>{}));const r=Date.now();for(const e of n)for(const[,t]of Object.entries(e))t.aggregate();e++,e===this._dataPointsPerAggregation&&t();const s=Date.now();i=r+1e3*this._aggregationInterval-s}else t(),this._calculators=Vm(),await this._callStateChanged.promise.catch((e=>{})),i=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=Nu())}t()}}class jm{constructor(){this._eventEmitter=new ep.EventEmitter,this._getCurrentTime=globalThis.performance&&"function"==typeof globalThis.performance.now?()=>globalThis.performance.now():()=>Date.now()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._eventEmitter.removeAllListeners()}}class qm extends jm{constructor(e){super(),this._intervalInMs=e,this._handle=0}start(){this._handle||(this._handle=globalThis.setInterval((()=>{this._eventEmitter.emit("tick")}),this._intervalInMs))}stop(){this._handle&&(globalThis.clearInterval(this._handle),this._handle=0)}dispose(){this.stop(),super.dispose()}}class Wm extends jm{constructor(e){super(),this._intervalInMs=e,this._callQueue=Promise.resolve(),this._state={isRunning:!1}}start(){if(this._state.isRunning)return;const e={isRunning:!0};this._state=e;const t=async()=>{for(;e.isRunning;){const e=this._getCurrentTime();this._eventEmitter.emit("tick");const t=this._getCurrentTime()-e;t<this._intervalInMs&&await Lu(this._intervalInMs-t)}};this._callQueue=this._callQueue.then((()=>t())).catch((()=>{}))}stop(){this._state.isRunning&&(this._state.isRunning=!1)}dispose(){this._state.isRunning=!1,super.dispose()}}class zm{static createTicker(e,t){if("interval"===e)return new qm(t);if("timeout"===e)return new Wm(t);throw new Error(`Invalid tickerType: ${e}`)}}class Jm{constructor(e,t,i,n){this._tsCall=e,this._logger=t,this._dataEventRefCount=0,this._lastFetchTime=0,this._timerDelayRatio=0,this._pendingStats=!1,this._fetchInterval=i,this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1});const r=1e3*i;this._ticker=zm.createTicker(n,r),this._ticker.on("tick",(()=>{const e=Date.now();this._lastFetchTime>0&&(this._timerDelayRatio=(e-this._lastFetchTime)/r),this._lastFetchTime=e,this._dataEventRefCount>0&&!1===this._pendingStats&&(this._pendingStats=!0,this.getStats().then((e=>{e&&this._eventEmitter.emit("data",e)})).catch((e=>{this._logger.error(e)})).finally((()=>{this._pendingStats=!1})))}));const s=()=>{[10,3].includes(this._tsCall.state)?this._start():this._stop()};this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{s()})),s()}dispose(){this._callStateChangedHandle.dispose(),this._ticker.dispose()}get fetchInterval(){return this._fetchInterval}get timerDelayRatio(){return this._timerDelayRatio}_start(){this._lastFetchTime=0,this._timerDelayRatio=0,this._ticker.start()}_stop(){this._ticker.stop()}on(e,t){this._dataEventRefCount++,this._eventEmitter.on(e,t)}off(e,t){this._dataEventRefCount--,this._eventEmitter.off(e,t)}}class Km extends Jm{constructor(e,t,i){super(e,t.createChild("MediaStatsPoller"),i.fetchInterval,i.pollingMethod)}async getStats(){return{report:this._tsCall.getMediaSessionStats(),delayRatio:this.timerDelayRatio}}}var Ym;!function(e){e[e.Running=0]="Running",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped"}(Ym||(Ym={}));class Qm{constructor(){this._sinks=[],this._transformers=[],this._state=Ym.Running}_setTransformers(e){this._transformers=e.slice()}addSink(e){e.source=this,this._sinks.push(e),e.onAdded(this._state===Ym.Running)}removeSink(e){e.source===this&&(p.pull(this._sinks,e),e.source=void 0,e.onRemoved())}removeAllSinks(){const e=this._sinks;this._sinks=[],e.forEach((e=>{e.source=void 0,e.onRemoved()}))}send(e){if(this._state!==Ym.Running)return;let t=e;this._transformers.length&&(t=this._transformers.reduce(((e,t)=>t.transform(e)),e)),this._sinks.forEach((e=>e.onReport(t)))}pause(){this._state===Ym.Running&&(this._state=Ym.Paused,this._sinks.forEach((e=>e.pause())))}resume(){this._state===Ym.Paused&&(this._state=Ym.Running,this._sinks.forEach((e=>e.resume())))}stop(){this._state!==Ym.Stopped&&this._sinks.forEach((e=>e.stop()))}}class Xm extends Qm{constructor(e){super(),this._setTransformers(e)}onReport(e){if(void 0===e.report)return;const t={audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}};t.metadata=t.metadata??{},t.metadata.delayRatio=e.delayRatio;const i=[[e.report.audio.send,t.audio.send],[e.report.audio.recv,t.audio.receive],[e.report.video.send,t.video.send],[e.report.video.recv,t.video.receive],[e.report.screenShare.send,t.screenShare.send],[e.report.screenShare.recv,t.screenShare.receive],[e.report.data,t.dataChannel],[e.report.transports,t.transports]],n=e=>{const t={};return Object.entries(e).forEach((e=>{const i=e[0],n=e[1];"altLayouts"!==i&&null!=n&&(t[i]=n)})),t};i.forEach((e=>{const t=e[0];if(void 0!==t){const i=e[1];t.forEach((e=>{const t=p.toString(e.id);i[t]=n(e),void 0!==e.altLayouts&&e.altLayouts.forEach((e=>{const r=e.id,s=n(e);s.groupId=t,i[r]=s}))}))}})),this.send(t)}}class Zm extends Qm{constructor(e){super(),this._setTransformers(e)}onAdded(e){}onRemoved(){}onReport(e){this.send(e)}get source(){return this._mediaStatsSource}set source(e){this._mediaStatsSource=e}}class ef{constructor(e){this._tsCall=e,this._activeParticipantMris=new Set,this._sourceIdToParticipantInfo=new Map,this._listenerHandles=[],this._config=yl(),this._listenerHandles.push(this._tsCall.on("participantAdded",(e=>{this._activeParticipantMris.add(e.id),this._updateMapping(e)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(e=>{this._activeParticipantMris.has(e.id)&&this._updateMapping(e)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(e=>{this._activeParticipantMris.delete(e.id),this._removeMapping(e)}))),this._tsCall.participants?.forEach((e=>{this._activeParticipantMris.add(e.id),this._updateMapping(e)}))}_updateMapping(e){const t=e.id,i=[],n=this._config.calling.composedStreamBotIds;e.endpoints?.endpointDetails?.forEach((e=>{e.mediaStreams?.forEach((r=>{i.push(r.sourceId),this._sourceIdToParticipantInfo.set(r.sourceId,{mri:t,participantId:e.participantId,isComposedStream:n.includes(t)})}))}))}_removeMapping(e){e.endpoints?.endpointDetails?.forEach((e=>{e.mediaStreams?.forEach((e=>{this._sourceIdToParticipantInfo.delete(e.sourceId)}))}))}findParticipantInfo(e){let t=this._sourceIdToParticipantInfo.get(e);if(void 0===t&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const e=this._tsCall.participants[0],i=e.endpoints?.endpointDetails[0];t={mri:e.id,participantId:i?.participantId??"",isComposedStream:!1}}return t}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._sourceIdToParticipantInfo.clear(),this._listenerHandles.forEach((e=>e.dispose()))}}class tf{constructor(e,t,i,n){this._tsCall=e,this._call=t,this._telemetryLogManager=i,this._config=n,this._participantMappingManager=new ef(this._tsCall)}dispose(){this._participantMappingManager.dispose()}log(e){const t=this._config.telemetry.mediaStatsConfig;[{type:"audio",direction:"send",value:e.audio.send},{type:"audio",direction:"recv",value:e.audio.receive},{type:"video",direction:"send",value:e.video.send},{type:"video",direction:"recv",value:e.video.receive},{type:"screen",direction:"send",value:e.screenShare.send},{type:"screen",direction:"recv",value:e.screenShare.receive},{type:"data",direction:"",value:e.dataChannel},{type:"transport",direction:"",value:e.transports}].forEach((e=>{const i=Object.values(e.value);i.forEach((n=>{const r={id:n.id},s={id:n.id};Object.keys(n).forEach((e=>{const i=e;if("id"===e)return;if("events"===e){const e=n[i];return void(e.length>0&&(r.events=JSON.stringify(e)))}const a=n[i];if(t.dataToSend.raw){const e={};a?.timestamp&&(e.timestamp=a?.timestamp),t.dataToSend.raw&&(e.raw=a?.raw),s[i]=e}const o={};void 0!==a.aggregation?(a.timestamp&&(o.timestamp=a.timestamp),t.dataToSend.min&&(o.min=a.aggregation.min),t.dataToSend.max&&(o.max=a.aggregation.max),t.dataToSend.sum&&(o.sum=a.aggregation.sum),t.dataToSend.count&&(o.count=a.aggregation.count)):(a.timestamp&&(o.timestamp=a.timestamp),a.reduced?o.raw=a.reduced:a.raw&&(o.raw=a.raw)),r[i]=o}));let a="",o="";if(("video"===e.type||"screen"===e.type)&&"recv"===e.direction){const e=n;if(void 0!==e.streamId&&e.streamId.raw?.length){const t=e.streamId.raw[0],i=this._participantMappingManager.findParticipantInfo(t);a=i?.participantId??"",o=i?.isComposedStream?"ComposedVideoStream":"RemoteVideoStream"}}if(Object.keys(r).length>1){const t={mediaType:e.type,mediaDirection:e.direction,stats:r,callId:this._tsCall.callId,remoteParticipantId:a,localParticipantId:this._tsCall.participantId,videoStreamKind:o,streamCount:i.length,appliedFrameHeightMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameHeight?.max,appliedBitrateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.bitrate?.max,appliedFrameRateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameRate?.max,audioEffectsProcessorStats:this._call.audioEffectsProcessorStats??void 0};this._sendMidCallNewMediaStats(t)}if(t.dataToSend.raw&&Object.keys(s).length>1){const t={mediaType:e.type,mediaDirection:e.direction,stats:s,callId:this._tsCall.callId,remoteParticipantId:a,localParticipantId:this._tsCall.participantId,videoStreamKind:o,streamCount:i.length};this._sendMidCallRawMediaStats(t)}}))}))}_sendMidCallNewMediaStats(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_mid_call_new_media_stats,tenant:uc,properties:e})}_sendMidCallRawMediaStats(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_mid_call_raw_media_stats,tenant:uc,properties:e})}}function nf(e){return{transform:t=>([[t.audio.send,e.audio.send],[t.audio.receive,e.audio.receive],[t.video.send,e.video.send],[t.video.receive,e.video.receive],[t.screenShare.send,e.screenShare.send],[t.screenShare.receive,e.screenShare.receive],[t.dataChannel,e.dataChannel],[t.transports,e.transports]].forEach((e=>{const t=e[0],i=e[1];p.forEach(i,((e,i)=>{!0!==e.disabled&&p.forEach(t,(t=>{let n=t[e.source];void 0!==n&&(void 0!==e.multiplier&&"number"==typeof n&&(n*=e.multiplier),e.integer&&(n=p.toInteger(n)),t[i]=n)}))}))})),t)}}function rf(e){const t=["audio.send","audio.receive","video.send","video.receive","screenShare.send","screenShare.receive","dataChannel","transports"];return{transform:i=>(p.forEach(t,(t=>{const n=p.get(i,t),r=p.get(e,t,[]);p.forEach(n,(e=>{r.forEach((t=>{"id"!==t&&delete e[t]}))}))})),i)}}const sf={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},frameRateInput:{aggregable:!0},frameWidthInput:{aggregable:!0},frameHeightInput:{aggregable:!0},framesEncoded:{},frameRateEncoded:{aggregable:!0},framesSent:{},frameRateSent:{aggregable:!0},frameWidthSent:{aggregable:!0},frameHeightSent:{aggregable:!0},keyFramesEncoded:{},transportId:{}},af={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},streamId:{},jitterBufferDelayInMs:{aggregable:!0},frameRateDecoded:{aggregable:!0},frameRateReceived:{aggregable:!0},frameWidthReceived:{aggregable:!0},frameHeightReceived:{aggregable:!0},longestFreezeDurationInMs:{},totalFreezeDurationInMs:{},framesReceived:{},framesDropped:{},framesDecoded:{},keyFramesDecoded:{},transportId:{}},of={audio:{send:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},audioInputLevel:{aggregable:!0},transportId:{}},receive:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},jitterBufferDelayInMs:{aggregable:!0},audioOutputLevel:{aggregable:!0},healedRatio:{aggregable:!0},transportId:{}}},video:{send:sf,receive:af},screenShare:{send:sf,receive:af},dataChannel:{incomingBitrate:{aggregable:!0},outgoingBitrate:{aggregable:!0},messagesSentPerSecond:{aggregable:!0},messagesReceivedPerSecond:{aggregable:!0}},transports:{rttInMs:{aggregable:!0},availableIncomingBitrate:{aggregable:!0},availableOutgoingBitrate:{aggregable:!0}}},cf={codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},framesEncoded:{raw_data_reduction:!0},framesSent:{raw_data_reduction:!0},keyFramesEncoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0},groupId:{raw_data_reduction:!0}},lf={codecName:{raw_data_reduction:!0},streamId:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},longestFreezeDurationInMs:{skip:!0},totalFreezeDurationInMs:{raw_data_reduction:!0},framesReceived:{raw_data_reduction:!0},framesDropped:{raw_data_reduction:!0},framesDecoded:{raw_data_reduction:!0},keyFramesDecoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},df={audio:{send:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},receive:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}}},video:{send:cf,receive:lf},screenShare:{send:cf,receive:lf},dataChannel:{state:{raw_data_reduction:!0},dataChannelIdentifier:{raw_data_reduction:!0},messagesSent:{raw_data_reduction:!0},bytesSent:{raw_data_reduction:!0},messagesReceived:{raw_data_reduction:!0},bytesReceived:{raw_data_reduction:!0}},transports:{candidateType:{events:!0},relayProtocol:{events:!0}}},hf={multiplier:1e3,integer:!0,source:"jitter"},uf={multiplier:1e3,integer:!0,source:"rtt"},gf={integer:!0,source:"jitterBufferMs"},pf={jitterInMs:hf,rttInMs:uf},mf={jitterInMs:hf,rttInMs:uf,jitterBufferDelayInMs:gf,streamId:{source:"msi"},longestFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"longestFreezeDuration"},totalFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"totalFreezeDuration"}},ff={audio:{send:{jitterInMs:hf,rttInMs:uf,audioInputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}},receive:{jitterInMs:hf,rttInMs:uf,jitterBufferDelayInMs:gf,audioOutputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}}},video:{send:pf,receive:mf},screenShare:{send:pf,receive:mf},dataChannel:{incomingBitrate:{source:"recvBitrate"},outgoingBitrate:{source:"sendBitrate"}},transports:{rttInMs:uf}};class Sf{constructor(e,t,i,n){this._tsCall=e,this._call=t,this._logger=i,this._disposed=!1;const r=yl();this._config=r.mediaStats,this._statsPoller=new Km(this._tsCall,this._logger,this._config);const s=[nf(p.merge(p.cloneDeep(ff),this._config.transformMetrics))];this._config.timerThrottlingFilter.enabled&&s.push(function(e,t){return{transform:i=>{const n=i.metadata?.delayRatio,r=e>0&&void 0!==n&&n>e;return p.forEach(t,((e,t)=>{const n=p.get(i,t);p.forEach(n,(t=>{p.forEach(e,((e,i)=>{if(r)delete t[i];else{const n=t[i];(void 0!==e.max&&n>e.max||void 0!==e.min&&n<e.min||p.isNaN(n))&&delete t[i]}}))}))})),i}}}(this._config.timerThrottlingFilter.delayRatio,this._config.timerThrottlingFilter.filterRange)),this._mediaStatsSourceNode=new Xm(s);const a=[3,10];this._isCallActive=a.includes(this._tsCall.state),this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{const e=a.includes(this._tsCall.state);this._isCallActive!==e&&(this._isCallActive=e,e?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause())}));const o=this._config.blockMetrics;if(Object.keys(o).length>0){const e=new Zm([{transform:e=>p.cloneDeep(e)},rf(o)]);this._mediaStatsSourceNode.addSink(e),this._collectorsSourceNode=e}else this._collectorsSourceNode=this._mediaStatsSourceNode;const c=r.telemetry.mediaStatsConfig;if(c.enabled){const e=new tf(this._tsCall,this._call,n,r),t=p.merge(p.cloneDeep(of),df,c.metricsProperties),i=new Hm(this._logger,{aggregationInterval:c.aggregationInterval,dataPointsPerAggregation:c.dataPointsPerAggregation,metricsPropertics:t});i.on("data",(t=>e.log(t))),this._mediaStatsSourceNode.addSink(i)}this._isCallActive?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause(),this._dataEventListener=e=>{this._mediaStatsSourceNode.onReport(e)},this._statsPoller.on("data",this._dataEventListener)}createCollector(e){if(this._disposed)throw new I({defaultError:f.FEATURES.MEDIA_STATS.DISPOSED});const t=this._config,i=new Gm(this._logger,{aggregationInterval:e?.aggregationInterval??t.aggregationInterval,dataPointsPerAggregation:e?.dataPointsPerAggregation??t.dataPointsPerAggregation,metricsPropertics:of});return this._collectorsSourceNode.addSink(i),i}dispose(){this._disposed||(this._disposed=!0,this._statsPoller.off("data",this._dataEventListener),this._mediaStatsSourceNode.stop(),this._callStateChangedHandle.dispose())}}class vf extends Cp{constructor(e){super(e)}get name(){return this._sendFeatureUsage("name",Zu.getter),"MediaStats"}createCollector(e){this._sendFeatureUsage("createCollector",Zu.attempt);const t=this._statsManager.createCollector(e);return this._sendFeatureUsage("creaetCollector",Zu.success),t}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._statsManager=new Sf(e.tsCall,this._call,this._logger,this._telemetryLogManager),this._sendFeatureUsage("initialize",Zu.initialize)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"MediaStats",featureType:"Call",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._statsManager.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}var yf,Cf;(yf=e.RecordingState||(e.RecordingState={}))[yf.None=0]="None",yf[yf.Started=1]="Started",yf[yf.Paused=2]="Paused",yf[yf.Ended=3]="Ended";class _f{constructor(e){this._eventEmitter=e,this._recordingBots=new Map,this._recordingBotChangedSubs=new WeakMap,this._recordingInitiatorMap=new Map,this._isRecordingActive=!1,this._updateIsCallRecorded=e=>this._isRecordingActive!==e&&(this._isRecordingActive=e,this._logger.info(`Updating isCallRecorded to ${e}`),!0),this._handleRecordingBotAdded=e=>{const t=()=>{let t,i=!1,n=!1;if(this._hasRecordingState(e)){if(this._recordingBots.has(e.id)){let i=this._getRecordingBotEndpoint(e);if(t=this._recordingBots.get(e.id),i&&t){t.endpoint=i;let e=i.userId?this._recordingInitiatorMap.get(i.userId):void 0;n=t.recordingInfo?.update(i,e)??!1}}else t=this._getRecordingBotInfo(e),t&&(this._logger.info("Adding recording bot"),this._recordingBots.set(e.id,t),i=!0);this._sendEvents(n?[t]:void 0,i?[t]:void 0,void 0,this._updateIsCallRecorded(this._isRecordingEnabled()))}};t(),this._recordingBotChangedSubs.set(e,e.changed(t))},this._handleRecordingBotRemoved=e=>{let t=this._recordingBots.get(e.id);this._recordingBots.delete(e.id),this._recordingBotChangedSubs.get(e)?.dispose(),this._recordingBotChangedSubs.delete(e),this._logger.info(`Updating recordingState to ${t?.endpoint?.state}`),t?.recordingInfo?.dispose(),this._sendEvents([t],void 0,[t],this._updateIsCallRecorded(this._isRecordingEnabled()))},this._sendEvents=(e,t,i,n)=>{e&&e.forEach((e=>e?.recordingInfo?.sendRecordingStateChanged()));let r=!!t&&t.length>0,s=!!i&&i.length>0;(r||s)&&this._eventEmitter.emit("recordingsUpdated",{added:this._getRecordingInfos(t),removed:this._getRecordingInfos(i)}),n&&this._eventEmitter.emit("isRecordingActiveChanged")},this._hasRecordingState=e=>e?.endpoints?.endpointDetails?.some((e=>!!e?.endpointMetadata?.__platform?.recording?.compliance?.state||!!e?.endpointMetadata?.processingModes?.recording?.state))??!1,this._getRecordingInfos=e=>{if(e)return e.map((e=>e?.recordingInfo)).filter((e=>!!e))},this._isRecordingEnabled=()=>{let e=!1;try{this._recordingBots.forEach((t=>{e||(e="Active"===t?.endpoint?.state)}))}catch(e){this._logger.info("Unable to read recording state: ",e)}return e},this._getRecordingInfoImpl=e=>{if(null==e)return;if("Active"!==e.state&&"Inactive"!==e.state)return;let t;return void 0!==e.userId&&(t=this._recordingInitiatorMap.get(e.userId)),new Ef(e.state,this._eventEmitter,t)},this._getRecordingBotInfo=e=>{let t=this._getRecordingBotEndpoint(e);return t?{endpoint:t,recordingInfo:this._getRecordingInfoImpl(t)}:void 0},this._getRecordingBotEndpoint=e=>{let t=e.endpoints?.endpointDetails.map((e=>{let t=e?.endpointMetadata?.__platform?.recording?.compliance?.state,i=e?.endpointMetadata?.__platform?.recording?.compliance?.userId,n=e?.endpointMetadata?.processingModes?.recording?.state,r=e?.endpointMetadata?.processingModes?.recording?.userId;if(t||n)return{state:t??n,userId:i??r}})).filter((e=>null!=e));if(t&&0!=t.length)return t.length>1&&this._logger.log(`Unexpected: multiple recording endpoints: ${t?.map((e=>e?.state??"undefined")).join(", ")}`),t[0]}}get isRecordingActive(){return this._isRecordingActive}get recordings(){return Array.from(this._recordingBots.values()).map((e=>e?.recordingInfo)).filter((e=>!!e))}initialize(e,t,i){this._logger=i.createChild((()=>`RecordingFeature::Call(id='${e.callId}', state='${e.state}')`)),e.on("callStateChanged",(async()=>{3===e.state&&this._initInitiatorMap(e)})),e.on("participantAdded",(async e=>{al(e.id)?this._handleRecordingBotAdded(e):void 0===e||this._recordingInitiatorMap.has(e.id)||this._recordingInitiatorMap.set(e.id,e.displayName)})),e.on("participantRemoved",(async e=>{al(e.id)?this._handleRecordingBotRemoved(e):void 0!==e&&this._recordingInitiatorMap.has(e.id)&&this._recordingInitiatorMap.delete(e.id)})),e.on("participantUpdated",(async e=>{void 0!==e&&this._recordingInitiatorMap.has(e.id)&&this._recordingInitiatorMap.set(e.id,e.displayName)}))}dispose(){let e=this._updateIsCallRecorded(!1),t=Array.from(this._recordingBots.values());t.forEach((e=>e?.recordingInfo?.dispose())),this._sendEvents(void 0,void 0,t,e)}_initInitiatorMap(e){const{participants:t}=e;[...t].forEach((e=>{al(e.id)||this._recordingInitiatorMap.set(e.id,e.displayName)}))}}class Ef{constructor(e,t,i){this.state=this.getRecordingState(e),this._eventEmitter=t,this.displayName=i}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}update(e,t){if(null==e)return!1;let i=this.getRecordingState(e.state);return i!=this.state&&(this.state=i,void 0!==t&&(this.displayName=t),!0)}dispose(){this.state=e.RecordingState.Ended}sendRecordingStateChanged(){this._eventEmitter.emit("recordingStateChanged")}getRecordingState(t){let i=e.RecordingState.None;switch(t?.toLocaleLowerCase()){case"active":i=e.RecordingState.Started;break;case"inactive":i=e.RecordingState.Paused;break;default:i=e.RecordingState.None}return i}}(Cf=e.LocalRecordingState||(e.LocalRecordingState={}))[Cf.None=0]="None",Cf[Cf.Started=1]="Started",Cf[Cf.Ended=2]="Ended";const Tf="active",If="inactive";class bf{constructor(e){this._eventEmitter=e,this._localRecordingInitiators=new Map,this._sendEvents=(e,t,i)=>{let n=!!e&&e.length>0,r=!!t&&t.length>0;(n||r)&&this._eventEmitter.emit("localRecordingsUpdated",{added:e,removed:t}),i&&this._eventEmitter.emit("isLocalRecordingActiveChanged")},this._isEnabled=yl().calling.localRecording.enabled,this._supportedConversationTypes=yl().calling.localRecording.supportedConversationTypes}get isRecordingActive(){return this._localRecordingInitiators.size>0}get recordings(){return Array.from(this._localRecordingInitiators.values())}initialize(e,t,i){if(this._logger=i.createChild((()=>`LocalRecordingFeature::Call(id='${e.callId}', state='${e.state}')`)),!this._isEnabled){const e="Local Recording feature is is disabled",t=new I({defaultError:f.FEATURES.LOCAL_RECORDING.DISABLED});throw this._logger.error(e),t}e.on("callStateChanged",(async()=>{if(3===e.state){if(!this._supportedConversationTypes.includes(e.conversationType)){const e="Local Recording feature is only available in meetings",t=new I({defaultError:f.FEATURES.LOCAL_RECORDING.ONLY_AVAILABLE_IN_MEETINGS});throw this._logger.error(e),t}this.initLocalRecordingStatus(e)}})),e.on("participantUpdated",(t=>this._onParticipantUpdatedEvent(e,t,t.endpoints?.endpointDetails)))}dispose(){let e=this._localRecordingInitiators.size>0,t=Array.from(this._localRecordingInitiators.values());t.forEach((e=>e?.dispose())),e&&(e=0==this._localRecordingInitiators.size),this._sendEvents(void 0,t,e)}hasOngoingLocalRecording(e){return e?.some((e=>(e.propertyBag?.localRecording?.value?.state||"")===Tf))||!1}initLocalRecordingStatus(e){const{participants:t}=e,i=[...t];this._localRecordingInitiators=new Map(i.filter((e=>this.hasOngoingLocalRecording(e.endpoints?.endpointDetails))).map((e=>[e.id,this._getLocalRecordingInfo(e)])))}_onParticipantUpdatedEvent(e,t,i){t?al(t.id)||(this.hasOngoingLocalRecording(i)?this._tryAddLocalRecordingInitiator(e,t):this._tryRemoveLocalRecordingInitiator(e,t)):this._logger.error(`Empty participant, skip update event processing. CallId: ${e.callId}`)}_tryAddLocalRecordingInitiator(e,t){const{callId:i}=e;if(!this._localRecordingInitiators.has(t.id)){this._logger.info(`Add local recording participant: ${t.id}, callId: ${i}`);let e=this._getLocalRecordingInfo(t);this._localRecordingInitiators.set(t.id,e),this._sendEvents([e],void 0,1==this._localRecordingInitiators.size)}}_tryRemoveLocalRecordingInitiator(e,t){const{callId:i}=e;if(this._localRecordingInitiators.has(t.id)){this._logger.info(`Remove local recording participant: ${t.id}, callId: ${i}`);let e=this._localRecordingInitiators.get(t.id);e.update(If),this._localRecordingInitiators.delete(t.id),this._sendEvents(void 0,[e],0==this._localRecordingInitiators.size)}}_getLocalRecordingInfo(e){let t=e.displayName;return new Af(Tf,t)}}class Af{constructor(e,t){this.state=this.getRecordingState(e),this.displayName=t}update(e){let t=this.getRecordingState(e);return t!=this.state&&(this.state=t,!0)}dispose(){this.state=e.LocalRecordingState.Ended}getRecordingState(t){let i=e.LocalRecordingState.None;switch(t?.toLocaleLowerCase()){case"active":i=e.LocalRecordingState.Started;break;case"inactive":i=e.LocalRecordingState.Ended;break;default:i=e.LocalRecordingState.None}return i}}class Rf{constructor(e){this._eventEmitter=e,this._botChangedSubs=new Map,this._isTranscriptionActive=!1,this._updateIsTranscriptionActive=e=>{this._isTranscriptionActive!==e&&(this._isTranscriptionActive=e,this._logger.info(`Updating isTranscriptionActive to ${e}`),this._eventEmitter.emit("isTranscriptionActiveChanged"))},this._isCallingApplication=e=>al(e.id),this._handleBotRemoved=e=>{this._botChangedSubs.get(e)?.dispose(),this._botChangedSubs.delete(e),this._checkIfAbotIsTranscribing()},this._handleBotAdded=e=>{this._botChangedSubs.set(e,e.changed(this._checkIfAbotIsTranscribing)),this._checkIfAbotIsTranscribing()},this._checkIfAbotIsTranscribing=()=>{try{Array.from(this._botChangedSubs.keys()).find((e=>e.endpoints?.endpointDetails?.find((e=>"Active"===e?.endpointMetadata?.processingModes?.realTimeTranscript?.state))))?this._updateIsTranscriptionActive(!0):this._updateIsTranscriptionActive(!1)}catch(e){this._logger.warn("Unable to read transcription state: ",e)}}}get isTranscriptionActive(){return this._isTranscriptionActive}initialize(e,t,i){this._logger=i.createChild((()=>`TranscriptionFeature::Call(id='${e.callId}', state='${e.state}')`)),e.on("participantAdded",(e=>{this._isCallingApplication(e)&&this._handleBotAdded(e)})),e.participants.forEach((e=>{this._isCallingApplication(e)&&this._handleBotAdded(e)})),e.on("participantRemoved",(e=>{this._isCallingApplication(e)&&this._handleBotRemoved(e)}))}dispose(){this._updateIsTranscriptionActive(!1),this._botChangedSubs.forEach(((e,t)=>e.dispose())),this._botChangedSubs.clear()}}class wf{get state(){return this._state}get error(){return this._error}constructor(e,t,i=!0){return this._eventEmitter=new ep.EventEmitter,this._lastTsTransferState=0,this._getTransferEndReason=(e,t=0)=>{let i=t,n=0,r=e||"Unknown";this._tsCall&&(i=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo.callControllerCode||t,n=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo?.callControllerSubCode||0,r=Lp(this._tsCall.terminatedReason));const s={code:i,subCode:n};return this._logger[0===i?"info":"error"](`Transfer end reason=${r}, code=${i}, subCode=${n}`),s},this._state="None",this._logger=t.createChild((()=>"Transfer")),this._logger.log("created"),this._tsCall=e,i?4!==e.state?(this._logger.error("Transfer end reason= call must be on hold before transfer"),this._error={code:y},void this.setTransferState(4)):(this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState),void this._tsCall.changed((()=>{this._tsCall.transferState!==this._lastTsTransferState&&(this._logger.log(`tsCall transfer state changed=${this._tsCall.transferState}`),this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState))}))):(this._logger.error("Transfer end reason= call was not found with this callId"),this._error={code:y},void this.setTransferState(4))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}setTransferState(e){let t,i;const n={0:"None",1:"Transferring",2:"Transferring",3:"Transferred",4:"Failed"};n[e]?(t=n[e],"Failed"===t&&(i=this._getTransferEndReason(),this._error=i),this._logger.log(`Mapped ts transfer state:[${e}] to [${t}]`),this._setTransferState(t)):this._logger.warn(`unable to map tsCall state=[${e}] to transfer state`)}_setTransferState(e){e!==this._state&&(this._logger.log(`transfer state changed [${this._state}]=>[${this.state}]`),this._state=e,this._eventEmitter.emit("stateChanged"))}}var Pf=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class Mf{constructor(e){this._eventEmitter=e,this._autoAccept=yl().calling.transfer.autoAccept}initialize(e,t,i,n){this._logger=n.createChild((()=>`TransferFeature::Call(id='${e.callId}', state='${e.state}')`)),this._telemetryLogManager=i,this._tsCall=e,this._callAgent=t,e.on("transferRequested",(e=>{const t=this.getTransferRequestPayload(e);if(this._autoAccept){const e=t.accept();this._eventEmitter.emit("transferAccepted",{targetCall:e})}}))}transfer(e,t){let i="safe";if(e.targetCallId&&(i="consultative"),this._sendFeatureUsage(i,Zu.attempt,t),!this.isTransferable(this._tsCall))throw this._sendFeatureUsage(i,Zu.failure,t),new I({defaultError:f.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE});try{let n;switch(i){case"safe":return n=this.transferToParticipant(e.targetParticipant,t),this._sendFeatureUsage(i,Zu.success,t),n;case"consultative":return n=this.transferToCall(e.targetCallId,t),this._sendFeatureUsage(i,Zu.success,t),n}}catch(e){if(this._sendFeatureUsage(i,Zu.failure,t),e instanceof I)throw e}throw this._sendFeatureUsage(i,Zu.failure,t),new I({defaultError:f.FEATURES.TRANSFER.TARGET_NOT_RECOGNIZED})}getTransferRequestPayload(e){const t=sl(e.transferContext.targetMri);if("communicationUser"===t.kind||"phoneNumber"===t.kind||"microsoftTeamsUser"===t.kind||"unknown"===t.kind||"microsoftTeamsApp"===t.kind){let t=!1;const i={accept:()=>{let i;try{if(i=this._callAgent.createTransferTargetCall(e.transferContext),t)return this._logger.info("Transfer accept was called when transfer action is already in progress."),i;t=!0;const n={threadId:"",messageId:void 0,transferContext:e.transferContext,mediaPeerType:0};i.startCallInternal(void 0,!1,void 0,n).catch((i=>{t=!1,e.onCompleted(7),this._logger.error("Transfer to target failed at call start")}));const r=()=>{if(t)switch(i.state){case"Connected":t=!1,e.onCompleted(1),this._logger.info("Transfer Completed"),i.off("stateChanged",(()=>{}));break;case"Disconnected":t=!1,e.onCompleted(7),this._logger.info(`Transfer call disconnected. \n                                            code = ${i.callEndReason?.code} \n                                            subcode = ${i.callEndReason?.subCode} \n                                            message = ${i.callEndReason?.message} \n                                            result categories = ${i.callEndReason?.resultCategories}`),i.off("stateChanged",(()=>{}))}};return i.on("stateChanged",r),i}catch(i){throw t=!1,e.onCompleted(7),this._logger.error("Transfer to target failed at call create"),new I({defaultError:f.FEATURES.TRANSFER.TRANSFER_TO_TARGET_FAILED,originalError:i})}}};return i}throw new I({defaultError:f.FEATURES.TRANSFER.INVALID_TARGET_TYPE,defaultErrorMessageArgs:[t]})}isTransferable(e){return 1===e.callType||e.participants.filter((e=>!al(e.id))).length<=2}transferToParticipant(e,t){let i,n=rl(e);return t&&(i={disableForwardingAndUnanswered:t.disableForwardingAndUnanswered,clientTransferContext:{customContext:jl(t)}}),4===this._tsCall.state&&this._tsCall.callSafeTransfer(n,void 0,i),new wf(this._tsCall,this._logger)}transferToCall(e,t){const i=this._callAgent.getCallByCallId(e);if(i&&!this.isTransferable(i))throw new I({defaultError:f.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE});let n;return t&&(n={clientTransferContext:{customContext:jl(t)}}),i&&4===this._tsCall.state&&this._tsCall.callConsultativeTransfer(i,void 0,void 0,n),new wf(this._tsCall,this._logger,!!i)}_sendFeatureUsage(e,t,i){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:{transferConstraint:{userToUserPresent:!!i?.customContext?.userToUser,xHeadersPresent:!!i?.customContext?.xHeaders&&i.customContext.xHeaders.length>0}}},this._telemetryLogManager,this._logger)}dispose(){}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([P(yp.Transfer),Pf("design:type",Function),Pf("design:paramtypes",[Object,Object]),Pf("design:returntype",Object)],Mf.prototype,"transfer",null);class Df{constructor(e,t,i,n){this._name=e,this._id=t,this._deviceType=i,this._deviceManager=n}get name(){return this._name}setName(e){this._name=e}get id(){return this._id}setId(e){this._id=e}get deviceType(){return this._deviceType}setDeviceType(e){this._deviceType=e}get deviceManager(){return this._deviceManager}}function Of(e,t){Reflect.defineMetadata(b,t,e)}function kf(e){if(this._capacity=Lf(e),this._length=0,this._front=0,Nf(e)){for(var t=e.length,i=0;i<t;++i)this[i]=e[i];this._length=t}}kf.prototype.toArray=function(){for(var e=this._length,t=new Array(e),i=this._front,n=this._capacity,r=0;r<e;++r)t[r]=this[i+r&n-1];return t},kf.prototype.push=function(e){var t=arguments.length,i=this._length;if(t>1){var n=this._capacity;if(i+t>n){for(var r=0;r<t;++r)this._checkCapacity(i+1),this[s=this._front+i&this._capacity-1]=arguments[r],i++,this._length=i;return i}var s=this._front;for(r=0;r<t;++r)this[s+i&n-1]=arguments[r],s++;return this._length=i+t,i+t}return 0===t?i:(this._checkCapacity(i+1),this[r=this._front+i&this._capacity-1]=e,this._length=i+1,i+1)},kf.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,i=this[t];return this[t]=void 0,this._length=e-1,i}},kf.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,i=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,i}},kf.prototype.unshift=function(e){var t=this._length,i=arguments.length;if(i>1){if(t+i>(r=this._capacity)){for(var n=i-1;n>=0;n--){this._checkCapacity(t+1);var r=this._capacity;this[a=(this._front-1&r-1^r)-r]=arguments[n],t++,this._length=t,this._front=a}return t}var s=this._front;for(n=i-1;n>=0;n--){var a;this[a=(s-1&r-1^r)-r]=arguments[n],s=a}return this._front=s,this._length=t+i,t+i}return 0===i?t:(this._checkCapacity(t+1),r=this._capacity,this[n=(this._front-1&r-1^r)-r]=e,this._length=t+1,this._front=n,t+1)},kf.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},kf.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},kf.prototype.get=function(e){var t=e;if(t===(0|t)){var i=this._length;if(t<0&&(t+=i),!(t<0||t>=i))return this[this._front+t&this._capacity-1]}},kf.prototype.isEmpty=function(){return 0===this._length},kf.prototype.clear=function(){for(var e=this._length,t=this._front,i=this._capacity,n=0;n<e;++n)this[t+n&i-1]=void 0;this._length=0,this._front=0},kf.prototype.toString=function(){return this.toArray().toString()},kf.prototype.valueOf=kf.prototype.toString,kf.prototype.removeFront=kf.prototype.shift,kf.prototype.removeBack=kf.prototype.pop,kf.prototype.insertFront=kf.prototype.unshift,kf.prototype.insertBack=kf.prototype.push,kf.prototype.enqueue=kf.prototype.push,kf.prototype.dequeue=kf.prototype.shift,kf.prototype.toJSON=kf.prototype.toArray,Object.defineProperty(kf.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),kf.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(Lf(1.5*this._capacity+16))},kf.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var i=this._front,n=this._length;i+n>t&&function(e,t,i,n,r){for(var s=0;s<r;++s)i[s+n]=e[s+t],e[s+t]=void 0}(this,0,this,t,i+n&t-1)};var Nf=Array.isArray;function Lf(e){if("number"!=typeof e){if(!Nf(e))return 16;e=e.length}return function(e){return e>>>=0,e-=1,e|=e>>1,e|=e>>2,e|=e>>4,1+((e|=e>>8)|e>>16)}(Math.min(Math.max(16,e),1073741824))}var xf=kf;class Uf{static overrideDefaultLogDump(){if(Uf.logDump.isEmpty())Uf.logDump=new xf(yl()?.debugInfo?.maxLogDumpLength);else{let e=new xf(yl()?.debugInfo?.maxLogDumpLength);for(;Uf.logDump.length>0;){const t=Uf.logDump.shift();t&&e.push(t)}Uf.logDump=e}}constructor(e,t=[],i=Uf.defaultLogRedirect){this._azureLogger=e,this._namespace=t,this._logRedirectCallback=i}createChild(e){return new Uf(this._azureLogger,[...this._namespace,"string"==typeof e?()=>e:e])}createFnLogger(e,t,...i){return this.createChild(this.getPrefix(e,t)+i.join(""))}log(...e){const t=this.getMessage(e);this._azureLogger.verbose(t),this._logRedirectCallback(`log:${t}`)}debug(...e){const t=this.getMessage(e);this._azureLogger.verbose(t),this._logRedirectCallback(`debug:${t}`)}info(...e){const t=this.getMessage(e);this._azureLogger.info(t),this._logRedirectCallback(`info:${t}`)}warn(...e){const t=this.getMessage(e);this._azureLogger.warning(t),this._logRedirectCallback(`warn:${t}`)}error(...e){const t=this.getMessage(e);this._azureLogger.error(this.getMessage(e)),this._logRedirectCallback(`error::${t}`)}getMessage(...e){return`${(new Date).toISOString()} ${this.getNamespace()} ${e.join(" ")}`}getNamespace(){return this._namespace.map((e=>e())).join(":")}getPrefix(e,t){let i="";return t&&(i+=t),e&&(i+=e),i}redirectLog(e){this._logRedirectCallback=t=>{Uf.defaultLogRedirect(t),e(t)}}dumpAllLogs(){return[...Uf.logDump.toArray()]}}Uf.logDump=new xf(500),Uf.defaultLogRedirect=e=>{if(yl()?.debugInfo?.enableLogDump){const t=()=>{Uf.logDump.length>yl()?.debugInfo?.maxLogDumpLength&&Uf.logDump.shift()};if(yl()?.debugInfo?.includeList.some((t=>p.includes(e,t))))return Uf.logDump.push(e),void t();if(!yl()?.debugInfo?.excludeList.some((t=>p.includes(e,t))))return Uf.logDump.push(e),void t()}};class Ff{constructor(e){this._telemetryLogManager=e}sendMediaStreamEvent(e){this._telemetryLogManager?.sendEvent({name:Xu.acs_calling_media_stream,tenant:uc,properties:{correlationId:e.correlationId,mediaType:e.mediaType,operation:e.operation,timestampInfo:e.timestampInfo,streamType:e.streamType||Hg.Local,additionalDetails:e.additionalDetails||"",kindOfEvent:e.kindOfEvent||"",callId:e.callId||"",localPaticipantId:e.localParticipantId||""}})}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([Of,function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:type",Object)],Ff.prototype,"logger",void 0);var Vf,Bf=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},Hf=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class $f{constructor(e){if(this._disposed=!1,this._call=new Set,this._canStartEffects=!1,this.kind="LocalVideoStream",this._renderers=[],this._disposeRenderer=e=>{this.logger.log("disposing renderer");try{e.dispose(),this.logger.log("renderer disposed")}catch(e){this.logger.log("failed to dispose renderer")}},!(e instanceof Df||e instanceof MediaStream))throw new I({defaultError:f.LOCAL_VIDEO_STREAM.WRONG_STREAM_TYPE});const i=t.createClientLogger("ACS-calling");this.logger=new Uf(i,[()=>`LocalVideoStream:${e.id}`]),this.logger.info("created"),this._eventEmitter=new Nm(this.logger),this.setSource(e,!0),this._localStreamTelemetryEventSender=new Ff(this._telemetryLogManager)}on(e,t){if("videoSourceChanged"!==e)throw new I({defaultError:f.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("videoSourceChanged"!==e)throw new I({defaultError:f.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}get source(){return this._source}get mediaStreamType(){return this._mediaStreamType}get telemetryLogManager(){return this._telemetryLogManager}get callStackWebCVProvider(){return this.source?.deviceManager?.callStackWebCvProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackVideoEffectsStatusManager??null}get canStartEffects(){return this._canStartEffects}async switchSource(e){this.logger.createFnLogger(Ig.SwitchSource);const t=+new Date,i=x(),n={timestampInfo:{attemptTimestamp:t},correlationId:i,operation:$g.switchSource,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",kindOfEvent:Zu.attempt,mediaType:Bg.Video,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),!(e instanceof Df)){const e=new I({defaultError:f.LOCAL_VIDEO_STREAM.SWITCH_SOURCE_WRONG_TYPE}),n={correlationId:i,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.switchSource,additionalDetails:{failureReason:e.message,code:C,...jp(e)},timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,mediaType:Bg.Video,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e}if(this._source===e){const e=new I({defaultError:f.LOCAL_VIDEO_STREAM.SWITCH_SAME_SOURCE}),n={correlationId:i,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.switchSource,additionalDetails:{failureReason:e.message,code:e.code,...jp(e)},timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,mediaType:Bg.Video,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e}try{"RawMedia"===this._mediaStreamType&&Array.from(this._call.values()).some((e=>e.localVideoStream===this))&&e.deviceManager.getTsDeviceManager().unsetRawMediaStream?.(1),e.deviceManager.getTsDeviceManager().selectDevices({camera:e.id}),this.setSource(e);const n={correlationId:i,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:Bg.Video,operation:$g.switchSource,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(n)}catch(e){const n=$p(0,e),r={correlationId:i,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.switchSource,additionalDetails:{failureReason:n.message,code:C,...jp(n)},timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,mediaType:Bg.Video,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),n}}dispose(){this.logger.log("Disposing LocalVideoStream."),this._disposed?this.logger.log("already disposed"):(this.disposeRawStream(),this._renderers.forEach((e=>this._disposeRenderer(e))),this._renderers=[],this._disposed=!0)}async getMediaStream(){const e=x();let t=+new Date;const i={correlationId:e,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",timestampInfo:{attemptTimestamp:t},operation:$g.getMediaStream,kindOfEvent:Zu.attempt,mediaType:Bg.VideoRaw,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(i),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const i={correlationId:e,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:Bg.VideoRaw,operation:$g.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(i),new MediaStream(this._mediaStreamSource.clone())}try{let i;if("ScreenSharing"===this._source.deviceType?i=2:"UsbCamera"!==this._source.deviceType&&"CaptureAdapter"!==this._source.deviceType&&"Virtual"!==this._source.deviceType||(i=1),!i)throw new I({defaultError:f.LOCAL_VIDEO_STREAM.CANT_GET_DEVICE_TYPE});this._rawStream||(this._rawStream=this.source.deviceManager.getRawDeviceMediaStream(i));const n={correlationId:e,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:Bg.VideoRaw,operation:$g.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(n);const r=await(this._rawStream?.getMediaStream());return new MediaStream(r.clone())}catch(i){let n;n="ScreenSharing"===this._source.deviceType?new I({defaultError:f.CALL.SS_RAW_STREAM_GET,originalError:i}):new I({defaultError:f.LOCAL_VIDEO_STREAM.VIDEO_GET_MEDIA_STREAM,originalError:i});const r={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:e,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.getMediaStream,additionalDetails:{failureReason:n.message,code:n.code,...jp(n)},kindOfEvent:Zu.failure,mediaType:Bg.VideoRaw,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),n}}async setMediaStream(e){const t=x();let i,n=+new Date,r=!1,s=!1,a=Bg.VideoRawOrScreenSharingRaw;for(let e of this._call){const t=e;if(t.localScreenSharingStream===this||t.localVideoStream===this){i=t.deviceManager,s=!0,t.localVideoStream===this?(r=!0,a=Bg.VideoRaw):t.localScreenSharingStream===this&&(r=!1,a=Bg.ScreenSharingRaw);break}}const o={timestampInfo:{attemptTimestamp:n},correlationId:t,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.setMediaStream,kindOfEvent:Zu.attempt,mediaType:a,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(o),!(e instanceof MediaStream)){const e=new I({defaultError:f.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE}),i={timestampInfo:{deltaTimeInMs:+new Date-n},correlationId:t,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.setMediaStream,additionalDetails:{failureReason:e.message,code:e.code,...jp(e)},kindOfEvent:Zu.failure,mediaType:a,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(i),e}if(this.setSource(e),yl()?.calling?.allowAccessRawMediaStream)try{if(s){const t=i?.getTsDeviceManager();if(!t?.setRawMediaStream)throw new I({defaultError:f.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_UNDEFINED_FUNC});r?t.setRawMediaStream(e,1):t.setRawMediaStream(e,2)}this._renderers.forEach((t=>{t.setSourceObject(e)}));const o={timestampInfo:{deltaTimeInMs:+new Date-n},correlationId:t,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.setMediaStream,kindOfEvent:Zu.success,mediaType:a,streamType:Hg.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(o)}catch(e){const i=new I({defaultError:f.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM,originalError:e}),r={correlationId:t,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:$g.setMediaStream,additionalDetails:{failureReason:i.message,code:i.code,...jp(i)},timestampInfo:{deltaTimeInMs:+new Date-n},kindOfEvent:Zu.failure,mediaType:a,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),i}}addCall(e){this._call.add(e)}removeCall(e){this._call.delete(e)}feature(e){return this._extensibleApi||(this._extensibleApi=new bp(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(e.videoStreamApiCtor)}registerRenderer(e){this._renderers.push(e)}unregisterRenderer(e){const t=this._renderers.indexOf(e);-1!==t&&this._renderers.splice(t,1)}getStreamMetadata(){let e,t,i=this.getCall();this._source instanceof Df?(e=this.source.deviceManager,t=this.source.deviceType):this._mediaStreamSource instanceof MediaStream&&i&&(e=i.deviceManager);let n=-1;return i&&("Video"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&i.localVideoStream===this?n=i.tsCall.mediaStreams[0][0]?.id||-1:("ScreenSharing"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&i.localScreenSharingStream===this)&&(n=i.tsCall.mediaStreams[1][0]?.id||-1)),{source:"local",sourceId:n,streamType:this.mediaStreamType,deviceType:t||"",callId:i?.id||"",localParticipantId:i?.tsCall.participantId||"",deviceManagerPermissionState:e?JSON.stringify({cameraPermission:e.getVideoDevicePermission(),microphonePermission:e.getAudioDevicePermission()}):"",acsResourceId:e?.getAcsResourceId()||"",clientId:e?.getClientId()||""}}getLocalParticipantId(){let e="";const t=this.getCall();return t&&(e=t.tsCall.participantId),e}getCall(){for(const e of this._call)if(e.localVideoStreams.includes(this))return e}setSource(e,t=!1){if(e instanceof Df)this._telemetryLogManager=e.deviceManager.telemetryLogManager,this._source=e,this._mediaStreamType="ScreenSharing"===e.deviceType?"ScreenSharing":"Video",this._mediaStreamSource=void 0,this._rawStream=void 0,this._canStartEffects=!0;else{try{1===globalThis[bc]&&(this._telemetryLogManager=globalThis[Ic])}catch(e){this.logger.error("Failed to retrive telemetry logger for localVideoStream")}this._source={name:"CustomMediaStream",id:x(),deviceType:"Virtual"},this._mediaStreamSource=e,this._mediaStreamType="RawMedia",this._canStartEffects=!1}t||this._eventEmitter.emit("videoSourceChanged",{source:this})}subscribeToRawStreamChangedIfNeeded(){this._source instanceof Df&&!this._videoSourceChangedSub&&(this._videoSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("videoSourceChanged",{source:this})})))}disposeRawStream(){this._rawStream&&this._rawStream.dispose(),this._videoSourceChangedSub?.dispose(),this._videoSourceChangedSub=void 0}}Bf([Of,Hf("design:type",Object)],$f.prototype,"logger",void 0),Bf([M(Ig.SwitchSource),Hf("design:type",Function),Hf("design:paramtypes",[Object]),Hf("design:returntype",Promise)],$f.prototype,"switchSource",null),Bf([M(Ig.GetMediaStream),Hf("design:type",Function),Hf("design:paramtypes",[]),Hf("design:returntype",Promise)],$f.prototype,"getMediaStream",null),Bf([M(Ig.SetMediaStream),Hf("design:type",Function),Hf("design:paramtypes",[MediaStream]),Hf("design:returntype",Promise)],$f.prototype,"setMediaStream",null),Bf([P(Ig.Feature),Hf("design:type",Function),Hf("design:paramtypes",[Object]),Hf("design:returntype","function"==typeof(Vf="undefined"!=typeof TFeature&&TFeature)?Vf:Object)],$f.prototype,"feature",null);class Gf{constructor(e,t,i,n,r){this._name=e,this._id=t,this._isSystemDefault=i,this._deviceType=n,this._deviceManager=r}get name(){return this._name}setName(e){this._name=e}get id(){return this._id}setId(e){this._id=e}get isSystemDefault(){return this._isSystemDefault}setIsSystemDefault(e){this._isSystemDefault=e}get deviceType(){return this._deviceType}setDeviceType(e){this._deviceType=e}get deviceManager(){return this._deviceManager}}class jf{constructor(e,t,i,n,r){this._workQueue=Promise.resolve(),this.logger=e.createChild("volume indicator"),this._eventEmitter=new Nm(this.logger,{enableLogEmit:!1}),this._isInitialized=!1,this._level=0,this._streamType=t,this._callId=n,this._localParticipantId=r,this._telemetryLogManager=i}get isInitialized(){return this._isInitialized}initialize(e){if(void 0===e)throw this.logger.error("failed to getMediaStreamTrack"),new I({defaultError:f.CALL.VOLUME_TRACK});const t=x(),i=+new Date;try{this.sendVolumeEvent({eventName:Xu.acs_calling_audio_stream_volume,correlationId:t,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),this.bindToAudioStreamVolume(e),this.sendVolumeEvent({eventName:Xu.acs_calling_audio_stream_volume,correlationId:t,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:""})}catch(e){const n=new I({defaultError:f.CALL.VOLUME_INIT,originalError:e});throw this.logger.error(n.message),this.sendVolumeEvent({eventName:Xu.acs_calling_audio_stream_volume,correlationId:t,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,...jp(n)}}),n}}bindToAudioStreamVolume(e){let[t,i]=this.setupVolumeCalculator(e);this._level=t();let n=setInterval((()=>{let e=t();e!==this._level&&(this._level=e,this._eventEmitter.emit("levelChanged"))}),yl()?.volumeIndicator?.microphoneVolumeSampleIntervalMs);this._volumeCallBackInterval=n,this._audioContext=i}setupVolumeCalculator(e){const t=new MediaStream(e),i=new AudioContext,n=i.createMediaStreamSource(t),r=i.createAnalyser();n.connect(r),r.fftSize=yl().volumeIndicator.fftSize,r.minDecibels=yl().volumeIndicator.minDecibels,r.maxDecibels=yl().volumeIndicator.maxDecibels,r.smoothingTimeConstant=yl().volumeIndicator.smoothingConstant;const s=new Uint8Array(r.frequencyBinCount);return[()=>{try{r.getByteFrequencyData(s);let e=0;for(const t of s)e+=t;return e/s.length*yl().volumeIndicator.normalisedMaxVolume/yl().volumeIndicator.maxAvailableVolume}catch(e){return this.logger.error("error in calculating audio stream volume"),0}},i]}dispose(){this._isInitialized=!1,this._level=0,this._eventEmitter.removeAllListeners();try{this._audioContext?.close().catch((e=>{this.logger.error("unable to close AudioContext")}))}catch(e){this.logger.error("unable to close MicrophoneAudioContext")}this._volumeCallBackInterval&&clearInterval(this._volumeCallBackInterval)}on(e,t){if("levelChanged"!==e)throw new I({defaultError:f.CALL.VOLUME_EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("levelChanged"!==e)throw new I({defaultError:f.CALL.VOLUME_EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}get level(){return this._level}getVolumeIndicator(e){const t=()=>{if(!this.isInitialized)try{this.initialize(e),this._isInitialized=!0}catch(e){const t=new I({defaultError:f.CALL.VOLUME_GET,originalError:e});throw this.logger.error(t.message),t}return this},i=this._workQueue.then((()=>t()));return this._workQueue=i.then(kl,kl),i}sendVolumeEvent(e){try{this._telemetryLogManager?.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send screen share telemetry")}}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([Of,function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:type",Object)],jf.prototype,"logger",void 0);var qf,Wf,zf,Jf=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},Kf=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class Yf{constructor(e){this.canStartEffects=!1;const i=t.createClientLogger("ACS-calling");if(this.logger=new Uf(i,[()=>`LocalAudioStream for default device with source: ${!!e}`]),this._eventEmitter=new Nm(this.logger),this._disposed=!1,!(e instanceof Gf||e instanceof MediaStream))throw new I({defaultError:f.LOCAL_AUDIO_STREAM.WRONG_STREAM_TYPE});if(e instanceof Gf&&"Microphone"!==e.deviceType)throw new I({defaultError:f.LOCAL_AUDIO_STREAM.SOURCE_WRONG_TYPE});this.setSource(e,!0),this._localStreamTelemetryEventSender=new Ff(this._telemetryLogManager),this._volumeIndicator=new jf(this.logger,"LocalAudioStream",this._telemetryLogManager),this.logger.info("created")}on(e,t){if("audioSourceChanged"!==e)throw new I({defaultError:f.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("audioSourceChanged"!==e)throw new I({defaultError:f.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}feature(e){return this._extensibleApi||(this._extensibleApi=new bp(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(e.audioStreamApiCtor)}get mediaStreamType(){return this._mediaStreamType}get source(){return this._source}get telemetryLogManager(){return this._telemetryLogManager}get callStackWasmVqeProvider(){return this.source?.deviceManager?.callStackWasmVqeProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackAudioEffectsStatusManager??null}async getMediaStream(){const e=x(),t=+new Date,i={timestampInfo:{attemptTimestamp:t},correlationId:e,operation:$g.getMediaStream,kindOfEvent:Zu.attempt,mediaType:Bg.AudioRaw,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(i),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const i={correlationId:e,mediaType:Bg.AudioRaw,operation:$g.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(i),this._mediaStreamSource}if(this._source instanceof Gf)try{this._rawStream=this._source.deviceManager.getRawDeviceMediaStream(0);const i=await(this._rawStream?.getMediaStream()),n={correlationId:e,mediaType:Bg.AudioRaw,operation:$g.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),i}catch(n){const i=new I({defaultError:f.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM,originalError:n}),r={correlationId:e,operation:$g.getMediaStream,additionalDetails:{failureReason:i.message,code:i.code,...jp(i)},timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,mediaType:Bg.AudioRaw,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),i}const n=new I({defaultError:f.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM}),r={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:e,operation:$g.getMediaStream,additionalDetails:{failureReason:n.message,code:C,...jp(n)},kindOfEvent:Zu.failure,mediaType:Bg.AudioRaw,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),n}async setMediaStream(e){const t=x();let i=+new Date;const n={timestampInfo:{attemptTimestamp:i},correlationId:t,operation:$g.setMediaStream,kindOfEvent:Zu.attempt,mediaType:Bg.AudioRaw,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),!(e instanceof MediaStream)){const e=new I({defaultError:f.LOCAL_AUDIO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE}),n={timestampInfo:{deltaTimeInMs:+new Date-i},correlationId:t,operation:$g.setMediaStream,additionalDetails:{failureReason:e.message,code:e.code,...jp(e)},kindOfEvent:Zu.failure,mediaType:Bg.AudioRaw,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e}this._mediaStreamSource=new MediaStream(e.getAudioTracks()),this.setSource(this._mediaStreamSource),this._volumeIndicator.dispose();const r={correlationId:t,mediaType:Bg.AudioRaw,operation:$g.setMediaStream,timestampInfo:{deltaTimeInMs:+new Date-i},streamType:Hg.Local,kindOfEvent:Zu.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(r)}async switchSource(e){const t=+new Date,i=x(),n={timestampInfo:{attemptTimestamp:t},correlationId:i,operation:$g.switchSource,kindOfEvent:Zu.attempt,mediaType:Bg.Audio,streamType:Hg.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e instanceof Gf&&"Microphone"!==e.deviceType){const e=new I({defaultError:f.LOCAL_AUDIO_STREAM.SWITCH_SOURCE_WRONG_TYPE}),n={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:i,operation:$g.switchSource,additionalDetails:{failureReason:e.message,code:e.code,...jp(e)},kindOfEvent:Zu.failure,mediaType:Bg.Audio,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e}if(this._source===e){const e=new I({defaultError:f.LOCAL_AUDIO_STREAM.SWITCH_SAME_SOURCE}),n={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:i,operation:$g.switchSource,additionalDetails:{failureReason:e.message,code:e.code,...jp(e)},kindOfEvent:Zu.failure,mediaType:Bg.Audio,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),e}try{this._source.deviceManager.selectMicrophone(e),this.setSource(e),this._volumeIndicator.dispose();const n={correlationId:i,mediaType:Bg.Audio,operation:$g.switchSource,timestampInfo:{deltaTimeInMs:+new Date-t},streamType:Hg.Local,kindOfEvent:Zu.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(n)}catch(e){const n=new I({defaultError:f.LOCAL_AUDIO_STREAM.UNKNOWN,originalError:e}),r={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:i,operation:$g.switchSource,additionalDetails:{failureReason:n.message,code:n.code,...jp(n)},kindOfEvent:Zu.failure,mediaType:Bg.Audio,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),n}}dispose(){this.logger.log("LocalAudioStream disposing"),this._disposed?this.logger.log("Already disposed"):(this._disposed=!0,this.disposeRawStream(),this._volumeIndicator.dispose(),this._eventEmitter.removeAllListeners(),this.logger.log("LocalAudioStream disposed"))}async getVolume(){return this._volumeIndicator.isInitialized?this._volumeIndicator:this._volumeIndicator.getVolumeIndicator(await this.getMediaStream())}subscribeToRawStreamChangedIfNeeded(){this._source instanceof Gf&&!this._audioSourceChangedSub&&(this._audioSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose()})))}disposeRawStream(){this._audioSourceChangedSub?.dispose(),this._rawStream?.dispose(),this._audioSourceChangedSub=void 0}getStreamMetadata(){const e=this.source.deviceManager;return{source:"local",streamType:this.mediaStreamType,deviceType:this.source.deviceType,deviceManagerPermissionState:JSON.stringify({cameraPermission:e.getVideoDevicePermission(),microphonePermission:e.getAudioDevicePermission()}),acsResourceId:e.getAcsResourceId()||"",clientId:e.getClientId()}}setSource(e,t=!1){if(e instanceof Gf)this._telemetryLogManager=e.deviceManager.telemetryLogManager,this._source=e,this._mediaStreamType="Audio",this._mediaStreamSource=void 0,this._rawStream=void 0,this.canStartEffects=!0;else{try{1===globalThis[bc]&&(this._telemetryLogManager=globalThis[Ic])}catch(e){this.logger.error("Failed to retrive telemetry logger for localAudioStream")}this._source={name:"CustomMediaStream",id:x(),deviceType:"Virtual",isSystemDefault:!1},this._mediaStreamSource=e,this._mediaStreamType="RawMedia",this.canStartEffects=!1}t||this._eventEmitter.emit("audioSourceChanged",{source:this})}}Jf([Of,Kf("design:type",Object)],Yf.prototype,"logger",void 0),Jf([P(bg.Feature),Kf("design:type",Function),Kf("design:paramtypes",[Object]),Kf("design:returntype","function"==typeof(qf="undefined"!=typeof TFeature&&TFeature)?qf:Object)],Yf.prototype,"feature",null),Jf([M(bg.GetMediaStream),Kf("design:type",Function),Kf("design:paramtypes",[]),Kf("design:returntype",Promise)],Yf.prototype,"getMediaStream",null),Jf([M(bg.SetMediaStream),Kf("design:type",Function),Kf("design:paramtypes",[MediaStream]),Kf("design:returntype",Promise)],Yf.prototype,"setMediaStream",null),Jf([M(bg.SwitchSource),Kf("design:type",Function),Kf("design:paramtypes",[Object]),Kf("design:returntype",Promise)],Yf.prototype,"switchSource",null),function(e){e[e.JITTER=0]="JITTER",e[e.RTT=1]="RTT",e[e.PACKETS_LOSS=2]="PACKETS_LOSS",e[e.BIT_RATE=3]="BIT_RATE",e[e.BANDWIDTH=4]="BANDWIDTH"}(Wf||(Wf={})),function(e){e[e.AUDIO=0]="AUDIO",e[e.VIDEO=1]="VIDEO"}(zf||(zf={}));const Qf="Unknown";var Xf,Zf;function eS(e){return e?.count.length&&e?.count[0]?function(e,t,i=100){return Math.round((e/t+Number.EPSILON)*i)/i}(e.sum[0],e.count[0]):NaN}function tS(e){return e?.count.length&&e?.count[0]?e.sum[0]:NaN}!function(e){e.Supported="Supported",e.NotSupported="NotSupported",e.Unknown="Unknown"}(Xf||(Xf={})),function(e){e.CompleteTest="CompleteTest",e.StartTest="StartTest",e.DeviceAccess="DeviceAccess",e.DeviceEnumerations="DeviceEnumerations",e.InCallDiagnostics="InCallDiagnostics",e.BrowserSupport="BrowserSupport"}(Zf||(Zf={}));class iS{constructor(){this._printableObjectAll=!0,this._completeTestInfo={name:"",succeeded:!0},this._diagnosticsTestRunIds=[],this._callMediaStatistics=Rl(),this._inCallDiagnostics={connected:!1,diagnostics:{audio:{jitter:Qf,packetLoss:Qf,rtt:Qf},video:{jitter:Qf,packetLoss:Qf,rtt:Qf}},bandWidth:Qf},this._diagnosticsMediaTelemetry={jitter:{audio:{inbound:0,outbound:0},video:{inbound:0,outbound:0}},rtt:{audio:0,video:0},packets:{audioSent:0,audioSentLost:0,audioReceived:0,audioReceivedLost:0,videoSent:0,videoSentLost:0,videoReceived:0,videoReceivedLost:0},bandWidth:0},this._isCreatingNewCallAgent=!1}intialize(e,t,i,n){this._internalCallClient=t,this._mainCallClient=e,this._logger=i,this._telemetryLogManager=n}async getDevices(e,t){let i=[];try{switch(t){case"Speaker":i=await e.getSpeakers();break;case"Microphone":i=await e.getMicrophones();break;default:i=await e.getCameras()}}catch(e){this._logger.warn("Failed to get speakers")}return i}async startTest(e,t){this._sendFeatureUsage("startTest",Zu.attempt),this._currentTestRunId=x(),this._diagnosticsTestRunIds.push(this._currentTestRunId),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.CompleteTest}}),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.StartTest}});try{this._internalDeviceManager=await this._internalCallClient.getDeviceManager();const e=this._internalCallClient.callAgent,t=await this._mainCallClient.getDeviceManager();e?.tsStack?.getDeviceManager().selectDevices({speaker:t.selectedSpeaker?.id,microphone:t.selectedMicrophone?.id});const i=await this._internalCallClient.getDeviceManager(),n={mic:(await this.getDevices(i,"Microphone")).length,speaker:(await this.getDevices(i,"Speaker")).length};this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.StartTest,!0,`Device selection successful. Result: ${Fl(n,this._printableObjectAll)}`)})}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.SET_DEVICE_FAIL,originalError:e});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.StartTest,!1,"Device selection failed."),additionalDetails:{...jp(t)}}),this._logger.warn(e),this._sendFeatureUsage("startTest",Zu.failure),t}try{return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.StartTest,!0,"StartTest succeeded")}),this._sendFeatureUsage("startTest",Zu.success),t?{deviceAccess:t.deviceAccess?this.deviceAccess():void 0,deviceEnumeration:t.deviceEnumeration?this.deviceEnumeration():void 0,inCallDiagnostics:t.inCallDiagnostics?this.getInCallDiagnostics(e):void 0,browserSupport:t.browserSupport?this.getBrowserSupport():void 0,callMediaStatistics:t.callMediaStatistics?this.getcallMediaStatistics():void 0,id:this._currentTestRunId}:{deviceAccess:this.deviceAccess(),deviceEnumeration:this.deviceEnumeration(),inCallDiagnostics:this.getInCallDiagnostics(e),browserSupport:this.getBrowserSupport(),callMediaStatistics:this.getcallMediaStatistics(),id:this._currentTestRunId}}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.GET_DIAGNOSTICS_INFO,originalError:e});throw this._logger.error(t.message),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.StartTest,!1,"StartTest failed."),additionalDetails:{...jp(t)}}),this._sendFeatureUsage("startTest",Zu.failure),t}}async getBrowserSupport(){let e;this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.BrowserSupport}});try{const t=await this._mainCallClient.getEnvironmentInfoInternal();e={browser:t.isSupportedBrowser?Xf.Supported:Xf.NotSupported,os:t.isSupportedPlatform?Xf.Supported:Xf.NotSupported},this.updateTestInfo(Zf.BrowserSupport,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Browser support successful. Result: ${Fl(e,this._printableObjectAll)}`,name:Zf.BrowserSupport}})}catch(t){e={browser:Xf.Unknown,os:Xf.Unknown},this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.BrowserSupport,!1,`Browser support failed. Error: ${Fl(t)}`)}),this._logger.error(`Browser support failed: ${t}`)}return new Promise((t=>t(e)))}async renderHiddenVideoElement(e,t){let i,n=e.tsCall,r=n.mediaStreams;try{await new Promise(((e,t)=>{i=n.changed((()=>{void 0!==r[0]&&r[0].length>0&&r[0][0].isAvailable&&(e(),i?.dispose(),this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call mediaStreams successful.",name:Zf.InCallDiagnostics}}))})),setTimeout((()=>{this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,"Call mediaStreams failed. Error: Timeout")}),t(new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_STREAM_TIMEOUT}))}),1e3*this._diagnosticsEcsConfig.CALL.MEDIASTREAM_TIMEOUT_IN_SEC)}));let s=n.mediaStreams[0][0],a=document.getElementById("_hiddenSelfRemoteStream");a&&a.remove(),a=document.createElement("div"),a.id="_hiddenSelfRemoteStream",a.style.position="relative",a.style.height="0px",a.style.width="0px";const o=document.createElement("div");o.style.position="absolute",o.style.height=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.heigth+"px",o.style.width=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.width+"px",o.style.bottom="0px",o.style.left="-2000px",a.appendChild(o),document.getElementsByTagName("body")[0].appendChild(a),this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Video element rendering successful. CallId: ${e.id}, localParticipantId: ${t}`,name:Zf.InCallDiagnostics}}),await s.start(o)}catch(e){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,`Call mediaStreams failed. Error: ${Fl(e)}`)}),this._logger.warn("Failed to render hidden video element")}}sineWaveAudioStream(){const e=new window.AudioContext,t=e.createMediaStreamDestination(),i=e.createOscillator();i.type="sine",i.frequency.value=500,i.connect(t),i.start();const{stream:n}=t;return new Yf(n)}async receiveAndPlayCallAudio(e,t){try{const i=new window.AudioContext,n=new MediaStream;i.createMediaStreamSource(n).connect(i.destination),this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call mediaStreams audio track succeeded. CallId: ${e.id}, localParticipantId: ${t}`,name:Zf.InCallDiagnostics}})}catch(e){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,`Call mediaStreams audio track failed. Error: ${Fl(e)}`)}),this._logger.warn("Failed to send audio to call.")}}async getcallMediaStatistics(){return this._callMediaStatistics.promise}setEcsConfig(){this._diagnosticsEcsConfig=yl()?.calling?.callDiagnostics}async getInCallDiagnostics(e){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.InCallDiagnostics}}),this.setEcsConfig();const t={groupId:this._diagnosticsEcsConfig.CALL.GROUP_ID},i=await this.getDevices(this._internalDeviceManager,"Camera");let n,r="";0!==i.length&&(n=[new $f(i[0])]);const s={videoOptions:{localVideoStreams:n},audioOptions:{muted:!1,localAudioStreams:[this.sineWaveAudioStream()]}};let a;try{a=await(this._mainCallClient.callAgent?.getExistingCallAgentWithToken(e)),a?this._internalCallClient.setCallAgent(a):(this._isCreatingNewCallAgent=!0,await this._internalCallClient.createCallAgent(e)),this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Create CallAgent successful.",name:Zf.InCallDiagnostics}})}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.GET_CALL_AGENT,originalError:e});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,t.message),additionalDetails:{...jp(t)}}),this._logger.error(t.message),t}const o=this._internalCallClient.callAgent?.join(t,s);if(o){try{await this.waitCallConnected(o),r=o.tsCall.participantId,this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call connected successfully",name:Zf.InCallDiagnostics}})}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.CONNECT_FAIL,originalError:e});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,t.message),additionalDetails:{...jp(t)}}),this._logger.error(t.message),t}try{this.updateTestInfo(Zf.InCallDiagnostics,!0),await this.renderHiddenVideoElement(o,r)}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.RENDER_VIDEO,originalError:e});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,t.message),additionalDetails:{...jp(t)}}),t}this.receiveAndPlayCallAudio(o,r);const t=o.feature(Mp(vf,{activationEvent:"OnExtendedObjectConstructor"}));this._callMediaStatistics.resolve(t),t.createCollector({aggregationInterval:this._diagnosticsEcsConfig.CALL.AGGREGATION.INTERVAL,dataPointsPerAggregation:this._diagnosticsEcsConfig.CALL.AGGREGATION.DATAPOINTS}).on("summaryReported",(e=>this.gatherCallStatistics(e)));try{await Lu(1e3*this._diagnosticsEcsConfig.CALL.DURATION_IN_SEC),await o.hangUp({forEveryone:!0}),this.updateTestInfo(Zf.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call hangup successful. Result: ${Fl(this._inCallDiagnostics,this._printableObjectAll)}`,name:Zf.InCallDiagnostics}})}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.HANGUP_FAIL,originalError:e});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.InCallDiagnostics,!1,t.message),additionalDetails:{...jp(t)}}),this._logger.error(t.message),t}this.dispose()}return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:this._completeTestInfo.succeeded,result:this._completeTestInfo.result||"InCallDiagnostics succeeded.",name:Zf.CompleteTest}}),this._inCallDiagnostics}async waitCallConnected(e){await new Promise((async(t,i)=>{e.on("stateChanged",(()=>{"Connected"==e.state&&(this._inCallDiagnostics.connected=!0,t()),"Disconnected"==e.state&&i("Call disconnected")}));const n=this._diagnosticsEcsConfig.CALL.CONNECT_TIMEOUT_IN_SEC;await Lu(1e3*n),i(new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.CALL_CONNECT_TIMEOUT,defaultErrorMessageArgs:[n]}))}))}qualityGrade(e,t,i){return e<=t?"Good":e>=i?"Bad":"Average"}bandwidthQualityGrade(e,t,i){return e>=t?"Good":e<=i?"Bad":"Average"}getQualityGradeForMetric(e,t,i){switch(e){case Wf.JITTER:return i===zf.AUDIO?this.qualityGrade(t,this._diagnosticsEcsConfig.AUDIO.JITTER.GOOD,this._diagnosticsEcsConfig.AUDIO.JITTER.AVERAGE):this.qualityGrade(t,this._diagnosticsEcsConfig.VIDEO.JITTER.GOOD,this._diagnosticsEcsConfig.VIDEO.JITTER.AVERAGE);case Wf.RTT:return i===zf.AUDIO?this.qualityGrade(t,this._diagnosticsEcsConfig.AUDIO.RTT.GOOD,this._diagnosticsEcsConfig.AUDIO.RTT.AVERAGE):this.qualityGrade(t,this._diagnosticsEcsConfig.VIDEO.RTT.GOOD,this._diagnosticsEcsConfig.VIDEO.RTT.AVERAGE);case Wf.PACKETS_LOSS:return i===zf.AUDIO?this.qualityGrade(t,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.AVERAGE):this.qualityGrade(t,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.AVERAGE);case Wf.BANDWIDTH:return this.bandwidthQualityGrade(t,this._diagnosticsEcsConfig.BANDWIDTH.GOOD,this._diagnosticsEcsConfig.BANDWIDTH.AVERAGE);default:return Qf}}gatherCallStatistics(e){try{const t=e.audio.receive.length?e.audio.receive[0]:void 0,i=e.audio.send.length?e.audio.send[0]:void 0,n=e.video.receive.length?e.video.receive[0]:void 0,r=e.video.send.length?e.video.send[0]:void 0,s=e.transports.length?e.transports[0]:void 0;this._diagnosticsMediaTelemetry.jitter.audio.inbound=eS(t?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.audio.outbound=eS(i?.jitterInMs?.aggregation);const a=Math.max(this._diagnosticsMediaTelemetry.jitter.audio?.inbound,this._diagnosticsMediaTelemetry.jitter.audio?.outbound);this._inCallDiagnostics.diagnostics.audio.jitter=this.getQualityGradeForMetric(Wf.JITTER,a,zf.AUDIO),this._diagnosticsMediaTelemetry.rtt.audio=eS(i?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.audio.rtt=this.getQualityGradeForMetric(Wf.JITTER,this._diagnosticsMediaTelemetry.rtt.audio,zf.AUDIO),this._diagnosticsMediaTelemetry.packets.audioSent=tS(i?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioSentLost=tS(i?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceived=tS(t?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceivedLost=tS(t?.packetsLostPerSecond?.aggregation);const o=this._diagnosticsMediaTelemetry.packets.audioSent-this._diagnosticsMediaTelemetry.packets.audioSentLost,c=this._diagnosticsMediaTelemetry.packets.audioReceived-this._diagnosticsMediaTelemetry.packets.audioReceivedLost,l=Math.max(o,c)/this._diagnosticsMediaTelemetry.packets.audioSent*100;this._inCallDiagnostics.diagnostics.audio.packetLoss=this.getQualityGradeForMetric(Wf.PACKETS_LOSS,l,zf.AUDIO),this._diagnosticsMediaTelemetry.jitter.video.inbound=eS(n?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.video.outbound=eS(r?.jitterInMs?.aggregation);const d=Math.max(this._diagnosticsMediaTelemetry.jitter.video.inbound,this._diagnosticsMediaTelemetry.jitter.video.outbound);this._inCallDiagnostics.diagnostics.video.jitter=this.getQualityGradeForMetric(Wf.JITTER,d,zf.VIDEO),this._diagnosticsMediaTelemetry.rtt.video=eS(r?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.video.rtt=this.getQualityGradeForMetric(Wf.RTT,this._diagnosticsMediaTelemetry.rtt.video,zf.VIDEO),this._diagnosticsMediaTelemetry.packets.videoSent=tS(r?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoSentLost=tS(r?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceived=tS(n?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceivedLost=tS(n?.packetsLostPerSecond?.aggregation);const h=this._diagnosticsMediaTelemetry.packets.videoSent-this._diagnosticsMediaTelemetry.packets.videoSentLost,u=this._diagnosticsMediaTelemetry.packets.videoReceived-this._diagnosticsMediaTelemetry.packets.videoReceivedLost,g=Math.max(h,u)/this._diagnosticsMediaTelemetry.packets.videoSent*100;this._inCallDiagnostics.diagnostics.video.packetLoss=this.getQualityGradeForMetric(Wf.PACKETS_LOSS,g,zf.VIDEO),this._diagnosticsMediaTelemetry.bandWidth=eS(s?.availableOutgoingBitrate?.aggregation),this._inCallDiagnostics.bandWidth=this.getQualityGradeForMetric(Wf.BANDWIDTH,this._diagnosticsMediaTelemetry.bandWidth,zf.AUDIO)}catch(e){const t=new I({defaultError:f.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_MEDIASTATS,originalError:e});this._logger.error("Failed to get audio call media stats:",t.message),this._callMediaStatistics.reject(t)}}async deviceAccess(){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.DeviceAccess}});const e=this._internalDeviceManager.askDevicePermission({audio:!0,video:!0});try{const t=await e;this.updateTestInfo(Zf.DeviceAccess,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Access successful. Result: ${Fl(t,this._printableObjectAll)}`,name:Zf.DeviceAccess}})}catch(e){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.DeviceAccess,!1,"Device Access failed.")})}return e}async deviceEnumeration(){const e={microphone:Qf,camera:Qf,speaker:Qf};this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Zf.DeviceEnumerations}});try{const t=0!==(await this.getDevices(this._internalDeviceManager,"Microphone")).length,i=0!==(await this.getDevices(this._internalDeviceManager,"Camera")).length,n=0!==(await this.getDevices(this._internalDeviceManager,"Speaker")).length;e.microphone=t?"Available":"NotAvailable",e.camera=i?"Available":"NotAvailable",e.speaker=n?"Available":"NotAvailable",this.updateTestInfo(Zf.DeviceEnumerations,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Enumeration successful. Result: ${Fl(e,this._printableObjectAll)}`,name:Zf.DeviceEnumerations}})}catch(e){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Zf.DeviceEnumerations,!1,"Device Enumeration failed.")}),this._logger.error(`Couldn't find mic, camera, or speaker: ${e}`)}return e}telemetryLogAttemptEvents(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_diagnostics_attempt,tenant:uc,properties:{name:e.testAttemptDetails.name,diagnosticsTestRunId:e.diagnosticsTestRunId}})}telemetryLogResultEvents(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_diagnostics_result,tenant:uc,properties:{name:e.testResultDetails.name,diagnosticsTestRunId:e.diagnosticsTestRunId,succeeded:e.testResultDetails.succeeded,result:e.testResultDetails.result,additionalDetails:e.additionalDetails||{}}})}updateTestInfo(e,t,i){return this._completeTestInfo.succeeded&&(this._completeTestInfo={succeeded:t,name:e,result:i}),{succeeded:t,name:e,result:i||""}}_sendFeatureUsage(e,t){kp({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._isCreatingNewCallAgent&&this._internalCallClient.callAgent?.dispose()}}class nS{constructor(e,t){this._debounce=void 0,this._updateFunction=e,this._timeout=t}debounce(){this._debounce?(clearTimeout(this._debounce),this._debounce=setTimeout((()=>{this._updateFunction(),this._debounce=void 0}),this._timeout)):(this._updateFunction(),this._debounce=setTimeout((()=>{this._debounce=void 0}),this._timeout))}flush(){this._debounce&&(clearTimeout(this._debounce),this._debounce=void 0,this._updateFunction())}}class rS{constructor(e,t,i,n,r,s){this._isReceiving=!1,this._mediaStreamType="Video",this._renderers=[],this._disposed=!1,this._size={height:0,width:0},this._setType=e=>{0===e.type?this._mediaStreamType="Video":1===e.type?this._mediaStreamType="ScreenSharing":2===e.type&&(this._mediaStreamType="LiveStream")},this._disposeRenderer=e=>{this.logger.log("disposing renderer");try{e.dispose(qg.Internal_RemoteVideoStreamDisposed),this.logger.log("renderer disposed")}catch(e){this.logger.log("failed to dispose renderer")}},this.tsStream=e,this._setType(this.tsStream),this.logger=t.createChild((()=>`Stream:{id=${this.tsStream.id}}:{type=${this._mediaStreamType}}`)),this.telemetryLogManager=r,this.kind=s,this._eventEmitter=new Nm(this.logger),this.call=i,this._tsParticipantId=n,this.sendRemoteVideoStreamTelemetry(),this._debounceSize=this.createDebounceSize(),this._debounceIsReceiving=new nS((()=>{const e=this._renderers?.filter((e=>!!e?.isRendering)).length>0;this._isReceiving!==e&&(this._isReceiving=e,this.logger.info(`isReceiving changed to ${this._isReceiving}`),this._eventEmitter.emit("isReceivingChanged"),this.sendRemoteVideoStreamTelemetry())}),yl().rendering.remoteVideo.debounceTimeout),this._registeredViewIdsMaxLength=yl().rendering.remoteVideo.registeredViewIdsMaxLength,this.logger.info("created")}on(e,t){if("sizeChanged"!==e&&"isReceivingChanged"!==e)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("sizeChanged"!==e&&"isReceivingChanged"!==e)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}get id(){return this.tsStream.id}get isReceiving(){return this._isReceiving}get tsParticipantId(){return this._tsParticipantId}get remoteParticipantId(){return this.tsStream.participantId??""}get mediaStreamType(){return this._mediaStreamType}get size(){return{height:this._size.height,width:this._size.width}}updateSize(){this._debounceSize.debounce()}updateIsReceiving(){this._debounceIsReceiving.debounce()}flushIsReceiving(){this._debounceIsReceiving.flush()}registerRenderer(e){this._renderers.push(e),this.logger.info(`Renderer registered, view id: ${e.viewId}`)}unregisterRenderer(e){const t=this._renderers.indexOf(e);-1!==t&&(this._renderers.splice(t,1),this.logger.info(`Renderer un-registered, view id: ${e.viewId}`))}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._disposed=!0,this._streamChangedHandler&&this._streamChangedHandler.dispose(),this._renderers.forEach((e=>this._disposeRenderer(e))),this._renderers=[],this._eventEmitter.removeAllListeners())}getRegisteredViewIds(){let e=this._renderers.map((e=>e.viewId));return this._registeredViewIdsMaxLength&&(e=e.slice(0,this._registeredViewIdsMaxLength)),e.join(", ")}sendRemoteVideoStreamTelemetry(){this.call.stats.recordEvent({name:Qu.remote_stream,callId:this.call.id,localParticipantId:this.call.tsCall.participantId,data:{...this.getStreamMetadata()}})}createDebounceSize(){return new nS((()=>{let e={height:0,width:0};this._renderers?.forEach((t=>{t?.isRendering&&t.size.height>e.height&&t.size.width>e.width&&(e.height=t.size.height,e.width=t.size.width)}),yl().rendering.remoteVideo.debounceTimeout),this._size.height===e.height&&this._size.width===e.width||(this._size.height=e.height,this._size.width=e.width,this.logger.info(`stream size changed to { height: ${this._size.height}, width: ${this._size.width} }`),this._eventEmitter.emit("sizeChanged"),this.sendRemoteVideoStreamTelemetry())}),yl().rendering.remoteVideo.debounceTimeout)}}class sS{constructor(e){this._statsInfo=e,this._originalValues={},this._aggregateValues={}}isDiffMethod(e){return"diff"==e||"last2"==e||"rate"===e}addStats(e,t){const i=this._statsInfo[e];let n=this._originalValues[e];if(void 0===n&&(n={raw:[],calc:[],lastTime:Date.now(),beginTime:Date.now()},this._originalValues[e]=n),this.isDiffMethod(i.calculation_method)){n.raw.push(t);const e=Date.now(),r=n.lastTime;n.lastTime=e,n.raw.length>1?(t=n.raw[n.raw.length-1]-n.raw[n.raw.length-2],"rate"===i.calculation_method&&(t=t/(e-r)*1e3),void 0!==i.multiplier&&(t*=i.multiplier),!0===i.integer&&(t|=0),n.calc.push(t)):"rate"===i.calculation_method&&(t=0)}else void 0!==i.multiplier&&"number"==typeof t&&(t*=i.multiplier),!0===i.integer&&(t|=0),n.raw.push(t);return t}aggregate(){const e={};for(const[t,i]of Object.entries(this._originalValues)){const n=this._statsInfo[t];if(void 0===n||!1===n.show)continue;this.isDiffMethod(n.calculation_method)&&i.raw.length>0&&(e[t]={raw:[i.raw[i.raw.length-1]],calc:[],lastTime:i.lastTime,beginTime:0});let r=this._aggregateValues[t];void 0===r&&(r={raw:[],timestamp:new Date(i.beginTime)},n.aggregation_needed&&(r.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[t]=r);const s=i.calc?.length?i.calc:i.raw;let a=s;if(n.aggregation_needed&&r.aggregation){const e=s.filter((e=>"number"==typeof e&&!isNaN(e)));r.aggregation.count.push(e.length),r.aggregation.sum.push(Fm(e)),r.aggregation.max.push(xm(e)),r.aggregation.min.push(Um(e)),a=e}n.raw_data_reduction&&a.length>0&&(r.reduced=r.reduced||[],r.reduced.push(a[a.length-1])),a.forEach((e=>r.raw.push(e)))}this._originalValues=e}popAggregates(){const e={};for(const[t,i]of Object.entries(this._aggregateValues))e[this._statsInfo[t].name??t]=i;return this._aggregateValues={},e}}class aS{constructor(e,t,i){if(this._tsCall=e,this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=new Map,i.aggregationInterval<1)throw new I({defaultError:f.FEATURES.LIVE_STREAM.INVALID_AGGREGATION_INTERVAL_RANGE});if(i.dataPointsPerAggregation<1)throw new I({defaultError:f.FEATURES.LIVE_STREAM.INVALID_DATAPOINTS_AGGREGATION_RANGE});this._logger=t.createChild("LiveStreamStatsCollector"),this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1}),this._callStateChanged=Nu(),this._statsPoller=i.statsPoller,this._statsInfo=i.statsInfo,this._aggregationInterval=i.aggregationInterval,this._dataPointsPerAggregation=i.dataPointsPerAggregation,this._isInternal=i.isInternal,this._dataEventListener=e=>{void 0!==e&&this._processData(e)},this._statsPoller.on("data",this._dataEventListener);const n=[3,10];let r=n.includes(this._tsCall.state);this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{r!==n.includes(this._tsCall.state)&&(r=!r,this._callStateChanged.resolve(r))})),this._run()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._disposed||(this._disposed=!0,this._callStateChangedHandle.dispose(),this._callStateChanged.resolve(!1),this._statsPoller.off("data",this._dataEventListener),this._eventEmitter.emit("dispose"),this._eventEmitter.removeAllListeners())}_processData(e){const t={},i=Object.keys(e);0!==i.length&&(i.forEach((i=>{const n=e[i],r={};let s=this._calculators.get(i);s||(s=new sS(this._statsInfo),this._calculators.set(i,s));for(const[e,t]of Object.entries(n)){const i=this._statsInfo[e];if(i&&!1!==i.show&&(this._isInternal||!i.is_internal)){const n=s.addStats(e,t);r[i.name??e]=n}}t[i]=r})),Object.keys(t).length>0&&this._eventEmitter.emit("sampleReported",t))}async _run(){let e=0;const t=e=>(Object.keys(e).forEach((t=>{e[t].reduced&&!this._isInternal&&delete e[t].reduced})),e),i=()=>{if(0===this._calculators.size||0===e)return;const i=[],n={};this._calculators.forEach(((e,r)=>{const s=t(e.popAggregates());0===Object.keys(s).length?i.push(r):(s.reduced&&!this._isInternal&&delete s.reduced,n[r]=s)}));try{this._eventEmitter.emit("summaryReported",n)}catch(e){this._logger.error(`summary event: ${e}`)}i.forEach((e=>{this._calculators.delete(e)})),e=0},n=[3,10];let r=1e3*this._aggregationInterval;for(;!this._disposed;){if(n.includes(this._tsCall.state)){r>0&&await Fu((()=>this._callStateChanged.promise),r).catch((e=>{}));const t=Date.now();this._calculators.size>0&&(this._calculators.forEach((e=>{e.aggregate()})),e++,e===this._dataPointsPerAggregation&&i());const n=Date.now();r=t+1e3*this._aggregationInterval-n}else i(),this._calculators.clear(),await this._callStateChanged.promise.catch((e=>{})),r=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=Nu())}i()}}class oS extends Jm{constructor(e,t,i,n){super(e,t.createChild("LiveStreamStatsPoller"),i.fetchInterval,i.pollingMethod),this._liveStreams=n}async getStats(){const e={};return this._liveStreams.forEach(((t,i)=>{try{const i=t.tsStream.getStats();if(i){const t=i.id.toString(),n={id:t};"number"==typeof i.player_downloadBitrate&&(n.videoBitrate=i.player_downloadBitrate),"number"==typeof i.player_audioDownloadBitrate&&(n.audioBitrate=i.player_audioDownloadBitrate),"number"==typeof i.player_totalDownloadedBytes&&(n.downloadBitrate=i.player_totalDownloadedBytes,n.totalDownloadBytes=i.player_totalDownloadedBytes),"number"==typeof i.player_videoBufferLength&&(n.bufferLengthInMs=Math.round(1e3*i.player_videoBufferLength)),void 0!==i.player_mediaHeight&&(n.videoHeight=i.player_mediaHeight),void 0!==i.player_mediaWidth&&(n.videoWidth=i.player_mediaWidth),void 0!==i.player_playerHeight&&(n.playerHeight=i.player_playerHeight),void 0!==i.player_playerWidth&&(n.playerWidth=i.player_playerWidth),"number"==typeof i.player_mediaDelay&&(n.mediaDelayInMs=Math.round(1e3*i.player_mediaDelay)),"number"==typeof i.player_currentPlayPosition&&(n.currentPlayPosition=Math.round(1e3*i.player_currentPlayPosition)/1e3),e[t]=n}}catch(e){this._logger.error(`fetch live stream stats failed: ${e}`)}})),Object.keys(e).length>0?e:void 0}}class cS{constructor(e,t,i){this._tsCall=e,this._telemetryLogManager=t,this._config=i}log(e){Object.entries(e).forEach((([e,t])=>{const i={id:e},n={id:e};if(Object.entries(t).forEach((([e,t])=>{const r=e,s={};if(this._config.dataToSend.raw){const e={};t?.timestamp&&(e.timestamp=t.timestamp),t?.raw&&(e.raw=t?.raw),void 0===e.raw&&delete n[r],n[r]=e}void 0!==t?.aggregation?(t?.timestamp&&(s.timestamp=t?.timestamp),this._config.dataToSend.min&&(s.min=t?.aggregation.min),this._config.dataToSend.max&&(s.max=t?.aggregation.max),this._config.dataToSend.sum&&(s.sum=t?.aggregation.sum),this._config.dataToSend.count&&(s.count=t?.aggregation.count),t?.aggregation.sum&&t?.aggregation.count&&(s.average=Fm(t?.aggregation.sum)/Fm(t?.aggregation.count))):(t?.timestamp&&(s.timestamp=t.timestamp),t?.reduced?s.raw=t?.reduced:void 0!==t?.raw&&(s.raw=t?.raw)),i[r]=s})),Object.keys(i).length>1){const e={stats:i,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamStatsEvent(e)}if(this._config.dataToSend.raw&&Object.keys(n).length>1){const e={stats:n,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamRawStatsEvent(e)}}))}_sendLiveStreamStatsEvent(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_livestream_stats,tenant:uc,properties:e})}_sendLiveStreamRawStatsEvent(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_livestream_raw_stats,tenant:uc,properties:e})}}class lS{constructor(e,t,i,n){this._tsCall=e,this._logger=t,this._collectors=[],this._disposed=!1,this._externalStatsInfo={};const r=yl().telemetry.liveStreamStatsConfig;this._config=r,this._statsPoller=new oS(this._tsCall,this._logger,r,n);const s={...jc,...r.additionalStats};if(Object.entries(s).filter((([,e])=>!e.is_internal)).forEach((([e,t])=>{this._externalStatsInfo[e]=t})),r.enabled){const e=new aS(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:r.aggregationInterval,dataPointsPerAggregation:r.dataPointsPerAggregation,statsInfo:s,isInternal:!0}),t=new cS(this._tsCall,i,r);e.on("summaryReported",(e=>{t.log(e)})),this._collectors.push(e)}}createStatsCollector(e){if(this._disposed)throw new I({defaultError:f.FEATURES.LIVE_STREAM.DISPOSED});const t=this._config,i=new aS(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:e?.aggregationInterval??t.aggregationInterval,dataPointsPerAggregation:e?.dataPointsPerAggregation??t.dataPointsPerAggregation,statsInfo:this._externalStatsInfo,isInternal:!1});return i.on("dispose",(()=>{this._collectors=this._collectors.filter((e=>e!==i))})),this._collectors.push(i),i}dispose(){this._disposed||(this._disposed=!0,this._collectors.forEach((e=>{e.dispose()})))}}class dS{constructor(e,t){this._featureName=e,this._targetBotIds=t,this._streamIdToStreamMap=new Map}initialize(e,t,i,n,r){this._logger=r.createChild((()=>`${this._featureName}::Call(id='${e.callId}')`)),this._telemetryLogManager=n,this._call=i,this._tsCall=e,this.observeBotParticipantsAlreadyInCall(),this._tsCall.on("participantAdded",(async e=>{this.observeBotParticipantJustJoinedCall(e)})),this._tsCall.on("participantRemoved",(async e=>{this.removeStreamOfTheBotJustRemovedFromCall(e)}))}disposeAllBotStreams(){this._streamIdToStreamMap.forEach((e=>e.dispose())),this._streamIdToStreamMap.clear()}observeBotParticipantsAlreadyInCall(){this._tsCall.participants.forEach((e=>{this.isExpectedBotParticipant(e)&&(this._logger.info(`${this._featureName} Bot already in the call`),this.observeBotParticipant(e))}))}observeBotParticipantJustJoinedCall(e){this.isExpectedBotParticipant(e)&&(this._logger.info(`${this._featureName} Bot added`),this.observeBotParticipant(e))}removeStreamOfTheBotJustRemovedFromCall(e){if(this.isExpectedBotParticipant(e)){this._logger.info(`${this._featureName} Bot removed`);const t=[];this.removeAllStreams(e,t),this.checkVideoStreamAddedOrRemoved([],t)}}observeBotParticipant(e){e.changed((()=>{this._logger.info(`${this._featureName} Bot - changed event triggered. state: ${e.state}`),this._mapStreams(e)})),this._logger.info(`Composition Bot state: ${e.state}`),this._mapStreams(e)}_mapStreams(e){const t=[],i=[],n=n=>{if(e)if(gl(e.streams&&e.streams[n])){let r=e.streams[n];this._logger.log(`Stream Type: ${n}`),r.forEach((i=>{if(void 0===i.id&&(i.id=-1),!this._streamIdToStreamMap.get(i.id)){const n=this.createConcreteVideoStream(i,e.id);this._logger.log(`${this._featureName} stream created, type==${n.mediaStreamType} id=${i.id}`),t.push(n)}})),this._streamIdToStreamMap.forEach((t=>{t.tsParticipantId!==e.id||r.some((e=>e.id===t.id))||i.push(t)}))}else this.removeAllStreams(e,i)};this.getStreamTypes().forEach((e=>n(e))),this.checkVideoStreamAddedOrRemoved(t,i)}removeAllStreams(e,t){this._streamIdToStreamMap.forEach((i=>{i.tsParticipantId===e.id&&t.push(i)}))}checkVideoStreamAddedOrRemoved(e,t){if(e.length>0||t.length>0){const i=e=>{this._streamIdToStreamMap.set(e.id,e)},n=e=>{const t=this._streamIdToStreamMap.get(e.id);t&&(this._logger.log(`stream removed, type==${t.mediaStreamType} id=${e.id}`),this._streamIdToStreamMap.delete(e.id),t.dispose())};e.forEach(i),t.forEach(n),this.emitVideoStreamsUpdatedEvent({added:e,removed:t})}}isExpectedBotParticipant(e){return this._targetBotIds.includes(e.id)}}class hS extends dS{constructor(e,t){super(t,yl().calling.liveStreamingBotIds),this._eventEmitter=e}initialize(e,t,i,n,r){super.initialize(e,t,i,n,r),this._statsManager=new lS(e,r,n,this._streamIdToStreamMap),this._tsCall.participantCounts&&null!=this._tsCall.participantCounts.streamingClients&&(this._participantCount=this._tsCall.participantCounts.streamingClients),this._tsCall.on("participantCountsUpdated",(()=>{if(this._tsCall.participantCounts&&this._participantCount!==this._tsCall.participantCounts.streamingClients){const e=this._participantCount;this._participantCount=this._tsCall.participantCounts.streamingClients,this._logger.log(`tsCall participantCount changed from ${e} to ${this._participantCount}`),this._eventEmitter.emit("participantCountChanged")}}))}dispose(){super.disposeAllBotStreams(),this._statsManager.dispose()}createStatsCollector(e){return this._statsManager.createStatsCollector(e)}get liveStreams(){return[...this._streamIdToStreamMap.values()].map((e=>e))}get streamingClientCount(){return this._participantCount??0}createConcreteVideoStream(e,t){return new uS(e,this._logger,this._call,this._callAgent,t,this._telemetryLogManager)}getStreamTypes(){return[2]}emitVideoStreamsUpdatedEvent(e){return this._eventEmitter.emit("liveStreamsUpdated",e)}}class uS extends rS{constructor(e,t,i,n,r,s){super(e,t,i,r,s,"LiveVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class gS extends dS{constructor(e,t){super(t,yl().calling.composedStreamBotIds),this._eventEmitter=e}initialize(e,t,i,n,r){super.initialize(e,t,i,n,r)}dispose(){super.disposeAllBotStreams()}get composedStreams(){return[...this._streamIdToStreamMap.values()].map((e=>e))}createConcreteVideoStream(e,t){return new pS(e,this._logger,this._call,this._callAgent,t,this._telemetryLogManager)}getStreamTypes(){return[0]}emitVideoStreamsUpdatedEvent(e){return this._eventEmitter.emit("composedStreamsUpdated",e)}}class pS extends rS{constructor(e,t,i,n,r,s){super(e,t,i,r,s,"ComposedVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class mS{constructor(e,t){this._logger=e,this._environmentInfo=t,this._videoEffectsEnabled=!1,this._audioEffectsEnabled=!1,this._videoEffectsSupported=!1,this._audioEffectsSupported=!1,this._config=yl(),this._mediaConfig=Cl(),this._videoEffectsEnabled=!(!this._mediaConfig?.enableVideoEffects||!this._config?.videoEffects?.enableVideoEffects),this._audioEffectsEnabled=!!this._config?.audioEffects?.enableAudioEffects,this._videoEffectsEnabled&&(this._videoEffectsSupported=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported())}async videoEffectsSupported(){if(this._videoEffectsEnabled){const e=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported();this._videoEffectsSupported=e&&this._isCurrentEnvironmentSDKSupported()}else this._logger.info("Video effects are disabled."),this._videoEffectsSupported=!1;return this._videoEffectsSupported}async audioEffectsSupported(e){return this._audioEffectsEnabled?this._audioEffectsSupported=this._isBrowserEffect(e)?this._isBrowserEffectSupported(e):await this._isWasmAudioEffectSupported():(this._logger.info("Audio effects are disabled."),this._audioEffectsSupported=!1),this._audioEffectsSupported}_isBrowserEffect(e){if("string"==typeof e)switch(e){case"BrowserEchoCancellation":case"BrowserNoiseSuppression":case"BrowserAutoGainControl":return!0;default:return!1}return!1}_isBrowserEffectSupported(e){const t=window.navigator?.mediaDevices?.getSupportedConstraints?.();if(t)switch(e){case"BrowserEchoCancellation":return!!t.echoCancellation;case"BrowserNoiseSuppression":return!!t.noiseSuppression;case"BrowserAutoGainControl":return!!t.autoGainControl;default:return!1}return!1}_isCurrentEnvironmentSDKSupported(){return!!(this._environmentInfo.isSupportedBrowser&&this._environmentInfo.isSupportedBrowserVersion&&this._environmentInfo.isSupportedEnvironment&&this._environmentInfo.isSupportedPlatform)}_isWasmVideoEffectSupported(){return this._mediaConfig?.webcv?.useWasmEffects?!!window.MediaStreamTrackProcessor||(this._logger.info("WASM effects disabled, insertable streams are not supported"),!1):(this._logger.info("WASM effects disabled by WebCV feature flag"),!1)}_isWebgl2EffectSupported(){return this._isCurrentRendererSupported()&&this._isWebGL2Supported()}_isCurrentRendererSupported(){const e=this._mediaConfig?.webcv?.webGLUnsupportedRenderers??[];let t=!1;try{const i=document.createElement("canvas").getContext("webgl"),n=i?.getExtension("WEBGL_debug_renderer_info"),r=n&&i?.getParameter(n.UNMASKED_RENDERER_WEBGL);return r&&!e.some((e=>e===r))?t=!0:this._logger.info(`Unsupported renderer: ${Il(r)}`),t}catch(e){return this._logger.warn(`Error trying to check compatibility: ${JSON.stringify(e)}`),!1}}_isWebGL2Supported(){try{const e=document.createElement("canvas").getContext("webgl2");if(!e)return this._logger.info("WebGL2 context is not supported"),!1;const t=e.getSupportedExtensions(),i=this._mediaConfig?.webcv?.webGLRequiredExtensions.filter((e=>!t?.includes(e)));if(i.length>0)return this._logger.info(`Unsupported WebGL2 extensions: ${Il(i)}`),!1}catch(e){return this._logger.error(`isWebGL2Supported: ${Il(e)}`),!1}return!0}async _isWasmAudioEffectSupported(){return window.AudioWorkletNode?!!window.WebAssembly||(this._logger.info("WebAssembly is not supported"),!1):(this._logger.info("AudioWorkletNode is not supported"),!1)}}const fS=[{acsEffect:"Off",tsCallingEffect:0},{acsEffect:"BackgroundBlur",tsCallingEffect:1},{acsEffect:"BackgroundReplacement",tsCallingEffect:16}];class SS{constructor(e){this._tsCall=e,this._activeParticipantMris=new Set,this._participantMriToSourceId=new Map,this._sourceIdToParticipantMri=new Map,this._sourceIdToParticipantId=new Map,this._listenerHandles=[],this._eventEmitter=new ep.EventEmitter,this._listenerHandles.push(this._tsCall.on("participantAdded",(e=>{this._activeParticipantMris.add(e.id),this._updateMapping(e),this._eventEmitter.emit("participantAdded",e.id)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(e=>{this._activeParticipantMris.has(e.id)&&this._updateMapping(e)&&this._eventEmitter.emit("participantUpdated",e.id)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(e=>{this._activeParticipantMris.delete(e.id),this._removeMapping(e),this._eventEmitter.emit("participantRemoved",e.id)}))),this._tsCall.participants.forEach((e=>{this._activeParticipantMris.add(e.id),this._updateMapping(e)}))}_updateMapping(e){const t=e.id,i=[];e.endpoints?.endpointDetails?.forEach((e=>{const t=e.mediaStreams?.find((e=>"data"===e.type));t&&(i.push(t.sourceId),this._sourceIdToParticipantId.set(t.sourceId,e.participantId))}));const n=this._participantMriToSourceId.get(t);return i.sort(),!p.isEqual(i,n)&&(this._participantMriToSourceId.set(t,i),i.forEach((e=>{this._sourceIdToParticipantMri.set(e,t)})),!0)}_removeMapping(e){const t=e.id,i=this._participantMriToSourceId.get(t)||[];this._participantMriToSourceId.delete(t),i.forEach((e=>{this._sourceIdToParticipantMri.delete(e),this._sourceIdToParticipantId.delete(e)}))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}findParticipantMri(e){let t=this._sourceIdToParticipantMri.get(e);return void 0===t&&this.isP2P()&&this._tsCall.participants.length&&(t=this._tsCall.participants[0].id),t}findParticipantId(e){let t=this._sourceIdToParticipantId.get(e);if(void 0===t&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const e=this._tsCall.participants[0].endpoints?.endpointDetails[0];t=e.participantId}return t}findSourceIds(e){return this._participantMriToSourceId.get(e)??[]}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._participantMriToSourceId.clear(),this._sourceIdToParticipantMri.clear(),this._sourceIdToParticipantId.clear(),this._listenerHandles.forEach((e=>e.dispose())),this._eventEmitter.removeAllListeners()}}const vS=2147483648,yS=65535,CS=1024,_S=4294967295;function ES(e,t){return new I({defaultError:f.FEATURES.DATA_CHANNEL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[t,e]})}function TS(e,t){return new I({defaultError:f.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_TYPE,defaultErrorMessageArgs:[e,t]})}function IS(e,t){return new I({defaultError:f.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_VALUE,defaultErrorMessageArgs:[e,t]})}function bS(){return new I({defaultError:f.FEATURES.DATA_CHANNEL.NO_AVAILABLE_CHANNEL_ID})}function AS(){return new I({defaultError:f.FEATURES.DATA_CHANNEL.INVALID_CHANNEL_ID})}function RS(){return new I({defaultError:f.FEATURES.DATA_CHANNEL.TOO_MANY_PARTICIPANTS})}function wS(){return new I({defaultError:f.FEATURES.DATA_CHANNEL.NO_AVAILABLE_UNRELIABLE_CHANNEL})}function PS(){return new I({defaultError:f.FEATURES.DATA_CHANNEL.TRAFFIC_LIMITED})}function MS(e){return e?.message??"Unknown"}function DS(e,t,i){const n=i.value;return i.value=function(...e){try{return n?.apply(this,e)}catch(e){throw this?._logger?.error(`${t}: ${MS(e)}`),e}},i}class OS{constructor(){this._firstByte=0,this._channelVersion=0,this._channelId=0,this._sequenceNumber=0}static parse(e){if(e.length<OS.headerLength)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.INVALID_MSG_LENGTH});const t=new DataView(e.buffer),i=t.getUint8(0),n=t.getUint8(1),r=t.getUint16(2),s=t.getUint32(4),a=e.slice(OS.headerLength),o=new OS;return o._firstByte=i,o._channelVersion=n,o._channelId=r,o._sequenceNumber=s,o._data=a,o._serializedData=e,o}static create(e,t,i,n){const r=new OS,s=new Uint8Array(OS.headerLength+n.length),a=new DataView(s.buffer);return t&=255,e&=65535,i>>>=0,a.setUint8(0,0),a.setUint8(1,t),a.setUint16(2,e),a.setUint32(4,i),s.set(n,OS.headerLength),r._channelVersion=t,r._channelId=e,r._sequenceNumber=i,r._data=n,r._serializedData=s,r}get channelId(){return this._channelId}set channelId(e){this._channelId=e}get channelVersion(){return this._channelVersion}get sequenceNumber(){return this._sequenceNumber}get data(){return this._data}get serializedData(){return this._serializedData}isInternal(){return!!(128&this._firstByte)}isEmpty(){return 0===this._data.length}}var kS;OS.headerLength=8,(kS=e.DataChannelState||(e.DataChannelState={}))[kS.Initializing=0]="Initializing",kS[kS.Initialized=1]="Initialized",kS[kS.Started=2]="Started",kS[kS.Stopped=3]="Stopped",kS[kS.Destroyed=4]="Destroyed";class NS{constructor(t,i){this._eventEmitter=new ep.EventEmitter,this._state=e.DataChannelState.Initializing,this._tsCall=t,this._dataId=i}async initialize(){const t={onStarted:async(t,i,n)=>{this._dataSendFunction=i,this._getStats=n,this._state=e.DataChannelState.Started,this._eventEmitter.emit("stateChanged",this._state)},onStopped:async t=>{this._dataSendFunction=void 0,this._getStats=void 0,this._state=e.DataChannelState.Stopped,this._eventEmitter.emit("stateChanged",this._state)},onDataReceived:async(e,t,i)=>{const n={sourceId:i,data:t};this._eventEmitter.emit("message",n)}};await(this._tsCall.dataChannelAdapter?.addHandler(this._dataId,t)),this._state<e.DataChannelState.Initialized&&(this._state=e.DataChannelState.Initialized)}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}send(e,t){return this._dataSendFunction?this._dataSendFunction(e,t):Promise.reject(new I({defaultError:f.FEATURES.DATA_CHANNEL.SENDER_NOT_READY}))}getStats(){return this._getStats?this._getStats():Promise.resolve({bufferSize:0,remainingBytes:0,remainingPackets:0})}get state(){return this._state}dispose(){if(this._state===e.DataChannelState.Destroyed)return;const t=this._state;this._state=e.DataChannelState.Destroyed,this._dataSendFunction=void 0,this._getStats=void 0,t!==e.DataChannelState.Initializing&&this._tsCall.dataChannelAdapter?.removeHandler(this._dataId).catch(kl),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners()}}class LS{constructor(e,t,i){const n=e.dataId;this._logger=i.createChild(`DataChannelProcessor(${n})`),this._eventEmitter=new Nm(this._logger,{enableLogOn:!1,enableLogOff:!1,enableLogOnce:!1,enableLogEmit:!1}),this._bufferFullErrorMessage=`dataId ${n} send queue is full`,this._dataChannelAdapter=new NS(t,n),this._dataChannelAdapter.on("message",(e=>{try{const t=e.sourceId,i=OS.parse(e.data),n={sourceId:t,message:i};i.isInternal()?this._eventEmitter.emit("internalMessage",n):this._eventEmitter.emit("message",n)}catch(e){this._logger.error(`process message error: ${MS(e)}`)}}))}async initialize(){await this._dataChannelAdapter.initialize()}async send(e){try{if(void 0===e.recipients)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.NO_VALID_PARTICIPANT});if(e.recipients.length>64)throw RS();await this._dataChannelAdapter.send(e.data,e.recipients)}catch(e){throw e?.message===this._bufferFullErrorMessage?new I({defaultError:f.FEATURES.DATA_CHANNEL.BUFFER_FULL}):new I({defaultError:f.FEATURES.DATA_CHANNEL.SEND_FAIL,originalError:e})}}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._eventEmitter.removeAllListeners(),this._dataChannelAdapter.dispose()}}class xS{constructor(e){this._sourceIds=[],this._participantMappingManager=e,this._participantMapping=new Map,e.on("participantAdded",(e=>{if(this._participantMapping.has(e)){const t=this._participantMappingManager.findSourceIds(e);this._participantMapping.set(e,t),this._updateSourceIds()}})),e.on("participantUpdated",(e=>{if(this._participantMapping.has(e)){const t=this._participantMappingManager.findSourceIds(e);this._participantMapping.set(e,t),this._updateSourceIds()}})),e.on("participantRemoved",(e=>{this._participantMapping.has(e)&&(this._participantMapping.set(e,[]),this._updateSourceIds())}))}get sourceIds(){if(this._participantMappingManager.isP2P()||!(this._participantMapping.size>0)||0!==this._sourceIds.length)return this._sourceIds}setParticipants(e){const t=[];e.forEach((e=>{ol(e),t.push(rl(e))})),this._participantMapping.clear(),t.forEach((e=>{const t=this._participantMappingManager.findSourceIds(e);this._participantMapping.set(e,t)})),this._updateSourceIds()}_updateSourceIds(){this._sourceIds=Array.from(this._participantMapping.values()).flat()}}var US,FS=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},VS=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.Open=0]="Open",e[e.Closed=1]="Closed",e[e.Destroyed=2]="Destroyed"}(US||(US={}));class BS{constructor(e,t,i,n,r,s){this._state=US.Open;const a=yl().dataChannel;this._eventEmitter=new ep.EventEmitter,this._channelId=e,this._channelVersion=t,this._sequenceNumber=Math.floor(Math.random()*(_S+1)),this._recipientsManager=new xS(n),this._dataChannelMonitor=r,this._sendMessageFunction=i,this._maxMessageSize=a.maxMessageSize,this._logger=s.createChild(`DataChannelSender(${e},${t})`),this._logger.info("opened")}get channelId(){return this._channelId}get maxMessageSize(){return this._maxMessageSize}setParticipants(e){if(!Array.isArray(e))throw TS("participants","CommunicationIdentifier[]");if(e.length>64)throw RS();this._recipientsManager.setParticipants(e),this._logger.info(`participant size: ${e.length}`)}async sendMessage(e){if(this._dataChannelMonitor.updateAttemptStats(e.length),!(e instanceof Uint8Array))throw TS("data","Uint8Array");if(this._state===US.Closed)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.SENDER_CLOSED});if(0===e.length)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.MSG_DATA_EMPTY});if(e.length>this._maxMessageSize)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.MSG_DATA_TOO_LARGE});const t=this._recipientsManager.sourceIds;await this._sendMessage(e,t),this._dataChannelMonitor.updateCommitStats(e.length)}close(){this._state<US.Closed&&(this._sendMessage(new Uint8Array,[]).catch(kl),this._state=US.Closed,this._eventEmitter.emit("close"),this._logger.info("closed"),this._dataChannelMonitor.close())}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this.close(),this._state!==US.Destroyed&&(this._eventEmitter.removeAllListeners(),this._state=US.Destroyed,this._logger.info("disposed"))}get channelVersion(){return this._channelVersion}get state(){return this._state}async _sendMessage(e,t){const i=OS.create(this._channelId,this._channelVersion,this._sequenceNumber,e);this._sequenceNumber=(this._sequenceNumber+1)%(_S+1);const n={channelId:this._channelId,channelVersion:this._channelVersion,recipients:t,data:i.serializedData};await this._sendMessageFunction(n)}}FS([DS,VS("design:type",Function),VS("design:paramtypes",[Array]),VS("design:returntype",void 0)],BS.prototype,"setParticipants",null),FS([function(e,t,i){const n=i.value;return i.value=async function(...e){try{return await(n?.apply(this,e))}catch(e){throw this?._logger?.error(`${t}: ${MS(e)}`),e}},i},VS("design:type",Function),VS("design:paramtypes",[Uint8Array]),VS("design:returntype",Promise)],BS.prototype,"sendMessage",null),FS([DS,VS("design:type",Function),VS("design:paramtypes",[]),VS("design:returntype",void 0)],BS.prototype,"close",null),FS([DS,VS("design:type",Function),VS("design:paramtypes",[]),VS("design:returntype",void 0)],BS.prototype,"dispose",null);class HS{constructor(e){this.value=e,this.next=void 0}}class $S{constructor(){this.length=0,this.front=void 0,this.rear=void 0}enqueue(e){const t=new HS(e);this.front?(this.rear.next=t,this.rear=t):(this.front=t,this.rear=t),this.length++}dequeue(){if(!this.front)return;const e=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,e.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}isEmpty(){return 0===length}clear(){this.front=void 0,this.rear=void 0,this.length=0}}var GS,jS=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},qS=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.Open=0]="Open",e[e.Closed=1]="Closed",e[e.Destroyed=2]="Destroyed"}(GS||(GS={}));class WS{constructor(e,t,i,n,r,s){this._receiveBuffers=new $S,this._remainingBytes=0,this._state=GS.Open,this._channelVersion=0;const a=yl().dataChannel;this._logger=s.createChild(`DataChannelReceiver(${e},${n},${i})`),this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1}),this._maxBufferSize=a.maxReceiveBufferSize,this._dataChannelMonitor=r,this._channelId=e,this._senderParticipantIdentifier=sl(t),this._channelVersion=n,this._lastMessageTimestamp=Date.now(),this._logger.info("created.")}get channelId(){return this._channelId}get senderParticipantIdentifier(){return this._senderParticipantIdentifier}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}readMessage(){const e=this._receiveBuffers.dequeue();return e?.data&&(this._remainingBytes-=e.data.length),e}dispose(){this._state!==GS.Destroyed&&(this.close(),this._state=GS.Destroyed,this._receiveBuffers.clear(),this._eventEmitter.removeAllListeners())}close(){this._state===GS.Open&&(this._state=GS.Closed,this._eventEmitter.emit("close"),this._dataChannelMonitor.close())}get channelVersion(){return this._channelVersion}get lastMessageTimestamp(){return this._lastMessageTimestamp}get state(){return this._state}appendMessage(e){if(this._dataChannelMonitor.updateAttemptStats(e.data.length),this._state!==GS.Open)return;if(0===e.data.length)return void this.close();if(this._lastMessageTimestamp=Date.now(),this._remainingBytes+e.data.length>this._maxBufferSize)return;const t={sequenceNumber:e.sequenceNumber,data:e.data};this._receiveBuffers.enqueue(t),this._remainingBytes+=e.data.length,this._eventEmitter.emit("messageReady"),this._dataChannelMonitor.updateCommitStats(e.data.length)}}jS([DS,qS("design:type",Function),qS("design:paramtypes",[]),qS("design:returntype",Object)],WS.prototype,"readMessage",null),jS([DS,qS("design:type",Function),qS("design:paramtypes",[OS]),qS("design:returntype",void 0)],WS.prototype,"appendMessage",null);class zS{constructor(e,t,i){this._timeoutHandle=0;const n=yl().dataChannel;this._eventEmitter=new ep.EventEmitter,this._participantMappingManager=e,this._dataChannelMonitor=t,this._logger=i,this._receivers=new Map,this._lastestVersion=new Map,this._receiveTimeoutInMs=n.receiveTimeoutInMs}_checkTimeoutReceivers(){Array.from(this._receivers.keys()).forEach((e=>{const t=this._receivers.get(e);void 0!==t&&Date.now()-t.lastMessageTimestamp>=this._receiveTimeoutInMs&&t.close()})),this._receivers.size>0&&(this._timeoutHandle=window.setTimeout((()=>{this._timeoutHandle=0,this._checkTimeoutReceivers(),Math.ceil(this._receiveTimeoutInMs/2)})))}appendMessage(e){const t=`${e.sourceId},${e.message.channelId}`,i=`${e.sourceId},${e.message.channelId},${e.message.channelVersion}`;let n=this._lastestVersion.get(t),r=this._receivers.get(i);const s=e.message;if(void 0===r){if(void 0!==n&&-1===function(e,t){if(e===t)return 0;if(-1===t)return 1;const i=e-t;return i>0?i<127.5?1:-1:-i>127.5?1:-1}(s.channelVersion,n))return;if(this._lastestVersion.set(t,s.channelVersion),s.isEmpty())return;if(0===this._eventEmitter.listenerCount("dataChannelReceiverCreated"))return;const a=this._participantMappingManager.findParticipantMri(e.sourceId)??"",o=this._participantMappingManager.findParticipantId(e.sourceId)??"",c=this._dataChannelMonitor.createReceiverMonitor(s.channelId,s.channelVersion,o);if(""===a)return void this._logger.info(`Unable to find corresponding sender mri, ignoring the message. channelId:${s.channelId}, sourceId:${e.sourceId}`);this._logger.info(`channelId:${s.channelId} message from ${o}, sourceId:${e.sourceId}, channelVersion:${s.channelVersion}`),r=new WS(s.channelId,a,e.sourceId,s.channelVersion,c,this._logger),r.on("close",(()=>{this._receivers.delete(i)})),this._receivers.set(i,r),this._eventEmitter.emit("dataChannelReceiverCreated",r),0===this._timeoutHandle&&this._checkTimeoutReceivers()}r.appendMessage(s),s.isEmpty()&&this._receivers.delete(i)}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){window.clearTimeout(this._timeoutHandle),this._timeoutHandle=0,this._receivers.forEach(((e,t)=>{e.dispose()})),this._lastestVersion.clear(),this._receivers.clear(),this._eventEmitter.removeAllListeners()}}const JS=64512;class KS{constructor(e){this._channelIdsInUse=e}findAvailableChannelId(){if(this._channelIdsInUse.size>=JS)throw bS();let e;for(;(e=Math.floor(Math.random()*JS)+CS)&&this._channelIdsInUse.has(e););return e}}class YS{constructor(e){this._availableChannelIds=[],this._channelIdsInUse=e,this._initArray()}findAvailableChannelId(){if(0===this._availableChannelIds.length){if(this._channelIdsInUse.size>=JS)throw bS();this._initArray()}return this._availableChannelIds.pop()}_initArray(){const e=Array.from(this._channelIdsInUse,(e=>e)).sort();let t=0,i=0;for(;t<=yS&&i<e.length;)t<e[i]?(this._availableChannelIds.push(t),t++):(t>e[i]||t++,i++);for(;t<=yS;)this._availableChannelIds.push(t),t++;this._availableChannelIds=p.shuffle(this._availableChannelIds)}}class QS{constructor(){this._channelIdsInUse=new Set,this._highWaterMark=Math.ceil(.8*JS),this._lowWaterMark=Math.floor(.4*JS),this._strategy=new KS(this._channelIdsInUse)}addChannelId(e){e>=CS&&e<=yS&&(this._channelIdsInUse.add(e),this._channelIdsInUse.size>=this._highWaterMark&&this._strategy instanceof KS&&(this._strategy=new YS(this._channelIdsInUse)))}removeChannelId(e){this._channelIdsInUse.delete(e),this._channelIdsInUse.size<this._lowWaterMark&&this._strategy instanceof YS&&(this._strategy=new KS(this._channelIdsInUse))}findAvailableChannelId(){return this._strategy.findAvailableChannelId()}}class XS{constructor(e){this._dataIds=[],this._channelIds=new Map,e.forEach((e=>{this._dataIds.push({dataId:e.dataId,bandwidth:e.bandwidth,allocatedBandwidth:0})}))}allocate(e){const t=p.maxBy(this._dataIds,(t=>1-(t.allocatedBandwidth+e.bitrate)/t.bandwidth));if(void 0===t)throw new I({defaultError:f.FEATURES.DATA_CHANNEL.NO_AVAILABLE_RELIABLE_CHANNEL});return t.allocatedBandwidth+=e.bitrate,this._channelIds.set(e.channelId,{dataId:t.dataId,allocatedBandwidth:e.bitrate}),t.dataId}deallocate(e){const t=this._channelIds.get(e);if(void 0!==t){const i=this._dataIds.find((e=>e.dataId===t.dataId));void 0!==i&&(i.allocatedBandwidth-=t.allocatedBandwidth),this._channelIds.delete(e)}}getDataIds(e){const t=this._channelIds.get(e);return void 0!==t?[t.dataId]:[]}}class ZS{getDataIds(e){throw wS()}getAllSum(){return 0}}class ev{constructor(e){this._acsDataIdConfigs=[],this._bandwidthList=[],this._acsDataIdConfigs=e,e.forEach((e=>{this._bandwidthList.push(e.bandwidth/1e3)})),this._allSum=p.sumBy(e,(e=>e.bandwidth))}getDataIds(e){let t=[];const i=Math.ceil(e/1e3);if(i>=this._allSum)t=this._acsDataIdConfigs.map((e=>e.dataId));else{const e=this._bandwidthList[0]-1;let n=0;i&e&&(n=this._bandwidthList.findIndex((e=>!(e&i))),-1!==n&&(t.push(this._acsDataIdConfigs[n].dataId),n++));for(let e=n;e<this._bandwidthList.length;e++)this._bandwidthList[e]&i&&t.push(this._acsDataIdConfigs[e].dataId)}return t}getAllSum(){return this._allSum}}class tv{constructor(e){this._bandwidthMap=new Map,this._bandwidthMap.set(0,[]),function(e){const t=[[]];return e.forEach((e=>{const i=[];t.forEach((t=>{i.push([...t,e])})),t.push(...i)})),t}(e).forEach((e=>{const t=p.sumBy(e,(e=>e.bandwidth)),i=this._bandwidthMap.get(t);(void 0===i||e.length<i.length)&&this._bandwidthMap.set(t,e.map((e=>e.dataId)))})),this._bandwidthList=Array.from(this._bandwidthMap.keys()).sort(((e,t)=>e-t))}getDataIds(e){const t=p.sortedIndex(this._bandwidthList,e),i=this._bandwidthList[t]??this._bandwidthList[this._bandwidthList.length-1];return this._bandwidthMap.get(i)||[]}getAllSum(){return p.last(this._bandwidthList)||0}}class iv{constructor(e){(e=p.sortBy(e,(e=>e.bandwidth))).length?function(e){if(e.find((e=>!Number.isInteger(Math.log2(e)))))return!1;for(let t=1;t<e.length;t++)if(e[t]!==2*e[t-1])return!1;return!0}(e.map((e=>e.bandwidth/1e3)))?this._dataIdSelectionStrategy=new ev(e):this._dataIdSelectionStrategy=new tv(e):this._dataIdSelectionStrategy=new ZS}getDataIds(e){return this._dataIdSelectionStrategy.getDataIds(e)}getAllSum(){return this._dataIdSelectionStrategy.getAllSum()}}class nv{constructor(e){this._totalNormalPriorityBandwidth=0,this._totalHighPriorityBandwidth=0,this._configs=new Map,this._currentNormalPriorityDataIds=[],this._currentHighPriorityDataIds=[],this._normalPriorityTable=new iv(e.filter((e=>"normal"===e.priority))),this._highPriorityTable=new iv(e.filter((e=>"high"===e.priority)))}allocate(e){this._configs.set(e.channelId,e),"Normal"===e.priority?this._totalNormalPriorityBandwidth+=e.bitrate:"High"===e.priority&&(this._totalHighPriorityBandwidth+=e.bitrate),this._updateDataIds()}deallocate(e){const t=this._configs.get(e);void 0!==t&&(this._configs.delete(e),"Normal"===t.priority?this._totalNormalPriorityBandwidth-=t.bitrate:"High"===t.priority&&(this._totalHighPriorityBandwidth-=t.bitrate),this._updateDataIds())}getDataIds(e){const t=this._configs.get(e);if(void 0!==t){if("Normal"===t.priority)return this._currentNormalPriorityDataIds;if("High"===t.priority)return this._currentHighPriorityDataIds}return[]}_updateDataIds(){const e=this._highPriorityTable.getAllSum(),t=this._totalHighPriorityBandwidth-e;if(t>0){const e=this._totalNormalPriorityBandwidth+t;this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(e),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth).concat(this._currentNormalPriorityDataIds)}else this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(this._totalNormalPriorityBandwidth),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth)}}class rv{constructor(e){const t=e.filter((e=>"reliable"===e.category)),i=e.filter((e=>"unicast"===e.category)),n=e.filter((e=>"broadcast"===e.category));this._reliableDataIdManager=new XS(t),this._unicastDataIdManager=new nv(i),this._broadcastDataIdManager=new nv(n),this._configs=new Map}allocate(e){let t=-1;if(this._configs.has(e.channelId))throw new I({defaultError:f.FEATURES.DATA_CHANNEL.CHANNEL_ALREADY_ALLOCATED});try{"Durable"===e.reliability?t=this._reliableDataIdManager.allocate(e):(this._unicastDataIdManager.allocate(e),this._broadcastDataIdManager.allocate(e)),this._configs.set(e.channelId,e)}catch(t){throw"Durable"===e.reliability?this._reliableDataIdManager.deallocate(e.channelId):(this._unicastDataIdManager.deallocate(e.channelId),this._broadcastDataIdManager.deallocate(e.channelId)),t}return t}deallocate(e){const t=this._configs.get(e);void 0!==t&&("Durable"===t.reliability?this._reliableDataIdManager.deallocate(e):(this._unicastDataIdManager.deallocate(e),this._broadcastDataIdManager.deallocate(e)),this._configs.delete(e))}getDataIdToSend(e,t,i){const n=this._configs.get(e);if(void 0!==n)return"Durable"===n.reliability?this._reliableDataIdManager.getDataIds(e):i?this._broadcastDataIdManager.getDataIds(e):this._unicastDataIdManager.getDataIds(e);throw function(e){return new I({defaultError:f.FEATURES.DATA_CHANNEL.CANT_FIND_CHANNEL_ID,defaultErrorMessageArgs:[e]})}(e)}}class sv{constructor(e){this._attemptCount=0,this._attemptBytes=0,this._commitCount=0,this._commitBytes=0,this._dataChannelTelemetryLogger=e,this._openTime=new Date,this._closeTime=this._openTime}updateAttemptStats(e){this._attemptCount++,this._attemptBytes+=e}updateCommitStats(e){this._commitCount++,this._commitBytes+=e}close(){this._closeTime=new Date}}class av extends sv{constructor(e,t,i,n){super(n),this._channelId=e,this._channelVersion=t,this._correlationId=i}close(){super.close();const e={direction:"send",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,correlationId:this._correlationId};this._dataChannelTelemetryLogger.sendStatsEvent(e)}}class ov extends sv{constructor(e,t,i,n){super(n),this._channelId=e,this._channelVersion=t,this._remoteParticipantId=i}close(){super.close();const e={direction:"recv",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,remoteParticipantId:this._remoteParticipantId};this._dataChannelTelemetryLogger.sendStatsEvent(e)}}class cv{constructor(e){this._dataChannelTelemetryLogger=e}createSenderMonitor(e,t,i){return new av(e,t,i,this._dataChannelTelemetryLogger)}createReceiverMonitor(e,t,i){return new ov(e,t,i,this._dataChannelTelemetryLogger)}}class lv{constructor(e){this._timeBucket=0,this._maxPacketRate=0,this._packetCount=0,this._maxPacketRate=e}canSend(e){let t=Math.ceil(e/1200);const i=window.performance.now();return Math.floor(i/1e3)==this._timeBucket&&(t+=this._packetCount),t<=this._maxPacketRate}update(e){let t=Math.ceil(e/1200);const i=window.performance.now(),n=Math.floor(i/1e3);n!==this._timeBucket&&(this._timeBucket=n,this._packetCount=0),this._packetCount+=t}}class dv{constructor(e){this._endTime=0,this._maxDataRate=0,this._maxDataRate=e/8}canSend(e){if(0===this._maxDataRate)return!0;const t=window.performance.now(),i=(this._endTime-t)/1e3;return!(i>0)||i+e/this._maxDataRate<=1}update(e){const t=window.performance.now(),i=this._maxDataRate?e/this._maxDataRate*1e3:0;this._endTime<t?this._endTime=t+i:this._endTime+=i}changeBitrate(e){this._maxDataRate=e/8}}class hv{constructor(){this._totalBytes=0,this._lastUpdateTime=window.performance.now(),this._lastUpdateBytes=0,this._currentBitrate=0}getBitrate(){return this._currentBitrate}update(e){this._totalBytes+=e}calculateBitrate(){const e=window.performance.now();e-this._lastUpdateTime>0&&(this._currentBitrate=8*(this._totalBytes-this._lastUpdateBytes)/(e-this._lastUpdateTime)),this._lastUpdateTime=e,this._lastUpdateBytes=this._totalBytes}}class uv{constructor(e,t){this._availableBytes=0,this._reducedBytes=0,this._lastUpdateTime=window.performance.now(),this._packetRateLimiter=new lv(t),this._receiveBitrate=new hv,this._bitrateTimer=window.setInterval((()=>{this._receiveBitrate.calculateBitrate();const t=window.performance.now(),i=(t-this._lastUpdateTime)/1e3;this._availableBytes=e/8*i,this._reducedBytes=.8*this._receiveBitrate.getBitrate()/8*i,this._lastUpdateTime=t}),1e3)}canSend(e,t){return t?!!this._packetRateLimiter.canSend(e)&&this._availableBytes-this._reducedBytes>=e:this._availableBytes>=e}updateSendBytes(e,t){t&&this._packetRateLimiter.update(e),this._availableBytes-=e}updateReceiveBytes(e){this._receiveBitrate.update(e)}dispose(){window.clearInterval(this._bitrateTimer)}}var gv;!function(e){e[e.Initializing=0]="Initializing",e[e.Initialized=1]="Initialized",e[e.Destroyed=2]="Destroyed"}(gv||(gv={}));class pv{constructor(e,t,i){this._state=gv.Initializing,this._initializedDefer=Nu();const n=yl();this._logger=t,this._tsCall=e,this._dataChannelTelemtryLogger=i,this._participantMappingManager=new SS(e),this._dataChannelMonitor=new cv(i),this._senders=new Map,this._receiversManager=new zS(this._participantMappingManager,this._dataChannelMonitor,t),this._processors=new Map,this._channelVersions=new Map,this._randomChannelIdManager=new QS,this._dataIds=new Map,n.dataChannel.dataIdConfigs.forEach((e=>{const t=this._dataIds.get(e.dataId)??[];t.push(e.raw?{dataId:e.dataId,raw:e.raw}:{dataId:e.dataId,raw:e.raw,bandwidth:e.bandwidth??0,priority:e.priority??"normal",category:e.category??"reliable"}),this._dataIds.set(e.dataId,t)})),this._rateLimiters=new Map,this._sendTrafficLimiter=new uv(n.dataChannel.maxSendBandwidth,n.dataChannel.maxBroadcastPacketRate),this._enableBroadcastLimitOnReliableChannel=n.dataChannel.enableBroadcastLimitOnReliableChannel}async initialize(){const e=async e=>{const t=new LS(e,this._tsCall,this._logger);return t.on("message",(t=>{const i=t.message;e.raw?i.channelId=e.dataId+vS:this._sendTrafficLimiter.updateReceiveBytes(i.data.length);try{this._receiversManager.appendMessage(t)}catch(t){this._logger.error(`Failed to appendMessage on dataId ${e.dataId}: ${MS(t)}`)}})),await t.initialize(),t},t=[],i=new Map,n=Array.from(this._dataIds.keys());for(let r=0;r<n.length;r++){const s=n[r],a=this._dataIds.get(s)[0];try{const t=await e(a);i.set(s,t)}catch(i){t.push(s),this._dataIds.delete(s)}}const r=p.flatten(Array.from(this._dataIds.values())).filter((e=>!e.raw));this._dataIdMappingManager=new rv(r),this._state===gv.Initializing?(this._processors=i,r.forEach((e=>{this._rateLimiters.has(e.dataId)||this._rateLimiters.set(e.dataId,new dv(e.bandwidth))})),t.length&&this._dataChannelTelemtryLogger.sendCreateProcessorEvent({kindOfEvent:"failure",dataIds:t}),this._state=gv.Initialized,this._initializedDefer.resolve()):i.forEach((e=>{e.dispose()}))}createSender(e,t){let i=e.channelId,n=!1;if(i>=vS){if(!0!==this._dataIds.get(i-vS)?.[0].raw)throw AS();n=!0}else{if(i<0||i>yS)throw AS();0===i&&(i=this._randomChannelIdManager.findAvailableChannelId())}this._senders.get(i)?.close();const r=function(e){return 255===e?0:e+1}(this._channelVersions.get(i)??-1);let s=i>=vS?i-vS:-1,a=!1;-1===s&&this._state===gv.Initialized&&(s=this._dataIdMappingManager.allocate({channelId:i,reliability:e.reliability,priority:e.priority,bitrate:1e3*e.bitrateInKbps}),a=!0);const o=this._dataChannelMonitor.createSenderMonitor(i,r,t),c=new BS(i,r,(async t=>{const r=t.data.length;if(-1===s&&!a){if(8===r)return;await this._initializedDefer.promise,a||(s=this._dataIdMappingManager.allocate({channelId:i,reliability:e.reliability,priority:e.priority,bitrate:1e3*e.bitrateInKbps}),a=!0)}const o=0===t.recipients?.length&&!this._participantMappingManager.isP2P();if(-1!==s)if(this._enableBroadcastLimitOnReliableChannel&&o&&!n){if(!this._sendTrafficLimiter.canSend(r,o))throw PS();const e=this._processors.get(s);await(e?.send(t)),this._sendTrafficLimiter.updateSendBytes(r,o)}else{const e=this._processors.get(s);await(e?.send(t))}else{const n=this._dataIdMappingManager.getDataIdToSend(i,r,o);try{const i=!this._sendTrafficLimiter.canSend(r,o);if(i&&"High"!==e.priority)throw PS();if(0===n.length)throw wS();for(let e=0;e<n.length;e++)try{const s=n[e],a=this._dataIds.get(s)[0];if(i&&"normal"===a.priority)continue;const c=this._rateLimiters.get(s);if(c?.canSend(r)??1){const e=this._processors.get(s);return await(e?.send(t)),c?.update(r),void this._sendTrafficLimiter.updateSendBytes(r,o)}}catch(e){}throw PS()}catch(e){this._logger.error(`Failed to send channelId ${i} message: ${MS(e)}`)}}}),this._participantMappingManager,o,this._logger);return c.on("close",(()=>{a&&this._dataIdMappingManager.deallocate(i),this._randomChannelIdManager.removeChannelId(i),this._senders.delete(i),setTimeout((()=>c.dispose()),0)})),void 0!==e.participants&&c.setParticipants(e.participants),this._senders.set(i,c),this._randomChannelIdManager.addChannelId(i),this._channelVersions.set(i,r),c}on(e,t){"dataChannelReceiverCreated"===e&&this._receiversManager.on("dataChannelReceiverCreated",t)}off(e,t){"dataChannelReceiverCreated"===e&&this._receiversManager.off("dataChannelReceiverCreated",t)}dispose(){this._state!==gv.Destroyed&&(this._state=gv.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(new I({defaultError:f.FEATURES.DATA_CHANNEL.DISPOSED})),this._senders.forEach((e=>{e.dispose()})),this._receiversManager.dispose(),this._processors.forEach((e=>{e.dispose()})),this._sendTrafficLimiter.dispose(),this._participantMappingManager.dispose())}}class mv{constructor(e,t){this._tsCall=e,this._telemetryLogManager=t}sendStatsEvent(e){const t={callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,...e};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_datachannel_stats,tenant:uc,properties:t})}sendCreateSenderEvent(e){const t={callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createSender",...e};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_datachannel,tenant:uc,properties:t})}sendCreateProcessorEvent(e){const t={callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createProcessor",...e};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_datachannel,tenant:uc,properties:t})}}class fv{constructor(e){this.typeRankComparator=(e,t)=>void 0===e.publishedState?-1:void 0===t.publishedState?1:e.publishedState.typeRank-t.publishedState.typeRank,this._eventEmitter=e,this._currentSpotlightStates=new Map;const t=yl().calling.spotlight;this._maxSpotlightStateSupported=t.maxSpotlightParticipants,this._supportedUserRoles=t.supportedRoles,this._meetingTypes=t.meetingTypes}initialize(e,t,i,n){this._logger=n.createChild((()=>`SpotlightFeature::Call(id='${e.callId}')`)),this._tsCall=e,this._telemetryLogManager=i,this._internalCallAgent=t;const r="initialize";this._sendFeatureUsage(r,Zu.initialize);try{let e=e=>new Map(this.getPublishedState(e).sort(this.typeRankComparator).map(((e,t)=>[e.id,{spotlightStateId:e.publishedState?.stateId,index:t+1}])));this._tsCall.on("publishedStatesChanged",(async t=>{let i=e(t),n=[];i.forEach(((e,t)=>{this._currentSpotlightStates.has(t)||n.push({identifier:sl(t),order:e?.index})}));let r=[];this._currentSpotlightStates.forEach(((e,t)=>{i.has(t)||r.push({identifier:sl(t)})})),this._currentSpotlightStates=i,(n.length||r.length)&&this._eventEmitter.emit("spotlightChanged",{added:n,removed:r})})),this._tsCall.publishedStates&&(this._currentSpotlightStates=e(this._tsCall.publishedStates)),this._sendFeatureUsage(r,Zu.success)}catch(e){this.handleSpotlightFailure(r,e)}}async startSpotlight(e){const t="startSpotlight";try{this._sendFeatureUsage(t,Zu.attempt);let i=this.getIdentifiersMri(e).filter((e=>!this._currentSpotlightStates.has(e)));if(!i.length)throw new I({defaultError:f.FEATURES.SPOTLIGHT.ALREADY_SPOTLIGHTED});this.validateStartSpotlightConditions(i);const n={level:"user",type:"spotlight",content:"{}",participantIds:i};if(!await this._tsCall.publishState(n,m.generateCauseId()))throw new I({defaultError:f.FEATURES.SPOTLIGHT.START_SPOTLIGHT_FAILED});this._sendFeatureUsage(t,Zu.success)}catch(e){this.handleSpotlightFailure(t,e)}}async stopSpotlight(e){const t="stopSpotlight";this._tsCall.publishedStates||this._logger.warn(`${t}: no participants is currently Spotlighted`);try{this._sendFeatureUsage(t,Zu.attempt);let i=this.getIdentifiersMri(e);this.validateStopSpotlightConditions(i);const n=this.findStateIdsForParticipantIds(i);await this._tsCall.removeState({stateIds:n},m.generateCauseId()),this._sendFeatureUsage(t,Zu.success)}catch(e){this.handleSpotlightFailure(t,e)}}async stopAllSpotlight(){const e="stopAllSpotlight";try{this._sendFeatureUsage(e,Zu.attempt),this.validateStopSpotlightConditions([]),await this._tsCall.removeStatesForEveryone({type:"spotlight"},m.generateCauseId()),this._sendFeatureUsage(e,Zu.success)}catch(t){this.handleSpotlightFailure(e,t)}}get spotlightedParticipants(){return this._tsCall.publishedStates?Array.from(this._currentSpotlightStates.keys()).map((e=>({identifier:sl(e),order:this._currentSpotlightStates.get(e)?.index}))):[]}get maxSpotlightStateSupported(){return this._maxSpotlightStateSupported}findStateIdsForParticipantIds(e){return e.length&&this._tsCall.publishedStates?e.map((e=>this._currentSpotlightStates.get(e)?.spotlightStateId||"")).filter((e=>e.length)):[]}getPublishedState(e){return e.typeStates.filter((e=>"spotlight"===e.type)).map((e=>e.participantStates)).flat()}isUserRoleEligible(){const e=this._tsCall.advancedMeetingRole;return!!e&&!!this._supportedUserRoles.find((t=>t===e))}isRoleBasedConversationType(){const e=this._tsCall.conversationType;return!!e&&!!this._meetingTypes.find((t=>t===e))}getIdentifiersMri(e){return e&&e?.length?e.map((e=>rl(e))):[this._internalCallAgent.getUserMri()]}validateStartSpotlightConditions(e){if(this.spotlightedParticipants.length+e.length>this._maxSpotlightStateSupported)throw new I({defaultError:f.FEATURES.SPOTLIGHT.SPOTLIGHT_LIGHT_MAX_REACHED,defaultErrorMessageArgs:[this._maxSpotlightStateSupported]});if(this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new I({defaultError:f.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE,defaultErrorMessageArgs:["Start",this._tsCall.conversationType]})}validateStopSpotlightConditions(e){if((1!==e.length||e[0]!==this._internalCallAgent.getUserMri())&&this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new I({defaultError:f.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE,defaultErrorMessageArgs:["Stop",this._tsCall.conversationType]})}handleSpotlightFailure(e,t){throw this._logger.error(JSON.stringify(t)),this._sendFeatureUsage(e,Zu.failure,t),t}_sendFeatureUsage(e,t,i){let n=i?{code:i?.code||_,subCode:i?.subCode||0,failureReason:i?.message||"",...jp(i)}:void 0;Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Spotlight",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:n},this._telemetryLogManager,this._logger)}}class Sv{initialize(e,t,i,n,r){this._tsCall=e,this._telemetryLogManager=n,this._logger=r}async submitSurvey(e){const t=+new Date,i=x();this.sendEndOfCallEvent("attempt",i);const n=this.validateSurvey(e);if(n){const e=new I({defaultError:f.FEATURES.CALL_SURVEY.INVALID_SURVEY,defaultErrorMessageArgs:[n]});throw this.sendEndOfCallEvent("failure",i,t,{failureReason:n,code:S,...jp(e),isExpected:!0}),e}return new Promise(((n,r)=>{const s=this.createCallSurveyInternal(e);this.registerNotificationEventListener(s,i,t,n,r),this.sendEndOfCallEvent("success",i,t,void 0,s)}))}registerNotificationEventListener(e,t,i,n,r){const s={id:t,callId:e.callId,localParticipantId:e.localParticipantId,overallRating:e.overallRating,audioRating:e.audioRating,videoRating:e.videoRating,screenshareRating:e.screenshareRating};Sv.NOTIFICATION_LISTENER.eventsSent=e=>{e.find((e=>e.name===Xu.acs_calling_survey&&e.data?.correlationId===t&&"success"===e.data?.kindOfEvent))&&n(s)},Sv.NOTIFICATION_LISTENER.eventsDiscarded=(e,n)=>{if(e.find((e=>e.name===Xu.acs_calling_survey&&e.data?.correlationId===t&&"success"===e.data?.kindOfEvent))){const e=new I({defaultError:f.FEATURES.CALL_SURVEY.SUBMIT_TIMEOUT});this.sendEndOfCallEvent("failure",t,i,{failureReason:e.message,code:e.code,...jp(e)}),r(e)}}}sendEndOfCallEvent(e,t,i,n,r){try{const s={eventName:Xu.acs_calling_survey,callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId,correlationId:t,kindOfEvent:e,timestampInfo:{deltaTimeInMs:0},additionalDetails:n};if(i){const e=+new Date;s.timestampInfo.deltaTimeInMs=e-i}"success"===e&&r?(s.overallRating=r.overallRating,s.audioRating=r.audioRating,s.videoRating=r.videoRating,s.screenshareRating=r.screenshareRating,this._telemetryLogManager.sendEvent({name:Xu.acs_calling_survey,tenant:uc,priority:cn,properties:s},Sv.NOTIFICATION_LISTENER)):this._telemetryLogManager.sendEvent({name:s.eventName,tenant:uc,properties:s})}catch(e){this._logger.debug("Unable to send call survey telemetry")}}createCallSurveyInternal(e){let t={callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId};return e&&(t.overallRating=e.overallRating,t.audioRating=e.audioRating,t.videoRating=e.videoRating,t.screenshareRating=e.screenshareRating),t}validateSurvey(e){let t="";return t=this.validateOverallRating(e.overallRating),t+=this.validateAudioRating(e.audioRating),t+=this.validateVideoRating(e.videoRating),t+=this.validateScreenshareRating(e.screenshareRating),""!==t||e.overallRating||e.audioRating||e.videoRating||e.screenshareRating||(t="At least one survey rating is required."),""===t&&(t=this.validateCallSurveyTypes(e)),t.trim()}validateOverallRating(e){if(!e)return"";let t="";return this.isValidFiveStarRating(e)?e.scale&&!this.isRatingValueMatchesRatingScale(e.score,e.scale)?t=this.ratingOutOfRangeMessage(Sv.OVERALL_RATING_SCORE,e):e.scale&&!this.isValidQualityThreshold(e.scale)?t=this.thresholdOutOfRangeMessage("overallRating.scale.lowScoreThreshold",e):e.scale&&!this.isValidRatingScale(e.scale)&&(t=this.ratingScaleOutOfRangeMessage("overallRating.scale",e)):t=this.defaultRatingScaleMessage(Sv.OVERALL_RATING_SCORE),t}validateAudioRating(e){if(!e)return"";let t="";return this.isValidFiveStarRating(e)?e.scale&&!this.isRatingValueMatchesRatingScale(e.score,e.scale)?t=this.ratingOutOfRangeMessage(Sv.AUDIO_RATING_SCORE,e):e.scale&&!this.isValidQualityThreshold(e.scale)?t=this.thresholdOutOfRangeMessage("audioRating.scale.lowScoreThreshold",e):e.scale&&!this.isValidRatingScale(e.scale)&&(t=this.ratingScaleOutOfRangeMessage("audioRating.scale",e)):t=this.defaultRatingScaleMessage(Sv.AUDIO_RATING_SCORE),t}validateVideoRating(e){if(!e)return"";let t="";return this.isValidFiveStarRating(e)?e.scale&&!this.isRatingValueMatchesRatingScale(e.score,e.scale)?t=this.ratingOutOfRangeMessage(Sv.VIDEO_RATING_SCORE,e):e.scale&&!this.isValidQualityThreshold(e.scale)?t=this.thresholdOutOfRangeMessage("videoRating.scale.lowScoreThreshold",e):e.scale&&!this.isValidRatingScale(e.scale)&&(t=this.ratingScaleOutOfRangeMessage("videoRating.scale",e)):t=this.defaultRatingScaleMessage(Sv.VIDEO_RATING_SCORE),t}validateScreenshareRating(e){if(!e)return"";let t="";return this.isValidFiveStarRating(e)?e.scale&&!this.isRatingValueMatchesRatingScale(e.score,e.scale)?t=this.ratingOutOfRangeMessage(Sv.SCREEN_SHARE_RATING_SCORE,e):e.scale&&!this.isValidQualityThreshold(e.scale)?t=this.thresholdOutOfRangeMessage("screenshareRating.scale.lowScoreThreshold",e):e.scale&&!this.isValidRatingScale(e.scale)&&(t=this.ratingScaleOutOfRangeMessage("screenshareRating.scale",e)):t=this.defaultRatingScaleMessage(Sv.SCREEN_SHARE_RATING_SCORE),t}validateCallSurveyTypes(e){let t="";return e.overallRating&&(t=this.valueShouldBeNumber(Sv.OVERALL_RATING_SCORE,e.overallRating.score),e.overallRating.issues&&(this.isArray(e.overallRating.issues)?e.overallRating.issues.some((e=>Sv.OVERALL_ISSUES[e]!==e))&&(t+="overallRating.issues array should be of type OverallIssue. "):t+="overallRating.issues should be of type Array<OverallIssue>. "),t+=this.ratingScaleShouldNotHaveUnexpectedProperties("overallRating.scale",e.overallRating.scale),t+=this.ratingShouldNotHaveUnexpectedProperties("overallRating",e.overallRating)),e.audioRating&&(t+=this.valueShouldBeNumber(Sv.AUDIO_RATING_SCORE,e.audioRating.score),e.audioRating.issues&&(this.isArray(e.audioRating.issues)?e.audioRating.issues.some((e=>Sv.AUDIO_ISSUES[e]!==e))&&(t+="audioRating.issues array should be of type AudioIssue. "):t+="audioRating.issues should be of type Array<AudioIssue>. "),t+=this.ratingScaleShouldNotHaveUnexpectedProperties("audioRating.scale",e.audioRating.scale),t+=this.ratingShouldNotHaveUnexpectedProperties("audioRating",e.audioRating)),e.videoRating&&(t+=this.valueShouldBeNumber(Sv.VIDEO_RATING_SCORE,e.videoRating.score),e.videoRating.issues&&(this.isArray(e.videoRating.issues)?e.videoRating.issues.some((e=>Sv.VIDEO_ISSUES[e]!==e))&&(t+="videoRating.issues array should be of type VideoIssue. "):t+="videoRating.issues should be of type Array<VideoIssue>. "),t+=this.ratingScaleShouldNotHaveUnexpectedProperties("videoRating.scale",e.videoRating.scale),t+=this.ratingShouldNotHaveUnexpectedProperties("videoRating",e.videoRating)),e.screenshareRating&&(t+=this.valueShouldBeNumber(Sv.SCREEN_SHARE_RATING_SCORE,e.screenshareRating.score),e.screenshareRating.issues&&(this.isArray(e.screenshareRating.issues)?e.screenshareRating.issues.some((e=>Sv.SCREENSHARE_ISSUES[e]!==e))&&(t+="screenshareRating.issues array should be of type ScreenshareIssue. "):t+="screenshareRating.issues should be of type Array<ScreenshareIssue>. "),t+=this.ratingScaleShouldNotHaveUnexpectedProperties("screenshareRating.scale",e.screenshareRating.scale),t+=this.ratingShouldNotHaveUnexpectedProperties("screenshareRating",e.screenshareRating)),t}isNumber(e){return null!==e&&"number"==typeof e}isArray(e){return null!==e&&Array.isArray(e)}isValidFiveStarRating(e){return null==e||void 0!==e.scale||e.score>=1&&e.score<=5}isRatingValueMatchesRatingScale(e,t){return e>=t.lowerBound&&e<=t.upperBound}isValidQualityThreshold(e){return e.lowScoreThreshold>=e.lowerBound&&e.lowScoreThreshold<=e.upperBound}isValidRatingScale(e){return e.lowerBound>=0&&e.upperBound<=100}valueShouldBeNumber(e,t){return this.isNumber(t)?"":`${e} should be of type number. `}ratingScaleShouldNotHaveUnexpectedProperties(e,t){let i="";if(!t)return i;for(let n in t)void 0===Sv.RATING_SCALE_KEYS[n]&&(i+=`${e} should not have ${n}. `);return i}ratingShouldNotHaveUnexpectedProperties(e,t){let i="";if(!t)return i;for(let n in t)void 0===Sv.CALL_RATING_KEYS[n]&&(i+=`${e} should not have ${n}. `);return i}defaultRatingScaleMessage(e){return`In default scale ${e} should be 1 to 5. `}ratingOutOfRangeMessage(e,t){return`${e}: ${t.score} should be between ${t.scale?.lowerBound} and ${t.scale?.upperBound}. `}thresholdOutOfRangeMessage(e,t){return`${e}: ${t.scale?.lowScoreThreshold} should be between ${t.scale?.lowerBound} and ${t.scale?.upperBound}. `}ratingScaleOutOfRangeMessage(e,t){return`${e} lowerBound: ${t.scale?.lowerBound} and upperBound: ${t.scale?.upperBound} should be between 0 and 100. `}}Sv.OVERALL_RATING_SCORE="overallRating.score",Sv.AUDIO_RATING_SCORE="audioRating.score",Sv.VIDEO_RATING_SCORE="videoRating.score",Sv.SCREEN_SHARE_RATING_SCORE="screenshareRating.score",Sv.NOTIFICATION_LISTENER={},Sv.OVERALL_ISSUES={CallCannotInvite:"CallCannotInvite",CallCannotJoin:"CallCannotJoin",CallEndedUnexpectedly:"CallEndedUnexpectedly",HadToRejoin:"HadToRejoin",OtherIssues:"OtherIssues"},Sv.AUDIO_ISSUES={AudioInterruption:"AudioInterruption",AudioNoise:"AudioNoise",AudioStoppedUnexpectedly:"AudioStoppedUnexpectedly",DistortedSpeech:"DistortedSpeech",Echo:"Echo",LowVolume:"LowVolume",NoLocalAudio:"NoLocalAudio",NoRemoteAudio:"NoRemoteAudio",OtherIssues:"OtherIssues"},Sv.VIDEO_ISSUES={AudioVideoOutOfSync:"AudioVideoOutOfSync",DarkVideoReceived:"DarkVideoReceived",Freezes:"Freezes",LowQuality:"LowQuality",NoVideoReceived:"NoVideoReceived",NoVideoSent:"NoVideoSent",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},Sv.SCREENSHARE_ISSUES={CannotPresent:"CannotPresent",Freezes:"Freezes",LargeDelay:"LargeDelay",LowQuality:"LowQuality",NoContentLocal:"NoContentLocal",NoContentRemote:"NoContentRemote",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},Sv.CALL_RATING_KEYS={score:"score",issues:"issues",scale:"scale"},Sv.RATING_SCALE_KEYS={lowerBound:"lowerBound",upperBound:"upperBound",lowScoreThreshold:"lowScoreThreshold"};class vv{constructor(e,t){this._eventEmitter=e,this._featureName=t}initialize(e,t,i,n,r){this._logger=r.createChild((()=>`${this._featureName}::Call(id='${e.callId}')`)),this._tsCall=e,this._tsCall.changed((()=>{this._logger.log("tsCall changed"),this.updateMeetingGroupDetails()}))}updateAudioZone(e){const t="updateAudioZone_"+x();return this._logger.log(`updateAudioZone toGroup=${e}, causeId=${t}`),this._tsCall.updateMeetingGroups(t,{scope:4,toGroup:e})}dispose(){this._meetingGroupDetails=void 0}get meetingGroupDetails(){return this._meetingGroupDetails}updateMeetingGroupDetails(){const e=this._tsCall.meetingGroupDetails;p.isEqual(e,this._meetingGroupDetails)||(this._meetingGroupDetails=e,this._eventEmitter.emit("meetingGroupDetailsChanged"))}}class yv{constructor(e,t,i){this._featureName=e,this._eventEmitter=t,this._optimalVideoCount=i}initialize(e,t,i,n,r){this._tsCall=e,this._logger=r,this._logger?.createChild((()=>`${this._featureName}::Call(id='${this._tsCall?.callId}')`)),this._tsCall.changed((()=>this.ovcChanged(e)))}ovcChanged(e){e?.optimalVideoCount&&e.optimalVideoCount!==this._optimalVideoCount&&(this._logger.log(`tsCall optimalVideoCount changed from ${this._optimalVideoCount} to ${e?.optimalVideoCount}`),this._eventEmitter.emit("optimalVideoCountChanged"))}}class Cv{constructor(e,t,i){this._effectsStatusManager=e,this._logger=t,this._localAudioStream=i,this._currentActiveBrowserEffects={},this._updateCurrentActive()}async setBrowserAudioEffects(e,t,i){try{await this._updateCurrentActive(t);const n={autoGainControl:void 0!==i.autoGainControl?i.autoGainControl:this._currentActiveBrowserEffects.autoGainControl,echoCancellation:void 0!==i.echoCancellation?i.echoCancellation:this._currentActiveBrowserEffects.echoCancellation,noiseSuppression:void 0!==i.noiseSuppression?i.noiseSuppression:this._currentActiveBrowserEffects.noiseSuppression},r=this._calculateFlags(n);this._logger.info(`Setting browser audio processing flags to ${r}`),await e.setAudioProcessingFlags(r)}catch(e){throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.AUDIO_FLAGS,originalError:e})}}async _updateCurrentActive(e){try{const t=e??this._effectsStatusManager.getActiveEffects();if(!this._localAudioStream.canStartEffects)throw new Error("Cannot proceed to update current browser audio effects, most likely source is not supported for audio effects");const i=await this._localAudioStream.getMediaStream(),n=i?.getAudioTracks()?.[0];if(!n)throw new Error("Could not get MediaStreamTrack from the LocalAudioStream");const r=n.getSettings();let s=!!r?.autoGainControl,a=!!r?.noiseSuppression,o=!!r?.echoCancellation;this._currentActiveBrowserEffects={},("BrowserAutoGainControl"===t?.autoGainControl?.[0]||s)&&(this._currentActiveBrowserEffects.autoGainControl=!0),("BrowserEchoCancellation"===t?.echoCancellation?.[0]||o)&&(this._currentActiveBrowserEffects.echoCancellation=!0),("BrowserNoiseSuppression"===t?.noiseSuppression?.[0]||a)&&(this._currentActiveBrowserEffects.noiseSuppression=!0)}catch(e){throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.AUDIO_FLAGS,originalError:e})}}_calculateFlags(e){let t=0;return e.autoGainControl&&(t+=1),e.echoCancellation&&(t+=2),e.noiseSuppression&&(t+=4),t}}var _v,Ev=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},Tv=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class Iv extends Ip{constructor(){super(...arguments),this._wasmVqeInitialized=!1,this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this._currentEffects={},this._previousTsWasmEffectType=0,this._currentTsWasmEffectType=0,this._stringForUnknownInput="UNKNOWN",this._audioEffectsProcessorStats=null,this._sourceStreamSubscription=null,this.effectStatusChangedCallback=(e,t,i)=>{"start"===i&&this.eventEmitter.emit("effectsStarted",t),"stop"===i&&this.eventEmitter.emit("effectsStopped",t)},this.configUpdatedCallback=async e=>{this._logger?.info("configUpdated callback, no-op.")},this.processingErrorCallback=async e=>{const t=x();this._logger?.info("processingError callback"),this.eventEmitter.emit("effectsError",e);const i=this.getEffectsNameForTelemetry(this.activeEffects),n=this.getUsageDetailsForTelemetry("Internal handle error",i);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.stopEffects,kindOfEvent:Zu.failure,additionalDetails:{failureReason:e.message,...jp(e),usageDetails:n}}),await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})},this.subscribeToStatUpdates=async()=>{let e=null;for(let t of Object.values(this._currentEffects))t&&"object"==typeof t&&(e=t);if(!e)return;const t=await e._internalHandle.getEffectProvider(),i=await(t?.getAudioEffectProvider());let n=null;i&&(this._audioEffectProviderSub=i?.on?.("onMetricsUpdated",(()=>{try{n=i?.getStats&&i.getStats(),n&&(this._audioEffectsProcessorStats={activeAudioEffects:JSON.stringify(this.activeEffects),audioEffectsSpeechProcessingStats:{localAudioInputSpeechRMS_dBFS:n?.speechLevels?.nearEndInputRMS_dBFS,localAudioOutputSpeechRMS_dBFS:n?.speechLevels?.nearEndOutputRMS_dBFS,localAudioInputNoiseRMS_dBFS:n?.noiseLevels?.nearEndInputRMS_dBFS,localAudioOutputNoiseRMS_dBFS:n?.noiseLevels?.nearEndOutputRMS_dBFS,remoteAudioInputSpeechRMS_dBFS:n?.speechLevels?.farEndInputRMS_dBFS,remoteAudioOutputSpeechRMS_dBFS:n?.speechLevels?.farEndOutputRMS_dBFS},rawStats:JSON.stringify(n)}),this.eventEmitter.emit("effectsProcessorStatsUpdated",this._audioEffectsProcessorStats)}catch(e){this._logger?.warn(`Could not emit audio effect processor stat event: ${e}`)}})),this._logger?.info("Subscribed to audioEffectsProvider stat updates"))},this.unsubscribeFromStatUpdates=()=>{let e=null;for(let t of Object.values(this._currentEffects))t&&"object"==typeof t&&(e=t);e?this._logger?.info("There is a wasm audio effect still active, skipping stat unsubscribe"):this._audioEffectProviderSub?.dispose&&(this._audioEffectProviderSub.dispose(),this._audioEffectProviderSub=()=>{},this._audioEffectsProcessorStats=null,this._logger?.info("Unsubscribed from audioEffectsProvider stat updates"))}}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this.updateAudioEffectsStatusManager()}get name(){return"AudioEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(e,t){if("effectsStarted"!==e&&"effectsStopped"!==e&&"effectsError"!==e&&"effectsProcessorStatsUpdated"!==e)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("effectsStarted"!==e&&"effectsStopped"!==e&&"effectsError"!==e&&"effectsProcessorStatsUpdated"!==e)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}async isSupported(e){const t=x(),i=+new Date,n=this.getUsageDetailsForTelemetry("",this.getEffectsNameForTelemetry(e));this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,kindOfEvent:Zu.attempt,additionalDetails:{usageDetails:n}});try{if(this.disposed)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const n=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new mS(this._logger,n));let r=!1;if("object"==typeof e){const t=this.getEffectInternalCast(e);r=await this._supportChecker.audioEffectsSupported(t),this._logger?.info(`Support check for ${t.name} resulted in: ${r}`)}else"string"==typeof e&&(r=await this._supportChecker.audioEffectsSupported(e),this._logger?.info(`Support check for ${e} resulted in: ${r}`));const s=this.getEffectsNameForTelemetry(e),a=this.getUsageDetailsForTelemetry("",s);return this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.success,additionalDetails:{usageDetails:a}}),r}catch(n){const r=new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SUPPORT_CHECK_FAILED,originalError:n});this._logger?.error(r.message);const s=this.getEffectsNameForTelemetry(e),a=this.getUsageDetailsForTelemetry("",s);throw this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.failure,additionalDetails:{failureReason:r.message,code:r.code,...jp(r),usageDetails:a}}),r}}async startEffects(e){const t=x(),i=+new Date,n=this.getUsageDetailsForTelemetry("",JSON.stringify(this.getEffectsConfigForTelemetry(e)));this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,kindOfEvent:Zu.attempt,additionalDetails:{usageDetails:n}});try{const n=yl();if(!n?.audioEffects?.enableAudioEffects)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.DISABLED});if(this.disposed)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const r=this._internalDeviceManager.getTsDeviceManager();if(!r)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.START_DEVICE_MANAGER});await this.updateAudioEffectsStatusManager(),this.subscribeToStreamInstanceEvents(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();let s=this.activeEffects;e?.autoGainControl&&(s=await this.startStopAutoGainControl(r,s,!0,e.autoGainControl)),e?.echoCancellation&&(s=await this.startStopEchoCancellation(r,s,!0,e.echoCancellation)),e?.noiseSuppression&&(s=await this.startStopNoiseSuppression(r,s,!0,e.noiseSuppression)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await r.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(s,"start"),await this.subscribeToStatUpdates();const a=JSON.stringify(s),o=this.getUsageDetailsForTelemetry("",a);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.success,additionalDetails:{usageDetails:o}})}catch(n){const r=new I({defaultError:f.FEATURES.AUDIO_EFFECTS.START_FAILED,originalError:n});this._logger?.error(r.message),this.eventEmitter.emit("effectsError",r);const s=JSON.stringify(this.getEffectsConfigForTelemetry(e)),a=this.getUsageDetailsForTelemetry("",s);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.failure,additionalDetails:{failureReason:r.message,code:r.code,...jp(r),usageDetails:a}})}}async stopEffects(e){const t=x(),i=+new Date,n=this.getUsageDetailsForTelemetry("",JSON.stringify(this.getEffectsConfigForTelemetry(e)));this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.stopEffects,kindOfEvent:Zu.attempt,additionalDetails:{usageDetails:n}});try{if(this.disposed)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.STOP_DISPOSED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const n=this._internalDeviceManager.getTsDeviceManager();if(!n)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.STOP_DEVICE_MANAGER});await this.updateAudioEffectsStatusManager();let r=this.activeEffects;e?.autoGainControl&&(r=await this.startStopAutoGainControl(n,r,!1)),e?.echoCancellation&&(r=await this.startStopEchoCancellation(n,r,!1)),e?.noiseSuppression&&(r=await this.startStopNoiseSuppression(n,r,!1)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await n.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(r,"stop"),this.unsubscribeFromStatUpdates(),this.unsubscribeFromStreamInstanceEvents();const s=JSON.stringify(r),a=this.getUsageDetailsForTelemetry("",s);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.success,additionalDetails:{usageDetails:a}})}catch(n){const r=new I({defaultError:f.FEATURES.AUDIO_EFFECTS.STOP_FAILED,originalError:n});this._logger?.error(r.message),this.eventEmitter.emit("effectsError",r);const s=JSON.stringify(this.getEffectsConfigForTelemetry(e)),a=this.getUsageDetailsForTelemetry("",s);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.failure,additionalDetails:{failureReason:r.message,code:r.code,...jp(r),usageDetails:a}})}}async dispose(){try{if(this.disposed)return void this._logger?.info("AudioEffects feature already disposed");await this.stopEffects({echoCancellation:!0,noiseSuppression:!0}),this._currentEffects={},this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.unsubscribeFromStreamInstanceEvents(),this.disposed=!0,this._logger?.info("AudioEffects feature disposed")}catch(e){const t=new I({defaultError:f.FEATURES.AUDIO_EFFECTS.DISPOSE_FAILED,originalError:e});this._logger?.error(t.message),this.eventEmitter.emit("effectsError",t)}}get audioEffectsProcessorStats(){return this._audioEffectsProcessorStats}async updateAudioEffectsStatusManager(){if(this.streamInstance.canStartEffects){if(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),!this._effectsStatusManager)if(this._effectsStatusManager=this._internalDeviceManager.callStackAudioEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback),this.streamInstance.canStartEffects){const e=await this.streamInstance.getMediaStream(),t=e?.getAudioTracks()?.[0],i=t?.getSettings();this._effectsStatusManager?.setActiveEffects({autoGainControl:i.autoGainControl?["BrowserAutoGainControl"]:[],echoCancellation:i.echoCancellation?["BrowserEchoCancellation"]:[],noiseSuppression:i.noiseSuppression?["BrowserNoiseSuppression"]:[]},"initialize")}else this._logger?.debug("Cannot process initial browser audio effects status, most likely LocalAudioStream source is not AudioDeviceInfo");this._activeEffects=this._effectsStatusManager.getActiveEffects(),this._browserAudioEffectsManager=new Cv(this._effectsStatusManager,this._logger,this.streamInstance)}else this._logger?.warn("Cannot update status manager, current source is not supported.")}async initializeWasmVqeInStack(e){if(this._wasmVqeInitialized)return void this._logger?.info("WasmVqe initialized already");if(!this._internalDeviceManager)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.FAILED_TO_GET_DM});const t=await e._internalHandle.getEffectProvider();if(!t)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.PROVIDER_UNAVAILABLE});const i=await t.getAudioEffectProvider(),n=this.streamInstance.callStackWasmVqeProvider;if(!n)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.AEC_PROVIDER_MISSING});n.providerValue=i,this._wasmVqeInitialized=!0}getEffectInternalCast(e){if("EchoCancellation"===e?.name&&this.isValidEffectInstance(e))return e;if("DeepNoiseSuppression"===e?.name&&this.isValidEffectInstance(e))return e;throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT})}isValidEffectInstance(e){let t;return("EchoCancellation"===e.name&&e._internalHandle||!("DeepNoiseSuppression"!==e.name||!e._internalHandle))&&(t=e,this.hasValidInternalHandle(t._internalHandle))}hasValidInternalHandle(e){return!!(e.getEffectProvider&&e.dispose&&e.setConfig&&e.handleProcessingError)}updateCurrentTsWasmAudioEffectType(e,t,i){const n=i??this._effectsStatusManager?.getActiveEffects();let r=!!n?.echoCancellation?.includes("EchoCancellation"),s=!!n?.noiseSuppression?.includes("DeepNoiseSuppression");switch(e){case"EchoCancellation":r=t;break;case"DeepNoiseSuppression":s=t}this._previousTsWasmEffectType=this._currentTsWasmEffectType,this._currentTsWasmEffectType=r&&s?16:r?4:s?2:0}subscribeToStreamInstanceEvents(){this._sourceStreamSubscription&&(this._logger?.info("Already subscribed to audioSourceChanged before, removing old sub"),this.streamInstance.off("audioSourceChanged",this._sourceStreamSubscription)),this._sourceStreamSubscription=async e=>{e.source&&"Audio"!==e.source.mediaStreamType&&await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})},this.streamInstance.on("audioSourceChanged",this._sourceStreamSubscription)}unsubscribeFromStreamInstanceEvents(){this._sourceStreamSubscription?(this.streamInstance.off("audioSourceChanged",this._sourceStreamSubscription),this._sourceStreamSubscription=null):this._logger?.info("No audioSourceChanged sub active")}subscribeToEffectEvents(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.on("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.on("processingError",this.processingErrorCallback))}disposeEffectEventSubscriptions(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.off("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.off("processingError",this.processingErrorCallback))}setConfigForEffects(e){const t=e._internalHandle.configProvider.config.audioEffects,i=Cl(),n=yl();i?.wasmvqe?.enableVqe&&n?.audioEffects?.enableAudioEffects&&(t.enableAudioEffects=i?.wasmvqe?.enableVqe&&n.audioEffects.enableAudioEffects),e._internalHandle.setConfig(t),this._logger?.info(`Config for audio effects set: ${Il(t)}`)}async startStopAutoGainControl(e,t,i,n){try{if(i&&n){if(!await this.isSupported(n)){const e=this.getEffectsNameForTelemetry(n);throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(e)]})}if("BrowserAutoGainControl"!==n)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_GAINCONTROL});return await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{autoGainControl:!0})),this._logger?.info("Browser auto gain control started"),this._currentEffects.autoGainControl=n,t.autoGainControl=[n],t}switch(t?.autoGainControl?.[0]??""){case"":case"BrowserAutoGainControl":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{autoGainControl:!1})),this._logger?.info("Browser auto gain control stopped")}return t.autoGainControl=[],this._currentEffects.autoGainControl=void 0,t}catch(e){throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SET_AUTO_GAIN_CONTROL,defaultErrorMessageArgs:[i],originalError:e})}}async startStopEchoCancellation(e,t,i,n){try{if(i&&n){if(!await this.isSupported(n)){const e=this.getEffectsNameForTelemetry(n);throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(e)]})}if("string"==typeof n&&"BrowserEchoCancellation"===n)"EchoCancellation"===t.echoCancellation[0]&&(await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("EchoCancellation",!1,t),t.echoCancellation=[]),await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{echoCancellation:!0})),this._logger?.info("Browser echo cancellation started"),this._currentEffects.echoCancellation=n,t.echoCancellation=[n];else{if("object"!=typeof n)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_ECHO});this._currentEffects.echoCancellation=this.getEffectInternalCast(n),this.setConfigForEffects(this._currentEffects.echoCancellation),await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.echoCancellation.name,!0,t),t.echoCancellation=[this._currentEffects.echoCancellation.name]}return t}switch(t?.echoCancellation?.[0]??""){case"":case"BrowserEchoCancellation":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{echoCancellation:!1})),this._logger?.info("Browser echo cancellation stopped");break;case"EchoCancellation":await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType("EchoCancellation",!1,t)}return t.echoCancellation=[],this._currentEffects.echoCancellation=void 0,t}catch(e){throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SET_ECHO_CANCELLATION,defaultErrorMessageArgs:[i],originalError:e})}}async startStopNoiseSuppression(e,t,i,n){try{if(i&&n){if(!await this.isSupported(n)){const e=this.getEffectsNameForTelemetry(n);throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(e)]})}if("string"==typeof n&&"BrowserNoiseSuppression"===n)"DeepNoiseSuppression"===t.noiseSuppression[0]&&(await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("DeepNoiseSuppression",!1,t),t.noiseSuppression=[]),await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{noiseSuppression:!0})),this._logger?.info("Browser noise cancellation started"),t.noiseSuppression=[n],this._currentEffects.noiseSuppression=n;else{if("object"!=typeof n)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_NOISE_SUPP});this._currentEffects.noiseSuppression=this.getEffectInternalCast(n),this.setConfigForEffects(this._currentEffects.noiseSuppression),await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.noiseSuppression.name,!0,t),t.noiseSuppression=[this._currentEffects.noiseSuppression.name]}return t}switch(t?.noiseSuppression?.[0]??""){case"":case"BrowserNoiseSuppression":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(e,t,{noiseSuppression:!1})),this._logger?.info("Browser noise suppression stopped");break;case"DeepNoiseSuppression":await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("DeepNoiseSuppression",!1,t)}return t.noiseSuppression=[],this._currentEffects.noiseSuppression=void 0,t}catch(e){throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.SET_NOISE_SUPPRESSION,defaultErrorMessageArgs:[i],originalError:e})}}sendFeatureUsageTelemetry(e){if(this._telemetryLogManager)try{const t={correlationId:e.correlationId,mediaType:Bg.AudioRaw,streamType:Hg.Local,operation:e.operation,timestampInfo:e.timestampInfo||{},kindOfEvent:e.kindOfEvent||"",additionalDetails:e.additionalDetails||""};this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:t})}catch(t){this._logger?.debug(`Unable to send ${e.operation} telemetry`)}else this._logger?.debug("Telemetry error. Instance is undefined.")}getEffectsConfigForTelemetry(e){let t=!1;"boolean"!=typeof e?.autoGainControl&&"boolean"!=typeof e?.echoCancellation&&"boolean"!=typeof e?.noiseSuppression||(t=!0);let i={};return i=t?{autoGainControl:e?.autoGainControl&&"boolean"==typeof e?.autoGainControl?e?.autoGainControl:void 0,echoCancellation:e?.echoCancellation&&"boolean"==typeof e?.echoCancellation?e?.echoCancellation:void 0,noiseSuppression:e?.noiseSuppression&&"boolean"==typeof e?.noiseSuppression?e?.noiseSuppression:void 0}:{autoGainControl:this.getEffectsNameForTelemetry(e?.autoGainControl),echoCancellation:this.getEffectsNameForTelemetry(e?.echoCancellation),noiseSuppression:this.getEffectsNameForTelemetry(e?.noiseSuppression)},Object.keys(i).forEach((e=>{""!==i[e]&&void 0!==i[e]||delete i[e]})),i}getEffectsNameForTelemetry(e){return e?"string"==typeof e?this.truncateToMax(e):e?.name&&"string"==typeof e?.name?this.truncateToMax(e.name):(this._logger?.warn("Invalid effect object found"),this._stringForUnknownInput):""}getUsageDetailsForTelemetry(e,t){const i=`${t?`[${t}]`:""}:${e??""}`;return this.truncateToMax(i)}truncateToMax(e){const t=yl().audioEffects.maxStringLengthForTelemetry;return this._logger?.info("Truncating audio effects info for telemetry"),e.length>t?e.substring(0,t-2)+"..":e}}function bv(e,t){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.EVENT_SUBSCIBE_UNSUBSCRIBE,defaultErrorMessageArgs:[t,e]})}function Av(){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.UNAVAILABLE})}function Rv(e){return p.isString(e)?e:e?.message??"Unknown"}function wv(e){throw e instanceof I?e:new I({defaultError:f.FEATURES.UNMIXED_AUDIO.UNKNOWN_ERROR})}function Pv(){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.PENDING_OPERATION})}function Mv(){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.UNSUPPORTED_OPERATION})}function Dv(e){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.INVALID_STATE,defaultErrorMessageArgs:[e]})}function Ov(e){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.FAILED_TO_INITIALIZE,originalError:e})}Ev([fp(),Tv("design:type",Function),Tv("design:paramtypes",[Object]),Tv("design:returntype",Promise)],Iv.prototype,"startEffects",null),Ev([fp(),Tv("design:type",Function),Tv("design:paramtypes",[Object]),Tv("design:returntype",Promise)],Iv.prototype,"stopEffects",null);class kv{constructor(e){this._tsCall=e,this._sourceIdMapping=new Map,this._participantIdMapping=new Map,this._listenerHandles=[],this._listenerHandles.push(this._tsCall.on("participantAdded",(e=>{this._updateMapping(e)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(e=>{this._updateMapping(e)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(e=>{this._removeMapping(e)}))),this._tsCall.participants.forEach((e=>{this._updateMapping(e)}))}_updateMapping(e){e.endpoints?.endpointDetails?.forEach((t=>{const i=t.mediaStreams?.find((e=>"audio"===e.type));if(i){const n={sourceId:i.sourceId,participantId:t.participantId,mri:e.id};this._sourceIdMapping.set(i.sourceId,n),this._participantIdMapping.set(t.participantId,n)}}))}_removeMapping(e){e.endpoints?.endpointDetails?.forEach((e=>{const t=e.mediaStreams?.find((e=>"audio"===e.type));t&&(this._sourceIdMapping.delete(t.sourceId),this._participantIdMapping.delete(e.participantId))}))}findParticipantInfoBySourceId(e){return this._sourceIdMapping.get(e)}findParticipantInfoByParticipantId(e){return this._participantIdMapping.get(e)}dispose(){this._sourceIdMapping.clear(),this._participantIdMapping.clear(),this._listenerHandles.forEach((e=>e.dispose()))}}class Nv{constructor(e,t){this._tsCall=e,this._telemetryLogManager=t}sendActionEvent(e){const t={callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,...e};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_unmixed_audio,tenant:uc,properties:t})}}class Lv{constructor(e,t){this._unmixedAudioTelemetryLogger=e,this._action=t,this._correlationId=x()}logAttempt(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"attempt",correlationId:this._correlationId})}logSuccess(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"success",correlationId:this._correlationId})}logFailure(e,t){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"failure",correlationId:this._correlationId,failureReason:e.message,...t,additionalDetails:{...jp(e)}})}}class xv{constructor(e,t){this._waitTimeoutInMs=e,this._expectedState=t,this._result=Rl(),this._wait=Fu((()=>this._result.promise),this._waitTimeoutInMs)}updateState(e){this._result.isPending()&&(e===this._expectedState?this._result.resolve():this._result.reject(new Error(`Unexpected active state: ${e}`)))}get waitState(){return this._expectedState}async wait(){await this._wait}cancel(){this._result.isPending()&&this._result.reject(new Error("Operation cancelled"))}}class Uv{constructor(e,t){this._logger=e.createChild(`AudioContext:${t}`);const i=new AudioContext,n=()=>{this._logger.info(`The AudioContext:${t} state changed to ${i.state}`),"closed"===i.state&&i.removeEventListener("statechange",n)};i.addEventListener("statechange",n),this._audioContext=i}async resume(e=0){if("closed"===this._audioContext.state)throw Dv(this._audioContext.state);if("running"===this._audioContext.state)return;const t=new xv(e,!0);return this._audioContext.resume().then((()=>{t.updateState(!0),this._logger.info("resumed")})).catch((e=>{this._logger.info(`Failed to resume: ${Rv(e)}`),t.updateState(!1)})),t.wait()}async close(){"closed"!==this._audioContext.state&&await this._audioContext.close().then((()=>{this._logger.info("closed")})).catch((e=>{this._logger.info(`Failed to close: ${Rv(e)}`)}))}get state(){return this._audioContext.state}get value(){return this._audioContext}}function Fv(e){switch(e){case _v.Uninitialized:return"Uninitialized";case _v.Initializing:return"Initializing";case _v.Initialized:return"Initialized";case _v.Destroyed:return"Destroyed";case _v.Aborted:return"Aborted"}}!function(e){e[e.Uninitialized=0]="Uninitialized",e[e.Initializing=1]="Initializing",e[e.Initialized=2]="Initialized",e[e.Destroyed=3]="Destroyed",e[e.Aborted=4]="Aborted"}(_v||(_v={}));class Vv{constructor(e,t,i,n){this._state=_v.Uninitialized,this._listenerHandles=[],this._audioContextSeq=0,this._activeStatePromises=new Set,this._lastestSpatialAudioRequest="none",this._pendingOperation=!1,this._initializedDefer=Rl();try{this._tsCall=e,this._logger=t.createChild("UnmixedAudioManager"),this._eventEmitter=new Nm(this._logger,{enableLogEmit:!1}),this._unmixedAudioTelemetryLogger=i,this._participantManager=new kv(e),this._destinationStreamInfoMap=new Map,this._destinationStreamInfoList=new Array(n.maxStreamSize),this._sourceStreamInfoList=new Array(n.maxStreamSize),this._maxStreamSize=n.maxStreamSize,this._operationTimeoutInMs=n.operationTimeoutInMs,this._skipProviderStateCheck=n.skipProviderStateCheck}catch(e){throw this._state=_v.Aborted,t.info(`Failed to create UnmixedAudioManager: ${Rv(e)}`),Ov(e)}}async initialize(){if(this._state!==_v.Uninitialized)throw Dv(Fv(this._state));this._initializedDefer.isPending()||(this._initializedDefer=Rl());const e=new Lv(this._unmixedAudioTelemetryLogger,"initialize");this._state=_v.Initializing;try{if(e.logAttempt(),!this._tsCall.getUnmixedAudioProvider)throw Av();if(this._tsUnmixedAudioProvider=this._tsUnmixedAudioProvider??await this._tsCall.getUnmixedAudioProvider(),!this._tsUnmixedAudioProvider)throw Av();this._audioContext=this._audioContext??new Uv(this._logger,this._audioContextSeq++),0===this._listenerHandles.length&&(this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onStreamSourcesUpdated",(e=>{this._state===_v.Initialized&&this._onStreamSourcesUpdatedHandler(e)}))),this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onActiveStateChanged",(()=>{if(this._state!==_v.Initialized)return;const e=this._tsUnmixedAudioProvider?.active??!1;this._logger.info(`activeStateChanged to ${e}`),this._activeStatePromises.forEach((t=>{t.updateState(e)})),this._activeStatePromises.clear()})))),e.logSuccess(),this._logger.info(`Initialized with maxStreamSize ${this._maxStreamSize}. The AudioContext state is ${this._getAudioContextState()}.`),this._state=_v.Initialized,this._initializedDefer.resolve()}catch(t){this._state=_v.Uninitialized;const i=Rv(t);this._logger.info(`Failed to initialize: ${i}`);const n=Ov(t);e.logFailure(n),this._initializedDefer.reject(n)}return this._initializedDefer.promise}async enableUnmixedAudio(){const e=new Lv(this._unmixedAudioTelemetryLogger,"enable");try{if(![_v.Uninitialized,_v.Initializing,_v.Initialized].includes(this._state))throw Dv(Fv(this._state));if(1===this._tsCall.callType)throw Mv();if(this._pendingOperation)throw Pv();if("enable"===this._lastestSpatialAudioRequest&&!this._skipProviderStateCheck&&"active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState())throw new I({defaultError:f.FEATURES.UNMIXED_AUDIO.ENABLED});let t;this._pendingOperation=!0,e.logAttempt(),this._state===_v.Uninitialized?await this.initialize():this._state===_v.Initializing&&await this._initializedDefer.promise,void 0!==this._audioContext&&"closed"!==this._getAudioContextState()||(this._cleaupAudioNodes(),this._audioContext=new Uv(this._logger,this._audioContextSeq++)),"active"!==this._getUnmixedAudioProviderState()&&(t=new xv(this._operationTimeoutInMs,!0),this._activeStatePromises.add(t));const i=[["resume AudioContext","running"===this._getAudioContextState()?void 0:this._audioContext.resume(this._operationTimeoutInMs)],["enable spatial audio config",this._enableSpatialAudio(!0)],["wait for the unmixed audio active state to change to true",t?.wait()]];await this._runTasks(i),this._pendingOperation=!1,e.logSuccess(),this._logger.info(`UnmixedAudio is enabled. The AudioContext state is ${this._getAudioContextState()}.`)}catch(t){const i=this._getAudioContextState(),n=this._getUnmixedAudioProviderState(),r=Rv(t);this._logger.info(`Failed to enable unmixed audio: ${r}. AudioContext=${i}, UnmixedAudio=${n}`);const s={audioContextState:i,unmixedAudioState:n},a=function(e,t){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.FAILED_TO_ENABLE,defaultErrorMessageArgs:[t.audioContextState||"undefined",t.unmixedAudioState||"undefined"],originalError:e})}(t,s);!1===this._pendingOperation&&wv(a),e.logFailure(a,s),this._pendingOperation=!1,wv(a)}}async disableUnmixedAudio(){const e=new Lv(this._unmixedAudioTelemetryLogger,"disable");try{if(![_v.Initializing,_v.Initialized].includes(this._state))throw Dv(Fv(this._state));if(1===this._tsCall.callType)throw Mv();if(this._pendingOperation)throw Pv();if("disable"===this._lastestSpatialAudioRequest&&"active"!==this._getUnmixedAudioProviderState())throw new I({defaultError:f.FEATURES.UNMIXED_AUDIO.DISABLED});let t;this._pendingOperation=!0,e.logAttempt(),this._state===_v.Initializing&&await this._initializedDefer.promise,"inactive"!==this._getUnmixedAudioProviderState()&&(t=new xv(this._operationTimeoutInMs,!1),this._activeStatePromises.add(t));const i=[["disable spatial audio config",this._enableSpatialAudio(!1)],["wait for the unmixed audio active state to change to false",t?.wait()]];await this._runTasks(i),this._pendingOperation=!1,e.logSuccess(),this._logger.info("UnmixedAudio is disabled")}catch(t){const i=this._getAudioContextState(),n=this._getUnmixedAudioProviderState(),r=Rv(t);this._logger.info(`Failed to disable unmixed audio: ${r}. AudioContext=${i}, UnmixedAudio=${n}`);const s={audioContextState:i,unmixedAudioState:n},a=function(e,t){return new I({defaultError:f.FEATURES.UNMIXED_AUDIO.FAILED_TO_DISABLE,defaultErrorMessageArgs:[t.audioContextState||"undefined",t.unmixedAudioState||"undefined"],originalError:e})}(t,s);!1===this._pendingOperation&&wv(a),e.logFailure(a,s),this._pendingOperation=!1,wv(a)}}get isUnmixedAudioActive(){return this._state===_v.Initialized&&"active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}dispose(){this._state!==_v.Destroyed&&(this._state=_v.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(new I({defaultError:f.FEATURES.UNMIXED_AUDIO.DISPOSED})),this._listenerHandles.forEach((e=>e.dispose())),this._cleaupAudioNodes(),this._participantManager.dispose(),this._audioContext?.close(),this._activeStatePromises.forEach((e=>{e.cancel()})),this._activeStatePromises.clear(),this._eventEmitter.removeAllListeners())}_getAudioContextState(){return this._audioContext?.state??"unavailable"}_getUnmixedAudioProviderState(){return this._tsUnmixedAudioProvider?this._tsUnmixedAudioProvider.active?"active":"inactive":"unavailable"}_cleaupAudioNodes(){this._sourceStreamInfoList.forEach(((e,t)=>{const i=this._destinationStreamInfoList[t];void 0!==e&&void 0!==i&&e.audioNode.disconnect(i.audioNode),this._sourceStreamInfoList[t]=void 0,this._destinationStreamInfoList[t]=void 0})),this._destinationStreamInfoMap.clear()}_onStreamSourcesUpdatedHandler(e){const t=this._audioContext?.value;if(void 0===t||"running"!==t.state)return;const i=[];for(let n=0;n<this._maxStreamSize;n++){const r=n<e.length?e[n]:0,s=r?this._participantManager.findParticipantInfoBySourceId(r):void 0;let a=this._destinationStreamInfoList[n],o=this._sourceStreamInfoList[n];if(void 0===s)void 0!==a&&void 0!==o&&(o.audioNode.disconnect(a.audioNode),this._destinationStreamInfoList[n]=void 0);else{const e=this._tsUnmixedAudioProvider?.streams[n]??void 0;if(void 0!==o&&o.mediaStream!==e&&(void 0!==a&&o.audioNode.disconnect(a.audioNode),o=void 0,this._sourceStreamInfoList[n]=void 0),!e)continue;let r=!1;void 0!==o&&void 0!==a&&s.participantId!==a.participantId&&(o.audioNode.disconnect(a.audioNode),a=void 0,this._destinationStreamInfoList[n]=void 0),void 0===a&&(a=this._destinationStreamInfoMap.get(s.participantId),void 0===a&&(a={participantId:s.participantId,identifier:sl(s.mri),audioNode:t.createMediaStreamDestination()},this._destinationStreamInfoMap.set(s.participantId,a)),this._destinationStreamInfoList[n]=a,r=!0),void 0===o&&(o={mediaStream:e,audioNode:t.createMediaStreamSource(e)},this._sourceStreamInfoList[n]=o,r=!0),r&&o.audioNode.connect(a.audioNode),i.push({id:s.sourceId,stream:a.audioNode.stream,participantId:s.participantId,identifier:a.identifier})}}this._eventEmitter.emit("participantSpeaking",{speakers:i})}async _enableSpatialAudio(e){await this._tsCall.setAudioMidcallConfigJson({enableSpatialAudio:e}),this._lastestSpatialAudioRequest=e?"enable":"disable"}async _runTasks(e){let t;if((await Promise.allSettled(e.map((e=>e[1])))).forEach(((i,n)=>{"rejected"===i.status&&(this._logger.info(`Failed to ${e[n][0]}: ${Rv(i.reason)}}`),t=i)})),void 0!==t)throw t.reason}}class Bv{constructor(){this._isEnabled=yl().calling.teamsMeetingAudioConferencing.enabled,this._supportedConversationTypes=yl().calling.teamsMeetingAudioConferencing.supportedConversationTypes}initialize(e,t,i,n){this._logger=n.createChild((()=>`teamsMeetingAudioConferencing::Call(id='${e.callId}')`)),this._tsCall=e,this._telemetryLogManager=i,this._internalCallAgent=t;const r="initialize";if(this.sendFeatureUsage(r,Zu.initialize),!this.isSupportedConversationType()){const e=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS});throw this._logger.error(e.message),this.sendFeatureUsage(r,Zu.failure,e),e}this.sendFeatureUsage(r,Zu.success)}getTeamsMeetingAudioConferencingDetails(){const e="getTeamsMeetingAudioConferencingDetails";if(this.sendFeatureUsage(e,Zu.attempt),!this._isEnabled){const t=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DISABLED});return this._logger.error(t.message),this.sendFeatureUsage(e,Zu.failure,t),Promise.reject(t)}if(!this.isSupportedConversationType()){const t=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS});return this._logger.error(t.message),this.sendFeatureUsage(e,Zu.failure,t),Promise.reject(t)}let t;if(3!==this._tsCall.state)return t=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNAVAILABLE_BEFORE_JOINING}),10===this._tsCall.state&&(t=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNVAILABLE_IN_LOBBY})),this.sendFeatureUsage(e,Zu.failure,t),this._logger.error(t.message),Promise.reject(t);let i={phoneConferenceId:"",phoneNumbers:[]};try{const t=this._tsCall?.meetingDetails?.pstnDetails?.acpMcuInfo?.settings,n=this._tsCall?.meetingDetails?.pstnDetails?.meetingInvitePhoneNumbers;if(!t&&!n)throw new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DETAILS_NOT_CONFIGURED});return i={phoneConferenceId:t?.participantPasscode||"",phoneNumbers:n?.map((e=>({cityName:e?.cityName,countryName:e?.countryName,tollPhoneNumber:e?.isTollFree?null:sl(Mc+e.number),tollFreeNumber:e?.isTollFree?sl(Mc+e.number):null})))||[]},this._logger.info("Teams meeting audio conferencing details was retrieved successfully"),this.sendFeatureUsage(e,Zu.success),Promise.resolve(i)}catch(t){const i=new I({defaultError:f.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.GET_DETAILS_FAILED,originalError:t});throw this.sendFeatureUsage(e,Zu.failure,i),i}}isSupportedConversationType(){const e=this._tsCall.conversationType;let t=this._supportedConversationTypes.find((t=>t===e));return this._logger.info(`TeamsMeetingAudioConferencingDetails::ConversationType = \n            ${e}. ConversationType is supported = ${t}`),t}sendFeatureUsage(e,t,i){let n=i?{code:i?.code||_,subCode:i?.subCode||0,failureReason:i?.message||"",...jp(i)}:void 0;Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"TeamsMeetingAudioConferencing",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:n},this._telemetryLogManager,this._logger)}}var Hv,$v=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.TraceLevel=void 0,function(e){e[e.Error=10]="Error",e[e.Warning=15]="Warning",e[e.Info=50]="Info"}(t.TraceLevel||(t.TraceLevel={}))})),Gv=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MessageTrackingOption=t.ConnectionState=t.ServiceGeneratedClientIdName=t.SystemCommandsStateName=t.ConfigurationName=t.SystemSessionStateName=t.StateSubscriptionsName=void 0,t.StateSubscriptionsName="ConfigStateSubscriptions",t.SystemSessionStateName="systemSessionState",t.ConfigurationName="config",t.SystemCommandsStateName="systemCommands",t.ServiceGeneratedClientIdName="serviceGeneratedClientId",function(e){e[e.Disconnected=0]="Disconnected",e[e.Connected=1]="Connected",e[e.Connecting=2]="Connecting"}(t.ConnectionState||(t.ConnectionState={})),function(e){e[e.All=0]="All",e[e.Last=1]="Last",e[e.None=2]="None"}(t.MessageTrackingOption||(t.MessageTrackingOption={}))})),jv=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}},qv=Object.prototype.toString,Wv=(Hv=Object.create(null),function(e){var t=qv.call(e);return Hv[t]||(Hv[t]=t.slice(8,-1).toLowerCase())});function zv(e){return e=e.toLowerCase(),function(t){return Wv(t)===e}}function Jv(e){return Array.isArray(e)}function Kv(e){return void 0===e}var Yv=zv("ArrayBuffer");function Qv(e){return null!==e&&"object"==typeof e}function Xv(e){if("object"!==Wv(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}var Zv=zv("Date"),ey=zv("File"),ty=zv("Blob"),iy=zv("FileList");function ny(e){return"[object Function]"===qv.call(e)}var ry=zv("URLSearchParams");function sy(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),Jv(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)}var ay,oy=(ay="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(e){return ay&&e instanceof ay}),cy={isArray:Jv,isArrayBuffer:Yv,isBuffer:function(e){return null!==e&&!Kv(e)&&null!==e.constructor&&!Kv(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){var t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||qv.call(e)===t||ny(e.toString)&&e.toString()===t)},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Yv(e.buffer)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:Qv,isPlainObject:Xv,isUndefined:Kv,isDate:Zv,isFile:ey,isBlob:ty,isFunction:ny,isStream:function(e){return Qv(e)&&ny(e.pipe)},isURLSearchParams:ry,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:sy,merge:function e(){var t={};function i(i,n){Xv(t[n])&&Xv(i)?t[n]=e(t[n],i):Xv(i)?t[n]=e({},i):Jv(i)?t[n]=i.slice():t[n]=i}for(var n=0,r=arguments.length;n<r;n++)sy(arguments[n],i);return t},extend:function(e,t,i){return sy(t,(function(t,n){e[n]=i&&"function"==typeof t?jv(t,i):t})),e},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e},inherits:function(e,t,i,n){e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,i&&Object.assign(e.prototype,i)},toFlatObject:function(e,t,i){var n,r,s,a={};t=t||{};do{for(r=(n=Object.getOwnPropertyNames(e)).length;r-- >0;)a[s=n[r]]||(t[s]=e[s],a[s]=!0);e=Object.getPrototypeOf(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:Wv,kindOfTest:zv,endsWith:function(e,t,i){e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;var n=e.indexOf(t,i);return-1!==n&&n===i},toArray:function(e){if(!e)return null;var t=e.length;if(Kv(t))return null;for(var i=new Array(t);t-- >0;)i[t]=e[t];return i},isTypedArray:oy,isFileList:iy};function ly(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var dy=function(e,t,i){if(!t)return e;var n;if(i)n=i(t);else if(cy.isURLSearchParams(t))n=t.toString();else{var r=[];cy.forEach(t,(function(e,t){null!=e&&(cy.isArray(e)?t+="[]":e=[e],cy.forEach(e,(function(e){cy.isDate(e)?e=e.toISOString():cy.isObject(e)&&(e=JSON.stringify(e)),r.push(ly(t)+"="+ly(e))})))})),n=r.join("&")}if(n){var s=e.indexOf("#");-1!==s&&(e=e.slice(0,s)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e};function hy(){this.handlers=[]}hy.prototype.use=function(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},hy.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},hy.prototype.forEach=function(e){cy.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var uy=hy,gy=function(e,t){cy.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))};function py(e,t,i,n,r){Error.call(this),this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r)}cy.inherits(py,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var my=py.prototype,fy={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(e){fy[e]={value:e}})),Object.defineProperties(py,fy),Object.defineProperty(my,"isAxiosError",{value:!0}),py.from=function(e,t,i,n,r,s){var a=Object.create(my);return cy.toFlatObject(e,a,(function(e){return e!==Error.prototype})),py.call(a,e.message,t,i,n,r),a.name=e.name,s&&Object.assign(a,s),a};var Sy=py,vy={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};var yy=function(e,t){t=t||new FormData;var i=[];function n(e){return null===e?"":cy.isDate(e)?e.toISOString():cy.isArrayBuffer(e)||cy.isTypedArray(e)?"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}return function e(r,s){if(cy.isPlainObject(r)||cy.isArray(r)){if(-1!==i.indexOf(r))throw Error("Circular reference detected in "+s);i.push(r),cy.forEach(r,(function(i,r){if(!cy.isUndefined(i)){var a,o=s?s+"."+r:r;if(i&&!s&&"object"==typeof i)if(cy.endsWith(r,"{}"))i=JSON.stringify(i);else if(cy.endsWith(r,"[]")&&(a=cy.toArray(i)))return void a.forEach((function(e){!cy.isUndefined(e)&&t.append(o,n(e))}));e(i,o)}})),i.pop()}else t.append(s,n(r))}(e),t},Cy=cy.isStandardBrowserEnv()?{write:function(e,t,i,n,r,s){var a=[];a.push(e+"="+encodeURIComponent(t)),cy.isNumber(i)&&a.push("expires="+new Date(i).toGMTString()),cy.isString(n)&&a.push("path="+n),cy.isString(r)&&a.push("domain="+r),!0===s&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},_y=function(e,t){return e&&!function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}(t)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t},Ey=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],Ty=cy.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(e){var n=e;return t&&(i.setAttribute("href",n),n=i.href),i.setAttribute("href",n),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=n(window.location.href),function(t){var i=cy.isString(t)?n(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0};function Iy(e){Sy.call(this,null==e?"canceled":e,Sy.ERR_CANCELED),this.name="CanceledError"}cy.inherits(Iy,Sy,{__CANCEL__:!0});var by=Iy,Ay=function(e){return new Promise((function(t,i){var n,r=e.data,s=e.headers,a=e.responseType;function o(){e.cancelToken&&e.cancelToken.unsubscribe(n),e.signal&&e.signal.removeEventListener("abort",n)}cy.isFormData(r)&&cy.isStandardBrowserEnv()&&delete s["Content-Type"];var c=new XMLHttpRequest;if(e.auth){var l=e.auth.username||"",d=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";s.Authorization="Basic "+btoa(l+":"+d)}var h=_y(e.baseURL,e.url);function u(){if(c){var n="getAllResponseHeaders"in c?function(e){var t,i,n,r={};return e?(cy.forEach(e.split("\n"),(function(e){if(n=e.indexOf(":"),t=cy.trim(e.substr(0,n)).toLowerCase(),i=cy.trim(e.substr(n+1)),t){if(r[t]&&Ey.indexOf(t)>=0)return;r[t]="set-cookie"===t?(r[t]?r[t]:[]).concat([i]):r[t]?r[t]+", "+i:i}})),r):r}(c.getAllResponseHeaders()):null;(function(e,t,i){var n=i.config.validateStatus;i.status&&n&&!n(i.status)?t(new Sy("Request failed with status code "+i.status,[Sy.ERR_BAD_REQUEST,Sy.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)})((function(e){t(e),o()}),(function(e){i(e),o()}),{data:a&&"text"!==a&&"json"!==a?c.response:c.responseText,status:c.status,statusText:c.statusText,headers:n,config:e,request:c}),c=null}}if(c.open(e.method.toUpperCase(),dy(h,e.params,e.paramsSerializer),!0),c.timeout=e.timeout,"onloadend"in c?c.onloadend=u:c.onreadystatechange=function(){c&&4===c.readyState&&(0!==c.status||c.responseURL&&0===c.responseURL.indexOf("file:"))&&setTimeout(u)},c.onabort=function(){c&&(i(new Sy("Request aborted",Sy.ECONNABORTED,e,c)),c=null)},c.onerror=function(){i(new Sy("Network Error",Sy.ERR_NETWORK,e,c,c)),c=null},c.ontimeout=function(){var t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",n=e.transitional||vy;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(new Sy(t,n.clarifyTimeoutError?Sy.ETIMEDOUT:Sy.ECONNABORTED,e,c)),c=null},cy.isStandardBrowserEnv()){var g=(e.withCredentials||Ty(h))&&e.xsrfCookieName?Cy.read(e.xsrfCookieName):void 0;g&&(s[e.xsrfHeaderName]=g)}"setRequestHeader"in c&&cy.forEach(s,(function(e,t){void 0===r&&"content-type"===t.toLowerCase()?delete s[t]:c.setRequestHeader(t,e)})),cy.isUndefined(e.withCredentials)||(c.withCredentials=!!e.withCredentials),a&&"json"!==a&&(c.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&c.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&c.upload&&c.upload.addEventListener("progress",e.onUploadProgress),(e.cancelToken||e.signal)&&(n=function(e){c&&(i(!e||e&&e.type?new by:e),c.abort(),c=null)},e.cancelToken&&e.cancelToken.subscribe(n),e.signal&&(e.signal.aborted?n():e.signal.addEventListener("abort",n))),r||(r=null);var p=function(e){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(h);p&&-1===["http","https","file"].indexOf(p)?i(new Sy("Unsupported protocol "+p+":",Sy.ERR_BAD_REQUEST,e)):c.send(r)}))},Ry={"Content-Type":"application/x-www-form-urlencoded"};function wy(e,t){!cy.isUndefined(e)&&cy.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var Py={transitional:vy,adapter:function(){var e;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(e=Ay),e}(),transformRequest:[function(e,t){if(gy(t,"Accept"),gy(t,"Content-Type"),cy.isFormData(e)||cy.isArrayBuffer(e)||cy.isBuffer(e)||cy.isStream(e)||cy.isFile(e)||cy.isBlob(e))return e;if(cy.isArrayBufferView(e))return e.buffer;if(cy.isURLSearchParams(e))return wy(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString();var i,n=cy.isObject(e),r=t&&t["Content-Type"];if((i=cy.isFileList(e))||n&&"multipart/form-data"===r){var s=this.env&&this.env.FormData;return yy(i?{"files[]":e}:e,s&&new s)}return n||"application/json"===r?(wy(t,"application/json"),function(e,t,i){if(cy.isString(e))try{return(t||JSON.parse)(e),cy.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(i||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){var t=this.transitional||Py.transitional,i=t&&t.silentJSONParsing,n=t&&t.forcedJSONParsing,r=!i&&"json"===this.responseType;if(r||n&&cy.isString(e)&&e.length)try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw Sy.from(e,Sy.ERR_BAD_RESPONSE,this,null,this.response);throw e}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:null},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};cy.forEach(["delete","get","head"],(function(e){Py.headers[e]={}})),cy.forEach(["post","put","patch"],(function(e){Py.headers[e]=cy.merge(Ry)}));var My=Py,Dy=function(e,t,i){var n=this||My;return cy.forEach(i,(function(i){e=i.call(n,e,t)})),e},Oy=function(e){return!(!e||!e.__CANCEL__)};function ky(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new by}var Ny=function(e){return ky(e),e.headers=e.headers||{},e.data=Dy.call(e,e.data,e.headers,e.transformRequest),e.headers=cy.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),cy.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||My.adapter)(e).then((function(t){return ky(e),t.data=Dy.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return Oy(t)||(ky(e),t&&t.response&&(t.response.data=Dy.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},Ly=function(e,t){t=t||{};var i={};function n(e,t){return cy.isPlainObject(e)&&cy.isPlainObject(t)?cy.merge(e,t):cy.isPlainObject(t)?cy.merge({},t):cy.isArray(t)?t.slice():t}function r(i){return cy.isUndefined(t[i])?cy.isUndefined(e[i])?void 0:n(void 0,e[i]):n(e[i],t[i])}function s(e){if(!cy.isUndefined(t[e]))return n(void 0,t[e])}function a(i){return cy.isUndefined(t[i])?cy.isUndefined(e[i])?void 0:n(void 0,e[i]):n(void 0,t[i])}function o(i){return i in t?n(e[i],t[i]):i in e?n(void 0,e[i]):void 0}var c={url:s,method:s,data:s,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o};return cy.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=c[e]||r,n=t(e);cy.isUndefined(n)&&t!==o||(i[e]=n)})),i},xy="0.27.2",Uy=xy,Fy={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){Fy[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));var Vy={};Fy.transitional=function(e,t,i){function n(e,t){return"[Axios v"+Uy+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return function(i,r,s){if(!1===e)throw new Sy(n(r," has been removed"+(t?" in "+t:"")),Sy.ERR_DEPRECATED);return t&&!Vy[r]&&(Vy[r]=!0,console.warn(n(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,r,s)}};var By={assertOptions:function(e,t,i){if("object"!=typeof e)throw new Sy("options must be an object",Sy.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(e),r=n.length;r-- >0;){var s=n[r],a=t[s];if(a){var o=e[s],c=void 0===o||a(o,s,e);if(!0!==c)throw new Sy("option "+s+" must be "+c,Sy.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new Sy("Unknown option "+s,Sy.ERR_BAD_OPTION)}},validators:Fy},Hy=By.validators;function $y(e){this.defaults=e,this.interceptors={request:new uy,response:new uy}}$y.prototype.request=function(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},(t=Ly(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var i=t.transitional;void 0!==i&&By.assertOptions(i,{silentJSONParsing:Hy.transitional(Hy.boolean),forcedJSONParsing:Hy.transitional(Hy.boolean),clarifyTimeoutError:Hy.transitional(Hy.boolean)},!1);var n=[],r=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(r=r&&e.synchronous,n.unshift(e.fulfilled,e.rejected))}));var s,a=[];if(this.interceptors.response.forEach((function(e){a.push(e.fulfilled,e.rejected)})),!r){var o=[Ny,void 0];for(Array.prototype.unshift.apply(o,n),o=o.concat(a),s=Promise.resolve(t);o.length;)s=s.then(o.shift(),o.shift());return s}for(var c=t;n.length;){var l=n.shift(),d=n.shift();try{c=l(c)}catch(e){d(e);break}}try{s=Ny(c)}catch(e){return Promise.reject(e)}for(;a.length;)s=s.then(a.shift(),a.shift());return s},$y.prototype.getUri=function(e){e=Ly(this.defaults,e);var t=_y(e.baseURL,e.url);return dy(t,e.params,e.paramsSerializer)},cy.forEach(["delete","get","head","options"],(function(e){$y.prototype[e]=function(t,i){return this.request(Ly(i||{},{method:e,url:t,data:(i||{}).data}))}})),cy.forEach(["post","put","patch"],(function(e){function t(t){return function(i,n,r){return this.request(Ly(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}$y.prototype[e]=t(),$y.prototype[e+"Form"]=t(!0)}));var Gy=$y;function jy(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;this.promise.then((function(e){if(i._listeners){var t,n=i._listeners.length;for(t=0;t<n;t++)i._listeners[t](e);i._listeners=null}})),this.promise.then=function(e){var t,n=new Promise((function(e){i.subscribe(e),t=e})).then(e);return n.cancel=function(){i.unsubscribe(t)},n},e((function(e){i.reason||(i.reason=new by(e),t(i.reason))}))}jy.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},jy.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},jy.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},jy.source=function(){var e;return{token:new jy((function(t){e=t})),cancel:e}};var qy=jy;var Wy=function e(t){var i=new Gy(t),n=jv(Gy.prototype.request,i);return cy.extend(n,Gy.prototype,i),cy.extend(n,i),n.create=function(i){return e(Ly(t,i))},n}(My);Wy.Axios=Gy,Wy.CanceledError=by,Wy.CancelToken=qy,Wy.isCancel=Oy,Wy.VERSION=xy,Wy.toFormData=yy,Wy.AxiosError=Sy,Wy.Cancel=Wy.CanceledError,Wy.all=function(e){return Promise.all(e)},Wy.spread=function(e){return function(t){return e.apply(null,t)}},Wy.isAxiosError=function(e){return cy.isObject(e)&&!0===e.isAxiosError};var zy=Wy,Jy=Wy;zy.default=Jy;for(var Ky=zy,Yy=a((function(e){var t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(t){var i=new Uint8Array(16);e.exports=function(){return t(i),i}}else{var n=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)!(3&t)&&(e=4294967296*Math.random()),n[t]=e>>>((3&t)<<3)&255;return n}}})),Qy=[],Xy=0;Xy<256;++Xy)Qy[Xy]=(Xy+256).toString(16).substr(1);var Zy,eC,tC=function(e,t){var i=t||0,n=Qy;return[n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]]].join("")},iC=0,nC=0;var rC=function(e,t,i){var n=t&&i||0,r=t||[],s=(e=e||{}).node||Zy,a=void 0!==e.clockseq?e.clockseq:eC;if(null==s||null==a){var o=Yy();null==s&&(s=Zy=[1|o[0],o[1],o[2],o[3],o[4],o[5]]),null==a&&(a=eC=16383&(o[6]<<8|o[7]))}var c=void 0!==e.msecs?e.msecs:(new Date).getTime(),l=void 0!==e.nsecs?e.nsecs:nC+1,d=c-iC+(l-nC)/1e4;if(d<0&&void 0===e.clockseq&&(a=a+1&16383),(d<0||c>iC)&&void 0===e.nsecs&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");iC=c,nC=l,eC=a;var h=(1e4*(268435455&(c+=122192928e5))+l)%4294967296;r[n++]=h>>>24&255,r[n++]=h>>>16&255,r[n++]=h>>>8&255,r[n++]=255&h;var u=c/4294967296*1e4&268435455;r[n++]=u>>>8&255,r[n++]=255&u,r[n++]=u>>>24&15|16,r[n++]=u>>>16&255,r[n++]=a>>>8|128,r[n++]=255&a;for(var g=0;g<6;++g)r[n+g]=s[g];return t||tC(r)};var sC=function(e,t,i){var n=t&&i||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var r=(e=e||{}).random||(e.rng||Yy)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t)for(var s=0;s<16;++s)t[n+s]=r[s];return t||tC(r)},aC=sC;aC.v1=rC,aC.v4=sC;var oC=aC,cC=a((function(e,t){var i=s&&s.__assign||function(){return i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.errorToString=void 0,t.errorToString=function(e,t){if(void 0===t&&(t=!0),null==e)return"";if("string"==typeof e)return e;try{return JSON.stringify(e,r(n(t)))}catch(e){return"Stringifying error failed"}};var n=function(e){return void 0===e&&(e=!1),function(t,n){return n instanceof Error?i({name:n.name,message:n.message,stack:e?[]:("string"==typeof n.stack?n.stack:"").split("\n").map((function(e){return e.trim()})).filter((function(e){return!!e}))},n):n}},r=function(e){var t=new WeakSet;return function(i,n){if("object"==typeof n&&null!==n){if(t.has(n))return;t.add(n)}return e(i,n)}}})),lC=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.EvictingQueue=void 0;var i=function(){function e(e){this.maxSize=e,this._store=[]}return Object.defineProperty(e.prototype,"store",{get:function(){return this._store},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._store.length},enumerable:!1,configurable:!0}),e.prototype.enqueue=function(e){this._store.length>=this.maxSize&&this._store.shift(),this._store.push(e)},e.prototype.dequeue=function(){return this._store.shift()},e.prototype.clear=function(){this._store=[]},e.prototype.forEach=function(e){this._store.forEach(e)},e}();t.EvictingQueue=i})),dC=a((function(e,t){var i=s&&s.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},n=s&&s.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(e){return function(t){return c([e,t])}}function c(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{i=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleSyncCell=void 0;var r=function(){function e(e,t,i,n,r){this.m_id=e,this.m_sender=t,this.m_shouldEmitEventForAllMessages=i,this.aggregation=r,this.m_events=new ep.EventEmitter,this.m_emitUnacknowledgedEventFor=null!=n?n:Gv.MessageTrackingOption.None}return e.prototype.on=function(e,t){return this.m_events.on(e,t),this},e.prototype.off=function(e,t){return this.m_events.off(e,t),this},e.prototype.removeAllListeners=function(e){return this.m_events.removeAllListeners(e),this},e.prototype.id=function(){return this.m_id},e.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},e.prototype.getAsync=function(){return i(this,void 0,void 0,(function(){return n(this,(function(e){return[2,this.m_value]}))}))},e.prototype.setAsync=function(e){return i(this,void 0,void 0,(function(){var t;return n(this,(function(i){return this.m_value=e,t={messageId:oC.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"set",value:JSON.stringify(this.m_value)},this.m_sender.sendStateMessage(t),[2]}))}))},e.prototype.delete=function(){this.m_value=void 0;var e={messageId:oC.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"delete",value:""};this.m_sender.sendStateMessage(e)},e.prototype.handleStateMessage=function(e){switch(e.operation){case"set":return void((JSON.stringify(this.m_value)!==e.value||this.m_shouldEmitEventForAllMessages)&&(this.m_value=JSON.parse(e.value),this.m_events.emit("valueChanged",this.m_value,e)));case"delete":return this.m_value=void 0,void this.m_events.emit("valueDeleted",this.m_value,e);default:return}},e.prototype.handleUnacknowledgedMessage=function(e){this.m_events.emit("valueUnacknowledged",e)},e.prototype.beginAggregatedStateUpdating=function(){var e;null===(e=this.aggregation)||void 0===e||e.beginAggregatedStateUpdating()},e.prototype.endAggregatedStateUpdating=function(){var e;null===(e=this.aggregation)||void 0===e||e.endAggregatedStateUpdating()},e}();t.SimpleSyncCell=r})),hC=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isPrefixDeleteMessage=void 0,t.isPrefixDeleteMessage=function(e){return"delete"===e.operation&&"prefix"===e.value}})),uC=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleSyncMap=void 0;var i=function(){function e(e,t,i,n,r){this.m_id=e,this.m_sender=t,this.m_shouldEmitEventForAllMessages=i,this.aggregation=r,this.m_events=new ep.EventEmitter,this.m_map=new Map,this.m_emitUnacknowledgedEventFor=null!=n?n:Gv.MessageTrackingOption.None}return e.prototype.on=function(e,t){return this.m_events.on(e,t),this},e.prototype.off=function(e,t){return this.m_events.off(e,t),this},e.prototype.removeAllListeners=function(e){return this.m_events.removeAllListeners(e),this},e.prototype.id=function(){return this.m_id},e.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},e.prototype.get=function(e){return this.m_map.get(e)},e.prototype.set=function(e,t){this.m_map.set(e,t);var i={messageId:oC.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"set",property:e,value:JSON.stringify(t)};this.m_sender.sendStateMessage(i)},e.prototype.delete=function(e){var t={messageId:oC.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:e,value:""};this.performLocalDelete(t),this.m_sender.sendStateMessage(t)},e.prototype.deleteWithPrefix=function(e){var t={messageId:oC.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:e,value:"prefix"};this.performLocalDelete(t),this.m_sender.sendStateMessage(t)},e.prototype.forEach=function(e){this.m_map.forEach(e)},e.prototype.handleStateMessage=function(e){switch(e.operation){case"set":return void this.handleSet(e);case"delete":return void this.handleDelete(e);default:return}},e.prototype.handleSet=function(e){if(!e.property)throw new Error("property is missing for a map.");(JSON.stringify(this.m_map.get(e.property))!==e.value||this.m_shouldEmitEventForAllMessages)&&(this.m_map.set(e.property,JSON.parse(e.value)),this.m_events.emit("valueChanged",e.property,e))},e.prototype.handleDelete=function(e){this.performLocalDelete(e),hC.isPrefixDeleteMessage(e)?this.m_events.emit("valuesDeletedWithPrefix",e.property,e):this.m_events.emit("valueDeleted",e.property||"",e)},e.prototype.handleUnacknowledgedMessage=function(e){this.m_events.emit("valueUnacknowledged",e)},e.prototype.beginAggregatedStateUpdating=function(){var e;null===(e=this.aggregation)||void 0===e||e.beginAggregatedStateUpdating()},e.prototype.endAggregatedStateUpdating=function(){var e;null===(e=this.aggregation)||void 0===e||e.endAggregatedStateUpdating()},e.prototype.performLocalDelete=function(e){var t=this;if(e.property){var i=e.property;hC.isPrefixDeleteMessage(e)?this.m_map.forEach((function(e,n){n.startsWith(i)&&t.m_map.delete(n)})):this.m_map.delete(e.property)}else this.m_map.clear()},e}();t.SimpleSyncMap=i})),gC=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleServicePerformanceTelemetry=t.SimpleServiceTelemetry=void 0;var i=function(){function e(e,t,i){this.backendService="SimpleService",this.clientId=e,this.sessionId=t,this.wsReconnectCount=0,this.wsState=Gv.ConnectionState[Gv.ConnectionState.Disconnected],this.maxRoundtripRaw=i||0,this.roundtripTelemetry=new n,this.messageHandleTelemetry=new n,this.offlineCacheTelemetry={cachedCount:0,resentCount:0,expiredCount:0,rejectedCount:0},this.maxRoundtripRaw>0&&(this.roundtripRaw=[]),this.messagePendingAckCount=0,this.unacknowledgedMessagesCount=0,this.messageRequested={},this.messageReceived={},this.messageAcknowledged={}}return e.prototype.addRoundtripLatency=function(e){this.roundtripRaw&&this.roundtripRaw.length<this.maxRoundtripRaw&&this.roundtripRaw.push(e),this.roundtripTelemetry.addLatency(e)},e.prototype.addMessageHandleLatency=function(e){this.messageHandleTelemetry.addLatency(e)},e.prototype.incrementAcknowledgedCount=function(e){this.incrementMessageCount(this.messageAcknowledged,e)},e.prototype.incrementRequestedCount=function(e){this.incrementMessageCount(this.messageRequested,e)},e.prototype.incrementReceivedCount=function(e){this.incrementMessageCount(this.messageReceived,e)},e.prototype.incrementMessageCount=function(e,t){var i=e[t],n=void 0===i?1:i+1;e[t]=n},e}();t.SimpleServiceTelemetry=i;var n=function(){function e(){this.count=0,this.minValue=0,this.maxValue=0,this.avgValue=0}return e.prototype.addLatency=function(e){this.count+=1,this.avgValue=this.avgValue+(e-this.avgValue)/this.count,this.minValue=this.count>1?Math.min(e,this.minValue):e,this.maxValue=Math.max(this.maxValue,e)},e}();t.SimpleServicePerformanceTelemetry=n})),pC=a((function(e,t){var i=s&&s.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},n=s&&s.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(e){return function(t){return c([e,t])}}function c(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{i=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}};Object.defineProperty(t,"__esModule",{value:!0}),t.StateServiceWebSocketConnection=void 0;var r=function(){function e(e,t){var r=this;this.onopen=null,this.onclose=null,this.onerror=null,this.onmessage=null,this.onlog=null,this.ws=new WebSocket(e),this.settings=t,this.ws.onopen=function(e){return i(r,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return this.onopen&&this.onopen(e),[4,this.sendSetupMessages()];case 1:return t.sent(),[2]}}))}))},this.ws.onclose=function(e){r.onclose&&r.onclose(e)},this.ws.onerror=function(e){r.onerror&&r.onerror(e)},this.ws.onmessage=function(e){r.onmessage&&r.onmessage(e)}}return e.CreateAsync=function(t,r){return i(this,void 0,void 0,(function(){return n(this,(function(i){return[2,new e(t,r)]}))}))},Object.defineProperty(e.prototype,"name",{get:function(){return"WebSocket"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this.ws.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isOpen",{get:function(){return this.ws.readyState===WebSocket.OPEN},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shouldSendPings",{get:function(){return!0},enumerable:!1,configurable:!0}),e.prototype.close=function(){this.ws.close()},e.prototype.send=function(e){this.ws.send(e)},e.prototype.sendSetupMessages=function(){return i(this,void 0,void 0,(function(){var e,t,i,r,s,a,o=this;return n(this,(function(n){switch(n.label){case 0:return(t=this.settings.getAuthTokenAsync)?[4,this.settings.getAuthTokenAsync()]:[3,2];case 1:t=n.sent(),n.label=2;case 2:return e=t,i=this.settings,r=i.metadata,s=i.subscriptions,a={authToken:e,metadata:r,subscriptions:s},this.settings.createSetupMessage(a).forEach((function(e){return o.send(e)})),[2]}}))}))},e}();t.StateServiceWebSocketConnection=r})),mC=a((function(e,t){var i=s&&s.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},n=s&&s.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(e){return function(t){return c([e,t])}}function c(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{i=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}},r=s&&s.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},a=s&&s.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleStateServiceProxy=void 0;var o=a(Ky),c=[2e3,2e3,3e3,3e3,5e3],l=function(){function e(e,t,i,n,r,s){var a;this.m_events=new ep.EventEmitter,this.m_clientId="",this.m_connectionState=Gv.ConnectionState.Disconnected,this.m_handlers=new Map,this.m_connection=null,this.m_clientIds=new Set,this.m_initTimeoutDurationInMS=0,this.m_retryAttempts=0,this.m_sessionRetryAttempts=0,this.m_maxSessionRetries=0,this.m_outboundMessageInfo=new Map,this.m_initPromise={promise:null,resolve:null,reject:null},this.m_messageBuffer=[],this.m_batchWaitTimeMS=20,this.m_batchMessageTypeName="list",this.m_closeConnectionTimer=null,this.m_lastCloseCode=0,this.m_lastCloseReason="",this.m_offlineMessageCache=[],this.m_unacknowledgedMessages=new Map,this.m_sessionId=e,this.m_logger=n,this.m_connectionAliveTimeAfterLoseFocusInMS=r.websocketAliveTimeAfterLoseFocusInMS,this.m_useServiceGeneratedClientId=r.useServiceGeneratedClientId||!1,this.m_wsUrl=i+"?docId="+this.m_sessionId+"&clientType="+t,r.correlationId&&(this.m_wsUrl+="&cid="+r.correlationId),r.isAutomation&&(this.m_wsUrl+="&automation=true"),r.autoRoutingEnabled&&(this.m_wsUrl+="&routing=true"),this.m_useServiceGeneratedClientId||(this.m_clientId=r.customClientId||oC.v4(),this.m_wsUrl+="&clientId="+this.m_clientId),this.m_deltasBaseUrl=i.replace("wss://","https://").replace("ws://","http://"),this.setupSystemClientsCell(),this.setUpSystemCommandsCell(),this.setupServiceGeneratedClientIdCell(),this.m_useServiceGeneratedClientId&&(this.m_clientIdEvictingQueue=new lC.EvictingQueue(20)),this.m_telemetry=new gC.SimpleServiceTelemetry(this.m_clientId,this.m_sessionId,r.maxRoundtripRaw),this.m_verbose=r.verbose||!1,this.m_batchedRequestsEnabled=r.batchedRequestsEnabled,this.m_initTimeoutDurationInMS=r.initTimeoutDurationInMs||0,this.m_pingTimeoutInMs=r.pingTimeoutInMs,this.m_pongTimeoutInMs=r.pongTimeoutInMs,this.m_user=s,this.m_metadata=r.metadata,this.m_retryIntervalsInMs=r.retryIntervalsInMs||c,this.m_maxSessionRetries=r.maxSessionRetries,this.m_offlineMessageCacheEnabled=r.offlineMessageCacheEnabled,this.m_maxOfflineMessageCacheTimeInMs=r.maxOfflineMessageCacheTimeInMs,this.m_maxOfflineMessageCacheLength=r.maxOfflineMessageCacheLength,this.m_allowReconnectOnMessageSend=r.allowReconnectOnSendMessage||!1,this.m_unacknowledgedMaxTimeInMs=null!==(a=r.unacknowledgeMessageTimeoutInMs)&&void 0!==a?a:0,this.m_subscriptions=r.subscriptions,this.m_connectionSettings={getAuthTokenAsync:this.getAuthToken.bind(this),createSetupMessage:this.createSetupMessage.bind(this),metadata:this.m_metadata,subscriptions:this.m_subscriptions}}return Object.defineProperty(e.prototype,"lastCloseReason",{get:function(){return this.m_lastCloseReason},enumerable:!1,configurable:!0}),e.prototype.senderId=function(){return this.m_clientId},e.prototype.countOfOutboundMessagesNotRoundTrippedYet=function(){return this.m_outboundMessageInfo.size},e.prototype.canRetry=function(){return this.m_connectionState===Gv.ConnectionState.Disconnected&&4321!==this.m_lastCloseCode},e.prototype.getServiceTelemetry=function(){return this.m_telemetry.wsState=Gv.ConnectionState[this.getConnectionState()],this.m_telemetry.messagePendingAckCount=this.m_outboundMessageInfo.size,this.m_telemetry},e.prototype.activeClientCount=function(){return this.m_clientIds.size},e.prototype.activeClientIds=function(){return this.m_clientIds},e.prototype.clientId=function(){return this.m_clientId},e.prototype.getConnectionState=function(){return this.m_connectionState},e.prototype.on=function(e,t){return this.m_events.on(e,t),this},e.prototype.connectAsync=function(){return i(this,void 0,void 0,(function(){var e=this;return n(this,(function(t){return this.m_initPromise.promise=new Promise((function(t,i){e.m_initPromise.resolve=t,e.m_initPromise.reject=i})),this.setConnectionState(Gv.ConnectionState.Connecting),[2,new Promise((function(t,r){return i(e,void 0,void 0,(function(){var e,i=this;return n(this,(function(n){switch(n.label){case 0:return e=this,[4,pC.StateServiceWebSocketConnection.CreateAsync(this.m_wsUrl,this.m_connectionSettings)];case 1:return e.m_connection=n.sent(),this.m_connection.onopen=function(){i.handleConnectionOpen(),i.startInitTimeoutTimerWithRetry(i.m_initTimeoutDurationInMS,i.m_initPromise.reject),t()},this.m_connection.onerror=function(e){var n;i.m_logger.sendTraceTag(590213388,$v.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(n=i.m_connection)||void 0===n?void 0:n.name)+" onerror. {sessionId: "+i.m_sessionId+", ClientId: "+i.m_clientId+", Error: "+JSON.stringify(e)+"}"),i.retryConnection((function(e){var t,n="failed to reconnect after "+(null===(t=i.m_connection)||void 0===t?void 0:t.name)+" error: "+cC.errorToString(e);i.m_logger.sendTraceTag(579463185,$v.TraceLevel.Error,n),r(n)}),!1,(function(){return t()}))},this.m_connection.onlog=function(e){var t;i.m_logger.sendTraceTag(556909603,e.detail.level,"SimpleStateServiceProxy::log - "+(null===(t=i.m_connection)||void 0===t?void 0:t.name)+" {sessionId: "+i.m_sessionId+", ClientId: "+i.m_clientId+", Message: "+e.detail.message+"}")},this.m_connection.onclose=function(e){var n,s;i.m_logger.sendTraceTag(590213389,$v.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(n=i.m_connection)||void 0===n?void 0:n.name)+" onclose. {sessionId: "+i.m_sessionId+", ClientId: "+i.m_clientId+", Code: "+e.code+", Reason: "+e.reason+"}"),i.m_lastCloseCode=e.code,i.m_lastCloseReason=e.reason,4321!==e.code?i.retryConnection((function(e){var t="failed to reconnect after service side disconnect: "+cC.errorToString(e);i.m_logger.sendTraceTag(579463186,$v.TraceLevel.Error,t),r(t)}),!1,(function(){return t()})):(i.setConnectionState(Gv.ConnectionState.Disconnected),i.m_logger.sendTraceTag(588009741,$v.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(s=i.m_connection)||void 0===s?void 0:s.name)+" onclose. Not retryable close code. {sessionId: "+i.m_sessionId+", ClientId: "+i.m_clientId+"}"))},this.m_connection.onmessage=function(e){var t;try{i.handleConnectionMessage(e)}catch(e){i.m_logger.sendTraceTag(590213390,$v.TraceLevel.Error,"SimpleStateServiceProxy::onmessage - "+(null===(t=i.m_connection)||void 0===t?void 0:t.name)+" error. {sessionId: "+i.m_sessionId+", ClientId: "+i.m_clientId+", Error: "+cC.errorToString(e)+"}")}},[2]}}))}))}))]}))}))},e.prototype.close=function(){var e;this.m_logger.sendTraceTag(590213400,$v.TraceLevel.Info,"SimpleStateServiceProxy::close. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.closeAndClearConnection(),this.m_retryTimer&&(clearTimeout(this.m_retryTimer),this.m_retryTimer=null),this.m_unacknowledgedMessages.clear(),this.clearPingPongTimer(),this.clearOfflineMessageCacheTimer(),this.clearInitTimeoutTimer(),this.clearUnacknowledgedTimer(),null===(e=this.m_clientIdEvictingQueue)||void 0===e||e.clear(),0!==this.countOfOutboundMessagesNotRoundTrippedYet()&&(this.m_events.emit("messageFailedToRoundTripOnClose",this.m_outboundMessageInfo.size),this.m_outboundMessageInfo.clear())},e.prototype.sendStateMessage=function(e){this.sendStateMessageImpl(e)},e.prototype.createMapAsync=function(e,t,r,s){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){return i=new uC.SimpleSyncMap(e,this,t,r,s),this.m_handlers.set(e,i),[2,i]}))}))},e.prototype.getMapAsync=function(e){return i(this,void 0,void 0,(function(){var t;return n(this,(function(i){return(t=this.m_handlers.get(e))?[2,t]:[2,null]}))}))},e.prototype.waitMapAsync=function(e,t,r,s){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){switch(n.label){case 0:return[4,this.m_initPromise.promise];case 1:return n.sent(),[4,this.getMapAsync(e)];case 2:return(i=n.sent())?[3,4]:[4,this.createMapAsync(e,t,r,s)];case 3:i=n.sent(),n.label=4;case 4:return[2,i]}}))}))},e.prototype.createCellAsync=function(e,t,r,s){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){return i=new dC.SimpleSyncCell(e,this,t,r,s),this.m_handlers.set(e,i),[2,i]}))}))},e.prototype.getCellAsync=function(e){return i(this,void 0,void 0,(function(){var t;return n(this,(function(i){return(t=this.m_handlers.get(e))?[2,t]:[2,null]}))}))},e.prototype.waitCellAsync=function(e,t,r,s){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){switch(n.label){case 0:return this.m_logger.sendTraceTag(520161040,$v.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - awaiting initPromise "+e),[4,this.m_initPromise.promise];case 1:return n.sent(),this.m_logger.sendTraceTag(520161039,$v.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - getCellAsync "+e),[4,this.getCellAsync(e)];case 2:return(i=n.sent())?[3,4]:(this.m_logger.sendTraceTag(520161038,$v.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - createCellAsync "+e),[4,this.createCellAsync(e,t,r,s)]);case 3:i=n.sent(),n.label=4;case 4:return[2,i]}}))}))},e.prototype.onFocusChanged=function(e){var t=this;e?(window.clearTimeout(this.m_closeConnectionTimer),this.m_connection||(this.m_logger.sendTraceTag(590213392,$v.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - retryConnection due to getting focus again. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.retryConnection((function(e){t.m_logger.sendTraceTag(579463187,$v.TraceLevel.Error,"failed to reconnect after regaining focus: "+cC.errorToString(e))}),!0))):this.m_closeConnectionTimer=window.setTimeout((function(){var e;t.m_connection&&(t.m_logger.sendTraceTag(590213391,$v.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - "+(null===(e=t.m_connection)||void 0===e?void 0:e.name)+" close due to losing focus. {sessionId: "+t.m_sessionId+", ClientId: "+t.m_clientId+"}"),t.m_connection.onclose=function(){},t.m_connection.close(),t.m_connection=null)}),this.m_connectionAliveTimeAfterLoseFocusInMS)},e.prototype.getHistoryAsync=function(e,t){return i(this,void 0,void 0,(function(){var i,r;return n(this,(function(n){switch(n.label){case 0:return(i=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),i.searchParams.append("docId",this.m_sessionId),i.searchParams.append("cid",this.m_clientId),i.searchParams.append("objectId",e),t&&i.searchParams.append("property",t),[4,o.default.get(i.toString())];case 1:return(r=n.sent().data).forEach((function(e){return e.value=JSON.parse(e.value)})),[2,r]}}))}))},e.prototype.getHistoryWithPaginationAsync=function(e,t,r){return i(this,void 0,void 0,(function(){var i,s;return n(this,(function(n){switch(n.label){case 0:return(i=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),i.searchParams.append("docId",this.m_sessionId),i.searchParams.append("cid",this.m_clientId),i.searchParams.append("objectId",e),i.searchParams.append("pagination","true"),r&&i.searchParams.append("cursor",r),t&&i.searchParams.append("property",t),[4,o.default.get(i.toString())];case 1:return(s=n.sent().data).messages.forEach((function(e){return e.value=JSON.parse(e.value)})),[2,s]}}))}))},e.prototype.setupSystemClientsCell=function(){var e=this;this.m_clientsCell=new dC.SimpleSyncCell("systemClients",this),this.m_handlers.set(this.m_clientsCell.id(),this.m_clientsCell),this.m_clientsCell.on("valueChanged",(function(t){e.m_clientIds=new Set(t),e.m_events.emit("activeClientCountChanged")}))},e.prototype.setUpSystemCommandsCell=function(){var e=this;this.m_systemCommandsCell=new dC.SimpleSyncCell(Gv.SystemCommandsStateName,this),this.m_handlers.set(this.m_systemCommandsCell.id(),this.m_systemCommandsCell),this.m_systemCommandsCell.on("valueChanged",(function(t){return i(e,void 0,void 0,(function(){var e,i,r;return n(this,(function(n){switch(n.label){case 0:return"refreshToken"===t?[3,1]:[3,6];case 1:if(!this.m_user||!this.m_user.getForceRefreshedTokenAsync)return[3,5];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this.m_user.getForceRefreshedTokenAsync()];case 3:return e=n.sent(),i={},e&&(i.authorization=e.token,i.authProvider=e.authProvider,i.mri=e.mri||"",i.huid=e.hashedUserEmail||""),this.sendConfigMessage(i),[3,5];case 4:return r=n.sent(),this.m_logger.sendTraceTag(574107847,$v.TraceLevel.Error,"Error getting force refreshed auth token: "+cC.errorToString(r)),[3,5];case 5:return[3,7];case 6:return this.m_logger.sendTraceTag(574107848,$v.TraceLevel.Error,"Unknown system command cell value: "+t),[3,7];case 7:return[2]}}))}))}))},e.prototype.setupServiceGeneratedClientIdCell=function(){var e=this;this.m_serviceGeneratedClientIdCell=new dC.SimpleSyncCell(Gv.ServiceGeneratedClientIdName,this),this.m_handlers.set(this.m_serviceGeneratedClientIdCell.id(),this.m_serviceGeneratedClientIdCell),this.m_serviceGeneratedClientIdCell.on("valueChanged",(function(t){e.m_logger.sendTraceTag(520161037,$v.TraceLevel.Info,"SimpleStateServiceProxy::serviceGeneratedClientId changed to "+t+"}"),e.setClientId(t,!0),e.processClientIdQueue(),e.m_useServiceGeneratedClientId&&(e.processOfflineMessageCache(!0),e.clearOfflineMessageCacheTimer())})),this.m_logger.sendTraceTag(509743689,$v.TraceLevel.Info,"SimpleStateServiceProxy::setupServiceGeneratedClientIdCell completed.")},e.prototype.handleConnectionOpen=function(){var e;this.m_logger.sendTraceTag(590213387,$v.TraceLevel.Info,"SimpleStateServiceProxy::connect - "+(null===(e=this.m_connection)||void 0===e?void 0:e.name)+" onopen. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryAttempts=0,this.setConnectionState(Gv.ConnectionState.Connected),this.startPingTimer(),this.m_useServiceGeneratedClientId||(this.processOfflineMessageCache(!1),this.clearOfflineMessageCacheTimer())},e.prototype.setConnectionState=function(e){this.m_connectionState!==e&&(this.m_connectionState=e,e===Gv.ConnectionState.Disconnected&&this.m_useServiceGeneratedClientId&&this.setClientId("",!1),this.m_events.emit("connectionStateChanged"))},e.prototype.setClientId=function(e,t){this.m_clientId!==e&&(this.m_clientId=e,t&&this.m_events.emit("clientIdChanged"))},e.prototype.processClientIdQueue=function(){var e=this;this.m_clientIdEvictingQueue&&this.m_clientIdEvictingQueue.forEach((function(t){t.senderId=e.m_clientId,e.sendConnectionMessage(t,!0)}))},e.prototype.sendGetInitialSystemStateMessages=function(){try{var e={messageId:oC.v4(),senderId:this.senderId(),objectId:Gv.SystemSessionStateName,type:"",operation:"get",value:""};this.sendStateMessage(e);var t={messageId:oC.v4(),senderId:this.senderId(),objectId:Gv.ServiceGeneratedClientIdName,type:"",operation:"get",value:""};this.sendStateMessage(t),this.m_logger.sendTraceTag(509141838,$v.TraceLevel.Info,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - sent messages.")}catch(e){this.m_logger.sendTraceTag(509141837,$v.TraceLevel.Error,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - caught error "+e)}},e.prototype.createSetupMessage=function(e){var t=e.authToken,i=e.metadata,n=e.subscriptions,r=[];if(t||i){var s={};t&&(s.authorization=t.token,s.authProvider=t.authProvider,s.mri=t.mri||"",s.huid=t.hashedUserEmail||""),i&&(s.metadata=JSON.stringify(i));var a={messageId:oC.v4(),senderId:this.senderId(),objectId:Gv.ConfigurationName,type:"",operation:"",value:JSON.stringify(s)};r.push(JSON.stringify(a))}return n&&(a={messageId:oC.v4(),senderId:this.senderId(),objectId:Gv.StateSubscriptionsName,type:"",operation:"",value:JSON.stringify(n)},r.push(JSON.stringify(a))),r},e.prototype.sendConfigMessage=function(e){var t={messageId:oC.v4(),senderId:this.senderId(),objectId:Gv.ConfigurationName,type:"",operation:"",value:JSON.stringify(e)};this.sendStateMessage(t)},e.prototype.retryConnection=function(e,t,r){var s=this;if(this.clearPingPongTimer(),this.clearInitTimeoutTimer(),this.m_retryAttempts>=this.m_retryIntervalsInMs.length||this.m_sessionRetryAttempts>=this.m_maxSessionRetries)return this.setConnectionState(Gv.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213393,$v.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection reached max retry attempts. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),void(e&&e(new Error("reached max retry attempts")));if(this.setConnectionState(Gv.ConnectionState.Connecting),t||this.m_connection&&!this.m_retryTimer){var a=this.m_retryIntervalsInMs[this.m_retryAttempts];this.m_retryAttempts+=1,this.m_sessionRetryAttempts+=1,this.m_telemetry.wsReconnectCount+=1,this.closeAndClearConnection(),this.m_retryTimer=setTimeout((function(){return i(s,void 0,void 0,(function(){var t;return n(this,(function(i){switch(i.label){case 0:this.m_logger.sendTraceTag(590213395,$v.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryTimer=null,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.connectAsync()];case 2:return i.sent(),r&&r(),[3,4];case 3:return t=i.sent(),this.setConnectionState(Gv.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213396,$v.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection failed. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}, "+cC.errorToString(t)),this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&e(t),[3,4];case 4:return[2]}}))}))}),a)}else this.m_logger.sendTraceTag(590213394,$v.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection skipped. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", NullConnection: "+(null===this.m_connection)+", NullRetryTimer: "+(null===this.m_retryTimer)+"}")},e.prototype.startPingTimer=function(){var e=this;this.m_connection&&this.m_connection.shouldSendPings&&(this.m_pingTimeoutInMs<=0||this.m_pongTimeoutInMs<=0||(this.clearPingPongTimer(),this.m_pingTimer=setTimeout((function(){return i(e,void 0,void 0,(function(){return n(this,(function(e){return this.sendPingMessage(),this.m_pingTimer=null,[2]}))}))}),this.m_pingTimeoutInMs)))},e.prototype.sendPingMessage=function(){var e=this;this.m_connection&&(this.m_connection.isOpen?(this.m_verbose&&this.m_logger.sendTraceTag(559952470,$v.TraceLevel.Info,"SimpleStateServiceProxy::sendPingMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __ping__"),this.m_connection.send("__ping__"),this.clearPongTimer(),this.m_pongTimer=setTimeout((function(){return i(e,void 0,void 0,(function(){var e=this;return n(this,(function(t){return this.retryConnection((function(t){e.m_logger.sendTraceTag(579463188,$v.TraceLevel.Error,"failed to reconnect after missing ping: "+cC.errorToString(t))}),!1),this.m_pongTimer=null,[2]}))}))}),this.m_pongTimeoutInMs)):(this.retryConnection((function(t){e.m_logger.sendTraceTag(579463189,$v.TraceLevel.Error,"failed to reconnect after closed connection: "+cC.errorToString(t))}),!1),this.clearPongTimer()))},e.prototype.clearPingPongTimer=function(){this.clearPingTimer(),this.clearPongTimer()},e.prototype.clearPingTimer=function(){this.m_pingTimer&&(clearTimeout(this.m_pingTimer),this.m_pingTimer=null)},e.prototype.clearPongTimer=function(){this.m_pongTimer&&(clearTimeout(this.m_pongTimer),this.m_pongTimer=null)},e.prototype.handleConnectionMessage=function(e){if("string"==typeof e.data){if(this.startPingTimer(),"__pong__"===e.data)return void(this.m_verbose&&this.m_logger.sendTraceTag(559952471,$v.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __pong__"));var t=Date.now();try{var i=JSON.parse(e.data);Array.isArray(i)&&i.length>0?this.handleAggregatedStateMessages(i):this.handleStateMessage(i),this.m_telemetry.addMessageHandleLatency(Date.now()-t),i.objectId===Gv.SystemSessionStateName?(this.m_logger.sendTraceTag(520161036,$v.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - systemSessionState - initPromise resolved."),this.m_initPromise.resolve(),this.clearInitTimeoutTimer()):i.objectId===Gv.ServiceGeneratedClientIdName&&this.m_logger.sendTraceTag(509743688,$v.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - serviceGeneratedClientId received.")}catch(e){this.m_logger.sendTraceTag(578102302,$v.TraceLevel.Error,"handleConnectionMessage: "+cC.errorToString(e))}}else this.m_logger.sendTraceTag(590213397,$v.TraceLevel.Error,"SimpleStateServiceProxy::handleConnectionMessage - Unknown data type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+typeof e.data+"}")},e.prototype.handleAggregatedStateMessages=function(e){var t,i,n=this;if(e&&0!==e.length){var s=e.map((function(e){return JSON.parse(e)})),a={};s.forEach((function(e){return a[e.objectId]=1+(a[e.objectId]||0)})),Object.keys(a).forEach((function(e){if(a[e]>1){var t=n.m_handlers.get(e);t&&t.beginAggregatedStateUpdating&&t.beginAggregatedStateUpdating()}}));try{for(var o=r(s),c=o.next();!c.done;c=o.next()){var l=c.value;this.handleStateMessage(l)}}catch(e){t={error:e}}finally{try{c&&!c.done&&(i=o.return)&&i.call(o)}finally{if(t)throw t.error}}Object.keys(a).forEach((function(e){if(a[e]>1){var t=n.m_handlers.get(e);t&&t.endAggregatedStateUpdating&&t.endAggregatedStateUpdating()}}))}},e.prototype.handleStateMessage=function(e){var t=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213398,$v.TraceLevel.Info,"SimpleStateServiceProxy::handleStateMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+e.objectId+", MessageId: "+e.messageId+"}"),"list"===e.type)JSON.parse(e.value).forEach((function(e){t.handleStateMessage(e)}));else{if(this.m_user&&this.m_user.validateMessage&&!this.m_user.validateMessage(e))return void this.m_logger.sendTraceTag(588009742,$v.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage rejected message: {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+e.objectId+", MessageId: "+e.messageId+"}");var i=this.getHandlerForMessage(e);if(e.senderId===this.senderId()&&(this.acknowledgeMessage(e,i),this.m_telemetry.incrementAcknowledgedCount(e.objectId)),this.measureMessageRoundTripLatency(e),this.m_telemetry.incrementReceivedCount(e.objectId),i)return void i.handleStateMessage(e)}},e.prototype.getAuthToken=function(){return i(this,void 0,void 0,(function(){var e,t;return n(this,(function(i){switch(i.label){case 0:if(!this.m_user||!this.m_user.getAuthTokenAsync)return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.m_user.getAuthTokenAsync()];case 2:return e=i.sent(),[3,4];case 3:return t=i.sent(),this.m_logger.sendTraceTag(578102469,$v.TraceLevel.Error,"Error getting auth token: "+cC.errorToString(t)),[3,4];case 4:return[2,e]}}))}))},e.prototype.getHandlerForMessage=function(e){var t=this.m_handlers.get(e.objectId);return t||("cell"===e.type?t=new dC.SimpleSyncCell(e.objectId,this):"map"===e.type?t=new uC.SimpleSyncMap(e.objectId,this):this.m_logger.sendTraceTag(559204164,$v.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage - Unknown message type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+e.type+"}"),t&&this.m_handlers.set(e.objectId,t),t)},e.prototype.sendStateMessageImpl=function(e){var t,i=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213403,$v.TraceLevel.Info,"SimpleStateServiceProxy::sendStateMessageImpl. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+e.objectId+", MessageId: "+e.messageId+"}"),e.objectId!==Gv.StateSubscriptionsName&&e.objectId!==Gv.ConfigurationName){if(this.m_outboundMessageInfo.set(e.messageId,Date.now()),this.m_telemetry.incrementRequestedCount(e.objectId),this.m_unacknowledgedMaxTimeInMs>0){var n=null===(t=this.getHandlerForMessage(e))||void 0===t?void 0:t.messageTrackingOption();if(n&&n!==Gv.MessageTrackingOption.None){var r=this.getUnacknowledgedMessagesMapKey(e,n);this.m_unacknowledgedMessages.set(r,{message:e,timestamp:Date.now()}),this.startUnacknowledgeMessageTimer()}}if(this.m_useServiceGeneratedClientId&&this.m_clientIdEvictingQueue&&!this.m_clientId&&"get"!==e.operation)return this.m_logger.sendTraceTag(508348254,$v.TraceLevel.Info,"SimpleStateServiceProxy::enqueueMessage "+JSON.stringify(e)),void this.m_clientIdEvictingQueue.enqueue(e)}this.m_user&&this.m_user.patchMessage&&this.m_user.patchMessage(e),this.m_batchedRequestsEnabled?(this.m_messageBuffer.push(e),this.m_processBufferTimer||(this.m_processBufferTimer=setTimeout((function(){i.processMessageBuffer()}),this.m_batchWaitTimeMS))):this.sendConnectionMessage(e,!0)},e.prototype.createListMessage=function(e){if(0!==e.length)return 1===e.length?e[0]:{value:JSON.stringify(e),type:this.m_batchMessageTypeName,operation:"",messageId:oC.v4(),objectId:"batch",senderId:this.senderId()}},e.prototype.processMessageBuffer=function(){var e=this.m_messageBuffer.length,t=this.m_messageBuffer.splice(0,e),i=this.createListMessage(t);this.m_processBufferTimer&&clearTimeout(this.m_processBufferTimer),this.m_processBufferTimer=null,i&&this.sendConnectionMessage(i,!0)},e.prototype.processOfflineMessageCache=function(e){var t=this;this.m_offlineMessageCacheEnabled&&(this.m_offlineMessageCache.forEach((function(i){e&&(i.message.senderId=t.m_clientId),t.sendConnectionMessage(i.message,!1),t.m_telemetry.offlineCacheTelemetry.resentCount+=1})),this.m_offlineMessageCache=[])},e.prototype.purgeOfflineMessageCache=function(){var e=this;if(this.m_offlineMessageCacheEnabled&&this.m_maxOfflineMessageCacheTimeInMs){var t=Date.now(),i=this.m_offlineMessageCache.filter((function(i){return e.m_maxOfflineMessageCacheTimeInMs&&i.timestamp+e.m_maxOfflineMessageCacheTimeInMs>=t}));this.m_telemetry.offlineCacheTelemetry.expiredCount+=this.m_offlineMessageCache.length-i.length,this.m_offlineMessageCache=i,0===this.m_offlineMessageCache.length&&this.clearOfflineMessageCacheTimer()}},e.prototype.clearOfflineMessageCacheTimer=function(){this.m_offlineMessageCacheEnabled&&this.m_offlineMessageCacheTimer&&(clearInterval(this.m_offlineMessageCacheTimer),this.m_offlineMessageCacheTimer=null)},e.prototype.getUnacknowledgedMessagesMapKey=function(e,t){return t===Gv.MessageTrackingOption.None?"":t===Gv.MessageTrackingOption.All?e.messageId:e.objectId},e.prototype.startUnacknowledgeMessageTimer=function(){var e=this;this.m_unacknowledgedMaxTimeInMs>0&&!this.m_unacknowledgedTimer&&(this.m_unacknowledgedTimer=setInterval((function(){e.notifyUnacknowledgedMessages(),e.m_unacknowledgedMessages.size<=0&&e.clearUnacknowledgedTimer()}),this.m_unacknowledgedMaxTimeInMs/2))},e.prototype.acknowledgeMessage=function(e,t){if(e.senderId===this.senderId()&&t&&!(this.m_unacknowledgedMessages.size<=0)){var i=this.getUnacknowledgedMessagesMapKey(e,t.messageTrackingOption()),n=this.m_unacknowledgedMessages.get(i);n&&e.messageId===n.message.messageId&&this.m_unacknowledgedMessages.delete(i)}},e.prototype.notifyUnacknowledgedMessages=function(){var e=this,t=Date.now();this.m_unacknowledgedMessages.forEach((function(i,n){if(i.timestamp+e.m_unacknowledgedMaxTimeInMs<t){var r=e.getHandlerForMessage(i.message);null==r||r.handleUnacknowledgedMessage(i.message),e.m_unacknowledgedMessages.delete(n),e.m_telemetry.unacknowledgedMessagesCount+=1}}))},e.prototype.clearUnacknowledgedTimer=function(){this.m_unacknowledgedTimer&&(clearInterval(this.m_unacknowledgedTimer),this.m_unacknowledgedTimer=null)},e.prototype.startInitTimeoutTimerWithRetry=function(e,t){var i=this;this.startInitTimeoutTimer(e,(function(){i.m_logger.sendTraceTag(509141836,$v.TraceLevel.Error,"SimpleStateServiceProxy::startInitTimeoutTimer - failed to init after "+e+" ms; requesting get messages and retrying"),i.sendGetInitialSystemStateMessages(),i.startInitTimeoutTimer(e,t)}))},e.prototype.startInitTimeoutTimer=function(e,t){e>0&&(this.clearInitTimeoutTimer(),this.m_initTimeoutTimer=setTimeout((function(){t("Initialization timed out after "+e+" ms")}),e))},e.prototype.clearInitTimeoutTimer=function(){this.m_initTimeoutTimer&&clearTimeout(this.m_initTimeoutTimer)},e.prototype.sendConnectionMessage=function(e,t){var i,n,r=this;if(this.m_allowReconnectOnMessageSend&&this.m_connectionState===Gv.ConnectionState.Disconnected&&(this.updateRetryAttempts(),this.retryConnection((function(e){r.m_logger.sendTraceTag(559428289,$v.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - failed to reconnect with error: "+cC.errorToString(e)+" ")}),!1)),this.m_offlineMessageCacheEnabled&&t){if(!this.m_connection||this.m_connectionState!==Gv.ConnectionState.Connected)return!this.m_maxOfflineMessageCacheLength||this.m_offlineMessageCache.length>=this.m_maxOfflineMessageCacheLength?(this.m_telemetry.offlineCacheTelemetry.rejectedCount+=1,void this.m_logger.sendTraceTag(570807006,$v.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - Dropping message because offline cache is full. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+(null===(i=this.m_connection)||void 0===i?void 0:i.readyState)+"}")):(!this.m_offlineMessageCacheTimer&&this.m_maxOfflineMessageCacheTimeInMs&&(this.m_offlineMessageCacheTimer=setInterval((function(){r.purgeOfflineMessageCache()}),this.m_maxOfflineMessageCacheTimeInMs/2)),this.m_offlineMessageCache.push({message:e,timestamp:Date.now()}),void(this.m_telemetry.offlineCacheTelemetry.cachedCount+=1))}else{if(!this.m_connection)return void this.m_logger.sendTraceTag(590213401,$v.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - connection is not set. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}");if(!this.m_connection.isOpen)return void this.m_logger.sendTraceTag(590213402,$v.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - "+this.m_connection.name+" status is not open. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+this.m_connection.readyState+"}")}null===(n=this.m_connection)||void 0===n||n.send(JSON.stringify(e))},e.prototype.closeAndClearConnection=function(){if(this.m_connection){if(this.m_connection.onclose=function(){},this.m_connection.isOpen)this.m_connection.close();else{var e=this.m_connection;e.onopen=function(){return e.close()}}this.m_connection=null}},e.prototype.updateRetryAttempts=function(){this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&(this.m_retryAttempts=0),this.m_sessionRetryAttempts>=this.m_maxSessionRetries&&(this.m_sessionRetryAttempts=0)},e.prototype.measureMessageRoundTripLatency=function(e){if(e.senderId===this.senderId())try{var t=this.m_outboundMessageInfo.get(e.messageId);if(void 0!==t){this.m_outboundMessageInfo.delete(e.messageId);var i=Date.now()-t;this.m_events.emit("messageRoundTripped",{clientId:this.m_clientId,sessionId:this.m_sessionId,messageId:e.messageId,objectId:e.objectId,operation:e.operation,latencyInMs:i}),this.m_telemetry.addRoundtripLatency(i)}else this.m_verbose&&this.m_logger.sendTraceTag(590213404,$v.TraceLevel.Info,"SimpleStateServiceProxy::measureMessageRoundTripLatency. Failed to find outbound message info for {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+e.objectId+", MessageId: "+e.messageId+"}")}catch(t){this.m_logger.sendTraceTag(590213405,$v.TraceLevel.Error,"SimpleStateServiceProxy::measureMessageRoundTripLatency - Exception thrown error. {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", MessageId: "+e.messageId+", Error: "+t.message+"}")}},e}();t.SimpleStateServiceProxy=l})),fC=a((function(e,t){var i=s&&s.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},n=s&&s.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(e){return function(t){return c([e,t])}}function c(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{i=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}};Object.defineProperty(t,"__esModule",{value:!0}),t.createStateServiceProxyAsync=void 0,t.createStateServiceProxyAsync=function(e,t,r,s,a,o){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){switch(n.label){case 0:return[4,(i=new mC.SimpleStateServiceProxy(e,t,r,s,a,o)).connectAsync()];case 1:return n.sent(),[2,i]}}))}))}})),SC=a((function(e,t){var i=s&&s.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),n=s&&s.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n($v,t),n(Gv,t),n(fC,t)}));class vC{constructor(e){this.enableConsoleLog=yl().calling.reaction.enableStateServiceConsoleLogs,this._logger=e}sendTraceTag(e,t,i){this.enableConsoleLog&&this._logger.info(`Tag: ${e}, Leve: ${t}, Message: ${i}`)}}class yC{constructor(e){this._wsUrl="",this.name="Reaction",this.capabilityChangeHandler=e=>{e.newValue.useReactions&&(this._participantCapability=this._call.getParticipantCapabilities().useReactions,this._logger.log(`participant capabilitity to useReactions feature is ${this._participantCapability}`))},this._eventEmitter=e,this._participantCapability={isPresent:!0,reason:"Capable"},this._isReactionFeatureEnabled=yl().calling.reaction.enabled}initialize(e,t,i,n,r,s){void 0===this._proxy||this._proxy?.getConnectionState()===SC.ConnectionState.Disconnected?(this._logger=r.createChild((()=>`ReactionImplOverStateService::Call(id='${this._tsCall.callId}')`)),this._internalCallAgent=t,this._tsCall=e,this._call=i,this._callInfo=s,this._docId=this._tsCall.callId,this._wsUrl=this.getEndpointUrl(),this._telemetryLogManager=n,this._sendAttempOrFailureFeatureUsage("initialize",Zu.attempt),this.start()):r.info("State Service Proxy already has an active connection."),"teamsMeetingJoin"==this._callInfo.context&&(this._participantCapability=this._call.getParticipantCapabilities().useReactions,this._logger.log(`participant capabilitity to useReactions feature is ${this._participantCapability}`),this._call.onParticipantCapabilitiesChanged("capabilitiesChanged",this.capabilityChangeHandler),this._logger.log("participant capabilities change event listener registered"))}async start(){const e=yl().calling.reaction.StateServiceProxySettings,t={getAuthTokenAsync:this.getAuthToken.bind(this)};try{this._proxy=await SC.createStateServiceProxyAsync(this._docId,"ACSWeb",this._wsUrl,new vC(this._logger),e,t)}catch(e){return this._logger.error("Could not create state service proxy",e),void this._sendAttempOrFailureFeatureUsage("initialize",Zu.failure,new I({defaultError:f.FEATURES.REACTION.STATE_SERVICE_CONNECT_FAIL,originalError:e}))}try{this._reactionsMap=await this._proxy.createMapAsync("reactions",!0)}catch(e){return this._logger.error("Could not create state service proxy reaction map",e),void this._sendAttempOrFailureFeatureUsage("initialize",Zu.failure,new I({defaultError:f.FEATURES.REACTION.MAP_CREATE_FAIL,originalError:e}))}this._sendSuccessFeatureUsage("initialize",Zu.success),this._reactionsMap?.on("valueChanged",this.onReactionsReceived.bind(this))}async getAuthToken(){const e={token:await this._internalCallAgent.tokenProvider(),authProvider:"SKYPE",mri:this._internalCallAgent.getUserMri()};return Promise.resolve(e)}async sendReaction(e,t){if(!this._isReactionFeatureEnabled||!this._participantCapability.isPresent){const e=new I({defaultError:f.FEATURES.REACTION.SEND_FAIL_POLICY});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Zu.failure,e,t),e}if(!this._reactionsMap){this._logger.error("Reaction Map has not yet been initialized.");const e=new I({defaultError:f.FEATURES.REACTION.NOT_INIT_YET});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Zu.failure,e,t),e}try{return this._reactionsMap?.set(this._internalCallAgent.getUserMri(),{name:e.reactionType}),void this._sendSuccessFeatureUsage("sendReaction",Zu.success,t,e.reactionType)}catch(e){this._logger.error("Unable to send reaction",e);const i=new I({defaultError:f.FEATURES.REACTION.SEND_REACTION_FAIL,originalError:e});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Zu.failure,i,t),i}}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}async onReactionsReceived(e){if(3===this._tsCall.state&&this._participantCapability.isPresent){const t=x();this._sendAttempOrFailureFeatureUsage("receiveReaction",Zu.attempt,void 0,t);try{const i={reactionType:(await(this._reactionsMap?.get(e))).name};this._eventEmitter.emit("reaction",{identifier:e,reactionMessage:i}),this._sendSuccessFeatureUsage("receiveReaction",Zu.success,t,i.reactionType)}catch(e){this._logger.error("Unable to parse reaction",e);let i=new I({defaultError:f.FEATURES.REACTION.RECEIVE_REACTION_FAIL,originalError:e});this._sendAttempOrFailureFeatureUsage("receiveReaction",Zu.failure,i,t)}}}dispose(){void 0!==this._telemetryLogManager&&(this._proxy?.getConnectionState()===SC.ConnectionState.Connected?(this._reactionsMap?.removeAllListeners("valueChanged"),this._proxy.close(),this._sendSuccessFeatureUsage("dispose",Zu.success),this._call.offParticipantCapabilitiesChanged("capabilitiesChanged",this.capabilityChangeHandler)):this._sendSuccessFeatureUsage("dispose",Zu.failure))}_sendAttempOrFailureFeatureUsage(e,t,i,n){let r=i?{code:i?.code||_,subCode:i?.subCode||0,failureReason:i?.message||"",...jp(i)}:void 0;Op({correlationId:n,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:r},this._telemetryLogManager,this._logger)}_sendSuccessFeatureUsage(e,t,i,n){let r;r="initialize"===e||"dispose"==e?void 0:{reactionConstraint:{reactionType:n}},Op({correlationId:i,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:r},this._telemetryLogManager,this._logger)}getEndpointUrl(){const e=this._internalCallAgent._caConfigBag,t=e&&Ll(e.identityType,e.region);var i=yl().PowerPointStateServiceUrl.public.amer;switch(e?.cloudType){case zo.Public:t&&(i=yl().PowerPointStateServiceUrl.public.eu);break;case zo.GccHigh:i=yl().PowerPointStateServiceUrl.gcch;break;case zo.AirGap08:i=yl().PowerPointStateServiceUrl.ag08;break;case zo.AirGap09:i=yl().PowerPointStateServiceUrl.ag09;break;case zo.Dod:i=yl().PowerPointStateServiceUrl.dod;break;default:i=yl().PowerPointStateServiceUrl.public.amer}return`wss://${new URL(i).hostname}/StateServiceHandler.ashx`}}class CC{get contentSharingSession(){return this._contentSharingSession}constructor(e){this._contentSharingSession=e}getFileDetails(){if(this.contentSharingSession)return JSON.parse(atob(this.contentSharingSession.contentSharingIdentity))}}const _C="azure_communication_calling_pptLive";class EC{constructor(e){this._isActive=!1,this._isInitializingPPTLive=!1,this._updateIsActive=e=>this._isActive!==e&&(this._isActive=e,this._logger.info(`Updating isActive to ${e}`),!0),this._eventEmitter=e,this._target=document.createElement("div"),this._target.id=_C,this._target.style.width="100%",this._target.style.height="100%"}initialize(e,t,i,n){this._logger=n.createChild((()=>`PPTLive::Call(id='${e.callId}')`)),this._tsCall=e,this._internalCallAgent=t,this._telemetryLogManager=i,this._tsCall.on("contentSharingChanged",(()=>{this._checkContentSharingSession(this._tsCall.contentSharingSessions)})),this._tsCall.on("callStateChanged",(()=>{this._updatePPTLive(this._tsCall.state)}))}get isActive(){return this._isActive}get target(){return this._target}get activePresenterId(){return this._activePresenterId}_checkContentSharingSession(e){if(this._contentSharing&&0===e.length)this._updateIsActive(!1),this._contentSharing=void 0,this._target.innerHTML="",this._isInitializingPPTLive=!1,this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("endedPPTLive",Zu.success);else if(!this._contentSharing&&0!==e.length){if(!yl().calling.pptlive.enabled)return;this._contentSharing=new CC(e[0]),this._updatePPTLive(this._tsCall.state),this._sendFeatureUsage("startedPPTLive",Zu.attempt,this._contentSharing?.contentSharingSession?.contentSharingGuid)}}async _updatePPTLive(e){this._fileDetails=this._contentSharing?.getFileDetails(),this._fileDetails&&"ppt"===this._fileDetails.type&&3===e&&await this._startPPTLive(this._target)}_updateActivePresenter(){this._tsCall.participants.forEach((e=>{const t=sl(e.id);2===e.contentSharingRole&&(this._activePresenterId=t)}))}_sendFeatureUsage(e,t,i){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"PPTLive",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:{pptLiveConstraint:{contentId:i}}},this._telemetryLogManager,this._logger)}_observeDivMount(){const e=new MutationObserver((async t=>{if(this._isActive){if(!this._isInitializingPPTLive)for(const i of t)for(let t=0;t<i.addedNodes.length;t++){const n=i.addedNodes[t];if(n.nodeType===Node.ELEMENT_NODE&&n.matches(`#${_C}`)){await this._startPPTLive(this._target),e.disconnect();break}}}else e.disconnect()}));e.observe(document.body,{childList:!0,subtree:!0})}_initViewerWithExperiment(e,t,i,n,r,s,a,o,c,l,d,h,u,g,p){const m=window.Microsoft,f=yl().calling.pptlive,S={Container:e,SessionInformation:{DocumentClickTime:new Date,HostInitTime:new Date,UiLocale:h,DataLocale:h,IsPresenter:!1,WdParams:{wdModernSlideShowInTeams:f.wdParams.wdModernSlideShowInTeams,wdPresenterViewInTeams:f.wdParams.wdPresenterViewInTeams,wdForceModernSlideShowInTeams:f.wdParams.wdForceModernSlideShowInTeams,isMovePrivateViewingToPPTEnabled:f.wdParams.isMovePrivateViewingToPPTEnabled},PptFeatureGates:f.featureGates,ParticipantId:o,EnableStateServiceInPreviewerFeatures:JSON.parse(f.enableStateServiceInPreviewerFeatures),StateServiceSettings:{stateServiceProxySettings:f.stateServiceProxySettings,regionalEndpointUrl:this._getEndpointUrl(),authEnabled:!1,rosterCheckEnabled:!1,stateServiceUser:{getAuthTokenAsync:!1,getForceRefreshedTokenAsync:!1}},ContentId:u,EndpointId:a,CallId:g,HostName:"ACSWeb",HostSessionId:c},WopiPrecheckInfo:{FileName:n,FileGetUrl:s,FileSize:r,CustomFontCatalogUrl:p,BundleInfo:{MajorVersion:i,Url:l},CreateNewInfo:null},ApplicationCustomSettings:{TakeFocusOnBoot:f.appSettings.takeFocusOnBoot,EnableAdvanceOnClick:f.appSettings.enableAdvanceOnClick,EnableAdvanceOnTap:f.appSettings.enableAdvanceOnTap},Diagnostics:{entryPoint:"null"},FnOnInitializeSuccess:e=>{e.GoToSlide(t,[],""),this._isInitializingPPTLive=!1,this._observeDivMount(),this._sendFeatureUsage("startedPPTLive",Zu.success,this._contentSharing?.contentSharingSession?.contentSharingGuid)},FnOnInitializeFailure:e=>{this._isInitializingPPTLive=!1;var t="Category: "+e.Category+"\nMessage: "+e.Message+"\nExtraInfo: "+e.ExtraInfo;this._sendFeatureUsage("startedPPTLive",Zu.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid),this._logger.error(t)}};d&&(S.ApplicationCustomSettings.EnableWacFallback=!1,S.ApplicationUrl=d),m.Office.PowerPoint.Bootstrap.Prefetch(),m.Office.PowerPoint.Bootstrap.InitializeWopiPending(S),this._updateActivePresenter(),this._updateIsActive(!0),this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("startedPPTLive",Zu.initialize,this._contentSharing?.contentSharingSession?.contentSharingGuid)}async _startPPTLive(e){this._fileDetails?.bootstrapperUrl&&(this._isInitializingPPTLive=!0,e.innerHTML="",await this._loadDynamicModule(this._fileDetails.bootstrapperUrl).then((()=>{this._fileDetails&&this._initViewerWithExperiment(e,Number(this._contentSharing?.contentSharingSession?.contentSharingState),this._fileDetails.majorVersion,this._fileDetails.name,this._fileDetails.fileSize,this._fileDetails.fileGetUrl,this._tsCall.endpointId,this._tsCall.participantId,x(),this._fileDetails.contentBundleUrl,this._fileDetails.wacUrl,navigator.language,this._fileDetails.id,this._tsCall.callId,this._fileDetails.customFontCatalogUrl)})).catch((()=>{this._sendFeatureUsage("startedPPTLive",Zu.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid)})))}_getEndpointUrl(){const e=this._internalCallAgent._caConfigBag,t=e&&Ll(e.identityType,e.region);let i=yl().PowerPointStateServiceUrl.public.amer;switch(e?.cloudType){case zo.Public:t&&(i=yl().PowerPointStateServiceUrl.public.eu);break;case zo.GccHigh:i=yl().PowerPointStateServiceUrl.gcch;break;case zo.AirGap08:i=yl().PowerPointStateServiceUrl.ag08;break;case zo.AirGap09:i=yl().PowerPointStateServiceUrl.ag09;break;case zo.Dod:i=yl().PowerPointStateServiceUrl.dod;break;default:i=yl().PowerPointStateServiceUrl.public.amer}return i}async _loadDynamicModule(e){return new Function(`return (async () => await import('${e}'))()`)()}}const TC={Recording:Mp(class extends Cp{constructor(e){super(e),this._impl=new _f(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"Recording"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e.tsCall,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Zu.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Zu.getter),this._impl.recordings}on(e,t){if("isRecordingActiveChanged"!==e&&"recordingsUpdated"!==e)throw new I({defaultError:f.FEATURES.RECORDING.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){if("isRecordingActiveChanged"!==e&&"recordingsUpdated"!==e)throw new I({defaultError:f.FEATURES.RECORDING.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Recording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),Transfer:Mp(class extends Cp{constructor(e){super(e),this._impl=new Mf(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"Transfer"}transfer(e,t){return this._impl.transfer(e,t)}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}on(e,t){this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),Transcription:Mp(class extends Cp{constructor(e){super(e),this._impl=new Rf(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"Transcription"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e.tsCall,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}get isTranscriptionActive(){return this._sendFeatureUsage("isTranscriptionActive",Zu.getter),this._impl.isTranscriptionActive}on(e,t){this._sendFeatureUsage("isTranscriptionActiveChanged",Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage("isTranscriptionActiveChanged",Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transcription",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),Captions:Mp(class extends Cp{constructor(e){super(e),this._impl=new Xp(this.eventEmitter)}initialize(e,t){const i=x();this._impl.initialize(e.tsCall,e.call,e.callAgent,e.callAgent.getHttpRequestHelper(),e.telemetryLogManager,t,this._telemetryStartTime,i),this._logger=t,this._telemetryStartTime=+Date.now(),this._telemetryLogManager=e.telemetryLogManager,this._call=e.call}get name(){return this._sendFeatureUsage("name",Zu.getter),this._captionsTelemetryType.toString()}get _captionsTelemetryType(){return"TeamsCaptions"===this._impl.kind?wp.TeamsCaptions:wp.Captions}get captions(){return this._impl.captions}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:this._captionsTelemetryType,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}}),RaiseHand:Mp(class extends Cp{constructor(e){super(e),this._impl=new Zp(this.eventEmitter)}get name(){return"RaiseHand"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._tsCall=e.tsCall,this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t)}async raiseHand(){return this._impl.raiseHand()}async lowerHand(){return this._impl.lowerHand()}async lowerHands(e){return this._impl.lowerHands(e)}lowerAllHands(){return this._impl.lowerAllHands()}getRaisedHands(){return this._sendFeatureUsage("getRaisedHands",Zu.getter),this._impl.raisedHands}on(e,t){this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}),LocalRecording:Mp(class extends Cp{constructor(e){super(e),this._impl=new bf(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"LocalRecording"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e.tsCall,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Zu.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Zu.getter),this._impl.recordings}on(e,t){if("isLocalRecordingActiveChanged"!==e&&"localRecordingsUpdated"!==e)throw new I({defaultError:f.FEATURES.RECORDING.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){if("isLocalRecordingActiveChanged"!==e&&"localRecordingsUpdated"!==e)throw new I({defaultError:f.FEATURES.RECORDING.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t,i){let n=i?{code:i?.code||_,subCode:i?.subCode||0,failureReason:i?.message||""}:void 0;Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"LocalRecording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:n},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),Reaction:Mp(class extends Cp{constructor(e){super(e),this._impl=new yC(this.eventEmitter),this._isReactionFeatureEnabled=yl().calling.reaction.enabled,this._callInfo=e.callInfo}get name(){return"Reaction"}initialize(e,t){this._tsCall=e.tsCall,this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._logger.info(`Meeting Reaction feature enable flag: ${this._isReactionFeatureEnabled}`),this._isReactionFeatureEnabled&&3===e.tsCall.state?this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t,this._callInfo):e.tsCall.on("callStateChanged",(()=>{this._isReactionFeatureEnabled&&3===e.tsCall.state?this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t,this._callInfo):this._logger.warn("Calls to reaction APIs will perform no action or return default values where applicable")}))}async sendReaction(e){let t=x();if(this._sendFeatureUsage("sendReaction",Zu.attempt,void 0,t),3!=this._tsCall.state||1===this._tsCall.callType){const e=new I({defaultError:3!=this._tsCall.state?f.FEATURES.REACTION.CALL_NOT_CONNECTED:f.FEATURES.REACTION.NOT_SUPPORTED_1TO1_CTE});throw this._sendFeatureUsage("sendReaction",Zu.failure,e,t),e}await this._impl.sendReaction(e,t)}on(e,t){if("reaction"!==e)throw new I({defaultError:f.FEATURES.REACTION.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});if(!this._isReactionFeatureEnabled){const e=new I({defaultError:f.FEATURES.REACTION.EVENT_SUBSCRIBE_FAIL_POLICY});throw this._sendFeatureUsage("receiveReaction",Zu.failure,e),e}this._sendFeatureUsage("receiveReaction",Zu.subscribe),this._impl.on(e,t)}off(e,t){if("reaction"!==e)throw new I({defaultError:f.FEATURES.REACTION.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});if(!this._isReactionFeatureEnabled){const e=new I({defaultError:f.FEATURES.REACTION.EVENT_UNSUBSCRIBE_FAIL_POLICY});throw this._sendFeatureUsage("receiveReaction",Zu.failure,e),e}this._sendFeatureUsage("receiveReaction",Zu.unsubscribe),this._impl.off(e,t)}dispose(){this.disposed||(this._impl.dispose(),super.dispose())}_sendFeatureUsage(e,t,i,n){let r=i?{code:i?.code||_,subCode:i?.subCode||0,failureReason:i?.message||"",...jp(i)}:void 0;Op({correlationId:n,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t},additionalDetails:r},this._telemetryLogManager,this._logger)}}),Spotlight:Mp(class extends Cp{constructor(e){super(e),this._impl=new fv(this.eventEmitter),this._isSpotlightFeatureEnabled=yl().calling.spotlight.enabled}get name(){return"Spotlight"}initialize(e,t){this._logger=t,this._logger.info(`Spotlight feature enable flag: ${this._isSpotlightFeatureEnabled}`),this._isSpotlightFeatureEnabled?(this._telemetryLogManager=e.telemetryLogManager,this._tsCall=e.tsCall,this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t)):this._logger.warn("Calls to spotlight APIs will perform no action or return default values where applicable")}async startSpotlight(e){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(e)&&await this._impl.startSpotlight(e)}async stopSpotlight(e){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(e)&&await this._impl.stopSpotlight(e)}async stopAllSpotlight(){this._isSpotlightFeatureEnabled&&await this._impl.stopAllSpotlight()}getSpotlightedParticipants(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("getSpotlightedParticipants",Zu.getter),this._impl.spotlightedParticipants):[]}get maxParticipantsToSpotlight(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("maxSpotlightSupportedState",Zu.getter),this._impl.maxSpotlightStateSupported):0}on(e,t){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t))}off(e,t){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t))}validateIdentifierParam(e=[]){try{return e.forEach((e=>ol(e))),!0}catch(e){return!1}}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}),PPTLive:Mp(class extends Cp{constructor(e){super(e),this._impl=new EC(this.eventEmitter)}on(e,t){this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}get isActive(){return this._impl.isActive}get target(){return this._impl.target}get activePresenterId(){return this._impl.activePresenterId}get name(){return"PPTLive"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._tsCall=e.tsCall,this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t)}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:e,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}),Capabilities:Mp(class extends Cp{constructor(e){super(e),this._callInfo=e.callInfo,this._impl=new rm(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"Capabilities"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._tsCall=e.tsCall,this._impl.initialize(e.tsCall,e.callAgent,e.call,this._callInfo,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}get capabilities(){return this._sendFeatureUsage("getCapabilities",Zu.getter),this._impl.capabilities}on(e,t){this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Capabilities",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}),DominantSpeakers:Mp(class extends Cp{constructor(e){super(e),this._impl=new km(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Zu.getter),"DominantSpeakers"}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t),this._sendFeatureUsage("initialize",Zu.initialize)}get dominantSpeakers(){return this._sendFeatureUsage("dominantSpeakers",Zu.getter),this._impl.dominantSpeakers}on(e,t){this._sendFeatureUsage("dominantSpeakersChanged",Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){this._sendFeatureUsage("dominantSpeakersChanged",Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"DominantSpeakers",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),LiveStream:Mp(class extends Cp{constructor(e){super(e),this._impl=new hS(this.eventEmitter,this.name)}get name(){return"LiveStream"}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t)}dispose(){this._impl.dispose(),super.dispose()}get liveStreams(){return this._impl.liveStreams}get participantCount(){return this._impl.streamingClientCount}on(e,t){if("liveStreamsUpdated"!==e&&"participantCountChanged"!==e)throw new I({defaultError:f.FEATURES.LIVE_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("liveStreamsUpdated"!==e&&"participantCount"!==e)throw new I({defaultError:f.FEATURES.LIVE_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}createStatsCollector(e){return this._impl.createStatsCollector(e)}}),ComposedStream:Mp(class extends Cp{constructor(e){super(e),this._impl=new gS(this.eventEmitter,this.name)}get name(){return"ComposedStream"}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t)}dispose(){this._impl.dispose(),super.dispose()}get composedStreams(){return this._impl.composedStreams}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}}),CallSurvey:Mp(class extends Cp{constructor(e){super(e),this._impl=new Sv}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t)}get name(){return"CallSurvey"}dispose(){super.dispose()}submitSurvey(e){return this._impl.submitSurvey(e)}}),UserFacingDiagnostics:Mp(class extends Cp{constructor(e){super(e),this._impl=new Pm}get name(){return this._sendFeatureUsage("name",Zu.getter),"Diagnostics"}get network(){return this._sendFeatureUsage("network",Zu.getter),this._impl.network}get media(){return this._sendFeatureUsage("media",Zu.getter),this._impl.media}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call,this._impl.initialize(e,t),this._sendFeatureUsage("initialize",Zu.initialize)}_sendFeatureUsage(e,t){Op({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Diagnostics",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),MediaStats:Mp(vf,{activationEvent:"OnExtendedObjectConstructor"}),DebugInfo:Dp(class extends Ep{constructor(e){super(e),this._impl=new cm;try{hl().includes("stable")||(this._browserTabInfoImpl=new lm(this.eventEmitter))}catch(t){e.callClient.logger.error("Feature to detect multiple tabs is not supported on the current environment.")}}get name(){return this._sendFeatureUsage("name",Zu.getter),"DebugInfo"}get lastLocalParticipantId(){return this._sendFeatureUsage("lastLocalParticipantId",Zu.getter),this._impl.lastLocalParticipantId}get logs(){return this._impl.logDump}get localParticipantIdMap(){return this._impl.localParticipantIdMap}get incommingCallIdMap(){return this._impl.incommingCallIdMap}get lastCallId(){if(this._sendFeatureUsage("lastCallId",Zu.getter),this.lastLocalParticipantId)return this._impl.localParticipantIdMap[this.lastLocalParticipantId].callIds.slice(-1)[0]}get diagnosticInformation(){return this._impl.diagnosticInformation}get sdkVersion(){return hl()}get acsResourceId(){return this._impl.AcsResourceId}get clientId(){return this._impl.clientId}dumpDebugInfoAsJSONString(){try{return JSON.stringify(this.toZip())}catch(e){return`JSON.stringify threw: ${e}`}}toZip(){return{clientId:this.clientId,lastLocalParticipantId:this.lastLocalParticipantId,localParticipantIdMap:this.localParticipantIdMap,incommingCallMap:this.incommingCallIdMap,AcsResourceId:this.acsResourceId,diagnosticInformation:this.diagnosticInformation,sdkVersion:this.sdkVersion,logs:this.logs}}dumpDebugInfo(){this._sendFeatureUsage("dumpDebugInfo",Zu.attempt);try{const e=ku.deflate(this.dumpDebugInfoAsJSONString(),{to:"string"}),t=om(e);return this._sendFeatureUsage("dumpDebugInfo",Zu.success),{dump:e,dumpId:`${x()}-${t}`}}catch(e){const t=`failed to deflate, error: ${e}`;return this.logger.error(t),this._sendFeatureUsage("dumpDebugInfo",Zu.failure),{dump:ku.deflate(t,{to:"string"}),dumpId:x()}}}initialize(e,t){this._impl.initialize(e,t),this.logger=t,this._telemetryLogManager=e.telemetryLogManager,this._callClient=e.callClient,this._browserTabInfoImpl&&this._browserTabInfoImpl.initialize(e.callClient,t,e.telemetryLogManager),this._sendFeatureUsage("initialize",Zu.initialize)}async getEnvironmentInfo(){return this._sendFeatureUsage("getEnvironmentInfo",Zu.getter),await this._callClient.getEnvironmentInfoInternal()}get isAnotherCallClientActiveInSameTab(){return this._sendFeatureUsage("isAnotherCallClientActiveInSameTab",Zu.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isAnotherCallClientActiveInSameTab}get isCallClientActiveInAnotherTab(){return this._sendFeatureUsage("isCallClientActiveInAnotherTab",Zu.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isCallClientActiveInAnotherTab}on(e,t){"isCallClientActiveInAnotherTabChanged"!==e&&"isAnotherCallClientActiveInSameTabChanged"!==e&&this.logger.error(`Not able to subscribe to event ${e}, unknown event name`),this._sendFeatureUsage(e,Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){"isCallClientActiveInAnotherTabChanged"!==e&&"isAnotherCallClientActiveInSameTabChanged"!==e&&this.logger.error(`Not able to unsubscribe to event ${e}, unknown event name`),this._sendFeatureUsage(e,Zu.unsubscribe),this.eventEmitter.off(e,t)}_sendFeatureUsage(e,t){kp({featureName:"DebugInfo",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:e,step:t}},this._telemetryLogManager,this.logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}},{activationEvent:"OnExtendedObjectConstructor"}),PreCallDiagnostics:Dp(class extends Ep{constructor(e){super(e),this._impl=new iS}initialize(e,t){const i=e.callClient;this._logger=t;const n=i.createInstance({diagnostics:{tags:["diagnostics"]}});this._telemetryLogManager=n.telemetryLogManager,this._impl.intialize(i,n,t,this._telemetryLogManager),this._sendFeatureUsage("initialize",Zu.initialize)}get name(){return this._sendFeatureUsage("name",Zu.getter),"PreCallDiagnostics"}startTest(e,t){return this._impl.startTest(e,t)}_sendFeatureUsage(e,t){kp({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Zu.attempt),this.disposed?this._sendFeatureUsage("dispose",Zu.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Zu.success))}}),VideoEffects:function(e,t={activationEvent:"OnFeatureAccess"}){return{get videoStreamApiCtor(){return e},activationOptions:t,isVideoStreamFeature:!0}}(class extends Tp{constructor(){super(...arguments),this._effect=null,this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[],this._tsCallingEffectCapability=0,this._tsCallingSupportedEffects=[{acsEffect:"Off",tsCallingEffect:0}],this._activeEffects=[],this._sourceStreamSubscription=null,this.configUpdatedCallback=async e=>{const t=this._internalDeviceManager.getTsDeviceManager();if("BackgroundReplacement"===e){const e=(this._effect?._internalHandle?.effectConfig).backgroundImageUrl;e&&await t.setBackgroundImageAsync("",e)}},this.processingErrorCallback=async e=>{const t=x();this.eventEmitter.emit("effectsError",e);const i=this.getEffectNameForTelemetry(this._effect?.name),n=this.getUsageDetailsForTelemetry("Internal handle error",i);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.effectsError,kindOfEvent:Zu.failure,additionalDetails:{failureReason:e.message,code:e.code,...jp(e),usageDetails:n}}),await this.stopEffects()},this.effectStatusChangedCallback=(e,t)=>{if(t.length>0){const e=this._effect?.name?[this._effect.name]:t;this.eventEmitter.emit("effectsStarted",e)}else{const t=this._effect?.name?[this._effect.name]:e;this.eventEmitter.emit("effectsStopped",t)}}}initialize(e,t){this._logger=t,this._telemetryLogManager=e.telemetryLogManager,this.updateEffectStatusManager()}get name(){return"VideoEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(e,t){if("effectsStarted"!==e&&"effectsStopped"!==e&&"effectsError"!==e&&"fpsWarningThresholdReached"!==e&&"timeForEffectsWarningReached"!==e)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t);const i=x();this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:i,operation:$g.subscribe,additionalDetails:{usageDetails:`Subscribed to ${e}`}})}off(e,t){if("effectsStarted"!==e&&"effectsStopped"!==e&&"effectsError"!==e&&"fpsWarningThresholdReached"!==e&&"timeForEffectsWarningReached"!==e)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}async isSupported(e){const t=x(),i=+new Date,n=this.getEffectNameForTelemetry(e?.name),r=this.getUsageDetailsForTelemetry("",n);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,kindOfEvent:Zu.attempt,additionalDetails:{usageDetails:r}});try{const n=this.getEffectInternalCast(e);if(this.disposed)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const r=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new mS(this._logger,r));const s=await this._supportChecker.videoEffectsSupported();this._logger.info(`Support check for ${n.name} resulted in: ${s}`);const a=this.getUsageDetailsForTelemetry("",n.name);return this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.success,additionalDetails:{usageDetails:a}}),s}catch(n){const r=new I({defaultError:f.FEATURES.VIDEO_EFFECTS.SUPPORT_CHECK_FAILED,originalError:n});this._logger.error(r.message);const s=this.getEffectNameForTelemetry(e?.name),a=this.getUsageDetailsForTelemetry("",s);throw this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.isSupported,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.failure,additionalDetails:{failureReason:r.message,code:r.code,...jp(r),usageDetails:a}}),r}}async startEffects(e){const t=x(),i=+new Date,n=this.getEffectNameForTelemetry(e?.name),r=this.getUsageDetailsForTelemetry("",n);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,kindOfEvent:Zu.attempt,additionalDetails:{usageDetails:r}});try{if(!yl().videoEffects.enableVideoEffects)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.DISABLED});if(this.disposed)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this.updateEffectStatusManager(),this.subscribeToStreamInstanceEvents();const n=window.performance.now();if(this._effect=this.getEffectInternalCast(e),!await this.isSupported(e))throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});const r=this._internalDeviceManager.getTsDeviceManager();if(!r)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.START_DEVICE_MANAGER});this.setConfigForEffects(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();const s=await this._effect._internalHandle.getEffectProvider();if(!s)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.PROVIDER_UNAVAILABLE});const a=await s.getVideoEffectProvider(),o=this.streamInstance.callStackWebCVProvider;if(!o)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.WEBCV_PROVIDER_FAILED});o.videoEffectProviderDeferredPromise.resolve(a),0===this._tsCallingEffectCapability&&(this._tsCallingEffectCapability=await(r?.getDeviceEffectsCapabilityAsync(""))),this._tsCallingSupportedEffects=this.getTsCallingSupportedEffects();const c=this._tsCallingSupportedEffects.find((e=>e.acsEffect===this._effect?.name));if(!c)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});await(r?.setDeviceEffectsAsync("",c.tsCallingEffect)),this._effectsStatusManager.setActiveEffects([this._effect.name]),this._logger.info(`Video effects started: ${this._effect.name}`);const l=window.performance.now();this.handleEffectsInitTimeEvent(n,l),this.handleFpsWarningEvent();const d=this.getUsageDetailsForTelemetry("",this._effect.name);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.success,additionalDetails:{usageDetails:d}})}catch(n){const r=new I({defaultError:f.FEATURES.VIDEO_EFFECTS.START_FAILED,originalError:n});this._logger?.error(r.message),this.eventEmitter.emit("effectsError",r),this.clearFpsCheckInterval();const s=this.getEffectNameForTelemetry(e?.name),a=this.getUsageDetailsForTelemetry("",s);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.startEffects,timestampInfo:{deltaTimeInMs:+new Date-i},kindOfEvent:Zu.failure,additionalDetails:{failureReason:r.message,code:r.code,...jp(r),usageDetails:a}})}}async stopEffects(){const e=x(),t=+new Date;this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:e,operation:$g.stopEffects,kindOfEvent:Zu.attempt});try{if(this.clearFpsCheckInterval(),this.disposed)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.STOP_DISPOSED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const i=this._internalDeviceManager.getTsDeviceManager();if(!i)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.STOP_DEVICE_MANAGER});this.updateEffectStatusManager();const n=this._tsCallingSupportedEffects.find((e=>"Off"===e.acsEffect));if(!n)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});await i.setDeviceEffectsAsync("",n.tsCallingEffect),this._effectsStatusManager?.setActiveEffects([]),this.unsubscribeFromStreamInstanceEvents();const r=this.getEffectNameForTelemetry(this._effect?.name);this._logger.info(`Video effects stopped: ${r}`),this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:e,operation:$g.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.success})}catch(i){const n=new I({defaultError:f.FEATURES.VIDEO_EFFECTS.STOP_FAILED,originalError:i});this._logger?.error(n.message),this.eventEmitter.emit("effectsError",n),this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:e,operation:$g.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,additionalDetails:{failureReason:n.message,code:n.code,...jp(n)}})}}async dispose(){try{if(this.disposed)return void this._logger.info("VideoEffects feature already disposed");this._effect&&(await this.stopEffects(),this._effect._internalHandle.dispose(),this._effect=null),this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.unsubscribeFromStreamInstanceEvents(),this.disposed=!0,this._logger.info("VideoEffects feature disposed")}catch(e){const t=new I({defaultError:f.FEATURES.VIDEO_EFFECTS.DISPOSE_FAILED,originalError:e});this._logger?.error(t.message),this.eventEmitter.emit("effectsError",t)}}getEffectInternalCast(e){if("BackgroundBlur"===e?.name&&this.isValidEffectInstance(e))return e;if("BackgroundReplacement"===e?.name&&this.isValidEffectInstance(e))return e;throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.INVALID_EFFECT})}isValidEffectInstance(e){let t;return("BackgroundBlur"===e.name&&void 0!==e._internalHandle||"BackgroundReplacement"===e.name&&void 0!==e._internalHandle)&&(t=e,this.hasValidInternalHandle(t._internalHandle))}hasValidInternalHandle(e){return void 0!==e.effectConfig&&void 0!==e.getEffectProvider&&void 0!==e.dispose&&void 0!==e.getStats&&void 0!==e.setConfig}getTsCallingSupportedEffects(){const e=[];return Object.values(fS).forEach((t=>{(this._tsCallingEffectCapability&t.tsCallingEffect)===t.tsCallingEffect&&e.push(t)})),e}subscribeToEffectEvents(){this._effect&&this._internalDeviceManager?(this._effect._internalHandle.on("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.on("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}disposeEffectEventSubscriptions(){this._effect?(this._effect._internalHandle.off("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.off("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}subscribeToStreamInstanceEvents(){this._sourceStreamSubscription&&(this._logger.info("Already subscribed to videoSourceChanged, removing old sub"),this.streamInstance.off("videoSourceChanged",this._sourceStreamSubscription)),this._sourceStreamSubscription=async e=>{e.source&&"Video"!==e.source.mediaStreamType&&await this.stopEffects()},this.streamInstance.on("videoSourceChanged",this._sourceStreamSubscription)}unsubscribeFromStreamInstanceEvents(){this._sourceStreamSubscription?(this.streamInstance.off("videoSourceChanged",this._sourceStreamSubscription),this._sourceStreamSubscription=null):this._logger.info("No videoSourceChanged sub active")}handleEffectsInitTimeEvent(e,t){if(!this._effect)return void this._logger.debug("No effect active");const i=x(),n=t-e,r=this._effect._internalHandle.effectConfig.effectInitTimeThresholdInMs;if(this._logger.info(`Time for effects to start: ${n}ms`),r&&n>r){this.eventEmitter.emit("timeForEffectsWarningReached",this._effect.name);const e=this.getUsageDetailsForTelemetry(`Threshold value: ${r}ms`,this._effect.name);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:i,operation:$g.timeForEffectsWarningReached,additionalDetails:{usageDetails:e}})}}handleFpsWarningEvent(){if(!this._effect)return void this._logger.debug("No effect active");this.clearFpsCheckInterval();const e=yl(),t=x(),i=e.videoEffects.waitTimeToInitiateFpsChecksInMs,n=e.videoEffects.fpsCheckIntervalTimeInMs;this._fpsWarningThresholdValue=this._effect._internalHandle.effectConfig.fpsWarningThreshold??e.videoEffects.fpsWarningThreshold;const r=window.setTimeout((()=>{const e=window.setInterval((()=>{const i=this._effect?._internalHandle.getStats(),n=i?.processor.fpsAvg;if(this._logger.info(`Effects avg fps check interval poll. Current Avg - ${n}`),n&&n<this._fpsWarningThresholdValue){this.eventEmitter.emit("fpsWarningThresholdReached",this._effect?.name),window.clearInterval(e),this._logger.info(`Effects fps warning threshold hit at ${n}fps`);const i=this.getUsageDetailsForTelemetry(`Fps reported: ${n}, Fps warning threshold value: ${this._fpsWarningThresholdValue}`,this._effect?.name);this.sendFeatureUsageTelemetry({eventName:Xu.acs_calling_media_stream,correlationId:t,operation:$g.fpsWarningThresholdReached,additionalDetails:{usageDetails:i}})}}),n);this._fpsWarningEventIntervalIds.push(e)}),i);this._fpsWarningEventTimeoutIds.push(r)}setConfigForEffects(){if(!this._effect)return void this._logger.debug("No effect active");const e=this._effect._internalHandle.configProvider.config.videoEffects??this._effect._internalHandle.configProvider.config,t=Cl(),i=yl();if(t?.enableVideoEffects&&i?.videoEffects?.enableVideoEffects&&(e.enableVideoEffects=t.enableVideoEffects&&i.videoEffects.enableVideoEffects),e.effectConfig={...e.effectConfig,effectInitTimeThresholdInMs:i.videoEffects.effectInitTimeThresholdInMs,fpsWarningThreshold:i.videoEffects.fpsWarningThreshold},t.webcv){const i=t.webcv;e.webcvConfig={...e.webcvConfig,...i}}this._effect._internalHandle.setConfig(e),this._logger.info(`Config for effects set: ${Il(e)}`)}sendFeatureUsageTelemetry(e){if(this._telemetryLogManager)try{const t={correlationId:e.correlationId,mediaType:Bg.VideoRaw,streamType:Hg.Local,operation:e.operation,timestampInfo:e.timestampInfo||{},kindOfEvent:e.kindOfEvent||"",additionalDetails:e.additionalDetails||""};this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:t})}catch(t){this._logger.debug(`Unable to send ${e.operation} telemetry`)}else this._logger.debug("Telemetry error. Instance is undefined.")}getEffectNameForTelemetry(e){let t="UNKNOWN";return e?t="string"==typeof e?e:JSON.stringify(e):this._effect?.name?t=this._effect.name:this._activeEffects?.[0]&&(t=JSON.stringify(this._activeEffects[0])),t}getUsageDetailsForTelemetry(e,t=""){return`${t?`[${t}] `:""}${e}`}clearFpsCheckInterval(){this._fpsWarningEventIntervalIds.forEach((e=>{window.clearInterval(e)})),this._fpsWarningEventTimeoutIds.forEach((e=>{window.clearTimeout(e)})),this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[]}updateEffectStatusManager(){this.streamInstance.canStartEffects?(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this._effectsStatusManager||(this._effectsStatusManager=this._internalDeviceManager.callStackVideoEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback)),this._activeEffects=this._effectsStatusManager.getActiveEffects()):this._logger.warn("Cannot update status manager, current source is not supported.")}}),AudioEffects:function(e,t={activationEvent:"OnFeatureAccess"}){return{get audioStreamApiCtor(){return e},activationOptions:t,isVideoStreamFeature:!0}}(Iv),DataChannel:Mp(class extends Cp{constructor(e){super(e)}createDataChannelSender(e){const t=x(),i=yl();try{if(void 0!==e.bitrateInKbps&&"number"!=typeof e.bitrateInKbps)throw TS("bitrateInKbps","number");if(void 0!==e.channelId&&"number"!=typeof e.channelId)throw TS("channelId","number");if(void 0!==e.participants&&!Array.isArray(e.participants))throw TS("participants","CommunicationIdentifier[]");if(void 0!==e.priority&&-1===["High","Normal"].indexOf(e.priority))throw IS("priority","High,Normal");if(void 0!==e.reliability&&-1===["Durable","Lossy"].indexOf(e.reliability))throw IS("reliability","Durable,Lossy");const n={bitrateInKbps:Math.ceil(e.bitrateInKbps??i.dataChannel.defaultBitrate/1e3),channelId:e.channelId??0,participants:e.participants??[],priority:e.priority??"Normal",reliability:e.reliability??"Durable"};this._logger.info(`createDataChannelSender: ${function(e){const t=[];return void 0!==e.bitrateInKbps&&t.push(`bitrateInKbps=${e.bitrateInKbps}`),void 0!==e.channelId&&t.push(`channelId=${e.channelId}`),void 0!==e.participants&&t.push(`participants size=${e.participants.length}`),void 0!==e.priority&&t.push(`priority=${e.priority}`),void 0!==e.reliability&&t.push(`reliability=${e.reliability}`),t.join(",")}(e)}`),this._sendFeatureUsage("createDataChannelSender",Zu.attempt),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"attempt",correlationId:t,senderOptions:{channelId:e.channelId,bitrateInKbps:e.bitrateInKbps,participantsSize:e.participants?.length,priority:e.priority,reliability:e.reliability}});const r=this._dataChannelManager.createSender(n,t);return this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"success",correlationId:t,senderOptions:{channelId:r.channelId,bitrateInKbps:n.bitrateInKbps,participantsSize:n.participants?.length,priority:n.priority,reliability:n.reliability}}),this._logger.info(`The sender is created. channel id=${r.channelId}`),this._sendFeatureUsage("createDataChannelSender",Zu.success),r}catch(e){const i=new I({defaultError:f.FEATURES.DATA_CHANNEL.FAILED_TO_CREATE_SENDER,originalError:e});throw this._logger.info(`Failed to create the sender: ${i.message}`),this._sendFeatureUsage("createDataChannelSender",Zu.failure),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"failure",correlationId:t,failureReason:i.message,additionalDetails:{...jp(i)}}),i}}async createDataChannelAdapter(e){const t=new NS(this._tsCall,e);return await t.initialize(),t}initialize(e,t){this._tsCall=e.tsCall,this._logger=t.createChild("DataChannelCallFeature"),this._telemetryLogManager=e.telemetryLogManager,this._dataChannelTelemetryLogger=new mv(this._tsCall,this._telemetryLogManager);const i=new pv(this._tsCall,this._logger,this._dataChannelTelemetryLogger);this._dataChannelManager=i,this._dataChannelManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Zu.initialize)})).catch((e=>{this._logger.error(`initialize:${MS(e)}`)}))}get name(){return this._sendFeatureUsage("name",Zu.getter),"DataChannel"}dispose(){this.disposed||(this._dataChannelManager?.dispose(),super.dispose())}on(e,t){if("dataChannelReceiverCreated"!==e)throw ES(e,"subscribe");this._sendFeatureUsage(e,Zu.subscribe),"dataChannelReceiverCreated"===e&&this._dataChannelManager?.on("dataChannelReceiverCreated",t)}off(e,t){if("dataChannelReceiverCreated"!==e)throw ES(e,"unsubscribe");this._sendFeatureUsage(e,Zu.unsubscribe),"dataChannelReceiverCreated"===e&&this._dataChannelManager?.off("dataChannelReceiverCreated",t)}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"DataChannel",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}}),OptimalVideoCount:Mp(class extends Cp{_sendOVCTelemetryEvent(e){if(!this._telemetryLogManager)return;const t={callId:this._call?.id||"",localParticipantId:this._tsCall?.participantId||"",featureName:"OptimalVideoCount",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{step:e}};this._telemetryLogManager.sendEvent({name:Xu.acs_calling_feature_usage,tenant:uc,properties:t})}get optimalVideoCount(){return this._sendOVCTelemetryEvent(Zu.getter),this._tsCall?.optimalVideoCount?this._tsCall.optimalVideoCount:1}constructor(e){super(e),this.name="OptimalVideoCount",this._impl=new yv(this.name,this.eventEmitter,this.optimalVideoCount)}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t),this._tsCall=e.tsCall,this._telemetryLogManager=e.telemetryLogManager,this._call=e.call}on(e,t){if("optimalVideoCountChanged"!==e)throw new I({defaultError:f.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendOVCTelemetryEvent(Zu.subscribe),this.eventEmitter.on(e,t)}off(e,t){if("optimalVideoCountChanged"!==e)throw new I({defaultError:f.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._sendOVCTelemetryEvent(Zu.unsubscribe),this.eventEmitter.off(e,t)}}),UnmixedAudio:Mp(class extends Cp{constructor(e){super(e)}initialize(e,t){const i=yl().unmixedAudio;this._tsCall=e.tsCall,this._logger=t.createChild("UnmixedAudioCallFeature"),this._telemetryLogManager=e.telemetryLogManager;const n=new Nv(this._tsCall,this._telemetryLogManager);this._unmixedAudioManager=new Vv(this._tsCall,this._logger,n,i),this._unmixedAudioManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Zu.initialize)})).catch((e=>{}))}get name(){return this._sendFeatureUsage("name",Zu.getter),"UnmixedAudio"}dispose(){this.disposed||(this._unmixedAudioManager.dispose(),super.dispose())}enableUnmixedAudio(){return this._unmixedAudioManager.enableUnmixedAudio()}disableUnmixedAudio(){return this._unmixedAudioManager.disableUnmixedAudio()}get isUnmixedAudioActive(){return this._unmixedAudioManager.isUnmixedAudioActive}on(e,t){if("participantSpeaking"!==e)throw bv(e,"subscribe");this._sendFeatureUsage(e,Zu.subscribe),this._unmixedAudioManager.on(e,t)}off(e,t){if("participantSpeaking"!==e)throw bv(e,"unsubscribe");this._sendFeatureUsage(e,Zu.unsubscribe),this._unmixedAudioManager.off(e,t)}_sendFeatureUsage(e,t){Op({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"UnmixedAudio",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:e,step:t}},this._telemetryLogManager,this._logger)}}),AudioZones:Mp(class extends Cp{constructor(e){super(e),this._impl=new vv(this.eventEmitter,this.name)}get name(){return"AudioZones"}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.call,e.telemetryLogManager,t)}updateAudioZone(e){return this._impl.updateAudioZone(e)}dispose(){this._impl.dispose(),super.dispose()}get meetingGroupDetails(){return this._impl.meetingGroupDetails}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}}),TeamsMeetingAudioConferencing:Mp(class extends Cp{constructor(e){super(e),this._impl=new Bv}get name(){return"TeamsMeetingAudioConferencing"}initialize(e,t){this._impl.initialize(e.tsCall,e.callAgent,e.telemetryLogManager,t)}async getTeamsMeetingAudioConferencingDetails(){return this._impl.getTeamsMeetingAudioConferencingDetails()}dispose(){this.disposed||super.dispose()}})};function IC(e){switch(e){case vp.CallClientFeature:return Object.entries(TC).filter((e=>!0===e[1].isCallClientFeature)).map((e=>e[1]));case vp.CallAgentFeature:return Object.entries(TC).filter((e=>!0===e[1].isCallAgentFeature)).map((e=>e[1]));case vp.CallFeature:return Object.entries(TC).filter((e=>!0===e[1].isCallFeature)).map((e=>e[1]))}}class bC{constructor(e,t){this._eventBag=[],this.resetEventBag=()=>{this._eventBag=[]},this._logger=e.createChild("CallStats"),this._telemetryLogManager=t}recordEvent(e){try{if(yl()?.telemetry?.callStatsFlushTimeout<0)return;if(yl()?.telemetry?.blockedEvents?.indexOf(e.name)>-1)return;const t={...e,timestamp:+new Date};this._logger.debug(`CallStat recorded=${e.name}`),this._eventBag.push(t),this.scheduleTelemtryFlush()}catch(e){this._logger.debug("Failed to record call stats")}}flushEvents(){if(this._logger.debug(`CallStats sending telemetry, number of events=${this._eventBag.length}`),0!==this._eventBag.length)try{const e=this._eventBag.reduce(((e,t)=>(e[t.localParticipantId]?e[t.localParticipantId].events.push({name:t.name,timestamp:t.timestamp,...t.data}):e[t.localParticipantId]={callId:t.callId,localParticipantId:t.localParticipantId,events:[{name:t.name,timestamp:t.timestamp,...t.data}]},e)),{});Object.keys(e).forEach((t=>{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_call_stats,tenant:uc,properties:{...e[t]}})})),this.resetEventBag()}catch(e){this._logger.debug("Failed to send call stats")}}scheduleTelemtryFlush(){this._callStatSendTimeout||(this._callStatSendTimeout=window.setTimeout((()=>{this.flushEvents(),this._callStatSendTimeout=void 0}),yl().telemetry.callStatsFlushTimeout))}}class AC{constructor(e){this._volumeIndicator=e,this._eventEmitter=new ep}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}get level(){return this._volumeIndicator.level}async setSource(e){this._mediaStream!==e&&(this._mediaStream&&this._volumeIndicator.dispose(),e&&(this._mediaStream=e,await this._volumeIndicator.getVolumeIndicator(e),this._volumeIndicator.on("levelChanged",(()=>{this._eventEmitter.emit("levelChanged")}))))}dispose(){this._eventEmitter.removeAllListeners()}}class RC{constructor(e,i,n,r){this._workQueue=Promise.resolve();const s=t.createClientLogger("ACS-calling");this.logger=new Uf(s,[()=>"RemoteAudioStream for media stream"]),this._source=e,this._disposed=!1,this._volumeIndicator=new jf(this.logger,"RemoteAudioStream",i,n,r),e.changed((async()=>{this._volumeProxy&&(this._workQueue=this._workQueue.then((async()=>{await(this._volumeProxy?.setSource(await this._source.getMediaStream()))})).catch((e=>{this.logger.log(`source changed but failed to update volume indicator: ${e?.message??"unknown error"}`)})))})),this.logger.info("created")}async getMediaStream(){return await this._source.getMediaStream()}get source(){return this._source}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._volumeIndicator.dispose(),this._disposed=!0)}async getVolume(){if(!this._volumeProxy){const e=new AC(this._volumeIndicator),t=this._workQueue.then((async()=>{await e.setSource(await this._source.getMediaStream())}));this._workQueue=t.catch(kl),await t,this._volumeProxy=e}return this._volumeProxy}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([Of,function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:type",Object)],RC.prototype,"logger",void 0);var wC=a((function(e,t){!function(i,n){var r="function",s="undefined",a="object",o="string",c="model",l="name",d="type",h="vendor",u="version",g="architecture",p="console",m="mobile",f="tablet",S="smarttv",v="wearable",y="embedded",C="Amazon",_="Apple",E="ASUS",T="BlackBerry",I="Browser",b="Chrome",A="Firefox",R="Google",w="Huawei",P="LG",M="Microsoft",D="Motorola",O="Opera",k="Samsung",N="Sharp",L="Sony",x="Xiaomi",U="Zebra",F="Facebook",V=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},B=function(e,t){return typeof e===o&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},$=function(e,t){if(typeof e===o)return e=e.replace(/^\s\s*/,""),typeof t===s?e:e.substring(0,350)},G=function(e,t){for(var i,s,o,c,l,d,h=0;h<t.length&&!l;){var u=t[h],g=t[h+1];for(i=s=0;i<u.length&&!l;)if(l=u[i++].exec(e))for(o=0;o<g.length;o++)d=l[++s],typeof(c=g[o])===a&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,d):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=d?d.replace(c[1],c[2]):n:this[c[0]]=d?c[1].call(this,d,c[2]):n:4===c.length&&(this[c[0]]=d?c[3].call(this,d.replace(c[1],c[2])):n):this[c]=d||n;h+=2}},j=function(e,t){for(var i in t)if(typeof t[i]===a&&t[i].length>0){for(var r=0;r<t[i].length;r++)if(B(t[i][r],e))return"?"===i?n:i}else if(B(t[i],e))return"?"===i?n:i;return e},q={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},W={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[u,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[u,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,u],[/opios[\/ ]+([\w\.]+)/i],[u,[l,O+" Mini"]],[/\bopr\/([\w\.]+)/i],[u,[l,O]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,u],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[u,[l,"UC"+I]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[u,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[u,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[u,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[u,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[u,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+I],u],[/\bfocus\/([\w\.]+)/i],[u,[l,A+" Focus"]],[/\bopt\/([\w\.]+)/i],[u,[l,O+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[u,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[u,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[u,[l,O+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[u,[l,"MIUI "+I]],[/fxios\/([-\w\.]+)/i],[u,[l,A]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+I]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+I],u],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],u],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,u],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,F],u],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,u],[/\bgsa\/([\w\.]+) .*safari\//i],[u,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[u,[l,b+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,b+" WebView"],u],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[u,[l,"Android "+I]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,u],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[u,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[u,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[u,j,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,u],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],u],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[u,[l,A+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[l,u],[/(cobalt)\/([\w\.]+)/i],[l,[u,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[g,"amd64"]],[/(ia32(?=;))/i],[[g,H]],[/((?:i[346]|x)86)[;\)]/i],[[g,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[g,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[g,"armhf"]],[/windows (ce|mobile); ppc;/i],[[g,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[g,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[g,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[g,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[c,[h,k],[d,f]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[c,[h,k],[d,m]],[/\((ip(?:hone|od)[\w ]*);/i],[c,[h,_],[d,m]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[c,[h,_],[d,f]],[/(macintosh);/i],[c,[h,_]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[c,[h,w],[d,f]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[c,[h,w],[d,m]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[c,/_/g," "],[h,x],[d,m]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[c,/_/g," "],[h,x],[d,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[c,[h,"OPPO"],[d,m]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[c,[h,"Vivo"],[d,m]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[c,[h,"Realme"],[d,m]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[c,[h,D],[d,m]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[c,[h,D],[d,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[c,[h,P],[d,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[c,[h,P],[d,m]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[c,[h,"Lenovo"],[d,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[c,/_/g," "],[h,"Nokia"],[d,m]],[/(pixel c)\b/i],[c,[h,R],[d,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[c,[h,R],[d,m]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[c,[h,L],[d,m]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[c,"Xperia Tablet"],[h,L],[d,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[c,[h,"OnePlus"],[d,m]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[c,[h,C],[d,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[c,/(.+)/g,"Fire Phone $1"],[h,C],[d,m]],[/(playbook);[-\w\),; ]+(rim)/i],[c,h,[d,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[c,[h,T],[d,m]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[c,[h,E],[d,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[c,[h,E],[d,m]],[/(nexus 9)/i],[c,[h,"HTC"],[d,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[c,/_/g," "],[d,m]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[c,[h,"Acer"],[d,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[c,[h,"Meizu"],[d,m]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[c,[h,N],[d,m]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,c,[d,m]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,c,[d,f]],[/(surface duo)/i],[c,[h,M],[d,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[c,[h,"Fairphone"],[d,m]],[/(u304aa)/i],[c,[h,"AT&T"],[d,m]],[/\bsie-(\w*)/i],[c,[h,"Siemens"],[d,m]],[/\b(rct\w+) b/i],[c,[h,"RCA"],[d,f]],[/\b(venue[\d ]{2,7}) b/i],[c,[h,"Dell"],[d,f]],[/\b(q(?:mv|ta)\w+) b/i],[c,[h,"Verizon"],[d,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[c,[h,"Barnes & Noble"],[d,f]],[/\b(tm\d{3}\w+) b/i],[c,[h,"NuVision"],[d,f]],[/\b(k88) b/i],[c,[h,"ZTE"],[d,f]],[/\b(nx\d{3}j) b/i],[c,[h,"ZTE"],[d,m]],[/\b(gen\d{3}) b.+49h/i],[c,[h,"Swiss"],[d,m]],[/\b(zur\d{3}) b/i],[c,[h,"Swiss"],[d,f]],[/\b((zeki)?tb.*\b) b/i],[c,[h,"Zeki"],[d,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],c,[d,f]],[/\b(ns-?\w{0,9}) b/i],[c,[h,"Insignia"],[d,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[c,[h,"NextBook"],[d,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],c,[d,m]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],c,[d,m]],[/\b(ph-1) /i],[c,[h,"Essential"],[d,m]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[c,[h,"Envizen"],[d,f]],[/\b(trio[-\w\. ]+) b/i],[c,[h,"MachSpeed"],[d,f]],[/\btu_(1491) b/i],[c,[h,"Rotor"],[d,f]],[/(shield[\w ]+) b/i],[c,[h,"Nvidia"],[d,f]],[/(sprint) (\w+)/i],[h,c,[d,m]],[/(kin\.[onetw]{3})/i],[[c,/\./g," "],[h,M],[d,m]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[c,[h,U],[d,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[c,[h,U],[d,m]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,c,[d,p]],[/droid.+; (shield) bui/i],[c,[h,"Nvidia"],[d,p]],[/(playstation [345portablevi]+)/i],[c,[h,L],[d,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[c,[h,M],[d,p]],[/smart-tv.+(samsung)/i],[h,[d,S]],[/hbbtv.+maple;(\d+)/i],[[c,/^/,"SmartTV"],[h,k],[d,S]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,P],[d,S]],[/(apple) ?tv/i],[h,[c,_+" TV"],[d,S]],[/crkey/i],[[c,b+"cast"],[h,R],[d,S]],[/droid.+aft(\w)( bui|\))/i],[c,[h,C],[d,S]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[c,[h,N],[d,S]],[/(bravia[\w ]+)( bui|\))/i],[c,[h,L],[d,S]],[/(mitv-\w{5}) bui/i],[c,[h,x],[d,S]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[h,$],[c,$],[d,S]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[d,S]],[/((pebble))app/i],[h,c,[d,v]],[/droid.+; (glass) \d/i],[c,[h,R],[d,v]],[/droid.+; (wt63?0{2,3})\)/i],[c,[h,U],[d,v]],[/(quest( 2)?)/i],[c,[h,F],[d,v]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[d,y]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[c,[d,m]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[c,[d,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[d,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[d,m]],[/(android[-\w\. ]{0,9});.+buil/i],[c,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[u,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[u,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,u],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[u,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,u],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[u,j,q]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[u,j,q]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[u,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,"Mac OS"],[u,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[u,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,u],[/\(bb(10);/i],[u,[l,T]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[u,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[u,[l,A+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[u,[l,"webOS"]],[/crkey\/([\d\.]+)/i],[u,[l,b+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[l,"Chromium OS"],u],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,u],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],u],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,u]]},z=function(e,t){if(typeof e===a&&(t=e,e=n),!(this instanceof z))return new z(e,t).getResult();var r=e||(typeof i!==s&&i.navigator&&i.navigator.userAgent?i.navigator.userAgent:""),p=t?function(e,t){var i={};for(var n in e)t[n]&&t[n].length%2==0?i[n]=t[n].concat(e[n]):i[n]=e[n];return i}(W,t):W;return this.getBrowser=function(){var e={};return e[l]=n,e[u]=n,G.call(e,r,p.browser),e.major=function(e){return typeof e===o?e.replace(/[^\d\.]/g,"").split(".")[0]:n}(e.version),e},this.getCPU=function(){var e={};return e[g]=n,G.call(e,r,p.cpu),e},this.getDevice=function(){var e={};return e[h]=n,e[c]=n,e[d]=n,G.call(e,r,p.device),e},this.getEngine=function(){var e={};return e[l]=n,e[u]=n,G.call(e,r,p.engine),e},this.getOS=function(){var e={};return e[l]=n,e[u]=n,G.call(e,r,p.os),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return r},this.setUA=function(e){return r=typeof e===o&&e.length>350?$(e,350):e,this},this.setUA(r),this};z.VERSION="1.0.33",z.BROWSER=V([l,u,"major"]),z.CPU=V([g]),z.DEVICE=V([c,h,d,p,m,S,f,v,y]),z.ENGINE=z.OS=V([l,u]),e.exports&&(t=e.exports=z),t.UAParser=z;var J=typeof i!==s&&(i.jQuery||i.Zepto);if(J&&!J.ua){var K=new z;J.ua=K.getResult(),J.ua.get=function(){return K.getUA()},J.ua.set=function(e){K.setUA(e);var t=K.getResult();for(var i in t)J.ua[i]=t[i]}}}("object"==typeof window?window:s)}));const PC=[{name:"edge",engine:"Edge",key:"Edge"},{name:"edgeanaheim",engine:"Chromium",key:"Edg"},{name:"chromium",engine:"Chromium",key:"Chromium"},{name:"opera",engine:"Chromium",key:"OPR"},{name:"yandexbrowser",engine:"Chromium",key:"YaBrowser"},{name:"electron",engine:"Chromium",key:"Electron"},{name:"chrome",engine:"Chromium",key:"Chrome"},{name:"firefox",engine:"Firefox",key:"Firefox"},{name:"safari",engine:"Safari",key:"Safari"},{name:"applewebview",engine:"Safari",key:"Mac OS X"},{name:"ie",engine:"MSIE",key:"Trident"}],MC="0.0",DC="unknown";function OC(e){return/iPhone|iPad|iPod|Android|Mobi/i.test(e)?"Mobile":"Desktop"}let kC=new wC.UAParser;function NC(){return kC||(kC=new wC.UAParser),kC.getResult()}function LC(){const e=NC().ua;return-1!==e.indexOf("Edge")?"edge":-1!==e.indexOf("Electron")?"electron":-1!==e.indexOf("Chrome")?"chrome":-1!==e.indexOf("Firefox")?"firefox":-1!==e.indexOf("Safari")?"safari":-1!==e.indexOf("Mac OS X")?"applewebview":-1!==e.indexOf("Trident")?"ie":"unknown"}function xC(e,t){const i=t.find((({name:t})=>t===e));if(!i)return DC;let n=i.engine;return n=function(e,t){const i=VC();return"chrome"===e&&"ios"===i&&(t="Safari"),t}(e,n),n}function UC(){const e=NC();return"WebKit"===e.browser.name&&-1!==e.ua.indexOf("Mac OS X")?e.os.version??MC:void 0!==e.browser.version?e.browser.version:MC}function FC(){const e=NC(),t=e.ua,i=function(e,t){const i=t.find((({key:t})=>e.includes(t)));if(!i)return DC;let n=i.name;return n=function(e,t){return"edge"!==e&&"edgeanaheim"!==e||((t.includes("Edg/")||t.includes("EdgA/")||t.includes("EdgiOS/"))&&(e="edgeanaheim"),t.includes("Edge/")&&(e="edge")),e}(n,NC().ua),n}(e.browser.name,PC);return{name:i,engine:xC(i,PC),version:UC(),formFactor:OC(t)}}function VC(){const e=NC().ua;return/windows phone/i.test(e)?"windowsphone":/windows /i.test(e)?"windows":/macintosh/i.test(e)?"mac":/(ipod|iphone|ipad)/i.test(e)?"ios":function(e){const t=!/like android/i.test(e),i=/android/i.test(e);return t&&i}(e)?"android":/(web|hpw)[o0]s/i.test(e)?"webos":/tizen/i.test(e)?"tizen":/headlesschrome(?:\/([\w\.]+)| )/i.test(e)?"headlesschrome":/linux/i.test(e)?"linux":/CrOS/.test(e)?"chrome":"other"}function BC(){const e=NC();return void 0!==e.os.version?e.os.version:MC}function HC(e){return/^\d+$/.test(e)}function $C(e,i){e=e.replace(/,/g,".").trim(),i=i.replace(/,/g,".").trim();let n=e.split("."),r=i.split(".");try{if(!n.every(HC)||!r.every(HC))return-2;for(;n.length<r.length;)n.push("0");for(;r.length<n.length;)r.push("0");let e=n.map(Number),t=r.map(Number);for(var s=0;s<e.length;s++)if(e[s]!==t[s]){if(e[s]>t[s])return 1;if(e[s]<t[s])return-1}}catch(e){t.AzureLogger.log(`Error in browser check version support: ${e}`)}return 0}function GC(e){let t=yl()?.environments;return!!t.hasOwnProperty(e)}function jC(){let e,t,i=!1;const n=NC(),r=VC(),s=FC().name,a=FC().version,o=GC(r),c=function(e,t){let i=yl()?.environments;return!(!GC(e)||!i[e].hasOwnProperty(t))&&i[e][t].isSupportedOnSdkVersion}(r,s);return c&&$C(a,function(e,t){let i=yl()?.environments;return i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)?i[e][t].minVersion:MC}(r,s))>=0&&(i=!0),t={platform:n.os.name,browser:n.browser.name,browserVersion:n.browser.version},e={environment:t,isSupportedPlatform:o,isSupportedBrowser:c,isSupportedBrowserVersion:i,isSupportedEnvironment:o&&c&&i},e}class qC{get currentVideoConstraints(){return this._currentVideoConstraints}constructor(e,t,i){this._tsCall=e,this._currentVideoConstraints={send:{frameHeight:{max:void 0},frameRate:{max:void 0},bitrate:{max:void 0}}},this._logger=t.createChild("MediaConstraintsManager"),this._telemetryLogManager=i}async setVideoConstraints(e,t,i,n){const r=this.getTelemetryPayload({video:e}),s=e=>{let r=e?{failureReason:e?e.message:void 0,code:e?e.code:void 0,...jp(e)}:void 0;Op({correlationId:i,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:{deltaTimeInMs:+new Date-n},featureDetails:{name:"setConstraints",step:e?Zu.failure:Zu.success,stage:t},additionalDetails:{constraints:this.getTelemetryPayload({video:this._currentVideoConstraints}),...r}},this._telemetryLogManager,this._logger)};try{if(Op({correlationId:i,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:"",featureDetails:{name:"setConstraints",step:Zu.attempt,stage:t},additionalDetails:{constraints:r}},this._telemetryLogManager,this._logger),!yl().calling.constraints.enabled)throw this._logger.error("Setting call constraints is disabled"),new I({defaultError:f.CALL.MEDIA_CONSTRAINTS_DISABLED});this._updateVideoConstraintsCache(e);const n={outgoingVideoLimit:{maxResolution:this._currentVideoConstraints.send?.frameHeight?.max,maxFramerate:this._currentVideoConstraints.send?.frameRate?.max,maxBitrate:this._currentVideoConstraints.send?.bitrate?.max}},a=this._tsCall.setCallConstraints?.(n);if("mid-call"!==t)a?.then((()=>{this._logger.info(`Successfully set call constraints at call ${t} - ${JSON.stringify(this._currentVideoConstraints)}`),s()})).catch((e=>{this._logger.error(`Error setting call constraints at call ${t}`);const i=new I({defaultError:f.CALL.SET_CONSTRAINTS_START_OR_ACCEPT,defaultErrorMessageArgs:[t],originalError:e});s(i)}));else try{await a,this._logger.info(`Successfully set call constraints during ${t} - ${JSON.stringify(this._currentVideoConstraints)}`),s()}catch(e){throw new I({defaultError:f.CALL.SET_CONSTRAINTS_MID_CALL,originalError:e})}return this._currentVideoConstraints}catch(e){const i=new I({defaultError:f.CALL.SET_CONSTRAINTS,defaultErrorMessageArgs:[t],originalError:e});throw s(i),i}}getTelemetryPayload(e){return{video:{send:{frameHeight:{max:e.video?.send?.frameHeight?.max},frameRate:{max:e.video?.send?.frameRate?.max},bitrate:{max:e.video?.send?.bitrate?.max}}}}}_updateVideoConstraintsCache(e){const t=yl(),i=t.calling.constraints.maxOutgoingResolution,n=t.calling.constraints.maxOutgoingFrameRate,r=t.calling.constraints.maxOutgoingVideoBitrate,s=e?.send?.frameHeight?.max??this._currentVideoConstraints.send?.frameHeight?.max,a=e?.send?.frameRate?.max??this._currentVideoConstraints.send?.frameRate?.max,o=e?.send?.bitrate?.max??this._currentVideoConstraints.send?.bitrate?.max;this._currentVideoConstraints={send:{frameHeight:{max:this._getConstraintValue(i,"maxOutgoingResolution",s)},frameRate:{max:this._getConstraintValue(n,"maxOutgoingFrameRate",a)},bitrate:{max:this._getConstraintValue(r,"maxOutgoingBitrate",o)}}}}_getConstraintValue(e,t,i){return"number"==typeof i?i<1?void this._logger.info(`Received ${t} as 0 or less, removing ${t} constraint`):(e>0&&i>e&&(this._logger.info(`${t} value ${i} is larger than ${e}, resetting to ${e}`),i=e),i):void this._logger.warn(`Received invalid ${t} value, removing ${t} constraint`)}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([Of,function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:type",Object)],qC.prototype,"_logger",void 0);var WC=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},zC=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class JC{constructor(e,t,i,n){this.logger=i.createChild("Lobby"),this._tsCall=e,this._eventEmitter=new Nm(this.logger),this._participants=new Map,this._call=t,this._telemetryLogManager=n,this._lobbySupportedConversationTypes=yl().calling.lobbyAdmitAndReject.supportedConversationTypes,this._isLobbyEnabled=yl().calling.lobbyAdmitAndReject.enabled,this._hasExpectedError=!1,this._isLobbyEnabled&&(this.getInLobbyParticipants(t.remoteParticipants),this._remoteParticipantUpdatedListener=e=>{if(0!==e.added.length&&e.added.forEach((e=>{"InLobby"===e.state&&this.addLobbyParticipant(e),e.on("stateChanged",(()=>{"InLobby"===e.state?this.addLobbyParticipant(e):"Connected"===e.state&&this.removeLobbyParticipant(e)}))})),0!==e.removed.length){if(0===this._call.remoteParticipants.length)return void this.removeAllLobbyParticipants();e.removed.forEach((e=>{this.removeLobbyParticipant(e)}))}},this._call.on("remoteParticipantsUpdated",this._remoteParticipantUpdatedListener))}on(e,t){if("lobbyParticipantsUpdated"!==e)throw new I({defaultError:f.LOBBY.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("lobbyParticipantsUpdated"!==e)throw new I({defaultError:f.LOBBY.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}async admit(e,t){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const i=x(),n=+new Date;this._sendLobbyAdmitAndRejectUsage("Start admit participant",eg.lobbyAdmit,i,Zu.attempt,void 0);try{ol(e),this.validateLobbyOperation(e),await this._tsCall.admitParticipant(rl(e));const t=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant admitted successfully",eg.lobbyAdmit,i,Zu.success,t-n)}catch(e){let t=ig.Unexpected;this._hasExpectedError&&(t=ig.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit participant from lobby",e,i,n,eg.lobbyAdmit,t)}}async reject(e,t){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const i=x(),n=+new Date;this._sendLobbyAdmitAndRejectUsage("Start reject participant",eg.lobbyReject,i,Zu.attempt,void 0);try{ol(e),this.validateLobbyOperation(e),await this._tsCall.removeParticipant(rl(e));const t=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant rejected successfully",eg.lobbyReject,i,Zu.success,t-n)}catch(e){let t=ig.Unexpected;this._hasExpectedError&&(t=ig.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to reject participant from lobby",e,i,n,eg.lobbyReject,t)}}async admitAll(e){const t=x(),i=+new Date;let n,r=0,s=0;if(!this._isLobbyEnabled)return this.logger.warn("Lobby is not enabled"),{successCount:r,failureCount:s};this._sendLobbyAdmitAndRejectUsage("Start admit all participants",eg.lobbyAdmitAll,t,Zu.attempt,void 0);try{this.validateLobbyOperation(),await this._tsCall.admit({scope:"all"},m.generateCauseId()).then((e=>{if(n=e,e.result){const t=JSON.parse(e.result);r=t.successCount,s=t.failureCount}}));const e=+new Date;if(0!==s)return this._sendLobbyAdmitAndRejectUsage(`${r} participants are admitted successfully, ${s} participants admit failed. TransactionEnd: ${n}`,eg.lobbyAdmitAll,t,Zu.success,e-i),{successCount:r,failureCount:s};this._sendLobbyAdmitAndRejectUsage("All participants are admitted successfully",eg.lobbyAdmitAll,t,Zu.success,e-i)}catch(e){let n=ig.Unexpected;this._hasExpectedError&&(n=ig.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit all participants from lobby",e,t,i,eg.lobbyAdmitAll,n)}return{successCount:r,failureCount:s}}get participants(){return this._isLobbyEnabled?Array.from(this._participants.values()):(this.logger.warn("Lobby is not enabled"),[])}getInLobbyParticipants(e){e.forEach((e=>{if("InLobby"===e.state){const t=rl(e.identifier);this._participants.set(t,e)}}))}removeAllLobbyParticipants(){if(0===this._participants.size)return;const e=Array.from(this._participants.values());this._participants.clear(),this.logger.info("All participants are removed from lobby"),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:e})}removeLobbyParticipant(e){const t=rl(e.identifier);this._participants.has(t)&&(this.logger.info(`${n.getIdentifierKind(e.identifier).kind} is removed from lobby`),this._participants.delete(t),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:[e]}))}addLobbyParticipant(e){const t=rl(e.identifier);this._participants.has(t)||(this.logger.info(`${n.getIdentifierKind(e.identifier).kind} is added to lobby`),this._participants.set(t,e),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[e],removed:[]}))}validateLobbyOperation(e){const t=this._tsCall.conversationType?this._tsCall.conversationType:"oneToOneCall";if(this.logger.info("Current conversation type is: ",t),!this._lobbySupportedConversationTypes.find((e=>e===t)))throw this._hasExpectedError=!0,new I({defaultError:f.LOBBY.CONV_UNSUPPORTED});if(e){let t=this._call.remoteParticipants.find((t=>rl(t.identifier)===rl(e)));if(t&&"Connected"===t.state)throw this._hasExpectedError=!0,new I({defaultError:f.LOBBY.ALREADY_IN_MEETING,defaultErrorMessageArgs:[n.getIdentifierKind(e).kind]});if(t&&"InLobby"!==t.state||!t)throw this._hasExpectedError=!0,new I({defaultError:f.LOBBY.NOT_IN_LOBBY,defaultErrorMessageArgs:[n.getIdentifierKind(e).kind]})}if(this._call.role!==Wc.Presenter&&this._call.role!==Wc.Organizer&&this._call.role!==Wc.Coorganizer)throw this._hasExpectedError=!0,new I({defaultError:f.LOBBY.UNAUTHORIZED_ADMIT_REJECT})}handleLobbyAdmitAndRejectFailure(e,t,i,n,r,s){const a=+new Date,o=function(e,t,i){const n=void 0===t?.code?500:t?._code,r=t?.subCode||t?._subCode||0;return new I({defaultError:{message:i+", reason: "+(t?.phrase||t?.message||"unknown error"),code:n,subCode:r,resultCategories:t?.resultCategories||[]}})}(this.logger,t,e);throw this._sendLobbyAdmitAndRejectUsage(o.message,r,i,Zu.failure,a-n,s,t),o}_sendLobbyAdmitAndRejectUsage(e,t,i,n,r,s,a){n===Zu.failure?this.logger.error(e):this.logger.info(e),this.sendLobbyAdmitAndRejectEvent({eventName:Xu.acs_calling_lobby_events,callId:this._call.id,localParticipantId:this._tsCall.participantId,correlationId:i,kindOfEvent:n,operation:t,isExpected:s??"",timestampInfo:r?{deltaTimeInMs:r}:"",additionalDetails:a?{failureReason:a.message,code:a.code,subCode:a.subCode,...jp(a)}:""})}sendLobbyAdmitAndRejectEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send lobby admit and reject telemetry")}}}function KC(){const e=window.navigator.mediaDevices;if(e?.isRemote){const t=e?.MSRDC_MMR_Shim?.remoteObjectManager?.isConnected;if(!0===t)return"connected";if(!1===t)return"disconnected"}return""}function YC(){const e=window.navigator.mediaDevices,t={isMMREnabled:e?.isRemote??!1};return t.isMMREnabled&&(e?.mmrClientVersion&&(t.mmrClientVersion=e.mmrClientVersion),e?.mmrExtensionVersion&&(t.mmrExtensionVersion=e.mmrExtensionVersion),e?.mmrHostVersion&&(t.mmrHostVersion=e.mmrHostVersion),e?.activityId&&(t.mmrActivityId=e.activityId),e?.connectionId&&(t.mmrConnectionId=e.connectionId),t.mmrRdpState=KC()),t}WC([Of,zC("design:type",Object)],JC.prototype,"logger",void 0),WC([M(Sg.LobbyAdmitParticipant),zC("design:type",Function),zC("design:paramtypes",[Object,Object]),zC("design:returntype",Promise)],JC.prototype,"admit",null),WC([M(Sg.LobbyRejectParticipant),zC("design:type",Function),zC("design:paramtypes",[Object,Object]),zC("design:returntype",Promise)],JC.prototype,"reject",null),WC([M(Sg.LobbyAdmitAll),zC("design:type",Function),zC("design:paramtypes",[Object]),zC("design:returntype",Promise)],JC.prototype,"admitAll",null);class QC{constructor(e){this._lastState="",this._callback=e=>{const t=e?.detail?.state??"";t?t!==this._lastState&&(this._logger.info(`connection state is ${t}`),this._eventEmitter.emit("stateChange",t),this._lastState=t):this._logger.info("connection state is unknown")},this._logger=e.createChild("MmrRdpConnectionManager"),this._eventEmitter=new ep.EventEmitter;const t=window.navigator.mediaDevices;t?.isRemote&&(t?.addEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("listener registered"))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}get state(){return KC()}dispose(){const e=window.navigator.mediaDevices;e?.isRemote&&(e?.removeEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("event listener unregistered")),this._eventEmitter.removeAllListeners()}}var XC=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class ZC extends rS{constructor(e,t,i,n,r,s,a){super(e,t,i,r,s,"RemoteVideoStream"),this._remoteParticipantIdentifier=a,this._isAvailable=!1,this.setIsAvailable=e=>{e!==this._isAvailable&&(this._isAvailable=!!e,this.logger.log(`isAvailable changed to ${this._isAvailable}`),this._eventEmitter.emit("isAvailableChanged",this._isAvailable),this.call.isHandlingLargeMeetingVideoRendering&&this.call.handleDominantSpeakersVideos(),super.sendRemoteVideoStreamTelemetry())};const o=()=>{if("Video"===this.mediaStreamType&&i.isHandlingLargeMeetingVideoRendering){for(const e of i.getTopNDominantSpeakersWithVideoOn())if(this.tsStream.isAvailable&&rl(e.identifier)===rl(this._remoteParticipantIdentifier))return void this.setIsAvailable(!0);this.setIsAvailable(!1)}else this.setIsAvailable(this.tsStream.isAvailable)};this._streamChangedHandler=this.tsStream.changed((()=>{o()})),o()}on(e,t){if("isAvailableChanged"!==e&&"sizeChanged"!==e&&"isReceivingChanged"!==e)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("isAvailableChanged"!==e&&"sizeChanged"!==e&&"isReceivingChanged"!==e)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}get isAvailable(){return this._isAvailable}async getMediaStream(){const e=x(),t=+new Date,i={correlationId:e,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:$g.getMediaStream,mediaType:this.getMediaType(),streamType:Hg.Remote,timestampInfo:{attemptTimestamp:t},kindOfEvent:Zu.attempt,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};this.sendMediaStreamEvent(i);try{if(!this.tsStream.getRawStream)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.GET_RAW_MEDIA_STREAM});if(!this.tsStream.isAvailable)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.RAWMEDIA_LVS_NOT_AVAILABLE});const i=this.tsStream.getRawStream(),n=new Promise((async(e,t)=>{const n=setTimeout((()=>{r.dispose(),t(new I({defaultError:f.REMOTE_VIDEO_STREAM.SUBSCRIBE_MEDIA_STREAM_TIMEOUT}))}),yl().rendering.remoteVideo.getMediaStreamTimeout),r=i.changed((()=>{s()})),s=async()=>{try{const t=await i.getMediaStream();if(!t)return void this.logger.warn("MediaStream is not yet ready.");clearTimeout(n),r.dispose(),e(t)}catch(e){this.logger.warn(`MediaStream is not yet ready, error=${e?.message||"unknown"}`)}};s()})),r=await n,s=r.getVideoTracks()[0];if(!s)throw new I({defaultError:f.REMOTE_VIDEO_STREAM.GET_TRACK});const a=new Promise(((e,t)=>{const i=()=>{s.removeEventListener("unmute",i,!1),e()};s.addEventListener("unmute",i,!1),s.muted?setTimeout((()=>{s.removeEventListener("unmute",i,!1),t(new I({defaultError:f.REMOTE_VIDEO_STREAM.TRACK_UNMUTED_TIMEOUT}))}),yl().rendering.remoteVideo.getMediaStreamTimeout):i()}));await a;const o={correlationId:e,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:$g.getMediaStream,mediaType:this.getMediaType(),streamType:Hg.Remote,timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.success,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};return this.sendMediaStreamEvent(o),r}catch(i){const n={correlationId:e,operation:$g.getMediaStream,mediaType:this.getMediaType(),streamType:Hg.Remote,additionalDetails:{failureReason:i?.message||"",code:i.code||_,...jp(i),remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},timestampInfo:{deltaTimeInMs:+new Date-t},kindOfEvent:Zu.failure,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};throw this.sendMediaStreamEvent(n),new I({defaultError:f.REMOTE_VIDEO_STREAM.GET_MEDIA_STREAM,originalError:i})}}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",rank:this.tsStream.rank,isAvailable:this.tsStream.isAvailable,acsIsAvailable:this._isAvailable,isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this._renderers.map((e=>e.viewId)).join(", "),height:this._size.height,width:this._size.width,isDisposed:this._disposed,optimalVideoCount:this.call?.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:this.call?.activeRemoteVideoStreamViews?.size||0}}dispose(){this.setIsAvailable(!1),super.dispose()}getMediaType(){return"ScreenSharing"===this.mediaStreamType?Bg.ScreenSharingRaw:Bg.VideoRaw}sendMediaStreamEvent(e){this.telemetryLogManager.sendEvent({name:Xu.acs_calling_media_stream,tenant:uc,properties:{timestampInfo:e.timestampInfo,correlationId:e.correlationId,additionalDetails:e.additionalDetails||"",kindOfEvent:e.kindOfEvent||"",mediaType:e.mediaType,streamType:e.streamType,operation:e.operation,localParticipantId:e.localParticipantId||"",callId:e.callId||""}})}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([M(Rg.GetMediaStream),XC("design:type",Function),XC("design:paramtypes",[]),XC("design:returntype",Promise)],ZC.prototype,"getMediaStream",null);var e_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},t_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let i_=1;class n_{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}get viewId(){return this._viewId}get size(){return{height:this._size.height,width:this._size.width}}constructor(e,t,i,n,r,s){this._target=e,this._viewId=t,this._videoStream=i,this._onDisposedCallback=r,this._eventEmitter=new ep.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!1,this._size={height:0,width:0},this._disposed=!1,this._handleTsRendererChanged=e=>{if(this.logger.debug(`rendering state is ${this._isRendering}, changed to ${this._tsRenderer?.isRendering}`),this._tsRenderer)if(this._tsRenderer.isRendering!==this._isRendering&&(this._isRendering=this._tsRenderer.isRendering,this._videoStream.updateIsReceiving(),this._isRendering&&this._renderingDeferred&&this._renderingDeferred.isPending()&&this._renderingDeferred.resolve(),e.log(`isRendering change to ${this._isRendering}`)),this._tsRenderer.isRendering){const e=this._tsRenderer.streamSize.height,t=this._tsRenderer.streamSize.width;e===this._size.height&&t===this._size.width||(this._size.height=e,this._size.width=t,this._videoStream.updateSize())}else this._size.height=0,this._size.width=0,this._videoStream.updateSize();this.sendRendererTelemetry()},this.sendRendererTelemetry=()=>{if(this._tsRenderer)try{const e={isRendering:this._tsRenderer.isRendering,streamWidth:this._tsRenderer.streamSize.width,streamHeight:this._tsRenderer.streamSize.height,isVideoAttached:this._target.isConnected,rendererWidth:this._target?.offsetWidth,rendererHeight:this._target?.offsetHeight};if(this.previousStats){if(function(e,t){const i=Object.keys(e);for(let n of i)if(e[n]!==t[n])return!1;return!0}(this.previousStats,e))return}else this.previousStats=e;this.previousStats=e;const t=this._videoStream.getStreamMetadata(),{callId:i,localParticipantId:n,isDisposed:r,viewIdsRegistered:s,height:a,width:o,...c}=t,l={...e,...c,viewId:this._viewId,disposed:this._disposed};this._videoStream.call.stats.recordEvent({name:Qu.remote_view,callId:i,localParticipantId:n,data:l})}catch(e){}},this._unsubscribeAvailabilityCallback=()=>{this._availableCallback&&("RemoteVideoStream"===this._videoStream.kind&&this._videoStream?.off("isAvailableChanged",this._availableCallback),this._availableCallback=void 0)},this._disposeTsRendererChangedObservable=()=>{this._tsRendererChanged&&(this._tsRendererChanged.dispose(),this._tsRendererChanged=void 0)},this._attemptToDisposeTsRenderer=()=>{if(this._tsRenderer){this.logger.debug("disposing underlying remote renderer");try{this._tsRenderer?.dispose(),this._tsRenderer=void 0}catch(e){throw this.logger.warn(`underlying remote renderer dispose failed with ${e?.message} error`),new I({defaultError:f.VIEW.REMOTE_RENDERER_DISPOSE_FAIL})}}},this.logger=n.createChild("RemoteStreamRenderer"+i_++),this.logger.log("created"),void 0!==s?.scalingMode&&(this._scalingMode=s.scalingMode),void 0!==s?.isMirrored&&(this._isMirrored=s.isMirrored),this._remoteStreamTelemetryEventSender=new Ff(this._videoStream.telemetryLogManager)}async start(){const e=x(),t=+new Date,i=this.logger.createFnLogger(wg.Start),n={timestampInfo:{attemptTimestamp:t},correlationId:e,operation:$g.render,kindOfEvent:Zu.attempt,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Remote};if(this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(n),this._disposed)throw this.logger.warn("already disposed"),new I({defaultError:f.VIEW.START_ALREADY_DISPOSED});try{i.info(`scalingMode=${Tl(this._scalingMode)}`),this._videoStream.registerRenderer(this),this._renderingDeferred=Nu(),this._renderingDeferred.promise.catch(kl),"RemoteVideoStream"===this._videoStream.kind&&(this._availableCallback=()=>{this._videoStream.isAvailable||(i.warn("stream isAvailable changed to false, attempting to reject operation"),this._renderingDeferred?.isPending()&&!this._disposed&&this._renderingDeferred?.reject(new I({defaultError:f.VIEW.STREAM_BECAME_UNAVAILABLE})))},this._videoStream.on("isAvailableChanged",this._availableCallback)),this._videoStream.tsStream.start(this._target,{scalingMode:Tl(this._scalingMode),transparent:!1}).then((e=>{if(this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._tsRenderer=e,this.logger.info("subscribed to video, waiting for the first frame"),this._disposed)throw this.logger.warn("already disposed, dispose underlying renderer"),this._attemptToDisposeTsRenderer(),new I({defaultError:f.VIEW.START_ALREADY_DISPOSED});this.logger.info(`current state of rendering is ${this._tsRenderer.isRendering}`),this.sendRendererTelemetry(),-1!==yl().rendering.remoteVideo.createViewTimeout&&setTimeout((()=>{if(this._renderingDeferred?.isPending())try{this._renderingDeferred.reject(new I({defaultError:f.VIEW.TIMEOUT}))}catch(e){}}),yl().rendering.remoteVideo.createViewTimeout),this._tsRendererChanged=this._tsRenderer.changed((()=>this._handleTsRendererChanged(i))),this._tsRenderer.isRendering&&this._renderingDeferred?.isPending()&&(this._isRendering=!0,this._videoStream.updateIsReceiving(),this._size.width=e.streamSize.width,this._size.height=e.streamSize.height,this._videoStream.updateSize(),this._renderingDeferred.resolve())})).catch((e=>{if(this.logger.info("Failed to subscribe to video"),this._renderingDeferred?.isPending()){const t=new I({defaultError:f.VIEW.SUBSCRIBE,originalError:e});this._renderingDeferred.reject(t)}})),await this._renderingDeferred.promise,this._videoStream.flushIsReceiving(),this._unsubscribeAvailabilityCallback(),yl().rendering.remoteVideo.forceCheckIfVideoWasAttachedToDom&&this._checkIfVideoWasAttachedToDom();const n={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:e,operation:$g.render,kindOfEvent:Zu.success,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Remote};return this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(n),this}catch(i){this.logger.warn(`Failed to render, message=${i}`);try{this.dispose()}catch(e){this.logger.warn(`dispose failed with ${e?.message} error`)}const n=new I({defaultError:f.VIEW.START,originalError:i});if(n.message!==f.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&n.message!==f.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const i={timestampInfo:{deltaTimeInMs:+new Date-t},correlationId:e,operation:$g.render,additionalDetails:{failureReason:n.message,code:C,...jp(n)},kindOfEvent:Zu.failure,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Remote};this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(i)}throw n}}async setScalingMode(e){if(!this._tsRenderer)throw new I({defaultError:f.VIEW.SCALING_MODE});await this._tsRenderer.setScalingMode(Tl(e)),this._scalingMode=e}dispose(e=qg.Public_App){if(this._disposed)throw new I({defaultError:f.VIEW.RENDERER_DISPOSE_ALREADY_DISPOSED});if(this._disposed=!0,this._disposeTsRendererChangedObservable(),this._unsubscribeAvailabilityCallback(),this._attemptToDisposeTsRenderer(),this._renderingDeferred?.isPending()){let t;switch(e){case qg.Internal_LargeMeetingVideoRendering:t=f.VIEW.LARGE_MEETING_VIEW_DISPOSED;break;case qg.Internal_RemoteVideoStreamDisposed:t=f.VIEW.REMOTE_VIDEO_STREAM_DISPOSED;break;default:t=f.VIEW.APP_VIEW_DISPOSED}this._renderingDeferred.reject(new I({defaultError:t}))}this._target&&this._target.remove();try{e!==qg.Public_App&&this._onDisposedCallback(e)}catch(e){this.logger.debug(`dispose callback failed with ${e?.message} error`)}this._videoStream.unregisterRenderer(this),this._size.height=0,this._size.width=0,this._videoStream.updateSize(),this._isRendering=!1,this._videoStream.updateIsReceiving(),this._eventEmitter.removeAllListeners(),this._renderingDeferred=void 0}_checkIfVideoWasAttachedToDom(){if(yl().rendering.remoteVideo.checkIfVideoAttachedToDom_poll){let e=yl().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalMaxTries;const t=()=>{this._target.isConnected||e<=0?this.sendRendererTelemetry():(e--,e>=0&&setTimeout((()=>t),yl().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalTime))};t()}else setTimeout((()=>{this._target.isConnected&&this.sendRendererTelemetry()}),yl().rendering.remoteVideo.checkIfVideoAttachedToDom_timeout)}}e_([Of,t_("design:type",Object)],n_.prototype,"logger",void 0),e_([M(wg.Start),t_("design:type",Function),t_("design:paramtypes",[]),t_("design:returntype",Promise)],n_.prototype,"start",null),e_([P(wg.Dispose),t_("design:type",Function),t_("design:paramtypes",[String]),t_("design:returntype",void 0)],n_.prototype,"dispose",null);var r_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},s_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class a_{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}constructor(e,t,i,n,r){this._target=e,this._videoStream=t,this._onDisposed=n,this._eventEmitter=new ep.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!0,this._disposed=!1,this.logger=i.createChild("LocalStreamRenderer"),this.logger.log("created"),void 0!==r?.scalingMode&&(this._scalingMode=r.scalingMode),void 0!==r?.isMirrored?this._isMirrored=r.isMirrored:"ScreenSharing"===this._videoStream.mediaStreamType&&(this._isMirrored=!1),this._localStreamTelemetryEventSender=new Ff(this._videoStream.telemetryLogManager)}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}async start(){const e=x(),t=this.logger.createFnLogger(wg.Start),i=+new Date,n={timestampInfo:{attemptTimestamp:i},correlationId:e,operation:$g.render,kindOfEvent:Zu.attempt,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(n);try{if(t.info("attempting to select new device as a source"),this._videoStream.source instanceof Df&&"Video"===this._videoStream.mediaStreamType){const e=this._videoStream.source.deviceManager.getTsDeviceManager();e.selectDevices({camera:this._videoStream.source.id}),t.info("device selected"),t.info("creating preview"),this._tsRenderer=await e.createPreview(this._target,{kind:"camera"},{scalingMode:Tl(this._scalingMode),transparent:!1,ignoreMirroring:!1,disposeRendererWhenStreamisNotAvailable:()=>!0})}else{if("RawMedia"!==this._videoStream.mediaStreamType&&"ScreenSharing"!==this._videoStream.mediaStreamType)throw new I({defaultError:f.VIEW.UNKNOWN_STREAM_TYPE});{const e=document.createElement("video");e.srcObject=await this._videoStream.getMediaStream(),e.play(),this._target.appendChild(e)}}this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._videoStream.registerRenderer(this);const n={timestampInfo:{deltaTimeInMs:+new Date-i},correlationId:e,operation:$g.render,kindOfEvent:Zu.success,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Local};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(n),this}catch(n){this.dispose();const t=$p(0,n),r={timestampInfo:{deltaTimeInMs:+new Date-i},correlationId:e,operation:$g.render,additionalDetails:{failureReason:t.message,code:t.code,subCode:t.subCode,...jp(t)},kindOfEvent:Zu.failure,mediaType:this._videoStream.mediaStreamType,streamType:Hg.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(r),t}}setScalingMode(e){if(!this._tsRenderer)throw new I({defaultError:f.VIEW.SCALING_MODE});this._tsRenderer.setScalingMode(Tl(e)),this._scalingMode=e}setSourceObject(e){this.disposeScreenSharingMediaStream();const t=this._target.querySelector("video");t&&(t.srcObject=e,t.play())}dispose(){if(!this._disposed){if(this._tsRenderer)try{this.logger.log("disposing underlying local renderer"),this._tsRenderer.dispose(),this._tsRenderer=void 0}catch(e){throw this.logger.warn(`underlying local renderer dispose failed with ${e?.message} error`),new I({defaultError:f.VIEW.LOCAL_RENDERER_DISPOSE_FAIL})}this.disposeScreenSharingMediaStream(),this._target.remove(),this._onDisposed&&this._onDisposed(this),this._eventEmitter.removeAllListeners(),this._disposed=!0}}disposeScreenSharingMediaStream(){if(this._videoStream.getCall()?.localScreenSharingStream){const e=this._target.querySelector("video"),t=e?.srcObject;t&&(t.getVideoTracks().forEach((e=>{e.stop()})),e.srcObject=null,this.logger.info("disposed of ScreenSharing MediaStream"))}}}r_([Of,s_("design:type",Object)],a_.prototype,"logger",void 0),r_([M(Pg.Start),s_("design:type",Function),s_("design:paramtypes",[]),s_("design:returntype",Promise)],a_.prototype,"start",null),r_([P(Pg.SetScalingMode),s_("design:type",Function),s_("design:paramtypes",[String]),s_("design:returntype",void 0)],a_.prototype,"setScalingMode",null),r_([P(Pg.SetSourceObject),s_("design:type",Function),s_("design:paramtypes",[MediaStream]),s_("design:returntype",void 0)],a_.prototype,"setSourceObject",null),r_([P(Pg.Dispose),s_("design:type",Function),s_("design:paramtypes",[]),s_("design:returntype",void 0)],a_.prototype,"dispose",null);var o_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},c_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let l_=1;class d_{get scalingMode(){return this._streamRenderer.scalingMode}get isMirrored(){return this._streamRenderer.isMirrored}get disposed(){return this._disposed}constructor(e,t,i,n){if(this._videoStream=e,this._viewId=i,this._options=n,this._disposed=!1,this._deleteActiveRemoteVideoStreamView=(e,t)=>{if(e.call.activeRemoteVideoStreamViews?.has(e.id)){let i=e.call.activeRemoteVideoStreamViews?.get(e.id);i?.delete(t),0==i?.size&&e.call.activeRemoteVideoStreamViews?.delete(e.id)}},this.logger=t.createChild("VideoStreamRendererView"+l_++),this.target=document.createElement("div"),this.target.style.width="100%",this.target.style.height="100%",this._videoStream instanceof rS)this._streamRenderer=new n_(this.target,this._viewId,this._videoStream,this.logger,(e=>{this._disposed||this.dispose(e)}),this._options);else{if(!(this._videoStream instanceof $f))throw new I({defaultError:f.VIEW.VIEW_WRONG_STREAM_TYPE});this._streamRenderer=new a_(this.target,this._videoStream,this.logger,(()=>this.dispose),this._options)}this._telemetryLogManager=this._videoStream.telemetryLogManager,this.logger.info("created")}async render(){const e=this.logger.createFnLogger(this._videoStream instanceof rS?Eg.RenderRemoteStream:Eg.RenderLocalStream);if(this._disposed)throw e.log("failed, stream disposed!"),new I({defaultError:f.VIEW.RENDER_FAIL_STREAM_DISPOSED});try{await this._streamRenderer.start()}catch(t){e.error("failed");try{this.dispose()}catch(e){this.logger.warn(`Failed to dispose, message=${e.message}`)}throw t}}async updateScalingMode(e){if(this._disposed)throw new I({defaultError:f.VIEW.SCALING_MODE_DISPOSED});if("Crop"!==e&&"Fit"!==e&&"Stretch"!==e)throw new I({defaultError:f.VIEW.SCALING_MODE_WRONG_VAL});try{await this._streamRenderer.setScalingMode(e)}catch(e){throw new I({defaultError:f.VIEW.SCALING_MODE,originalError:e})}}dispose(e=qg.Public_App){if(this._disposed)throw new I({defaultError:f.VIEW.VIEW_ALREADY_DISPOSED});this._disposed=!0;const t=+new Date,i=x();try{e===qg.Public_App&&this.sendDisposeViewEvent({eventName:Xu.acs_calling_dispose_view_attempt,correlationId:i,timestampInfo:{attemptTimestamp:t}}),this._videoStream instanceof ZC&&this._deleteActiveRemoteVideoStreamView(this._videoStream,this._viewId),this.logger.debug("attempt to dispose stream renderer"),this._streamRenderer.dispose(e),this.target?.remove();const n=+new Date;e===qg.Public_App&&this.sendDisposeViewEvent({eventName:Xu.acs_calling_dispose_view_success,correlationId:i,timestampInfo:{deltaTimeInMs:n-t}})}catch(n){const r=new I({defaultError:f.VIEW.DISPOSE_FAIL,originalError:n});if(e===qg.Public_App){const e=+new Date;this.sendDisposeViewEvent({eventName:Xu.acs_calling_dispose_view_failure,correlationId:i,timestampInfo:{deltaTimeInMS:e-t}},r)}throw r}}sendDisposeViewEvent(e,t){try{let i,n;t&&(i="string"==typeof t?.message?t?.message:"",n={...jp(t)}),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{...this._videoStream.getStreamMetadata(),viewId:this._viewId,correlationId:e.correlationId,timestampInfo:e.timestampInfo,failureReason:i,additionalDetails:n}})}catch(e){this.logger.debug("Unable to send telemtery")}}}o_([Of,c_("design:type",Object)],d_.prototype,"logger",void 0),o_([M(Eg.Render),c_("design:type",Function),c_("design:paramtypes",[]),c_("design:returntype",Promise)],d_.prototype,"render",null),o_([M(Eg.UpdateScalingMode),c_("design:type",Function),c_("design:paramtypes",[String]),c_("design:returntype",Promise)],d_.prototype,"updateScalingMode",null),o_([P(Eg.Dispose),c_("design:type",Function),c_("design:paramtypes",[String]),c_("design:returntype",void 0)],d_.prototype,"dispose",null);class h_{get createViewStats(){return this._createViewStats}get initialCreateViewStats(){return this._initialCreateViewStats}constructor(e,t,i,n,r){this._statsCollector=e,this._streamId=t,this._logger=i,this._call=n,this._attemptTimestamp=r,this._createViewFailureStats={},this._createViewStats={},this._initialCreateViewStats={},this._statsCollector.on("sampleReported",(e=>{!function(e,t,i,n){const r=yl()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength,s=yl()?.rendering.remoteVideo.createViewSendMediaStatsInitialMaxLength,a=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","healedRatio","lossRate"],o=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","frameRateDecoded","frameRateReceived","frameWidthReceived","frameHeightReceived","longestFreezeDurationInMs","totalFreezeDurationInMs","framesReceived","framesDropped","framesDecoded","keyFramesDecoded"],c=o;if(i.audio.receive.length>0){const n=i.audio.receive[0];e.audio=e.audio??{},t.audio=t.audio??{},a.forEach((i=>{const a=i;if(void 0!==n[a]&&e.audio){const t=n[a];if(void 0===e.audio[a])e.audio[a]=[t];else{const i=e.audio[a]?.length;i>=r&&e.audio[a]?.shift(),e.audio[a]?.push(t)}}if(void 0!==n[a]&&t.audio){const e=n[a];if(void 0===t.audio[a])t.audio[a]=[e];else{const i=t.audio[a]?.length;i<s&&t.audio[a]?.push(e)}}}))}if(i.video.receive.length>0){const a=i.video.receive.find((e=>e.streamId===n));void 0!==a&&(e.video=e.video??{},t.video=t.video??{},o.forEach((i=>{const n=i;if(void 0!==a[n]&&e.video){const t=a[n];if(void 0===e.video[n])e.video[n]=[t];else{const i=e.video[n]?.length;i>=r&&e.video[n]?.shift(),e.video[n]?.push(t)}}if(void 0!==a[n]&&t.video){const e=a[n];if(void 0===t.video[n])t.video[n]=[e];else{const i=t.video[n]?.length;i<s&&t.video[n]?.push(e)}}})))}if(i.screenShare.receive.length>0){const a=i.screenShare.receive.find((e=>e.streamId===n));void 0!==a&&(e.screenShare=e.screenShare??{},t.screenShare=t.screenShare??{},c.forEach((i=>{const n=i;if(void 0!==a[n]&&e.screenShare){const t=a[n];if(void 0===e.screenShare[n])e.screenShare[n]=[t];else{const i=e.screenShare[n]?.length;i>=r&&e.screenShare[n]?.shift(),e.screenShare[n]?.push(t)}}if(void 0!==a[n]&&t.screenShare){const e=a[n];if(void 0===t.screenShare[n])t.screenShare[n]=[e];else{const i=t.screenShare[n]?.length;i<s&&t.screenShare[n]?.push(e)}}})))}}(this.createViewStats,this.initialCreateViewStats,e,this._streamId)}))}getCreateViewFailureStats(){try{let e=0,t=NaN;void 0!==this.createViewStats.video?.framesDropped&&void 0!==this.initialCreateViewStats.video?.framesDropped&&(e=this.createViewStats.video?.framesDropped.length,t=this.createViewStats.video?.framesDropped[e-1]-this.initialCreateViewStats.video?.framesDropped[0]);let i=NaN,n=NaN;void 0!==this.createViewStats.video?.framesReceived&&void 0!==this.initialCreateViewStats.video?.framesReceived&&(e=this.createViewStats.video.framesReceived.length,i=this.createViewStats.video.framesReceived[e-1]-this.initialCreateViewStats.video?.framesReceived[0],e=this.initialCreateViewStats.video.framesReceived.length,n=this.initialCreateViewStats.video.framesReceived[0]);let r=NaN;void 0!==this.createViewStats.video?.framesDecoded&&void 0!==this.initialCreateViewStats.video?.framesDecoded&&(e=this.createViewStats.video.framesDecoded.length,r=this.createViewStats.video.framesDecoded[e-1]-this.initialCreateViewStats.video?.framesDecoded[0]);let s=NaN;void 0!==this.createViewStats.video?.keyFramesDecoded&&void 0!==this.initialCreateViewStats.video?.keyFramesDecoded&&(e=this.createViewStats.video.keyFramesDecoded.length,s=this.createViewStats.video.keyFramesDecoded[e-1]-this.initialCreateViewStats.video?.keyFramesDecoded[0]);let a=0;!isNaN(t)&&!isNaN(i)&&i>0&&(a=Number((t/i*100).toFixed(7)));let o=!1;i>0&&0===r&&(o=!0);let c=!1;isNaN(r)||isNaN(s)||r!==s||(c=!0);const l=[],d=this._call.networkQualityUfdEventDetails,h=yl().rendering.remoteVideo.createViewFailureNetworkUfdCheckWindowInMs;d.forEach((e=>{Math.abs(e.timestampInfo-this._attemptTimestamp)<=h&&l.push(e)}));let u=!1;isNaN(i)||isNaN(n)||i!==n||(u=!0),this._createViewFailureStats.video={framesDroppedPercentage:a,framesReceivedButNothingDecoded:o,onlyKeyFramesDecoded:c,networkQualityEventsDuringAttempt:l,zeroFramesReceived:u}}catch(e){this._logger.debug("Error calculating create view failure stats!")}return this._createViewFailureStats}}class u_{constructor(e,t){this._liveStreamStatsCollector=e,this._streamId=t,this._liveStreamStats={},this._initialLiveStreamStats={};const i=yl()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength;this._liveStreamStatsCollector.on("sampleReported",(e=>{(function(e,t,i,n){const r=t[i.toString()];void 0!==r&&["audioBitrate","videoBitrate","downloadBitrate","bufferLengthInMs","videoHeight","videoWidth","currentPlayPosition"].forEach((t=>{const i=t,s=t;if(void 0!==r[i]){const t=r[i];if(void 0===e[s])e[s]=[t];else{const i=e[s]?.length;i>=n&&e[s]?.shift(),e[s]?.push(t)}}}))})(this._liveStreamStats,e,this._streamId,i),p.isEmpty(this._initialLiveStreamStats)&&(this._initialLiveStreamStats=this._liveStreamStats)}))}get initialCreateViewLiveStreamStats(){return this._initialLiveStreamStats}get createViewLiveStreamStats(){return this._liveStreamStats}}var g_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},p_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class m_{get _createViewStats(){return"RemoteVideoStream"!==this._videoStream.kind&&"ComposedVideoStream"!==this._videoStream.kind||!this._createViewTelemetryHelper?"LiveVideoStream"===this._videoStream.kind&&this._createViewLiveStreamTelemetryHelper?this._createViewLiveStreamTelemetryHelper.createViewLiveStreamStats:{}:this._createViewTelemetryHelper.createViewStats}constructor(e){if(this.size={height:0,width:0},this.views=new Map,this.disposed=!1,this._attemptToDisposeView=e=>{try{e?.dispose()}catch(e){this.logger.warn(e?.message||"Failed to dispose, unknown error")}},this._addActiveRemoteVideoStreamView=(e,t,i)=>{if(e.call.activeRemoteVideoStreamViews?.has(e.id)){let n=e.call.activeRemoteVideoStreamViews?.get(e.id);n&&n.set(t,i)}else{let n=new Map;n.set(t,i),e.call.activeRemoteVideoStreamViews?.set(e.id,n)}},!(e instanceof $f||e instanceof rS||e instanceof ZC))throw new I({defaultError:f.VIEW.RENDERER_WRONG_STREAM_TYPE});const i=t.createClientLogger("ACS");this._videoStream=e,this._telemetryLogManager=e.telemetryLogManager,this.logger=new Uf(i,e instanceof $f?[()=>`VideoStreamRenderer:LocalVideoStream:${g.pii.Omit(e?.source?.id)}`]:[()=>`VideoStreamRenderer:${e.kind}:${e?.id}`]),this.logger.info("created")}async createView(e){if(this.disposed)throw new I({defaultError:f.VIEW.RENDERER_DISPOSED});const t=+new Date,i=x(),n=x();let r,s;try{if(this.sendCreateViewEvent({eventName:Xu.acs_calling_create_view_attempt,viewId:i,correlationId:n,timestampInfo:{attemptTimestamp:t}}),"RemoteVideoStream"===this._videoStream.kind&&!this._videoStream.isAvailable){const e=new I({defaultError:f.VIEW.ISAVAILABLE_FALSE}),r=+new Date;throw this.sendCreateViewEvent({eventName:Xu.acs_calling_create_view_failure,viewId:i,correlationId:n,timestampInfo:{deltaTimeInMs:r-t}},e),e}if("RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&yl()?.calling.applyViewLimit&&Cl()?.numVideoChannelsGvc){const e=Cl().numVideoChannelsGvc,r=this._videoStream;if(!r.call.activeRemoteVideoStreamViews?.has(r.id)&&r.call.activeRemoteVideoStreamViews?.size>=e){const r=new I({defaultError:f.VIEW.MAX_NUM_OF_VIEWS_REACHED,defaultErrorMessageArgs:[e]}),s=+new Date;throw this.sendCreateViewEvent({eventName:Xu.acs_calling_create_view_failure,viewId:i,correlationId:n,timestampInfo:{deltaTimeInMs:s-t}},r),r}}if(yl()?.rendering.remoteVideo.createViewSendMediaStats)if("RemoteVideoStream"===this._videoStream.kind||"ComposedVideoStream"===this._videoStream.kind){const e=this._videoStream,i=e.call;s=e.call.feature(TC.MediaStats).createCollector();const n=e.id;this._createViewTelemetryHelper=new h_(s,n,this.logger,i,t)}else if("LiveVideoStream"===this._videoStream.kind){const e=this._videoStream;s=e.call.feature(TC.LiveStream).createStatsCollector();const t=e.id;this._createViewLiveStreamTelemetryHelper=new u_(s,t)}r=new d_(this._videoStream,this.logger,i,e),this.views.set(i,r),await r.render(),"RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&this._addActiveRemoteVideoStreamView(this._videoStream,i,r);const a=+new Date;return this.sendCreateViewEvent({eventName:Xu.acs_calling_create_view_success,viewId:i,correlationId:n,timestampInfo:{deltaTimeInMs:a-t}}),s?.dispose(),r}catch(e){const a=new I({defaultError:f.VIEW.CREATE_VIEW_FAILED,originalError:e});if(this.views.delete(i),this._attemptToDisposeView(r),s?.dispose(),a.message!==f.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&a.message!==f.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const e=+new Date;this.sendCreateViewEvent({eventName:Xu.acs_calling_create_view_failure,viewId:i,correlationId:n,timestampInfo:{deltaTimeInMs:e-t}},a)}throw a}}async sendCreateViewEvent(e,t){try{let i={},n={},r={};if(yl()?.rendering.remoteVideo.createViewSendMediaStats&&(e.eventName===Xu.acs_calling_create_view_failure||e.eventName===Xu.acs_calling_create_view_success)){if("RemoteVideoStream"===this._videoStream.kind){const e=this._videoStream.call,t=e.tsCall.getMediaSessionStats();i={videoSubscriptionEvents:t?.extensions?.Video_SubscriptionEvents,screenSharingSubscriptionEvents:t?.extensions?.Sharing_SubscriptionEvents,videoSendMaxCapabilities:t?.extensions?.Video_send_MaxCapabilities,screenSharingSendMaxCapabilities:t?.extensions?.Sharing_send_MaxCapabilities,iceConnectedStateTime:t?.metrics?.IceConnectedStateTime,relayCandidate:t?.extensions?.RelayCandidate,videoRecvTimeToFirstFrame:t?.extensions?.Video_recv_TimeToFirstFrame,screenSharingRecvTimeToFirstFrame:t?.extensions?.Sharing_recv_TimeToFirstFrame,optimalVideoCount:e.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:e.activeRemoteVideoStreamViews?.size||0}}e.eventName===Xu.acs_calling_create_view_failure&&(r=this._createViewTelemetryHelper?.getCreateViewFailureStats()??{},n=this._createViewStats)}i.visibilityState=document.visibilityState;let s="",a={};t&&(s="string"==typeof t?.message?t?.message:"",a={...jp(t)}),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{viewId:e.viewId,correlationId:e.correlationId,timestampInfo:e.timestampInfo,...this._videoStream.getStreamMetadata(),failureReason:s,additionalProperties:i,additionalDetails:a,stats:n,createViewFailureDebugStats:r,videoStreamKind:this._videoStream.kind}})}catch(e){this.logger.debug("Unable to send telemtery")}}dispose(){if(this.disposed)throw new I({defaultError:f.VIEW.RENDERER_ALREADY_DISPOSED});this.disposed=!0,this.views.forEach(this._attemptToDisposeView),this.views.clear()}}g_([Of,p_("design:type",Object)],m_.prototype,"logger",void 0),g_([M(Tg.CreateView),p_("design:type",Function),p_("design:paramtypes",[Object]),p_("design:returntype",Promise)],m_.prototype,"createView",null),g_([P(Tg.Dispose),p_("design:type",Function),p_("design:paramtypes",[]),p_("design:returntype",void 0)],m_.prototype,"dispose",null);var f_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},S_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class v_{get identifier(){return this._identifier}get endpointDetails(){return this._tsParticipant?.endpoints?.endpointDetails.map((e=>({participantId:e.participantId})))||[]}get state(){return this._state}get videoStreams(){return[...this._mappedStreams.values()]}get isMuted(){return this._isMuted}get isSpeaking(){return this._isSpeaking}get callEndReason(){return this._callEndReason}get displayName(){return this._displayName}get role(){return this._role}constructor(e,t,i,n,r){this._mappedStreams=new Map,this._state="Idle",this._lastTsParticipantState=0,this._isMuted=!1,this._isSpeaking=!1,this._displayName="",this._role="Unknown",this.acsToTsStreamType=e=>"Video"===e?0:"ScreenSharing"===e?1:void 0,this._identifier=e,this.logger=t.createChild((()=>`RemoteParticipant{${this._identifier.kind}}`)),this._telemetryLogManager=r,this._eventEmitter=new Nm(this.logger),this._callAgent=n,this._call=i,this.logger.log("created"),this._renderers={Video:{renderingState:{}},ScreenSharing:{renderingState:{}}}}on(e,t){if("stateChanged"!==e&&"isMutedChanged"!==e&&"isSpeakingChanged"!==e&&"displayNameChanged"!==e&&"roleChanged"!==e&&"videoStreamsUpdated"!==e)throw new I({defaultError:f.REMOTE_PARTICIPANT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("stateChanged"!==e&&"isMutedChanged"!==e&&"isSpeakingChanged"!==e&&"displayNameChanged"!==e&&"roleChanged"!==e&&"videoStreamsUpdated"!==e)throw new I({defaultError:f.REMOTE_PARTICIPANT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}async mute(){if(!yl().calling.enableMuteOthers)throw new I({defaultError:f.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_DISABLED});const e=this.logger.createFnLogger(vg.Mute),t=+new Date,i=x();this.sendAudioEvent({eventName:Xu.acs_calling_mute_attempt,eventType:tg.MuteSpecificParticipant,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{e.info("remote mute specific");var n=[];void 0!==this._tsParticipant&&(n=n.concat(this._tsParticipant)),await this._call.tsCall.muteParticipants(1,n),e.info("remote mute specific success");const r=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_mute_success,eventType:tg.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:r-t},correlationId:i,step:"mid-call"})}catch(n){const r=new I({defaultError:f.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_FAILED,originalError:n});e.error(r.message);const s=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_mute_failure,eventType:tg.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call"},r),r}}_dispose(){this.logger.log("dispose"),this._participantChangedHandler&&this._participantChangedHandler.dispose(),this._mappedStreams.forEach((e=>e.dispose())),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners(),this._disposeVideo(0),this._disposeVideo(1)}get tsRemoteParticipant(){return this._tsParticipant}get kind(){return"RemoteParticipant"}setCallEndReason(e){this._callEndReason=e}observeParticipant(e){this._tsParticipant||(this._tsParticipant=e,this._displayName=e.displayName,this._isMuted=e.isServerMuted,this._participantChangedHandler=this._tsParticipant.changed((()=>{if(this._tsParticipant&&this._tsParticipant.state!==this._lastTsParticipantState&&(this._lastTsParticipantState=this._tsParticipant.state,this._mapTsParticipantState(this._tsParticipant.state)),this._mapStreams(),this._tsParticipant&&this._tsParticipant.isServerMuted!==this._isMuted&&(this._isMuted=this._tsParticipant.isServerMuted,this._eventEmitter.emit("isMutedChanged")),this._tsParticipant&&this._tsParticipant.displayName!==this._displayName&&(this._displayName=e.displayName,this._eventEmitter.emit("displayNameChanged")),this._tsParticipant&&this._tsParticipant.advancedMeetingRole!==this._lastTsParticipantAdvancedRole&&(this._lastTsParticipantAdvancedRole=e.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole)),this._tsParticipant){const e=0!==this._tsParticipant.voiceLevel;e!==this._isSpeaking&&(this._isSpeaking=e,this._eventEmitter.emit("isSpeakingChanged"))}})),this._mapTsParticipantState(this._tsParticipant.state),this._mapStreams(),this._lastTsParticipantAdvancedRole=this._tsParticipant.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole))}setParticipantState(e){e!==this._state&&(this.logger.log(`state changed ${this._state}=>${this.state}`),this._state=e,"Disconnected"==this._state?this._dispose():this._eventEmitter.emit("stateChanged",this._state))}async stopRenderingVideo(){this._disposeVideo(0)}async renderVideo(e,t){return"function"==typeof e?this._updateRenderingState(e,"Video",t):await this._renderStreamForParticipant(e,0,t)}async _updateRenderingState(e,t,i){if("function"==typeof e){let n;const r="Video"===t?0:1;this._tsParticipant&&(n=i?.stream?i.stream:new ZC(this._tsParticipant.streams[r][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier),n.on("isReceivingChanged",(()=>{this._renderers[t].renderingState.isFrozen=!n.isReceiving,e(this._renderers[t].renderingState)})),n.on("isAvailableChanged",(async()=>{this._renderers[t].renderingState.isStreaming!==n?.isAvailable&&(this._renderers[t].renderingState.isStreaming=n.isAvailable,this._renderers[t].renderingState.isStreaming&&!this._renderers[t].renderer&&(this._renderers[t].renderer=this._renderers[t]?.renderer?this._renderers[t].renderer:new m_(n),this._renderers[t].view||(this._renderers[t].view=await(this._renderers[t].renderer?.createView(i?.viewOptions))),this._renderers[t].renderingState.videoTarget=this._renderers[t].view?.target)),e(this._renderers[t].renderingState)})))}}async renderScreenShare(e,t){return"function"==typeof e?this._updateRenderingState(e,"ScreenSharing",t):this._renderStreamForParticipant(e,1,t)}async _renderStreamForParticipant(e,t,i){if(this._tsParticipant){const n=0===t?"Video":"ScreenSharing",r=i?.stream?i.stream:new ZC(this._tsParticipant.streams[t][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);return r.isAvailable&&(this._renderers[n].view=await this._appendVideo(e,t,r,i?.viewOptions)),r.on("isAvailableChanged",(async()=>{r.isAvailable?this._renderers[n].view=await this._appendVideo(e,t,r,i?.viewOptions):this._renderers[n]?.view&&this._renderers[n].view?.target&&this._renderers[n].view?.target.parentNode?.removeChild(this._renderers[n].view?.target)})),Promise.resolve({stream:r,view:this._renderers[n]?.view})}return Promise.reject()}async _appendVideo(e,t,i,n){try{const r=0===t?"Video":"ScreenSharing";if(0===t&&(this._renderers[r]?.renderer||(this._renderers[r].renderer=this._renderers[r]?.renderer?this._renderers[r].renderer:new m_(i),this._renderers[r].view=await(this._renderers[r].renderer?.createView(n))),this._renderers[r].view))return e.appendChild(this._renderers[r].view?.target||document.createElement("emptyNode")),Promise.resolve(this._renderers[r].view)}catch(e){return Promise.reject(e)}return Promise.reject()}async _disposeVideo(e){const t=0===e?"Video":"ScreenSharing";this._renderers[t].view?.dispose(),this._renderers[t].renderer?.dispose(),this._renderers[t]={renderingState:{}}}_setParticipantRole(e){let t=Hl(yl(),e);"Unknown"===t?this.logger.log(`tsParticipant advancedMeetingRole=${e} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${e}=>${t}`),this._role!=t&&(this.logger.log(`role changed ${this._role}=>${e}`),this._role=t,this._eventEmitter.emit("roleChanged"))}_mapTsParticipantState(e){let t;const i={0:"Idle",1:"Connecting",2:"Ringing",3:"Connected",4:"Disconnected",5:"Hold",7:"InLobby",6:"EarlyMedia"};i[e]?(t=i[e],this.logger.log(`mapped tsParticipant ${e}=>${this._state}`),this.setParticipantState(t)):this.logger.log(`unable to map tsCall state=${e} to call state`)}_mapStreams(){const e=[],t=[],i=i=>{if(this._tsParticipant)if(this._tsParticipant.streams&&gl(this._tsParticipant.streams[i])){let n=[];this._tsParticipant&&(n=this._tsParticipant.streams[i]),n.forEach((t=>{if(!this._mappedStreams.get(t.id)){const i=new ZC(t,this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);this.logger.log(`stream created, type==${i.mediaStreamType} id=${t.id}`),e.push(i)}})),this._mappedStreams.forEach((e=>{this.acsToTsStreamType(e.mediaStreamType)===i&&(n.some((t=>t.id===e.id))||t.push(e))}))}else this._mappedStreams.forEach((e=>{this.acsToTsStreamType(e.mediaStreamType)===i&&t.push(e)}))};i(0),i(1),(e.length>0||t.length>0)&&(e.forEach((e=>{this._mappedStreams.set(e.id,e)})),t.forEach((e=>{const t=this._mappedStreams.get(e.id);t&&(this.logger.log(`stream removed, type==${t.mediaStreamType} id=${e.id}`),this._mappedStreams.delete(e.id),t.dispose())})),this._eventEmitter.emit("videoStreamsUpdated",{added:e,removed:t}))}sendAudioEvent(e,t){try{let i,n;t&&(i=t.message,n=jp(t));const r={callId:this._call.id,timestampInfo:e.timestampInfo,correlationId:e.correlationId,step:e.step||"",failureReason:i||"",additionalDetails:{...n}};void 0!==e.eventType&&(r.eventType=e.eventType),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:r})}catch(e){this.logger.debug("Unable to send mute others audio telemetry")}}}f_([Of,S_("design:type",Object)],v_.prototype,"logger",void 0),f_([M(vg.Mute),S_("design:type",Function),S_("design:paramtypes",[]),S_("design:returntype",Promise)],v_.prototype,"mute",null);class y_{constructor(e){this._deviceManager=e,this._eventEmitter=new ep.EventEmitter,this._selectedDeviceListeners=new Map,this._selectedDevices=new Map,this._deviceInfoMapper=this._deviceManager.deviceInfoMapper;const t=e=>()=>{const t=this._selectedDevices.get(e),i=(()=>"Speaker"===e?this._deviceManager.selectedSpeaker:"Microphone"===e?this._deviceManager.selectedMicrophone:void 0)(),n=void 0===i?void 0:{id:this._deviceInfoMapper.getDeviceId(i.id),name:this._deviceInfoMapper.scrubDeviceLabel(i.name)};this._selectedDevices.set(e,n),this._eventEmitter.emit("selectedDeviceChanged",{selectedDeviceType:e,oldDevice:t,newDevice:n})},i=t("Speaker");this._selectedDeviceListeners.set("Speaker",i),this._deviceManager.on("selectedSpeakerChanged",i),i();const n=t("Microphone");this._selectedDeviceListeners.set("Microphone",n),this._deviceManager.on("selectedMicrophoneChanged",n),n()}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}selectedDevice(e){return this._selectedDevices.get(e)}dispose(){const e=this._selectedDeviceListeners.get("Speaker");e&&this._deviceManager.off("selectedSpeakerChanged",e);const t=this._selectedDeviceListeners.get("Microphone");t&&this._deviceManager.off("selectedMicrophoneChanged",t),this._eventEmitter.removeAllListeners()}}function C_(t,i,n,r){const s=r===qc.RoomCall||t.kind===e.CallKind.Call&&"Incoming"==t.direction&&!t.tsCall.groupId&&!!t.tsCall.meetingData?.meetingCode&&!t.tsCall.threadId,a=!s&&r===qc.TeamsMeetingLink||r===qc.TeamsMeetingId||r===qc.TeamsCoordinates||"Incoming"==t.direction&&!t.tsCall.groupId&&!!t.tsCall.meetingData&&!!t.tsCall.threadId;return{timestampInfo:{attemptTimestamp:+new Date},correlationId:n,localParticipantId:t.tsCall.participantId||"",isACSModeledInteropCall:t.isACSModeledInteropCall,callId:t.tsCall.callId||"",callType:t.tsCall.callType||"",callDirection:t.direction,state:"Ringing"===t.state?"Ringing":Fp[t.tsCall.state],groupJoin:!!t.tsCall.groupId,roomJoin:s,meetingJoin:a,callEndDiagnosticsInfo:t.tsCall.callEndDiagnosticsInfo||{},isSupportedEnvironment:i?.runningEnvironmentInfo?.isSupportedEnvironment,diagnosticInfo:{...t.tsCall.callEndDiagnosticsInfo,telemetryPayloadBytesOriginal:og.telemetryPayloadBytesOriginal,telemetryPayloadBytesCompressed:og.telemetryPayloadBytesCompressed}}}function __(e,t,i){try{"state-changed"===i.step&&"Connecting"===i.newState&&(og.telemetryPayloadBytesOriginal=0,og.telemetryPayloadBytesCompressed=0),e.sendEvent({name:Xu.acs_calling_call_progress,tenant:uc,properties:i})}catch(e){t.error(`Failed to send event: ${Xu.acs_calling_call_progress} step: ${i.step}`)}}var E_,T_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},I_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class b_{get id(){return this._id}get callerInfo(){return{identifier:this._callerIdentity,displayName:this._callerDisplayName}}get state(){return this._state}get role(){return this._role}get callEndReason(){return this._callEndReason}get kind(){return this._kind}get direction(){return this._direction}get isMuted(){return this._isMuted}get isScreenSharingOn(){return this._isScreenSharingOn}get isLocalVideoStarted(){return this._isLocalVideoStarted}get localVideoStreams(){return this._localVideoStreams}get localAudioStreams(){return this._localAudioStreams}get isIncomingAudioMuted(){return this._isIncomingAudioMuted}get remoteParticipants(){return this._remoteParticipants}get totalParticipantCount(){return this._totalParticipantCount}get lobby(){return this._lobby}get isACSModeledInteropCall(){return this._isACSModeledInteropCall}subscribeToGetRemoteAudioStream(){if(!this._rawAudioStreamChangedSubscription)try{let e=this.tsCall.getIncomingRawAudioStream(),t=async()=>{try{if(0===this._remoteAudioStreams.length){if(!await e.getMediaStream())throw new I({defaultError:f.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED});this._remoteAudioStreams.push(new RC(e,this._telemetryLogManager,this.id,this.tsCall.participantId)),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:this._remoteAudioStreams,removed:[]})}else if(await e.getMediaStream())this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[]});else{const e=this._remoteAudioStreams[0];e.dispose(),this._remoteAudioStreams=[],this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[e]})}}catch(e){throw new I({defaultError:f.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR,originalError:e})}};this._rawAudioStreamChangedSubscription=e.changed((()=>{this.logger.info(`Changed fired ${this.tsCall.state}, ${this.state}`),t().catch(kl)})),t().catch((()=>{this.logger.info("Failed to update remote audio stream collection, retrying on changed")}))}catch(e){this.logger.info("Failed to get raw audio stream from the stack")}}get remoteAudioStreams(){if(!yl().calling.allowAccessRawMediaStream)throw new I({defaultError:f.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED});return this._remoteAudioStreams}get deviceManager(){return this._callAgent.deviceManager}get mediaConstraintsManager(){return this._mediaConstraintsManager}get isHandlingLargeMeetingVideoRendering(){return this._isHandlingLargeMeetingVideoRendering}get networkQualityUfdEventDetails(){return this._networkQualityUfdEventDetails}get acsProxy(){return this._callAgent.acsProxy}get acsCustomRelayManager(){return this._callAgent.acsCustomRelayManager}get audioEffectsProcessorStats(){return this._audioEffectsProcessorStats}constructor(e,t,i,n,r,s){this._callAgent=t,this._isMuted=!1,this._isMuted_correlationIdCache=x(),this._isIncomingAudioMuted=!1,this._isIncomingAudioMuted_correlationIdCache=x(),this._isScreenSharingOn=!1,this._isLocalVideoStarted=!1,this._localVideoStreams=[],this._localAudioStreams=[],this._remoteAudioStreams=[],this._totalParticipantCount=1,this._isDeviceNotFunctioningMuted=!1,this.__attemptedToRecoverMicNotFunctioningBySDK=!1,this._isMicrophoneMuted=!1,this._disposed=!1,this._lastTsCallState=0,this._isSpeakerMuted=!1,this._callMode=0,this._role=Oc,this._lastTsCallMeetingDetails={},this._isHandlingLargeMeetingVideoRendering=!1,this._joinContextDescription=qc.Unknown,this._remoteParticipantsChangedListeners=[],this._localRingingStateSet=!1,this._networkQualityUfdEventDetails=[],this._audioEffectsProcessorStats=null,this._isACSModeledInteropCall=!1,this._mriToRemoteParticipantMap=new Map,this._remoteParticipants=[],this._state="None",this.localVideoStream=void 0,this.localScreenSharingStream=void 0,this._handleCallingApplicationIdentifier=e=>{this._isClosedCaptionsBot(e)&&this.logger.info("Handle participant: Ignore closed captions application")},this._handleMuteChanges=()=>{const e=new Jg(this.tsCall,{config:this._config}),t=this.tsCall.conversationType||e.context===kg.RoomJoin?!!(this.tsCall.isMuted||10!==this.tsCall.state&&this.tsCall.isServerMuted||this._isDeviceNotFunctioningMuted):!(!this.tsCall.isMuted&&!this._isDeviceNotFunctioningMuted);if(this._isMuted!=t){this.logger.info(`isMuted changed from ${this._isMuted} to ${t}`);let e=[];this.tsCall.isMuted&&e.push("isMicrophoneMuted"),this.tsCall.isServerMuted&&(e.push("isServerMuted"),this._eventEmitter.emit("mutedByOthers")),this._isDeviceNotFunctioningMuted&&e.push("isDeviceNotFunctioningMuted");let i="";e.length>=1&&(i=e.join(", ")),t&&(this._isMuted_correlationIdCache=x()),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,this._isMuted_correlationIdCache,this._joinContextDescription),step:"isMuted-changed",oldIsMuted:this._isMuted,newIsMuted:t,reason:i}),this._isMuted=t,this._eventEmitter.emit("isMutedChanged")}},this._handleIncomingAudioMuteChanges=()=>{const e=this._isSpeakerMuted;this._isIncomingAudioMuted!=e&&(this.logger.info(`newIncomingAudioMuted changed from ${this._isIncomingAudioMuted} to ${e}`),e&&(this._isIncomingAudioMuted_correlationIdCache=x()),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,this._isIncomingAudioMuted_correlationIdCache,this._joinContextDescription),step:"isIncomingAudioMuted-changed",oldIsMuted:this._isIncomingAudioMuted,newIsMuted:e,reason:""}),this._isIncomingAudioMuted=e,this._eventEmitter.emit("isIncomingAudioMutedChanged"))},this._isClosedCaptionsBot=e=>"28:b1902c3e-b9f7-4650-9b23-5772bd429747"===e.id,this.getTotalNotBotParticipantCount=()=>{let e=1;return this.tsCall.participantCounts&&this.tsCall.participantCounts.totalParticipants>0&&(e=this.tsCall.participantCounts.totalParticipants),this.tsCall.participants&&(e-=this.tsCall.participants.filter((e=>this.isHiddenBot(e))).length),e},this._id=e.callId,this.tsCall=i,this._direction=e.isIncoming?"Incoming":"Outgoing",this._config=e,this.logger=this._callAgent.logger.createChild((()=>`Call:${this._id}:${this._state}`)),this._telemetryLogManager=n,this.stats=new bC(this.logger,this._telemetryLogManager),this._eventEmitter=new Nm(this.logger),this.activeRemoteVideoStreamViews=new Map,this._mediaMetricsDeviceEvents={},this._kind=r,this._optimalVideoCount=1,this._ufdsCorrelationIdCache={1:{0:void 0,1:void 0,2:void 0,3:void 0},2:{0:void 0,1:void 0,2:void 0,3:void 0},3:{0:void 0,1:void 0,2:void 0,3:void 0},4:{0:void 0,1:void 0,2:void 0,3:void 0},5:{0:void 0,1:void 0,2:void 0,3:void 0},6:{0:void 0,1:void 0,2:void 0,3:void 0},7:{0:void 0,1:void 0,2:void 0,3:void 0},8:{0:void 0,1:void 0,2:void 0,3:void 0},9:{0:void 0,1:void 0,2:void 0,3:void 0},10:{0:void 0,1:void 0,2:void 0,3:void 0},11:{0:void 0,1:void 0,2:void 0,3:void 0},12:{0:void 0,1:void 0,2:void 0,3:void 0},13:{0:void 0,1:void 0,2:void 0,3:void 0},14:{0:void 0,1:void 0,2:void 0,3:void 0},15:{0:void 0,1:void 0,2:void 0,3:void 0},16:{0:void 0,1:void 0,2:void 0,3:void 0},17:{0:void 0,1:void 0,2:void 0,3:void 0},18:{0:void 0,1:void 0,2:void 0,3:void 0},19:{0:void 0,1:void 0,2:void 0,3:void 0},20:{0:void 0,1:void 0,2:void 0,3:void 0},21:{0:void 0,1:void 0,2:void 0,3:void 0},22:{0:void 0,1:void 0,2:void 0,3:void 0},23:{0:void 0,1:void 0,2:void 0,3:void 0},24:{0:void 0,1:void 0,2:void 0,3:void 0},25:{0:void 0,1:void 0,2:void 0,3:void 0},26:{0:void 0,1:void 0,2:void 0,3:void 0},27:{0:void 0,1:void 0,2:void 0,3:void 0},28:{0:void 0,1:void 0,2:void 0,3:void 0},29:{0:void 0,1:void 0,2:void 0,3:void 0},30:{0:void 0,1:void 0,2:void 0,3:void 0},31:{0:void 0,1:void 0,2:void 0,3:void 0},32:{0:void 0,1:void 0,2:void 0,3:void 0},33:{0:void 0,1:void 0,2:void 0,3:void 0},34:{0:void 0,1:void 0,2:void 0,3:void 0},35:{0:void 0,1:void 0,2:void 0,3:void 0},36:{0:void 0,1:void 0,2:void 0,3:void 0},37:{0:void 0,1:void 0,2:void 0,3:void 0},38:{0:void 0,1:void 0,2:void 0,3:void 0},39:{0:void 0,1:void 0,2:void 0,3:void 0},40:{0:void 0,1:void 0,2:void 0,3:void 0},41:{0:void 0,1:void 0,2:void 0,3:void 0},42:{0:void 0,1:void 0,2:void 0,3:void 0},43:{0:void 0,1:void 0,2:void 0,3:void 0},44:{0:void 0,1:void 0,2:void 0,3:void 0},45:{0:void 0,1:void 0,2:void 0,3:void 0},46:{0:void 0,1:void 0,2:void 0,3:void 0},47:{0:void 0,1:void 0,2:void 0,3:void 0},48:{0:void 0,1:void 0,2:void 0,3:void 0},49:{0:void 0,1:void 0,2:void 0,3:void 0},50:{0:void 0,1:void 0,2:void 0,3:void 0},51:{0:void 0,1:void 0,2:void 0,3:void 0},52:{0:void 0,1:void 0,2:void 0,3:void 0},53:{0:void 0,1:void 0,2:void 0,3:void 0},54:{0:void 0,1:void 0,2:void 0,3:void 0},55:{0:void 0,1:void 0,2:void 0,3:void 0},56:{0:void 0,1:void 0,2:void 0,3:void 0},57:{0:void 0,1:void 0,2:void 0,3:void 0},58:{0:void 0,1:void 0,2:void 0,3:void 0},59:{0:void 0,1:void 0,2:void 0,3:void 0},60:{0:void 0,1:void 0,2:void 0,3:void 0},61:{0:void 0,1:void 0,2:void 0,3:void 0},62:{0:void 0,1:void 0,2:void 0,3:void 0},63:{0:void 0,1:void 0,2:void 0,3:void 0},64:{0:void 0,1:void 0,2:void 0,3:void 0},65:{0:void 0,1:void 0,2:void 0,3:void 0},66:{0:void 0,1:void 0,2:void 0,3:void 0},67:{0:void 0,1:void 0,2:void 0,3:void 0},68:{0:void 0,1:void 0,2:void 0,3:void 0},69:{0:void 0,1:void 0,2:void 0,3:void 0},70:{0:void 0,1:void 0,2:void 0,3:void 0},71:{0:void 0,1:void 0,2:void 0,3:void 0},72:{0:void 0,1:void 0,2:void 0,3:void 0},73:{0:void 0,1:void 0,2:void 0,3:void 0},74:{0:void 0,1:void 0,2:void 0,3:void 0},75:{0:void 0,1:void 0,2:void 0,3:void 0},76:{0:void 0,1:void 0,2:void 0,3:void 0},77:{0:void 0,1:void 0,2:void 0,3:void 0}};const a=new Jg(this.tsCall,{config:this._config});this._capabilityResolver=new nm(this._eventEmitter,this.logger,this,a,t,i),yl().calling.mediaMetricsDeviceEventsEnabled&&(this._dmDevicesChangedSub=this._callAgent.tsStack?.getDeviceManager().on("devicesChanged",(()=>{this.setOrUpdateMediaMetricsDeviceEvents()}))),this._extensibleApi=new bp(this.logger,{call:this,callAgent:this._callAgent,callInfo:new Jg(this.tsCall,{config:this._config})},{tsCall:this.tsCall,callAgent:this._callAgent,call:this,telemetryLogManager:this._telemetryLogManager}),this._lobby=new JC(this.tsCall,this,this.logger,this._telemetryLogManager);const o=IC(vp.CallFeature);for(const e of o)"OnExtendedObjectConstructor"===e.activationOptions.activationEvent&&this.feature(e);this._mmrRdpConnectionManager=new QC(this.logger),yl().telemetry.sendNetworkChangedTelemetry&&this._sendNetworkChangedTelemetry(),yl().telemetry.deviceChangedEvents.enabled&&(this._selectedDeviceManager=new y_(this.deviceManager),this._setupSelectedDeviceChangedTelemetry()),this._mediaConstraintsManager=new qC(this.tsCall,this.logger,this._telemetryLogManager),this._isACSModeledInteropCall=s??!1}async accept(e={}){const t=e.audioOptions?.muted??!1,i=this.getLocalVideoStreamFromCallOptions(e),n=this.getLocalAudioStreamFromCallOptions(e),r=+new Date,s=x(),a=this._callAgent.getEcsConfigIds(),o=ql(this.tsCall);let c={joinContextDescription:"",additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),muted:t,withVideo:!!i,...YC(),AcsCallingSDKWeb_ecsConfigId:a.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:a.SkypeWebMedia,customContext:{userToUserPresent:!!o?.userToUser,xHeadersPresent:!!o?.xHeaders&&o.xHeaders.length>0}},additionalDetails:{}};const l=(e,t)=>{const a=+new Date;let o,l={...c};if(t){const{callEndReason:t,callingCommunicationError:i}=Bp(e,this);l.additionalDetails.callEndReason=t,o=i}else o=new I({defaultError:f.CALL.ACCEPT_INCOMING_CALL,originalError:e}),l.additionalDetails.communicationServicesError=jp(o).communicationServicesError;return this.sendCallStageEvent({eventName:Xu.acs_calling_call_accept_failed,correlationId:s,timestampInfo:{deltaTimeInMs:a-r},additionalPayload:l},o),i&&(this.sendVideoEvent({correlationId:s,eventName:Xu.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:a-r},localVideoStream:i,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn},o),this.removeLocalVideoStream(i)),n&&this.removeLocalAudioStream(n),o};try{if(e?.videoOptions?.constraints){let t=this._mediaConstraintsManager.getTelemetryPayload({video:e?.videoOptions?.constraints});c.additionalProperties.constraints=t}this.sendCallStageEvent({eventName:Xu.acs_calling_call_accept_attempt,correlationId:s,timestampInfo:{attemptTimestamp:r},additionalPayload:c});let a={...c};if(i&&this.setLocalVideoStream(i),this.setLocalAudioStream(n),i&&this.sendVideoEvent({eventName:Xu.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:r},correlationId:s,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn}),1!==this.tsCall.state)throw new I({defaultError:f.CALL.ACCEPT_NOT_RINGING});try{if(e?.videoOptions?.constraints){const t=await this._mediaConstraintsManager.setVideoConstraints(e?.videoOptions?.constraints,"accept",s,r),i=this._mediaConstraintsManager.getTelemetryPayload({video:t});a.additionalProperties.constraints=i}}catch(e){const t=new I({defaultError:f.CALL.ACCEPT_VIDEO_CONSTRAINTS,originalError:e});this.logger.error(`${t.message}`)}const o=this._getReceiveOnlyAudioOnCallStart(n),d={withVideo:!!i,receiveOnlyAudioOnCallStart:o,muted:t};return t&&(d.muteFlags=1),yl()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(d.mediaConfiguration={connectionType:"NoDirectConnection"}),"RawMedia"===i?.mediaStreamType&&await this._setRawStream(i,1),this.tsCall.accept(d).then((async()=>{const e=+new Date;i&&this.shallRemoveLvsAfterConnectedSuccessfully(i,"accept",s,e,r),n&&(this.startAudioInternal(n,!0).catch((e=>{})),this.shallRemoveLasAfterConnectedSuccessfully(n,"accept",s,e,r)),this.sendCallStageEvent({eventName:Xu.acs_calling_call_accept_connected,correlationId:s,timestampInfo:{deltaTimeInMs:e-r},additionalPayload:a})})).catch((e=>{l(e,!0)})),this}catch(e){throw l(e,!1)}}async reject(){const e=+new Date,t=x();this.sendCallStageEvent({eventName:Xu.acs_calling_call_reject_attempt,correlationId:t,timestampInfo:{attemptTimestamp:e}});const i=this._callAgent.getEcsConfigIds(),n={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:i.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:i.SkypeWebMedia},additionalDetails:{}};if(1!==this.tsCall.state){const i=new I({defaultError:f.CALL.REJECT_NOT_RINGING});n.additionalDetails.communicationServicesError=jp(i).communicationServicesError;const r=+new Date;throw this.sendCallStageEvent({eventName:Xu.acs_calling_call_reject_failed,correlationId:t,timestampInfo:{deltaTimeInMs:r-e},additionalPayload:n},i),i}return this.tsCall.reject().then((()=>{const i=+new Date;this.sendCallStageEvent({eventName:Xu.acs_calling_call_reject_success,correlationId:t,timestampInfo:{deltaTimeInMs:i-e}})})).catch((i=>{const r=+new Date,{callEndReason:s,callingCommunicationError:a}=Bp(this,i);throw n.additionalDetails.callEndReason=s,this.sendCallStageEvent({eventName:Xu.acs_calling_call_reject_failed,correlationId:t,timestampInfo:{deltaTimeInMs:r-e},additionalPayload:n},a),a}))}dispose(){this._disposed||(this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesChangedSub=void 0,this._extensibleApi.dispose(),this._eventEmitter.removeAllListeners(),this._onlineListener&&window.removeEventListener("online",this._onlineListener),this._offlineListener&&window.removeEventListener("offline",this._offlineListener),this._trouterStateChangedListener&&this._callAgent.offTrouterStateChanged(this._trouterStateChangedListener),this._mmrRdpConnectionManager.dispose(),this._selectedDeviceManager?.dispose(),this._disposed=!0)}async startAudioInternal(e,t=!1){const i=x(),n=+new Date;if(this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.attempt,isInternal:t,timestampInfo:"",additionalDetails:""}),"RawMedia"!==e.mediaStreamType){if(t)return void this.logger.info("startAudioInternal internal call: LocalAudioStream media type is not raw media, skipping raw audio startAudioInternal");{const e=new I({defaultError:f.CALL.START_AUDIO_LAS_NOT_RAW_MEDIA});this.logger.error(`Failed to start raw media audio: ${f.CALL.START_AUDIO_LAS_NOT_RAW_MEDIA.message}`);const r=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,isInternal:t,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:r-n},additionalDetails:{failureReason:e.message||"",code:e.code,subCode:e.subCode,...jp(e)}}),e}}let r;this._userProvidedLocalAudioStreamCache=e;try{r=await e.getMediaStream()}catch(e){const r=new I({defaultError:f.CALL.LOCAL_AUDIO_GET_MEDIA_STREAM,originalError:e});this.logger.error(`Failed to get raw stream with error: ${e}`);const s=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,isInternal:t,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:s-n},additionalDetails:{failureReason:r.message||"",code:r.code,subCode:r.subCode,...jp(r)}}),r}const s=this._callAgent.tsStack?.getDeviceManager();if(!yl()?.calling?.allowAccessRawMediaStream||!s?.setRawMediaStream){const e=new I({defaultError:f.CALL.LOCAL_AUDIO_SET_MEDIA_STREAM});this.logger.error("Failed to set raw input audio stream");const r=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,isInternal:t,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:r-n},additionalDetails:{failureReason:e.message||"",code:e.code,subCode:e.subCode,...jp(e)}}),e}const a=new MediaStream(r);s?.setRawMediaStream(a,0),this.removeLocalAudioStream(this.localAudioStreams[0]),this.setLocalAudioStream(e);const o=+new Date;this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.success,isInternal:t,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:o-n},additionalDetails:""})}stopAudioInternal(e=!1){const t=x(),i=+new Date;this.sendRawMediaEvent({eventName:Xu.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.attempt,isInternal:e,timestampInfo:"",additionalDetails:""});const n=this._localAudioStreams[0];if("RawMedia"!==n?.mediaStreamType){if(e)return void this.logger.info("stopAudioInternal internal call: LocalAudioStream media type is not raw media, skipping raw audio stopAudioInternal");{const n=new I({defaultError:f.CALL.STOP_AUDIO_LAS_NOT_RAW_MEDIA});this.logger.error(`Failed to stop raw media audio: ${f.CALL.STOP_AUDIO_LAS_NOT_RAW_MEDIA.message}`);const r=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,isInternal:e,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:r-i},additionalDetails:{failureReason:n.message||"",code:n.code,subCode:n.subCode,...jp(n)}}),n}}const r=this._callAgent.tsStack?.getDeviceManager();if(!yl()?.calling?.allowAccessRawMediaStream||!r?.unsetRawMediaStream){const n=new I({defaultError:f.CALL.LOCAL_AUDIO_UNSET_MEDIA_STREAM});this.logger.error("Failed to unset raw input audio stream");const r=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,isInternal:e,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:r-i},additionalDetails:{failureReason:n.message||"",code:n.code,subCode:n.subCode,...jp(n)}}),n}r.unsetRawMediaStream(0),this._userProvidedLocalAudioStreamCache=void 0,this.removeLocalAudioStream(this.localAudioStreams[0]),this.setLocalAudioStream();const s=+new Date;this.sendRawMediaEvent({eventName:Xu.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.success,isInternal:e,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:s-i},additionalDetails:""})}bindTsCall(){void 0!==this.tsCall.callerMri&&(this._callerIdentity=sl(this.tsCall.callerMri),this._callerDisplayName=this.tsCall.participants.find((e=>e.id===this.tsCall.callerMri))?.displayName),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._setCallRole(this.tsCall.advancedMeetingRole),this.updateCallMode(),this.tsCall.changed((()=>{this.tsCall.callId!==this._id&&(this.logger.log(`tsCall callId changed from ${this._id} to ${this.tsCall.callId}`),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"id-changed",isACSModeledInteropCall:this.isACSModeledInteropCall,oldCallId:this._id,newCallId:this.tsCall.callId}),this._id=this.tsCall.callId,this._eventEmitter.emit("idChanged")),this.tsCall.state!==this._lastTsCallState&&(this.logger.log(`tsCall state changed=${this.tsCall.state}`),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._handleMuteChanges()),this._isScreenSharingOn!==this.tsCall.isScreenSharingOn&&(this.logger.log(`tsCall isScreenSharingOn changed=${this.tsCall.isScreenSharingOn}`),this._isScreenSharingOn=this.tsCall.isScreenSharingOn,this._isScreenSharingOn||this.removeScreenSharingStream(),this._eventEmitter.emit("isScreenSharingOnChanged")),this._isMicrophoneMuted!==this.tsCall.isMuted&&(this.logger.log(`tsCall isMuted changed=${this.tsCall.isMuted}`),this._isMicrophoneMuted=this.tsCall.isMuted,this._handleMuteChanges()),this._isSpeakerMuted!==this.tsCall.isSpeakerMuted&&(this.logger.log(`tsCall _isSpeakerMuted changed=${this.tsCall.isSpeakerMuted}`),this._isSpeakerMuted=this.tsCall.isSpeakerMuted,this._handleIncomingAudioMuteChanges()),this.tsCall.advancedMeetingRole!==this._lastTsCallAdvancedMeetingRole&&(this.logger.log(`tsCall advancedMeetingRole changed=${this.tsCall.advancedMeetingRole}`),this._setCallRole(this.tsCall.advancedMeetingRole)),(this.tsCall.meetingData?.meetingUrl||this.tsCall.meetingData?.passcode||this.tsCall.threadId)&&this.tsCall.meetingDetails&&function(e,t){return null==t.meetingCapability&&null!=e.meetingCapability||null==t.capabilities&&null!=e.capabilities||!(p.isEqual(t.capabilities,e.capabilities)&&p.isEqual(t.meetingCapability,e.meetingCapability))}(this.tsCall.meetingDetails,this._lastTsCallMeetingDetails)&&this._setMeetingCapabilities(this.tsCall.meetingDetails),this.updateCallMode(),this.optimalVideoCountChanged()})),this.tsCall.on("serverMutedChanged",(()=>{this.logger.log(`tsCall isServerMuted changed=${this.tsCall.isServerMuted}`),this._handleMuteChanges()})),this._totalParticipantCount=this.getTotalNotBotParticipantCount(),this.tsCall.on("participantCountsUpdated",(()=>{const e=this.getTotalNotBotParticipantCount();if(this._totalParticipantCount!==e){const t=this._totalParticipantCount;this._totalParticipantCount=e,this.logger.log(`tsCall totalParticipantCount changed from ${t} to ${this._totalParticipantCount}`),yl().rendering.remoteVideo.largeMeeting.handleVideoRendering&&this._enableOrDisable_largeMeeting_videoRendering(),this._eventEmitter.emit("totalParticipantCountChanged");try{this.stats.recordEvent({name:Qu.number_of_participants,callId:this.id,localParticipantId:this.tsCall.participantId,data:{totalParticipantCount:this._totalParticipantCount,participantCounts:this.tsCall.participantCounts||{},previousParticipantCount:t}})}catch(e){this.logger.error("failed to send participant count change telemetry")}}})),this.tsCall.on("callQualityChanged",(async e=>{try{let t;5===e.type||32===e.type||2===e.type||1===e.type||37===e.type?(t=Qu.network_quality,this._trackNetworkQualityUfdEventDetails(e.type)):t=44===e.type||43===e.type||9===e.type||25===e.type||27===e.type||45===e.type||33===e.type||34===e.type||55===e.type||26===e.type||47===e.type?Qu.video_device_issue:Qu.other_diagnostic,3===e.value||2===e.value?(this.logger.warn(`Ufd error raised!, ufd=${e.type}, value=${e.value}, kind=${t}`),t===Qu.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!1}))):(this.logger.warn(`Ufd error recovered!, ufd=${e.type}, value=${e.value}, kind=${t}`),t===Qu.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!0})));let i="";const n=this._ufdsCorrelationIdCache[e.type][e.mediaType];3==e.value||2==e.value?n?i=n:(i=x(),this._ufdsCorrelationIdCache[e.type][e.mediaType]=i):(n&&(i=n),this._ufdsCorrelationIdCache[e.type][e.mediaType]=void 0);const r={type:e.type.toString(),level:e.value,mediaType:e.mediaType,correlationId:i};if(this.stats.recordEvent({name:t,callId:this.id,localParticipantId:this.tsCall.participantId,data:r}),this.shallStopVideo(e)){const t=+new Date,i=x();this.logger.warn(`Attempting to stop video gracefully due to video ufd being raised.UFD: ${e.type}, value: ${e.value}, call direction: ${this._direction}`),this.sendAudioEvent({eventName:Xu.acs_calling_stop_video_on_ufd_attempt,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{this.localVideoStream&&this.stopVideo(this.localVideoStream)}catch(t){const i=`Failed to stop video on video device start failed or capture mute event ${e.type} with value ${e.value}`;this.logger.error(i)}}if(this.shallRemoveLocalVideoStreamOnBadUfd(e)){const t=new I({defaultError:f.CALL.REMOVE_LOCAL_VIDEO_ON_BAD_UFD,defaultErrorMessageArgs:[e.type,e.value,this._direction]});this.localVideoStream&&(this.sendVideoEvent({eventName:Xu.acs_calling_start_video_failure,correlationId:x(),timestampInfo:{attemptTimestamp:+new Date},step:"start",additionalDetails:{...jp(t)},localVideoStream:this.localVideoStream,isScreenSharingOnFlag:this.isScreenSharingOn},t),this.removeLocalVideoStream(this.localVideoStream)),this.logger.error(t.message)}if(this.shallStopAudio(e)){const t=+new Date,i=x();if(yl()?.calling?.allowMuteOnBadUfd&&!this.tsCall.isMuted){this.sendAudioEvent({eventName:Xu.acs_calling_mute_on_ufd_attempt,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{await this.mute()}catch(t){const i=`Failed to mute on microphone device not functioning or capture mute event ${e.type} with value ${e.value}`;this.logger.error(i)}}const n=yl()?.calling?.preventStopAudio;if(n)return this.sendAudioEvent({eventName:Xu.acs_calling_prevent_stop_audio,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"}),void(!yl()?.calling?.preventFakeMute&&this.markCallMuted());this.sendAudioEvent({eventName:Xu.acs_calling_stop_audio_attempt,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{await this.tsCall.stopAudio(),this.markCallMuted();const e=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_stop_audio_success,timestampInfo:{deltaTimeInMs:e-t},correlationId:i,step:"mid-call"})}catch(n){const r=new I({defaultError:f.CALL.STOP_AUDIO_ON_BAD_UFD,defaultErrorMessageArgs:[e.type,e.value],originalError:n});this.logger.error(r.message);const s=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_stop_audio_failure,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call"},r)}}this.muteUnmuteOnMicrophoneNotFunctioningUfd(e),this.audioDidAutoRecover(e)&&(this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges())}catch(e){this.logger.error("Failed to send ufd telemetry")}})),this.tsCall.on("participantAdded",(async e=>{this.logger.debug("tsCall participant added");const t=[];e.endpoints?.endpointDetails.forEach((e=>t.push(e.participantId))),0===t.length&&t.push("remoteParticipantId unavailable");const i=sl(e.id);if(this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:t,participantAddedOrRemoved:"added",kindOfEvent:Zu.event}),this.isHiddenBot(e))return this.logger.info("Add participant: Handle hidden calling application"),void this._handleCallingApplicationIdentifier(e);this._handleLocalRingingCallState(e);try{const t=this.getOrCreateRemoteParticipant(i,e);this._eventEmitter.emit("remoteParticipantsUpdated",{added:[t],removed:[]})}catch(e){this.logger.log("unable to map call participant to ACS user")}})),this.logger.debug(`tsCall current participant count=${this.tsCall?.participants?.length}`),this.tsCall.participants.forEach((e=>{const t=sl(e.id);this.getOrCreateRemoteParticipant(t,e),this._handleLocalRingingCallState(e)}));try{const e=[];this.tsCall.participants.forEach((t=>{t.endpoints?.endpointDetails.forEach((t=>e.push(t.participantId)))})),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:e,participantAddedOrRemoved:"added",kindOfEvent:Zu.initialize})}catch(e){this.logger.info("Remove participant: Ignore calling application")}this.tsCall.on("participantRemoved",(async e=>{this.logger.debug("tsCall participant removed");const t=[];if(e.endpoints?.endpointDetails.forEach((e=>t.push(e.participantId))),0===t.length&&t.push("remoteParticipantId unavailable"),this.isHiddenBot(e))return this.logger.info("Remove participant: Ignore calling application"),void this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:t,participantAddedOrRemoved:"removed",kindOfEvent:Zu.event});const i=e.id;if(i){const n=this._remoteParticipants.find((e=>rl(e.identifier)===i));if(n){const{callEndReason:i}=Hp(this,e);n.setCallEndReason(i),this.deleteRemoteParticipant(n),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[n]}),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:t,participantAddedOrRemoved:"removed",kindOfEvent:Zu.event,additionalDetails:{...qp(i)}})}else this.logger.log("unable to find participant to remove")}}))}_trackNetworkQualityUfdEventDetails(e){const t=+new Date;let i="";switch(e){case 5:i=dm;break;case 32:i=gm;break;case 2:i=hm;break;case 1:i=um;break;case 37:i=pm}this._networkQualityUfdEventDetails.push({eventName:i,timestampInfo:t})}async muteUnmuteOnMicrophoneNotFunctioningUfd(e){try{const t=yl().calling;if(!t.muteUnmuteOnMicrophoneNotFunctioning||this._isMuted||9!==e.type||3!==e.value)return;this.__attemptedToRecoverMicNotFunctioningBySDK=!0,await this.mute(),t.unmuteDelayForMicrophoneNotFunctioningInMs>=0&&await Lu(t.unmuteDelayForMicrophoneNotFunctioningInMs),await this.unmute()}catch(e){this.logger.info("Unable to perform mute and unmute to recover microphoneNotFunctioning",e)}finally{this.__attemptedToRecoverMicNotFunctioningBySDK=!1}}updateCallMode(){this.tsCall.callMode&&this._callMode!==this.tsCall.callMode&&(this.logger.log(`tsCall callMode changed from ${this._callMode} to ${this.tsCall.callMode}`),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"callMode-changed",oldState:Vp[this._callMode],newState:Vp[this.tsCall.callMode]}),this._callMode=this.tsCall.callMode)}async startCallInternal(e,t,i,n){const r=!!e?.audioOptions?.muted,s=this.getLocalVideoStreamFromCallOptions(e),a=this.getLocalAudioStreamFromCallOptions(e);let o;const c=+new Date,l=x();this._joinContextDescription=function(e){return e?e.groupId?qc.GroupCall:!e.threadId||e.organizerId||e.tenantId||e.messageId?e.threadId&&e.organizerId&&e.tenantId&&e.messageId?qc.TeamsCoordinates:e.meetingId?qc.TeamsMeetingId:e.meetingLink?qc.TeamsMeetingLink:e.roomId?qc.RoomCall:qc.Unknown:qc.GroupChatCall:qc.Unknown}(i);const d=this._callAgent.getEcsConfigIds(),h={joinContextDescription:this._joinContextDescription,additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,IsEmergencyCall:n?.isEmergency||!1,trouterState:this._callAgent.getTrouterState(),muted:r,withVideo:!!s,...YC(),AcsCallingSDKWeb_ecsConfigId:d.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:d.SkypeWebMedia,customContext:{userToUserPresent:!!e?.customContext?.userToUser,xHeadersPresent:!!e?.customContext?.xHeaders&&e.customContext.xHeaders.length>0}},additionalDetails:{}};e?.videoOptions?.constraints&&(h.additionalProperties.constraints=this._mediaConstraintsManager.getTelemetryPayload({video:e?.videoOptions?.constraints})),n?.meetingInfo?.tenantId&&(this._teamsMeetingTenantId=n.meetingInfo.tenantId,h.additionalProperties.teamsMeetingTenantId=n.meetingInfo.tenantId),n?.threadId&&(this._teamsMeetingThreadId=n.threadId,h.additionalProperties.teamsMeetingThreadId=n.threadId),yl().calling.setDeviceType&&"default"!==this._callAgent.getDeviceType()&&(h.additionalProperties.firstPartyOptions={deviceType:this._callAgent.getDeviceType(),isImmersiveMode:e?.firstPartyOptions?.isImmersiveMode}),this.sendCallStageEvent({eventName:Xu.acs_calling_call_attempt,correlationId:l,timestampInfo:{attemptTimestamp:c},additionalPayload:h});let u={...h},g={...h};try{this._isMicrophoneMuted=r,e?.alternateCallerId&&(o=rl(e.alternateCallerId)),s&&this.setLocalVideoStream(s),this.setLocalAudioStream(a)}catch(e){const t=+new Date,i=new I({defaultError:f.CALL.INSTANTIATE_CALL,originalError:e});throw u.additionalDetails.communicationServicesError=jp(i).communicationServicesError,this.sendCallStageEvent({eventName:Xu.acs_calling_call_failed,correlationId:l,timestampInfo:{deltaTimeInMs:t-c},additionalPayload:u},i),this.logger.error(i.message),i}try{const i={...n};!yl().calling.setDeviceType||"mesh"!==this._callAgent.getDeviceType()&&"meshV2"!==this._callAgent.getDeviceType()||(i.endpointMetadata=JSON.stringify({meshapp:!0})),this.tsCall.init(i),s&&this.sendVideoEvent({correlationId:l,eventName:Xu.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:c},localVideoStream:s,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn});try{if(e?.videoOptions?.constraints){const t=await this._mediaConstraintsManager.setVideoConstraints(e?.videoOptions?.constraints,"start",l,c),i=this._mediaConstraintsManager.getTelemetryPayload({video:t});g.additionalProperties.constraints=i}}catch(e){const t=new I({defaultError:f.CALL.CALLSTART_VIDEO_CONSTRAINTS,originalError:e});this.logger.error(`${t.message}`)}let d=this.setClientEndpointCapabilities(e);yl()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(d.mediaConfiguration={connectionType:"NoDirectConnection"}),r&&(d.muteFlags=1),d.customHeaderContext=jl(e),"RawMedia"===s?.mediaStreamType&&await this._setRawStream(s,1);const h=this._getReceiveOnlyAudioOnCallStart(a);t?await this.tsCall.startWithMeetingData(m.generateCauseId(),{withVideo:!!s,muted:r,ringOthers:!0,alternateId:o,shouldResurrect:"resurrect",receiveOnlyAudioOnCallStart:h,...d}):await this.tsCall.start({withVideo:!!s,muted:r,ringOthers:!0,alternateId:o,receiveOnlyAudioOnCallStart:h,...d});const u=+new Date;this.sendCallStageEvent({eventName:Xu.acs_calling_call_connected,correlationId:l,timestampInfo:{deltaTimeInMs:u-c},additionalPayload:g}),s&&this.shallRemoveLvsAfterConnectedSuccessfully(s,"start",l,u,c),a&&(this.startAudioInternal(a,!0).catch((e=>{})),this.shallRemoveLasAfterConnectedSuccessfully(a,"start",l,u,c)),this._handleAudioEffectsOperations()}catch(e){const t=+new Date,{callEndReason:i,callingCommunicationError:n}=Bp(this,e);throw s&&(this.sendVideoEvent({correlationId:l,eventName:Xu.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:t-c},localVideoStream:s,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn},n),this.removeLocalVideoStream(s)),a&&this.removeLocalAudioStream(a),u.additionalDetails.callEndReason=qp(i).callEndReason,this.sendCallStageEvent({eventName:Xu.acs_calling_call_failed,correlationId:l,timestampInfo:{deltaTimeInMs:t-c},additionalPayload:u},n),this.logger.error(`Failed to start the call, message=${i?.message}, code=${i?.code}, subCode=${i?.subCode}, resultCategories=${i?.resultCategories}`),n}}getTopNDominantSpeakersWithVideoOn(){if(this._internalDominantSpeakersListener){const e=this._internalDominantSpeakersListener.dominantSpeakers.speakersList.map((e=>this._mriToRemoteParticipantMap.get(rl(e)))).filter((e=>!!e)).filter((e=>!!e.videoStreams.filter((e=>"Video"===e.mediaStreamType)).find((e=>e.tsStream.isAvailable))));if(this.logger.info(`There are currently ${e.length} top-n dominant speakers with video on in the large meeting where topCount is ${yl().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount}`),e.length<yl().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount){const t=this._remoteParticipants.filter((e=>!!e.videoStreams.filter((e=>"Video"===e.mediaStreamType)).find((e=>e.tsStream.isAvailable)))).filter((t=>!e.includes(t)));t.sort(((e,t)=>{const i=e.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((e=>"audio"===e.type)).map((e=>e.sourceId))??[],n=i.length>0?Math.min(...i):void 0,r=t.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((e=>"audio"===e.type)).map((e=>e.sourceId))??[],s=r.length>0?Math.min(...r):void 0;return void 0!==n&&null!=s?n-s:0}));for(const i of t){if(e.length===yl().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount)break;e.push(i)}}else e.splice(yl().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount);return e}return[]}getParticipantCapabilities(){const e=this._capabilityResolver.getCapabilities();return this.logger.log(`participant capabilities are ${e}`),e}feature(e){return this._extensibleApi.getApiObjectInstance(e.callApiCtor)}async hangUp(e){const t=+new Date,i=x();return this.sendCallStageEvent({eventName:Xu.acs_calling_call_hangup_attempt,correlationId:i,timestampInfo:{attemptTimestamp:t}}),this.tsCall.stop(e?.forEveryone).then((()=>{const e=+new Date;this.sendCallStageEvent({eventName:Xu.acs_calling_call_hangup_success,correlationId:i,timestampInfo:{deltaTimeInMs:e-t}})})).catch((e=>{const n=+new Date,{callEndReason:r,callingCommunicationError:s}=Bp(this,e),a=this._callAgent.getEcsConfigIds(),o={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:a.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:a.SkypeWebMedia},additionalDetails:{...qp(r)}};throw this.sendCallStageEvent({eventName:Xu.acs_calling_call_hangup_failure,correlationId:i,timestampInfo:{deltaTimeInMs:n-t},additionalPayload:o},s),s}))}async mute(){const e=this.logger.createFnLogger(Sg.Mute),t=+new Date,i=x();this.sendAudioEvent({eventName:Xu.acs_calling_mute_attempt,eventType:tg.MuteMicrophone,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{e.info("mute"),await this.tsCall.mute(),e.info("mute success");const n=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_mute_success,eventType:tg.MuteMicrophone,timestampInfo:{deltaTimeInMs:n-t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK})}catch(n){const r=new I({defaultError:f.CALL.MIC_MUTE,originalError:n});e.error("Failed to mute microphone");const s=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_mute_failure,eventType:tg.MuteMicrophone,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK},r),r}}async unmute(){const e=this.logger.createFnLogger(Sg.Unmute),t=+new Date,i=x();let n=!1;this.sendAudioEvent({eventName:Xu.acs_calling_unmute_attempt,eventType:tg.UnmuteMicrophone,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{e.info("unmute"),await this.tsCall.unmute(),e.info("unmute success");const r=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_unmute_success,eventType:tg.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:r-t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});const s=+new Date,a=yl()?.calling?.preventStopAudio;if(!a&&this._isDeviceNotFunctioningMuted){this.sendAudioEvent({eventName:Xu.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:s},correlationId:i,step:"mid-call"}),n=!0,e.info("start audio"),await this.tsCall.startAudio(),e.info("start audio success");const t=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:Xu.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:t-s},correlationId:i,step:"mid-call"})}this.setLocalAudioStream()}catch(r){const s=n?f.CALL.MIC_UNMUTE_AND_STARTAUDIO:f.CALL.MIC_UNMUTE,a=new I({defaultError:s,originalError:r});e.error(s.message);const o=+new Date;throw this.sendAudioEvent({eventName:n?Xu.acs_calling_start_audio_failure:Xu.acs_calling_unmute_failure,eventType:n?void 0:tg.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:o-t},correlationId:i,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK&&!n},a),a}}async muteAllRemoteParticipants(){if(!yl().calling.enableMuteOthers)throw new I({defaultError:f.CALL.MUTE_ALL_PARTICIPANTS_DISABLED});const e=this.logger.createFnLogger(Sg.MuteAllRemoteParticipants),t=+new Date,i=x();this.sendAudioEvent({eventName:Xu.acs_calling_mute_attempt,eventType:tg.MuteAllRemoteParticipants,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{e.info("mute all others"),await this.tsCall.muteParticipants(0,[]),e.info("mute all others success");const n=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_mute_success,eventType:tg.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:n-t},correlationId:i,step:"mid-call"})}catch(n){const r=new I({defaultError:f.CALL.MUTE_ALL_PARTICIPANTS,originalError:n});e.error(r.message);const s=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_mute_failure,eventType:tg.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call"},r),r}}async muteIncomingAudio(){const e=this.logger.createFnLogger(Sg.MuteIncomingAudio),t=+new Date,i=x();this.sendAudioEvent({eventName:Xu.acs_calling_mute_attempt,eventType:tg.MuteIncomingAudio,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{await this.tsCall.muteSpeaker();const e=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_mute_success,eventType:tg.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:e-t},correlationId:i,step:"mid-call"})}catch(n){const r=new I({defaultError:f.CALL.MUTE_INCOMING_AUDIO,originalError:n});e.error(r.message);const s=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_mute_failure,eventType:tg.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call"},r),r}}async unmuteIncomingAudio(){const e=this.logger.createFnLogger(Sg.MuteIncomingAudio),t=+new Date,i=x();this.sendAudioEvent({eventName:Xu.acs_calling_unmute_attempt,eventType:tg.UnmuteIncomingAudio,timestampInfo:{attemptTimestamp:t},correlationId:i,step:"mid-call"});try{await this.tsCall.unmuteSpeaker();const e=+new Date;this.sendAudioEvent({eventName:Xu.acs_calling_unmute_success,eventType:tg.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:e-t},correlationId:i,step:"mid-call"})}catch(n){const r=new I({defaultError:f.CALL.UNMUTE_INCOMING_AUDIO,originalError:n});e.error(r.message);const s=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_unmute_failure,eventType:tg.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:s-t},correlationId:i,step:"mid-call"},r),r}}async sendDtmf(e){const t=function(e){switch(e){case"Num0":return 0;case"Num1":return 1;case"Num2":return 2;case"Num3":return 3;case"Num4":return 4;case"Num5":return 5;case"Num6":return 6;case"Num7":return 7;case"Num8":return 8;case"Num9":return 9;case"Star":return 10;case"Pound":return 11;case"A":return 12;case"B":return 13;case"C":return 14;case"D":return 15;case"Flash":return 16;default:throw new I({defaultError:f.CALL.INVALID_DTMF_TONE})}}(e);return this.tsCall.sendDtmfTone(t).catch((e=>{throw this.logger.error("Failed to send DTMF tone"),new I({defaultError:f.CALL.DTMF_TONE})}))}async startVideo(e){const t=this.logger.createFnLogger(Sg.StartVideo),i=+new Date,n=x(),r=yl()?.calling?.preventStopAudio;if(this.sendVideoEvent({eventName:Xu.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:i},localVideoStream:e,correlationId:n,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),this._isDeviceNotFunctioningMuted&&!r){this.sendAudioEvent({eventName:Xu.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:i},correlationId:n,step:"mid-call"});try{t.info("start audio before starting video"),await this.tsCall.startAudio(),t.info("start audio success before starting video");const e=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:Xu.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:e-i},correlationId:n,step:"mid-call"})}catch(e){const r="Failed to start audio before starting video",s=new I({defaultError:f.CALL.START_AUDIO_BEFORE_VIDEO,originalError:e});t.error(r);const a=+new Date;throw this.sendAudioEvent({eventName:Xu.acs_calling_start_audio_failure,timestampInfo:{deltaTimeInMs:a-i},correlationId:n,step:"mid-call"},s),s}}try{if(!e)throw new I({defaultError:f.CALL.STREAM_NULL});if(!(e instanceof $f))throw new I({defaultError:f.CALL.STREAM_IS_NOT_LVS});if(this.tsCall.isVideoOn)throw new I({defaultError:f.CALL.VIDEO_ALREADY_ON});"RawMedia"===e?.mediaStreamType&&await this._setRawStream(e,1),this.setLocalVideoStream(e)}catch(t){const r=new I({defaultError:f.CALL.START_VIDEO,originalError:t});throw this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_start_video_failure,timestampInfo:{attemptTimestamp:i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},r),r}try{t.info("start video"),await this.tsCall.startVideo();const r=+new Date;this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:r-i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),t.info("video started")}catch(r){const t=+new Date,s=$p(0,r);throw this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:t-i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},s),this.removeLocalVideoStream(e),s}}async stopVideo(e){const t=this.logger.createFnLogger(Sg.StopVideo),i=+new Date,n=x();if(this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_stop_video_attempt,timestampInfo:{attemptTimestamp:i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),!this.tsCall.isVideoOn){const t=new I({defaultError:f.CALL.VIDEO_ALREADY_OFF});throw this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},t),t}if(this.localVideoStream!==e){const t=new I({defaultError:f.CALL.STOP_WRONG_STREAM});throw this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},t),t}const r=()=>{try{if(yl().calling.allowAccessRawMediaStream&&"RawMedia"===e.mediaStreamType){const e=this._callAgent.tsStack?.getDeviceManager();e&&e.unsetRawMediaStream&&e.unsetRawMediaStream(1)}}catch(e){this.logger.info(`Unset raw video stream: ${e?.message??"Unkown error"}`)}};try{t.info("stop video"),await this.tsCall.stopVideo(),r();const s=+new Date;this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_stop_video_success,timestampInfo:{deltaTimeInMs:s-i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),t.info("video stopped"),this.removeLocalVideoStream(e)}catch(t){r();const s=+new Date,a=$p(0,t);throw this.sendVideoEvent({correlationId:n,eventName:Xu.acs_calling_stop_video_failure,timestampInfo:{deltaTimeInMs:s-i},localVideoStream:e,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},a),a}}startAudio(e){return this.startAudioInternal(e)}stopAudio(){return this.stopAudioInternal()}async hold(){const e=+new Date,t=x();try{this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.attempt,timestampInfo:{deltaTimeInMs:e},additionalDetails:{holdType:Lg.Standard}}),await this.tsCall.hold(),this.removeLocalAudioStream(this._localAudioStreams[0]);const i=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{holdType:Lg.Standard}})}catch(i){const n=+new Date,r=new I({defaultError:f.CALL.HOLD_CALL});throw this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-e},additionalDetails:{failureReason:r.message,code:r.code,subCode:r.subCode,holdType:Lg.Standard,...jp(r)}}),r}}async resume(){const e=+new Date,t=x();try{this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.attempt,timestampInfo:{deltaTimeInMs:e},additionalDetails:{holdType:Lg.Standard}}),await this.tsCall.unhold(),this.setLocalAudioStream();const i=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{holdType:Lg.Standard}})}catch(i){const n=+new Date,r=new I({defaultError:f.CALL.RESUME_CALL});throw this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-e},additionalDetails:{failureReason:r.message,code:r.code,subCode:r.subCode,holdType:Lg.Standard,...jp(r)}}),r}}async startScreenSharing(e){this.logger.createFnLogger(Sg.StartScreenShare);const t=+new Date,i=x();try{if(this.sendScreenShareEvent({eventName:Xu.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:e}),3!==this.tsCall.state)throw new I({defaultError:f.CALL.START_SS_CALL_NOT_CONNECTED});if(this.tsCall.isScreenSharingOn)throw new I({defaultError:f.CALL.SS_ALREADY_ON});if(e){if(!(e instanceof $f))throw new I({defaultError:f.CALL.SS_RAW_STREAM_IS_NOT_LVS});if("RawMedia"!==e.mediaStreamType)throw new I({defaultError:f.CALL.SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA});await this._setRawStream(e,2),this.localScreenSharingStream=e}else this.localScreenSharingStream=new $f(new Df(il,x(),il,this._callAgent.deviceManager))}catch(e){const n=+new Date;this.removeScreenSharingStream();const r=new I({defaultError:f.CALL.START_SS,originalError:e});throw this.sendScreenShareEvent({eventName:Xu.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-t},additionalDetails:{failureReason:r.message,code:r.code,subCode:r.subCode,...jp(r)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),r}return this.tsCall.startScreenSharing().then((()=>{const e=+new Date;this.localScreenSharingStream&&-1===this._localVideoStreams.indexOf(this.localScreenSharingStream)&&(this.localScreenSharingStream.addCall(this),this._localVideoStreams.push(this.localScreenSharingStream),this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localScreenSharingStream],removed:[]})),this.sendScreenShareEvent({eventName:Xu.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:e-t},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream})})).catch((e=>{const n=+new Date;this.removeScreenSharingStream();const r=$p(0,e);throw this.sendScreenShareEvent({eventName:Xu.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-t},additionalDetails:{failureReason:r.message,code:r.code,subCode:r.subCode,...jp(r)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),r}))}async stopScreenSharing(){this.logger.createFnLogger(Sg.StopScreenShare);const e=+new Date,t=x();if(this.sendScreenShareEvent({eventName:Xu.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),3!==this.tsCall.state)throw new I({defaultError:f.CALL.STOP_SS_CALL_NOT_CONNECTED});if(!this.tsCall.isScreenSharingOn){const i=+new Date,n=new I({defaultError:f.CALL.SS_ALREADY_OFF});throw this.sendScreenShareEvent({eventName:Xu.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,...jp(n)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),n}return this.tsCall.stopScreenSharing().then((()=>{const i=+new Date,n=p.cloneDeep(this.localScreenSharingStream);this.removeScreenSharingStream(),this.sendScreenShareEvent({eventName:Xu.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:n})})).catch((i=>{const n=+new Date,r=$p(0,i);let s="string"==typeof r?.message?r?.message:void 0;throw this.sendScreenShareEvent({eventName:Xu.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-e},additionalDetails:{failureReason:s||"",code:r.code,subCode:r.subCode,...jp(r)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),r}))}async setConstraints(e){const t=+new Date,i=x();try{let n=await this._mediaConstraintsManager.setVideoConstraints(e?.video,"mid-call",i,t);this.logger.info(`Video constraints set - ${JSON.stringify(n)}`)}catch(e){throw new I({defaultError:f.CALL.SET_VIDEO_CONSTRAINTS,originalError:e})}}on(e,t){if("stateChanged"!==e&&"idChanged"!==e&&"isMutedChanged"!==e&&"isIncomingAudioMutedChanged"!==e&&"isScreenSharingOnChanged"!==e&&"isLocalVideoStartedChanged"!==e&&"remoteParticipantsUpdated"!==e&&"localVideoStreamsUpdated"!==e&&"localAudioStreamsUpdated"!==e&&"remoteAudioStreamsUpdated"!==e&&"totalParticipantCountChanged"!==e&&"roleChanged"!=e&&"mutedByOthers"!==e)throw new I({defaultError:f.CALL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("stateChanged"!==e&&"idChanged"!==e&&"isMutedChanged"!==e&&"isIncomingAudioMutedChanged"!=e&&"isScreenSharingOnChanged"!==e&&"isLocalVideoStartedChanged"!==e&&"remoteParticipantsUpdated"!==e&&"localVideoStreamsUpdated"!==e&&"localAudioStreamsUpdated"!==e&&"remoteAudioStreamsUpdated"!==e&&"totalParticipantCountChanged"!=e&&"roleChanged"!=e&&"mutedByOthers"!==e)throw new I({defaultError:f.CALL.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}onMeetingCapabilitiesChanged(e,t){if("meetingCapabilitiesChanged"!==e)throw new I({defaultError:f.CALL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}offMeetingCapabilitiesChanged(e,t){if("meetingCapabilitiesChanged"!=e)throw new I({defaultError:f.CALL.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}onParticipantCapabilitiesChanged(e,t){this.logger.log("participant capabilities change event listener registered"),this._eventEmitter.on(e,t)}offParticipantCapabilitiesChanged(e,t){this.logger.log("participant capabilities change event listener unregistered"),this._eventEmitter.off(e,t)}getOrCreateRemoteParticipant(e,t){let i=this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)));return i||(i=new v_(e,this.logger,this,this._callAgent,this._telemetryLogManager),this._remoteParticipants.push(i),this._mriToRemoteParticipantMap.set(rl(i.identifier),i)),t&&i.observeParticipant(t),i}deleteRemoteParticipant(e){let t=!0;return 1!==this._remoteParticipants.splice(this._remoteParticipants.indexOf(e),1).length&&(this.logger.warn("Deleted remote participant array is not 1"),t=!1),this._mriToRemoteParticipantMap.delete(rl(e.identifier))||(this.logger.warn("Deleted remote participant was not found in mri-to-remoteparticipant map"),t=!1),t}sendCallOnHoldAndResumedEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send call hold or resume telemetry")}}sendVideoEvent(e,t){try{let i,n;try{i=e.localVideoStream?.getStreamMetadata()}catch(e){this.logger.error("Unable to get stream meta data on send video event")}t&&(n="string"==typeof t?.message?t?.message:void 0,e.additionalDetails={...jp(t)}),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{...i,callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:e.timestampInfo,correlationId:e.correlationId,step:e.step||"",failureReason:n||"",isScreenSharingOnFlag:e.isScreenSharingOnFlag,additionalDetails:e.additionalDetails||{}}})}catch(e){this.logger.debug("Unable to send video telemetry")}}sendScreenShareEvent(e){let t;try{t=e.localVideoStream?.getStreamMetadata()}catch(e){this.logger.error("Unable to get stream meta data on send video event")}try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{...t,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:e.correlationId,kindOfEvent:e.kindOfEvent,timestampInfo:e.timestampInfo,additionalDetails:e.additionalDetails,isVideoOn:e.isVideoOn}})}catch(e){this.logger.debug("Unable to send screen share telemetry")}}sendRawMediaEvent(e){const t={...e};t.localAudioStream=e.localAudioStream?.source instanceof MediaStream?"MediaStream":"Device";try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:t})}catch(e){this.logger.debug("Unable to send raw media telemetry")}}sendAudioEvent(e,t){try{let i;t&&(i="string"==typeof t?.message?t?.message:void 0,e.additionalDetails={...jp(t)});const n={callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:e.timestampInfo,correlationId:e.correlationId,step:e.step||"",failureReason:i||"",additionalDetails:e.additionalDetails||{}};void 0!==e.eventType&&(n.eventType=e.eventType),e.initiatedBySdk&&(n.initiatedBySdk=!0),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:n})}catch(e){this.logger.debug("Unable to send audio telemetry")}}sendCallStageEvent(t,i,n){try{let r,s="";i&&(r=this?.tsCall?.callEndDiagnosticsInfo||n||{},s=i.message);const a=this._joinContextDescription===qc.RoomCall||this.kind===e.CallKind.Call&&"Incoming"===this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData?.meetingCode&&!this.tsCall.threadId,o=!a&&this._joinContextDescription===qc.TeamsMeetingLink||this._joinContextDescription===qc.TeamsMeetingId||this._joinContextDescription===qc.TeamsCoordinates||"Incoming"==this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData&&!!this.tsCall.threadId,c={localParticipantId:this?.tsCall?.participantId||"",callId:this?.tsCall?.callId||"",callType:this?.tsCall?.callType||"",callDirection:this._direction,failureReason:s,callEndDiagnosticsInfo:r,calleeIdentityType:this.getParticipantIdentityType(),groupJoin:!!this?.tsCall?.groupId,roomJoin:a,meetingJoin:o,correlationId:t.correlationId,timestampInfo:t.timestampInfo,...t.additionalPayload};this._telemetryLogManager.sendEvent({name:t.eventName,tenant:uc,properties:c})}catch(e){}}getParticipantIdentityType(){if(this.tsCall?.participants.length>1)return nl.group;if(0===this.tsCall?.participants.length)return nl.unknown;const e=this.tsCall?.participants[0];return sl(e.id).kind}optimalVideoCountChanged(){const e=this._optimalVideoCount,t=this.tsCall.optimalVideoCount;if(t&&e!==t)try{__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"optimalVideoCount-changed",previousOptimalVideoCount:e,newOptimalVideoCount:t,currentNumberOfVideosRendered:this.activeRemoteVideoStreamViews?.size||0})}catch(e){this.logger.error("Failed to send optimal video count change telemetry")}finally{this._optimalVideoCount=this.tsCall.optimalVideoCount||1}}_sendNetworkChangedTelemetry(){try{const e=(e,t,i)=>{__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"network-changed",trouterState:e,onLine:t,rdpState:i})};this._trouterStateChangedListener=t=>{e(t,navigator.onLine,this._mmrRdpConnectionManager.state)},this._callAgent.onTrouterStateChanged(this._trouterStateChangedListener),this._onlineListener=t=>{e(this._callAgent.getTrouterState(),!0,this._mmrRdpConnectionManager.state)},window.addEventListener("online",this._onlineListener),this._offlineListener=t=>{e(this._callAgent.getTrouterState(),!1,this._mmrRdpConnectionManager.state)},window.addEventListener("offline",this._offlineListener),this._mmrRdpConnectionManager.on("stateChange",(t=>{e(this._callAgent.getTrouterState(),!1,t)})),e(this._callAgent.getTrouterState(),navigator.onLine,this._mmrRdpConnectionManager.state)}catch(e){this.logger.warn("Failed to subscribe to network changed")}}_setupSelectedDeviceChangedTelemetry(){try{const e=e=>{__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"selectedDevice-changed",selectedDeviceType:e.selectedDeviceType,oldDevice:e.oldDevice,newDevice:e.newDevice})};if(this._selectedDeviceManager){this._selectedDeviceManager.on("selectedDeviceChanged",e);const t=this._selectedDeviceManager.selectedDevice("Speaker"),i=this._selectedDeviceManager.selectedDevice("Microphone");e({selectedDeviceType:"Speaker",oldDevice:void 0,newDevice:t}),e({selectedDeviceType:"Microphone",oldDevice:void 0,newDevice:i})}}catch(e){this.logger.warn("Failed to subscribe to selectedDevice changed")}}setLocalVideoStream(e){if(!this._callAgent.tsStack)throw new I({defaultError:f.CALL.VIDEO_UNDEFINED_STACK});if(!this.localVideoStream&&e&&!this._localVideoStreams.find((t=>t===e))){this.localVideoStream=e,this._localVideoStreams.push(this.localVideoStream),"RawMedia"!==this.localVideoStream.mediaStreamType&&this._callAgent.tsStack.getDeviceManager().selectDevices({camera:e.source.id}),this.localVideoStream.addCall(this);try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localVideoStream],removed:[]})}catch(e){this.logger.warn("Application threw on emit localVideoStreamsUpdated added")}this.logger.log("isLocalVideoStarted changed=true"),this._isLocalVideoStarted=!0,this._eventEmitter.emit("isLocalVideoStartedChanged")}}removeLocalVideoStream(e){if(this.localVideoStream&&e===this.localVideoStream&&this.localVideoStreams.find((e=>e===this.localVideoStream))){if(this.logger.log("Attempting to remove local video stream"),0===this._localVideoStreams.splice(this._localVideoStreams.indexOf(this.localVideoStream),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localVideoStreams collection");this.logger.log("Local video stream removed successfully"),this.localVideoStream.removeCall(this),this.localVideoStream.dispose();const t=this.localVideoStream;this.localVideoStream=void 0;try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[t]})}catch(e){this.logger.warn("Application threw on emit localVideoStreamsUpdated removed")}this.logger.log("isLocalVideoStarted changed=false"),this._isLocalVideoStarted=!1,this._eventEmitter.emit("isLocalVideoStartedChanged")}}setLocalAudioStream(e){if(!this._callAgent.tsStack)throw new I({defaultError:f.CALL.LOCAL_AUDIO_UNDEFINED_STACK});if(e)e.on("audioSourceChanged",this.audioSourceChanged),this._localAudioStreams.push(e),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[e],removed:[]});else if(0===this._localAudioStreams.length){if(this._userProvidedLocalAudioStreamCache)return(e=this._userProvidedLocalAudioStreamCache).on("audioSourceChanged",this.audioSourceChanged),this._localAudioStreams.push(e),void this._eventEmitter.emit("localAudioStreamsUpdated",{added:[e],removed:[]});const t=this.deviceManager?.selectedMicrophone;if(t){const e=new Yf(t);e.on("audioSourceChanged",this.audioSourceChanged),this._localAudioStreams.push(e),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[e],removed:[]})}else this.logger.warn("Could not get current selected microphone to update localAudioStreams collection")}else this.logger.warn("No localAudioStream provided and the collection is not empty, doing nothing")}removeLocalAudioStream(e){if(e){if(this.logger.log("Attempting to remove local audio stream"),e.off("audioSourceChanged",this.audioSourceChanged),e.dispose(),0===this._localAudioStreams.splice(this._localAudioStreams.indexOf(e),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localAudioStreams collection");this.logger.log("Local audio stream removed successfully"),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[],removed:[e]})}}_handleAudioEffectsOperations(){try{const e=this._localAudioStreams?.[0];if(!e)return void this.logger.debug("No LocalAudioStream found in the call, cannot handle call audio effects operations");this._audioEffectsStatsListener=e=>{this._audioEffectsProcessorStats=e};const t=e.feature(TC.AudioEffects);t?.on("effectsProcessorStatsUpdated",this._audioEffectsStatsListener)}catch(e){this.logger.warn(`Error handling audio effects operations during call start: ${e}`)}}removeScreenSharingStream(){if(this.localScreenSharingStream&&this.localVideoStreams.find((e=>e===this.localScreenSharingStream))){if(yl()?.calling?.allowAccessRawMediaStream&&"RawMedia"===this.localScreenSharingStream?.mediaStreamType){const e=this._callAgent.tsStack?.getDeviceManager();e?.unsetRawMediaStream&&e.unsetRawMediaStream(2)}this.localScreenSharingStream.dispose(),this.localScreenSharingStream.removeCall(this);const e=this._localVideoStreams.indexOf(this.localScreenSharingStream);this._localVideoStreams.splice(e,1);const t=this.localScreenSharingStream;this.localScreenSharingStream=void 0,this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[t]})}}mapTsCallState(e){let t=Fp[e];switch(t){case"Unknown":case void 0:this.logger.log(`Ignored tsCall state \`${e}\``);break;case"Disconnected":{this._callEndReason=Bp(this).callEndReason,this._remoteParticipants.forEach((e=>{e.setCallEndReason(Hp(this,e.tsRemoteParticipant).callEndReason),e.setParticipantState("Disconnected")}));const i=this._remoteParticipants.map((e=>e));this._remoteParticipants=[],this._mriToRemoteParticipantMap.clear(),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:i}),this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream),this.localAudioStreams[0]&&this.removeLocalAudioStream(this.localAudioStreams[0]),this._rawAudioStreamChangedSubscription?.dispose(),yl().calling.allowAccessRawMediaStream&&this.remoteAudioStreams[0]&&this.removeRemoteAudioStream(this.remoteAudioStreams[0]),this._userProvidedLocalAudioStreamCache=void 0,this.logger.log(`Mapped tsCall state:${e} to ${t}`),this._setCallState(t),this._telemetryLogManager.flushAllEvents(this.id).then((()=>{this.logger.log("Telemetry flushed")})).catch((e=>{this.logger.warn("Failed to flush telemetry log manager events")}));break}case"Connected":this.logger.log(`Mapped tsCall state:${e} to ${t}`),this._remoteParticipantsChangedListeners.forEach((e=>{e.dispose()})),this._setCallState(t),this.setOrUpdateMediaMetricsDeviceEvents(),yl().calling.allowAccessRawMediaStream&&this.subscribeToGetRemoteAudioStream();break;case"Incoming Call":{this.logger.log(`state changed from ${this._state} to 'Incoming Call'`);const e=new Jg(this.tsCall,{config:this._config});__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"state-changed",oldState:this._state,newState:"Incoming Call",callTypeInfo:{initiatorKind:e.initiatorKind,targetKind:e.targetKind,transferor:e.transferorKind,context:e.context,callScenario:e.callScenario,direction:e.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1});break}default:this.logger.log(`Mapped tsCall state:${e} to ${t}`),this._setCallState(t)}}shallStopVideo(e){const t=yl()?.calling?.deviceNotFunctioningMuted,i=yl()?.calling?.deviceCaptureMutedVideo,n=yl()?.calling?.preventStopVideo,r=25===e.type&&3===e.value,s=r&&1===e.mediaType,a=33===e.type&&3===e.value,o=FC(),c="ios"===VC()&&"Safari"===o.engine,l="android"===VC(),d=3===this.tsCall.state;return n?d&&this.tsCall.isVideoOn&&a:t&&d&&this.tsCall.isVideoOn&&(a||c&&r||i&&l&&s)}shallRemoveLocalVideoStreamOnBadUfd(e){const t=this.tsCall.localMediaStreams.find((e=>1===e.mediaType)),i=1===e.mediaType&&3===e.value&&25===e.type,n=4==this.tsCall.state||5===this.tsCall.state;if("Mobile"===FC().formFactor&&(i||"hidden"==document.visibilityState)&&this.localVideoStream&&n&&!t)return!1;if(!yl()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return!1;const r=3===this.tsCall.state;return!(1!==e.mediaType||3!==e.value||33!==e.type&&25!==e.type&&34!==e.type||!this.localVideoStream||r||t)}shallStopAudio(e){const t=yl()?.calling?.deviceNotFunctioningMuted,i=yl()?.calling?.osAutoRecoverAudio,n=25===e.type&&3===e.value&&0===e.mediaType,r=9===e.type&&3===e.value,s=FC(),a="ios"===VC()&&"Safari"===s.engine,o=3===this.tsCall.state;return i?t&&o&&r:t&&!this._isDeviceNotFunctioningMuted&&o&&(r||a&&n)}markCallMuted(){this._isDeviceNotFunctioningMuted=!0,this._handleMuteChanges()}audioDidAutoRecover(e){const t=yl()?.calling?.deviceCaptureMuteRecover&&!yl()?.calling?.preventFakeMute,i=25===e.type&&1===e.value&&0===e.mediaType,n=3===this.tsCall.state,r=FC(),s="ios"===VC()&&"Safari"===r.engine,a=9===e.type&&1===e.value;return t&&this._isDeviceNotFunctioningMuted&&n&&(a||s&&i)}sendParticipantAddedOrRemovedEvent(e){try{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_participant_added_or_removed,tenant:uc,properties:{callId:this.id,remotePerticipantId:Array.isArray(e?.remoteParticipantIds)?e?.remoteParticipantIds.slice(0,yl().telemetry.maxExistingReportedParticipants):[],participantAddedOrRemoved:e.participantAddedOrRemoved,localParticipantId:this.tsCall.participantId,kindOfEvent:e.kindOfEvent,correlationId:e.correlationId||"",timestampInfo:e.timestampInfo||"",additionalDetails:e.additionalDetails||{}}})}catch(e){this.logger.debug("Unable to send participant added telemtery")}}_handleLocalRingingCallState(e){"Connected"===this._state||"Outgoing"!==this._direction||this._localRingingStateSet||this._remoteParticipantsChangedListeners.push(e.changed((()=>{2!==e.state||"Connected"===this._state||this._localRingingStateSet||(this._setCallState("Ringing"),this._localRingingStateSet=!0,this._remoteParticipantsChangedListeners.forEach((e=>{e.dispose()})))})))}_setCallState(e){if(e!==this._state){const t=this._state,i=e,n=new Jg(this.tsCall,{config:this._config});this.logger.log(`state changed from ${t} to ${i}`),this._state=i,this._eventEmitter.emit("stateChanged"),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"state-changed",oldState:t,newState:i,callTypeInfo:{initiatorKind:n.initiatorKind,targetKind:n.targetKind,transferor:n.transferorKind,context:n.context,callScenario:n.callScenario,direction:n.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1,additionalDetails:"Disconnected"===this._state&&this._callEndReason?{...qp(this._callEndReason)}:void 0})}}_setCallRole(e){if(e!==this._lastTsCallAdvancedMeetingRole){let t=Hl(yl(),e);t===Oc?this.logger.log(`tsParticipant advancedMeetingRole=${this._role} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${e}=>${t}`),__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"role-changed",oldAcsRole:this._role,newAcsRole:t,serviceRole:e||""}),this._role!=t&&(this.logger.log(`self-role changed ${this._role}=>${e}`),this._role=t,this._lastTsCallAdvancedMeetingRole=e,this._capabilityResolver.resolveCapabilitiesBasedOnRole(),this._eventEmitter.emit("roleChanged"))}}_setMeetingCapabilities(e){(function(e,t){return!!(e.capabilities&&null!=e.capabilities.allowVideo&&(null==t.capabilities?.allowVideo||t.capabilities.allowVideo!=e.capabilities.allowVideo)||e.meetingCapability&&null!=e.meetingCapability.allowIPVideo&&(null==t.meetingCapability?.allowIPVideo||t.meetingCapability.allowIPVideo!=e.meetingCapability.allowIPVideo)||e.meetingCapability&&null!=e.meetingCapability.attendeeRestrictions&&(null==t.meetingCapability?.attendeeRestrictions||t.meetingCapability.attendeeRestrictions!=e.meetingCapability.attendeeRestrictions)||e.meetingCapability&&null!=e.meetingCapability.allowPstnConferencing&&(null==t.meetingCapability?.allowPstnConferencing||t.meetingCapability.allowPstnConferencing!=e.meetingCapability.allowPstnConferencing)||e.meetingCapability&&null!=e.meetingCapability.allowTranslatedCaptions&&(null==t.meetingCapability?.allowTranslatedCaptions||t.meetingCapability?.allowTranslatedCaptions!=e.meetingCapability.allowTranslatedCaptions)||e.meetingCapability&&null!=e.meetingCapability.allowTranslatedTranscriptions&&(null==t.meetingCapability?.allowTranslatedTranscriptions||t.meetingCapability?.allowTranslatedTranscriptions!=e.meetingCapability.allowTranslatedTranscriptions)||e.meetingCapability&&null!=e.meetingCapability.allowRaiseHands&&(null==t.meetingCapability?.allowRaiseHands||t.meetingCapability?.allowRaiseHands!=e.meetingCapability.allowRaiseHands)||e.meetingCapability&&null!=e.meetingCapability.allowTeamsMeetingReactions&&(null==t.meetingCapability?.allowTeamsMeetingReactions||t.meetingCapability?.allowTeamsMeetingReactions!=e.meetingCapability.allowTeamsMeetingReactions)||e.meetingCapability&&null!=e.meetingCapability.presenterOption&&(null==t.meetingCapability?.presenterOption||t.meetingCapability?.presenterOption!=e.meetingCapability.presenterOption)||e.capabilities&&null!=e.capabilities.maskIdentitiesForRole&&(null==t.capabilities?.maskIdentitiesForRole||t.capabilities?.maskIdentitiesForRole!=e.capabilities.maskIdentitiesForRole))})(e,this._lastTsCallMeetingDetails)&&(__(this._telemetryLogManager,this.logger,{...C_(this,this._callAgent,x(),this._joinContextDescription),step:"meetingCapabilities-changed",oldMeetingDetails:this._lastTsCallMeetingDetails,newMeetingDetails:e}),this.logger.log(`Core Meeting Capabilities has changed to: ${JSON.stringify(e)}`),this._capabilityResolver.resolveCapabilitiesBasedOnMeetingCapabilities(),this._eventEmitter.emit("meetingCapabilitiesChanged")),Object.assign(this._lastTsCallMeetingDetails,e)}async audioSourceChanged(e){this._telemetryLogManager.sendEvent({name:Xu.acs_calling_local_audio_source_changed,tenant:uc,properties:{callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:+new Date,correlationId:x(),localAudioStream:e.source?.source instanceof MediaStream?"MediaStream":"Device"}}),e.source instanceof Gf?(this.localAudioStreams[0]&&"RawMedia"===this.localAudioStreams[0].mediaStreamType&&this.stopAudioInternal(!0),this._callAgent.tsStack?.getDeviceManager().selectDevices({microphone:e.source.id})):await this.startAudioInternal(e.source,!0)}removeRemoteAudioStream(e){if(e){if(this.logger.log("Attempting to remove remote audio stream"),0===this._remoteAudioStreams.splice(this._remoteAudioStreams.indexOf(e),1).length)return void this.logger.warn("Stream not found, failed to remove stream from remoteAudioStreams collection");this.logger.log("remote audio stream removed successfully"),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[e]})}}async setOrUpdateMediaMetricsDeviceEvents(){if(yl().calling.mediaMetricsDeviceEventsEnabled)try{const e=this.tsCall.getMediaSessionStats();if(void 0!==e?.metrics?.DeviceEvents){const t=JSON.parse(e.metrics.DeviceEvents),i=Bl(this._mediaMetricsDeviceEvents||{},t);i.length>0&&(this._mediaMetricsDeviceEvents=t,this.stats.recordEvent({name:Qu.media_metrics_device_events,callId:this.id,localParticipantId:this.tsCall.participantId,data:{metricsDeviceEvents:i||{},metricsDevicesChangeCount:t?.metrics_DevicesChangeCount||0,metricsDevicesCount:t?.metrics_DevicesCount||{}}}))}else this.logger.error("Failed to set media metrics device events telemetry: no valid events data")}catch(e){this.logger.error("Failed to set media metrics device events telemetry")}}setClientEndpointCapabilities(e){const t={};let i=0;return e?.firstPartyOptions?.isImmersiveMode&&(i|=32768),yl()?.calling?.supportLiveStreaming&&(i|=32),i>0&&(t.clientEndpointCapabilities=i),t}getLocalVideoStreamFromCallOptions(e){let t;if(Array.isArray(e?.videoOptions?.localVideoStreams)){if(1!==e?.videoOptions?.localVideoStreams.length)throw new I({defaultError:f.CALL.ONLY_SINGLE_VIDEO_STREAM});if(t=e?.videoOptions?.localVideoStreams[0],!(t instanceof $f))throw new I({defaultError:f.CALL.NOT_INSTANCE_OF_LVS})}return t}getLocalAudioStreamFromCallOptions(e){let t;if(Array.isArray(e?.audioOptions?.localAudioStreams)){if(1!==e?.audioOptions?.localAudioStreams.length)throw new I({defaultError:f.CALL.ONLY_SINGLE_AUDIO_STREAM});if(t=e?.audioOptions?.localAudioStreams[0],!(t instanceof Yf))throw new I({defaultError:f.CALL.NOT_INSTANCE_OF_LAS})}return t&&(this._userProvidedLocalAudioStreamCache=t),t}async _setRawStream(e,t){if(!yl().calling.allowAccessRawMediaStream)throw new I({defaultError:f.CALL.ACCESS_RAW_MEDIA_STREAM_DISABLED});const i=this._callAgent.tsStack?.getDeviceManager();if(!i?.setRawMediaStream)throw new I({defaultError:f.CALL.ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC});try{const n=await e.getMediaStream();if(!n)throw new I({defaultError:f.CALL.SS_RAW_STREAM_UNDEFINED});i.setRawMediaStream(n,t)}catch(e){if(1===t)throw new I({defaultError:f.CALL.VIDEO_SET_MEDIA_STREAM,originalError:e});if(2===t)throw new I({defaultError:f.CALL.SS_RAW_STREAM_SET,originalError:e})}}shallRemoveLvsAfterConnectedSuccessfully(e,t,i,n,r){if(this.tsCall.localMediaStreams.find((e=>1===e.mediaType)))this.sendVideoEvent({correlationId:i,eventName:Xu.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:n-r},localVideoStream:e,step:t,isScreenSharingOnFlag:this._isScreenSharingOn});else{if(!yl()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return;this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream);const n=+new Date,s=new I({defaultError:f.CALL.VIDEO_FAILED_TO_START,defaultErrorMessageArgs:[t]});this.logger.error(s.message),this.sendVideoEvent({correlationId:i,eventName:Xu.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:n-r},localVideoStream:e,step:t,isScreenSharingOnFlag:this._isScreenSharingOn},s)}}shallRemoveLasAfterConnectedSuccessfully(e,t,i,n,r){if(this.tsCall.localMediaStreams.find((e=>0===e.mediaType)))this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,kindOfEvent:Zu.success,localAudioStream:e,timestampInfo:{deltaTimeInMs:n-r},additionalDetails:""});else{if(!yl().calling.removeLocalAudioStreamCheckOnCallStartAndCallAccept)return;this.removeLocalAudioStream(this.localAudioStreams[0]);const n=+new Date;this.logger.error(`Removing local audio stream because audio failed to start during call-${t} process.`);const s=new I({defaultError:f.CALL.AUDIO_FAILED_TO_START,defaultErrorMessageArgs:[t]});this.sendRawMediaEvent({eventName:Xu.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:i,localAudioStream:e,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:n-r},additionalDetails:{failureReason:s.message||"",code:s.code,subCode:s.subCode,...jp(s)}})}}_enableOrDisable_largeMeeting_videoRendering(){try{!this._isHandlingLargeMeetingVideoRendering&&this._totalParticipantCount-1>=yl().rendering.remoteVideo.largeMeeting.participantCountThreshold?(this._isHandlingLargeMeetingVideoRendering=!0,this._internalDominantSpeakersListener=new km(new Nm(this.logger.createChild((()=>`DominanSpeakersFeatureInternal:: Call(id=${this.tsCall.callId})`)))),this._internalDominantSpeakersListener.initialize(this.tsCall,this._callAgent,this._telemetryLogManager,this.logger,!0),this.logger.info("Initialized internal dominant speakers listener"),this._internalDominantSpeakersListener.on("dominantSpeakersChanged",(()=>{this.handleDominantSpeakersVideos()})),this.handleDominantSpeakersVideos(),this.logger.info("Initialized large meeting video rendering handler")):this._isHandlingLargeMeetingVideoRendering&&(this._totalParticipantCount-1>=yl().rendering.remoteVideo.largeMeeting.participantCountThreshold?this.handleDominantSpeakersVideos():(this._isHandlingLargeMeetingVideoRendering=!1,this._internalDominantSpeakersListener?.dispose(),this._internalDominantSpeakersListener=void 0,this.logger.info("Disposed of internal dominant speakers listener"),this.remoteParticipants.forEach((e=>{e.videoStreams.forEach((e=>{e.setIsAvailable(e.tsStream.isAvailable)}))})),this.logger.info("All remote streams isAvailable flags were reset"),this.logger.info("Disposed large meeting video rendering handler")))}catch(e){this.logger.error("Failed to handle large meeting video rendering",e)}}isHiddenBot(e){if(al(e.id)){if(function(e){return!(!e.startsWith(Pc)||e.startsWith(Hc)||e.startsWith(Gc)||e.startsWith($c))}(e.id))return!0;if(yl()?.calling?.blacklistedBots?.includes(e.id))return!0;if(e.endpoints?.endpointDetails&&e.endpoints?.endpointDetails.length>0)return e.endpoints?.endpointDetails[0].endpointMetadata?.__platform?.ui?.hidden}return!1}handleDominantSpeakersVideos(){this.logger.info("Dominant speakers changed during large meeting");const e=this.getTopNDominantSpeakersWithVideoOn();this.logger.info(`There are currently ${e.length} top-n speakers with video on in the large meeting`),e.forEach((e=>{e.videoStreams.filter((e=>"Video"===e.mediaStreamType)).forEach((e=>{e.setIsAvailable(e.tsStream.isAvailable)}))})),this._remoteParticipants.filter((t=>!e.includes(t))).forEach((e=>{e.videoStreams.filter((e=>"Video"===e.mediaStreamType)).forEach((e=>{try{e.setIsAvailable(!1)}catch(e){const t=new I({defaultError:f.CALL.LARGE_MEETING_FORCE_ISAVAILABLE,originalError:e});this.logger.warn(t.message)}const t=this.activeRemoteVideoStreamViews.get(e.id);t&&t.forEach((e=>{try{e.disposed||(e.dispose(qg.Internal_LargeMeetingVideoRendering),this.logger.info("Successfully disposed of view during large meeting"))}catch(e){const t=new I({defaultError:f.CALL.LARGE_MEETING_DISPOSE_VIEW,originalError:e});this.logger.warn(t.message)}}))}))}))}_getReceiveOnlyAudioOnCallStart(e){return"RawMedia"===e?.mediaStreamType&&(this.logger.info("Raw media LocalAudioStream in call options, starting the call as receiveOnlyAudio"),!0)}}T_([Of,I_("design:type",Object)],b_.prototype,"logger",void 0),T_([P(Sg.BindToCall),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",void 0)],b_.prototype,"bindTsCall",null),T_([P(Sg.Feature),I_("design:type",Function),I_("design:paramtypes",[Object]),I_("design:returntype","function"==typeof(E_="undefined"!=typeof TFeature&&TFeature)?E_:Object)],b_.prototype,"feature",null),T_([M(Sg.HangUp),I_("design:type",Function),I_("design:paramtypes",[Object]),I_("design:returntype",Promise)],b_.prototype,"hangUp",null),T_([M(Sg.Mute),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"mute",null),T_([M(Sg.Unmute),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"unmute",null),T_([M(Sg.MuteAllRemoteParticipants),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"muteAllRemoteParticipants",null),T_([M(Sg.MuteIncomingAudio),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"muteIncomingAudio",null),T_([M(Sg.UnmuteIncomingAudio),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"unmuteIncomingAudio",null),T_([M(Sg.SendDtmf),I_("design:type",Function),I_("design:paramtypes",[String]),I_("design:returntype",Promise)],b_.prototype,"sendDtmf",null),T_([M(Sg.StartVideo),I_("design:type",Function),I_("design:paramtypes",[$f]),I_("design:returntype",Promise)],b_.prototype,"startVideo",null),T_([M(Sg.StopVideo),I_("design:type",Function),I_("design:paramtypes",[$f]),I_("design:returntype",Promise)],b_.prototype,"stopVideo",null),T_([M(Sg.startAudio),I_("design:type",Function),I_("design:paramtypes",[Yf]),I_("design:returntype",Promise)],b_.prototype,"startAudio",null),T_([D(Sg.Hold),M(Sg.Hold),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"hold",null),T_([D(Sg.Resume),M(Sg.Resume),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"resume",null),T_([M(Sg.StartScreenShare),I_("design:type",Function),I_("design:paramtypes",[$f]),I_("design:returntype",Promise)],b_.prototype,"startScreenSharing",null),T_([M(Sg.StopScreenShare),I_("design:type",Function),I_("design:paramtypes",[]),I_("design:returntype",Promise)],b_.prototype,"stopScreenSharing",null),T_([M(Sg.SetConstraints),I_("design:type",Function),I_("design:paramtypes",[Object]),I_("design:returntype",Promise)],b_.prototype,"setConstraints",null);var A_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},R_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class w_ extends b_{get info(){return this._info}constructor(t,i,n,r,s){super(t,i,n,r,e.CallKind.Call,s),this._info=new Jg(n,{roomId:t.roomId}),this._info.initialize(this._eventEmitter,this.logger,this._telemetryLogManager)}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(e,t){let i,r;const s=t,a=t,o=t,c=+new Date,l=x();if(this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.attempt,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{attemptTimestamp:c}}),this._callAgent.isCteUser())switch(this.validateThreadId(e,t),n.getIdentifierKind(e).kind){case"communicationUser":r=s.threadId;break;case"microsoftTeamsUser":r=o.threadId;break;case"phoneNumber":r=a.threadId;break;default:{const e=new I({defaultError:f.CALL.ADD_UNKNOWN});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{deltaTimeInMs:+new Date-c},additionalDetails:{code:e.code,failureReason:e.message,...jp(e)}}),e}}let d;a?.alternateCallerId&&(ol(a.alternateCallerId),i=rl(a.alternateCallerId));try{if(d=ol(e),!$l(this.acsProxy,this.acsCustomRelayManager,!1,d))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN})}catch(e){throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{deltaTimeInMs:+new Date-c},additionalDetails:{code:e.code,failureReason:e.message,...jp(e)}}),e}if(this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)))){const t=new I({defaultError:f.CALL.PARTICIPANT_ALREADY_IN_CALL,defaultErrorMessageArgs:[n.getIdentifierKind(e).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{deltaTimeInMs:+new Date-c},additionalDetails:{code:t.code,failureReason:t.message,...jp(t)}}),t}const h=Gl([e]);this._isACSModeledInteropCall=h,yl().calling.enableSmePassFakeConversation&&!r&&e&&h&&(r=this.tsCall.threadId||`${E}${x()}`);const u=this.getOrCreateRemoteParticipant(sl(rl(e)));return this.tsCall.addParticipant(rl(e),{alternateId:i,threadId:r}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.success,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{deltaTimeInMs:+new Date-c}})})).catch((t=>{const{callEndReason:i}=Hp(this,u.tsRemoteParticipant,t);u.callEndReason||u.setCallEndReason(i);const n=qp(i);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:l,timestampInfo:{deltaTimeInMs:+new Date-c},additionalDetails:{code:n?.callEndReason.code,subCode:n?.callEndReason.subCode,failureReason:n?.callEndReason.message,...n}}),this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)))&&(this.deleteRemoteParticipant(u),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[u]}))})),u}async removeParticipant(e,t){const i=+new Date,r=x();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.attempt,participantAddedOrRemoved:"remove",correlationId:r,timestampInfo:{attemptTimestamp:i}});try{ol(e)}catch(e){const t=new I({defaultError:f.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:e});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:r,timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:{code:e.code,failureReason:e.message,...jp(t)}}),t}let s=this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)));if(!s){const t=new I({defaultError:f.CALL.PARTICIPANT_NOT_IN_CALL,defaultErrorMessageArgs:[n.getIdentifierKind(e).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:t.code,subCode:t.subCode,failureReason:t.message,...jp(t)}}),t}try{await this.tsCall.removeParticipant(rl(e)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.success,participantAddedOrRemoved:"remove",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date}})}catch(e){const t=Hp(this,s.tsRemoteParticipant,e).callEndReason;s.callEndReason||s.setCallEndReason(t);const n=qp(t);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:n?.callEndReason.code,subCode:n?.callEndReason.subCode,failureReason:n?.callEndReason.message,...n}}),new I({defaultError:{message:t.message,code:t.code,subCode:t.subCode||0,resultCategories:t.resultCategories},originalError:e})}}validateThreadId(e,t){if(!t?.threadId)throw new I({defaultError:f.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID})}}A_([P(Sg.AddParticipant),R_("design:type",Function),R_("design:paramtypes",[Object,Object]),R_("design:returntype",Object)],w_.prototype,"addParticipant",null),A_([M(Sg.RemoveParticipant),R_("design:type",Function),R_("design:paramtypes",[Object,Object]),R_("design:returntype",Promise)],w_.prototype,"removeParticipant",null);var P_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class M_{get kind(){return this._kind}get id(){return this._callCommon.id}get callerInfo(){return this._callCommon.callerInfo}get callEndReason(){return this._callCommon.callEndReason}get customContext(){return this._customContext}constructor(e,t){this._callCommon=e,this._eventEmitter=new ep.EventEmitter,this._kind=t,this._callConnected="Connected"===this._callCommon.state,this._customContext=ql(this._callCommon.tsCall),this._callCommon.on("stateChanged",(()=>{"Connected"===this._callCommon.state?this._callConnected=!0:"Disconnected"!==this._callCommon.state||this._callConnected||this._eventEmitter.emit("callEnded",{callEndReason:this._callCommon.callEndReason})}))}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}reject(){return this._callCommon.reject()}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([M(),P_("design:type",Function),P_("design:paramtypes",[]),P_("design:returntype",Promise)],M_.prototype,"reject",null);var D_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class O_ extends M_{get info(){return this._call.info}constructor(t){super(t,e.IncomingCallKind.IncomingCall),this._call=t}async accept(e){if("microsoftTeamsUser"===this.info?.initiatorKind&&!$l(this._call.acsProxy,this._call.acsCustomRelayManager,!0))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});return await this._call.accept(e),this._call}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([M(Sg.Accept),D_("design:type",Function),D_("design:paramtypes",[Object]),D_("design:returntype",Promise)],O_.prototype,"accept",null);class k_{constructor(e,t){this.logger=e,this.proxy=t}async sendRequestWithRetry(e,t,i,n,r,s=1,a){if(s>r)throw new Error("Max retry reached");n.timeout||(n.timeout=2e4),n.maxRedirects=0,this.proxy&&(t=this.proxy.proxyfyUrl(t));try{switch(e){case"post":default:return await Ky.post(t,i,n);case"get":return await Ky.get(t,n);case"put":return await Ky.put(t,i,n);case"delete":return await Ky.delete(t,n)}}catch(o){let c=o?.response?.status;this.logger.error(`Found error for request ${e} ${t} ${c||""}`);const l=s+1;if(l<=r){let s=t;if(o&&o.response)if(301===o.response.status||302===o.response.status||303===o.response.status||307===o.response.status||404===o.response.status)s=o.response.headers&&o.response.headers.location?o.response.headers.location:s;else if(o.response.status<500)throw o;return this.logger.error(`Retrying, attempt #${l} url=${s}`),await new Promise((e=>setTimeout(e,a))),this.sendRequestWithRetry(e,s,i,n,r,l,a)}throw o}}}const N_="callNotification",L_="conversationInvitation",x_="debugContent",U_="groupContext";class F_{get callId(){return this._callId}get localParticipantId(){return this._localParticipantId}constructor(e,t,i){if(this._callId="",this._localParticipantId="",this._logger=i.createChild("IncomingCallPushNotificationHandler"),!e.incomingCallContext)throw new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED});if(Object.keys(e).length>1)throw new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_PAYLOAD_TOO_MANY_KEYS});if(this._payload=e,this._incomingCallContext=this._payload.incomingCallContext,this._tsCallRegistry=t,this._gp=JSON.parse(ku.inflate(atob(this._incomingCallContext),{to:"string"})),!(this._gp.hasOwnProperty(N_)&&this._gp.hasOwnProperty(L_)&&this._gp.hasOwnProperty(x_)&&this._gp.hasOwnProperty(U_)))throw this._logger.error(`Missing incoming call context data. Found: ${Object.keys(this._gp)}`),new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD});this._callId=this._gp.debugContent.callId,this._localParticipantId=this._gp.debugContent.participantId}async process(){try{if(this._tsCallRegistry.calls.some((e=>e.callId==this._callId)))throw new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED});const e=Nu(),t=t=>{const i=()=>{t.callId===this._callId&&t.participantId===this._localParticipantId&&1===t.state&&e.resolve()};this._tsCallStateSub=t.on("callStateChanged",i),i()};this._tsCallRegistrySub=this._tsCallRegistry.on("callAdded",t);const i={eventId:107,body:{gp:this._gp}};if(!this._tsCallRegistry.incomingCallMessageHandler.handleMessage(i))throw new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS});setTimeout((()=>{e.isPending()&&e.reject(new I({defaultError:f.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_CALL_MISSED}))}),5e3),await e.promise}catch(e){throw e}finally{this._tsCallRegistrySub?.dispose(),this._tsCallStateSub?.dispose()}}}class V_{constructor(e){this._httpRequestHelper=e,this._isPolicyFetchApplicable=!1,this._policySettingData={},this._threadIdData={};const i=t.createClientLogger("ACS");this._logger=new Uf(i)}initialize(e){this._localParticipant=e.localParticipant,this._skypeToken=e.skypeToken,this._userDialedPstnNumber=e.pstnNumber,this._emergencyNumber=this._userDialedPstnNumber,this._telemetryLogManager=e.telemetryLogManager}async CreateChatThreadId(e,t){this._callId=e;let i="",n="",r={};const s=+new Date;let a=t?.createThreadIdSuffix;this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:a??yl().MiddleTier.serverManagedThreadIdApiConfiguration.createThreadSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:""});const o=this.getAcsMiddletierServiceRequestHeaderForThreadApi();n=0==a?.indexOf("/")?yl().MiddleTier.baseServiceUrl+a:yl().MiddleTier.baseServiceUrl+"/"+a,t?.participants.push({id:this._localParticipant}),r={Participants:t?.participants};try{let e=await this._httpRequestHelper.sendRequestWithRetry("post",n,r,{headers:o},yl().MiddleTier.maxRetry);this._logger.info("Successfully created chat thread using ACS MiddleTier Service."),this._threadIdData=e?.data;const t=+new Date;return this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:a??yl().MiddleTier.serverManagedThreadIdApiConfiguration.createThreadSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:t-s},additionalDetails:{phrase:"Thread Id was successfully created from ACS MiddleTier Service",code:0,subCode:220006}}),Promise.resolve(this._threadIdData.threadId)}catch(e){const t=+new Date;i="Error creating thread Id from ACS MiddleTier Service",this._logger.error(i);const n=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.CREATETHREAD_FAILED});throw this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:a??yl().MiddleTier.serverManagedThreadIdApiConfiguration.createThreadSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-s},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,...jp(n)}}),n}}async AddParticipantsToThread(e,t){this._callId=e;let i="",n={};const r=+new Date;let s=t?.addParticipantsSuffix;this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:s??yl().MiddleTier.serverManagedThreadIdApiConfiguration.addParticipantSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:""});const a=this.getAcsMiddletierServiceRequestHeaderForThreadApi();i=0==s?.indexOf("/")?yl().MiddleTier.baseServiceUrl+s:yl().MiddleTier.baseServiceUrl+"/"+s,n={threadId:t?.threadId,Participants:t?.participants};try{let e=await this._httpRequestHelper.sendRequestWithRetry("post",i,n,{headers:a},yl().MiddleTier.maxRetry);this._logger.info("Call to add participants to chat thread using ACS MiddleTier Service");let t=e?.data;if(null!==t){if(!t.isSuccess)throw new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.ADD_PARTICIPANTS_TO_THREAD_FAILED});t.multipleStatus.length>0&&735==t.multipleStatus[0].statusCode&&this._logger.info("Trying to add the same participant to the thread id")}const o=+new Date;return this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:s??yl().MiddleTier.serverManagedThreadIdApiConfiguration.addParticipantSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:o-r},additionalDetails:{phrase:"Successfully add participants from ACS MiddleTier Service",code:0,subCode:220007}}),Promise.resolve(t.isSuccess)}catch(e){const t=+new Date;this._logger.error("");const i=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.ADD_PARTICIPANTS_TO_THREAD_FAILED});throw this.sendMiddleTierApiEvent({eventName:Xu.acs_calling_middletier_gateway_api,callId:this._callId,suffix:s??yl().MiddleTier.serverManagedThreadIdApiConfiguration.addParticipantSuffix,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-r},additionalDetails:{failureReason:i.message,code:i.code,subCode:i.subCode,...jp(i)}}),i}}async fetchUserPoliciesFromAcsMiddleTier(e,t,i){this._callId=e,this._participantId=t;let n="",r={};const s=+new Date;if(this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:""}),!this._localParticipant){const e=+new Date,t=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.TEAMS_USER_ID_NOT_PROVIDED});throw this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:e-s},additionalDetails:{failureReason:t.message,code:t.code,subCode:t.subCode,...jp(t)}}),t}if(i){let e=i.policyUrlSuffix;n=0==e.indexOf("/")?yl().MiddleTier.baseServiceUrl+e:yl().MiddleTier.baseServiceUrl+"/"+e,r={id:this._localParticipant,userPolicies:i.userPolicies,userProperties:i.userProperties}}else n=yl().MiddleTier.baseServiceUrl+yl().MiddleTier.policyUrlSuffix,r={id:this._localParticipant};const a=this.getAcsMiddletierServiceRequestHeader();try{let e=await this._httpRequestHelper.sendRequestWithRetry("post",n,r,{headers:a},yl().MiddleTier.maxRetry);this._policySettingData=e?.data;const t=+new Date;this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:t-s},additionalDetails:{phrase:"Teams user policy was fetched successfully from ACS MiddleTier Service",code:0,subCode:220004}})}catch(e){const t=+new Date,i=function(e,t){return new I({defaultError:{message:e?.response?.data?.operationFailure?.phrase||t.message,code:e?.response?.data?.operationFailure?.code||t.code,subCode:e?.response?.data?.operationFailure?.subCode||t.subCode,resultCategories:e?.response?.data?.operationFailure?.resultCategories||t.resultCategories},originalError:e})}(e,f.CTE_MID_TIER_POLICY_SERVICE.FETCH_POLICY);throw this._logger.error(i.message),this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-s},additionalDetails:{failureReason:i.message,code:i.code,subCode:i.subCode,...jp(i)}}),i}}isEvEnabled(){let e=this._policySettingData?.userAggregatedPolicySettingData?.userProperties;return e?.evEnabled||!1}isMoHEnabled(){let e=this._policySettingData?.userAggregatedPolicySettingData?.userPolicies?.teamsCallingPolicy,t=e?.musicOnHoldEnabledType;return this._logger.info("Checking Music on Hold Policy, Enabled Type is: "+t),t===(Ng.Enabled||Ng.UserOverride)}getTeamsUserCaptionsPoliciesData(){const e=+new Date;let t="";this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:""});let i=this._policySettingData.userAggregatedPolicySettingData,n=i?.userPolicies,r=i?.userProperties;if(!n?.teamsCallingPolicy){const t=+new Date,i=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-e},additionalDetails:{failureReason:i.message,code:i.code,subCode:i.subCode,...jp(i)}})}if(!n?.teamsMeetingPolicy){const t=+new Date,i=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-e},additionalDetails:{failureReason:i.message,code:i.code,subCode:i.subCode,...jp(i)}})}if(!r?.featureTypes){const t=+new Date,i=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:t-e},additionalDetails:{failureReason:i.message,code:i.code,subCode:i.subCode,...jp(i)}})}if(n?.teamsCallingPolicy||n?.teamsMeetingPolicy||r?.featureTypes?.includes(el.TeamsProMgmt)){t=JSON.stringify({isLiveCaptionsEnabledForCalling:n?.teamsCallingPolicy?.liveCaptionsEnabledTypeForCalling===tl.DisabledUserOverride,isLiveCaptionsEnabledForMeeting:n?.teamsMeetingPolicy?.liveCaptionsEnabledType===tl.DisabledUserOverride,isTeamsProMgmtSkuAvailable:r?.featureTypes?.includes(el.TeamsProMgmt)??!1});const i=+new Date;this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{phrase:"Fetching Captions policy from ACS MiddleTier Service response was successful",code:0}}),this._logger.info(`Fetching user's captions policy content = ${t}`)}return t}getEmergencyContent(){const e=+new Date;this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.attempt,timestampInfo:"",additionalDetails:""});let t="";try{let i=this._policySettingData.userAggregatedPolicySettingData,n=i?.userPolicies,r=!1,s="";if(n?.locationPolicy?.emergencyNumbers){let e=n.locationPolicy.emergencyNumbers||[];this.isPhoneNumberInLocationPolicy(e)&&(r=!0,t=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:i?.userProperties.region,locationPolicyTag:n?.locationPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:n?.teamsEmergencyCallingPolicy?.policyDocument}),s="LocationPolicy")}if(!r&&n?.teamsEmergencyCallRoutingPolicy){let e=n?.teamsEmergencyCallRoutingPolicy?.emergencyNumbers||[];this.isPhoneNumberInTeamsEmergenencyRoutingPolicy(e)&&(r=!0,t=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:i?.userProperties.region,teamsEmergencyCallRoutingPolicyTag:n?.teamsEmergencyCallRoutingPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:n?.teamsEmergencyCallingPolicy?.policyDocument}),s="TeamsEmergencyCallingRoutingPolicy")}const a=r?`Created Emergency policy using ${s}`:"This is NOT an emergency call",o=+new Date;return this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:o-e},additionalDetails:{phrase:"Deriving Emergency policy from ACS MiddleTier Service response was successful",code:0,subCode:220005}}),this._logger.info(`Deriving emergency policy message = ${a}. Emergency Content = ${t}`),t}catch(t){const i=+new Date,n=new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.DERIVE_EMERGENCY_POLICY,originalError:t});throw this.sendMiddleTierPolicyEvent({eventName:Xu.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,...jp(n)}}),n}}isFetchUserPoliciesAndSettingsApplicable(e,t){return pl(e)||pl(t)||(this._isPolicyFetchApplicable=this.verifyFetchUserPoliciesSettings(e,t)),this._isPolicyFetchApplicable}getEmergencyNumber(){return this._emergencyNumber}getUserDialedPstnNumber(){return this._userDialedPstnNumber}getUserPolicy(){return this._policySettingData.userAggregatedPolicySettingData?.userPolicies}isPhoneNumberInLocationPolicy(e){if(!pl(e))for(let t of e)if(t.dialString===this._userDialedPstnNumber||!pl(t.dialMask?.split(";").find((e=>e===this._userDialedPstnNumber))))return this._emergencyNumber=t.dialString,!0;return!1}isPhoneNumberInTeamsEmergenencyRoutingPolicy(e){if(!pl(e))for(let t of e)if(t.emergencyDialString===this._userDialedPstnNumber||!pl(t.emergencyDialMask?.split(";").find((e=>e===this._userDialedPstnNumber))))return this._emergencyNumber=t.emergencyDialString,!0;return!1}verifyFetchUserPoliciesSettings(e,t){let i=yl().MiddleTier;return i.enabled?i.userPolicySettingsApi?e?Array.isArray(t)&&(t.length>1||!n.isPhoneNumberIdentifier(t[0]))?(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):Array.isArray(t)||n.isPhoneNumberIdentifier(t)?(this._logger.info("Teams user is eligible to fetch policies and settings from MiddleTier Service "),!0):(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):(this._logger.info("Originator (Caller) is not a Teams User"),!1):(this._logger.info("ACS MiddleTier Policy API is disabled"),i.userPolicySettingsApi):(this._logger.info("ACS MiddleTier service is disabled"),i.enabled)}isSecurityDeskEnabled(){let e=this._policySettingData.userAggregatedPolicySettingData?.userPolicies?.teamsEmergencyCallingPolicy;return!(pl(e?.notificationGroup)&&pl(e?.notificationDialOutNumber)||0==e?.notificationGroup?.trim().length&&0==e?.notificationDialOutNumber?.trim().length)}getAcsMiddletierServiceRequestHeader(){return{"Content-Type":"application/json","X-Skypetoken":this._skypeToken||"","Access-Control-Allow-Origin":"*","X-Microsoft-Skype-Chain-ID":this._callId}}getAcsMiddletierServiceRequestHeaderForThreadApi(){let e={};return e=this.getAcsMiddletierServiceRequestHeader(),e.onbehalfOfUser=this._localParticipant,e}sendMiddleTierPolicyEvent(e){try{this._telemetryLogManager?.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this._logger.debug("Unable to send AcsMiddleTierPolicyService telemetry")}}sendMiddleTierApiEvent(e){try{this._telemetryLogManager?.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this._logger.debug("Unable to send MiddleTier Api telemetry")}}}var B_,H_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},$_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let G_=1;class j_{get kind(){return this._kind}get connectionState(){return this._connectionState}constructor(e,t,i,n,r,s,a){this._callClient=e,this._disposed=!1,this.tokenProvider=async e=>{if(this._parsedTokenCredential.exp<Date.now()&&!e)throw this.updateConnectionState("tokenExpired"),new I({defaultError:f.CALL_AGENT.ACCESSTOKEN_EXPIRED});if(!this._communicationTokenCredential)throw new I({defaultError:f.CALL_AGENT.GET_TOKEN_BEFORE_INIT});const t=await Ul(this._communicationTokenCredential,yl().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal});return t.acsResourceId===this._parsedTokenCredential?.acsResourceId&&t.identityMri===this._parsedTokenCredential?.identityMri||Ol(f.CALL_AGENT.REFRESHED_TOKEN_INVALID_USERID,this.logger),e?this._tokenFetchTries+=1:this._tokenFetchTries=0,this._tokenFetchTries>this._maxNmberOfRetries&&(this.sendTokenExpiredEvent(),this.updateConnectionState("tokenExpired"),this._disposed||await this.dispose(),Ol(f.CALL_AGENT.REFRESHED_TOKEN_RETRIES,this.logger)),t.jwtToken},this.sendTokenChangedEvent=(e,t)=>{try{this._telemetryLogManager.sendEvent({name:t?Xu.acs_calling_token_expiration_changed:Xu.acs_calling_token_expiration_changed_failure,tenant:uc,properties:{deltaTimeInMs:e}})}catch(e){this.logger.debug("Unable to send token change telemetry")}},this.sendTokenExpiredEvent=()=>{try{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_token_expired,tenant:uc})}catch(e){this.logger.debug("Unable to send token expired telemetry")}},this.logger=t.createChild("CallAgent"+G_++),this._telemetryLogManager=n,this._kind=s,this._connectionState="Connected",this._eventEmitter=new Nm(this.logger),this.clientId=i,this._abortController=new AbortController,this._maxDisplayNameLength=yl()?.calling?.maxDisplayNameLength||256,this._previousTokenExpiration=0,this._tokenFetchTries=0,this._maxNmberOfRetries=yl()?.calling?.maxNumberOfTokenFetchRetries||10,this._callStack=r,this.acsProxy=this._callClient.acsProxy,this.acsCustomRelayManager=this._callClient.acsCustomRelayManager,this._httpRequestHelper=new k_(this.logger,this.acsProxy),this.mtPolicyService=new V_(this._httpRequestHelper),this._parsedTokenCredential={jwtToken:"",acsResourceId:void 0,identityMri:"",cloudType:zo.Public,isCte:!1,region:"",rgnClaimExists:!1,exp:0},this._caConfigBag={clientId:"",acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?ic.Enterprise:ic.Consumer,region:this._parsedTokenCredential.region,emergencyCountryCode:void 0,IsUserEmergencyCountryCode:!1},this.deviceManager=a,this._extensibleApi=new bp(this.logger,{callClient:this._callClient,callAgent:this},{tsStack:this.tsStack,callAgent:this,telemetryLogManager:this._telemetryLogManager});const o=IC(vp.CallAgentFeature);for(const e of o)"OnExtendedObjectConstructor"===e.activationOptions.activationEvent&&this.feature(e);this._trouterStateChangeCallback=e=>{this.logger.log(`Callback Trouter state changed to ${e}`),this.updateConnectionState("trouterChanged")},this._registrarStateChangeCallback=e=>{this.logger.log(`Callback Registrar state changed to ${e}`),this.updateConnectionState("registrarChanged")}}getHttpRequestHelper(){return this._httpRequestHelper}getTrouterState(){return this._callStack?this._callStack.getTrouterState():"Unknown"}onTrouterStateChanged(e){return this._callStack.onTrouterStateChanged(e)}offTrouterStateChanged(e){return this._callStack.offTrouterStateChanged(e)}getAcsResourceId(){return this._parsedTokenCredential?.acsResourceId||""}getUserMri(){return`8:${this._parsedTokenCredential?.identityMri}`||""}getUserPolicy(){return this._userPolicies}async initialize(t,i,n){const r=+new Date;try{if(this.sendCallAgentInitializiedEvent(Xu.acs_calling_call_agent_init_attempt,{attemptTimestamp:r}),this._communicationTokenCredential=t,this._parsedTokenCredential=await Ul(t,yl().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._kind!==e.CallAgentKind.TeamsCallAgent||this._parsedTokenCredential.isCte?this._kind===e.CallAgentKind.CallAgent&&this._parsedTokenCredential.isCte&&Ol(f.CALL_AGENT.ACS_CALLAGENT_TOKEN_ONLY,this.logger):Ol(f.CALL_AGENT.TEAMS_CALLAGENT_TOKEN_ONLY,this.logger),n?.displayName){if(this._parsedTokenCredential.isCte)throw new I({defaultError:f.CALL_AGENT.CTE_DISPLAY_NAME});if(n?.displayName.length>this._maxDisplayNameLength)throw new I({defaultError:f.CALL_AGENT.DISPLAY_NAME_TOO_LONG})}if(this._parsedTokenCredential.cloudType===zo.Public&&(!this._parsedTokenCredential.region||""===this._parsedTokenCredential.region)){try{const e=+new Date-r;this._telemetryLogManager.sendEvent({name:Xu.acs_calling_token_has_no_data_location,tenant:uc,properties:{deltaTimeInMs:e}})}catch(e){this.logger.debug("Unable to send token has no data location assigned")}this._parsedTokenCredential.region=this._parsedTokenCredential.rgnClaimExists?rc[0]:nc[0],this.logger.info("Used default data location because token has no data location assigned")}this._caConfigBag={clientId:this.clientId,acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?ic.Enterprise:ic.Consumer,emergencyCountryCode:n?.emergencyCallOptions?.countryCode,region:this._parsedTokenCredential.region,IsUserEmergencyCountryCode:!!n?.emergencyCallOptions?.countryCode},this.addToCallAgentsMap(this._parsedTokenCredential),this.onDisposedCallback=i;const s=this._communicationTokenCredential.getToken;this._disposed=!1;const a=async e=>{const t=+new Date;try{const i=await s.apply(this._communicationTokenCredential,[e]),n=+new Date;return i.expiresOnTimestamp!==this._previousTokenExpiration&&(this.sendTokenChangedEvent(n-t,!0),this._previousTokenExpiration=i.expiresOnTimestamp),i}catch(e){const i=+new Date;this._previousTokenExpiration=0,this.sendTokenChangedEvent(i-t,!1),Ol(f.CALL_AGENT.FAILED_TO_GET_TOKEN,this.logger)}};t.getToken=a;try{this.runningEnvironmentInfo=await this._callClient.getEnvironmentInfoInternal()}catch(e){this.logger.debug("Unable to get the running environment info")}if(this.tsStack=await this._callStack.initializeStackForUser(this.tokenProvider,this._caConfigBag),this._parsedTokenCredential.rgnClaimExists)try{await this.updateParsedTokenCredentials(t)}catch(e){this.logger.debug(`Failed to update parsed token credentials. Error message = ${e?.message||""}`)}this._telemetryLogManager.initialize(this._caConfigBag),this._tsCallRegistry=await this.initializeCallRegistry(this.tsStack,n),this.registerConnectionStateEventHandlers();const o=+new Date;this.sendCallAgentInitializiedEvent(Xu.acs_calling_call_agent_init_success,{deltaTimeInMs:o-r})}catch(e){this._caConfigBag&&!this._telemetryLogManager.isInitialized()&&this._telemetryLogManager.initialize(this._caConfigBag);const t=new I({defaultError:f.CALL_AGENT.INIT_FAIL,originalError:e});this.removeFromCallAgentsMap(this._parsedTokenCredential);const i=+new Date;throw this.sendCallAgentInitializiedEvent(Xu.acs_calling_call_agent_init_failure,{deltaTimeInMs:i-r},t),this._telemetryLogManager.clearTelemetryLoggers(),t}}isCteUser(){return void 0!==this._parsedTokenCredential?.isCte&&this._parsedTokenCredential?.isCte}getClientId(){return this.clientId}getCallByCallId(e,t){return t?this._tsCallRegistry.getCall(e,t):this._tsCallRegistry.calls.filter((t=>t.callId===e))?.[0]}createTransferTargetCall(e){const t=m.generateCauseId(),i=x(),n=x(),r=this._tsCallRegistry.createCall("",i,n,void 0,t),s=this.createNewCall(i,r);return this.addToCallArray(s),this.handleCallState(s),r.addParticipant(e.targetMri).catch((()=>{this.logger.error("Failed to add participant for transer call")})),s.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[s],removed:[]}),s}getEcsConfigIds(){return this._callStack.getEcsConfigIds()}feature(e){return this._extensibleApi.getApiObjectInstance(e.callAgentApiCtor)}async handlePushNotification(e){const t=x(),i=+new Date;let n;try{if(this.sendHandlePushNotificationEvent({eventName:Xu.acs_calling_handle_push_notification,correlationId:t,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:"",localParticipantId:"",kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),!e.incomingCallContext)throw new I({defaultError:f.CALL_AGENT.INVALID_PUSH_NOTIFICAITON_DATA});n=new F_(e,this._tsCallRegistry,this.logger),await n.process(),this.sendHandlePushNotificationEvent({eventName:Xu.acs_calling_handle_push_notification,correlationId:t,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:n.callId,localParticipantId:n.localParticipantId,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:""})}catch(e){const r=new I({defaultError:f.CALL_AGENT.PUSH_NOTIFICAITON_FAIL,originalError:e});throw this.sendHandlePushNotificationEvent({eventName:Xu.acs_calling_handle_push_notification,correlationId:t,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:n?.callId||"",localParticipantId:n?.localParticipantId||"",kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:{failureReason:r.message,code:r.code,...jp(r)}}),r}}getDeviceType(){const e=this._callClient?.firstPartyOptions?.acsDeviceType;return e?zc[e]:"default"}trackCallEndTimeToStopTelemetry(e){0===e.length?og.callEndTimestamp=Date.now():og.callEndTimestamp=Number.MAX_SAFE_INTEGER}updateConnectionState(e){const t=this.getCallAgentConnectionState(),i=this.getTrouterState(),n=this._callStack?.isRegistered()?"Connected":"Disconnected",r="Connected"===t?void 0:"tokenExpired"==e?"tokenExpired":"signalingIssue";if(t!==this._connectionState||r!==this._connectionStateReason){this.sendCallAgentInfoEvent({eventName:Xu.acs_calling_call_agent,additionalDetails:{step:"connectionState-changed",oldState:this._connectionState,newState:t,trouterState:i,registrarState:n,reason:r}});const e={oldValue:this._connectionState,newValue:t,reason:r};this._connectionState=t,this._connectionStateReason=r,this._eventEmitter.emit("connectionStateChanged",e)}}sendCallAgentInfoEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{...e.additionalDetails}})}catch(e){this.logger.debug("Failed to send connection state changed event",e)}}sendCallAgentInitializiedEvent(e,t,i){try{let n="string"==typeof i?.message?i?.message:void 0;e!==Xu.acs_calling_call_agent_init_failure&&(n=void 0);let r=i?jp(i):void 0;const s=this.getEcsConfigIds();this._telemetryLogManager.sendEvent({name:e,tenant:uc,properties:{...t,isSupportedEnvironment:this.runningEnvironmentInfo?.isSupportedEnvironment,failureReason:n,additionalProperties:{AcsCallingSDKWeb_ecsConfigIds:s.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigIds:s.SkypeWebMedia},additionalInformation:{trouterState:this.getTrouterState()},additionalDetails:{...r}}})}catch(e){this.logger.debug("Unable to send telemtery")}}sendHandlePushNotificationEvent(e){try{this._telemetryLogManager?.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send handle push notification telemetry")}}async initializeCallRegistry(e,t){let i=t?.displayName;const n=await this.getCallRegistry(e,this._parsedTokenCredential,this.tokenProvider,i);return this.logger.info(`registry created for version number=${hl()}`),n}async getCallRegistry(e,t,i,n){const r={id:t.identityMri,displayName:n||"",tokenProvider:i},s=await e.createCallRegistry(r);await s.login(r);const a=yl()?.tsCalling?.accountConfiguration?.ring||void 0,o=t.isCte?ic.Enterprise:ic.Consumer,c=t.acsResourceId,l=t.region;let d={acsResourceId:c,clientType:o,ring:a};yl().calling.setDeviceType&&(d.deviceType=this.getDeviceType());const h=yl().calling.eudb;return h.isEnabled&&h.sendRegionToNgc&&(h.isRgnClaimEnabledForACS||t.isCte)&&(d={...d,region:l}),yl()?.calling.supportLiveStreaming&&(d.clientSupportsUms=!0),s.setConfiguration(d),s.on("callAdded",this.handleCallAdded),s.on("callRemoved",this.handleCallRemoved),n&&s.updateDisplayName(n),s}async updateParsedTokenCredentials(e){this._parsedTokenCredential=await Ul(e,yl().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._caConfigBag.region=this._parsedTokenCredential.region}registerConnectionStateEventHandlers(){this._callStack.onRegisteredChanged(this._registrarStateChangeCallback),this.onTrouterStateChanged(this._trouterStateChangeCallback)}getCallAgentConnectionState(){return this._callStack?.isRegistered()&&"Connected"===this.getTrouterState()?"Connected":this._callStack?.isRegistered()||"Disconnected"!==this.getTrouterState()?"Connecting":"Disconnected"}}H_([Of,$_("design:type",Object)],j_.prototype,"logger",void 0),H_([M(fg.Initialize),$_("design:type",Function),$_("design:paramtypes",[Object,Function,Object]),$_("design:returntype",Promise)],j_.prototype,"initialize",null),H_([P(fg.Feature),$_("design:type",Function),$_("design:paramtypes",[Object]),$_("design:returntype","function"==typeof(B_="undefined"!=typeof TFeature&&TFeature)?B_:Object)],j_.prototype,"feature",null),H_([M(fg.HandlePushNotification),$_("design:type",Function),$_("design:paramtypes",[Object]),$_("design:returntype",Promise)],j_.prototype,"handlePushNotification",null);var q_=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},W_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const z_=new Map;class J_ extends j_{get calls(){return this._calls}constructor(t,i,n,r,s,a,o){super(t,i,r,s,n,e.CallAgentKind.CallAgent,a),this._calls=[],this.handleCallRemoved=e=>{this.logger.info(`removing callId=${e.callId}`);const t=this._calls.find((t=>t.id===e.callId));if(t){const e=this._calls.indexOf(t);-1!==e&&this._calls.splice(e,1),t.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[t]}),this.logger.info("call removed")}},this.handleCallAdded=e=>{if(!this._calls.find((t=>t.id===e.callId))){const t=e.on("callStateChanged",(()=>{if(1===e.state){const i=e.callId;t.dispose();const n=new w_({callId:i,isIncoming:!0},this,e,this._telemetryLogManager),r=new O_(n);this.handleCallState(n),n.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:r})}}))}},this.handleCallState=e=>{e.on("stateChanged",(()=>{try{"Disconnected"===e.state?this.tsStack?(this._tsCallRegistry.deleteCall(e.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${e.id}`),e.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(e.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry"):"Connecting"===e.state&&"Incoming"==e.direction&&(this.addToCallArray(e),this._eventEmitter.emit("callsUpdated",{added:[e],removed:[]}))}catch(e){this.logger.error("Failed to handle call state changed event")}}))},this.displayName=o?.displayName}addToCallAgentsMap(e){z_.get(e?.identityMri)&&Ol(f.CALL_AGENT.ACS_CALLAGENT_ALREADY_EXSISTS,this.logger),z_.set(e?.identityMri,this)}removeFromCallAgentsMap(e){e?.identityMri&&z_.get(e?.identityMri)===this&&z_.delete(e?.identityMri)}async getExistingCallAgentWithToken(e){try{const t=await Ul(e,yl().calling.eudb.isRgnClaimEnabledForACS);return z_.get(t.identityMri)}catch(e){throw new I({defaultError:f.CALL_AGENT.PARSE_ACCESSTOKEN,originalError:e})}}createNewCall(e,t){return new w_({callId:e},this,t,this._telemetryLogManager)}addToCallArray(e){this._calls.push(e),this.trackCallEndTimeToStopTelemetry(this._calls)}startCall(e,t){if(this.assertCallUserIds(e),t?.alternateCallerId&&ol(t.alternateCallerId),e.find((e=>rl(e)===this.getUserMri())))throw new I({defaultError:f.CALL_AGENT.CANT_CALL_YOURSELF});let i=t?.audioOptions?.muted;return void 0===i&&(i=!1),this.logger.info(`startCall with video=${!!t?.videoOptions},muted=${i}`),this.createCall({participants:e,startCallOptions:t})}join(e,t){if(!$l(this.acsProxy,this.acsCustomRelayManager,!1,void 0,e))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});this.assertCallContext(e);let i=t?.audioOptions?.muted;return void 0===i&&(i=!1),this.logger.info(`join with video=${!!t?.videoOptions},muted=${i}`),this.createCall({callContext:e,startCallOptions:t})}async dispose(){if(this._disposed)throw new I({defaultError:f.CALL_AGENT.ACS_ALREADY_DISPOSED});this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&z_.delete(this._parsedTokenCredential?.identityMri);try{const e=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(e))}catch(e){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(e,t){if("incomingCall"!==e&&"callsUpdated"!==e&&"connectionStateChanged"!==e)throw new I({defaultError:f.CALL_AGENT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("incomingCall"!==e&&"callsUpdated"!==e&&"connectionStateChanged"!==e)throw new I({defaultError:f.CALL_AGENT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}createCall(e){if(e?.startCallOptions?.firstPartyOptions?.isImmersiveMode&&"meshV2"!==this.getDeviceType())throw new I({defaultError:f.CALL_AGENT.MESH_DEVICETYPE_V2});let t,i,n,r=e?.callContext?.threadId||e?.startCallOptions?.threadId,s=!1,a=e?.callContext?.groupId;const o=e?.callContext?.roomId,c=e?.callContext?.meetingLink,l=e?.callContext?.meetingId,d=e?.callContext?.passcode||"";if(a&&a.startsWith("19:")&&(r=a,a=""),c)if(xg(c))i=Vg(c);else{if(!Ug(c,this.logger))throw new I({defaultError:f.CALL_AGENT.INVALID_MEETING_LINK});if(Fg(c.trim().toLocaleLowerCase(),yl().calling.tfl.hosts)&&!yl().calling.tfl.isEnabled)throw new I({defaultError:f.CALL_AGENT.UNSUPPORTED_TFL_MEETING_JOIN});s=!0}if(e?.callContext?.threadId&&e?.callContext?.organizerId&&e?.callContext?.tenantId&&(i={threadId:e?.callContext?.threadId,messageId:e?.callContext?.messageId?e?.callContext?.messageId.toString():"0",organizerId:e?.callContext?.organizerId,tenantId:e?.callContext?.tenantId}),i&&(n={meetingType:"0"===i.messageId?1:2,tenantId:i.tenantId,organizerId:i.organizerId,replyChainMessageId:i.messageId}||void 0,r=i.threadId,t=i.messageId),this.tsStack){const i=m.generateCauseId(),h=x(),u=x();let g,p=!1;a?g=this._tsCallRegistry.createCallWithGroupId(a,h,u,i):l?g=this._tsCallRegistry.createCallWithMeetingData({meetingCode:l,passcode:d,threadId:r},h,u,i):o?g=this._tsCallRegistry.createCallWithMeetingData({meetingCode:o},h,u,i):s?g=this._tsCallRegistry.createCallWithMeetingData({meetingUrl:c},h,u,i):(p=!!e?.participants&&e.participants.length>=2&&Gl(e.participants),yl().calling.enableSmePassFakeConversation&&!r&&p&&(r=`${E}${x()}`),g=this._tsCallRegistry.createCall(r||"",h,u,t,i));const f=new w_({callId:h,roomId:o},this,g,this._telemetryLogManager,p);this.addToCallArray(f),this.handleCallState(f);const S={threadId:r||"",messageId:t||"",meetingInfo:n,mediaPeerType:2};return e?.participants&&e?.participants.forEach((e=>{g.addParticipant(rl(e)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),f.startCallInternal(e?.startCallOptions,!!l||!!o,e?.callContext,S).catch(kl),f.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[f],removed:[]}),f}throw new I({defaultError:f.CALL_AGENT.STACK_NOT_INIT})}assertCallContext(e){if(!e||this.checkForAtLeastOneValidCallConfig(e)||this.checkIfMultiplesConfigsWereSpecified(e)||this.checkForInvalidTeamsMeetingCoordinates(e))throw new I({defaultError:f.CALL_AGENT.INVALID_JOIN_LOCATOR})}checkForAtLeastOneValidCallConfig(e){return!(e.threadId||e.meetingLink||e.groupId||e.meetingId||e.roomId)}checkIfMultiplesConfigsWereSpecified(e){return e.threadId&&e.groupId||e.groupId&&e.meetingLink}checkForInvalidTeamsMeetingCoordinates(e){return!e.threadId&&e.tenantId&&e.organizerId||e.threadId&&(e.organizerId&&!e.tenantId||!e.organizerId&&e.tenantId)}assertCallUserIds(e){Ml(e,f.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),Pl(e,f.CALL_AGENT.USERIDS_CANNOT_BE_NULL),function(e){if(!(e instanceof Array))throw new I({defaultError:f.IDENTIFIER.INVALID_IDENTIFIER_ARRAY})}(e),e.forEach((e=>{const t=ol(e);if(!$l(this.acsProxy,this.acsCustomRelayManager,!1,t))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN})}))}}q_([P(fg.StartCall),W_("design:type",Function),W_("design:paramtypes",[Array,Object]),W_("design:returntype",Object)],J_.prototype,"startCall",null),q_([P(fg.Join),W_("design:type",Function),W_("design:paramtypes",[Object,Object]),W_("design:returntype",Object)],J_.prototype,"join",null),q_([M(fg.Dispose),W_("design:type",Function),W_("design:paramtypes",[]),W_("design:returntype",Promise)],J_.prototype,"dispose",null);class K_{constructor(e,t,i){this._configIds={AcsCallingSDKWeb:"",SkypeWebMedia:""},this.setConfigOrDefault=(e,t)=>{e&&Object.keys(e).forEach((i=>{void 0!==e[i]&&(t[i]=e[i])}))},this._logger=e,this.sdkDiagnosticInformation=t,this._acsProxy=i;const n=yl().calling.applicationSettingsUrls;this._trouterSettings={version:`3617/${dl()}`,productName:"AcsWeb",trouterServiceUrl:n.Public_TrouterServiceUrl,registrarServiceUrl:n.Public_RegistrarServiceUrl,maxRegistrationTimeInMs:36e5,pnhAppId:"AcsWeb",pnhTemplate:"AcsWeb_2.0",environment:"Prod",platform:LC()},this._JsCsaConfig={languageCode:"en",emergencyCallCountry:"",autoResolveConflictedCall:!1,handleRosterFromCreateAndJoin:!0,conversationServiceUrl:i.proxyfyUrl(n.Public_ConversationServiceUrl),useInternalHttpDispatcher:!i.hasProxyUrl(),supportsHostlessGroupCalls:!0,doHostlessCalling:!0,shouldServiceSendCallEventMessages:!0,shouldServiceSendNGCUpgradeMessages:!0,supportsCompressedServicePayload:!0,handleNewOfferRequest:!0,handleMediaOfferFromPushNotification:!0,isWebRtcEnabled:!0,supportsSynchronousTrouterResponse:!0,autoJoinOnConflict:!0,brokerEnabledOutgoing:!0,brokerEnabledIncoming:!0,brokerExclusively:!1,brokerRequestBatching:!0,isGVCOutgoingEnabled:!0,isGVCJoiningEnabled:!0,enableTokenCache:!1},this._JamaSettingsMobile={webrtcCameraOpenFs:900,webrtcMultipartyMaxScalingFs:900,webrtcMaxScalingFs:900},this._JamaSettings={debug:!1,numVideoChannelsGvc:6,webcv:null},this._MDNTrapSettings={Service:{url:i.proxyfyUrl(n.Public_MdnTrapServiceUrl),tokenUrl:i.proxyfyUrl(n.Public_MdnTrapServiceTokenUrl)},Relay:{Skype:{addresses:[],fqdns:[n.Public_MdnTrapRelaySkypeFqdns],tcpPort:443,udpPort:3478},Turn:{addresses:[],fqdns:[n.Public_MdnTrapRelayTurnFqdns],tcpPort:443,udpPort:3478,url:n.Public_MdnTrapRelayTurnUrl}},Http:{connectionTimeout:30,requestTimeout:60},Token:{earlyRefreshMinutes:1080,earlyRefreshPercentage:25}},this._TrouterJScriptClient={TelemetryEnabled:!1,ClientTelemetryEventEnabled:{trouter_js_client_connected:!1,trouter_js_client_disconnected:!1,trouter_js_client_error:!1,trouter_js_client_progress:!1,trouter_js_client_response:!1,trouter_js_client_check_connection:!1,trouter_js_client_registration:!1,trouter_js_client_unregistration:!1,logHealthCheckError:!1,logSendPingError:!1,numberOfStepsToMaintain:0,sendProgressTimeoutSecs:0}}}getTrouterTelemetryConfig(){return{enabled:this._TrouterJScriptClient.TelemetryEnabled,...this._TrouterJScriptClient.ClientTelemetryEventEnabled}}getJamaSettings(){const e=FC();let t=this._JamaSettings;return"Mobile"==e.formFactor&&(t={...t,...this._JamaSettingsMobile}),t}getClientInformation(){const e=yl().telemetry.reportSdkUaToService,t=yl().telemetry.reportEnvToService;return`ACSWeb(3617/${dl()})`+(t?`/${function(){const e=FC();return`os=${VC()}; osVer=${BC()}; browser=${e.name}; browserVer=${e.version}; formFactor=${e.formFactor};`}()}`:"")+(e?`/(${this.sdkDiagnosticInformation})`:"")}getJsCsaConfig(){return{...this._JsCsaConfig,clientInformation:this.getClientInformation()}}getMdnTrapSettings(){return this._MDNTrapSettings}getTrouterSettings(){return this._trouterSettings}setConfig(e,t){this._logger.info("Update ECS settings");const i=yl().calling.applicationSettingsUrls,n=yl().calling.applicationSettingsEudbUrls,r=e&&Ll(e.identityType,e.region);if(e?.identityType==ic.Enterprise)r?(this._trouterSettings.trouterServiceUrl=n.Enterprise_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(n.Enterprise_RegistrarServiceUrl_EUDB)):(this._trouterSettings.trouterServiceUrl=i.Enterprise_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(i.Enterprise_RegistrarServiceUrl));else switch(e?.cloudType){case zo.Public:r&&(this._trouterSettings.trouterServiceUrl=n.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(n.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(n.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(n.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(n.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[n.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[n.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=n.Public_MdnTrapRelayTurnUrl_EUDB);break;case zo.GccHigh:this._trouterSettings.trouterServiceUrl=i.GccHigh_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(i.GccHigh_RegistrarServiceUrl);break;case zo.Dod:this._trouterSettings.trouterServiceUrl=i.Dod_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(i.Dod_RegistrarServiceUrl);break;case zo.AirGap08:this._trouterSettings.trouterServiceUrl=i.AirGap08_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(i.AirGap08_RegistrarServiceUrl);break;case zo.AirGap09:this._trouterSettings.trouterServiceUrl=i.AirGap09_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(i.AirGap09_RegistrarServiceUrl)}if(t)this._configIds={AcsCallingSDKWeb:t?.ConfigIDs?.AcsCallingSDKWeb||"",SkypeWebMedia:t?.ConfigIDs?.SkypeWebMedia||""},this.setConfigOrDefault(t?.SkypeCalling,this._JsCsaConfig),this.setConfigOrDefault(t?.MDN_TRAP,this._MDNTrapSettings),this.setConfigOrDefault(t?.SkypeWebMedia?.mediaAgent,this._JamaSettings),this.setConfigOrDefault(t?.TrouterJScriptClient,this._TrouterJScriptClient);else if(e?.identityType===ic.Enterprise)r?(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(n.Enterprise_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(n.Enterprise_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(n.Enterprise_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[n.Enterprise_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[n.Enterprise_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=n.Enterprise_MdnTrapRelayTurnUrl_EUDB):(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(i.Enterprise_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(i.Enterprise_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(i.Enterprise_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[i.Enterprise_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[i.Enterprise_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=i.Enterprise_MdnTrapRelayTurnUrl);else switch(e?.cloudType){case zo.Public:r&&(this._trouterSettings.trouterServiceUrl=n.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(n.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(n.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(n.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(n.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[n.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[n.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=n.Public_MdnTrapRelayTurnUrl_EUDB);break;case zo.GccHigh:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(i.GccHigh_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(i.GccHigh_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(i.GccHigh_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[i.GccHigh_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[i.GccHigh_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=i.GccHigh_MdnTrapRelayTurnUrl;break;case zo.Dod:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(i.Dod_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(i.Dod_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(i.Dod_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[i.Dod_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[i.Dod_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=i.Dod_MdnTrapRelayTurnUrl;break;case zo.AirGap08:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(i.AirGap08_ConversationServiceUrl);break;case zo.AirGap09:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(i.AirGap09_ConversationServiceUrl)}}getConfigIds(){return this._configIds}assertConfigs(e){let t=[];if(e?.SkypeCalling||t.push("SkypeCalling"),e?.MDN_TRAP||t.push("MDN_TRAP"),e?.SkypeWebMedia?e?.SkypeWebMedia?.mediaAgent||t.push("SkypeWebMedia.mediaAgent"):t.push("SkypeWebMedia"),e?.TrouterJScriptClient||t.push("TrouterJScriptClient"),t.length>0){const e=new I({defaultError:f.CALL_STACK.FOUND_UNDEFINED_CONFIGS,defaultErrorMessageArgs:[t.join(", ")]});throw this._logger.error(e.message),e}}}var Y_,Q_=a((function(e,t){var i;i=function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var i={};return t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Timespan=t.toJson=t.fetchWithTimeout=void 0,t.fetchWithTimeout=function(e,t){var i,n=new Promise((function(t,n){fetch(e).then((function(e){void 0!==i&&clearTimeout(i),t(e)})).catch((function(e){void 0!==i&&clearTimeout(i),n(e)}))}));if(0!==t){var r=new Promise((function(n,r){i=setTimeout(r,t,new Error("Fetch for '".concat(e.url,"' timed out")))}));return Promise.race([n,r])}return n},t.toJson=function(e){try{return JSON.stringify(e)}catch(t){return"Unable to serialize object of type ".concat(typeof e)}};var n=function(){function e(){this.start=Date.now()}return Object.defineProperty(e.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this.start=Date.now()},e}();t.Timespan=n},function(e,t,i){var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),s=this&&this.__assign||function(){return s=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},s.apply(this,arguments)},a=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.createRegistrarClient=t.RegistrarClient=void 0;var c=i(0),l=["skype","aad","cae"],d=function(e){function t(t){var i=e.call(this,t)||this;return i.name="CancelationError",i}return r(t,e),t}(Error),h=function(){function e(t,i,n){this.logger=t,this.maxBackoffInMs=i,this.initialDelay=n,this.backoffCount=0,this.id=++e.idCounter}return e.prototype.delay=function(e){var t=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise((function(e,t){t(new d("Cancelled"))}));var i=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off ".concat(e," for ").concat(i," milliseconds with ID ").concat(this.id)),new Promise((function(n,r){t.cancelFunc=r,t.timerHandle=setTimeout((function(){t.logger.info("[RegistrarClient] Back off for ".concat(e," with ID ").concat(t.id," complete")),t.timerHandle=void 0,n()}),i)}))},e.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new d("Cancelled"))),this.backoffCount=-1},e.prototype.calculateNextBackoffMs=function(){var e=1+.4*(Math.random()-.5),t=this.initialDelay*Math.pow(2,this.backoffCount)*e;return t=Math.round(t),Math.min(this.maxBackoffInMs,t)},e.idCounter=0,e}(),u=function(){function e(e,t,i){var n;this.logger=e,this.tokenProvider=t,this.options=i,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===i.maxRetriesForGetToken||null===i.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:i.maxRetriesForGetToken,this.proxyUrlRewrite=null!==(n=i.proxyUrlRewrite)&&void 0!==n?n:function(e){return e}}return e.prototype.setTelemetryLogger=function(e){this.eventLogger=e},e.prototype.register=function(e,t){return a(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.performRegistration(e,t,"pr_set_registration")];case 1:return i.sent(),this.cachedRegistrationParams=[e,t],[2]}}))}))},e.prototype.unregister=function(){return a(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),e=new Request(this.proxyUrlRewrite("".concat(this.options.registrarUrl,"/").concat(this.options.registrationId)),{method:"DELETE",mode:"cors",headers:new Headers(s(s({},this.options.extraRegistrationHeaders),{accept:"application/json, text/javascript"}))}),[4,this.callRegistrar(e,"pr_delete_registration")];case 1:return t.sent(),[2]}}))}))},e.prototype.cancelPendingRequests=function(){var e=this;Object.keys(this.backoffs).forEach((function(t){e.backoffs[t].cancel()})),this.backoffs={}},e.prototype.resendRegistration=function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return e.sent(),[2]}}))}))},e.prototype.performRegistration=function(e,t,i){return a(this,void 0,void 0,(function(){var n,r;return o(this,(function(a){switch(a.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),n={clientDescription:e,registrationId:this.options.registrationId,nodeId:"",transports:t},r=new Request(this.proxyUrlRewrite(this.options.registrarUrl),{method:"POST",mode:"cors",headers:new Headers(s(s({},this.options.extraRegistrationHeaders),{"content-type":"application/json",accept:"application/json, text/javascript"})),body:(0,c.toJson)(n)}),[4,this.callRegistrar(r,i)];case 1:return a.sent(),[2]}}))}))},e.prototype.startBackoff=function(){var e=new h(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[e.id]=e,e},e.prototype.stopBackoff=function(e){e.cancel(),delete this.backoffs[e.id]},e.prototype.getToken=function(e){return a(this,void 0,void 0,(function(){var t,i,n,r,s,a,c;return o(this,(function(o){switch(o.label){case 0:t=this.startBackoff(),i=0,o.label=1;case 1:return o.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new token"),[4,this.tokenProvider({needFresh:!0,supportedTokenTypes:l,wwwAuthenticateHeader:e,purpose:"registrar"})];case 2:return n=o.sent(),this.stopBackoff(t),[2,n];case 3:r=o.sent(),o.label=4;case 4:return o.trys.push([4,6,,7]),i++,s=JSON.stringify(r),i>this.maxRetriesForGetToken?(a="[RegistrarClient] getToken retry limit hit. Will not retry now. Error: ".concat(s),this.logger.error(a),this.stopBackoff(t),[2,Promise.reject(a)]):(this.logger.warn("[RegistrarClient] Retrying for a new token. Retry Count: ".concat(i," Error: ").concat(s)),[4,t.delay("Fetching a new token")]);case 5:return o.sent(),[3,8];case 6:throw c=o.sent(),this.stopBackoff(t),c;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}}))}))},e.prototype.callRegistrar=function(e,t){var i,n,r;return a(this,void 0,void 0,(function(){var s,a,d,h,u,g,p,m,f,S,v,y,C,_,E,T;return o(this,(function(o){switch(o.label){case 0:return s=this.startBackoff(),[4,this.tokenProvider({needFresh:!1,supportedTokenTypes:l,wwwAuthenticateHeader:void 0,purpose:"registrar"})];case 1:a=o.sent(),this.setTokenHeader(e,a),d=new c.Timespan,h=0,o.label=2;case 2:u=void 0,o.label=3;case 3:return o.trys.push([3,10,15,16]),g=e.clone(),[4,(0,c.fetchWithTimeout)(g,this.options.requestTimeoutMs)];case 4:return 401!==(u=o.sent()).status?[3,8]:++h>this.maxRetriesForGetToken?(p="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '".concat(e.url,"' failed with ").concat(u.status," ").concat(u.statusText),this.logger.error(p),this.stopBackoff(s),[2,Promise.reject(p)]):(this.logger.warn("[RegistrarClient] Retry Count ".concat(h,". Request '").concat(e.url,"' failed with ").concat(u.status," ").concat(u.statusText)),m=null!==(n=null===(i=u.headers)||void 0===i?void 0:i.get("www-authenticate"))&&void 0!==n?n:void 0,f=this.setTokenHeader,S=[e],[4,this.getToken(m)]);case 5:return f.apply(this,S.concat([o.sent()])),h>1?[4,s.delay("Registrar call retry after 401")]:[3,7];case 6:o.sent(),o.label=7;case 7:return[3,22];case 8:if(u.status>=500&&u.status<600)throw new Error("Fetch for '".concat(e.url,"' failed with ").concat(u.status," ").concat(u.statusText));o.label=9;case 9:return[3,16];case 10:v=o.sent(),this.logger.error("[RegistrarClient] Request failed with ".concat(v)),o.label=11;case 11:return o.trys.push([11,13,,14]),[4,s.delay("Registrar call retry")];case 12:return o.sent(),[3,22];case 13:throw y=o.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(s),y;case 14:return[3,16];case 15:return this.sendTelemetryEvent(t,e,u,d),[7];case 16:return this.stopBackoff(s),u.ok?[2,u]:[3,17];case 17:C=void 0,o.label=18;case 18:return o.trys.push([18,20,,21]),E=(_=JSON).stringify,[4,u.json()];case 19:return C=E.apply(_,[o.sent()]),[3,21];case 20:return o.sent(),C="no details",[3,21];case 21:throw T="Fetch for '".concat(e.url,"' failed with ").concat(u.status," ").concat(u.statusText," (").concat(C,", MS-CV: ").concat(null===(r=u.headers)||void 0===r?void 0:r.get("MS-CV"),")"),this.logger.error("[RegistrarClient] ".concat(T)),new Error(T);case 22:return[3,2];case 23:return[2]}}))}))},e.prototype.setTokenHeader=function(e,t){switch(e.headers.delete("X-Skypetoken"),e.headers.delete("Authorization"),e.headers.delete("X-MS-Migration"),t.tokenType.toLowerCase()){case"skype":e.headers.set("X-Skypetoken",t.token);break;case"aad":case"cae":e.headers.set("Authorization","Bearer ".concat(t.token));break;default:throw new Error("unsupported token type: ".concat(t.tokenType))}!1===this.options.usingLegacyTokenApi&&e.headers.set("X-MS-Migration","True")},e.prototype.sendTelemetryEvent=function(e,t,i,n){if(void 0!==this.eventLogger){var r={name:e,properties:{url:{value:t.url},result_code:{value:void 0!==i?i.status:0},begin_timestamp:{value:n.startTime},elapsed:{value:n.duration}}};this.eventLogger.logEvent(r)}},e}();t.RegistrarClient=u,t.createRegistrarClient=function(e,t,i){return new u(e,t,i)}}])},e.exports=i()})),X_=a((function(e,t){var i;i=function(e){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var i={};return t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=20)}([function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;var n=function(){function e(e,t){this.name=e,this.logger=t}return e.prototype.debug=function(e){this.logger.debug("[".concat(this.name,"] ").concat(e))},e.prototype.info=function(e){this.logger.info("[".concat(this.name,"] ").concat(e))},e.prototype.warn=function(e){this.logger.warn("[".concat(this.name,"] ").concat(e))},e.prototype.error=function(e){this.logger.error("[".concat(this.name,"] ").concat(e))},e}();t.Logger=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.USER_AUTHENTICATE_EVENT_NAME=t.SUPPORTED_TOKEN_TYPES=t.FAILED_MESSAGE_ACK=t.UNHANDLED_MESSAGE_ACK=t.HANDLED_MESSAGE_ACK=t.CLIENT_VERSION=t.constants=void 0,t.constants={TROUTER_INIT:"trouterinit",TROUTER_READY_EVENT:"trouterReadyEvent",TROUTER_READY_TIMEOUT:"trouterReadyTimeout",TROUTER_TOKEN_REQUEST:"trouterTokenRequest",TROUTER_TOKEN_GET_SUCCEEDED:"trouterTokenGetSucceeded",TROUTER_TOKEN_GET_FAILED:"trouterTokenGetFailed",TROUTER_RECONNECTING:"trouterReconnecting",RENEWAL:"renewal",NEW_CONNECTION:"newConnection",ENDPOINT_REGISTRATION_FAILED:"endpointRegistrationFailed"},t.CLIENT_VERSION="2024.14.01.37",t.HANDLED_MESSAGE_ACK=200,t.UNHANDLED_MESSAGE_ACK=404,t.FAILED_MESSAGE_ACK=500,t.SUPPORTED_TOKEN_TYPES=["skype","aad","cae"],t.USER_AUTHENTICATE_EVENT_NAME="user.authenticate"},function(e,t,i){var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterState=t.UserActivityState=void 0,function(e){e[e.Unknown=0]="Unknown",e[e.Active=1]="Active",e[e.Inactive=2]="Inactive"}(n||(t.UserActivityState=n={})),function(e){e[e.Unknown=0]="Unknown",e[e.Connected=2]="Connected",e[e.Disconnected=3]="Disconnected",e[e.Switching=9]="Switching"}(r||(t.TrouterState=r={}))},function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.Timespan=t.CorrelationVector=t.fetchWithTimeout=t.calculateExpireTsInSec=t.calculateTtlInSec=t.toJson=void 0,t.toJson=function(e){try{return JSON.stringify(e)}catch(t){return"Unable to serialize object of type ".concat(typeof e)}},t.calculateTtlInSec=function(e){var t=Math.round((new Date).getTime()/1e3);return void 0!==e&&e>t?e-t:0},t.calculateExpireTsInSec=function(e){return Math.round((new Date).getTime()/1e3)+e},t.fetchWithTimeout=function(e,t){return n(this,void 0,void 0,(function(){var i,n,s;return r(this,(function(r){return n=new Promise((function(t,n){fetch(e).then((function(e){clearTimeout(i),t(e)})).catch((function(e){clearTimeout(i),n(e)}))})),0!==t?(s=new Promise((function(n,r){var s=new URL(e.url),a=new Error("".concat(e.method," ").concat(s.origin).concat(s.pathname," timed out"));i=setTimeout(r,t,a)})),[2,Promise.race([n,s])]):[2,n]}))}))};var s=function(){function e(e){this.base=void 0!==e?e:this.createCorrelationVectorBase(),this.extension=0}return e.extend=function(t){return new e(t)},e.prototype.increase=function(){this.extension++},e.prototype.value=function(){return"".concat(this.base,".").concat(this.extension)},e.prototype.createCorrelationVectorBase=function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321/+",t="AQgw",i="",n=0;n<21;n++)i+=e.charAt(Math.floor(64*Math.random()));return i+t.charAt(Math.floor(4*Math.random()))},e}();t.CorrelationVector=s;var a=function(){function e(){this.start=Date.now()}return Object.defineProperty(e.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this.start=Date.now()},e}();t.Timespan=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterManagerState=t.UserActivityEventReason=t.ServerState=void 0;var n,r,s=i(3),a=function(){function e(e,t,i,n,r,s,a){this.connectionId=e,this.connectedClientId=t,this.domId=i,this.unsecureUrl=n,this.url=r,this.c2cUrlBase=s,this.expirationTsSec=a}return e.prototype.getRemainingTtlInSec=function(){return(0,s.calculateTtlInSec)(this.expirationTsSec)},e}();t.ServerState=a,function(e){e[e.Unknown=0]="Unknown",e[e.Modified=1]="Modified",e[e.Snapshot=2]="Snapshot",e[e.Connected=3]="Connected"}(n||(t.UserActivityEventReason=n={})),function(e){e[e.Unknown=0]="Unknown",e[e.Connected=2]="Connected",e[e.Disconnected=3]="Disconnected",e[e.Switching=9]="Switching",e[e.TerminalError=10]="TerminalError"}(r||(t.TrouterManagerState=r={}))},function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.redirectUrlIfPresent=t.ensureNumber=t.reconnectParamsWithoutUrls=t.adaptUrl=t.isV4ConnectEvent=t.usedProtocolAfterFallback=t.usedProtocol=void 0,t.usedProtocol=function(e,t){return"skype"===e&&"1"!==function(e){return"string"==typeof e?e:"number"==typeof e?e.toString():void 0}(null==t?void 0:t.scae)?"v4a":"v4c"},t.usedProtocolAfterFallback=function(e,t){return"v4c-websocket-failure"===(null==t?void 0:t.kind)?"v4a":e},t.isV4ConnectEvent=function(e){return Object.prototype.hasOwnProperty.call(e,"connectparams")},t.adaptUrl=function(e,t){return"v4a"===t?e.replace(/\/v4\/c\b/,"/v4/a").replace("wss://","https://").replace("ws://","http://"):e.replace(/\/v4\/a\b/,"/v4/c").replace("https://","wss://").replace("http://","ws://")},t.reconnectParamsWithoutUrls=function(e){if(void 0!==e)return n(n({},e),{reconnectUrl:void 0,serviceUrl:void 0})},t.ensureNumber=function(e){return"string"==typeof e?parseInt(e,10):e},t.redirectUrlIfPresent=function(e){if("redirect"===(null==e?void 0:e.kind)&&void 0!==e.host){var t=e.host;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),t.endsWith("/v4/c")||t.endsWith("/v4/a")||(t+="/v4/c"),t}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterFsm=t.State=void 0;var n,r,s=i(4),a=i(0),o=i(5);!function(e){e[e.Initial=0]="Initial",e[e.RetrievingToken=1]="RetrievingToken",e[e.Allocating=2]="Allocating",e[e.Handshaking=3]="Handshaking",e[e.Connecting=4]="Connecting",e[e.AnonymousConnecting=5]="AnonymousConnecting",e[e.WebsocketAuthenticating=6]="WebsocketAuthenticating",e[e.Connected=7]="Connected",e[e.Unregistering=8]="Unregistering",e[e.TerminalError=9]="TerminalError"}(n||(t.State=n={})),function(e){e[e.Initial=0]="Initial",e[e.Registering=1]="Registering",e[e.RegisteringButResendPending=2]="RegisteringButResendPending",e[e.Retrying=3]="Retrying",e[e.Registered=4]="Registered",e[e.RegistrationDisabled=5]="RegistrationDisabled"}(r||(r={}));var c=function(){function e(e,t,i,s){this.worker=t,this.incallModeEnabled=i,this.protocolSelector=s,this.state=n.Initial,this.autoReconnect=!0,this.logger=new a.Logger("ConnectionFsm",e),this.registrationState=r.Initial}return e.prototype.getState=function(){return this.state},e.prototype.isActive=function(){return this.state===n.Allocating||this.state===n.Connected||this.state===n.Handshaking||this.state===n.Connecting||this.state===n.RetrievingToken||this.state===n.AnonymousConnecting||this.state===n.WebsocketAuthenticating},e.prototype.isConnecting=function(){return this.state===n.Allocating||this.state===n.Handshaking||this.state===n.Connecting||this.state===n.AnonymousConnecting},e.prototype.start=function(){return this.state===n.Initial?(this.setState(n.RetrievingToken),this.worker.getToken(!0,!1,void 0),!0):(this.showIgnored("start"),!1)},e.prototype.stop=function(e,t){e&&(this.registrationState=r.Initial),this.worker.isIncallMode()&&this.worker.exitIncallMode(),this.worker.resetTokenBackoff(),this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.state===n.Connected&&this.worker.sendDisconnectTelemetryEvent("connection stopped"),this.registrationState!==r.Registered&&this.registrationState!==r.Registering&&this.registrationState!==r.RegisteringButResendPending||this.state===n.Unregistering?t?(this.setState(n.TerminalError),this.worker.dispatchTerminalError()):(this.setState(n.Initial),this.worker.dispatchDisconnected()):(this.registrationState=r.Initial,this.setState(n.Unregistering),this.worker.sendUnregisterRequest())},e.prototype.onTokenReceived=function(e,t,i){this.state===n.RetrievingToken?"v4c"===(0,o.usedProtocolAfterFallback)(this.protocolSelector(e.tokenType,i),t)?(this.setState(n.AnonymousConnecting),this.worker.startConnectionTimer(),this.worker.connectV4c(e,t)):(this.setState(n.Allocating),this.worker.startConnectionTimer(),this.worker.sendAllocateRequest(e)):this.showIgnored("onTokenReceived")},e.prototype.checkConnection=function(e){e&&this.onPingInterval()},e.prototype.onAllocationSucceed=function(e){return this.state===n.Allocating&&this.registrationState===r.Registered&&this.worker.dispatchUnregistered(),this.state===n.Allocating?(this.setState(n.Handshaking),this.registrationState=r.Initial,this.worker.startSocketIo(e),!0):(this.showIgnored("onAllocationSucceed"),!1)},e.prototype.onAllocationFailed=function(e,t){this.state===n.Allocating?this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!e,claimsChallenge:t}):this.showIgnored("onAllocationFailed")},e.prototype.onV4cException=function(){this.state!==n.AnonymousConnecting&&this.state!==n.WebsocketAuthenticating||(this.logger.error("v4c exception, falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}}))},e.prototype.onConnectingTimeout=function(){this.state===n.Allocating||this.state===n.Connecting||this.state===n.Handshaking||this.state===n.AnonymousConnecting||this.state===n.WebsocketAuthenticating?this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0}):this.showIgnored("onConnectingTimeout")},e.prototype.onConnecting=function(){this.state===n.Handshaking?this.setState(n.Connecting):this.showIgnored("onConnecting")},e.prototype.onSocketConnect=function(e){this.state===n.AnonymousConnecting?(this.setState(n.WebsocketAuthenticating),this.worker.sendV4cAuthenticationEvent(e)):this.showIgnored("onSocketConnect")},e.prototype.onConnectingFailed=function(){this.state===n.Connecting?this.onConnectingTimeout():this.state===n.Handshaking?(this.logger.error("Unexpected error in Socket.io - no valid transports"),this.onConnectingTimeout()):this.state===n.AnonymousConnecting||this.state===n.WebsocketAuthenticating?(this.logger.info("/v4/c falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}})):this.showIgnored("onConnectingFailed")},e.prototype.onSocketDisconnect=function(e){this.state===n.Handshaking||this.state===n.Connected||this.state===n.WebsocketAuthenticating?(this.state===n.Connected&&this.worker.sendDisconnectTelemetryEvent(null==e?void 0:e.toTelemetryString()),this.state===n.WebsocketAuthenticating&&this.worker.countDisconnectBeforeConnectionEstablishment(),"skypetoken-deprecated"===(null==e?void 0:e.reason)?(this.logger.error("Skypetoken deprecated response, not retrying any further"),this.onTerminalError()):this.cleanUpAndInitiateReconnect({backoff:this.state!==n.Connected&&"dup"!==(null==e?void 0:e.reason),allowCachedToken:"unauthorized"!==(null==e?void 0:e.reason),claimsChallenge:null==e?void 0:e.claims})):this.showIgnored("onSocketDisconnect")},e.prototype.onTrouterConnected=function(){this.state===n.Connecting||this.state===n.WebsocketAuthenticating?(this.setState(n.Connected),this.worker.resetTokenBackoff(),this.worker.stopConnectionTimer(),this.worker.sendUserActivityState(s.UserActivityEventReason.Connected,!0),this.worker.startPingTimer(),this.worker.dispatchConnected(),this.worker.shouldSkipRegistration()?(this.registrationState=r.RegistrationDisabled,this.worker.dispatchRegistered()):(this.registrationState=r.Registering,this.worker.sendRegisterRequest())):this.showIgnored("onTrouterConnected")},e.prototype.onReconnectRequired=function(e,t,i){this.state===n.AnonymousConnecting||this.state===n.WebsocketAuthenticating?void 0===i||"host"!==i.target||void 0===i.url||""===i.url?(this.logger.error("unexpected reconnect arguments: ".concat(null==i?void 0:i.target," ").concat(null==i?void 0:i.url,", reconnecting without cache")),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect-no-host"}})):this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect",host:i.url}}):this.worker.dispatchReconnectIsRequired(e,t)},e.prototype.disableAutoReconnect=function(){this.autoReconnect=!1},e.prototype.onDownstreamRequest=function(e){this.state===n.Connected?(this.switchToIncallModeIfEnabled(),this.worker.dispatchDownstreamRequest(e)):this.showIgnored("onDownstreamRequest")},e.prototype.onTrouterMessageLost=function(e){this.state===n.Connected?this.worker.dispatchTrouterMessageLost(e):this.showIgnored("onTrouterMessageLost")},e.prototype.onPingInterval=function(){this.state===n.Connected?this.worker.sendPingRequest():this.showIgnored("onPingInterval")},e.prototype.onPingResponseTimeout=function(){this.onMissedResponse("onPingResponseTimeout")},e.prototype.onPingResponse=function(){this.state===n.Connected||this.showIgnored("onPingResponse")},e.prototype.onRegistrationFailed=function(){this.state===n.Connected&&this.registrationState===r.Registering?(this.worker.dispatchUnregistered(),this.registrationState=r.Retrying,this.worker.startRegistrationRetryTimer()):this.state===n.Connected&&this.registrationState===r.RegisteringButResendPending?(this.registrationState=r.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationFailed")},e.prototype.onRetryRegistration=function(){this.state===n.Connected&&this.registrationState===r.Retrying?(this.registrationState=r.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRetryRegistration")},e.prototype.onRegistrationSucceeded=function(){this.state===n.Connected&&this.registrationState===r.Registering?(this.registrationState=r.Registered,this.worker.dispatchRegistered(),this.worker.startRegistrationTimer()):this.state===n.Connected&&this.registrationState===r.RegisteringButResendPending?(this.registrationState=r.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationSucceeded")},e.prototype.onRegistrationNearExpiry=function(){this.state===n.Connected&&this.registrationState===r.Registered?(this.registrationState=r.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationNearExpiry")},e.prototype.onUnregistrationDone=function(){this.state===n.Unregistering?(this.setState(n.Initial),this.worker.dispatchUnregistered(),this.worker.dispatchDisconnected()):this.showIgnored("onUnregistrationDone")},e.prototype.onResendRegistration=function(){this.worker.dispatchUnregistered(),this.state===n.Connected&&this.registrationState===r.Registered?(this.registrationState=r.Registering,this.worker.stopRegistrationTimer(),this.worker.sendRegisterRequest()):this.state===n.Connected&&this.registrationState===r.Registering&&(this.registrationState=r.RegisteringButResendPending)},e.prototype.onIncallModeTimer=function(){this.worker.exitIncallMode(),this.state===n.Connected?(this.worker.stopPingTimer(),this.worker.startPingTimer()):this.showIgnored("onIncallModeTimer")},e.prototype.onSetNewUserActivityState=function(){this.worker.sendUserActivityState(s.UserActivityEventReason.Modified,this.state===n.Connected)},e.prototype.onActivityStateResponseTimeout=function(){this.onMissedResponse("onActivityStateResponseTimeout")},e.prototype.forceReconnect=function(e){this.state===n.Connected&&this.worker.sendDisconnectTelemetryEvent(e),this.worker.resetTokenBackoff(),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})},e.prototype.onTerminalError=function(){this.logger.error("Cannot proceed, reached terminal state. Switching from state '".concat(n[this.state],"' to ").concat(n[n.TerminalError])),this.stop(!0,!0),this.setState(n.TerminalError)},e.prototype.onMissedResponse=function(e){this.state===n.Connected?(this.worker.sendDisconnectTelemetryEvent(e),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})):this.showIgnored(e)},e.prototype.showIgnored=function(e){this.logger.debug("Ignoring event '".concat(e,"' in state '").concat(n[this.state],"'"))},e.prototype.setState=function(e){this.logger.info("Switching from state '".concat(n[this.state],"' to state '").concat(n[e],"'")),this.state!==e?this.state=e:this.logger.error("Attempt to switch to the current state '".concat(n[e],"'"))},e.prototype.switchToIncallModeIfEnabled=function(){this.incallModeEnabled&&(this.worker.isIncallMode()||(this.worker.enterIncallMode(),this.worker.stopPingTimer(),this.worker.startPingTimer()),this.worker.restartIncallModeTimer())},e.prototype.cleanUpAndInitiateReconnect=function(e){if(!this.autoReconnect)return this.logger.info("Automatic reconnect is disabled, stopping this connection"),void this.stop(!0);this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.setState(n.RetrievingToken),this.worker.dispatchReconnecting(),this.worker.getToken(e.allowCachedToken,e.backoff,e.claimsChallenge,e.fallbackReason)},e}();t.TrouterFsm=c},function(e,t,i){function n(e,t){var i=t?void 0:{"X-MS-Migration":"True"};switch(e.tokenType.toLowerCase()){case"skype":return a({"X-Skypetoken":e.token},i);case"aad":case"cae":return a({Authorization:"Bearer ".concat(e.token)},i);default:throw new Error("unsupported token type: ".concat(e.tokenType))}}function r(e){return"object"==typeof e&&null!==e&&void 0!==e.stack?(0,h.toJson)(e.stack):'"(no error.stack)"'}function s(e){return"object"==typeof e&&null!==e&&"string"==typeof e.message?e.message:"(no error.message)"}var a=this&&this.__assign||function(){return a=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},a.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},c=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterConnection=t.ReconnectReason=void 0;var l,d=i(21),h=i(3),u=i(15),g=i(1),p=i(16),m=i(17),f=i(2),S=i(4),v=i(0),y=i(5),C=i(6),_=i(12),E=function(){this.cv=g.CLIENT_VERSION,this.ua="",this.hr="",this.v=""},T=function(){function e(){this["force new connection"]=!0,this.reconnect=!1,this.query="",this.ackTimeoutMs=5e3}return e.prototype.rewriteUrlForProxy=function(e){return e},e}(),I="MS-CV",b=function(){function e(e,t){this.logger=t,this.cvCounter=0;var i=JSON.parse(e);this.startTS=this.safeJsonNumber(i,"startTS",0),this.url=this.safeJsonString(i,"url",""),this.shortUrl=this.safeJsonString(i,"shortUrl",""),this.body=this.safeJsonString(i,"body",""),this.headers=this.safeJsonRecord(i,"headers",{}),this.id=this.safeJsonNumber(i,"id",-1),this.method=this.safeJsonString(i,"method",""),this.replied=!1,this.timedout=!1,this.receivedCv=this.headers[I],this.updateCvHeader()}return Object.defineProperty(e.prototype,"correlationVector",{get:function(){return this.receivedCv?"".concat(this.receivedCv,".").concat(this.cvCounter):""},enumerable:!1,configurable:!0}),e.prototype.on=function(e,t){"data"===e?this.dataCallback=t:"end"===e&&("function"==typeof this.dataCallback&&this.dataCallback(this.body),t())},e.prototype.incrementCorrelationVector=function(){++this.cvCounter,this.updateCvHeader()},e.prototype.updateCvHeader=function(){var e=this.correlationVector;e&&(this.headers[I]=e)},e.prototype.safeJsonNumber=function(e,t,i){var n;if(null!=e&&Object.prototype.hasOwnProperty.call(e,t)){var r=e;if("number"==typeof r[t])return r[t];if("string"==typeof r[t])return parseFloat(r[t]);null===(n=this.logger)||void 0===n||n.warn("unexpected type of '".concat(t,"': ").concat(typeof r[t]))}return i},e.prototype.safeJsonString=function(e,t,i){var n;if(null!=e&&Object.prototype.hasOwnProperty.call(e,t)){var r=e;if("string"==typeof r[t])return r[t];null===(n=this.logger)||void 0===n||n.warn("unexpected type of '".concat(t,"': ").concat(typeof r[t]))}return i},e.prototype.safeJsonRecord=function(e,t,i){var n;if(null!=e&&Object.prototype.hasOwnProperty.call(e,t)){var r=e;if("object"==typeof r[t])return r[t];null===(n=this.logger)||void 0===n||n.warn("unexpected type of '".concat(t,"': ").concat(typeof r[t]))}return i},e}(),A=function(){function e(e,t,i){this.request=e,this.responseData=t,this.sendResponse=i}return e.prototype.writeHead=function(e,t){this.responseData.status=e,this.responseData.headers=t},e.prototype.write=function(e){this.responseData.body+=e},e.prototype.end=function(e){return e&&(this.responseData.body+=e),this.sendResponse(this.request,this.responseData)},e}(),R=function(e){this.name=e,this.args={},this.timeoutTimerId=0};!function(e){e[e.Configuration=0]="Configuration",e[e.ServerInitiated=1]="ServerInitiated"}(l||(t.ReconnectReason=l={}));var w=function(){function e(e,t,i,n,r,s,a,o){var c,l=this;this.options=t,this.manager=i,this.tokenProvider=n,this.usingLegacyTokenApi=r,this.protocolSelector=a,this.audienceSubscriptionState=o,this.WEBSOCKET_TRANSPORT_NAME="websocket",this.XHR_POLLING_TRANSPORT_NAME="xhr-polling",this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR="Error",this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED="Unsubscribed",this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT="Timeout",this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST="BadRequest",this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX=/&audienceSubscriptionState=[^&]*|^audienceSubscriptionState=[^&]*&?/,this.connectionId="",this.inIncallMode=!1,this.connectionAttempt=0,this.connectedClientId="",this.isNavigatorOnline=!0,this.onNavigatorOnlineStatusUpdateBound=this.onNavigatorOnlineStatusUpdate.bind(this),this.c2cUrlBase="",this.connectingErrorsInRow=0,this.unauthorizedErrorCount=0,this.pendingSentEventTimers={},this.lastDisconnectReason="",this.UNKNOWN_TRANSPORT="unknown_transport",this.connectingErrorsThreshold=3,this.pendingAudienceSubscription=void 0,this.logger=new v.Logger("Connection",e),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff=new m.ExponentialBackoff(this.logger,this.timeoutOptions.maxBackoffMs),this.clientID=Date.now(),"undefined"!=typeof window&&window.location&&(this.domId=window.location.hostname);var h=new E;h.cv=g.CLIENT_VERSION,h.ua="",(null===(c=this.options)||void 0===c?void 0:c.clientInfo)&&(h.ua=this.safeString(this.options.clientInfo.ua),h.v=this.safeString(this.options.clientInfo.v)),this.clientInfo=h,this.connectionTracker=new u.ConnectionTracker(e,this.clientID,this.clientInfo,(function(){return l.getServerState()}),this.options.endpointId,this.options.clientCorrelationID,this.options.environment),this.applyConnectionTrackerOptions(t);var p=this.options.incallModeTimeoutMs>0;if(this.fsm=new C.TrouterFsm(e,this,p,this.protocolSelector),t.registration){var f={registrarUrl:t.registration.registrarUrl,proxyUrlRewrite:t.rewriteUrlForProxy,registrationId:t.registration.registrationId,requestTimeoutMs:t.timeoutOptions.fetchTimeoutMs,initialRetryDelayMs:1e3,maxRetryDelayMs:t.timeoutOptions.maxBackoffMs,usingLegacyTokenApi:this.usingLegacyTokenApi,maxRetriesForGetToken:t.retryLimitOnTokenFetch,extraRegistrationHeaders:t.extraConnectionHeaders};this.registrarClient=(0,d.createRegistrarClient)(e,this.tokenProvider,f)}this.userActivityState=s}return e.prototype.start=function(e){this.logger.info("Starting"),this.reconnectParams=e,"undefined"!=typeof window&&window.navigator&&window.addEventListener?(this.isNavigatorOnline=window.navigator.onLine,window.addEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.addEventListener("offline",this.onNavigatorOnlineStatusUpdateBound),this.logger.debug("Registered for browser online notifications - current state: ".concat(this.isNavigatorOnline))):this.isNavigatorOnline=!0,this.fsm.start()},e.prototype.stop=function(e){this.logger.info("Stopping"),"undefined"!=typeof window&&window.navigator&&(window.removeEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.removeEventListener("offline",this.onNavigatorOnlineStatusUpdateBound)),this.fsm.stop(e),this.connectionTracker.close()},e.prototype.configure=function(e){var t=this.options.trouterUrl!==e.trouterUrl;this.options=e,this.applyConnectionTrackerOptions(e),t&&(this.logger.info("Configuration changed. Reconnection required."),this.fsm.onReconnectRequired(!1,l.Configuration))},e.prototype.checkConnection=function(e){this.logger.info("checkConnection called with ".concat(e)),this.fsm.checkConnection(e),e&&this.connectionTracker.sendTelemetry(u.ClientEventName.CheckConnection,{disconnectDetected:e},[])},e.prototype.disableRegistrationsAndAutoReconnect=function(){this.stopRegistrationTimer(),this.cancelPendingRegistrationRequests(),this.fsm.disableAutoReconnect()},e.prototype.getServerState=function(){return new S.ServerState(this.connectionId,this.connectedClientId,this.domId?this.domId:"",this.allocateResult?this.allocateResult.url:"",this.allocateResult?this.allocateResult.surl:"",this.c2cUrlBase,this.connectionExpireTimestampInSecs)},e.prototype.getState=function(){return this.fsm.getState()},e.prototype.getToken=function(e,t,i,n,r){var s=this;void 0===r&&(r=0),this.logger.info("Getting token ".concat(t?"with backoff":"without backoff"));var a=function(){s.connectionTracker.trackStart("token");var t={needFresh:!e,wwwAuthenticateHeader:i,supportedTokenTypes:g.SUPPORTED_TOKEN_TYPES,purpose:"trouter"};s.logger.info("Requesting token: needFresh=".concat(t.needFresh," ")+"types=[".concat(g.SUPPORTED_TOKEN_TYPES,"], ")+"wwwAuthenticateHeader is ".concat(t.wwwAuthenticateHeader?"non empty":"empty")),s.tokenProvider(t).then((function(e){s.logger.debug("".concat(e.tokenType," token is received")),s.connectionTracker.trackEnd("token"),s.fsm.onTokenReceived(e,n,s.reconnectParams)})).catch((function(t){var a=(0,h.toJson)(t.stack);if(s.logger.error("Getting token failed, will retry after timeout. Error: ".concat(a)),s.connectionTracker.trackError("token",a),!s.canRetryTokenFetchRequest(r+s.unauthorizedErrorCount))return s.connectionTracker.trackError("token","getToken retry limit hit, reached terminal error state"),s.resetTokenBackoff(),void s.fsm.onTerminalError();s.getToken(e,!0,i,n,r+1)}))};t?this.tokenBackoff.backoff("getting token",a):(this.resetTokenBackoff(),a())},e.prototype.startConnectionTimer=function(){var e=this;this.stopConnectionTimer(),this.logger.debug("Starting connection timeout for ".concat(this.timeoutOptions.connectionTimeoutMs," ms")),this.connectionTimeoutId=setTimeout((function(){e.logger.info("Connection timeout is fired"),e.fsm.onConnectingTimeout()}),this.timeoutOptions.connectionTimeoutMs)},e.prototype.stopConnectionTimer=function(){this.connectionTimeoutId&&(this.logger.debug("Stopping connection timeout"),clearTimeout(this.connectionTimeoutId),this.connectionTimeoutId=void 0)},e.prototype.startPingTimer=function(){var e=this;"websocket"===this.transportTypeName?(this.logger.debug("Starting ping timeout for ".concat(this.timeoutOptions.pingTimeoutMs," ms")),this.pingTimerId=setInterval((function(){e.logger.info("Ping interval fired"),e.fsm.onPingInterval()}),this.timeoutOptions.pingTimeoutMs)):this.logger.debug("Not starting ping for transport ".concat(this.transportTypeName))},e.prototype.stopPingTimer=function(){this.pingTimerId&&(this.logger.debug("Stopping ping timeout"),this.clearPingResponseTimer(),clearInterval(this.pingTimerId),this.pingTimerId=void 0)},e.prototype.shouldSkipRegistration=function(){return void 0===this.options.registration},e.prototype.hasCustomRegistrationTtl=function(){var e,t;return void 0!==(null===(e=this.options.registration)||void 0===e?void 0:e.registrarTtlSec)&&0!==(null===(t=this.options.registration)||void 0===t?void 0:t.registrarTtlSec)},e.prototype.startRegistrationTimer=function(){var e=this;this.stopRegistrationTimer();var t=this.getRegistrationTtl(),i=t[0],n=t[1];if(i<=30||!n)return this.logger.debug("Starting registration expiration timer (TTL ".concat(i," sec)")),void(this.registrationTimerId=setTimeout((function(){e.registrationTimerId=void 0,e.logger.warn("Registration expired but the connection is still alive. Should never happen"),e.dispatchUnregistered()}),1e3*i));var r=i-30;this.logger.debug("Starting registration extension timer for ".concat(r," sec")),this.registrationTimerId=setTimeout((function(){e.logger.info("Registration extension timer fired"),e.registrationTimerId=setTimeout((function(){e.registrationTimerId=void 0,e.logger.debug("Registration extension did not happen in time"),e.dispatchUnregistered()}),3e4),e.fsm.onRegistrationNearExpiry()}),1e3*r)},e.prototype.startRegistrationRetryTimer=function(){var e=this;this.stopRegistrationTimer(),this.registrationTimerId=setTimeout((function(){e.registrationTimerId=void 0,e.fsm.onRetryRegistration()}),123e3)},e.prototype.stopRegistrationTimer=function(){this.registrationTimerId&&(this.logger.debug("Stopping registration timeout"),clearTimeout(this.registrationTimerId),this.registrationTimerId=void 0)},e.prototype.resendRegistration=function(){if(!this.registrarClient)throw new Error("Trouter Client not configured to handle registrations");return this.fsm.onResendRegistration(),Promise.resolve()},e.prototype.buildSocketIoUrlParams=function(e,t){if(!this.allocateResult)throw new Error("Allocate result is undefined in buildSocketIoUrlParams()");for(var i={},n=this.allocateResult.connectparams,r=0,s=Object.keys(n);r<s.length;r++){var a=s[r];if(void 0!==n[a]){var o=n[a];"string"==typeof o||"number"==typeof o?i[a]=o:this.logger.error("signatureData[".concat(a,"] has unsupported type ").concat(typeof o))}}return i.v="v4",i.tc=encodeURI((0,h.toJson)(this.clientInfo)),i.timeout=this.timeoutOptions.pingTimeoutMs/1e3,i.auth="true",this.options.endpointId&&(i.epid=this.options.endpointId),e&&(i.userActivity=encodeURI((0,h.toJson)(e))),t&&(i.audienceSubscriptionState=encodeURIComponent((0,h.toJson)(t))),this.appendConnectedClientIds(this.buildQuery(i),!0)},e.prototype.startSocketIo=function(e){var t,i;if(this.logger.debug("Starting socket io"),this.connectionTracker.trackStart("connectSocket"),!this.allocateResult)throw new Error("Allocate result is undefined in startSocketIo()");var r=this.options.ioOptions?a({},this.options.ioOptions):new T,s=this.userActivityState.state!==f.UserActivityState.Unknown?this.userActivityState.increaseCvAndGetEventObject():void 0,o=null===(t=this.audienceSubscriptionState)||void 0===t?void 0:t.increaseCvAndGetEventObject();if(r["force new connection"]=!0,r.reconnect=!1,r.rewriteUrlForProxy=this.options.rewriteUrlForProxy,r.requestHeaders=a(a({},this.options.extraConnectionHeaders),n(e,this.usingLegacyTokenApi)),r.query=this.buildSocketIoUrlParams(s,o),this.logger.info("connecting to ".concat(this.allocateResult.socketio,"?").concat(r.query)),this.stopSocketIo(),this.socket=(null!==(i=this.options.io)&&void 0!==i?i:_).connect(this.allocateResult.socketio,r),void 0===this.socket)throw new Error("Can't create Socket.io object");this.attachSocketIoHandlers(this.socket,e,s,o)},e.prototype.stopSocketIo=function(){if(this.socket){this.logger.debug("clearing socket.io");try{for(var e=0,t=["connecting","connect","connect_failed","close_during_connecting","disconnect","reconnect","reconnect_failed","reconnecting","error","message","trouter.connected","trouter.reconnect","trouter.message_loss"];e<t.length;e++){var i=t[e];this.socket.removeAllListeners(i)}this.socket.disconnect(),this.logger.debug("cleared socket"),this.socket=void 0}catch(e){this.logger.error("exception in disconnecting previous socket. Error: ".concat(r(e)))}}},e.prototype.dispatchConnected=function(){this.logger.info("dispatching connected"),this.manager.onConnected(this)},e.prototype.dispatchRegistered=function(){this.logger.info("dispatching registered"),this.manager.onRegistered(this)},e.prototype.dispatchUnregistered=function(){this.logger.info("dispatching unregistered"),this.manager.onUnregistered(this)},e.prototype.dispatchDownstreamRequest=function(e){var t=this;this.logger.debug("dispatching downstream request");try{var i=new A(e,new u.ResponseData(e.id),(function(e,i){return t.logger.debug("sending response to downstream"),t.sendResponse(e,i)}));this.manager.onDownstreamRequest(this,e,i)}catch(e){this.logger.error("exception in socket.on message. Error : ".concat(r(e)))}},e.prototype.dispatchReconnecting=function(){this.logger.info("dispatching reconnecting"),this.manager.onReconnecting(this)},e.prototype.dispatchReconnectIsRequired=function(e,t){this.logger.info("dispatching reconnect is required by server"),this.manager.onReconnectIsRequired(this,e,t)},e.prototype.dispatchDisconnected=function(){this.logger.info("dispatching disconnected"),this.manager.onDisconnected(this)},e.prototype.dispatchTerminalError=function(){this.logger.info("dispatching terminal error"),this.manager.onTerminalError(this)},e.prototype.dispatchTrouterMessageLost=function(e){this.logger.info("dispatching trouter message lost"),this.manager.onTrouterMessageLost(e)},e.prototype.countDisconnectBeforeConnectionEstablishment=function(){this.logger.warn("counting disconnect before connection was fully established as a connection failure"),++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold()},e.prototype.sendProcessedDroppedIndicators=function(e){var t=this;try{this.logger.debug("emitting processed flow tags to the server");var i=new R("trouter.processed_message_loss");i.args={droppedIndicators:e},this.sendDownstreamEvent(i,(function(){t.logger.info("emitted processed flow tags to the server")}))}catch(e){var n=r(e);this.logger.error("unable to send processed message loss event. Error: ".concat(n)),this.connectionTracker.trackError("trouter.processed_message_loss",n,!1)}},e.prototype.sendAllocateRequest=function(e){var t=this;this.connectionAttempt++,this.connectionTracker.trackNewConnection();var i,r=this.options.trouterUrl,s=this.reconnectParams,o="string"==typeof(null==s?void 0:s.se)?parseInt(s.se,10):"number"==typeof(null==s?void 0:s.se)?s.se:void 0;o&&o<=Date.now()+36e5&&(this.logger.warn("Dropping expired cached connection parameters: ".concat(new Date(o))),this.reconnectParams=s=void 0),s&&s.serviceUrl!==r&&(this.logger.warn("Dropping cached connection parameters for a different environment (".concat(s.serviceUrl,", now ").concat(r,")")),this.reconnectParams=s=void 0),(null==s?void 0:s.reconnectUrl)&&(r=s.reconnectUrl),i=s?a(a({},s),{serviceUrl:void 0,reconnectUrl:void 0}):null,r=(0,y.adaptUrl)(r,"v4a"),r=this.appendCorrelationIds(r,!1),r=this.appendEndpointId(r,!1),i&&(r+="&".concat(this.buildQuery(i)),i.v||(r+="&v=".concat("v4"))),r=this.options.rewriteUrlForProxy(r);var c=new Request(r,{method:"POST",mode:"cors",headers:new Headers(a(a({"Content-Type":"text/plain"},this.options.extraConnectionHeaders),n(e,this.usingLegacyTokenApi)))});this.logger.info("sendAllocateRequest: POST ".concat(r)),this.connectionTracker.trackStart("allocation");var l,d=Date.now(),u=-1,g=!1;(0,h.fetchWithTimeout)(c,this.timeoutOptions.fetchTimeoutMs).then((function(e){var i;if(u=e.status,!e.ok)throw l=null!==(i=e.headers.get("www-authenticate"))&&void 0!==i?i:void 0,g="1"===e.headers.get("x-trouter-skypetoken-deprecated"),t.logger.warn("Allocation request got response status ".concat(e.status,", www-authenticate header was ").concat(l?"not empty":"empty")),new Error(e.statusText);var n=e.headers.get("content-type");if(!n||"application/json"!==n&&!n.startsWith("application/json;"))throw new Error("Content-type '".concat(n,"' is unexpected"));return t.connectionTracker.trackEnd("allocation"),e.json()})).then((function(i){t.unauthorizedErrorCount=0,t.onAllocationResponse(i,e)})).catch((function(e){t.connectingErrorsInRow++;var i="".concat(e).concat(u>=0?", status code ".concat(u):"");if(t.logger.error("".concat(t.connectingErrorsInRow," failed connecting attempt(s) in a row. ").concat(i)),t.connectionTracker.trackError("allocation",i),g){var n="Skypetoken deprecated response, not retrying any further";return t.logger.error(n),t.connectionTracker.trackError("allocation",n),void t.fsm.onTerminalError()}if(401===u&&t.unauthorizedErrorCount++,!t.canRetryTokenFetchRequest(t.unauthorizedErrorCount))return n="getToken retry limit hit, reached terminal error state",t.connectionTracker.trackError("allocation",n),void t.fsm.onTerminalError();if(-1!==u||t.isNavigatorOnline){if(t.reconnectParams&&t.connectingErrorsInRow>=t.connectingErrorsThreshold)if(u>=400&&u<=599)t.resetReconnectParamsOnErrorThreshold();else if(t.reconnectParams.reconnectUrl&&t.connectingErrorsInRow%3==0){t.logger.warn("".concat(t.connectingErrorsInRow," connection attempts, testing nominal service URL"));var r=Math.min(t.timeoutOptions.connectionTimeoutMs-(Date.now()-d)-500,t.timeoutOptions.fetchTimeoutMs);return void t.testNominalUrlConnectivity(r).then((function(e){t.connectionTracker.trackProgress("nomcheck",e?"ok":"failed"),e?(t.logger.warn("Nominal service URL is reachable, erasing cached reconnect URL"),t.reconnectParams&&delete t.reconnectParams.reconnectUrl):t.logger.warn("Nominal service URL is not reachable either, keeping cached reconnect URL"),t.fsm.onAllocationFailed(!1,void 0)}),(function(){t.fsm.onAllocationFailed(!1,void 0)}))}}else t.logger.info("Expected failure, the browser says it is not online at the moment");t.fsm.onAllocationFailed(401===u,l)}))},e.prototype.testNominalUrlConnectivity=function(e){var t,i=this;if(e<1e3)return this.logger.warn("There is no time left to reasonably perform the nominal service URL connectivity check (".concat(e," ms), falling back to assuming that the connectivity is fine")),Promise.resolve(!0);try{var n=new URL(this.options.trouterUrl);n.pathname="/",n.search="?"+this.buildQuery({check:Date.now(),cor_id:encodeURIComponent(this.options.clientCorrelationID),epid:encodeURIComponent(this.options.endpointId?this.options.endpointId:""),tc:encodeURIComponent((0,h.toJson)(this.clientInfo))}),t=new Request(this.options.rewriteUrlForProxy(n.toString()),{method:"GET",headers:{Accept:"text/plain"}})}catch(e){return this.logger.warn("Nominal service URL connectivity test request could not be created (".concat(e,"), falling back to assuming that the connectivity is fine")),Promise.resolve(!0)}return(0,h.fetchWithTimeout)(t,e).then((function(e){if(200!==e.status)throw new Error("Not 200 OK: ".concat(e.status," ").concat(e.statusText));return e.text()})).then((function(e){if("Trouter"!==e)throw new Error('Not "Trouter": '.concat(e.substring(0,16)).concat(e.length>16?"...":""));return!0})).catch((function(e){return i.logger.error("Nominal service URL connectivity test failed: ".concat(e)),!1}))},e.prototype.sendPingRequest=function(){var e=this;if(this.socket&&void 0===this.pingResponseTimerId)try{this.logger.debug("emitting ping event");var t=!1;this.socket.emit("ping",(function(){!0!==t&&e.onPingResponse()})),this.pingResponseTimerId=setTimeout((function(){e.logger.error("Ping response timeout is fired"),t=!0,e.clearPingResponseTimer(),e.fsm.onPingResponseTimeout()}),this.timeoutOptions.pongTimeoutMs)}catch(e){var i=r(e);this.logger.error("unable to send ping. Error: ".concat(i)),this.connectionTracker.trackError("ping",i,!1)}},e.prototype.connectV4c=function(e,t){var i,n,r,s,o,c,l=this.options.ioOptions?a({},this.options.ioOptions):new T;l["force new connection"]=!0,l.reconnect=!1,(null===(i=this.reconnectParams)||void 0===i?void 0:i.serviceUrl)&&(0,y.adaptUrl)(this.reconnectParams.serviceUrl,"v4c")!==(0,y.adaptUrl)(this.options.trouterUrl,"v4c")&&(this.logger.warn("Dropping cached connection parameters for a different environment (".concat(this.reconnectParams.serviceUrl,", now ").concat(this.options.trouterUrl,")")),this.reconnectParams=void 0);var d=null!==(s=null!==(n=(0,y.redirectUrlIfPresent)(t))&&void 0!==n?n:"redirect-no-host"!==(null==t?void 0:t.kind)?null===(r=this.reconnectParams)||void 0===r?void 0:r.reconnectUrl:void 0)&&void 0!==s?s:this.options.trouterUrl,h=(0,y.adaptUrl)(d,"v4c");l["skipped handshake data"]={timeout:70,websocketUrl:h},l.query=this.buildV4cUrlParams(),l.rewriteUrlForProxy=this.options.rewriteUrlForProxy;try{if(this.stopSocketIo(),this.transportTypeName="websocket",this.socket=(null!==(o=this.options.io)&&void 0!==o?o:_).connect(this.options.trouterUrl,l),void 0===this.socket)throw new Error("failed to create Socket.io object");var u=null===(c=this.audienceSubscriptionState)||void 0===c?void 0:c.increaseCvAndGetEventObject();this.attachSocketIoHandlers(this.socket,e,void 0,u)}catch(e){this.logger.error("".concat(e)),this.connectionTracker.trackError("v4c","".concat(e)),this.fsm.onV4cException()}},e.prototype.sendV4cAuthenticationEvent=function(e){var t,i={headers:a(a({},this.options.extraConnectionHeaders),n(e,this.usingLegacyTokenApi)),connectparams:(0,y.reconnectParamsWithoutUrls)(this.reconnectParams)};null===(t=this.socket)||void 0===t||t.emit(g.USER_AUTHENTICATE_EVENT_NAME,i)},e.prototype.setUserActivityState=function(e){var t=e.state!==this.userActivityState.state;this.userActivityState=e,t?(this.logger.info("Changing user activity state to '".concat(e.toEventJSON(),"'")),this.fsm.onSetNewUserActivityState()):(this.logger.debug("Not changing the same user activity state '".concat(e.toEventJSON(),"'")),this.manager.onUserActivityStateAccepted(e.correlationVector.value()))},e.prototype.sendUserActivityState=function(e,t){this.userActivityState.state!==f.UserActivityState.Unknown&&("websocket"===this.transportTypeName&&t?e===S.UserActivityEventReason.Connected?this.sendUserActivityStateMultiple(2):this.sendUserActivityStateMultiple(1):"xhr-polling"===this.transportTypeName&&e===S.UserActivityEventReason.Modified&&this.fsm.forceReconnect("user activity/force reconnect"))},e.prototype.setAudienceSubscriptionsAsync=function(e,t){var i=this.audienceSubscriptionState;if(this.audienceSubscriptionState=e,this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME)return this.setAudienceSubscriptionsInternalAsync(e.increaseCvAndGetEventObject(),t);if(this.transportTypeName===this.XHR_POLLING_TRANSPORT_NAME){var n=this.setAudienceSubscriptionsLongpollInternalAsync(e.increaseCvAndGetEventObject(),t,i);return this.fsm.forceReconnect("set audience subscription force reconnect"),n}throw new Error("set audience subscription executed on an unknown transport")},e.prototype.setAudienceSubscriptionsUnsafeAsync=function(e){if(e)return this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?this.setAudienceSubscriptionsInternalAsync(e,15e3):void 0},e.prototype.setAudienceSubscriptionsInternalAsync=function(e,t){return o(this,void 0,void 0,(function(){var i,n,r=this;return c(this,(function(s){switch(s.label){case 0:return this.logger.info("[WebSocket] Audience subscription set requested."),(i=new R("audience.subscribe")).args=e,[4,new Promise((function(n){var s=!1,a=setTimeout((function(){return s=!0,n(r.buildAudienceSubscriptionsTimeoutResponse(e))}),t);r.sendDownstreamEvent(i,(function(e,t){s||(clearTimeout(a),r.logger.debug("[Websocket] Audience subscription response: ".concat(t)),r.pendingAudienceSubscription&&r.onAudienceSubscriptionResult(t),n(t))}))}))];case 1:return n=s.sent(),this.manager.onAudiencesSetResolved(n,e.cv),[2,n]}}))}))},e.prototype.setAudienceSubscriptionsLongpollInternalAsync=function(e,t,i){var n;return o(this,void 0,void 0,(function(){var r,s,a,o,l,d,h=this;return c(this,(function(c){switch(c.label){case 0:return this.logger.info("[XHR Polling] Audience subscription set requested."),this.pendingAudienceSubscription&&(this.logger.error("Racing audience subscriptions occured. This situation resolves into undefined scenario and/or nasal demons."),clearTimeout(this.pendingAudienceSubscription.timeoutId)),0===e.audiences.length?[2,this.handleAudienceUnsubscribeLongpoll(e.cv,i)]:[4,new Promise((function(i){var n=setTimeout((function(){return h.pendingAudienceSubscription=void 0,i(h.buildAudienceSubscriptionsTimeoutResponse(e))}),t);h.pendingAudienceSubscription={audienceSetResolve:i,timeoutId:n}}))];case 1:return r=c.sent(),this.manager.getState()===f.TrouterState.Unknown||this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?[2,r]:(null==(s=r.responses[0])?void 0:s.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(r,e.cv),[2,r]):(a=r.responses.find((function(t){return t.audienceId===e.audiences[0].id})),(null==a?void 0:a.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(r,e.cv),[2,r]):(o=(null===(n=null==i?void 0:i.audienceSubscriptionModel.audienceSubscriptions[0])||void 0===n?void 0:n.id)!==(null==s?void 0:s.audienceId),i&&o&&(l=this.mapToSyntheticAudienceSubscriptionResponses(i.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200),(d=r.responses).push.apply(d,l)),this.manager.onAudiencesSetResolved(r,e.cv),[2,r]))}}))}))},e.prototype.clearAudienceSubscriptionStateQueryParam=function(){var e,t,i;(null===(i=null===(t=null===(e=this.socket)||void 0===e?void 0:e.socket)||void 0===t?void 0:t.options)||void 0===i?void 0:i.query)&&(this.socket.socket.options.query=this.socket.socket.options.query.replace(this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX,""))},e.prototype.handleAudienceUnsubscribeLongpoll=function(e,t){var i;this.audienceSubscriptionState=void 0;var n={responses:[]};if(t){var r=this.mapToSyntheticAudienceSubscriptionResponses(t.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200);(i=n.responses).push.apply(i,r)}return this.manager.onAudiencesSetResolved(n,e),n},e.prototype.buildAudienceSubscriptionsTimeoutResponse=function(e){return this.logger.error("Audience subscription attempt has timed out."),{responses:this.mapToSyntheticAudienceSubscriptionResponses(e.audiences,this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT)}},e.prototype.mapToSyntheticAudienceSubscriptionResponses=function(e,t,i){return e.map((function(e){return{audienceId:e.id,result:{audienceSubscriptionState:t,responseStatus:i}}}))},e.prototype.expediteBackoff=function(){this.tokenBackoff.expediteIfPending()},e.prototype.sendRegisterRequest=function(){var e=this;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");if(!this.allocateResult)throw new Error("Allocate result is undefined in sendRegisterRequest()");this.logger.info("sending register request");var t=new h.Timespan;this.connectionTracker.trackStart("registration");var i=this.getRegistrationTtl()[0];this.registrarClient.register({appId:this.options.registration.pnhAppId,aesKey:"",languageId:"en-US",platform:this.options.registration.platform,templateKey:this.options.registration.pnhTemplateKey,platformUIVersion:this.options.registration.platformUIVersion,productContext:this.options.registration.productContext},{TROUTER:[{context:this.options.registration.context,path:this.allocateResult.surl,ttl:i}]}).then((function(){e.logger.info("Register request successful"),e.connectionTracker.trackEnd("registration"),e.fsm.onRegistrationSucceeded(),e.connectionTracker.sendTelemetry(u.ClientEventName.Registration,{duration:t.duration},[])})).catch((function(i){e.logger.error("Register request failed. Error: ".concat(i)),e.connectionTracker.trackError("registration",s(i)),e.fsm.onRegistrationFailed(),e.connectionTracker.sendTelemetry(u.ClientEventName.Registration,{duration:t.duration},[])}))},e.prototype.sendUnregisterRequest=function(){var e=this;this.logger.info("sending unregister request");var t=new h.Timespan;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");this.connectionTracker.trackStart("unregistration"),this.registrarClient.unregister().then((function(){e.logger.info("Unregister request successful"),e.connectionTracker.trackEnd("unregistration"),e.fsm.onUnregistrationDone(),e.connectionTracker.sendTelemetry(u.ClientEventName.Unregistration,{duration:t.duration},[])})).catch((function(i){e.logger.error("Unregister request failed. Error: ".concat(i)),e.connectionTracker.trackError("unregistration",s(i)),e.fsm.onUnregistrationDone(),e.connectionTracker.sendTelemetry(u.ClientEventName.Unregistration,{duration:t.duration},[])}))},e.prototype.resetTokenBackoff=function(){this.tokenBackoff.reset()},e.prototype.cancelPendingRegistrationRequests=function(){this.registrarClient&&this.registrarClient.cancelPendingRequests()},e.prototype.clearSentEventTimers=function(){var e=Object.keys(this.pendingSentEventTimers);if(e.length>0){this.logger.debug("Clearing all pending downstream events related timers");for(var t=0,i=e;t<i.length;t++){var n=i[t];this.clearSentEventTimer(Number(n))}}},e.prototype.restartIncallModeTimer=function(){var e=this;this.clearIncallModeTimerId(),this.logger.debug("Restarting incall mode timer"),this.incallModeTimerId=setTimeout((function(){e.logger.info("Call mode timer fired"),e.fsm.onIncallModeTimer()}),this.options.incallModeTimeoutMs)},e.prototype.enterIncallMode=function(){this.logger.info("Entering incall mode"),this.timeoutOptions=this.options.incallTimeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!0},e.prototype.exitIncallMode=function(){this.logger.info("Exiting incall mode"),this.clearIncallModeTimerId(),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!1},e.prototype.isIncallMode=function(){return this.inIncallMode},e.prototype.sendDisconnectTelemetryEvent=function(e){var t={reason:e,serverClosed:!this.fsm.isActive()};this.connectionTracker.trackDisconnected(t),this.connectionTracker.clearConnectedInfo()},e.prototype.forceReconnectDueToNoRegistration=function(){this.fsm.forceReconnect("force reconnect due to no registration")},e.prototype.resetReconnectParamsOnErrorThreshold=function(){this.logger.warn("".concat(this.connectingErrorsInRow," connection attempts, server-side failure: erasing cached connection parameters")),this.reconnectParams=void 0},e.prototype.onSocketConnecting=function(e){this.logger.info("onSocketConnecting(".concat(e,")")),this.transportTypeName=e,this.connectionTracker.trackProgress("connecting",this.transportTypeName),this.fsm.onConnecting()},e.prototype.onSocketConnect=function(e){this.logger.info("onSocketConnect"),this.fsm.onSocketConnect(e)},e.prototype.onSocketConnectFailed=function(e){this.logger.error("onSocketConnectFailed"),this.connectionTracker.trackError("connect_failed",e,!0,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),this.fsm.onConnectingFailed()},e.prototype.onSocketDisconnect=function(e){var t=this.connectionTracker.getSessionLength()||0,i=p.DisconnectReason.fromRawReason(e);this.logger.error("onSocketDisconnect, reason: ".concat(i.reason)),"dup"===i.reason&&"dup"===this.lastDisconnectReason&&t<this.options.duplicateDisconnectThresholdMs&&(this.logger.warn("Socket was closed by server as Duplicate for the second time in a row "+"after ".concat(t," ms which is below the threshold of ")+"".concat(this.options.duplicateDisconnectThresholdMs," ms. Resetting cached ")+"connection parameters and making a new allocation."),this.reconnectParams=void 0),this.lastDisconnectReason=i.reason,this.fsm.onSocketDisconnect(i),this.connectionExpireTimestampInSecs=void 0},e.prototype.onSocketReconnect=function(){this.logger.error("onSocketReconnect"),this.fsm.onTrouterConnected()},e.prototype.onSocketReconnectFailed=function(e){this.logger.error("onSocketReconnectFailed with '".concat(e,"'")),this.fsm.onSocketDisconnect(p.DisconnectReason.fromSocketIoEventData("reconnecterror",e))},e.prototype.onSocketReconnecting=function(){this.logger.error("onSocketReconnecting")},e.prototype.onSocketError=function(e){this.logger.error("onSocketError with '".concat((0,h.toJson)(e),"'")),this.fsm.isConnecting()&&++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold(),this.connectionTracker.trackError("connectSocket",function(e){return null!=e&&"function"==typeof e.toString?e.toString():"[".concat(typeof e,"]")}(e)),this.fsm.onSocketDisconnect(p.DisconnectReason.fromSocketIoEventData("socketerror",e))},e.prototype.onSocketMessage=function(e){var t,i,n=this;this.logger.debug("onSocketMessage");try{var a=null===(t=(i=new b(e,this.logger)).headers)||void 0===t?void 0:t["X-Microsoft-Skype-Chain-ID"],o=a?" Chain-Id ".concat(a):"";this.logger.info("Received request N ".concat(i.id).concat(o," CV ").concat(i.correlationVector," to '").concat(i.url,"'")),i.startTS=Date.now(),i.url&&this.urlPath&&i.url.startsWith(this.urlPath)&&(i.shortUrl=i.url.substring(this.urlPath.length))}catch(e){var c=r(e);return this.logger.error("unable to parse request. Error: ".concat(c)),this.connectionTracker.trackRequest(void 0,c),void this.connectionTracker.sendResponseError("unable to parse request, error: ".concat(e))}i.timeoutTimerId=setTimeout((function(){if(!i.replied){n.logger.error("Request ".concat(i.id," timed out"));var e=new u.ResponseData(i.id);e.status=504,e.headers={"Trouter-Responder":"ClientLib"},n.sendResponse(i,e),i.timedout=!0}}),this.timeoutOptions.requestTimeoutMs);try{this.connectionTracker.trackRequest(i),this.fsm.onDownstreamRequest(i)}catch(e){this.logger.error("exception in socket.on message. Error: ".concat(r(e))),this.connectionTracker.sendResponseError(s(e),i,void 0)}},e.prototype.onTrouterConnected=function(e,t,i){var n,r,s,o,c=this;if((0,y.isV4ConnectEvent)(e)){var l=e;this.allocateResult=a(a({},l),{ttl:e.ttl.toString()}),this.populateAndCacheReconnectParams(l,l.reconnectUrl),this.populateConnectionStateFields(l)}else if(!this.allocateResult)return void this.logger.error("Invalid internal state - received onTrouterConnected while allocateResult is not set");this.connectingErrorsInRow=0,this.logger.info("onTrouterConnected: ".concat(this.allocateResult.url)),"xhr-polling"===this.transportTypeName&&t&&this.manager.onUserActivityStateAccepted(t.cv),(null===(s=null===(r=null===(n=this.socket)||void 0===n?void 0:n.socket)||void 0===r?void 0:r.options)||void 0===s?void 0:s.query)&&(this.socket.socket.options.query+="&connected=true"),this.urlPath=this.allocateResult.url.replace(/https?:\/\/([A-z0-9\:\$\-\_\.\+\!\*\"\(\)\,]*)\//,"/");var d=this.connectedUrl!==this.allocateResult.url;this.connectedUrl=this.allocateResult.url,this.connectionExpireTimestampInSecs=(0,h.calculateExpireTsInSec)((0,y.ensureNumber)(e.ttl)),this.connectionTracker.trackEnd("connectSocket"),this.connectionTracker.trackConnected(d,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),null===(o=this.setAudienceSubscriptionsUnsafeAsync(i))||void 0===o||o.catch((function(e){return c.logger.error("Re-subscribe to audiences has failed with ".concat(e))})),this.fsm.onTrouterConnected()},e.prototype.onTrouterReconnect=function(e){var t=e.target;this.logger.info("onTrouterReconnect target: ".concat(t)),"self"===t?this.fsm.onReconnectRequired(!0,l.ServerInitiated):this.fsm.onReconnectRequired(!1,l.ServerInitiated,e)},e.prototype.onTrouterMessageLoss=function(e){this.logger.debug("onTrouterMessageLoss"),this.fsm.onTrouterMessageLost(e.droppedIndicators)},e.prototype.onAudienceSubscriptionResult=function(e){this.logger.info("onAudienceSubscriptionResult"),this.pendingAudienceSubscription&&(clearTimeout(this.pendingAudienceSubscription.timeoutId),this.pendingAudienceSubscription.audienceSetResolve(e),this.pendingAudienceSubscription=void 0)},e.prototype.buildV4cUrlParams=function(){var e={};return e.tc=encodeURI((0,h.toJson)(this.clientInfo)),e.timeout=Math.floor(this.timeoutOptions.pingTimeoutMs/1e3),this.options.endpointId&&(e.epid=this.options.endpointId),this.appendConnectedClientIds(this.buildQuery(e),!0)},e.prototype.attachSocketIoHandlers=function(e,t,i,n){var r=this;e.on("connecting",(function(e){r.onSocketConnecting(e)})),e.on("connect",(function(){r.onSocketConnect(t)})),e.on("connect_failed",(function(e){r.onSocketConnectFailed(e)})),e.on("close_during_connecting",(function(e){r.onSocketConnectFailed(e)})),e.on("disconnect",(function(e){r.onSocketDisconnect(e)})),e.on("reconnect",(function(){r.onSocketReconnect()})),e.on("reconnect_failed",(function(e){r.onSocketReconnectFailed(e)})),e.on("reconnecting",(function(){r.onSocketReconnecting()})),e.on("error",(function(e){r.onSocketError(e)})),e.on("message",(function(e){r.onSocketMessage(e)})),e.on("trouter.connected",(function(e){r.onTrouterConnected(e,i,n)})),e.on("trouter.reconnect",(function(e){r.onTrouterReconnect(e)})),e.on("trouter.message_loss",(function(e){r.onTrouterMessageLoss(e)})),e.on("audience.subscriptionresult",(function(e,t){r.onAudienceSubscriptionResult(t)}))},e.prototype.onNavigatorOnlineStatusUpdate=function(){var e=window.navigator.onLine;this.logger.debug("Browser online status update - new state: ".concat(e,", previously: ").concat(this.isNavigatorOnline)),e&&!this.isNavigatorOnline?(this.isNavigatorOnline=!0,this.tokenBackoff.expediteIfPending(),this.connectionTracker.trackProgress("browserNet","online")):!e&&this.isNavigatorOnline&&(this.isNavigatorOnline=!1,this.connectionTracker.trackProgress("browserNet","offline"))},e.prototype.onAllocationResponse=function(e,t){this.logger.info("Received allocation response ".concat(JSON.stringify(e))),this.allocateResult=e,this.populateAndCacheReconnectParams(this.allocateResult,"".concat(this.allocateResult.socketio,"v4/a")),this.populateConnectionStateFields(this.allocateResult),this.fsm.onAllocationSucceed(t)},e.prototype.populateAndCacheReconnectParams=function(e,t){this.reconnectParams=a({serviceUrl:this.options.trouterUrl,reconnectUrl:t},e.connectparams),this.manager.onConnectionParametersUpdated(this.reconnectParams)},e.prototype.populateConnectionStateFields=function(e){var t,i,n="string"==typeof e.ttl?parseInt(e.ttl,10):e.ttl;if(this.connectionExpireTimestampInSecs=(0,h.calculateExpireTsInSec)(n),this.connectionId=null!==(t=e.id)&&void 0!==t?t:"",this.connectedClientId=e.ccid,this.logger.debug("connected client id set {connectedClientId:".concat(this.connectedClientId,"}")),this.c2cUrlBase=null!==(i=e.curlb)&&void 0!==i?i:"",""===this.c2cUrlBase){var r=e.surl.indexOf("://");r>=0&&(r=e.surl.indexOf("/",r+3))>=5&&":3443"===e.surl.substr(r-5,5)&&(this.c2cUrlBase=e.surl.substr(0,r-5))}},e.prototype.onPingResponse=function(){this.logger.debug("onPingResponse"),this.connectionTracker.increasePingResponseCount(),this.clearPingResponseTimer(),this.fsm.onPingResponse()},e.prototype.clearPingResponseTimer=function(){void 0!==this.pingResponseTimerId&&(clearTimeout(this.pingResponseTimerId),this.pingResponseTimerId=void 0)},e.prototype.buildQuery=function(e){for(var t=[],i=0,n=Object.keys(e);i<n.length;i++){var r=n[i];void 0!==e[r]&&t.push("".concat(r,"=").concat(e[r]))}return t.join("&")},e.prototype.appendConnectedClientIds=function(e,t){var i="";e.includes("ccid=")||(i="ccid=".concat(this.connectedClientId,"&")),this.domId&&(i+="dom=".concat(this.domId,"&")),i.length>0&&(i=i.slice(0,-1));var n=t||e.includes("?")?"&":"?";return this.appendCorrelationIds(e+n+i,t)},e.prototype.appendEndpointId=function(e,t){var i=t||e.includes("?")?"&":"?";return!e.includes("epid")&&this.options.endpointId?"".concat(e).concat(i,"epid=").concat(this.options.endpointId):e},e.prototype.appendCorrelationIds=function(e,t){var i=t||e.includes("?")?"&":"?";return e.includes("cor_id")?e:"".concat(e).concat(i,"cor_id=").concat(this.options.clientCorrelationID)+"&con_num=".concat(this.clientID,"_").concat(this.connectionAttempt)},e.prototype.safeString=function(e){return"string"==typeof e?e:""},e.prototype.sendResponse=function(e,t){var i,n,s;if(e.timedout)return this.logger.error("Request ".concat(e.id," already timed out")),1;if(e.replied)return this.logger.error("Response for request ".concat(e.id," already sent")),2;clearTimeout(e.timeoutTimerId),e.timeoutTimerId=void 0,e.replied=!0,t.headers=null!==(i=t.headers)&&void 0!==i?i:{};var a=e.correlationVector;this.logger.info("Sending response N ".concat(e.id," CV ").concat(a," with status ").concat(t.status)),a&&(t.headers[I]=a),(null===(n=e.headers)||void 0===n?void 0:n["trouter-request"])&&(t.headers["trouter-request"]=e.headers["trouter-request"]);var o=Date.now()-e.startTS;if(t.headers["trouter-client"]=(0,h.toJson)({cd:o}),(null===(s=e.headers)||void 0===s?void 0:s["trouter-is-broadcast"])&&(t.headers["trouter-is-broadcast"]=e.headers["trouter-is-broadcast"]),this.logger.debug("response: ".concat((0,h.toJson)(t))),!this.socket)return this.connectionTracker.sendResponseError("no socket",e,t),4;try{return this.socket.send((0,h.toJson)(t)),t.sentTS=Date.now(),e.incrementCorrelationVector(),this.connectionTracker.trackResponse(e,o,t),"websocket"===this.transportTypeName&&this.sendPingRequest(),0}catch(i){var c="unable to send data on response.end. Error: ".concat(r(i));return this.logger.error(c),this.connectionTracker.sendResponseError(c,e,t),4}},e.prototype.sendUserActivityStateMultiple=function(e){var t=this,i=new R("user.activity"),n=this.userActivityState.increaseCvAndGetEventObject();i.args=n,this.logger.debug("Sending user activity '".concat(this.userActivityState.toEventJSON(),"', remaining ").concat(e-1));var r=!1;this.sendDownstreamEvent(i,(function(){if(!0!==r&&(t.logger.info("User activity state: ".concat(n.state,", cv: ").concat(n.cv," accepted")),t.manager.onUserActivityStateAccepted(n.cv),t.clearSentEventTimer(i.timeoutTimerId),e>1)){var s=setTimeout((function(){t.clearSentEventTimer(s),t.sendUserActivityStateMultiple(e-1)}),t.options.userActivitySecondResendDelayMs);t.registerSentEventTimer(s,"user.activity/resend")}})),i.timeoutTimerId=setTimeout((function(){t.logger.error("Activity state response timeout is fired"),r=!0,t.fsm.onActivityStateResponseTimeout(),t.clearSentEventTimer(i.timeoutTimerId)}),this.timeoutOptions.userActivityResponseTimeoutMs),this.registerSentEventTimer(i.timeoutTimerId,"user.activity/response")},e.prototype.sendDownstreamEvent=function(e,t){this.logger.debug("Sending downstream event ".concat(e.name)),this.socket&&this.socket.emit(e.name,e.args,t)},e.prototype.registerSentEventTimer=function(e,t){this.logger.debug("registering timer ".concat(e," -> ").concat(t)),this.pendingSentEventTimers[e]=t},e.prototype.clearSentEventTimer=function(e){var t=this.pendingSentEventTimers[e];this.logger.debug("clearing timer ".concat(e," -> ").concat(t)),delete this.pendingSentEventTimers[e],clearTimeout(e)},e.prototype.getRegistrationTtl=function(){var e,t,i=(0,h.calculateTtlInSec)(this.connectionExpireTimestampInSecs);if(this.logger.debug("Current connectionID will expire in ".concat(i," seconds")),(null===(e=this.options.registration)||void 0===e?void 0:e.registrarTtlSec)&&i>0){var n=this.options.registration.registrarTtlSec<i;return[Math.min(this.options.registration.registrarTtlSec,i),n]}return(null===(t=this.options.registration)||void 0===t?void 0:t.registrarTtlSec)?[this.options.registration.registrarTtlSec,!1]:i>0?[i,!1]:[3600,!1]},e.prototype.clearIncallModeTimerId=function(){void 0!==this.incallModeTimerId&&(this.logger.debug("Clearing in-call mode timer"),clearTimeout(this.incallModeTimerId),this.incallModeTimerId=void 0)},e.prototype.applyConnectionTrackerOptions=function(e){try{e.eventLogger&&"function"==typeof e.eventLogger.logEvent?(this.connectionTracker.mergeSettings(e.telemetrySettings),this.connectionTracker.enable(e.eventLogger)):this.logger.warn("Trouter client event logging disabled due to invalid configuration.")}catch(e){this.logger.warn("Trouter client event logging disabled. Error: ".concat(r(e))),this.connectionTracker.disable()}},e.prototype.canRetryTokenFetchRequest=function(e){var t=this.options.retryLimitOnTokenFetch;return null==t||e<t||(this.logger.warn("Reached limit on maximum number of token fetch request. Current count: ".concat(e,", retry limit: ").concat(t)),!1)},e}();t.TrouterConnection=w},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MessageHandlerRegistry=void 0;var n=i(1),r=i(0),s=function(){function e(e){this.messageHandlers=[],this.logger=new r.Logger("MessageHandlers",e)}return e.prototype.register=function(e){if(this.messageHandlers.some((function(t){return t===e})))throw new Error("Registering the same handler twice is not allowed");this.messageHandlers.push(e)},e.prototype.clear=function(){this.logger.debug("Clearing message handlers"),this.messageHandlers=[]},e.prototype.active=function(){return this.messageHandlers.length>0},e.prototype.handleMessage=function(e){for(var t={resultCode:n.UNHANDLED_MESSAGE_ACK,isHandled:!1},i=0,r=this.messageHandlers;i<r.length;i++){var s=r[i],a=this.safeExecuteHandle(s,e);if(void 0!==a&&(void 0===a.isHandled||a.isHandled))return void 0===a.resultCode&&(a.resultCode=n.HANDLED_MESSAGE_ACK),a}return t},e.prototype.safeExecuteHandle=function(e,t){try{return e.handleMessage(t)}catch(e){return void this.logger.warn("Trouter message handler threw an exception: ".concat(e))}},e}();t.MessageHandlerRegistry=s},function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.addCacheAsBackupTo=void 0,t.addCacheAsBackupTo=function(e){var t,i=this;return function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){return s&&(t=void 0),[2,new Promise((function(i,n){e(s).then((function(e){t=e,i(e)})).catch((function(e){void 0!==t&&t.length>0&&i(t),n(e)}))}))]}))}))}}},function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterManager=t.AudienceSubscriptionState=t.UserActivityObject=void 0;var s=i(3),a=i(2),o=i(4),c=i(0),l=i(5),d=i(18),h=i(7),u=i(6),g=i(19),p=function(){function e(e,t){this.state=e,this.correlationVector=void 0!==t?t:s.CorrelationVector.extend()}return e.prototype.getStateString=function(){switch(this.state){case a.UserActivityState.Active:return"active";case a.UserActivityState.Inactive:return"inactive";case a.UserActivityState.Unknown:return"unknown";default:return"undefined"}},e.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},e.prototype.toEventObject=function(){return{state:this.getStateString(),cv:this.correlationVector.value()}},e.prototype.toEventJSON=function(){return(0,s.toJson)(this.toEventObject())},e}();t.UserActivityObject=p;var m=function(){function e(e,t){void 0===t&&(t=s.CorrelationVector.extend()),this.audienceSubscriptionModel=e,this.correlationVector=t}return e.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},e.prototype.toEventObject=function(){return{audiences:this.audienceSubscriptionModel.audienceSubscriptions,cv:this.correlationVector.value()}},e.prototype.toEventJSON=function(){return(0,s.toJson)(this.toEventObject())},e}();t.AudienceSubscriptionState=m;var f=function(){function e(e,t,i,n,r,o){var d=this;this.logFunc=e,this.options=t,this.tokenProvider=i,this.usingLegacyTokenApi=n,this.listener=r,this.tokenTypeProtocolSelector=function(e,t){return d.options.forceV4aProtocol?"v4a":(0,l.usedProtocol)(e,t)},this.logger=new c.Logger("Manager",e),this.logger.info("Created TrouterManager with options ".concat((0,s.toJson)(this.options))),this.fsm=new g.TrouterManagerFsm(e,this),this.baseEndpointUrl="",this.processedMessageLoss={},this.userActivityObject=new p(a.UserActivityState.Unknown),this.protocolSelector=null!=o?o:this.tokenTypeProtocolSelector.bind(this)}return e.prototype.start=function(){this.fsm.start()},e.prototype.stop=function(e){this.fsm.stop(e)},e.prototype.configure=function(e){this.options=e,void 0!==this.firstConnection&&this.firstConnection.configure(e),void 0!==this.secondConnection&&this.secondConnection.configure(e),this.logger.info("Reconfigured TrouterManager with options ".concat((0,s.toJson)(this.options)))},e.prototype.checkConnection=function(e){void 0!==this.firstConnection&&this.firstConnection.checkConnection(e),void 0!==this.secondConnection&&this.secondConnection.checkConnection(e)},e.prototype.resendRegistration=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){return void 0!==this.secondConnection?(this.logger.info("Resending registration on the second/new connection"),[2,this.secondConnection.resendRegistration()]):void 0!==this.firstConnection?(this.logger.info("Resending registration on the first/current connection"),[2,this.firstConnection.resendRegistration()]):(this.logger.info("No connection to resend registration on, will be done upon (re)connect"),[2])}))}))},e.prototype.getServerState=function(){if(void 0!==this.firstConnection)return this.firstConnection.getServerState()},e.prototype.getState=function(){return this.fsm.getState()},e.prototype.isInTerminalState=function(){return this.fsm.getInternalState()===o.TrouterManagerState.TerminalError},e.prototype.reportStateInfo=function(){var e=this.firstConnection?u.State[this.firstConnection.getState()]:"Unknown",t=o.TrouterManagerState[this.fsm.getInternalState()];if(this.secondConnection){var i=u.State[this.secondConnection.getState()];return"Manager ".concat(t,"; 1st ").concat(e,"; 2nd ").concat(i)}return"Manager ".concat(t,"; Connection ").concat(e)},e.prototype.startFirstConnection=function(){var e=new h.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.firstConnection=e,this.getConnectionCache().then((function(t){e.start(t)})).catch((function(){}))},e.prototype.startSecondConnection=function(e){var t=new h.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.secondConnection=t,void 0!==this.firstConnection&&this.firstConnection.disableRegistrationsAndAutoReconnect(),e?this.getConnectionCache().then((function(e){t.start(e)})).catch((function(){})):t.start()},e.prototype.stopFirstConnection=function(e){void 0!==this.firstConnection&&(this.storedFirstConnection=this.firstConnection,this.firstConnection.stop(e),this.firstConnection=void 0)},e.prototype.stopSecondConnection=function(e){void 0!==this.secondConnection&&(this.secondConnection.stop(e),this.secondConnection=void 0)},e.prototype.stopSecondConnectionDelayed=function(){if(void 0!==this.secondConnection){var e=this.secondConnection;this.secondConnection=void 0,this.logger.info("Closing an inactive connection in ".concat(Math.round(this.options.lingeringConnectionDelayMs/1e3),"s")),setTimeout((function(){e.stop(!0)}),this.options.lingeringConnectionDelayMs)}},e.prototype.forceStopLingeringConnection=function(){this.storedFirstConnection&&(this.storedFirstConnection.stop(!1),this.storedFirstConnection=void 0)},e.prototype.switchConnections=function(){var e=this.firstConnection;this.firstConnection=this.secondConnection,this.secondConnection=e},e.prototype.doesSecondConnectionExist=function(){return void 0!==this.secondConnection},e.prototype.dispatchConnected=function(){if(void 0!==this.firstConnection){var e=this.firstConnection.getServerState(),t=e.url.endsWith("/")?e.url.slice(0,-1):e.url,i={baseEndpointUrl:t,newEndpointUrl:t!==this.baseEndpointUrl,c2cUrlBase:e.c2cUrlBase,clientId:e.connectedClientId,connectionId:e.connectionId,connectionTtlSec:e.getRemainingTtlInSec()};this.baseEndpointUrl=t,this.listener.onTrouterConnected(e.url,i)}},e.prototype.dispatchDisconnected=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},e.prototype.dispatchTerminalError=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},e.prototype.dispatchRegistrationState=function(e){this.options.registrationStateCallback&&this.options.registrationStateCallback(e)},e.prototype.expediteBackoffOnConnections=function(){var e;void 0!==this.lastExpediteBackoffCallAt&&Date.now()-this.lastExpediteBackoffCallAt<(null!==(e=this.options.expediteBackoffOnStartMinimumDelayMs)&&void 0!==e?e:1e4)?this.logger.info("Expedite backoff due to start() too frequent, skipping"):(this.lastExpediteBackoffCallAt=Date.now(),void 0!==this.firstConnection&&this.firstConnection.expediteBackoff(),void 0!==this.secondConnection&&this.secondConnection.expediteBackoff())},e.prototype.onDownstreamRequest=function(e,t,i){var n={id:t.id,method:t.method,path:"/".concat(t.shortUrl),body:t.body,headers:t.headers},r={id:t.id,status:0,headers:{},body:"",send:function(){return r.status<=100||r.status>=999?3:(i.writeHead(r.status,r.headers),i.end(r.body))}};this.listener.onTrouterRequest(n,r)},e.prototype.onConnected=function(e){this.fsm.onConnected(e===this.firstConnection)},e.prototype.onRegistered=function(e){this.fsm.onRegistered(e===this.firstConnection)},e.prototype.onUnregistered=function(e){this.fsm.onUnregistered(e===this.firstConnection||e===this.storedFirstConnection)},e.prototype.onReconnecting=function(e){this.fsm.onReconnecting(e===this.firstConnection)},e.prototype.onReconnectIsRequired=function(e,t,i){this.fsm.onReconnectionRequired(e===this.firstConnection,t,i)},e.prototype.onDisconnected=function(e){this.fsm.onDisconnected(e===this.firstConnection||e==this.storedFirstConnection),this.storedFirstConnection=void 0},e.prototype.onTerminalError=function(){this.fsm.onTerminalError(),this.storedFirstConnection=void 0},e.prototype.onUserActivityStateAccepted=function(e){this.listener.onTrouterUserActivityStateAccepted&&this.listener.onTrouterUserActivityStateAccepted(e)},e.prototype.onAudiencesSetResolved=function(e,t){var i,n;null===(n=(i=this.listener).onAudiencesSetResolved)||void 0===n||n.call(i,e,t)},e.prototype.onConnectionParametersUpdated=function(e){this.setConnectionCache(e)},e.prototype.setUserActivityState=function(e,t){return this.userActivityObject=new p(e,s.CorrelationVector.extend(t)),void 0!==this.secondConnection?(this.logger.info("Setting user activity ".concat(this.userActivityObject.toEventJSON()," on the second/new connection")),void this.secondConnection.setUserActivityState(this.userActivityObject)):void 0!==this.firstConnection?(this.logger.info("Setting user activity ".concat(this.userActivityObject.toEventJSON()," on the first/current connection")),void this.firstConnection.setUserActivityState(this.userActivityObject)):void 0},e.prototype.setAudienceSubscriptionsAsync=function(e,t,i){if(this.audienceSubscriptionState=new m(e,s.CorrelationVector.extend(i)),this.secondConnection)return this.logger.info("Setting audience subscriptions ".concat(this.audienceSubscriptionState.toEventJSON()," on second/new connection")),this.secondConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,t);if(this.firstConnection)return this.logger.info("Setting audience subscriptions ".concat(this.audienceSubscriptionState.toEventJSON()," on first/current connection")),this.firstConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,t);throw new Error("No connection found")},e.prototype.onTrouterMessageLost=function(e){var t=this;if(this.listener.onTrouterMessageLoss)if(null==e?void 0:e.length){var i=e.filter((function(e){return void 0!==t.processedMessageLoss["".concat(e.tag,"-").concat(e.etag)]}));if(i.length&&(this.logger.info("onTrouterMessageLoss - immediately acknowledging ".concat(i.length," seen dropped indicators")),this.sendProcessedDroppedIndicators(i),!(e=e.filter((function(e){return void 0===t.processedMessageLoss["".concat(e.tag,"-").concat(e.etag)]}))).length))return void this.logger.info("onTrouterMessageLoss - all declared dropped indicators have been seen before");if(!this.listener.onTrouterMessageLoss(e.map((function(e){return e.tag}))))return void this.logger.warn("onTrouterMessageLoss - some flow tag(s) have not been processed by listeners");e.forEach((function(e){t.processedMessageLoss["".concat(e.tag,"-").concat(e.etag)]=""})),this.sendProcessedDroppedIndicators(e)}else this.logger.warn("onTrouterMessageLoss - no flow tags have been provided")},e.prototype.getConnectionCache=function(){var e=this;return this.options.connectionCache?(this.logger.debug("Querying host's connection cache"),this.options.connectionCache.onGetTrouterConnectionCache().then((function(e){var t=e?JSON.parse(e):void 0;return"object"==typeof t?t:void 0})).catch((function(t){return e.logger.warn("Invalid connection cache content provided: ".concat(t)),e.connectionCache}))):Promise.resolve(this.connectionCache)},e.prototype.setConnectionCache=function(e){if(this.connectionCache=e,this.options.connectionCache)try{this.options.connectionCache.onSetTrouterConnectionCache(JSON.stringify(e))}catch(e){this.logger.warn("Error setting external connection cache: ".concat(e))}},e.prototype.sendProcessedDroppedIndicators=function(e){return void 0!==this.firstConnection?void this.firstConnection.sendProcessedDroppedIndicators(e):void 0!==this.secondConnection?void this.secondConnection.sendProcessedDroppedIndicators(e):void 0},e.prototype.configuredTrouterManager=function(){return new d.RegistrationEnforcer(this,this.options.connectionDependsOnRegistration,this.options.delayEventsUntilRegistered)},e}();t.TrouterManager=f},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterUrlPromise=void 0;var n=i(0),r=function(){function e(e){this.logger=new n.Logger("UrlPromise",e)}return e.prototype.getPromise=function(){var e=this;return void 0!==this.url?(this.logger.debug("returning previously resolved url: ".concat(this.url)),Promise.resolve(this.url)):(void 0===this.pendingPromise?(this.logger.debug("creating and returning promise"),this.pendingPromise=new Promise((function(t,i){e.pendingPromiseResolveRef=t,e.pendingPromiseRejectRef=i}))):this.logger.debug("returning existing promise"),this.pendingPromise)},e.prototype.resolveUrl=function(e){this.url=e,this.logger.debug("got url: ".concat(this.url));var t=this.pendingPromiseResolveRef;this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==t&&(this.logger.debug("resolving promise"),t(e))},e.prototype.rejectUrl=function(e){this.logger.debug("aborting");var t=this.pendingPromiseRejectRef;this.url=void 0,this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==t&&(this.logger.debug("rejecting promise"),t(e))},e.prototype.resetUrl=function(){this.logger.debug("resetting url"),this.url=void 0},e}();t.TrouterUrlPromise=r},function(e,t,i){(function(e,i){!function(e,t){var i=e;i.version="0.9.6",i.protocol=1,i.transports=[],i.j=[],i.sockets={},i.connect=function(e,n){var r,s,a=i.util.parseUri(e);t&&t.location&&(a.protocol=a.protocol||t.location.protocol.slice(0,-1),a.host=a.host||(t.document?t.document.domain:t.location.hostname),a.port=a.port||t.location.port),r=i.util.uniqueUri(a);var o={host:a.host,secure:"https"==a.protocol,port:a.port||("https"==a.protocol?443:80),query:a.query||""};return i.util.merge(o,n),!o["force new connection"]&&i.sockets[r]||(s=new i.Socket(o)),!o["force new connection"]&&s&&(i.sockets[r]=s),s=s||i.sockets[r],o["skipped handshake data"]?s.of(""):s.of(a.path.length>1?a.path:"")}}(i.exports,void 0===e?window:e);var n=i.exports;!function(e,t){var i=e.util={},n=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,r=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];i.parseUri=function(e){for(var t=n.exec(e||""),i={},s=14;s--;)i[r[s]]=t[s]||"";return i},i.uniqueUri=function(e){var i=e.protocol,n=e.host,r=e.port;return"document"in t?(n=n||document.domain,r=r||("https"==i&&"https:"!==document.location.protocol?443:document.location.port)):(n=n||"localhost",r||"https"!=i||(r=443)),(i||"http")+"://"+n+":"+(r||80)},i.query=function(e,t){var n=i.chunkQuery(e||""),r=[];for(var s in i.merge(n,i.chunkQuery(t||"")),n)n.hasOwnProperty(s)&&r.push(s+"="+n[s]);return r.length?"?"+r.join("&"):""},i.chunkQuery=function(e){for(var t,i={},n=e.split("&"),r=0,s=n.length;r<s;++r)(t=n[r].split("="))[0]&&(i[t[0]]=t[1]);return i};var s=!1;i.load=function(e){if("document"in t&&"complete"===document.readyState||s)return e();i.on(t,"load",e,!1)},i.on=function(e,t,i,n){e.attachEvent?e.attachEvent("on"+t,i):e.addEventListener&&e.addEventListener(t,i,n)},i.request=function(e){if(e&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!e||i.ua.hasCORS))return new XMLHttpRequest;if(!e)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}return null},"undefined"!=typeof window&&i.load((function(){s=!0})),i.defer=function(e){if(!i.ua.webkit||"undefined"!=typeof importScripts)return e();i.load((function(){setTimeout(e,100)}))},i.merge=function(e,t,n,r){var s,a=r||[],o=void 0===n?2:n;for(s in t)t.hasOwnProperty(s)&&i.indexOf(a,s)<0&&("object"==typeof e[s]&&o?i.merge(e[s],t[s],o-1,a):(e[s]=t[s],a.push(t[s])));return e},i.mixin=function(e,t){i.merge(e.prototype,t.prototype)},i.inherit=function(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i},i.isArray=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},i.intersect=function(e,t){for(var n=[],r=e.length>t.length?e:t,s=e.length>t.length?t:e,a=0,o=s.length;a<o;a++)~i.indexOf(r,s[a])&&n.push(s[a]);return n},i.indexOf=function(e,t,i){var n=e.length;for(i=i<0?i+n<0?0:i+n:i||0;i<n&&e[i]!==t;i++);return n<=i?-1:i},i.toArray=function(e){for(var t=[],i=0,n=e.length;i<n;i++)t.push(e[i]);return t},i.ua={},i.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var e=new XMLHttpRequest}catch(e){return!1}return null!=e.withCredentials}(),i.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent)}(void 0!==n?n:i.exports,void 0===e?window:e),function(e,t){function i(){}e.EventEmitter=i,i.prototype.on=function(e,i){return this.$events||(this.$events={}),this.$events[e]?t.util.isArray(this.$events[e])?this.$events[e].push(i):this.$events[e]=[this.$events[e],i]:this.$events[e]=i,this},i.prototype.addListener=i.prototype.on,i.prototype.once=function(e,t){function i(){n.removeListener(e,i),t.apply(this,arguments)}var n=this;return i.listener=t,this.on(e,i),this},i.prototype.removeListener=function(e,i){if(this.$events&&this.$events[e]){var n=this.$events[e];if(t.util.isArray(n)){for(var r=-1,s=0,a=n.length;s<a;s++)if(n[s]===i||n[s].listener&&n[s].listener===i){r=s;break}if(r<0)return this;n.splice(r,1),n.length||delete this.$events[e]}else(n===i||n.listener&&n.listener===i)&&delete this.$events[e]}return this},i.prototype.removeAllListeners=function(e){return this.$events&&this.$events[e]&&(this.$events[e]=null),this},i.prototype.listeners=function(e){return this.$events||(this.$events={}),this.$events[e]||(this.$events[e]=[]),t.util.isArray(this.$events[e])||(this.$events[e]=[this.$events[e]]),this.$events[e]},i.prototype.emit=function(e){if(!this.$events)return!1;var i=this.$events[e];if(!i)return!1;var n=Array.prototype.slice.call(arguments,1);if("function"==typeof i)i.apply(this,n);else{if(!t.util.isArray(i))return!1;for(var r=i.slice(),s=0,a=r.length;s<a;s++)r[s].apply(this,n)}return!0}}(void 0!==n?n:i.exports,void 0!==n?n:i.parent.exports),function(e,t){if(t&&t.parse)return e.JSON={parse:t.parse,stringify:t.stringify};throw new Error("JSON not available")}(void 0!==n?n:i.exports,"undefined"!=typeof JSON?JSON:void 0),function(e,t){var i=e.parser={},n=i.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],r=i.reasons=["transport not supported","client not handshaken","unauthorized"],s=i.advice=["reconnect"],a=t.JSON,o=t.util.indexOf;i.encodePacket=function(e){var t=o(n,e.type),i=e.id||"",c=e.endpoint||"",l=e.ack,d=null;switch(e.type){case"error":var h=e.reason?o(r,e.reason):"",u=e.advice?o(s,e.advice):"";""===h&&""===u||(d=h+(""!==u?"+"+u:""));break;case"message":""!==e.data&&(d=e.data);break;case"event":var g={name:e.name};e.args&&e.args.length&&(g.args=e.args),d=a.stringify(g);break;case"json":d=a.stringify(e.data);break;case"connect":e.qs&&(d=e.qs);break;case"ack":d=e.ackId+(e.args&&e.args.length?"+"+a.stringify(e.args):"")}var p=[t,i+("data"==l?"+":""),c];return null!=d&&p.push(d),p.join(":")},i.encodePayload=function(e){var t="";if(1==e.length)return e[0];for(var i=0,n=e.length;i<n;i++)t+=""+e[i].length+""+e[i];return t};var c=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;i.decodePacket=function(e){if(!(o=e.match(c)))return{};var t=o[2]||"",i=(e=o[5]||"",{type:n[o[1]],endpoint:o[4]||""});switch(t&&(i.id=t,o[3]?i.ack="data":i.ack=!0),i.type){case"error":var o=e.split("+");i.reason=r[o[0]]||"",i.advice=s[o[1]]||"";break;case"message":i.data=e||"";break;case"event":try{var l=a.parse(e);i.name=l.name,i.args=l.args}catch(e){}i.args=i.args||[];break;case"json":try{i.data=a.parse(e)}catch(e){}break;case"connect":i.qs=e||"";break;case"ack":if((o=e.match(/^([0-9]+)(\+)?(.*)/))&&(i.ackId=o[1],i.args=[],o[3]))try{i.args=o[3]?a.parse(o[3]):[]}catch(e){}break;case"disconnect":i.reason=e}return i},i.decodePayload=function(e){if(""==e.charAt(0)){for(var t=[],n=1,r="";n<e.length;n++)""==e.charAt(n)?(t.push(i.decodePacket(e.substr(n+1).substr(0,r))),n+=Number(r)+1,r=""):r+=e.charAt(n);return t}return[i.decodePacket(e)]}}(void 0!==n?n:i.exports,void 0!==n?n:i.parent.exports),function(e,t){function i(e,t){this.socket=e,this.sessid=t,this.connectErrorCallback=void 0,this.isOpened=!1}e.Transport=i,t.util.mixin(i,t.EventEmitter),i.prototype.onData=function(e){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==e){var i=t.parser.decodePayload(e);if(i&&i.length)for(var n=0,r=i.length;n<r;n++)this.onPacket(i[n])}return this},i.prototype.onPacket=function(e){return this.socket.setHeartbeatTimeout(),"heartbeat"==e.type?this.onHeartbeat():("connect"==e.type&&""==e.endpoint&&this.onConnect(),"error"==e.type&&"reconnect"==e.advice&&(this.isOpened=!1),this.socket.onPacket(e),this)},i.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var e=this;this.closeTimeout=setTimeout((function(){e.onDisconnect()}),this.socket.closeTimeout)}},i.prototype.onDisconnect=function(){return this.close&&this.isOpened&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},i.prototype.onConnect=function(){return this.socket.onConnect(),this.connectErrorCallback=void 0,this},i.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},i.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},i.prototype.packet=function(e){this.send(t.parser.encodePacket(e))},i.prototype.onHeartbeat=function(e){this.packet({type:"heartbeat"})},i.prototype.onOpen=function(){this.isOpened=!0,this.clearCloseTimeout(),this.socket.onOpen()},i.prototype.onClose=function(){this.isOpened=!1,this.socket.onClose(),this.onDisconnect()},i.prototype.prepareUrl=function(e){var i=this.socket.options;if(i["skipped handshake data"])return i.rewriteUrlForProxy(i["skipped handshake data"].websocketUrl+(e||""));var n=this.scheme()+"://"+i.host+":"+i.port+"/"+i.resource+"/"+t.protocol+"/"+this.name+"/"+this.sessid+(e||"");return i.rewriteUrlForProxy(n)},i.prototype.ready=function(e,t){t.call(this)},i.prototype.clearEventHandlers=function(){return this}}(void 0!==n?n:i.exports,void 0!==n?n:i.parent.exports),function(e,t,i){function n(e){if(this.options={port:80,secure:!1,document:"document"in i&&document,resource:"socket.io",transports:t.transports.slice(),"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!0,"auto connect":!0,"flash policy port":10843},t.util.merge(this.options,e),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.disconnected=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||t.util.ua.hasCORS)){var n=this;t.util.on(i,"unload",(function(){n.disconnectSync()}),!1)}this.options["auto connect"]&&this.connect()}function r(){}e.Socket=n,t.util.mixin(n,t.EventEmitter),n.prototype.of=function(e){return this.namespaces[e]||(this.namespaces[e]=new t.SocketNamespace(this,e),""!==e&&this.namespaces[e].packet({type:"connect"})),this.namespaces[e]},n.prototype.publish=function(){var e;for(var t in this.emit.apply(this,arguments),this.namespaces)this.namespaces.hasOwnProperty(t)&&(e=this.of(t)).$emit.apply(e,arguments)},n.prototype.handshake=function(e){function i(t){t instanceof Error?n.onError(t.message):e.apply(null,t.split(":"))}var n=this,s=this.options;if(!n.disconnected){var a=s.rewriteUrlForProxy(["http"+(s.secure?"s":"")+":/",s.host+":"+s.port,s.resource,t.protocol,t.util.query(this.options.query,"t="+ +new Date)].join("/"));if(this.isXDomain()&&!t.util.ua.hasCORS){var o=document.getElementsByTagName("script")[0],c=document.createElement("script");c.src=a+"&jsonp="+t.j.length,o.parentNode.insertBefore(c,o),t.j.push((function(e){i(e),c.parentNode.removeChild(c)}))}else{var l=t.util.request();l.open("GET",a,!0);var d=this.options.requestHeaders;void 0!==d&&Object.keys(d).forEach((function(e){l.setRequestHeader(e,d[e])})),l.onreadystatechange=function(){4==l.readyState&&(l.onreadystatechange=r,200==l.status?i(l.responseText):!n.reconnecting&&n.onError(l.responseText))},l.send(null)}}},n.prototype.getTransport=function(e){for(var i,n=e||this.transports,r=0;i=n[r];r++)if(t.Transport[i]&&t.Transport[i].check(this)&&(!this.isXDomain()||t.Transport[i].xdomainCheck()))return new t.Transport[i](this,this.sessionid);return null},n.prototype.connect=function(e){if(this.connecting||this.disconnected)return this;var i=this,n=function(n,r,s,a){function o(){if(!i.connected&&!i.disconnected)if(i.connecting=!1,clearTimeout(i.connectTimeoutTimer),i.options["try multiple transports"]){for(;i.remainingTransports.length>0&&i.remainingTransports.splice(0,1)[0]!=i.transport.name;);i.remainingTransports.length?c(i.remainingTransports):i.publish("connect_failed")}else i.publish("connect_failed")}function c(e){if(i.transport&&(i.transport.clearTimeouts(),i.transport.clearEventHandlers()),i.transport=i.getTransport(e),!i.transport||i.disconnected)return i.publish("connect_failed");i.transport.ready(i,(function(){i.connecting=!0,i.publish("connecting",i.transport.name),i.transport.open(o),i.options["connect timeout"]&&(i.connectTimeoutTimer=setTimeout((function(){o()}),i.options["connect timeout"]))}))}i.sessionid=n,i.closeTimeout=1e3*s+2e3,i.heartbeatTimeout=1e3*r+2e3,i.transports=a?t.util.intersect(a.split(","),i.options.transports):i.options.transports,i.setHeartbeatTimeout(),i.remainingTransports=i.transports.slice(0),c(i.transports),i.once("connect",(function(){clearTimeout(i.connectTimeoutTimer),e&&"function"==typeof e&&e()}))};if(this.options["skipped handshake data"]){var r=this.options["skipped handshake data"];n("v4c-"+(new Date).getTime(),r.timeout,r.timeout,"websocket")}else this.handshake(n);return this},n.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);var e=this;this.heartbeatTimeoutTimer=setTimeout((function(){e.transport.onClose()}),this.heartbeatTimeout)},n.prototype.packet=function(e){return this.connected&&!this.doBuffer?this.transport.packet(e):this.buffer.push(e),this},n.prototype.setBuffer=function(e){this.doBuffer=e,!e&&this.connected&&this.buffer.length&&(this.transport.payload(this.buffer),this.buffer=[])},n.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this.disconnected=!0,this},n.prototype.disconnectSync=function(){var e=t.util.request(),i=this.resource+"/"+t.protocol+"/"+this.sessionid;e.open("GET",i,!0),this.onDisconnect("booted")},n.prototype.isXDomain=function(){var e=i.location.port||("https:"==i.location.protocol?443:80);return this.options.host!==i.location.hostname||this.options.port!=e},n.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},n.prototype.onOpen=function(){this.open=!0},n.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},n.prototype.onPacket=function(e){this.of(e.endpoint).onPacket(e)},n.prototype.onError=function(e){e&&e.advice&&"reconnect"===e.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",e&&e.reason?e.reason:e)},n.prototype.onDisconnect=function(e){var t=this.connected,i=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(t||i)&&(this.transport.close(),this.transport.clearTimeouts(),t?(this.publish("disconnect",e),"booted"!=e&&this.options.reconnect&&!this.reconnecting&&this.reconnect()):this.publish("close_during_connecting",e))},n.prototype.reconnect=function(){function e(){if(i.connected){for(var e in i.namespaces)i.namespaces.hasOwnProperty(e)&&""!==e&&i.namespaces[e].packet({type:"connect"});i.publish("reconnect",i.transport.name,i.reconnectionAttempts)}clearTimeout(i.reconnectionTimer),i.removeListener("connect_failed",t),i.removeListener("connect",t),i.reconnecting=!1,delete i.reconnectionAttempts,delete i.reconnectionDelay,delete i.reconnectionTimer,delete i.redoTransports,i.options["try multiple transports"]=r}function t(){if(i.reconnecting)return i.connected?e():i.connecting&&i.reconnecting?i.reconnectionTimer=setTimeout(t,1e3):void(i.reconnectionAttempts++>=n?i.redoTransports?(i.publish("reconnect_failed"),e()):(i.on("connect_failed",t),i.options["try multiple transports"]=!0,i.transport=i.getTransport(),i.redoTransports=!0,i.connect()):(i.reconnectionDelay<s&&(i.reconnectionDelay*=2),i.connect(),i.publish("reconnecting",i.reconnectionDelay,i.reconnectionAttempts),i.reconnectionTimer=setTimeout(t,i.reconnectionDelay)))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var i=this,n=this.options["max reconnection attempts"],r=this.options["try multiple transports"],s=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(t,this.reconnectionDelay),this.on("connect",t)}}(void 0!==n?n:i.exports,void 0!==n?n:i.parent.exports,void 0===e?window:e),function(e,t){function i(e,t){this.socket=e,this.name=t||"",this.flags={},this.json=new n(this,"json"),this.ackPackets=0,this.acks={}}function n(e,t){this.namespace=e,this.name=t}e.SocketNamespace=i,t.util.mixin(i,t.EventEmitter),i.prototype.$emit=t.EventEmitter.prototype.emit,i.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},i.prototype.packet=function(e){return e.endpoint=this.name,this.socket.packet(e),this.flags={},this},i.prototype.send=function(e,t){var i={type:this.flags.json?"json":"message",data:e};return"function"==typeof t&&(i.id=++this.ackPackets,i.ack=!0,this.acks[i.id]=t),this.packet(i)},i.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1),i=t[t.length-1],n={type:"event",name:e};return"function"==typeof i&&(n.id=++this.ackPackets,n.ack="data",this.acks[n.id]=i,t=t.slice(0,t.length-1)),n.args=t,this.packet(n)},i.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},i.prototype.onPacket=function(e){function i(){n.packet({type:"ack",args:t.util.toArray(arguments),ackId:e.id})}var n=this;switch(e.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(e.reason||"booted"):this.$emit("disconnect",e.reason||"");break;case"message":case"json":var r=["message",e.data];"data"==e.ack?r.push(i):e.ack&&this.packet({type:"ack",ackId:e.id}),this.$emit.apply(this,r);break;case"event":r=[e.name].concat(e.args),"data"==e.ack&&r.push(i),this.$emit.apply(this,r);break;case"ack":this.acks[e.ackId]&&(this.acks[e.ackId].apply(this,e.args),delete this.acks[e.ackId]);break;case"error":e.advice?this.socket.onError(e):"unauthorized"==e.reason?this.$emit("connect_failed",e.reason):this.$emit("error",e.reason)}},n.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},n.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}(void 0!==n?n:i.exports,void 0!==n?n:i.parent.exports),function(e,t,i){function n(e){t.Transport.apply(this,arguments)}function r(){}e.websocket=n,t.util.inherit(n,t.Transport),n.prototype.name="websocket",n.prototype.open=function(e){var n,r=t.util.query(this.socket.options.query),s=this;return this.connectErrorCallback=e,n||(n=i.MozWebSocket||i.WebSocket),this.websocket=new n(this.prepareUrl(r)),this.websocket.onopen=function(){s.onOpen(),s.socket.setBuffer(!1)},this.websocket.onmessage=function(e){s.onData(e.data)},this.websocket.onclose=function(){s.onClose(),s.socket.setBuffer(!0)},this.websocket.onerror=function(e){s.onError(e)},this},n.prototype.send=function(e){return this.websocket.send(e),this},n.prototype.payload=function(e){for(var t=0,i=e.length;t<i;t++)this.packet(e[t]);return this},n.prototype.close=function(){return this.websocket.close(),this},n.prototype.onError=function(e){void 0!==this.connectErrorCallback&&(this.connectErrorCallback(),this.connectErrorCallback=void 0),this.socket.onError(e)},n.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},n.check=function(){return"WebSocket"in i&&!("__addTask"in WebSocket)||"MozWebSocket"in i},n.xdomainCheck=function(){return!0},n.prototype.clearEventHandlers=function(){return this.websocket&&(this.websocket.onopen=this.websocket.onmessage=this.websocket.onclose=this.websocket.onerror=r),this},t.transports.push("websocket")}(void 0!==n?n.Transport:i.exports,void 0!==n?n:i.parent.exports,void 0===e?window:e),function(e,t,i){function n(e){e&&t.Transport.apply(this,arguments)}function r(){}e.XHR=n,t.util.inherit(n,t.Transport),n.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},n.prototype.payload=function(e){for(var i=[],n=0,r=e.length;n<r;n++)i.push(t.parser.encodePacket(e[n]));this.send(t.parser.encodePayload(i))},n.prototype.send=function(e){return this.post(e),this},n.prototype.post=function(e){var t=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),i.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=function(){this.onload=r,t.socket.setBuffer(!1)}:this.sendXHR.onreadystatechange=function(){4==this.readyState&&(this.onreadystatechange=r,200==this.status?(clearTimeout(this.ackTimeoutTimer),t.socket.setBuffer(!1)):t.onClose())},this.sendXHR.send(e),t.sendXHR.ackTimeoutTimer=setTimeout((function(){t.onClose()}),t.socket.options.ackTimeoutMs)},n.prototype.close=function(){return this.onClose(),this},n.prototype.request=function(e){var i=t.util.request(this.socket.isXDomain()),n=t.util.query(this.socket.options.query,"t="+ +new Date);i.open(e||"GET",this.prepareUrl(n),!0);var r=this.socket.options.requestHeaders;if(void 0!==r&&Object.keys(r).forEach((function(e){i.setRequestHeader(e,r[e])})),"POST"==e)try{i.setRequestHeader?i.setRequestHeader("Content-type","text/plain;charset=UTF-8"):i.contentType="text/plain"}catch(e){}return i},n.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},n.check=function(e,n){try{var r=t.util.request(n),s=i.XDomainRequest&&r instanceof XDomainRequest,a=(e&&e.options&&e.options.secure?"https:":"http:")!=i.location.protocol;if(r&&(!s||!a))return!0}catch(e){}return!1},n.xdomainCheck=function(){return n.check(null,!0)},n.prototype.clearEventHandlers=function(){return this.sendXHR&&(this.sendXHR.onreadystatechange=this.sendXHR.onload=r),this}}(void 0!==n?n.Transport:i.exports,void 0!==n?n:i.parent.exports,void 0===e?window:e),function(e,t,i){function n(){t.Transport.XHR.apply(this,arguments)}function r(){}e["xhr-polling"]=n,t.util.inherit(n,t.Transport.XHR),t.util.merge(n,t.Transport.XHR),n.prototype.name="xhr-polling",n.prototype.open=function(e){return this.connectErrorCallback=e,t.Transport.XHR.prototype.open.call(this),!1},n.prototype.get=function(){if(this.isOpened){var e=this;this.xhr=this.request(),i.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=function(){e.connectErrorCallback=void 0,this.onload=r,this.onerror=r,e.onData(this.responseText),e.get()},this.xhr.onerror=function(){e.onClose(),void 0!==e.connectErrorCallback&&(e.connectErrorCallback(),e.connectErrorCallback=void 0)}):this.xhr.onreadystatechange=function(){4==this.readyState&&(this.onreadystatechange=r,200==this.status?(e.connectErrorCallback=void 0,e.onData(this.responseText),e.get()):(e.onClose(),void 0!==e.connectErrorCallback&&(e.connectErrorCallback(),e.connectErrorCallback=void 0)))},this.xhr.send(null)}},n.prototype.onClose=function(){if(t.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=r;try{this.xhr.abort()}catch(e){}this.xhr=null}},n.prototype.ready=function(e,i){var n=this;t.util.defer((function(){i.call(n)}))},n.prototype.clearEventHandlers=function(){return t.Transport.XHR.prototype.clearEventHandlers.call(this),this.xhr&&(this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=r),this},t.transports.push("xhr-polling")}(void 0!==n?n.Transport:i.exports,void 0!==n?n:i.parent.exports,void 0===e?window:e),t.io=n}).call(t,i(13),i(14)(e))},function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionTracker=t.Properties=t.TrackerStep=t.ClientEventName=t.ResponseData=void 0;var n,r=i(3),s=i(1),a=i(0),o=function(e){this.id=e,this.status=200,this.headers={},this.body=""};t.ResponseData=o,function(e){e.Connected="trouter_js_client_connected",e.Disconnected="trouter_js_client_disconnected",e.Error="trouter_js_client_error",e.Progress="trouter_js_client_progress",e.Response="trouter_js_client_response",e.Request="trouter_js_client_request",e.CheckConnection="trouter_js_client_check_connection",e.Registration="trouter_js_client_registration",e.Unregistration="trouter_js_client_unregistration"}(n||(t.ClientEventName=n={}));var c=function(e,t,i,n,r){this.stepName=e,this.operation=t,this.delta=i,this.ts=n,this.error=r};t.TrackerStep=c;var l=function(){};t.Properties=l;var d=function(){this.numberOfPingReplies=0,this.connectedTimestamp=0,this.isNewUrl=!1,this.transportType="",this.connectionNumber=0},h=function(){this.enabled=!1,this.numberOfStepsToMaintain=40,this.logHealthCheckError=!1,this.sendProgressTimeoutSecs=55,this.logSendPingError=!1,this.maxBackoffInMs=12e4,this.trouter_js_client_connected=!1,this.trouter_js_client_disconnected=!1,this.trouter_js_client_error=!1,this.trouter_js_client_progress=!1,this.trouter_js_client_response=!1,this.trouter_js_client_request=!1,this.trouter_js_client_registration=!1,this.trouter_js_client_unregistration=!1,this.trouter_js_client_check_connection=!0},u=function(){function e(e,t,i,n,s,o,c){this.clientId=t,this.clientInfo=i,this.getServerState=n,this.endpointId=s,this.clientCorrelationID=o,this.environment=c,this.logger=new a.Logger("ConnectionTracker",e),this.clientCorrelationID=void 0!==o?o:"",this.steps=[],this.connectionAttempt=0,this.totalStepCount=0,this.beginTimestamp=new r.Timespan,this.eventLogSettings=new h,this.connectedInfo=new d}return e.prototype.enable=function(e){this.eventLogSettings.enabled=!0,this.eventLogger=e},e.prototype.disable=function(){this.eventLogSettings.enabled=!1},e.prototype.sendProgress=function(e){this.steps.length>0&&this.sendTelemetry(n.Progress,e,this.steps)},e.prototype.cancelProgressTimer=function(){void 0!==this.progressTimeout&&(clearTimeout(this.progressTimeout),this.progressTimeout=void 0)},e.prototype.resetProgressSendTimer=function(){var e=this;this.cancelProgressTimer(),void 0!==this.eventLogSettings.sendProgressTimeoutSecs&&this.eventLogSettings.sendProgressTimeoutSecs>0&&(this.progressTimeout=setTimeout((function(){e.sendProgress({reason:"timeout",timeoutSecs:e.eventLogSettings.sendProgressTimeoutSecs})}),1e3*this.eventLogSettings.sendProgressTimeoutSecs))},e.prototype.setConnectedInfo=function(e,t){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=Date.now(),this.connectedInfo.isNewUrl=e,this.connectedInfo.transportType=t,++this.connectedInfo.connectionNumber},e.prototype.clearConnectedInfo=function(){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=0,this.connectedInfo.isNewUrl=!0,this.connectedInfo.transportType=""},e.prototype.copyProperties=function(e,t){for(var i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];void 0!==t[r]&&(e[r.replace(/-/g,"_")]={value:t[r]})}},e.prototype.increasePingResponseCount=function(){++this.connectedInfo.numberOfPingReplies},e.prototype.sendTelemetry=function(e,t,i){try{if(!0===this.eventLogSettings.enabled&&!0===this.eventLogSettings[e]&&void 0!==this.eventLogger){var n=this.getServerState(),a={name:e,properties:{connectionAttempt:{value:this.connectionAttempt},epid:{value:this.endpointId},clientCorrelationID:{value:this.clientCorrelationID},steps:{value:(0,r.toJson)(i)},clientID:{value:this.clientId},eventVersion:{value:3},environment:{value:this.environment},cv:{value:s.CLIENT_VERSION},ua:{value:this.clientInfo.ua},connectionId:{value:n.connectionId},connectedClientId:{value:n.connectedClientId},domId:{value:n.domId},url:{value:n.unsecureUrl},surl:{value:n.url},ttlInSecs:{value:n.getRemainingTtlInSec()},numberOfPingReplies:{value:this.connectedInfo.numberOfPingReplies},connectedTimestamp:{value:this.connectedInfo.connectedTimestamp},isNewUrl:{value:this.connectedInfo.isNewUrl},transportType:{value:this.connectedInfo.transportType},connectionNumber:{value:this.connectedInfo.connectionNumber}}};this.copyProperties(a.properties,t),this.eventLogger.logEvent(a)}}catch(t){this.logger.warn("error in sending event ".concat(e,": ").concat((0,r.toJson)(t)))}},e.prototype.createStep=function(e,t,i){return new c(e,t,this.beginTimestamp.duration,Date.now(),i)},e.prototype.addStep=function(e,t,i){if(!1!==this.eventLogSettings.enabled&&(0===this.steps.length&&this.beginTimestamp.reset(),this.steps.push(this.createStep(e,t,i)),++this.totalStepCount,void 0!==this.eventLogSettings.numberOfStepsToMaintain&&this.steps.length>this.eventLogSettings.numberOfStepsToMaintain)){var r=this.steps.slice(0);this.steps.length=0,this.sendTelemetry(n.Progress,{reason:"flush"},r)}},e.prototype.trackStart=function(e){this.addStep(e,"start")},e.prototype.trackEnd=function(e){this.addStep(e,"end")},e.prototype.trackError=function(e,t,i,r){void 0===i&&(i=!0),"health"===e&&!0!==this.eventLogSettings.logHealthCheckError||"ping"===e&&!1===this.eventLogSettings.logSendPingError||(void 0===r&&(r="error"),!0===i&&this.addStep(e,r,t),this.sendTelemetry(n.Error,{},[this.createStep(e,r,t)]))},e.prototype.trackProgress=function(e,t){this.addStep(e,t)},e.prototype.trackConnected=function(e,t){this.setConnectedInfo(e,t);var i=this.steps.slice(0),r=this.totalStepCount,s=this.beginTimestamp.duration;this.steps.length=0,this.totalStepCount=0,this.sendTelemetry(n.Connected,{stepCount:i.length,totalStepCount:r,connectionEstablishmentMs_Total:s},i),this.cancelProgressTimer()},e.prototype.getSessionLength=function(){return Date.now()-this.connectedInfo.connectedTimestamp},e.prototype.trackDisconnected=function(e){e.sessionLengthMS=this.getSessionLength(),this.sendTelemetry(n.Disconnected,e,[]),this.resetProgressSendTimer()},e.prototype.trackNewConnection=function(){++this.connectionAttempt},e.prototype.trackRequest=function(e,t){var i={};void 0!==t&&(i.hasError=!0,i.error=t);try{if(e){i.requestID=e.id,i.httpMethod=e.method,i.url=e.url,i.bodyLength=e.body.length,i.shortUrl=e.shortUrl,i.requestTimeStamp=e.startTS,i.correlationVector=e.correlationVector;for(var s=e.headers,a=0,o=Object.keys(s);a<o.length;a++){var c=o[a];i[c]=s[c]}}}catch(e){i.hasError=!0,i.error="".concat(i.error," error creating request context ").concat((0,r.toJson)(e))}this.sendTelemetry(n.Request,i,[])},e.prototype.trackResponse=function(e,t,i,s){var a={};void 0!==s&&(a.hasError=!0,a.error=s);try{if(a.responseTimestamp=void 0!==i?i.sentTS:Date.now(),e){a.requestID=e.id,a.httpMethod=e.method,a.shortUrl=e.shortUrl,a.correlationVector=e.correlationVector;for(var o=e.headers,c=0,l=Object.keys(o);c<l.length;c++){var d=l[c];a[d]=o[d]}}i&&(a.latencyMS=t,a.responseCode=i.status,a.responseLength=i.body.length)}catch(e){a.hasError=!0,a.error="".concat(a.error," error creating response context ").concat((0,r.toJson)(e))}this.sendTelemetry(n.Response,a,[])},e.prototype.sendResponseError=function(e,t,i){this.trackResponse(t,void 0,i,e)},e.prototype.close=function(){this.sendProgress({reason:"closed"}),this.steps.length=0,this.cancelProgressTimer()},e.prototype.mergeSettings=function(e){if(e){this.eventLogSettings.numberOfStepsToMaintain=Math.min(40,Math.max(10,void 0!==e.numberOfStepsToMaintain?e.numberOfStepsToMaintain:0));var t=Math.min(3600,Math.max(55,void 0!==e.sendProgressTimeoutSecs?e.sendProgressTimeoutSecs:0));this.eventLogSettings.logHealthCheckError=e.logHealthCheckError,this.eventLogSettings.logSendPingError=e.logSendPingError;for(var i=0,r=Object.keys(n).map((function(e){return n[e]}));i<r.length;i++){var s=r[i];void 0!==e[s]&&(this.eventLogSettings[s]=e[s])}this.eventLogSettings.sendProgressTimeoutSecs!==t&&(this.eventLogSettings.sendProgressTimeoutSecs=t,this.resetProgressSendTimer())}},e}();t.ConnectionTracker=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DisconnectReason=void 0;var n=function(){function e(e,t,i){this.reason=e,this.claims=t,this.details=i}return e.fromRawReason=function(t,i){if(""===t||"dup"===t)return new e(t);try{var n=JSON.parse(t);return"object"!=typeof n||void 0===n.reason?(null==i||i.error("invalid disconnect reason format"),new e("unknown",void 0,t)):new e(n.reason,n.claims,n.details)}catch(i){return new e("disconnect",void 0,t)}},e.fromSocketIoEventData=function(t,i){return"string"==typeof i?new e(t,void 0,i):void 0},e.prototype.toTelemetryString=function(){return"socketerror"===this.reason||"reconnecterror"===this.reason||"disconnect"===this.reason?this.details:this.reason},e}();t.DisconnectReason=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ExponentialBackoff=void 0;var n=function(){function e(e,t,i){void 0===i&&(i={tolerance:2,minimumWaitMs:1e4}),this.logger=e,this.maxBackoffInMs=t,this.gapDetectionSettings=i,this.backoffId=0,this.backoffCount=0}return e.calculateNextBackoffMs=function(e,t){var i=1+.4*(Math.random()-.5),n=1e3*Math.pow(2,e)*i;return n=Math.round(n),Math.min(t,n)},e.prototype.setMaxBackoffMs=function(e){this.maxBackoffInMs=e},e.prototype.backoff=function(t,i){var n=this;if(void 0!==this.timerHandle&&(this.logger.debug("Clearing current back off"),clearTimeout(this.timerHandle),this.timerHandle=void 0),void 0!==this.previousCompleteTime){var r=Date.now()-this.previousCompleteTime;r>this.maxBackoffInMs*this.gapDetectionSettings.tolerance&&r>this.gapDetectionSettings.minimumWaitMs&&(this.logger.info("Back off for ".concat(t," with ID ").concat(this.backoffId," will be reset due to a lot of time having passed since the previous backoff (").concat(r," ms)")),this.backoffCount=0,this.previousCompleteTime=void 0)}var s=e.calculateNextBackoffMs(this.backoffCount,this.maxBackoffInMs);this.backoffId++,this.backoffCount++,this.logger.info("Backing off ".concat(t," for ").concat(s," milliseconds with ID ").concat(this.backoffId)),this.callback=function(e,r){(function(e,t,i){if(void 0===e||void 0===t)return!1;var n=Date.now()-e;return n>t*i.tolerance&&n>i.minimumWaitMs})(e,r,n.gapDetectionSettings)&&(n.logger.info("Back off for ".concat(t," with ID ").concat(n.backoffId," will be reset due to the wait (").concat(Date.now()-(null!=e?e:0)," ms) being longer than expected (").concat(r," ms)")),n.backoffCount=0),n.logger.info("Back off for ".concat(t," with ID ").concat(n.backoffId," complete, invoking handler")),n.timerHandle=void 0,n.callback=void 0,n.previousCompleteTime=Date.now(),i()};var a=Date.now();this.timerHandle=setTimeout((function(){var e;return null===(e=n.callback)||void 0===e?void 0:e.call(n,a,s)}),s)},e.prototype.reset=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off with ID ".concat(this.backoffId)),clearTimeout(this.timerHandle),this.timerHandle=void 0,this.callback=void 0),this.backoffCount=0},e.prototype.expediteIfPending=function(){if(this.backoffCount=0,void 0!==this.timerHandle){this.logger.debug("Expediting back off with ID ".concat(this.backoffId)),clearTimeout(this.timerHandle),this.timerHandle=void 0;var e=this.callback;this.callback=void 0,e&&e()}},e}();t.ExponentialBackoff=n},function(e,t,i){var n=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,s=t.length;r<s;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.LoggingManagerConsumer=t.RegistrationEnforcer=void 0;var r=i(6),s=function(){function e(e,t,i){this.wrapped=e,this.shouldConnectionDependOnRegistration=t,this.shouldHoldBackEvents=i,this.isRegistered=!1,this.heldBackEvents=[]}return e.prototype.onDownstreamRequest=function(e,t,i){this.passIfRegisteredOrNotNeeded("onDownstreamRequest",e,t,i)},e.prototype.onConnected=function(e){this.passIfRegisteredOrNotNeeded("onConnected",e)},e.prototype.onRegistered=function(e){this.isRegistered=!0,this.wrapped.onRegistered(e),this.fireHeldBackEvents()},e.prototype.onUnregistered=function(e){this.isRegistered=!1,this.wrapped.onUnregistered(e),e.getState()===r.State.Connected&&this.shouldConnectionDependOnRegistration()&&e.forceReconnectDueToNoRegistration()},e.prototype.onReconnecting=function(e){this.wrapped.onReconnecting(e)},e.prototype.onReconnectIsRequired=function(e,t,i){this.wrapped.onReconnectIsRequired(e,t,i)},e.prototype.onDisconnected=function(e){this.isRegistered=!1,this.dropHeldBackEvents(),this.wrapped.onDisconnected(e)},e.prototype.onTerminalError=function(e){this.wrapped.onTerminalError(e)},e.prototype.onConnectionParametersUpdated=function(e){this.wrapped.onConnectionParametersUpdated(e)},e.prototype.onTrouterMessageLost=function(e){this.passIfRegisteredOrNotNeeded("onTrouterMessageLost",e)},e.prototype.onUserActivityStateAccepted=function(e){this.passIfRegisteredOrNotNeeded("onUserActivityStateAccepted",e)},e.prototype.onAudiencesSetResolved=function(e,t){this.passIfRegisteredOrNotNeeded("onAudiencesSetResolved",e,t)},e.prototype.getState=function(){return this.wrapped.getState()},e.prototype.holdBackEvent=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.heldBackEvents.push({kind:e,args:t})},e.prototype.passIfRegisteredOrNotNeeded=function(e){for(var t,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];var s=this.shouldConnectionDependOnRegistration(),a=this.shouldHoldBackEvents();s&&a||this.fireHeldBackEvents(s?function(e){return"onConnected"!==e.kind}:void 0),this.isRegistered||!s||!1===a&&"onConnected"!==e?(t=this.wrapped)[e].apply(t,i):this.holdBackEvent.apply(this,n([e],i,!1))},e.prototype.fireHeldBackEvents=function(e){for(var t,i=0,n=this.heldBackEvents;i<n.length;i++){var r=n[i];(void 0===e||e(r))&&(t=this.wrapped)[r.kind].apply(t,r.args)}this.heldBackEvents=void 0===e?[]:this.heldBackEvents.filter((function(t){return!e(t)}))},e.prototype.dropHeldBackEvents=function(){this.heldBackEvents=[]},e}();t.RegistrationEnforcer=s;var a=function(){function e(e,t,i,n){this.wrapped=e,this.prefix=t,this.logger=i,this.onEventAction=n}return e.prototype.onEvent=function(e,t){var i;void 0!==this.onEventAction?this.onEventAction(e,t):(null!==(i=this.logger)&&void 0!==i?i:console).log("".concat(this.prefix," TracingEnforcer: ").concat(e,"(").concat(t,")"))},e.prototype.onDownstreamRequest=function(e,t,i){this.onEvent("onDownstreamRequest",JSON.stringify({request:t,response:i})),this.wrapped.onDownstreamRequest(e,t,i)},e.prototype.onConnected=function(e){this.onEvent("onConnected",e.getState().toString()),this.wrapped.onConnected(e)},e.prototype.onRegistered=function(e){this.onEvent("onRegistered",e.getState().toString()),this.wrapped.onRegistered(e)},e.prototype.onUnregistered=function(e){this.onEvent("onUnregistered",e.getState().toString()),this.wrapped.onUnregistered(e)},e.prototype.onReconnecting=function(e){this.onEvent("onReconnecting",e.getState().toString()),this.wrapped.onReconnecting(e)},e.prototype.onReconnectIsRequired=function(e,t,i){this.onEvent("onReconnectIsRequired",JSON.stringify({connection:e.getState().toString(),useConnectParamsFromCache:t,reason:i})),this.wrapped.onReconnectIsRequired(e,t,i)},e.prototype.onDisconnected=function(e){this.onEvent("onDisconnected",e.getState().toString()),this.wrapped.onDisconnected(e)},e.prototype.onTerminalError=function(e){this.onEvent("onTerminalError",JSON.stringify({connection:e})),this.wrapped.onTerminalError(e)},e.prototype.onConnectionParametersUpdated=function(e){this.onEvent("onConnectionParametersUpdated",JSON.stringify({connectParams:e})),this.wrapped.onConnectionParametersUpdated(e)},e.prototype.onTrouterMessageLost=function(e){this.onEvent("onTrouterMessageLost",JSON.stringify({flowTags:e})),this.wrapped.onTrouterMessageLost(e)},e.prototype.onUserActivityStateAccepted=function(e){this.onEvent("onUserActivityStateAccepted",JSON.stringify({cv:e})),this.wrapped.onUserActivityStateAccepted(e)},e.prototype.onAudiencesSetResolved=function(e,t){this.onEvent("onAudiencesSetResolved",JSON.stringify({audienceSubscriptionsResponse:e,cv:t})),this.wrapped.onAudiencesSetResolved(e,t)},e.prototype.getState=function(){return this.wrapped.getState()},e}();t.LoggingManagerConsumer=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TrouterManagerFsm=void 0;var n=i(2),r=i(4),s=i(0),a=i(7),o=function(){function e(e,t){this.worker=t,this.state=r.TrouterManagerState.Unknown,this.logger=new s.Logger("ManagerFsm",e)}return e.prototype.start=function(){this.state===r.TrouterManagerState.Unknown?(this.setState(r.TrouterManagerState.Disconnected),this.worker.forceStopLingeringConnection(),this.worker.startFirstConnection()):(this.logger.info("start called in state '".concat(r.TrouterManagerState[this.state],"', expediting pending backoffs, if any")),this.worker.expediteBackoffOnConnections())},e.prototype.stop=function(e){this.state!==r.TrouterManagerState.Unknown?(this.setState(r.TrouterManagerState.Unknown),this.worker.stopFirstConnection(!0===e),this.worker.stopSecondConnection(!0===e)):this.showIgnored("stop")},e.prototype.getState=function(){switch(this.state){case r.TrouterManagerState.Unknown:case r.TrouterManagerState.Connected:case r.TrouterManagerState.Disconnected:case r.TrouterManagerState.Switching:return this.state;case r.TrouterManagerState.TerminalError:return n.TrouterState.Disconnected}},e.prototype.getInternalState=function(){return this.state},e.prototype.onConnected=function(e){this.state===r.TrouterManagerState.Disconnected&&e?this.worker.doesSecondConnectionExist()?this.setState(r.TrouterManagerState.Switching):(this.setState(r.TrouterManagerState.Connected),this.worker.dispatchConnected()):this.showIgnored("onConnected(".concat(e,")"))},e.prototype.onRegistered=function(e){this.state!==r.TrouterManagerState.Disconnected||e?this.state!==r.TrouterManagerState.Switching||e?this.state===r.TrouterManagerState.Disconnected&&e&&(this.setState(r.TrouterManagerState.Connected),this.worker.dispatchConnected()):(this.setState(r.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnectionDelayed(),this.worker.dispatchConnected()):(this.setState(r.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnection(!0),this.worker.dispatchConnected()),this.worker.dispatchRegistrationState(!0)},e.prototype.onUnregistered=function(e){e&&this.worker.dispatchRegistrationState(!1)},e.prototype.onReconnecting=function(e){this.state!==r.TrouterManagerState.Connected&&this.state!==r.TrouterManagerState.Switching||!e?this.showIgnored("onReconnecting(".concat(e,")")):(this.setState(r.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected())},e.prototype.onReconnectionRequired=function(e,t,i){this.state===r.TrouterManagerState.Connected&&e?(this.setState(r.TrouterManagerState.Switching),this.worker.startSecondConnection(t)):this.state===r.TrouterManagerState.Disconnected&&e?this.worker.startSecondConnection(t):this.state===r.TrouterManagerState.Switching&&e&&i===a.ReconnectReason.Configuration?(this.logger.debug("onReconnectionRequired: switch requested while already in Switching state"),this.worker.stopSecondConnection(!0),this.worker.startSecondConnection(t)):this.showIgnored("onReconnectionRequired(".concat(e,")"))},e.prototype.onDisconnected=function(e){this.state==r.TrouterManagerState.Unknown&&e?this.worker.dispatchDisconnected():this.state==r.TrouterManagerState.Switching&&e?(this.worker.switchConnections(),this.worker.stopSecondConnection(!1),this.setState(r.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected()):this.showIgnored("onDisconnected(".concat(e,")"))},e.prototype.onTerminalError=function(){this.setState(r.TrouterManagerState.TerminalError),this.worker.dispatchTerminalError()},e.prototype.showIgnored=function(e){this.logger.info("Ignoring event '".concat(e,"' in state '").concat(r.TrouterManagerState[this.state],"'"))},e.prototype.setState=function(e){this.logger.info("Switching from state '".concat(r.TrouterManagerState[this.state],"' to state '").concat(r.TrouterManagerState[e],"'")),this.state!==e?this.state=e:this.logger.error("Attempt to switch to the current state '".concat(r.TrouterManagerState[e],"'"))},e}();t.TrouterManagerFsm=o},function(e,t,i){function n(e,t){if(!t)return e;var i=s(s({},e),{enabled:t.TelemetryEnabled});return void 0!==t.ClientTelemetryEventEnabled&&(i=s(s({},i),t.ClientTelemetryEventEnabled)),i}function r(e,t,i){var r,a,o,c,l,d,h,u,g,p,m=function(i){return e.proxyUrlRewrite?(t.info("Using rewritten URL for proxy"),e.proxyUrlRewrite(i)):i};return{clientInfo:{ua:e.trouterSettings.productName,v:e.trouterSettings.version},ioOptions:{ackTimeoutMs:5e3,rewriteUrlForProxy:m},clientCorrelationID:e.trouterSettings.sessionId,environment:e.trouterSettings.environment,telemetrySettings:n(e.telemetryConfig.settings,i),eventLogger:e.telemetryConfig.eventLogger,endpointId:e.trouterSettings.registrationId,trouterUrl:(null==i?void 0:i.TrouterConnectionUrl)||e.trouterSettings.trouterServiceUrl,registration:e.trouterSettings.registrarServiceUrl?{registrarUrl:e.trouterSettings.registrarServiceUrl,registrationId:null!==(r=e.trouterSettings.registrationId)&&void 0!==r?r:"",pnhAppId:null!==(a=e.trouterSettings.pnhAppId)&&void 0!==a?a:"",platform:null!==(o=e.trouterSettings.platform)&&void 0!==o?o:"",pnhTemplateKey:null!==(c=e.trouterSettings.pnhTemplate)&&void 0!==c?c:"",platformUIVersion:null!==(l=e.trouterSettings.platformUIVersion)&&void 0!==l?l:"",productContext:e.trouterSettings.pnhProductContext||void 0,context:null!==(d=e.trouterSettings.pnhContext)&&void 0!==d?d:"",registrarTtlSec:(null!==(h=e.trouterSettings.maxRegistrationTimeInMs)&&void 0!==h?h:0)/1e3}:void 0,connectionDependsOnRegistration:void 0===e.trouterSettings.registrarServiceUrl?function(){return!1}:null!==(u=e.trouterSettings.connectionDependsOnRegistration)&&void 0!==u?u:function(){return!1},delayEventsUntilRegistered:null!==(g=e.trouterSettings.delayEventsUntilRegistered)&&void 0!==g?g:function(){return!1},timeoutOptions:s({connectionTimeoutMs:e.trouterSettings.trouterConnectTimeoutInMs||3e4,fetchTimeoutMs:1e4,pingTimeoutMs:4e4,pongTimeoutMs:5e3,maxBackoffMs:"TeamsCDL"===e.trouterSettings.productName?3e5:3e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},e.trouterSettings.timeoutOptions),incallTimeoutOptions:s({connectionTimeoutMs:1e4,fetchTimeoutMs:5e3,pingTimeoutMs:5e3,pongTimeoutMs:2e3,maxBackoffMs:"TeamsCDL"===e.trouterSettings.productName?3e5:1e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},e.trouterSettings.incallTimeoutOptions),incallModeTimeoutMs:null!==(p=e.trouterSettings.incallModeTimeoutMs)&&void 0!==p?p:0,lingeringConnectionDelayMs:6e4,userActivitySecondResendDelayMs:e.trouterSettings.userActivitySecondResendDelayMs||1e4,duplicateDisconnectThresholdMs:1e4,connectionCache:e.connectionCache,registrationStateCallback:e.registrationStateCallbackForAcsDoNotUse,rewriteUrlForProxy:m,retryLimitOnTokenFetch:e.trouterSettings.retryLimitOnTokenFetch,extraConnectionHeaders:e.trouterSettings.extraConnectionHeaders,expediteBackoffOnStartMinimumDelayMs:1e4,toJSON:function(){return s(s({},this),{connectionCache:this.connectionCache?{}:this.connectionCache})}}}var s=this&&this.__assign||function(){return s=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},s.apply(this,arguments)},a=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(a,o)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(c=0)),c;)try{if(r=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,s=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(a=(a=c.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],s=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,s,a,o,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(t,"__esModule",{value:!0}),t.replaceTrouterUrlBase=t.getTrouterServiceVersion=t.createTrouterService=t.TrouterService=t.UserActivityState=t.TrouterState=void 0;var c=i(1),l=i(2);Object.defineProperty(t,"TrouterState",{enumerable:!0,get:function(){return l.TrouterState}}),Object.defineProperty(t,"UserActivityState",{enumerable:!0,get:function(){return l.UserActivityState}});var d=i(0),h=i(8),u=i(9),g=i(10),p=i(11),m=function(){function e(e){this.logProvider=e,this.stateChangedListeners=[],this.logger=new d.Logger("Trouter",e),this.trouterUrlPromise=new p.TrouterUrlPromise(e),this.messageHandlers=new h.MessageHandlerRegistry(e),this.listeners={},this.connectionInfo=null,this.logger.info("Created TrouterService version ".concat(c.CLIENT_VERSION))}return e.prototype.start=function(e){var t;if(this.logger.info("Start"),!e.skypeTokenProvider&&!e.authTokenProvider)throw new Error("no token provider has been configured, either skypeTokenProvider or authTokenProvider must be populated");e.skypeTokenProvider&&!e.trouterSettings.disableInternalSkypeTokenCache&&(e.skypeTokenProvider=(0,u.addCacheAsBackupTo)(e.skypeTokenProvider)),this.trouterCfg=e;var i=r(e,this.logger,this.ecsCfg);!1===e.internalEnableV4cProtocol&&(i.forceV4aProtocol=!0);var n=function(e,t){var i,n=this;return function(r){return a(n,void 0,void 0,(function(){var n,s,a;return o(this,(function(o){switch(o.label){case 0:n=new Date,s=setInterval((function(){var t=Math.round((Date.now()-n.getTime())/6e4);e.warn("Note: Trouter auth token request promise from ".concat(n.toISOString()," has not been resolved for ").concat(t," minutes. The client is blocked from operating properly"))}),3e5),o.label=1;case 1:return o.trys.push([1,,3,4]),[4,t(r)];case 2:return a=o.sent(),r.needFresh&&a.token===i&&e.error("API violation: Trouter auth token provider got a request with needRefresh=true, but returned the same token as last time anyway. Please fix the host app"),i=a.token,[2,a];case 3:return clearInterval(s),[7];case 4:return[2]}}))}))}}(this.logger,null!==(t=e.authTokenProvider)&&void 0!==t?t:function(e){var t=this;return function(i){return a(t,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return t={},[4,e(i.needFresh)];case 1:return[2,(t.token=n.sent(),t.tokenType="skype",t)]}}))}))}}(e.skypeTokenProvider));void 0===this.trouterServer&&(this.trouterServer=new g.TrouterManager(this.logProvider,i,n,void 0===e.authTokenProvider,this)),void 0!==this.pendingActivityState&&(this.trouterServer.setUserActivityState(this.pendingActivityState[0],this.pendingActivityState[1]),this.pendingActivityState=void 0),this.trouterServer.start()},e.prototype.stop=function(e){this.logger.info("close connection"),this.trouterUrlPromise.rejectUrl(new Error("TrouterService is stopped")),void 0!==this.trouterServer&&this.trouterServer.stop(e)},e.prototype.setEcsConfig=function(e){return a(this,void 0,void 0,(function(){var t=this;return o(this,(function(i){return[2,new Promise((function(i){if(t.ecsCfg=e.TrouterJScriptClient,t.logger.info("Setting ECS configuration to ".concat(JSON.stringify(t.ecsCfg))),void 0!==t.trouterServer&&void 0!==t.trouterCfg){var n=r(t.trouterCfg,t.logger,t.ecsCfg);t.trouterServer.configure(n)}i()}))]}))}))},e.prototype.checkConnection=function(e){void 0!==this.trouterServer&&this.trouterServer.checkConnection(null!=e&&e)},e.prototype.resendRegistration=function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){if(!this.trouterServer)throw new Error("resendRegistration called too early");return[2,this.trouterServer.resendRegistration()]}))}))},e.prototype.registerListener=function(e,t){return""===t||!t.startsWith("/")||t.includes("?")||t.includes("#")?(this.logger.error("Listener path '".concat(t,"' is not valid")),!1):this.listeners[t]?(this.logger.error("Another listener is already registered for path '".concat(t,"'")),!1):(this.listeners[t]=e,this.logger.debug("Listener for path '".concat(t,"' registered")),this.connectionInfo&&e.onTrouterConnected(this.connectionInfo.baseEndpointUrl+t,this.connectionInfo),!0)},e.prototype.unregisterListener=function(e){for(var t=[],i=0,n=Object.keys(this.listeners);i<n.length;i++){var r=n[i];this.listeners[r]===e&&t.push(r)}if(0===t.length)return!1;for(var s=0,a=t;s<a.length;s++)r=a[s],delete this.listeners[r];return this.logger.debug("Listener for path(s) '".concat(t.join("', '"),"' unregistered")),!0},e.prototype.onTrouterConnected=function(e,t){this.logger.debug("Trouter is now connected");for(var i=0,n=Object.keys(this.listeners);i<n.length;i++){var r=n[i];try{this.listeners[r].onTrouterConnected(t.baseEndpointUrl+r,t)}catch(e){this.logger.error("Listener '".concat(r,"' threw an exception from onTrouterConnected(): ").concat(e))}}this.connectionInfo=t,this.trouterUrlPromise.resolveUrl(e),this.notifyStateChanged(l.TrouterState.Connected,{url:e,getRemainingTtlInSec:function(){return t.connectionTtlSec}})},e.prototype.onTrouterDisconnected=function(){this.logger.debug("Trouter is now disconnected"),this.connectionInfo=null;for(var e=0,t=Object.keys(this.listeners);e<t.length;e++){var i=t[e],n=this.listeners[i];if(n.onTrouterDisconnected)try{n.onTrouterDisconnected()}catch(e){this.logger.error("Listener '".concat(i,"' threw an exception from onTrouterDisconnected(): ").concat(e))}}this.notifyStateChanged(l.TrouterState.Disconnected)},e.prototype.onTrouterRequest=function(e,t){for(var i="",n=0,r=Object.keys(this.listeners);n<r.length;n++){var s=r[n];e.path.startsWith(s)&&s.length>i.length&&(i=s)}if(""===i)this.tryMessageHandlers(e,t)||(t.status=404,t.headers={"Trouter-Responder":"ClientLib"},t.send());else try{this.listeners[i].onTrouterRequest(e,t)}catch(e){this.logger.error("Listener '".concat(i,"' threw an exception from onTrouterRequest(): ").concat(e)),t.status=500,t.headers={"Trouter-Responder":"ClientLib"},t.send()}},e.prototype.onTrouterMessageLoss=function(e){this.logger.info("onTrouterMessageLoss called with tags [".concat(e,"]"));for(var t=!0,i=0,n=Object.keys(this.listeners);i<n.length;i++){var r=n[i],s=this.listeners[r];if(s.onTrouterMessageLoss)try{void 0===(t=s.onTrouterMessageLoss(e)&&t)&&(this.logger.error("Listener '".concat(r,"' did not return a boolean value from onTrouterMessageLoss()")),t=!1)}catch(e){this.logger.error("Listener '".concat(r,"' threw an exception from onTrouterMessageLoss(): ").concat(e)),t=!1}}return t},e.prototype.onTrouterUserActivityStateAccepted=function(e){this.logger.debug("onTrouterUserActivityStateAccepted cv: ".concat(e));for(var t=0,i=Object.keys(this.listeners);t<i.length;t++){var n=i[t],r=this.listeners[n];if(r.onTrouterUserActivityStateAccepted)try{r.onTrouterUserActivityStateAccepted(e)}catch(e){this.logger.error("Listener '".concat(n,"' threw an exception from onTrouterUserActivityStateAccepted(): ").concat(e))}}},e.prototype.onAudiencesSetResolved=function(e,t){this.logger.debug("onAudiencesSetResolved cv: ".concat(t));for(var i=0,n=Object.keys(this.listeners);i<n.length;i++){var r=n[i],s=this.listeners[r];if(s.onAudiencesSetResolved)try{s.onAudiencesSetResolved(e,t)}catch(e){this.logger.error("Listener '".concat(r,"' threw an exception from onAudienceSubscribed(): ").concat(e))}}},e.prototype.setUserActivityState=function(e,t){if(e!==l.UserActivityState.Active&&e!==l.UserActivityState.Inactive)throw new Error("setUserActivityState called with unsupported value ".concat(e));this.logger.info("setUserActivityState called with value ".concat(l.UserActivityState[e])),this.trouterServer&&this.state()!==l.TrouterState.Unknown?this.trouterServer.setUserActivityState(e,t):(this.pendingActivityState=[e,t],this.logger.warn("setUserActivityState called before start() or after stop()"))},e.prototype.setAudienceSubscriptions=function(e,t){if(e.audienceSubscriptions.length>1)throw new Error("Only singular audience subscription is supported");if(this.trouterServer&&this.state()!==l.TrouterState.Unknown)return this.trouterServer.setAudienceSubscriptionsAsync(e,15e3,t);throw new Error("audience subscribe called before start() or after stop()")},e.prototype.state=function(){return void 0!==this.trouterServer?this.trouterServer.getState():l.TrouterState.Unknown},e.prototype.isInTerminalState=function(){return void 0!==this.trouterServer&&this.trouterServer.isInTerminalState()},e.prototype.reportStateInfo=function(){return void 0===this.trouterServer?"":this.trouterServer.reportStateInfo()},e.prototype.getServerState=function(){if(void 0!==this.trouterServer)return this.trouterServer.getServerState()},e.prototype.getTrouterUrlAsync=function(){return void 0!==this.trouterServer?this.trouterUrlPromise.getPromise():Promise.reject(new Error("TrouterService has not been started"))},e.prototype.onStateChanged=function(e){if(this.logger.info("onStateChanged called"),void 0===e)this.stateChangedListeners=this.stateChangedListeners.filter((function(e){return void 0===e.wrappedCallback}));else{this.offStateChanged(e);var t=function(t,i){e(t,i?i.url:"")};t.wrappedCallback=e,this.stateChangedListeners.push(t)}},e.prototype.offStateChanged=function(e){this.logger.info("offStateChanged called");var t=this.stateChangedListeners.length;return this.stateChangedListeners=this.stateChangedListeners.filter((function(t){return t.wrappedCallback!==e})),t>this.stateChangedListeners.length},e.prototype.addCallback=function(e){this.logger.info("addListener called"),-1===this.stateChangedListeners.indexOf(e,0)&&void 0!==e&&this.stateChangedListeners.push(e)},e.prototype.removeCallback=function(e){this.logger.info("removeListener called");var t=this.stateChangedListeners.indexOf(e,0);return t>-1&&(this.stateChangedListeners.splice(t,1),!0)},e.prototype.registerMessageHandler=function(e){this.logger.info("registerMessageHandler is called"),this.messageHandlers.register(e)},e.prototype.clearMessageHandlers=function(){this.logger.info("clearMessageHandlers is called"),this.messageHandlers.clear()},e.prototype.notifyStateChanged=function(e,t){var i=this;this.logger.info("notifyStateChanged called, will forward to ".concat(this.stateChangedListeners.length," listeners")),this.stateChangedListeners.forEach((function(n){try{n(e,t)}catch(e){i.logger.error("Error in callback ".concat(e))}}))},e.prototype.tryMessageHandlers=function(e,t){if(!this.messageHandlers.active())return!1;var i,n=null;try{n=(i=JSON.parse(e.body))&&(i.evt||i.eventId)||null}catch(e){}var r={eventId:n,url:(this.connectionInfo?this.connectionInfo.baseEndpointUrl:"")+e.path,body:i,rawBody:e.body,headers:e.headers},s=this.messageHandlers.handleMessage(r);return!!s.isHandled&&(t.status=s.resultCode,s.responseHeaders&&(t.headers=s.responseHeaders),s.responseBody&&(t.body=s.responseBody),t.send(),!0)},e}();t.TrouterService=m,t.createTrouterService=function(e){return new m(e)},t.getTrouterServiceVersion=function(){return c.CLIENT_VERSION},t.replaceTrouterUrlBase=function(e,t){var i=e.indexOf("://");if(i>=0){var n=e.indexOf("/",i+3);if(n>=0)return t+e.substr(n)}return""}},function(t,i){t.exports=e}])},e.exports=i(Q_)}));class Z_{constructor(e,t){this.logEvent=e=>{this._logger.debug(e),this._telemetryLogManager.sendEvent({name:e.name,tenant:"708a9eb9fe2646fe8f4c37b7eee2e3da-9b97485a-57b9-43a8-8177-07ca7a653a30-6706",properties:{...e.properties}})},this._logger=e.createChild("TelemetrySender"),this._telemetryLogManager=t}}class eE{constructor(e,t,i,n,r){this._ecsProvider=t,this._tokenProvider=i,this._isRegistered=!1,this._registeredChangedListeners=[],this._logger=e.createChild("Trouter"),this._logger.info("init"),this._initialRegistrationCompleteDefer=Nu(),this._telemetryLogManager=n,this._acsProxy=r}async start(e){let t;if(this._trouterService)throw this._logger.error("Trouterservice already initialized"),new I({defaultError:f.CALL_STACK.SIGNALING_SERVICE_ALREADY_INITIALIZED});{const i=new Promise((async(t,i)=>{try{if(this._logger.info("Trouterservice start"),this._trouterService=X_.createTrouterService(this._logger),!this._trouterService)throw this._logger.error("Failed to create trouter service"),new I({defaultError:f.CALL_STACK.SIGNALING_SERVICE_CREATE_FAIL});this._options=this._getTrouterConfig(this._logger,this._tokenProvider),e&&(this._options.trouterSettings.environment=e.environment||"",this._options.trouterSettings.sessionId=e.sessionId);let i,n,r=+new Date;this._trouterService.start(this._options),this._trouterService.onStateChanged(((e,t)=>{e===X_.TrouterState.Connected&&(i=+new Date)})),await this._initialRegistrationCompleteDefer.promise;const s=+new Date;i=i??+new Date,n=i,t({trouterRequestCompletionTimeDeltaMs:Math.max(0,i-r),registrarRequestCompletionTimeDeltaMs:Math.max(0,s-n)})}catch(e){i(e)}}));try{const e=Fu((()=>i),25e3);t=await e}catch(e){throw 408===e.code?(this._logger.error("Signaling init timeout"),new I({defaultError:f.CALL_STACK.SIGNALING_SERVICE_CREATE_TIMEOUT,defaultErrorMessageArgs:[25e3]})):(this._logger.error("Signaling init failed"),new I({defaultError:f.CALL_STACK.SIGNALING_INIT_FAIL}))}}return t}isRegistered(){return this._isRegistered}onRegisteredChanged(e){this._logger.info("TrouterService onRegisteredChanged"),this._registeredChangedListeners.push(e)}offRegisteredChanged(e){const t=this._registeredChangedListeners.indexOf(e);this._logger.info(`TrouterService offRegisteredChanged: ${t}`),t>-1&&this._registeredChangedListeners.splice(t,1)}stop(e){this._logger.info("Trouterservice stop"),this._trouterService?(this._trouterService.onStateChanged(void 0),this._trouterService.stop(e),this._trouterService=void 0):this._logger.error("Trouterservice not inited")}registerMessageHandler(e){this._logger.info("Trouterservice registerMessageHandler"),this._trouterService&&this._trouterService.registerMessageHandler(e)}clearMessageHandlers(){this._trouterService&&this._trouterService.clearMessageHandlers()}checkConnection(){this._trouterService&&this._trouterService.checkConnection()}state(){return this._logger.info("Trouterservice state"),this._trouterService?this._trouterService.state():X_.TrouterState.Unknown}onStateChanged(e){this._logger.info("Trouterservice onStateChanged"),this._trouterService&&this._trouterService.onStateChanged(e)}offStateChanged(e){this._logger.info("Trouterservice offStateChanged"),this._trouterService&&this._trouterService.offStateChanged(e)}getTrouterUrlAsync(){return this._trouterService?(this._logger.info("getTrouterUrlAsync called"),this._trouterService.getTrouterUrlAsync()):Promise.reject("Trouterservice not started yet")}_getSettings(){return{registrationId:x(),registrarServiceUrl:this._ecsProvider.getTrouterSettings().registrarServiceUrl,registrarTtlInSeconds:this._ecsProvider.getTrouterSettings().registrarTtlInSeconds,maxRegistrationTimeInMs:this._ecsProvider.getTrouterSettings().maxRegistrationTimeInMs,registrarRefreshTimeoutInMs:this._ecsProvider.getTrouterSettings().registrarRefreshTimeoutInMs,pnhAppId:this._ecsProvider.getTrouterSettings().pnhAppId,pnhTemplate:this._ecsProvider.getTrouterSettings().pnhTemplate,platform:this._ecsProvider.getTrouterSettings().platform,platformUIVersion:this._ecsProvider.getTrouterSettings().version,trouterServiceUrl:this._ecsProvider.getTrouterSettings().trouterServiceUrl,version:this._ecsProvider.getTrouterSettings().version,trouterConnectTimeoutInMs:this._ecsProvider.getTrouterSettings().trouterConnectTimeoutInMs,productName:this._ecsProvider.getTrouterSettings().productName,sessionId:x(),environment:this._ecsProvider.getTrouterSettings().environment,timeoutOptions:this._ecsProvider.getTrouterSettings().timeoutOptions}}_createTrouterTelemetryConfig(e){return{eventLogger:new Z_(e.createChild("TrouterTelemetry"),this._telemetryLogManager),settings:{enabled:this._ecsProvider.getTrouterTelemetryConfig().enabled,logHealthCheckError:this._ecsProvider.getTrouterTelemetryConfig().logHealthCheckError,trouter_js_client_connected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_connected,trouter_js_client_disconnected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_disconnected,trouter_js_client_error:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_error,trouter_js_client_progress:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_progress,trouter_js_client_response:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_response,numberOfStepsToMaintain:this._ecsProvider.getTrouterTelemetryConfig().numberOfStepsToMaintain,sendProgressTimeoutSecs:this._ecsProvider.getTrouterTelemetryConfig().sendProgressTimeoutSecs}}}_getTrouterConfig(e,t){return{trouterSettings:this._getSettings(),proxyUrlRewrite:this._acsProxy.hasProxyUrl()?e=>this._acsProxy.proxyfyUrl(e):void 0,skypeTokenProvider:t,telemetryConfig:this._createTrouterTelemetryConfig(e),registrationStateCallbackForAcsDoNotUse:e=>{this._logger.info(`TrouterService registrationStateCallbackForAcs: ${e}`),this._isRegistered=e,this._initialRegistrationCompleteDefer.isPending()&&this._isRegistered?this._initialRegistrationCompleteDefer.resolve():this._isRegistered?this._logger.info("Signaling service is currently registered"):this._logger.error("Signaling service is currently not registered. Unable to receive incoming calls"),this._onRegisteredChanged(e)}}}_onRegisteredChanged(e){this._logger.info(`TrouterService onRegisteredChanged: ${e}`),this._registeredChangedListeners.forEach((t=>{t(e)}))}}class tE{constructor(e){this._eventToTenantId={skypecosi_concore_web_csa_conversation_httprequest:gc,skypecosi_concore_web_ts_calling_in_call_session:gc,skypecosi_concore_web_ts_calling_call_setup_session:gc,skypecosi_concore_native_ts_calling_in_call_session:gc,skypecosi_concore_native_ts_calling_call_setup_session:gc,skypecosi_concore_web_pluginless_call_session:gc,skypecosi_concore_web_pluginless_modality_session:gc,skypecosi_concore_web_csa_conversation_callmodality:gc,skypecosi_concore_web_ts_calling_registry:gc,mdsc_webrtc_session:pc,mdsc_webrtc_session_initial:pc,live_events:"2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326",mdsc_ortc_reports:pc,mdsc_ortc_reports_initial:pc,mdsc_rt_log:pc},this.getTenant=e=>this._eventToTenantId[e]?this._eventToTenantId[e]:"",this.getCallingAdapter=()=>({sendEvent:(e,t)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(e),name:e,properties:t})}}),this.getGenericTelemetryLogger=e=>({sendEvent:e=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(e.eventName),name:e.eventName,properties:e.props})}}),this.getMediaAdapter=()=>({sendEvent:(e,t)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(e),name:e,properties:t})}}),this.sendEvents=e=>(e.forEach((e=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(e.eventName),name:e.eventName,properties:e.props})})),Promise.resolve()),this._telemetryLogManager=e}}class iE{constructor(e,t,i,n,r,s=!0,a,o,c,l){this.configType=e,this.caConfigBag=t,this.queryParameters=i,this.ecsConfigReceiver=n,this.platformId=r,this.isAppInitiallyInForeground=s,this.userRawSkypeToken=a,this.userSkypeTokenExpiration=o,this.projectName=c,this.ecsHosts=l}}class nE{constructor(){this._timedVideoEffectProviderPromise=wl(3e3),this._timedModelConfigPromise=wl(3e3)}get videoEffectProviderDeferredPromise(){return this._timedVideoEffectProviderPromise.deferredPromise}get modelConfigDeferredPromise(){return this._timedModelConfigPromise.deferredPromise}async getVideoEffectProvider(){return this._timedVideoEffectProviderPromise.timerStart(),this._timedVideoEffectProviderPromise.deferredPromise.promise}async getModelConfig(){return this._timedModelConfigPromise.deferredPromise.resolve({modelUrl:"",weightPathPrefix:""}),this._timedModelConfigPromise.deferredPromise.promise}}class rE{constructor(e){this._encodedStreamsJsPath=e}async getWorkerUrl(){return this._encodedStreamsJsPath}}class sE{constructor(e,t){this.logger=e,this.proxy=t}getRequestOptions(e,t,i,n,r){return{headers:t||{},timeout:n,payload:i||null,responseType:r}}getAsync(e,t){return this.sendRequest(this.proxy.proxyfyUrl(e),t,"GET")}postAsync(e,t){return this.sendRequest(this.proxy.proxyfyUrl(e),t,"POST")}putAsync(e,t){return this.sendRequest(this.proxy.proxyfyUrl(e),t,"PUT")}removeAsync(e,t){return this.sendRequest(this.proxy.proxyfyUrl(e),t,"DELETE")}async sendRequest(e,t={headers:{}},i){const n=this.logger.createChild(`[${t.causeId||x()}][Request]`);n.info(`sending, ${i}-${e}`);const r=Date.now();let s;t.headers=t.headers||{},t.headers["content-type"]||(t.headers["content-type"]=t.contentType||"application/json");try{const a=Ky.request({url:e,method:i,headers:t.headers||{},timeout:"number"==typeof t.timeout?t.timeout:45e3,data:t.payload||"",responseType:t.responseType||t.dataType||"json",withCredentials:ml(t.withCredentials,!1),cancelToken:new Ky.CancelToken((e=>{s=e}))});(function(e){return!!e&&"function"==typeof e.then})(t.timeout)&&t.timeout.then((()=>{n.info("Aborting pending request"),s()}),(()=>{n.info("Timeout promise rejected, ignoring")}));const o=await a;return n.info(`success, status=${o.status}`),{response:o.data,request:o.request,duration:Date.now()-r}}catch(e){if(n.info("failed"),Ky.isCancel(e))throw n.info(`response=${fl(e.response)}`),{aborted:!0};throw e.response?n.info(`response=${fl(e.response)}`):e.request?n.info(`no response, request=${fl(e.request)}`):n.info(`request not made, error=${fl(e)}`),e||new Error("Request failed")}}}class aE{constructor(){this._activeEffects=[],this.eventEmitter=new ep.EventEmitter}on(e,t){if("statusChanged"!==e)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("statusChanged"!==e)throw new I({defaultError:f.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}getActiveEffects(){return this._activeEffects}setActiveEffects(e){const t=this._activeEffects;this._activeEffects=e,this.eventEmitter.emit("statusChanged",t,this._activeEffects)}}!function(e){e[e.Default=0]="Default",e[e.User=1]="User"}(Y_||(Y_={}));class oE{constructor(){this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this.eventEmitter=new ep.EventEmitter}on(e,t){if("statusChanged"!==e)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.on(e,t)}off(e,t){if("statusChanged"!==e)throw new I({defaultError:f.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this.eventEmitter.off(e,t)}getActiveEffects(){return this._activeEffects}setActiveEffects(e,t){const i={...this._activeEffects};this._activeEffects={...e},this.eventEmitter.emit("statusChanged",i,this._activeEffects,t)}}class cE{get providerValue(){return this._providerValue}set providerValue(e){this._providerValue=e}async getAudioEffectProvider(){return this.providerValue}}var lE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._isAllowed=!1}return e.prototype.putBackgroundFetchAllowed=function(e){if(this._isAllowed=e,this.isBackgroundFetchAllowed()&&this._isAllowedDeferral){var t=this._isAllowedDeferral;this._isAllowedDeferral=void 0,t.resolve(void 0)}},e.prototype.isBackgroundFetchAllowed=function(){return this._isAllowed},e.prototype.waitForBackgroundFetchAllowed=function(){return this.isBackgroundFetchAllowed()?l.Resolved():(this._isAllowedDeferral||(this._isAllowedDeferral=l.Defer()),this._isAllowedDeferral.promise())},e}();t.default=i})),dE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._isActive=!1}return e.prototype.putAppActive=function(e){if(this._isActive=e,this.isAppActive()&&this._appActiveDeferral){var t=this._appActiveDeferral;this._appActiveDeferral=void 0,t.resolve(void 0)}},e.prototype.isAppActive=function(){return this._isActive},e.prototype.waitForAppActive=function(){return this.isAppActive()?l.Resolved():(this._appActiveDeferral||(this._appActiveDeferral=l.Defer()),this._appActiveDeferral.promise())},e}();t.default=i})),hE=function(){function e(e,t){this._event=e,this._callback=t}return e.prototype.unsubscribe=function(){this._event.unsubscribe(this._callback)},e}(),uE=function(){function e(e){void 0===e&&(e=!1);var t=this;this._allowStopPropagation=e,this.fire=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];for(var n=t._subscribers,r=n.length-1;r>=0;r--){var s=n[r].apply(null,e);if(t._allowStopPropagation&&s)return!0}return!1},this._subscribers=[]}return e.prototype.dispose=function(){this._subscribers=[]},e.prototype.subscribe=function(e){return this._subscribers=this._subscribers.concat(e),new hE(this,e)},e.prototype.unsubscribe=function(e){this._subscribers=this._subscribers.filter((function(t){return t!==e}))},e}(),gE=Object.freeze({__proto__:null,SubscriptionToken:hE,default:uE}),pE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Default=0]="Default",e[e.User=1]="User"}(t.EcsConfigType||(t.EcsConfigType={}))})),mE=function(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(i){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})})),t}(gE),fE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this._config=e,this.configUpdated=new mE.default,this._cachedConfigs={}}return e.prototype.initialize=function(){return this.updateConfigsToFetch()},e.prototype.updateConfigsToFetch=function(){var e=this,t=this._config.getConfig(),i=t.databaseInterface,n=t.configsToFetch;if(!i)return l.Resolved();for(var r=[],s=function(t){if(a._cachedConfigs[t])return"continue";r.push(i.getData(t).then((function(i){i&&(e._cachedConfigs[t]=i)})).catch((function(){return l.Resolved()})))},a=this,o=0,c=n;o<c.length;o++)s(c[o]);return l.all(r).then((function(){r.length>0&&e.configUpdated.fire()}))},e.prototype.getEcsConfig=function(){return this._cachedConfigs[pE.EcsConfigType.User]||this._cachedConfigs[pE.EcsConfigType.Default]},e.prototype.getEcsConfigByType=function(e){return this._cachedConfigs[e]},e.prototype.putConfig=function(e){var t=this.getEcsConfig();this._cachedConfigs[e.configType]=e;var i=this.getEcsConfig();(i&&i.configType===e.configType||t&&i&&t.configType!==i.configType)&&this.configUpdated.fire();var n=this._config.getConfig().databaseInterface;return n?n.putData(e.configType,e):l.Resolved()},e}();t.default=i})),SE=a((function(e,t){var i=s&&s.__assign||function(){return i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.initialize=function(e){if(this._config)throw"ECS Configuration already initialized";this._config=e},e.prototype.getConfig=function(){if(!this._config)throw"ECS Configuration not yet initialized";return this._config},e.prototype.setConfigsToFetch=function(e){if(!this._config)throw"ECS Configuration not yet initialized";this._config=i({},this._config,{configsToFetch:e})},e.prototype.setFetchTimeout=function(e){if(!this._config)throw"ECS Configuration not yet initialized";this._config=i({},this._config,{fetchTimeout:e})},e}();t.default=n})),vE=a((function(e,t){var i=s&&s.__assign||function(){return i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.assert=function(e,t){if(!e)throw new Error(t)},t.isObject=function(e){return null!==e&&"object"==typeof e},t.isString=function(e){return"string"==typeof e},t.attempt=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.apply(void 0,t)}catch(e){return new Error(e)}},t.remove=function(e,t){for(var i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)},t.clone=function(e){return Array.isArray(e)?e.map(t.clone):t.isObject(e)?Object.keys(e).reduce((function(n,r){var s;return i(i({},n),((s={})[r]=t.clone(e[r]),s))}),{}):e}})),yE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_TIME_GROW_FACTOR=2.718281828459045,t.DEFAULT_TIME_JITTER=.11962656472;var i=function(){function e(e,i,n,r){void 0===n&&(n=t.DEFAULT_TIME_GROW_FACTOR),void 0===r&&(r=t.DEFAULT_TIME_JITTER),this._initialTime=e,this._maxTime=i,this._growFactor=n,this._jitterFactor=r,vE.assert(this._initialTime>0,"Initial delay must be positive"),vE.assert(this._maxTime>0,"Delay upper bound must be positive"),vE.assert(this._growFactor>=0,"Ratio must be non-negative"),vE.assert(this._jitterFactor>=0,"Jitter factor must be non-negative"),this.reset()}return e.prototype.reset=function(){this._incrementCount=0,this._currentTime=Math.round(this._initialTime*(1+Math.random()*this._jitterFactor))},e.prototype.getTime=function(){return this._currentTime},e.prototype.getIncrementCount=function(){return this._incrementCount},e.prototype.calculateNext=function(){var e=this._currentTime*this._growFactor;return e>this._maxTime&&(e=this._maxTime),this._jitterFactor<1e-5?this._currentTime=e:this._currentTime=Math.round(Math.random()*e*this._jitterFactor+e),this._currentTime<this._initialTime&&(this._currentTime=this._initialTime),this._currentTime>this._maxTime&&(this._currentTime=this._maxTime),this._incrementCount++,this._currentTime},e.prototype.getTimeAndCalculateNext=function(){var e=this.getTime();return this.calculateNext(),e},e}();t.ExponentialTime=i})),CE=a((function(e,t){var i,n,r,a=s&&s.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},i(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=s&&s.__assign||function(){return o=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)};function c(e){return!!e&&0===e.indexOf("application/json")}function d(e,t){return t.canceled||!t.statusCode||t.statusCode>=400&&t.statusCode<600?r.DoNotRetry:r.RetryCountedWithBackoff}Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.DontCare=0]="DontCare",e[e.Low=1]="Low",e[e.Normal=2]="Normal",e[e.High=3]="High",e[e.Critical=4]="Critical"}(n=t.WebRequestPriority||(t.WebRequestPriority={})),function(e){e[e.DoNotRetry=0]="DoNotRetry",e[e.RetryUncountedImmediately=1]="RetryUncountedImmediately",e[e.RetryUncountedWithBackoff=2]="RetryUncountedWithBackoff",e[e.RetryCountedWithBackoff=3]="RetryCountedWithBackoff",e[e.PauseUntilResumed=4]="PauseUntilResumed"}(r=t.ErrorHandlingType||(t.ErrorHandlingType={})),t.DefaultOptions={priority:n.Normal},t.SimpleWebRequestOptions={MaxSimultaneousRequests:5,HungRequestCleanupIntervalMs:1e4,setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){return clearTimeout(e)}},t.DefaultErrorHandler=d;var h,u=[],g=[],p=[],m=0,f=0,S=function(){function e(e,i,n,r,s){this._action=e,this._url=i,this.options=n,this._getHeaders=r,this._blockRequestUntil=s,this._aborted=!1,this._timedOut=!1,this._paused=!1,this._created=Date.now(),this._finishHandled=!1,this._retryExponentialTime=new yE.ExponentialTime(1e3,3e5),this._options=o(o({},t.DefaultOptions),n)}return e.prototype.getPriority=function(){return this._options.priority||n.DontCare},e.checkQueueProcessing=function(){for(var e=function(){var e=u.shift();g.push(e),(e._blockRequestUntil&&e._blockRequestUntil()||l.Resolved()).finally((function(){vE.remove(g,e)})).then((function(){p.length<t.SimpleWebRequestOptions.MaxSimultaneousRequests&&!e._aborted?(p.push(e),v._scheduleHungRequestCleanupIfNeeded(),e._fire()):e._enqueue()}),(function(t){e._respond("_blockRequestUntil rejected: "+t)}))};u.length>0&&p.length<t.SimpleWebRequestOptions.MaxSimultaneousRequests;)e()},e._scheduleHungRequestCleanupIfNeeded=function(){p.length>0&&void 0===h?h=t.SimpleWebRequestOptions.setTimeout(this._hungRequestCleanupTimerCallback,t.SimpleWebRequestOptions.HungRequestCleanupIntervalMs):0===p.length&&h&&(t.SimpleWebRequestOptions.clearTimeout(h),h=void 0)},e.prototype._removeFromQueue=function(){vE.remove(p,this),vE.remove(u,this)},e.prototype._assertAndClean=function(e,t){e||(this._removeFromQueue(),console.error(t),vE.assert(e,t))},e.prototype._fire=function(){var i=this;this._xhr=new XMLHttpRequest,this._xhrRequestHeaders={};var n=vE.attempt((function(){i._xhr.open(i._action,i._url,!0)}));if(n)this._respond(n.toString());else{if(this._options.timeout){var r=f;3!==r&&(this._assertAndClean(!this._requestTimeoutTimer,"Double-fired requestTimeoutTimer"),this._requestTimeoutTimer=t.SimpleWebRequestOptions.setTimeout((function(){i._requestTimeoutTimer=void 0,i._timedOut=!0,i.abort()}),this._options.timeout)),(3===r||r<=1)&&(this._xhr.timeout=this._options.timeout,this._xhr.ontimeout=function(){f=3,3===r&&(i._timedOut=!0,i._aborted=!0,i._respond("TimedOut"))})}var s=m;3!==s?(0===s&&(m=1),this._xhr.onreadystatechange=function(){i._xhr&&(3!==i._xhr.readyState||!i._options.streamingDownloadProgress||i._aborted?4===i._xhr.readyState&&(0===s&&1===m&&t.SimpleWebRequestOptions.setTimeout((function(){3!==m&&(m=2)}),1e4),i._respond()):i._options.streamingDownloadProgress(i._xhr.responseText))}):this._options.streamingDownloadProgress&&(this._xhr.onreadystatechange=function(){i._xhr&&3===i._xhr.readyState&&i._options.streamingDownloadProgress&&!i._aborted&&i._options.streamingDownloadProgress(i._xhr.responseText)}),2!==s&&(this._xhr.onload=function(){m=3,3===s&&i._respond()},this._xhr.onerror=function(){m=3,3===s&&i._respond()}),this._xhr.onabort=function(){i._aborted=!0,i._respond("Aborted")},this._xhr.upload&&this._options.onProgress&&(this._xhr.upload.onprogress=this._options.onProgress);var a=this._options.acceptType||"json",o=this._options.customResponseType||e._getResponseType(a),c=vE.attempt((function(){i._xhr.responseType=o}));if(c&&"json"!==o)throw c;v._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Accept",e.mapContentType(a)),this._xhr.withCredentials=!!this._options.withCredentials;var l=this.getRequestHeaders(),d={};if(Object.keys(l).forEach((function(e){var t=l[e],n=e.toLowerCase();"content-type"!==n?"accept"!==n?(i._assertAndClean(!d[n],"Setting duplicate header key: "+d[n]+" and "+e),null!=t?(d[n]=!0,v._setRequestHeader(i._xhr,i._xhrRequestHeaders,e,t)):console.warn('Tried to set header "'+e+'" on request with "'+t+'" value, header will be dropped')):i._assertAndClean(!1,"Don't set Accept with options.headers -- use it with the options.acceptType property"):i._assertAndClean(!1,"Don't set Content-Type with options.headers -- use it with the options.contentType property")})),this._options.sendData){var h=e.mapContentType(this._options.contentType||"json");v._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Content-Type",h);var u=e.mapBody(this._options.sendData,h);this._xhr.send(u)}else this._xhr.send()}},e._setRequestHeader=function(e,t,i,n){e.setRequestHeader(i,n),t[i]=n},e.mapContentType=function(e){return"json"===e?"application/json":"form"===e?"application/x-www-form-urlencoded":e},e.mapBody=function(e,t){if(c(t)){if(!vE.isString(e))return JSON.stringify(e)}else if(function(e){return!!e&&0===e.indexOf("application/x-www-form-urlencoded")}(t)){if(!vE.isString(e)&&vE.isObject(e)){var i=e;return Object.keys(i).map((function(e){return encodeURIComponent(e)+(i[e]?"="+encodeURIComponent(i[e].toString()):"")})).join("&")}}else if(function(e){return!!e&&0===e.indexOf("multipart/form-data")}(t)){if(vE.isObject(e)){var n=new FormData,r=e;return Object.keys(r).forEach((function(e){return n.append(e,r[e])})),n}vE.assert(!1,"contentType multipart/form-data must include an object as sendData")}return e},e.prototype.setUrl=function(e){this._url=e},e.prototype.setHeader=function(e,t){this._options.augmentHeaders||(this._options.augmentHeaders={}),t?this._options.augmentHeaders[e]=t:delete this._options.augmentHeaders[e]},e.prototype.getRequestHeaders=function(){var e={};return!this._getHeaders||this._options.overrideGetHeaders||this._options.headers||(e=o(o({},e),this._getHeaders())),this._options.overrideGetHeaders&&(e=o(o({},e),this._options.overrideGetHeaders)),this._options.headers&&(e=o(o({},e),this._options.headers)),this._options.augmentHeaders&&(e=o(o({},e),this._options.augmentHeaders)),e},e.prototype.getOptions=function(){return vE.clone(this._options)},e.prototype.setPriority=function(e){this._options.priority!==e&&(this._options.priority=e,this._paused||this._xhr||(vE.remove(u,this),this._enqueue()))},e.prototype.resumeRetrying=function(){this._paused?(this._paused=!1,this._enqueue()):vE.assert(!1,"resumeRetrying() called but not paused!")},e.prototype._enqueue=function(){var t=this;if(!this._aborted&&!(p.indexOf(this)>=0||g.indexOf(this)>=0||u.indexOf(this)>=0)){var i=u.findIndex((function(e){return e.getPriority()===t.getPriority()&&e._created>t._created||e.getPriority()<t.getPriority()}));i>-1?u.splice(i,0,this):u.push(this),e.checkQueueProcessing()}},e._getResponseType=function(e){return"blob"===e?"arraybuffer":"text/xml"===e||"application/xml"===e?"document":"text/plain"===e?"text":"json"},e._hungRequestCleanupTimerCallback=function(){h=void 0,p.filter((function(e){return!(!e._xhr||4!==e._xhr.readyState||(console.warn("SimpleWebRequests found a completed XHR that hasn't invoked it's callback functions, manually responding"),0))})).forEach((function(e){e._respond()})),v._scheduleHungRequestCleanupIfNeeded()},e}();t.SimpleWebRequestBase=S;var v=function(e){function i(t,i,n,r,s){return e.call(this,t,i,n,r,s)||this}return a(i,e),i.prototype.abort=function(){this._aborted?vE.assert(!1,"Already aborted "+this._action+" request to "+this._url):(this._aborted=!0,this._retryTimer&&(t.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(t.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._deferred?(this._respond("Aborted"),this._xhr&&this._xhr.abort()):vE.assert(!1,"Haven't even fired start() yet -- can't abort"))},i.prototype.start=function(){var e=this;return this._deferred?(vE.assert(!1,"WebRequest already started"),l.Rejected("WebRequest already started")):(this._deferred=l.Defer(),this._deferred.onCancel((function(){e.abort()})),this._enqueue(),this._deferred.promise())},i.prototype._respond=function(e){var i=this;if(!this._finishHandled){this._finishHandled=!0,this._removeFromQueue(),this._retryTimer&&(t.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(t.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0);var n,s=0;if(this._xhr)try{s=this._xhr.status,n=this._xhr.statusText||e}catch(e){}else n=e||"Browser Error - Possible CORS or Connectivity Issue";var a,o,l={};if(this._xhr){if((this._xhr.getAllResponseHeaders()||"").split(/\r?\n/).forEach((function(e){if(0!==e.length){var t=e.indexOf(":");-1===t?l[e]="":l[e.substr(0,t).toLowerCase()]=e.substr(t+1).trim()}})),!l["content-type"]){var h=this._xhr.getResponseHeader("content-type");h&&(l["content-type"]=h)}if(a=this._xhr.response,l["content-type"]&&c(l["content-type"])&&(!a||!vE.isObject(a))&&("text"===this._xhr.responseType||""===this._xhr.responseType)&&this._xhr.responseText)try{a=JSON.parse(this._xhr.responseText)}catch(e){o=e,console.warn("Failed to parse XHR JSON response")}}if(this._xhr&&4===this._xhr.readyState&&(s>=200&&s<300||304===s)){var u={url:this._xhr.responseURL||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:s,statusText:n,headers:l,body:a,responseParsingException:o};this._deferred.resolve(u)}else{var g={url:(this._xhr?this._xhr.responseURL:void 0)||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:s,statusText:n,headers:l,body:a,canceled:this._aborted,timedOut:this._timedOut,responseParsingException:o};this._options.augmentErrorResponse&&this._options.augmentErrorResponse(g);var p=this._options.customErrorHandler?this._options.customErrorHandler(this,g):d(0,g);p!==r.DoNotRetry&&(this._options.retries&&this._options.retries>0||p===r.PauseUntilResumed||p===r.RetryUncountedImmediately||p===r.RetryUncountedWithBackoff)?(p===r.RetryCountedWithBackoff&&this._options.retries--,this._requestTimeoutTimer&&(t.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._aborted=!1,this._timedOut=!1,this._finishHandled=!1,this._xhr&&(this._xhr.onabort=null,this._xhr.onerror=null,this._xhr.onload=null,this._xhr.onprogress=null,this._xhr.onreadystatechange=null,this._xhr.ontimeout=null,this._xhr=void 0,this._xhrRequestHeaders=void 0),p===r.PauseUntilResumed?this._paused=!0:p===r.RetryUncountedImmediately?this._enqueue():this._retryTimer=t.SimpleWebRequestOptions.setTimeout((function(){i._retryTimer=void 0,i._enqueue()}),this._retryExponentialTime.getTimeAndCalculateNext())):this._deferred.reject(g)}S.checkQueueProcessing()}},i}(S);t.SimpleWebRequest=v})),_E=a((function(e,t){var i=s&&s.__assign||function(){return i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this._defaultOptions={excludeEndpointUrl:!1,withCredentials:!1,retries:0},this._endpointUrl=e}return e.prototype._performApiCall=function(e,t,n,r){var s=this;void 0===r&&(r={});var a=i(i({},this._defaultOptions),r);n&&(a.sendData=n),a.eTag&&(a.augmentHeaders||(a.augmentHeaders={}),a.augmentHeaders["If-None-Match"]=a.eTag),a.contentType||(a.contentType=vE.isString(a.sendData)?"form":"json");var o=a.excludeEndpointUrl?e:this._endpointUrl+e;return new CE.SimpleWebRequest(t,o,a,(function(){return s._getHeaders(a)}),(function(){return s._blockRequestUntil(a)})).start().then((function(e){return s._processSuccessResponse(e),e}))},e.prototype._getHeaders=function(e){return{}},e.prototype._blockRequestUntil=function(e){},e.prototype._processSuccessResponse=function(e){},e.prototype.performApiGet=function(e,t){return this.performApiGetDetailed(e,t).then((function(e){return e.body}))},e.prototype.performApiGetDetailed=function(e,t){return this._performApiCall(e,"GET",void 0,t)},e.prototype.performApiPost=function(e,t,i){return this.performApiPostDetailed(e,t,i).then((function(e){return e.body}))},e.prototype.performApiPostDetailed=function(e,t,i){return this._performApiCall(e,"POST",t,i)},e.prototype.performApiPatch=function(e,t,i){return this.performApiPatchDetailed(e,t,i).then((function(e){return e.body}))},e.prototype.performApiPatchDetailed=function(e,t,i){return this._performApiCall(e,"PATCH",t,i)},e.prototype.performApiPut=function(e,t,i){return this.performApiPutDetailed(e,t,i).then((function(e){return e.body}))},e.prototype.performApiPutDetailed=function(e,t,i){return this._performApiCall(e,"PUT",t,i)},e.prototype.performApiDelete=function(e,t,i){return this.performApiDeleteDetailed(e,t,i).then((function(e){return e.body}))},e.prototype.performApiDeleteDetailed=function(e,t,i){return this._performApiCall(e,"DELETE",t,i)},e}();t.GenericRestClient=n})),EE=a((function(e,t){function i(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),i(yE),i(_E),i(CE)})),TE=EE,IE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.prototype.getAttributes=function(){return{Source:"ecs_client"}},e}();t.TelemetryEventBase=i})),bE=a((function(e,t){var i,n=s&&s.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},i(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,i,n,r,s,a,o,c,l,d,h,u,g){var p=e.call(this)||this;return p._responseTime=t,p._responseCode=i,p._fetchAttempts=n,p._hasValidToken=r,p._serverEndpoint=s,p._etag=a,p._fetchDurationValid=o,p._cacheAvailable=c,p._responseSize=l,p._configAge=d,p._configExpired=h,p._fetchStart=u,p._fetchEnd=g,p}return n(t,e),t.prototype.getEventName=function(){return"ecs_tsclient_fetch_config"},t.prototype.getAttributes=function(){var t=e.prototype.getAttributes.call(this);return t.fetch_delay_ms=this._responseTime,t.fetch_response_code=this._responseCode,t.fetch_attempts=this._fetchAttempts,t.authenticated_user=this._hasValidToken,t.url=this._serverEndpoint,t.fetched_etag=this._etag,t.fetch_duration_valid=this._fetchDurationValid,t.cache_available=this._cacheAvailable,t.response_size=this._responseSize,t.config_age=this._configAge,t.config_expired=this._configExpired,t.fetch_start=this._fetchStart,t.fetch_end=this._fetchEnd,t},t}(IE.TelemetryEventBase);t.EcsConfigFetchResponse=r})),AE=a((function(e,t){var i,n=s&&s.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},i(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),r=s&&s.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var a,o,c=function(e){function t(t,i,n,r,s,a,o,c){var l=e.call(this,t)||this;if(l._config=i,l._skypeTokenData=n,l._appActiveData=r,l._allowBackgroundFetchData=s,l._etag=a,l._getUserConfig=o,l._apiPath="/config/v1/"+l._config.getConfig().clientName+"/"+l._config.getConfig().clientVersion,c){var d=Object.keys(c).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(c[e].toString())}));d&&(l._apiPath+="?"+d.join("&"))}return l}return n(t,e),t.prototype._blockRequestUntil=function(e){var t=this;if(this._getUserConfig&&!this._skypeTokenData.isSkypeTokenValid()&&console.log("ECS - Delaying User config fetch until we have a valid SkypeToken"),!this._appActiveData.isAppActive()&&!this._allowBackgroundFetchData.isBackgroundFetchAllowed()){var i=this._getUserConfig?"User config":"config";console.log("ECS - Delaying "+i+" fetch until the app is active (or background fetch is allowed)")}return l.race([this._appActiveData.waitForAppActive(),this._allowBackgroundFetchData.waitForBackgroundFetchAllowed()]).then((function(){if(t._getUserConfig)return t._skypeTokenData.waitForValidSkypeToken()})).then((function(){o=Date.now()}))},t.prototype._getHeaders=function(){var e={};return this._etag&&(e["If-None-Match"]=this._etag),this._getUserConfig&&(e.Authorization=this._skypeTokenData.getSkypeToken()),e},t.prototype.getConfig=function(){var t=this._config.getConfig().fetchTimeout;return void 0!==t&&(t<0?t=0:t>0&&t<3e4&&(t=3e4)),e.prototype.performApiGetDetailed.call(this,this._apiPath,{timeout:t})},t}(TE.GenericRestClient),d=function(){function e(e,t,i,n,r){this._config=e,this._skypeTokenData=t,this._appActiveData=i,this._allowBackgroundFetchData=n,this._telemetryManager=r,this._ecsFailureBackoffTimer=new TE.ExponentialTime(1e3,3e5),this._cacheMaxAgeRegex=/.*max-age=(\d+).*/gi,this._serverIndex=NaN}return e.prototype.getConfig=function(e,t,i){var n=this,s=this._config.getConfig().hosts;if((isNaN(this._serverIndex)||this._serverIndex>s.length-1)&&(this._serverIndex=Math.floor(Math.random()*s.length)),!s||!s.length)return l.Rejected(new Error("no configuration service endpoint"));var d=l.Defer(),h=0,u=function(){var g=e&&e.eTag?e.eTag:void 0,p=new c(s[n._serverIndex],n._config,n._skypeTokenData,n._appActiveData,n._allowBackgroundFetchData,g,t,i);h++,p.getConfig().then((function(i){var c=i.headers.etag,u=i.headers.expires;if(i.body&&i.body.Headers&&(c||(c=i.body.Headers.ETag),u||(u=i.body.Headers.Expires)),a=Date.now(),!c||!u)return console.warn("ECS - Service returned an empty ETag or Expiration header: "+JSON.stringify(i)),l.Rejected();var p,m=new Date(n._calculateExpirationDate(i.headers)).getTime();if(304===i.statusCode&&e)(p=r({},e)).eTag=c,p.expiration=m,p.cacheUpdateTime=a,p.lastFetchTokenHash=n._skypeTokenData.getSkypeTokenHash(i.requestHeaders.Authorization);else{if("object"!=typeof i.body)return console.warn("ECS - Service returned invalid response "+JSON.stringify(i)),l.Rejected();p={config:i.body,configType:t?pE.EcsConfigType.User:pE.EcsConfigType.Default,eTag:c,expiration:m,cacheUpdateTime:o,lastFetchTokenHash:n._skypeTokenData.getSkypeTokenHash(i.requestHeaders.Authorization),appVersion:n._config.getConfig().clientVersion}}var f=a-o,S=!(f<0||f>31536e6),v=e?Date.now()-e.cacheUpdateTime:0;n._telemetryManager.sendTelemetryEvent(new bE.EcsConfigFetchResponse(f,i.statusCode,h,n._skypeTokenData.isSkypeTokenValid(),s[n._serverIndex],c,S,!!g,JSON.stringify(i).length,v,!(e&&e.expiration-Date.now()>0),o,a)),n._ecsFailureBackoffTimer.reset(),d.resolve(p)})).catch((function(){n._serverIndex=(n._serverIndex+1)%s.length,setTimeout((function(){u()}),n._ecsFailureBackoffTimer.getTimeAndCalculateNext())}))};return u(),d.promise()},e.prototype._calculateExpirationDate=function(e){var t=Date.now()+1728e5;if(e.date&&e.expires){var i=new Date(e.date).getTime(),n=Date.now()-i,r=new Date(e.expires).getTime();return isNaN(r)?t:Math.min(t,r+n)}var s=this._cacheMaxAgeRegex.exec(e["cache-control"]);return this._cacheMaxAgeRegex.lastIndex=0,s&&2===s.length?Math.min(t,Date.now()+1e3*Number(s[1])):Date.now()+18e5},e}();t.default=d})),RE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,n,r,s){var a=this;this._config=e,this._skypeTokenData=t,this._cache=i,this._isFetchingSettings={},this._pendingFetch={},this._paused=!1,this._fetchEcsSettingsIfNeeded=function(e){var t=a._config.getConfig(),i=a._cache.getEcsConfigByType(e);if(-1!==t.configsToFetch.indexOf(e)&&!a._isFetchingSettings[e])if(i||!a._pendingFetch[e]){var n=i?i.expiration-Date.now():-1;n<=0||i&&e===pE.EcsConfigType.User&&a._skypeTokenData.isSkypeTokenValid()&&i.lastFetchTokenHash!==a._skypeTokenData.getSkypeTokenHash(a._skypeTokenData.getSkypeToken())?a._fetchSkypeEcsSettings(e):setTimeout((function(){return a._fetchEcsSettingsIfNeeded(e)}),n)}else a._fetchSkypeEcsSettings(e)},this._fetchSkypeEcsSettings=function(e,t){void 0===t&&(t=!1),a._isFetchingSettings[e]||a._paused&&!t?a._pendingFetch[e]=!0:(a._pendingFetch[e]=!1,a._isFetchingSettings[e]=!0,a._config.getConfig().getEcsParameters().catch((function(){return console.warn("ECS - Failed to fetch ECS fetching parameters"),{}})).then((function(t){return a._ecsClient.getConfig(a._cache.getEcsConfig(),e===pE.EcsConfigType.User,t)})).then((function(t){console.log("ECS - Config fetch complete"),a._isFetchingSettings[e]=!1,a._cache.putConfig(t),a._fetchEcsSettingsIfNeeded(e)})))},this._ecsClient=new AE.default(this._config,this._skypeTokenData,n,r,s)}return e.prototype.initialize=function(){var e=this;this.updateConfigsToFetch(),this._skypeTokenData.skypeTokenChanged.subscribe((function(){return e._fetchEcsSettingsIfNeeded(pE.EcsConfigType.User)}))},e.prototype.updateConfigsToFetch=function(){for(var e=this._config.getConfig(),t=0,i=e.configsToFetch;t<i.length;t++)(s=i[t])in this._isFetchingSettings||(this._isFetchingSettings[s]=!1),s in this._isFetchingSettings||(this._pendingFetch[s]=!1);for(var n=0,r=e.configsToFetch;n<r.length;n++){var s=r[n],a=this._cache.getEcsConfigByType(s);!a||a.appVersion&&a.appVersion!==e.clientVersion?this._fetchSkypeEcsSettings(s,!0):this._fetchEcsSettingsIfNeeded(s)}},e.prototype.requestUpdate=function(){for(var e=0,t=this._config.getConfig().configsToFetch;e<t.length;e++){var i=t[e];this._fetchSkypeEcsSettings(i)}},e.prototype.pause=function(){this._paused=!0},e.prototype.resume=function(){this._paused=!1;for(var e=0,t=this._config.getConfig().configsToFetch;e<t.length;e++){var i=t[e];this._fetchEcsSettingsIfNeeded(i)}},e}();t.default=i})),wE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.skypeTokenChanged=new mE.default}return e.prototype.putSkypeTokenData=function(e){if(this._data=e,this.isSkypeTokenValid()&&this.skypeTokenChanged.fire(),this.isSkypeTokenValid()&&this._validSkypeTokenDeferral){var t=this._validSkypeTokenDeferral;this._validSkypeTokenDeferral=void 0,t.resolve(void 0)}},e.prototype.isSkypeTokenValid=function(){var e=this._data;return!!e&&!!e.skypeToken&&e.skypeTokenExpiration>Date.now()},e.prototype.getSkypeToken=function(){var e=this._data;if(!e||!e.skypeToken)throw"No Skype Token provided";return e.skypeToken},e.prototype.getSkypeTokenHash=function(e){return void 0===e?0:e.split("").reduce((function(e,t){return(101*e+t.charCodeAt(0))%999727999}),e.length)},e.prototype.waitForValidSkypeToken=function(){return this.isSkypeTokenValid()?l.Resolved():(this._validSkypeTokenDeferral||(this._validSkypeTokenDeferral=l.Defer()),this._validSkypeTokenDeferral.promise())},e}();t.default=i})),PE=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this._cache=e,this.telemetryEventAdded=new mE.default}return e.prototype.sendTelemetryEvent=function(t){var i=t.getEventName(),n=t.getAttributes(),r=!1,s=this._cache.getEcsConfig();if(s&&e._containsEcsClientTelemetryConfig(s.config)){var a=s.config.ECSCONFIG;a&&a.ecsClientTelemetry&&(r=!!a.ecsClientTelemetry[i])}r&&this.telemetryEventAdded.fire(i,n)},e._containsEcsClientTelemetryConfig=function(e){return!!e&&!!e.ECSCONFIG&&!!e.ECSCONFIG.ecsClientTelemetry},e}();t.default=i})),ME=a((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Models=pE;var i=function(){function e(){this._allowBackgroundFetchData=new lE.default,this._appActiveData=new dE.default,this._config=new SE.default,this._cache=new fE.default(this._config),this._skypeTokenData=new wE.default,this._telemetryManager=new PE.default(this._cache),this._scheduler=new RE.default(this._config,this._skypeTokenData,this._cache,this._appActiveData,this._allowBackgroundFetchData,this._telemetryManager),this.telemetryEventAdded=this._telemetryManager.telemetryEventAdded,this.configUpdated=this._cache.configUpdated}return e.prototype.initialize=function(e){var t=this;return this._config.initialize(e),this._skypeTokenData.putSkypeTokenData(e.initialSkypeTokenData),this._appActiveData.putAppActive(e.initialAppActiveState),this._cache.initialize().then((function(){t._scheduler.initialize()}))},e.prototype.getConfig=function(){return this._cache.getEcsConfig()},e.prototype.getConfigType=function(){var e=this._cache.getEcsConfig();if(e)return e.configType},e.prototype.requestUpdate=function(){this._scheduler.requestUpdate()},e.prototype.pause=function(){this._scheduler.pause()},e.prototype.resume=function(){this._scheduler.resume()},e.prototype.setAllowBackgroundFetch=function(e){this._allowBackgroundFetchData.putBackgroundFetchAllowed(e)},e.prototype.useSkypeToken=function(e,t){this._skypeTokenData.putSkypeTokenData({skypeToken:e,skypeTokenExpiration:t})},e.prototype.setAppActive=function(e){this._appActiveData.putAppActive(e)},e.prototype.setConfigsToFetch=function(e){var t=this;return this._config.setConfigsToFetch(e),this._cache.updateConfigsToFetch().then((function(){t._scheduler.updateConfigsToFetch()}))},e.prototype.setFetchTimeout=function(e){this._config.setFetchTimeout(e)},e}();t.default=i})),DE=function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}(ME);class OE{constructor(e,t){this.skypeToken=e,this.skypeTokenExpiration=t}}class kE{constructor(e,t,i){this._logger=e,this._acsProxy=t,this._counter=0,this._resumeCounter=3e3,this._disposed=!1,this._ecsClient=i||new DE,this._isSubscribed=this._initialized=!1}subscribeEcsConfig(e){return e.configType!==Y_.Default&&e.configType!==Y_.User?Promise.reject("This type of config is not currently supported."):(this._resetConfigCache(e),this._initialized||this._isSubscribed?Promise.reject("Possible duplicate call. Ecs already initialized for this confiugration definition."):Promise.resolve(this._initializeEcsConfig(e).then((()=>{this._ecsClient.configUpdated.subscribe((()=>{if(this._isSubscribed=!0,this._config=this._ecsClient.getConfig(),e.ecsConfigReceiver&&this._config&&(e.ecsConfigReceiver(this._config.config)?this._counter=0:this._counter+=1,this._counter>3))try{this._ecsClient.pause(),this._counter=0,this._resumeCounter*=2,window.setTimeout((()=>{this._disposed||this._ecsClient.resume()}),this._resumeCounter)}catch(e){this._logger.warn("Failed to retry fetch ECS")}}))})).catch((e=>{this._logger.warn("Failed to initialize ECS config because: "+e)}))))}setConfigsToFetch(e){return this._ecsClient.setConfigsToFetch(e)}dispose(){try{this._ecsClient.configUpdated.dispose(),this._disposed=!0}catch(e){this._logger.warn(`Failed to dispose ECS config update, e=${e}`)}}getConfigType(){if(void 0!==this._configDefCache)return this._ecsClient.getConfigType()}getETag(){return void 0===this._config?"":this._config.eTag}getConfigId(e){return void 0===this._config?Promise.reject("Ecs Service has not yet responded. Try calling this API again in sometime."):Promise.resolve(this._config.config.ConfigIDs[e])}setAllowBackgroundFetch(e){return this._ecsClient.setAllowBackgroundFetch(e),Promise.resolve()}setSkypeToken(e,t){return this._ecsClient.useSkypeToken(e,t),Promise.resolve()}setAppActiveState(e){return this._ecsClient.setAppActive(e),Promise.resolve()}_resetConfigCache(e){void 0===e||void 0===this._configDefCache||e.queryParameters===this._configDefCache.queryParameters&&e.configType===this._configDefCache.configType||(this._isSubscribed=!1,this._initialized=!1,this._config=void 0),this._configDefCache=e}_initializeEcsConfig(e){this._initialized=!0;const t={hosts:e.ecsHosts?e.ecsHosts:this._getHostUrls(e.caConfigBag),clientName:"Skype",clientVersion:this._getClientVersion(e.platformId),configsToFetch:this._getLibConfigType(e.configType),getEcsParameters:()=>this._getQueryParameterPromise(e.queryParameters),initialAppActiveState:e.isAppInitiallyInForeground,initialSkypeTokenData:new OE(e.userRawSkypeToken,e.userSkypeTokenExpiration)};return new Promise(((e,i)=>{this._ecsClient.initialize(t).then(e,i)}))}_getHostUrls(e){let t;if(e)if(e.identityType===ic.Enterprise)t=Yo.Enterprise_Ecs_ServerUrl;else switch(e.cloudType){case zo.Public:t=Yo.Public_EcsServer_Url;break;case zo.Dod:t=Yo.Dod_EcsServer_Url;break;case zo.GccHigh:t=Yo.GccHigh_EcsServer_Url;break;case zo.AirGap08:t=Yo.AirGap08_EcsServer_Url;break;case zo.AirGap09:t=Yo.AirGap09_EcsServer_Url;break;default:t=Yo.Public_EcsServer_Url}else t=Yo.Public_EcsServer_Url;return[this._acsProxy.proxyfyUrl(t)]}_getClientVersion(e){let t="";return t+=e||"3617",t+="_",t+=dl(),t}_getLibConfigType(e){return[e===Y_.Default?ME.Models.EcsConfigType.Default:ME.Models.EcsConfigType.User]}_getQueryParameterPromise(e={}){return l.Resolved(e)}}var NE,LE=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},xE=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class UE{constructor(e,t,i,n,r,s,a){if(this._ECS_FETCH_TYPE_USER="User",this._ECS_FETCH_TYPE_DEFAULT="Default",this._disposed=!1,this._trouterStateChangedListenersRegistered=new Map,this.clientId=t,this.sdkDiagnosticInformation=n,this.logger=e.createChild("CallStack"),this._telemetryLogManager=i,this._acsProxy=r,this._acsCustomRelayManager=s,this._webcvProvider=new nE,this._wasmvqeProvider=new cE,"https:"!==location.protocol&&"file:"!==location.protocol&&"localhost"!==location.hostname)throw new I({defaultError:f.CALL_STACK.BAD_PROTOCOL});this._telemetryService=new tE(this._telemetryLogManager),this._ecsProvider=new K_(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new kE(this.logger,this._acsProxy),this._videoEffectsStatusManager=new aE,this._audioEffectsStatusManager=new oE,void 0!==a&&(this._encodedStreamsWorkerProvider=new rE(a))}getClientId(){return this.clientId}getTrouterState(){const e=this?._trouterService?.state();return this.mapTsTrouterState(e)}getEcsConfigIds(){return this._ecsProvider.getConfigIds()}isRegistered(){return this._trouterService?.isRegistered()??!1}onRegisteredChanged(e){this._trouterService?.onRegisteredChanged(e)}offRegisteredChanged(e){this._trouterService?.offRegisteredChanged(e)}onTrouterStateChanged(e){const t=(t,i)=>{e(this.mapTsTrouterState(t))};return this._trouterService?.onStateChanged(t),this._trouterStateChangedListenersRegistered.set(e,t),{listener:e,tsTrouterStateChangedListener:t}}offTrouterStateChanged(e){const t=this._trouterStateChangedListenersRegistered.get(e);if(t)return this._trouterService?.offStateChanged(t),this._trouterStateChangedListenersRegistered.delete(e),{listener:e,tsTrouterStateChangedListener:t}}mapTsTrouterState(e){let t="Uninitialized";if(void 0!==e)switch(e){case 0:t="Unknown";break;case 2:t="Connected";break;case 3:t="Disconnected";break;case 9:t="Switching"}return t}get webcvProvider(){return this._webcvProvider}get wasmvqeProvider(){return this._wasmvqeProvider}get videoEffectsStatusManager(){return this._videoEffectsStatusManager}get audioEffectsStatusManager(){return this._audioEffectsStatusManager}async createStackBase(e){if(this._createStackBaseWaitPromise)return this._createStackBaseWaitPromise;const t=new Promise((async(t,i)=>{try{const i=this._getBaseStackConfig();this._tsStack=await m.pluginlessStackFactory.buildBaseStack(i),await this.initializeEcsBase(e),t(this._tsStack)}catch(e){i(e)}}));try{this._createStackBaseWaitPromise=Fu((()=>t),5e4);const e=await this._createStackBaseWaitPromise;return this.logger.log("Base stack init success"),e}catch(e){throw await this.dispose(),e.code===v?new I({defaultError:f.CALL_STACK.BASE_STACK_INIT_TIMEOUT}):new I({defaultError:f.CALL_STACK.BASE_STACK_INIT_FAILED,originalError:e})}}async initializeStackForUser(e,t){if(this.caConfigBag=t,this._initializeStackForUserWaitPromise)return this._initializeStackForUserWaitPromise;this._tsStack=await this.createStackBase(t),this._disposed=!1;const i=new Promise((async(i,n)=>{try{this._tsStack?(this._telemetryService=new tE(this._telemetryLogManager),this._ecsProvider=new K_(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new kE(this.logger,this._acsProxy),await this.initializeEcsBase(t),await this.initializeEcsForUser(e),Uf.overrideDefaultLogDump(),yl().calling.doNotWaitForTrouter?this._initTrouter(e).catch((()=>{this.logger.warn(f.CALL_STACK.SIGNALING_UNINITIALIZED.message)})):await this._initTrouter(e),this.logger.log("Signaling initialized successfully."),await this._tsStack.initializeMediaAgent({httpRequestDispatcher:this.getRequestDispatcher(),tokenProvider:e,relayManager:this.getCustomRelayManager(),configProvider:{getSkypeConfig:()=>Promise.resolve({}),getRelayConfig:()=>{const e=this._ecsProvider.getMdnTrapSettings();return Promise.resolve(e)}},appStateProvider:this._getAppStateProvider(),clientInformation:this._ecsProvider.getJsCsaConfig().clientInformation}),await this._tsStack.initializeSignalingAgentProvider({signalingAgentConfig:this._getSignalingConfig(e),trouterService:this._trouterService}),await this._tsStack.init(),i(this._tsStack)):(this.logger.error("Base stack failed to create"),n(new I({defaultError:f.CALL_STACK.USER_STACK_NO_BASE_STACK})))}catch(e){n(e)}}));try{this._initializeStackForUserWaitPromise=Fu((()=>i),3e4);const e=await this._initializeStackForUserWaitPromise;return this.sendStackInitEvent(!0),this.logger.log("User stack init success"),e}catch(e){if(await this.dispose(),e.code===v)throw this.sendStackInitEvent(!1,"User stack init timeout",e),new I({defaultError:f.CALL_STACK.USER_STACK_INIT_TIMEOUT});if("Uninitialized"===this.getTrouterState())throw new I({defaultError:f.CALL_STACK.SIGNALING_UNINITIALIZED});throw this.sendStackInitEvent(!1,"User stack init failed",e),new I({defaultError:f.CALL_STACK.USER_STACK_INIT_FAILED,originalError:e})}}getRequestDispatcher(){return this._acsProxy.hasProxyUrl()?(this.logger.info("Using custom proxy for network requests (non media)"),new sE(this.logger,this._acsProxy)):new m.HttpRequestDispatcherImplementation}async initializeEcsBase(e){const t=Rl(),i=this.getEcsQueryParameters(e),n=x(),r=e?this._ECS_FETCH_TYPE_USER:this._ECS_FETCH_TYPE_DEFAULT,s=new iE(Y_.Default,e,i,(i=>{if(i?.Headers?.CountryCode&&this.updateEmergencyCallCountry(i?.Headers?.CountryCode),t.resolve(),this._ecsFetcher.getConfigType()===Y_.User&&this._ecsSetupCompleteForUser.resolve(),this._ecsFetcher&&this._tsStack&&void 0!==i){let t;const s=+new Date;try{return function(e){if(!e)throw new I({defaultError:f.INTERNAL.ECS_CONFIG_EMPTY});if(!e.AcsCallingSDKWeb)throw new I({defaultError:f.INTERNAL.ECS_CONFIG_MISSING_ACS});try{const t=vl.telemetry.deviceChangedEvents.piiSafeWords.slice();p.mergeWith(vl,e.AcsCallingSDKWeb,ul);const i=vl.telemetry.deviceChangedEvents;"merge"===i.piiSafeWordsMode&&(i.piiSafeWords=p.union(t,i.piiSafeWords))}catch(e){throw new I({defaultError:f.INTERNAL.ECS_CONFIG_MERGING_ERROR})}}(i),this._ecsProvider.setConfig(e,i),function(e){Sl=e}(this._ecsProvider.getJamaSettings()),t=JSON.stringify(i),this._tsStack.getEcsProvider().setEcsConfig({ecsBlob:t,userIdentity:"",etag:this._ecsFetcher.getETag()}),this._ecsProvider.assertConfigs(i),!0}catch(e){const t=+new Date;this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_failure,{deltaTimeInMs:t-s},r,n,this._ecsProvider.getConfigIds(),new I({defaultError:f.CALL_STACK.PARSE_CONFIG,originalError:e})),this.logger.error("Unable to parse configuration")}}return!1}),"3617"),a=+new Date;try{await this._ecsFetcher.subscribeEcsConfig(s),this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_attempt,{attemptTimestamp:a},r,n);const e=Fu((()=>t.promise),7e3);await e;const i=+new Date;this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_success,{deltaTimeInMs:i-a},r,n,this._ecsProvider.getConfigIds())}catch(t){const i=new I({defaultError:f.CALL_STACK.PARSE_CONFIG,originalError:t}),s=+new Date;this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_failure,{deltaTimeInMs:s-a},r,n,this._ecsProvider.getConfigIds(),i),this.logger.warn("Failed to fetch base settings. Stack will initialize without default settings",t),this._ecsProvider.setConfig(e,void 0)}}async initializeEcsForUser(e){const t=await e();this._ecsSetupCompleteForUser=Rl();try{await this._ecsFetcher.setConfigsToFetch([Y_.User]),await this._ecsFetcher.setSkypeToken(t,1e3*Dl(t).exp)}catch(e){throw this.logger.error("Unable to set skype token for user ecs config"),new I({defaultError:f.CALL_STACK.SET_STACK_CONFIG})}const i=x(),n=this.caConfigBag?"User":"Default",r=+new Date;try{this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_attempt,{attemptTimestamp:r},n,i);const e=Fu((()=>this._ecsSetupCompleteForUser.promise),7e3);await e;const t=+new Date;this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_success,{deltaTimeInMs:t-r},n,i,this._ecsProvider.getConfigIds())}catch(e){const t=+new Date;this.sendEcsSettingsFetchedDataEvent(Xu.acs_calling_config_fetched_failure,{deltaTimeInMs:t-r},n,i,this._ecsProvider.getConfigIds(),e),this.logger.warn("Failed to fetch user settings. Stack will initialize without user settings",e)}}async getDeviceManager(){if(!this._createStackBaseWaitPromise)throw new I({defaultError:f.CALL_STACK.GET_DM});return(await this._createStackBaseWaitPromise).getDeviceManager()}async dispose(e){if(!this._disposed){if(this._disposed=!0,this._trouterService)try{this._trouterService.clearMessageHandlers(),this._trouterService.stop(e),this._trouterService=void 0}catch(e){this.logger.error("Failed to dispose signaling")}if(this._tsStack)try{await this._tsStack.dispose(),this._tsStack=void 0}catch(e){this.logger.error("Failed to dispose calling stack")}this._ecsFetcher.dispose(),this._createStackBaseWaitPromise=void 0,this._initializeStackForUserWaitPromise=void 0,this._tsStack=void 0,this.logger.info("Calling stack disposed")}}getEcsQueryParameters(e){const t={};try{t.CLRelease=m.getVersion();const i=FC();t.BrowserName=i.name,t.BrowserEngine=i.engine,t.BrowserVersion=i.version,t.FormFactor=i.formFactor,t.IdentityType=ic.Consumer,t.Cloud=zo.Public,t.OSVer=`${VC()}-${BC()}`,e&&(t.Cloud=e.cloudType,t.IdentityType=e.identityType);const n="_TS_BUILC_VERSION_".replace("C","D");t.CLRelease===n?t.CLRelease="9999.99":t.CLRelease.match(/^\d+\.\d+\.\d+\.\d+$/)||delete t.CLRelease}catch(e){throw this.logger.error(e),new I({defaultError:f.CALL_STACK.SET_STACK_PARAMS,originalError:e})}return t}sendEcsSettingsFetchedDataEvent(e,t,i,n,r,s){let a,o;s&&(a=s.message,o=jp(s)),this._telemetryLogManager.sendEvent({name:e,tenant:uc,properties:{...t,ecsFetchType:i,correlationId:n,failureReason:a,ecsConfigIds_AcsCallingSDKWeb:r?.AcsCallingSDKWeb||"",ecsConfigIds_SkypeWebMedia:r?.SkypeWebMedia||"",additionalDetails:{...o}}})}updateEmergencyCallCountry(e){this.caConfigBag&&!this.caConfigBag.emergencyCountryCode&&!this.caConfigBag.IsUserEmergencyCountryCode&&e&&(this.caConfigBag.emergencyCountryCode=e)}async _initTrouter(e){let t=+new Date;try{this._trouterService=new eE(this.logger,this._ecsProvider,(t=>e(t)),this._telemetryLogManager,this._acsProxy),t=+new Date;let i=await this._trouterService.start();return void this.sendSignalingInitEvent(!0,+new Date-t,i.trouterRequestCompletionTimeDeltaMs,i.registrarRequestCompletionTimeDeltaMs)}catch(e){throw this.sendSignalingInitEvent(!1,+new Date-t,void 0,void 0,e),e}}_getBaseStackConfig(){const e=this._getMediaProviderConfig(),t={clientInformation:this._ecsProvider.getClientInformation(),logger:this.logger,mediaSettings:e.mediaSettings,platformType:LC(),callSettings:{useLwjForAllCalls:!1},usePlatformSupportApi:!0,telemetryTenants:{media:"mediaAgent",signaling:"signalingAgent",tlePlayer:"tlePlayer"},telemetryService:this._telemetryService,webcvProvider:this._webcvProvider,wasmVqeProvider:this._wasmvqeProvider};return void 0!==this._encodedStreamsWorkerProvider&&(t.encodedStreamsWorkerProvider=this._encodedStreamsWorkerProvider),t}_getSignalingConfig(e){const t={...this._ecsProvider.getJsCsaConfig(),httpRequestDispatcher:this.getRequestDispatcher(),telemetryManager:this._telemetryService.getCallingAdapter(),logger:this.logger,skypeToken:()=>e(),trouterServiceProvider:this._trouterService,ecsEtag:this._ecsFetcher.getETag()};return this.caConfigBag?.emergencyCountryCode&&(t.emergencyCallCountry=this.caConfigBag?.emergencyCountryCode),t}_getMediaProviderConfig(){return{logger:this.logger,mediaSettings:this._getMediaAgentConfig()}}_getMediaAgentConfig(){return{...this._ecsProvider.getJamaSettings()}}_getAppStateProvider(){return{isOnline:()=>!0}}sendStackInitEvent(e,t,i){try{let n,r;i&&(n=i.message,r=jp(i)),this._telemetryLogManager.sendEvent({name:Xu.acs_calling_stack_init,tenant:uc,properties:{success:e,reason:t,failureReason:n||"unknown",additionalDetails:{...r}}})}catch(e){}}sendSignalingInitEvent(e,t,i,n,r){try{let s,a;r&&(s=r.message,a=jp(r)),this._telemetryLogManager.sendEvent({name:Xu.acs_calling_signaling_init,tenant:uc,properties:{success:e,failureReason:s||"unknown",timestampInfo:{deltaTimeInMs:t,deltaTimeInMsTrouterRequest:i,deltaTimeInMsRegistrarRequest:n},additionalDetails:{...a}}})}catch(e){}}getCustomRelayManager(){if(this._tsCustomRelayManager=this._acsCustomRelayManager.getTsRelayManager(),this._tsCustomRelayManager&&yl().calling.enableCustomTurnUsage)return this.logger.info("Using custom relays for media traffic"),this._acsCustomRelayManager.customRelayManagerInUse=!0,this._tsCustomRelayManager}}LE([Of,xE("design:type",Object)],UE.prototype,"logger",void 0),LE([M(Cg.CreateStackBase),xE("design:type",Function),xE("design:paramtypes",[Object]),xE("design:returntype",Promise)],UE.prototype,"createStackBase",null),LE([M(Cg.InitializeStackForUser),xE("design:type",Function),xE("design:paramtypes",[Function,Object]),xE("design:returntype",Promise)],UE.prototype,"initializeStackForUser",null),LE([M(Cg.InitializeEcsBase),xE("design:type",Function),xE("design:paramtypes",[Object]),xE("design:returntype",Promise)],UE.prototype,"initializeEcsBase",null),LE([M(Cg.InitializeEcsForUser),xE("design:type",Function),xE("design:paramtypes",[Function]),xE("design:returntype",Promise)],UE.prototype,"initializeEcsForUser",null),LE([M(Cg.GetDeviceManager),xE("design:type",Function),xE("design:paramtypes",[]),xE("design:returntype",Promise)],UE.prototype,"getDeviceManager",null),LE([M(Cg.Dispose),xE("design:type",Function),xE("design:paramtypes",[Boolean]),xE("design:returntype",Promise)],UE.prototype,"dispose",null);class FE{constructor(){this._eventEmitter=new ep.EventEmitter}notifyAll(e){this._eventEmitter.emit(e)}waitFor(e,t){return new Promise(((i,n)=>{let r=0;const s=()=>{i(),clearTimeout(r)};this._eventEmitter.once(e,s),r=window.setTimeout((()=>{this._eventEmitter.off(e,s),n(new Error("timeout"))}),t)}))}}class VE{constructor(){this._deviceIdMapping=new Map,this._deviceId=1,this._keywords=yl().telemetry.deviceChangedEvents.piiSafeWords}getDeviceId(e){let t=this._deviceIdMapping.get(e);return void 0!==t||(++this._deviceId,t=`${e.split(":")[0]??""}:${this._deviceId}`,this._deviceIdMapping.set(e,t)),t}scrubDeviceLabel(e){return function(e,t){if(!e)return"";if(e.length<3)return e;const i=[],n=e.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);n&&i.push(n[1]);try{if(!t?.length)return"no_keywords";{const n=new RegExp(`(${t.join("|")})`,"gi");let r=n.exec(e);for(;r;)i.push(r[1]),r=n.exec(e)}}catch(e){const t=e=>p.isString(e)?e:e?.message??"";i.push(`Error: ${t(e)}`)}return 0===i.length?"unknown":i.join(" ")}(e,this._keywords)}}!function(e){e.deviceSelection="deviceSelection"}(NE||(NE={}));var BE=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},HE=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class $E{constructor(e,t,i){this._callStack=t,this._videoDevices=[],this._audioDevices=[],this._tsDeviceTypeToAudioDeviceType={2:"Microphone",3:"Speaker",4:"CompositeAudioDevice"},this.logger=e.createChild("DeviceManager"),this._telemetryLogManager=i,this._eventEmitter=new Nm(this.logger),this._browserInfo=FC(),this._safariVideoPermissionState="unknown",this._combinedDevicePermission=new Map,this._deviceInfoMapper=new VE,this._deviceSelectionNotifications=new FE}get telemetryLogManager(){return this._telemetryLogManager}getRawDeviceMediaStream(e){const t=x(),i=+new Date;if(this.sendRawMediaEvent({eventName:Xu.acs_calling_get_raw_device_media_stream,correlationId:t,kindOfEvent:"attempt",mediaType:e,timestampInfo:"",additionalDetails:""}),!this._tsDeviceManager?.getRawDeviceMediaStream){const n=new I({defaultError:f.DEVICE_MANAGER.GET_MEDIA_STREAM_TRACK});this.logger.error("Failed to get raw device stream track");const r=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_get_raw_device_media_stream,correlationId:t,kindOfEvent:"failure",mediaType:e,timestampInfo:{deltaTimeInMs:r-i},additionalDetails:{failureReason:n.message||"",code:n.code,subCode:n.subCode,...jp(n)}}),n}let n;try{n=this._tsDeviceManager?.getRawDeviceMediaStream(e);const r=+new Date;return this.sendRawMediaEvent({eventName:Xu.acs_calling_get_raw_device_media_stream,correlationId:t,kindOfEvent:"success",mediaType:e,timestampInfo:{deltaTimeInMs:r-i},additionalDetails:""}),n}catch(n){const r=new I({defaultError:f.DEVICE_MANAGER.GET_MEDIA_STREAM_DEVICE_UNAVAILABLE,originalError:n});this.logger.error("Failed to get raw device stream track");const s=+new Date;throw this.sendRawMediaEvent({eventName:Xu.acs_calling_get_raw_device_media_stream,correlationId:t,kindOfEvent:"failure",mediaType:e,timestampInfo:{deltaTimeInMs:s-i},additionalDetails:{failureReason:r.message||"",code:r.code,subCode:r.subCode,...jp(r)}}),r}}getClientId(){return this._callStack.getClientId()}async getDeviceManager(){if(this._tsDeviceManager)return this._tsDeviceManager;const e=+new Date;try{this.sendGetDeviceManagerEvent({eventName:Xu.acs_calling_get_device_manager,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),await this._callStack.createStackBase(),this._tsDeviceManager=await this._callStack.getDeviceManager();const t=await this._tsDeviceManager.enumerateDevicesAsync();this.logger.info(`tsDevicesList:${JSON.stringify(t)}`),t.forEach((e=>{if(1===e.kind){const t=e;this._videoDevices.push(new Df(t.label,t.id,"UsbCamera",this))}else if(2===e.kind||3===e.kind){const t=e,i=new Gf(t.label,t.id,t.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[t.kind],this);this._audioDevices.push(i)}}));const i=this._tsDeviceManager.getSelectedDevices();this._selectedMicrophone=this._audioDevices.find((e=>e.id===i.microphone)),this._selectedSpeaker=this._audioDevices.find((e=>e.id===i.speaker)),this._dmDevicesChangedSub=this._tsDeviceManager.on("devicesChanged",(async()=>{try{await this.syncDeviceList(await(this._tsDeviceManager?.enumerateDevicesAsync())),this.checkForSelectedDevicesChanges()}catch(t){this.logger.warn(`Unable to handle devicesChanged, error=${t?.message}, code=${t?.code}`);const i=+new Date;this.sendGetDeviceManagerEvent({eventName:Xu.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{failureReason:t?.message,code:t?.code,...jp(t),context:"devicesChanged"}})}})),yl().calling.devicePermissions.getCurrentState&&(this._audioDevicePermission=Vl(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),this._videoDevicePermission=Vl(this._tsDeviceManager?.getPermissionState("camera"),this.logger)),this.logger.info("Initial permission state audio:",this._audioDevicePermission,"video:",this._videoDevicePermission),this._dmDevicesPermissionChangedSub=this._tsDeviceManager.on("onPermissionStateChanged",this.permissionsChanged.bind(this));const n=+new Date;this.sendGetDeviceManagerEvent({eventName:Xu.acs_calling_get_device_manager,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:n-e},additionalDetails:""})}catch(t){const i=new I({defaultError:f.DEVICE_MANAGER.GET_DM,originalError:t});this.logger.error(i.message);const n=+new Date;this.sendGetDeviceManagerEvent({eventName:Xu.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:n-e},additionalDetails:{failureReason:i.message,code:i.code,...jp(i)}})}return this._tsDeviceManager}on(e,t){if("videoDevicesUpdated"!==e&&"audioDevicesUpdated"!==e&&"selectedMicrophoneChanged"!==e&&"selectedSpeakerChanged"!==e)throw new I({defaultError:f.DEVICE_MANAGER.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("videoDevicesUpdated"!==e&&"audioDevicesUpdated"!==e&&"selectedMicrophoneChanged"!==e&&"selectedSpeakerChanged"!==e)throw new I({defaultError:f.DEVICE_MANAGER.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}getTsDeviceManager(){if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});return this._tsDeviceManager}getSafariPermissionState(){return"Safari"===this._browserInfo.engine?this._safariVideoPermissionState:"unknown"}getAcsResourceId(){return this._callStack?.caConfigBag?.acsResourceId}getAudioDevicePermission(){return this._audioDevicePermission}getVideoDevicePermission(){return this._videoDevicePermission}get callStackWebCvProvider(){return this._callStack.webcvProvider}get callStackWasmVqeProvider(){return this._callStack.wasmvqeProvider}get callStackVideoEffectsStatusManager(){return this._callStack.videoEffectsStatusManager}get callStackAudioEffectsStatusManager(){return this._callStack.audioEffectsStatusManager}get deviceInfoMapper(){return this._deviceInfoMapper}getEnvironmentInfoInternal(){return this._environmentInfo||(this._environmentInfo=jC()),this._environmentInfo}sendRawMediaEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send raw media telemetry")}}sendGetDeviceManagerEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send get_device_manager telemetry")}}permissionsChanged(e,t){const i=this._audioDevicePermission,n=this._videoDevicePermission;let r,s;yl().calling.devicePermissions.getCurrentState?(r=Vl(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),s=Vl(this._tsDeviceManager?.getPermissionState("camera"),this.logger)):(r=i,s=n),this._audioDevicePermission=r||!!e?.audio,this._videoDevicePermission=s||!!e?.video,t&&(t.audio&&(this._audioDevicePermission=e?.audio??!1),t.video&&(this._videoDevicePermission=e?.video??!1)),i===this._audioDevicePermission&&n===this._videoDevicePermission||(this.logger.info(`permission state changed from audio: ${i}, video: ${n}\n                          to audio: ${this._audioDevicePermission}, video: ${this._videoDevicePermission}`),this._telemetryLogManager.sendEvent({name:Xu.acs_calling_device_permission_changed,tenant:uc,properties:{previousAudioDevicePermission:this.nullHandler(i),previousVideoDevicePermission:this.nullHandler(n),newAudioDevicePermission:this.nullHandler(this._audioDevicePermission),newVideoDevicePermission:this.nullHandler(this._videoDevicePermission)}}))}checkForSelectedDevicesChanges(){if(this.logger.info("checkForSelectedDevicesChanges"),this._tsDeviceManager){const e=this._tsDeviceManager.getSelectedDevices();e.microphone!==this._selectedMicrophone?.id&&(this._selectedMicrophone=this._audioDevices.find((t=>t.id===e.microphone)),this._eventEmitter.emit("selectedMicrophoneChanged"),void 0!==e.microphone&&this._deviceSelectionNotifications.notifyAll(e.microphone)),e.speaker!==this._selectedSpeaker?.id&&(this._selectedSpeaker=this._audioDevices.find((t=>t.id===e.speaker)),this._eventEmitter.emit("selectedSpeakerChanged"),void 0!==e.speaker&&this._deviceSelectionNotifications.notifyAll(e.speaker))}else this.logger.warn("DeviceManager is undefined, Unable to check selected devices")}isACSDeviceEqualToTSDevice(e,t){return e.id===t.id}async syncDeviceList(e){if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});this.logger.info("syncDeviceList"),void 0===e&&(e=await this._tsDeviceManager.enumerateDevicesAsync());const t=[];let i=[];const n=[];let r=[];e.map((e=>{if(1===e.kind){const i=this._videoDevices.find((t=>this.isACSDeviceEqualToTSDevice(t,e)));if(i)i.setName(e.label),i.setId(e.id),i.setDeviceType("UsbCamera");else{const i=new Df(e.label,e.id,"UsbCamera",this);t.push(i),this._videoDevices.push(i)}}else if(2===e.kind||3===e.kind){const t=this._audioDevices.find((t=>this.isACSDeviceEqualToTSDevice(t,e)));if(t){const i=e;t.setName(i.label),t.setId(i.id),t.setIsSystemDefault(i.isSystemDefault),t.setDeviceType(this._tsDeviceTypeToAudioDeviceType[i.kind])}else{const t=new Gf(e.label,e.id,e.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[e.kind],this);n.push(t),this._audioDevices.push(t)}}}));const s=t=>{const i=t.filter((t=>!e.find((e=>this.isACSDeviceEqualToTSDevice(t,e)))));return i.map((e=>{t.splice(t.indexOf(e),1)})),i};i=s(this._videoDevices),r=s(this._audioDevices),(t.length>0||i.length>0)&&this._eventEmitter.emit("videoDevicesUpdated",{added:t,removed:i}),(n.length>0||r.length>0)&&this._eventEmitter.emit("audioDevicesUpdated",{added:n,removed:r})}get isSpeakerSelectionAvailable(){if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});return this._tsDeviceManager.isAudioOutputSelectionSupported}get selectedMicrophone(){return this._selectedMicrophone}get selectedSpeaker(){return this._selectedSpeaker}async getCameras(){return await this.syncDeviceList(),this._videoDevices}async getMicrophones(){return await this.syncDeviceList(),this._audioDevices.filter((e=>"Microphone"===e.deviceType))}async getSpeakers(){if(this.isSpeakerSelectionAvailable)return await this.syncDeviceList(),this._audioDevices.filter((e=>"Speaker"===e.deviceType));throw new I({defaultError:f.DEVICE_MANAGER.SPEAKER_ENUMERATION_UNSUPPORTED})}async selectMicrophone(e){if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});if(!e||!e.id)throw new I({defaultError:f.DEVICE_MANAGER.INVALID_DEVICE});if("microphone:"===e.id)throw new I({defaultError:f.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE});if(this.logger.info("selectMicrophone called"),this._selectedMicrophone?.id!==e.id){const t=yl().calling.deviceSelectionTimeoutInMs,i=this._deviceSelectionNotifications.waitFor(e.id,t),n="Microphone",r=this._deviceInfoMapper.getDeviceId(e.id),s=this._deviceInfoMapper.scrubDeviceLabel(e.name),a=x(),o=(e,t,i)=>{this.sendDeviceSelectionEvent({eventName:Xu.acs_calling_client_operations,operation:NE.deviceSelection,kindOfEvent:e,correlationId:a,timestampInfo:void 0!==t?{deltaTimeInMs:t}:{},additionalDetails:void 0!==i?{failureReason:i.message,code:i.code,...jp(i)}:"",deviceSelection:{deviceId:r,deviceName:s,deviceType:n}})};o("attempt");const c=Date.now();try{this._tsDeviceManager.selectDevices({microphone:e.id}),await i.catch((t=>{if(this._selectedMicrophone?.id!==e.id)throw t})),o("success",Date.now()-c)}catch(e){let t;throw t=new I("timeout"===e?.message?{defaultError:f.DEVICE_MANAGER.SELECT_MICROPHONE_TIMEOUT}:{defaultError:f.DEVICE_MANAGER.SELECT_MICROPHONE_FAIL,originalError:e}),o("failure",Date.now()-c,t),t}}else this.logger.warn("microphoneDevice is already active")}async selectSpeaker(e){const t=this.logger.createFnLogger(_g.SelectSpeaker);if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});if(!this.isSpeakerSelectionAvailable)throw new I({defaultError:f.DEVICE_MANAGER.SPEAKER_SELECTION_UNSUPPORTED});if(!e||!e.id)throw new I({defaultError:f.DEVICE_MANAGER.INVALID_DEVICE});if("speaker:"===e.id)throw new I({defaultError:f.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE});if(t.info("selectSpeaker called"),this._selectedSpeaker?.id!==e.id){const t=yl().calling.deviceSelectionTimeoutInMs,i=this._deviceSelectionNotifications.waitFor(e.id,t),n="Speaker",r=this._deviceInfoMapper.getDeviceId(e.id),s=this._deviceInfoMapper.scrubDeviceLabel(e.name),a=x(),o=(e,t,i)=>{this.sendDeviceSelectionEvent({eventName:Xu.acs_calling_client_operations,operation:NE.deviceSelection,kindOfEvent:e,correlationId:a,timestampInfo:void 0!==t?{deltaTimeInMs:t}:{},additionalDetails:void 0!==i?{failureReason:i.message,code:i.code,...jp(i)}:"",deviceSelection:{deviceId:r,deviceName:s,deviceType:n}})};o("attempt");const c=Date.now();try{this._tsDeviceManager.selectDevices({speaker:e.id}),await i.catch((t=>{if(this._selectedSpeaker?.id!==e.id)throw t})),o("success",Date.now()-c)}catch(e){let t;throw t=new I("timeout"===e?.message?{defaultError:f.DEVICE_MANAGER.SELECT_SPEAKER_TIMEOUT}:{defaultError:f.DEVICE_MANAGER.SELECT_SPEAKER_FAIL,originalError:e}),o("failure",Date.now()-c,t),t}}else t.warn("device is already selected")}async askDevicePermission(e){const t={audio:!!e.audio,video:!!e.video};if(!e.audio&&!e.video)throw new I({defaultError:f.DEVICE_MANAGER.ONE_PERMISSION_ATLEAST});const i=this.getKeyForConstrains(t);let n=this._combinedDevicePermission.get(i);return n?this.logger.info(`askDevicePermission attempt: audio:${t.audio}, video:${t.video} on pending existing request ${Fl(n)}`):(n=this.askDevicePermissionInternal(t),this._combinedDevicePermission.set(i,n),n.finally((()=>{this._combinedDevicePermission.delete(i)}))),n}getKeyForConstrains(e){return Object.keys(e).filter((t=>e[t])).toString()}async askDevicePermissionInternal(e){this.logger.info(`askDevicePermission attempt: audio:${e.audio}, video:${e.video}`);const t=x(),i=+new Date;this.sendAudioVideoPermissionEvent({eventName:Xu.acs_calling_adp_attempt,correlationId:t,audioPermissionRequested:e.audio,videoPermissionRequested:e.video});try{if(!this._tsDeviceManager)throw new I({defaultError:f.DEVICE_MANAGER.ACCESS_DM});const n=[];if(yl().calling.devicePermissions.splitAskAudioVideo){this.logger.info("askDevicePermission, split permission check");const t=[];if(e.audio&&(this.logger.info("askDevicePermission, split permission audio"),t.push(this._tsDeviceManager.askDevicePermission({audio:e.audio,video:!1}))),e.video){const i=async t=>new Promise(((i,n)=>{const r=async()=>{if(this.logger.info("askDevicePermission, split permission video"),!this._tsDeviceManager){const e="askDevicePermission, split permission video failed device manager not found";return this.logger.error(e),void n(e)}try{const t=await this._tsDeviceManager.askDevicePermission({audio:!1,video:e.video});i(t)}catch(e){n(e)}};t?window.setTimeout(r,t):r()}));t.push(i(yl().calling.devicePermissions.timeoutInBetween))}const i=await Promise.allSettled(t);let r={audio:!1,video:!1};i.forEach((e=>{"fulfilled"===e.status&&e?.value&&(r={audio:r.audio||!!e?.value?.audio,video:r.video||!!e?.value?.video}),"rejected"===e.status&&e?.reason&&n.push(e.reason)})),this.permissionsChanged(r,e),this._safariVideoPermissionState=this._videoDevicePermission?"granted":"denied"}else{const t=await this._tsDeviceManager.askDevicePermission({audio:e.audio,video:e.video});this.permissionsChanged(t,e)}if(e?.audio&&!this._audioDevicePermission||e?.video&&!this._videoDevicePermission)this.sendAudioVideoPermissionEvent({eventName:Xu.acs_calling_adp_failure,correlationId:t,audioPermissionRequested:e.audio,videoPermissionRequested:e.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission},new I({defaultError:f.DEVICE_MANAGER.PERMISSION_NOT_GRANTED_OR_FAILED,defaultErrorMessageArgs:[Fl(n)]}));else{const n=+new Date;this.sendAudioVideoPermissionEvent({eventName:Xu.acs_calling_adp_success,correlationId:t,audioPermissionRequested:e.audio,videoPermissionRequested:e.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:n-i})}}catch(n){const r=new I({defaultError:f.DEVICE_MANAGER.ADP_FAIL,originalError:n}),s=+new Date;this.sendAudioVideoPermissionEvent({eventName:Xu.acs_calling_adp_failure,correlationId:t,audioPermissionRequested:e.audio,videoPermissionRequested:e.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:s-i},r)}return{audio:!!this._audioDevicePermission,video:!!this._videoDevicePermission}}sendAudioVideoPermissionEvent(e,t){try{let i,n,r;t&&(i="string"==typeof t?.message?t?.message:void 0,n=jp(t)),e.deltaTimeInMs&&(r=e.deltaTimeInMs>25e3),this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:{audioPermissionGranted:this.nullHandler(e.audioPermissionGranted),videoPermissionGranted:this.nullHandler(e.videoPermissionGranted),audioPermissionRequested:e.audioPermissionRequested,videoPermissionRequested:e.videoPermissionRequested,correlationId:e.correlationId||"",failureReason:i||"",deltaTimeInMs:e.deltaTimeInMs||"",deltaTimeGreaterThanJAMATimeout:this.nullHandler(r),additionalDetails:{...n}}})}catch(e){this.logger.debug("Unable to send audio video permission failure success telemtery")}}sendDeviceSelectionEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send device selection telemetry")}}nullHandler(e){return void 0===e?"":e}dispose(){this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesPermissionChangedSub&&this._dmDevicesPermissionChangedSub.dispose(),this._dmDevicesPermissionChangedSub=void 0,this._dmDevicesChangedSub=void 0}}BE([Of,HE("design:type",Object)],$E.prototype,"logger",void 0),BE([M(_g.GetDeviceManager),HE("design:type",Function),HE("design:paramtypes",[]),HE("design:returntype",Promise)],$E.prototype,"getDeviceManager",null),BE([M(_g.GetCameras),HE("design:type",Function),HE("design:paramtypes",[]),HE("design:returntype",Promise)],$E.prototype,"getCameras",null),BE([M(_g.GetMicrophones),HE("design:type",Function),HE("design:paramtypes",[]),HE("design:returntype",Promise)],$E.prototype,"getMicrophones",null),BE([P(_g.GetSpeakers),HE("design:type",Function),HE("design:paramtypes",[]),HE("design:returntype",Promise)],$E.prototype,"getSpeakers",null),BE([M(_g.SelectMicrophone),HE("design:type",Function),HE("design:paramtypes",[Object]),HE("design:returntype",Promise)],$E.prototype,"selectMicrophone",null),BE([M(_g.SelectSpeaker),HE("design:type",Function),HE("design:paramtypes",[Object]),HE("design:returntype",Promise)],$E.prototype,"selectSpeaker",null),BE([M(_g.AskDevicePermission),HE("design:type",Function),HE("design:paramtypes",[Object]),HE("design:returntype",Promise)],$E.prototype,"askDevicePermission",null);var GE=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class jE extends M_{get info(){return this._teamsCall.info}constructor(t){super(t,e.IncomingCallKind.TeamsIncomingCall),this._teamsCall=t}async accept(e){if(!$l(this._teamsCall.acsProxy,this._teamsCall.acsCustomRelayManager,!0))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});return await this._teamsCall.accept(e),this._teamsCall}}!function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);s>3&&a&&Object.defineProperty(t,i,a)}([M(Sg.Accept),GE("design:type",Function),GE("design:paramtypes",[Object]),GE("design:returntype",Promise)],jE.prototype,"accept",null);class qE extends zg{constructor(e){super(e)}}var WE=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},zE=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class JE extends b_{get info(){return this._info}constructor(t,i,n,r){super(t,i,n,r,e.CallKind.TeamsCall),this._isEmergencyCall=!1,this._musicOnHoldEnabled=!1,this._info=new qE(n),this._info.initialize(this._eventEmitter,this.logger,this._telemetryLogManager),this._mtPolicyService=i.mtPolicyService}async startCallInternal(e,t,i,n,r){if(this._mtPolicyService&&this._mtPolicyService.isFetchUserPoliciesAndSettingsApplicable()){let t="",i=!0;this._isEmergencyCall=!1;try{this.logger.info("Fetching Teams User policy from MiddleTier Service"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId)}catch(e){i=!1,this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n                    Error message = ${e?.message}, code = ${e?.code}, subcode = ${e?.subCode}.\n                    Proceeding as normal pstn call`)}if(i){try{this.enforcePolicyAndLicenseRestrictions()}catch(e){return void this.handlePolicyAndLicenseRestrictionsFailure(e)}try{this.logger.info("Deriving emergency content from fetched policies and settings"),t=this._mtPolicyService.getEmergencyContent()}catch(e){this.logger.warn(`Error deriving emergency content from fetched policies and settings. \n                    Error message = ${e?.message}, code = ${e?.code}, subcode = ${e?.subCode}. Proceeding as normal pstn call`)}n&&(n.emergencyContent=t||"",n.isEmergency=t?.trim().length>0||!1,this._isEmergencyCall=n.isEmergency)}}if(r){let t=[];Array.isArray(r)?t=r:t.push(r),this._isEmergencyCall&&1==t.length&&(this.logger.info(`user dialed number (${t[0].phoneNumber}) resolved to actual emergency number (${this._mtPolicyService.getEmergencyNumber()} during startCall`),t[0]={phoneNumber:this._mtPolicyService.getEmergencyNumber()}),t.length>1&&this.setupThreadIdWhenStartingGroupCall(t,e,n),t.forEach((e=>{this.tsCall.addParticipant(rl(e)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),this.logger.info("Paticipant added during startCall")}super.startCallInternal(e,t,i,n)}isEmergencyCallInProgress(){return this._isEmergencyCall}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(e,t){const i=+new Date,r=x();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.attempt,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{attemptTimestamp:i}});let s="";try{if(t.threadId)this.logger.info("Customer provided threadId in options: "+JSON.stringify(t)),this.validateThreadId(e,t),s=t.threadId;else{if(!yl().MiddleTier.serverManagedThreadIdApiConfiguration.allowServerThreadCreation)throw new I({defaultError:f.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID});if(null!==this._info.threadId&&void 0!==this._info.threadId){s=this._info.threadId;let t=[];t.push({id:rl(e)}),this._mtPolicyService.AddParticipantsToThread(this.tsCall.callId,{threadId:s,addParticipantsSuffix:yl().MiddleTier.serverManagedThreadIdApiConfiguration.addParticipantSuffix,participants:t}).catch((e=>{this.logger.warn("Error when adding participants "+JSON.stringify(t)+" to thread. "+e)}))}else{let i=[];this._remoteParticipants.forEach((e=>{i.push({id:rl(e.identifier)})})),i.push({id:rl(e)});try{this._mtPolicyService.CreateChatThreadId(this.tsCall.callId,{createThreadIdSuffix:yl().MiddleTier.serverManagedThreadIdApiConfiguration.createThreadSuffix,participants:i}).then((e=>{e&&(t.threadId=e,s=e,this._info.setThreadId(e)),this.logger.info("Add participant into 1on1 call to convert it into Teams group call. Create thread id: "+s)}))}catch(t){let i="Error when adding participants "+rl(e)+" to thread to create a Teams group call. ";if(!yl().MiddleTier.serverManagedThreadIdApiConfiguration.decoupleChatThreadFromCalls)throw new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.CREATETHREAD_FAILED});this.logger.warn(i+t)}}}ol(e)}catch(e){const t=new I({defaultError:f.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:e});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:e.code,failureReason:e.message,...jp(t)}}),t}if(!$l(this.acsProxy,this.acsCustomRelayManager,!0)){const e=new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:e.code,failureReason:e.message,...jp(e)}}),e}if(this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)))){const t=new I({defaultError:f.CALL.PARTICIPANT_ALREADY_IN_CALL,defaultErrorMessageArgs:[n.getIdentifierKind(e).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:t.code,failureReason:t.message,...jp(t)}}),t}const a=this.getOrCreateRemoteParticipant(sl(rl(e)));if(yl().calling.enableSmePassFakeConversation&&(n.isPhoneNumberIdentifier(e)||n.isCommunicationUserIdentifier(e)||"communicationUser"===a.identifier.kind))throw new I({defaultError:f.CALL_AGENT.ACTION_BLOCKED});return this.tsCall.addParticipant(rl(e),{threadId:s}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.success,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date}})})).catch((t=>{const{callEndReason:n}=Hp(this,a.tsRemoteParticipant,t);a.callEndReason||a.setCallEndReason(n);const s=qp(n);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"add",correlationId:r,timestampInfo:{deltaTimeInMs:i-+new Date},additionalDetails:{code:s?.callEndReason.code,subCode:s?.callEndReason.subCode,failureReason:s?.callEndReason.message,...s}}),this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)))&&(this.deleteRemoteParticipant(a),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[a]}))})),a}async removeParticipant(e){const t=+new Date,i=x();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.attempt,participantAddedOrRemoved:"remove",correlationId:i,timestampInfo:{attemptTimestamp:t}});try{ol(e)}catch(e){const n=new I({defaultError:f.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:e});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:i,timestampInfo:{deltaTimeInMs:t-+new Date},additionalDetails:{code:e.code,failureReason:e.message,...jp(n)}}),n}let r=this._remoteParticipants.find((t=>rl(t.identifier)===rl(e)));if(!r){const r=new I({defaultError:f.CALL.PARTICIPANT_NOT_IN_CALL,originalError:[n.getIdentifierKind(e).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:i,timestampInfo:{deltaTimeInMs:+new Date-t},additionalDetails:{code:r.code,subCode:r.subCode,failureReason:r.message,...jp(r)}}),r}try{await this.tsCall.removeParticipant(rl(e)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.success,participantAddedOrRemoved:"remove",correlationId:i,timestampInfo:{deltaTimeInMs:t-+new Date}})}catch(e){const{callEndReason:n}=Hp(this,r.tsRemoteParticipant,e);r.callEndReason||r.setCallEndReason(n);const s=qp(n);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Zu.failure,participantAddedOrRemoved:"remove",correlationId:i,timestampInfo:{deltaTimeInMs:t-+new Date},additionalDetails:{code:s?.callEndReason.code,subCode:s?.callEndReason.subCode,failureReason:s?.callEndReason.message,...s}}),new I({defaultError:{message:n.message,code:n.code,subCode:n.subCode||0,resultCategories:n.resultCategories},originalError:e})}}async mute(){super.mute()}async unmute(){super.unmute()}async hold(){if(4===this.tsCall.state)return void this.logger.info("Call already on hold");if(!yl().calling.musicOnHoldEnabled)return this.logger.warn("Music on Hold is not enabled"),super.hold();this._musicOnHoldEnabled=!1;const e=+new Date,t=x();this._causeId=m.generateCauseId(),this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.attempt,timestampInfo:{deltaTimeInMs:e},additionalDetails:{holdType:Lg.MusicOnHold}});try{this.logger.info("Fetching Teams Calling Policy from Azure Communication Services"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId,{policyUrlSuffix:yl().MiddleTier.policyUrlSuffixV2,userPolicies:["TeamsCallingPolicy"]}),this._musicOnHoldEnabled=this._mtPolicyService.isMoHEnabled()}catch(e){this.logger.warn(`Fetching Teams Calling Policy from Azure Communication Services failed.\n                Error message = ${e?.message}, code = ${e?.code}, subcode = ${e?.subCode}.`)}return this._musicOnHoldEnabled?await this.tsCall.hold(void 0,this._causeId,{isLocal:!0},1).then((async()=>{this.logger.info("Successfully detached devices as part of Hold"),await this.tsCall.park(3,this._causeId).then((()=>{const i=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{holdType:Lg.MusicOnHold}}),this.logger.info("Successful park() as part of hold, Music on Hold completed successfully")}))})).catch((()=>{const i=+new Date,n=new I({defaultError:f.CALL.HOLD_CALL});throw this.logger.warn(`Attempting to perform Music on Hold failed.\n                    Error message = ${n.message}, code = ${n.code}, subcode = ${n.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Hold,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,holdType:Lg.MusicOnHold,...jp(n)}}),n})):(this.logger.info("Fetching  of Teams Calling Policy failed or Music on Hold Disabled, proceeding with standard hold"),super.hold())}async resume(){if(this._musicOnHoldEnabled){const e=+new Date,t=x();return this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.attempt,timestampInfo:{deltaTimeInMs:e},additionalDetails:{holdType:Lg.MusicOnHold}}),await this.tsCall.unpark(3,this._causeId).then((async()=>{this.logger.info("Successful unpark() as part of resume"),await this.tsCall.unhold(void 0,this._causeId).then((()=>{const i=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.success,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{holdType:Lg.MusicOnHold}}),this.logger.info("Successful unhold() as part of resume, resume completed successfully")}))})).catch((()=>{const i=+new Date,n=new I({defaultError:f.CALL.RESUME_CALL});throw this.logger.warn(`Attempting to perform resume from Music on Hold failed.\n                    Error message = ${n.message}, code = ${n.code}, subcode = ${n.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:Xu.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:t,operation:Sg.Resume,kindOfEvent:Zu.failure,timestampInfo:{deltaTimeInMs:i-e},additionalDetails:{failureReason:n.message,code:n.code,subCode:n.subCode,holdType:Lg.MusicOnHold,...jp(n)}}),n}))}return this.logger.info("Music on Hold Disabled, proceeding with standard resume"),super.resume()}validateThreadId(e,t){if(!t?.threadId){const e=new I({defaultError:f.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID});throw this.logger.error(`Error Message = ${e.message}, code = ${e.code}, subcode = ${e.subCode}`),e}this.validateThreadIdFormat(t?.threadId)}validateThreadIdFormat(e){if(!e.startsWith("19")){const e=new I({defaultError:f.CALL.TEAMS_INVALID_THREAD_ID});throw this.logger.error(`Error Message = ${e.message}, code = ${e.code}, subcode = ${e.subCode}`),e}}enforcePolicyAndLicenseRestrictions(){const e=+new Date;if(!this._mtPolicyService.isEvEnabled()){const t=+new Date,i=new I({defaultError:f.CALL.CTE_VOICE_NOT_ENABLED});this.logger.error(`Error Message = ${i.message}, code = ${i.code}, subcode = ${i.subCode}`);const n=this._callAgent.getEcsConfigIds();throw this.sendCallStageEvent({eventName:Xu.acs_calling_call_failed,correlationId:x(),timestampInfo:{deltaTimeInMs:t-e},additionalPayload:{additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:n.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:n.SkypeWebMedia},additionalDetails:{...jp(i)}}},i,{code:i.code,subCode:i.subCode,phrase:i.message}),i}}handlePolicyAndLicenseRestrictionsFailure(e){this._callEndReason={message:"Unknown",code:e?.code,subCode:e?.subCode,resultCategories:e?.resultCategories},this._state="Disconnected",this._eventEmitter.emit("stateChanged"),this._callAgent.handleCallRemoved(this.tsCall)}async setupThreadIdWhenStartingGroupCall(e,t,i){if(t&&t.threadId&&(this.validateThreadIdFormat(t.threadId),this.logger.info("ThreadId is already provided in the options parameter: "+JSON.stringify(t))),void 0===t||!t.threadId){let n=[];e.forEach((e=>{n.push({id:rl(e)})}));try{this._mtPolicyService.CreateChatThreadId(this.tsCall.callId,{createThreadIdSuffix:yl().MiddleTier.serverManagedThreadIdApiConfiguration.createThreadSuffix,participants:n}).then((e=>{t||(t={}),t.threadId=e,e&&this._info.setThreadId(e),i&&e&&(i.threadId=e)}))}catch(e){let t="Failed to create thread Id for Teams group call ";if(!yl().MiddleTier.serverManagedThreadIdApiConfiguration.decoupleChatThreadFromCalls)throw new I({defaultError:f.CTE_MID_TIER_POLICY_SERVICE.CREATETHREAD_FAILED});this.logger.warn(t+e)}}}}WE([D(Sg.AddParticipant),P(Sg.AddParticipant),zE("design:type",Function),zE("design:paramtypes",[Object,Object]),zE("design:returntype",Object)],JE.prototype,"addParticipant",null),WE([D(Sg.RemoveParticipant),M(Sg.RemoveParticipant),zE("design:type",Function),zE("design:paramtypes",[Object]),zE("design:returntype",Promise)],JE.prototype,"removeParticipant",null),WE([D(Sg.Mute),zE("design:type",Function),zE("design:paramtypes",[]),zE("design:returntype",Promise)],JE.prototype,"mute",null),WE([D(Sg.Unmute),zE("design:type",Function),zE("design:paramtypes",[]),zE("design:returntype",Promise)],JE.prototype,"unmute",null),WE([D(Sg.Hold),M(Sg.Hold),zE("design:type",Function),zE("design:paramtypes",[]),zE("design:returntype",Promise)],JE.prototype,"hold",null),WE([D(Sg.Resume),M(Sg.Resume),zE("design:type",Function),zE("design:paramtypes",[]),zE("design:returntype",Promise)],JE.prototype,"resume",null);var KE=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},YE=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const QE=new Map;class XE extends j_{get calls(){return this._calls}constructor(t,i,n,r,s,a){super(t,i,r,s,n,e.CallAgentKind.TeamsCallAgent,a),this._calls=[],this.handleCallAdded=e=>{if(!this._calls.find((t=>t.id===e.callId))){const t=e.on("callStateChanged",(()=>{if(1===e.state){const i=e.callId;t.dispose();const n=new JE({callId:i,isIncoming:!0},this,e,this._telemetryLogManager),r=new jE(n);this.handleCallState(n),n.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:r})}}))}},this.handleCallRemoved=e=>{this.logger.info(`removing callId=${e.callId}`);const t=this._calls.find((t=>t.id===e.callId));if(t){const e=this._calls.indexOf(t);-1!==e&&this._calls.splice(e,1),t.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[t]}),this.logger.info("call removed")}},this.handleCallState=e=>{e.on("stateChanged",(()=>{try{"Disconnected"===e.state?this.tsStack?(this._tsCallRegistry.deleteCall(e.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${e.id}`),e.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(e.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry"):"Connecting"===e.state&&"Incoming"==e.direction&&(this.addToCallArray(e),this._eventEmitter.emit("callsUpdated",{added:[e],removed:[]}))}catch(e){this.logger.error("Failed to handle call state changed event")}}))},this.logger=i}createNewCall(e,t){return new JE({callId:e},this,t,this._telemetryLogManager)}addToCallArray(e){this._calls.push(e),this.trackCallEndTimeToStopTelemetry(this._calls)}addToCallAgentsMap(e){QE.get(e?.identityMri)&&Ol(f.CALL_AGENT.TEAMS_CALLAGENT_ALREADY_EXSISTS,this.logger),QE.set(e?.identityMri,this)}removeFromCallAgentsMap(e){e?.identityMri&&QE.get(e?.identityMri)===this&&QE.delete(e?.identityMri)}getMiddleTierServiceInstance(){return this.mtPolicyService}async setUserPoliciesOnAgentInitialization(){try{if(this.isCteUser()){this.mtPolicyService.initialize({localParticipant:this.getUserMri(),skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});let e=x();this.logger.info(`ACS MiddleTier service called on Teams Call Agent initialization with call Id=${e}`),await this.mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(e,this.getUserMri(),{policyUrlSuffix:yl().MiddleTier.policyUrlSuffixV2,userPolicies:["EmergencyPolicies","TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata","phoneNumber","sipUri","hostType","accountEnabled","useTeamsCalling","evEnabled","region","routingType","preferredDataLocation","featureTypes"]}),this._userPolicies=this.mtPolicyService.getUserPolicy(),this.logger.info(`****User policy initialized to ${JSON.stringify(this._userPolicies)}`)}}catch(e){this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n            Error message = ${e?.message}, code = ${e?.code}, subcode = ${e?.subCode}.`)}}startCall(e,t){let i;if(this.assertParticipants(e),Array.isArray(e)){if(i=t,e.length>1&&!yl().MiddleTier.serverManagedThreadIdApiConfiguration.allowServerThreadCreation&&!i?.threadId)throw new I({defaultError:f.CALL_AGENT.GROUPCALL_THREADID});if(1==e.length&&i?.threadId)throw new I({defaultError:f.CALL_AGENT.ONE_TO_ONE_THREADID})}else i=t;if(yl().calling.enableSmePassFakeConversation&&this.isAcsToTeamsInteropCall(e))throw new I({defaultError:f.CALL_AGENT.ACTION_BLOCKED});this.mtPolicyService.isFetchUserPoliciesAndSettingsApplicable(this.isCteUser(),e)&&this.mtPolicyService.initialize({localParticipant:this.getUserMri(),pstnNumber:Array.isArray(e)?e[0].phoneNumber:e.phoneNumber,skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});let n=i?.audioOptions?.muted;return void 0===n&&(n=!1),this.logger.info(`startCall with video=${!!i?.videoOptions},muted=${n}`),this.createCall({participants:e,startCallOptions:i})}join(e,t){this.assertCallContext(e);let i=!!t?.audioOptions?.muted;return this.logger.info(`join with video=${!!t?.videoOptions},muted=${i}`),this.createCall({teamsCallContext:e,startCallOptions:t})}async dispose(){if(this._disposed)throw new I({defaultError:f.CALL_AGENT.CTE_ALREADY_DISPOSED});this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&QE.delete(this._parsedTokenCredential?.identityMri);try{const e=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(e))}catch(e){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(e,t){if("incomingCall"!==e&&"callsUpdated"!==e&&"connectionStateChanged"!==e)throw new I({defaultError:f.CALL_AGENT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.on(e,t)}off(e,t){if("incomingCall"!==e&&"callsUpdated"!==e&&"connectionStateChanged"!==e)throw new I({defaultError:f.CALL_AGENT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[e]});this._eventEmitter.off(e,t)}createCall(e){let t,i,n,r=e?.teamsCallContext?.threadId,s=!1;const a=e?.teamsCallContext?.meetingLink,o=e?.teamsCallContext?.meetingId,c=e?.teamsCallContext?.passcode||"",l=!!e?.participants&&Array.isArray(e?.participants)&&e?.participants.length>1;if(this.isCteUser()&&l&&(r=(e?.startCallOptions).threadId),!$l(this.acsProxy,this.acsCustomRelayManager,!0))throw new I({defaultError:f.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});if(a)if(xg(a))i=Vg(a);else{if(!Ug(a,this.logger))throw new I({defaultError:f.CALL_AGENT.INVALID_MEETING_LINK});if(Fg(a.trim().toLocaleLowerCase(),yl().calling.tfl.hosts))throw new I({defaultError:f.CALL_AGENT.UNSUPPORTED_TFL_MEETING_JOIN});s=!0}if(e?.teamsCallContext?.threadId&&e?.teamsCallContext?.organizerId&&e?.teamsCallContext?.tenantId&&(i={threadId:e?.teamsCallContext?.threadId,messageId:e?.teamsCallContext?.messageId?e?.teamsCallContext?.messageId.toString():"0",organizerId:e?.teamsCallContext?.organizerId,tenantId:e?.teamsCallContext?.tenantId}),i&&(n={meetingType:"0"===i.messageId?1:2,tenantId:i.tenantId,organizerId:i.organizerId,replyChainMessageId:i.messageId}||void 0,r=i.threadId,t=i.messageId),this.tsStack){const i=m.generateCauseId(),l=x(),d=x();let h;h=o?this._tsCallRegistry.createCallWithMeetingData({meetingCode:o,passcode:c,threadId:r},l,d,i):s?this._tsCallRegistry.createCallWithMeetingData({meetingUrl:a},l,d,i):this._tsCallRegistry.createCall(r||"",l,d,t,i);const u=new JE({callId:l},this,h,this._telemetryLogManager);this.addToCallArray(u),this.handleCallState(u);const g={threadId:r||"",messageId:t||"",meetingInfo:n,mediaPeerType:2};return u.startCallInternal(e?.startCallOptions,!!o,e?.teamsCallContext,g,e?.participants).catch(kl),u.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[u],removed:[]}),u}throw new I({defaultError:f.CALL_AGENT.STACK_NOT_INIT})}assertParticipants(e){Ml(e,f.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),Pl(e,f.CALL_AGENT.USERIDS_CANNOT_BE_NULL)}assertCallContext(e){if(!e||this.checkForAtLeastOneValidCallConfig(e)||this.checkForInvalidTeamsMeetingCoordinates(e))throw new I({defaultError:f.CALL_AGENT.INVALID_JOIN_LOCATOR})}checkForAtLeastOneValidCallConfig(e){return!e.threadId&&!e.meetingLink&&!e.meetingId}checkForInvalidTeamsMeetingCoordinates(e){return!e.threadId&&e.tenantId&&e.organizerId||e.threadId&&(e.organizerId&&!e.tenantId||!e.organizerId&&e.tenantId)}isAcsToTeamsInteropCall(e){let t=!1;return this.isCteUser()&&(Array.isArray(e)?e.length>=1&&e.find((e=>n.isCommunicationUserIdentifier(e)))&&(t=!0):n.isCommunicationUserIdentifier(e)&&(t=!0)),t}}KE([P(fg.StartCall),YE("design:type",Function),YE("design:paramtypes",[Object,Object]),YE("design:returntype",Object)],XE.prototype,"startCall",null),KE([P(fg.Join),YE("design:type",Function),YE("design:paramtypes",[Object,Object]),YE("design:returntype",Object)],XE.prototype,"join",null),KE([M(fg.Dispose),YE("design:type",Function),YE("design:paramtypes",[]),YE("design:returntype",Promise)],XE.prototype,"dispose",null);class ZE{constructor(){this._proxyInUse=!1;const e=t.createClientLogger("ACS-calling");this.logger=new Uf(e,[()=>"AcsProxy"])}get proxyInUse(){return this._proxyInUse}set proxyInUse(e){this._proxyInUse=e}get proxyUrl(){return this._proxyUrl?.toString()||""}set proxyUrl(e){if(e.length<4)throw new I({defaultError:f.CALL_CLIENT.PROXY_SHORT_URL});"/"!==e.slice(-1)&&(e=e.concat("","/"));try{const t=new URL(e);if("https:"!==t.protocol&&"http:"!==t.protocol)throw new I({defaultError:f.CALL_CLIENT.PROXY_PROTOCOL});this._proxyUrl=t}catch(t){const i=new I({defaultError:f.CALL_CLIENT.SETUP_PROXY,defaultErrorMessageArgs:[e],originalError:t});throw this.logger.error(i.message),i}}hasProxyUrl(){return!!this._proxyUrl}proxyfyUrl(e){let t=e;if(!this._proxyUrl)return this.logger.info(`Proxy url not defined, return original ${t}`),t;try{const e=new URL(t);t=`${e.protocol}//${this._proxyUrl.host}${this._proxyUrl.pathname}${e.host}${e.pathname}${e.search}`,this.logger.info(`Proxyfing url from ${e} to ${t}`)}catch(e){const t=`Failed proxyfy url with error: ${JSON.stringify(e)}, returning original`;this.logger.error(t)}return this._proxyInUse=!0,t}}class eT{constructor(){this._hasCustomRelay=!1,this._customRelayManagerInUse=!1;const e=t.createClientLogger("ACS-calling");this._logger=new Uf(e,[()=>"AcsCustomRelayManager"])}getRelayConfig(){return this._relayConfig}setRelayConfig(e){this._relayConfig={...e},this._logger.info("Custom relay config provided"),this._hasCustomRelay=!0,this._createTsRelayManager()}get hasRelayConfig(){return this._hasCustomRelay}get customRelayManagerInUse(){return this._customRelayManagerInUse}set customRelayManagerInUse(e){this._customRelayManagerInUse=e}getTsRelayManager(){return this._tsRelayManager}_createTsRelayManager(){if(!this._hasCustomRelay||!this._relayConfig||this._relayConfig.iceServers.length<1)return void this._logger.warn("No relay config provided. No op.");const e=[];this._relayConfig.iceServers.forEach((t=>{t.urls.forEach((i=>{const n=this._getIndividualRelay(i,t?.username,t?.credential);e.push(n)}))})),this._tsRelayManager={initialize(){},queryRelaysAsync:t=>Promise.resolve(e)}}_getIndividualRelay(e,t,i){const n=[],r=[],s=[Gg.turn,Gg.turns,Gg.stun],a=[jg.tcp,jg.tls,jg.udp];let o;try{o=new URL(e)}catch(t){throw new I({defaultError:f.CALL_CLIENT.RELAY_INFO,defaultErrorMessageArgs:[e],originalError:t})}const c=o.protocol.replace(":","");if(!s.includes(c))throw new I({defaultError:f.CALL_CLIENT.RELAY_UNRECOGNIZED_SCHEMA});let l,d="";try{d=o.href.replace(/((turn)s?|stun):/,"https:"),l=new URL(d)}catch(e){throw new I({defaultError:f.CALL_CLIENT.RELAY_INFO,defaultErrorMessageArgs:[d],originalError:e})}let h=l.searchParams.get("transport")??"";a.includes(h)||(this._logger.warn(`Unknown transport protocol detected for the provided turn, defaulting to ${jg.udp}`),h=jg.udp);let u=""===l.port?this._extractPortFromUrl(o):Number(l.port);u||(this._logger.warn("Could not read port from relay url, defaulting to 3478"),u=3478);let g=l.hostname;return function(e){return new RegExp(Xc).test(e)}(g)?n.push(g):r.push(g),{addresses:n,udpPort:h===jg.udp?u:void 0,tcpPort:h===jg.tcp?u:void 0,tlsPort:h===jg.tls?u:void 0,username:t??"",password:i??"",type:"turn",fqdns:r}}_extractPortFromUrl(e){const t=e.href.match(Zc)?.[0];return Number(t?.replace(":",""))}}var tT,iT=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},nT=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let rT=1;class sT{get callAgent(){return this._callAgent}get teamsCallAgent(){return this._teamsCallAgent}get sdkDiagnosticInformation(){return this._sdkDiagnosticInformation}get telemetryLogManager(){return this._telemetryLogManager}setCallAgent(e){this._callAgent=e}setTeamsCallAgent(e){this._teamsCallAgent=e}on(e,t){this._eventEmitter.on(e,t)}off(e,t){this._eventEmitter.off(e,t)}constructor(e){this._customProxyAndTurnInformation={proxy:null,turn:null},this.sendTelemetry=()=>{try{if(yl().telemetry.telemetryBeforeUnload&&this._callAgent&&this._callAgent._calls)for(const e of this._callAgent._calls)e.tsCall.sendLastKnownStats()}catch(e){this.logger.debug("Error logging telemetry",e)}},this.handleVisibilityChange=()=>{"hidden"===document.visibilityState?(this.logger.debug("Visibility changed to hidden"),this.sendPageVisibilityInfoEvent("visibilityChange",!0),this.hangupCalls()):(this.logger.debug("Visibility changed to visible"),this.sendPageVisibilityInfoEvent("visibilityChange",!1))},this.handlePageShow=()=>{this.logger.debug("Page show"),this.sendPageVisibilityInfoEvent("pageShow",!0)},this.handlePageHide=()=>{this.logger.debug("Page hide"),this.sendPageVisibilityInfoEvent("pageHide",!1)},this.handleOrientationChange=()=>{this.logger.debug(`Orientation changed to ${screen.orientation.type}`),this.sendOrientationChangeEvent(screen.orientation.type)},this.getOrientationBasedOnWindowSize=()=>window.innerHeight>window.innerWidth?"portrait-primary":"landscape-primary",this.handleResize=()=>{const e=this.getOrientationBasedOnWindowSize();this._previousOrientation!==e&&(this._previousOrientation=e,this.sendOrientationChangeEvent(e))};const i=+new Date;this.clientId=x();const n=e?.logger||t.createClientLogger("ACS-calling"),r=rT++;if(this._acsProxy=new ZE,this._acsCustomRelayManager=new eT,e?.networkConfiguration){e.networkConfiguration.proxy?.url&&(this._customProxyAndTurnInformation.proxy={...e.networkConfiguration.proxy},this._acsProxy.proxyUrl=this._customProxyAndTurnInformation.proxy.url),e.networkConfiguration.turn&&(this._customProxyAndTurnInformation.turn={...e.networkConfiguration.turn},this._acsCustomRelayManager.setRelayConfig(this._customProxyAndTurnInformation.turn));const t=this.getTelemetryTag();e.diagnostics?e.diagnostics.tags?e.diagnostics.tags.push(t):e.diagnostics.tags=[t]:e.diagnostics={tags:[t]}}this.logger=new Uf(n,[()=>`CallClient${r}`]),this._eventEmitter=new Nm(this.logger),this._sdkDiagnosticInformation=function(e,t,i){const n=`azsdk-js-communication-calling/${e}`;let r="";if(i?.diagnostics?.appName){let e=i?.diagnostics?.appName.trim().replace(/\s/g,"_");e.length>64&&(t.warn("appName is too long, max allowed length is 64 chars, appName was truncated to max length"),e=e.substr(0,64)),r+=e?`${e}/`:"default/"}else r+="default/";if(i?.diagnostics?.appVersion){let e=i?.diagnostics?.appVersion.trim().replace(/\s/g,"_");e.length>64&&(t.warn("appVersion is too long, max allowed length is 64 chars, appVersion was truncated to max length"),e=e.substr(0,64)),r+=e||"0.0.0"}else r+="0.0.0";if(r+=` ${n}`,i?.diagnostics?.tags&&Array.isArray(i?.diagnostics?.tags)&&i?.diagnostics?.tags.length>0){let e=i?.diagnostics?.tags.map((e=>e.trim().replace(/\s/g,"_"))).filter((e=>!!e)).join(";");e.length>128&&(t.warn("tags are too long, max allowed length is 128 chars, tags were truncated to max length"),e=e.substr(0,128)),e.length>0&&(r+=" ("+e+").")}return r}(hl(),this.logger,e),this.diagnosticOptions=e?.diagnostics,this.firstPartyOptions=e?.firstPartyOptions,this._telemetryLogManager=new og(this.logger,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager);try{this.sendCallClientInitEvent({eventName:Xu.acs_calling_call_client_init,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),Object.defineProperty(globalThis,bc,{value:r,writable:!0,enumerable:!1}),1===r&&Object.defineProperty(globalThis,Ic,{value:this._telemetryLogManager,writable:!1,enumerable:!1}),this.logger.info("created"),this._callStack=new UE(this.logger,this.clientId,this._telemetryLogManager,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager,this.firstPartyOptions?.encodedStreamsJsPath),this._deviceManager=new $E(this.logger,this._callStack,this._telemetryLogManager),this._previousOrientation="",this.sendInitialOrientation(),window.addEventListener("beforeunload",this.sendTelemetry),window.addEventListener("visibilitychange",this.handleVisibilityChange,!1),window.addEventListener("pageshow",this.handlePageShow,!1),window.addEventListener("pagehide",this.handlePageHide,!1),screen.orientation?screen.orientation.addEventListener("change",this.handleOrientationChange):window.addEventListener("resize",this.handleResize,!1),this._extensibleApi=new bp(this.logger,{callClient:this},{callClient:this,telemetryLogManager:this._telemetryLogManager});const e=IC(vp.CallClientFeature);for(const t of e)"OnExtendedObjectConstructor"===t.activationOptions.activationEvent&&this.feature(t);this.sendCallClientInitEvent({eventName:Xu.acs_calling_call_client_init,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:""})}catch(e){const t=new I({defaultError:f.CALL_CLIENT.INIT_CALL_CLIENT,originalError:e});throw this.sendCallClientInitEvent({eventName:Xu.acs_calling_call_client_init,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-i},additionalDetails:{failureReason:t.message,code:t.code,subCode:t.subCode,...jp(t)}}),t}}createInstance(e){return new sT(e)}get acsProxy(){return this._acsProxy}get acsCustomRelayManager(){return this._acsCustomRelayManager}getSDKVersion(){return hl()}feature(e){return this._extensibleApi.getApiObjectInstance(e.callClientApiCtor)}async createCallAgent(e,t){(this._callAgent||this._teamsCallAgent)&&Ol(f.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger),this.validateEmergencyCountryCode(t);try{const i=()=>{this._callAgent=void 0};return this._callAgent=new J_(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager,t),await this._callAgent.initialize(e,i,t),this._eventEmitter.emit("callAgentCreated"),this._callAgent}catch(e){throw this._callAgent=void 0,new I({defaultError:f.CALL_CLIENT.CREATE_CALL_AGENT,originalError:e})}}async createTeamsCallAgent(e,t){(this._callAgent||this._teamsCallAgent)&&Ol(f.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger);try{const i=()=>{this._teamsCallAgent=void 0};return this._teamsCallAgent=new XE(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager),await this._teamsCallAgent.initialize(e,i,t),this._teamsCallAgent.setUserPoliciesOnAgentInitialization(),this._eventEmitter.emit("teamsCallAgentCreated"),this._teamsCallAgent}catch(e){throw this._teamsCallAgent=void 0,new I({defaultError:f.CALL_CLIENT.CREATE_TEAMS_CALL_AGENT,originalError:e})}}async getDeviceManager(){return await this._deviceManager.getDeviceManager(),this._deviceManager}async getEnvironmentInfoInternal(){return this._environmentInfos||(await this._callStack.createStackBase(),this._environmentInfos=jC()),this._environmentInfos}validateEmergencyCountryCode(e){e?.emergencyCallOptions?.countryCode&&e.emergencyCallOptions?.countryCode.length>10&&Ol(f.CALL_CLIENT.EMERGENCY_CODE_TOO_LONG,this.logger)}sendOrientationChangeEvent(e,t=!1){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_orientation_changed,tenant:uc,properties:{orientation:e,isInitial:t}})}catch(e){this.logger.debug("Unable to send orientation change telemetry")}}sendInitialOrientation(){let e=screen.orientation&&screen.orientation.type;e||(e=this.getOrientationBasedOnWindowSize()),this.sendOrientationChangeEvent(e,!0)}sendCallClientInitEvent(e){try{this._telemetryLogManager.sendEvent({name:e.eventName,tenant:uc,properties:e})}catch(e){this.logger.debug("Unable to send CallClient initialized telemetry event")}}hangupCalls(){try{"Mobile"===FC().formFactor&&yl().calling.hangUpCallOnPageHide&&this._callAgent?.calls.forEach((e=>e.hangUp()))}catch(e){try{this.logger.error(`Unable to hangup call on page hide due to ${JSON.stringify(e)}`)}catch(e){this.logger.error("Unable to hangup call on page hide due to unknown error")}}}sendPageVisibilityInfoEvent(e,t){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:Xu.acs_calling_page_hidden,tenant:uc,properties:{eventName:e,pageHidden:t}})}catch(e){this.logger.debug("Unable to send page hide telemetry")}}getTelemetryTag(){return this._customProxyAndTurnInformation.proxy&&this._customProxyAndTurnInformation.turn?Jc.usedProxyAndNonMsftTurn:this._customProxyAndTurnInformation.proxy?Jc.onlyUsedProxy:this._customProxyAndTurnInformation.turn?Jc.onlyUsedNonMsftTurn:""}}iT([Of,nT("design:type",Object)],sT.prototype,"logger",void 0),iT([P(mg.GetSDKVersion),nT("design:type",Function),nT("design:paramtypes",[]),nT("design:returntype",String)],sT.prototype,"getSDKVersion",null),iT([P(mg.Feature),nT("design:type",Function),nT("design:paramtypes",[Object]),nT("design:returntype","function"==typeof(tT="undefined"!=typeof TFeature&&TFeature)?tT:Object)],sT.prototype,"feature",null),iT([M(mg.CreateCallAgent),nT("design:type",Function),nT("design:paramtypes",[Object,Object]),nT("design:returntype",Promise)],sT.prototype,"createCallAgent",null),iT([M(mg.CreateTeamsCallAgent),nT("design:type",Function),nT("design:paramtypes",[Object,Object]),nT("design:returntype",Promise)],sT.prototype,"createTeamsCallAgent",null),iT([M(mg.GetDeviceManager),nT("design:type",Function),nT("design:paramtypes",[]),nT("design:returntype",Promise)],sT.prototype,"getDeviceManager",null),iT([M(mg.GetEnvironmentInfo),nT("design:type",Function),nT("design:paramtypes",[]),nT("design:returntype",Promise)],sT.prototype,"getEnvironmentInfoInternal",null),e.CallClient=sT,e.Features=TC,e.LocalAudioStream=Yf,e.LocalVideoStream=$f,e.VideoStreamRenderer=m_,Object.defineProperty(e,"__esModule",{value:!0})}(t,i(367),i(351))},639:(e,t,i)=>{"use strict";i.d(t,{H:()=>c});class n extends Error{}n.prototype.name="InvalidTokenError";const r=e=>{const{exp:t}=function(e,t){if("string"!=typeof e)throw new n("Invalid token specified: must be a string");t||(t={});const i=!0===t.header?0:1,r=e.split(".")[i];if("string"!=typeof r)throw new n(`Invalid token specified: missing part #${i+1}`);let s;try{s=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(e){return decodeURIComponent(atob(e).replace(/(.)/g,((e,t)=>{let i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i})))}(t)}catch(e){return atob(t)}}(r)}catch(e){throw new n(`Invalid token specified: invalid base64 for part #${i+1} (${e.message})`)}try{return JSON.parse(s)}catch(e){throw new n(`Invalid token specified: invalid json for part #${i+1} (${e.message})`)}}(e);return{token:e,expiresOnTimestamp:1e3*t}},s={token:"",expiresOnTimestamp:-10};class a{constructor(e){this.expiringSoonIntervalInMs=6e5,this.refreshAfterLifetimePercentage=.5,this.activeTokenFetching=null,this.activeTokenUpdating=null,this.disposed=!1;const{tokenRefresher:t,token:i,refreshProactively:n}=e;this.refresh=t,this.currentToken=i?r(i):s,this.refreshProactively=null!=n&&n,this.refreshProactively&&this.scheduleRefresh()}async getToken(e){if(!this.isTokenExpiringSoon(this.currentToken))return this.currentToken;if(!this.isTokenValid(this.currentToken)){const t=this.updateTokenAndReschedule(null==e?void 0:e.abortSignal);await t}return this.currentToken}dispose(){this.disposed=!0,this.activeTokenFetching=null,this.activeTokenUpdating=null,this.currentToken=s,this.activeTimeout&&clearTimeout(this.activeTimeout)}async updateTokenAndReschedule(e){if(this.activeTokenUpdating)return this.activeTokenUpdating;this.activeTokenUpdating=this.refreshTokenAndReschedule(e);try{await this.activeTokenUpdating}finally{this.activeTokenUpdating=null}}async refreshTokenAndReschedule(e){const t=await this.refreshToken(e);if(!this.isTokenValid(t))throw new Error("The token returned from the tokenRefresher is expired.");this.currentToken=t,this.refreshProactively&&this.scheduleRefresh()}async refreshToken(e){try{return this.activeTokenFetching||(this.activeTokenFetching=this.refresh(e)),r(await this.activeTokenFetching)}finally{this.activeTokenFetching=null}}scheduleRefresh(){if(this.disposed)return;this.activeTimeout&&clearTimeout(this.activeTimeout);const e=this.currentToken.expiresOnTimestamp-Date.now();let t=null;t=this.isTokenExpiringSoon(this.currentToken)?e*this.refreshAfterLifetimePercentage:e-this.expiringSoonIntervalInMs,this.activeTimeout=setTimeout((()=>this.updateTokenAndReschedule()),t)}isTokenValid(e){return e&&Date.now()<e.expiresOnTimestamp}isTokenExpiringSoon(e){return!e||Date.now()>=e.expiresOnTimestamp-this.expiringSoonIntervalInMs}}class o{constructor(e){this.token=e}async getToken(){return this.token}dispose(){}}class c{constructor(e){this.disposed=!1,this.tokenCredential="string"==typeof e?new o(r(e)):new a(e)}async getToken(e){this.throwIfDisposed();const t=await this.tokenCredential.getToken(e);return this.throwIfDisposed(),t}dispose(){this.disposed=!0,this.tokenCredential.dispose()}throwIfDisposed(){if(this.disposed)throw new Error("User credential is disposed")}}},351:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AzureCommunicationTokenCredential:()=>n.H,createCommunicationAccessKeyCredentialPolicy:()=>S,createCommunicationAuthPolicy:()=>N,createIdentifierFromRawId:()=>K,deserializeCommunicationIdentifier:()=>X,getIdentifierKind:()=>q,getIdentifierRawId:()=>W,isCommunicationUserIdentifier:()=>B,isKeyCredential:()=>F,isMicrosoftTeamsAppIdentifier:()=>G,isMicrosoftTeamsUserIdentifier:()=>$,isPhoneNumberIdentifier:()=>H,isUnknownIdentifier:()=>j,parseClientArguments:()=>V,parseConnectionString:()=>x,serializeCommunicationIdentifier:()=>Q});var n=i(639);const r=e=>(new TextEncoder).encode(e);function s(e){if("function"!=typeof btoa)throw new Error("Your browser environment is missing the global `btoa` function");const t=new Uint8Array(e);let i="";for(const e of t)i+=String.fromCharCode(e);return btoa(i)}var a;const o=null===(a=null===globalThis||void 0===globalThis?void 0:globalThis.crypto)||void 0===a?void 0:a.subtle,c=async e=>{const t=r(e);return s(await o.digest("SHA-256",t))},l=async(e,t)=>{const i={name:"HMAC",hash:{name:"SHA-256"}},n=r(t),a=function(e){if("function"!=typeof atob)throw new Error("Your browser environment is missing the global `atob` function");const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}(e),c=o,l=await c.importKey("raw",a,i,!1,["sign"]);return s(await c.sign(i,l,n))};var d,h,u,g,p;new Set("0123456789abcdefABCDEF"),"function"==typeof(null===(d=null===globalThis||void 0===globalThis?void 0:globalThis.crypto)||void 0===d?void 0:d.randomUUID)&&globalThis.crypto.randomUUID.bind(globalThis.crypto),"undefined"!=typeof window&&window.document,"object"==typeof self&&"function"==typeof(null===self||void 0===self?void 0:self.importScripts)&&("DedicatedWorkerGlobalScope"===(null===(h=self.constructor)||void 0===h?void 0:h.name)||"ServiceWorkerGlobalScope"===(null===(u=self.constructor)||void 0===u?void 0:u.name)||null===(g=self.constructor)||void 0===g||g.name),"undefined"!=typeof Deno&&void 0!==Deno.version&&Deno.version.deno,"undefined"!=typeof Bun&&Bun.version;const m=void 0!==globalThis.process&&Boolean(globalThis.process.version)&&Boolean(null===(p=globalThis.process.versions)||void 0===p?void 0:p.node),f=("undefined"!=typeof navigator&&(null===navigator||void 0===navigator||navigator.product),"CommunicationAccessKeyCredentialPolicy");function S(e){return{name:f,async sendRequest(t,i){var n;const r=t.method.toUpperCase(),s=(new Date).toUTCString(),a=await c((null===(n=t.body)||void 0===n?void 0:n.toString())||""),o="x-ms-date",d=`${o};host;x-ms-content-sha256`,h=new URL(t.url),u=h.searchParams.toString(),g=u?`${h.pathname}?${u}`:h.pathname,p=h.port,f=p?`${h.host}:${p}`:h.host,S=`${r}\n${g}\n${s};${f};${a}`,v=await l(e.key,S);return m&&t.headers.set("Host",f||""),t.headers.set(o,s),t.headers.set("x-ms-content-sha256",a),t.headers.set("Authorization",`HMAC-SHA256 SignedHeaders=${d}&Signature=${v}`),i(t)}}}new Set(["Deserialize","Serialize","Retry","Sign"]);var v=i(367);const y=(0,v.createClientLogger)("core-rest-pipeline"),C="REDACTED",_=["x-ms-client-request-id","x-ms-return-client-request-id","x-ms-useragent","x-ms-correlation-request-id","x-ms-request-id","client-request-id","ms-cv","return-client-request-id","traceparent","Access-Control-Allow-Credentials","Access-Control-Allow-Headers","Access-Control-Allow-Methods","Access-Control-Allow-Origin","Access-Control-Expose-Headers","Access-Control-Max-Age","Access-Control-Request-Headers","Access-Control-Request-Method","Origin","Accept","Accept-Encoding","Cache-Control","Connection","Content-Length","Content-Type","Date","ETag","Expires","If-Match","If-Modified-Since","If-None-Match","If-Unmodified-Since","Last-Modified","Pragma","Request-Id","Retry-After","Server","Transfer-Encoding","User-Agent","WWW-Authenticate"],E=["api-version"];Symbol("rawContent"),new Set("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'()+,-./:=?"),(0,v.createClientLogger)("core-rest-pipeline retryPolicy"),Symbol.iterator,Symbol.for("@azure/core-tracing span"),Symbol.for("@azure/core-tracing namespace");const T={},I=new class{constructor({additionalAllowedHeaderNames:e=[],additionalAllowedQueryParameters:t=[]}={}){e=_.concat(e),t=E.concat(t),this.allowedHeaderNames=new Set(e.map((e=>e.toLowerCase()))),this.allowedQueryParameters=new Set(t.map((e=>e.toLowerCase())))}sanitize(e){const t=new Set;return JSON.stringify(e,((e,i)=>{if(i instanceof Error)return Object.assign(Object.assign({},i),{name:i.name,message:i.message});if("headers"===e)return this.sanitizeHeaders(i);if("url"===e)return this.sanitizeUrl(i);if("query"===e)return this.sanitizeQuery(i);if("body"!==e&&"response"!==e&&"operationSpec"!==e){if(Array.isArray(i)||!("object"!=typeof(n=i)||null===n||Array.isArray(n)||n instanceof RegExp||n instanceof Date)){if(t.has(i))return"[Circular]";t.add(i)}var n;return i}}),2)}sanitizeHeaders(e){const t={};for(const i of Object.keys(e))this.allowedHeaderNames.has(i.toLowerCase())?t[i]=e[i]:t[i]=C;return t}sanitizeQuery(e){if("object"!=typeof e||null===e)return e;const t={};for(const i of Object.keys(e))this.allowedQueryParameters.has(i.toLowerCase())?t[i]=e[i]:t[i]=C;return t}sanitizeUrl(e){if("string"!=typeof e||null===e)return e;const t=new URL(e);if(!t.search)return e;for(const[e]of t.searchParams)this.allowedQueryParameters.has(e.toLowerCase())||t.searchParams.set(e,C);return t.toString()}};class b extends Error{constructor(e,t={}){super(e),this.name="RestError",this.code=t.code,this.statusCode=t.statusCode,this.request=t.request,this.response=t.response,Object.setPrototypeOf(this,b.prototype)}[T](){return`RestError: ${this.message} \n ${I.sanitize(this)}`}}b.REQUEST_SEND_ERROR="REQUEST_SEND_ERROR",b.PARSE_ERROR="PARSE_ERROR";class A extends Error{constructor(e){super(e),this.name="AbortError"}}const R="The operation was aborted.";function w(e,t,i){return new Promise(((n,r)=>{let s,a;const o=()=>r(new A((null==i?void 0:i.abortErrorMsg)?null==i?void 0:i.abortErrorMsg:R)),c=()=>{(null==i?void 0:i.abortSignal)&&a&&i.abortSignal.removeEventListener("abort",a)};if(a=()=>(s&&clearTimeout(s),c(),o()),(null==i?void 0:i.abortSignal)&&i.abortSignal.aborted)return o();s=setTimeout((()=>{c(),n(t)}),e),(null==i?void 0:i.abortSignal)&&i.abortSignal.addEventListener("abort",a)}))}const P={forcedRefreshWindowInMs:1e3,retryIntervalInMs:3e3,refreshWindowInMs:12e4};const M="bearerTokenAuthenticationPolicy";async function D(e){const{scopes:t,getAccessToken:i,request:n}=e,r={abortSignal:n.abortSignal,tracingOptions:n.tracingOptions},s=await i(t,r);s&&e.request.headers.set("Authorization",`Bearer ${s.token}`)}class O{get key(){return this._key}constructor(e){if(!e)throw new Error("key must be a non-empty string");this._key=e}update(e){this._key=e}}function k(e){const t=e;return t&&"function"==typeof t.getToken&&(void 0===t.signRequest||t.getToken.length>0)}function N(e){return k(e)?function(e){var t;const{credential:i,scopes:n,challengeCallbacks:r}=e,s=e.logger||y,a=Object.assign({authorizeRequest:null!==(t=null==r?void 0:r.authorizeRequest)&&void 0!==t?t:D,authorizeRequestOnChallenge:null==r?void 0:r.authorizeRequestOnChallenge},r),o=i?function(e,t){let i,n=null,r=null;const s=Object.assign(Object.assign({},P),t),a={get isRefreshing(){return null!==n},get shouldRefresh(){var e;return!a.isRefreshing&&(null!==(e=null==r?void 0:r.expiresOnTimestamp)&&void 0!==e?e:0)-s.refreshWindowInMs<Date.now()},get mustRefresh(){return null===r||r.expiresOnTimestamp-s.forcedRefreshWindowInMs<Date.now()}};function o(t,o){var c;return a.isRefreshing||(n=async function(e,t,i){async function n(){if(!(Date.now()<i)){const t=await e();if(null===t)throw new Error("Failed to refresh access token.");return t}try{return await e()}catch(e){return null}}let r=await n();for(;null===r;)await w(t),r=await n();return r}((()=>e.getToken(t,o)),s.retryIntervalInMs,null!==(c=null==r?void 0:r.expiresOnTimestamp)&&void 0!==c?c:Date.now()).then((e=>(n=null,r=e,i=o.tenantId,r))).catch((e=>{throw n=null,r=null,i=void 0,e}))),n}return async(e,t)=>i!==t.tenantId||Boolean(t.claims)||a.mustRefresh?o(e,t):(a.shouldRefresh&&o(e,t),r)}(i):()=>Promise.resolve(null);return{name:M,async sendRequest(e,t){if(!e.url.toLowerCase().startsWith("https://"))throw new Error("Bearer token authentication is not permitted for non-TLS protected (non-https) URLs.");let i,r;await a.authorizeRequest({scopes:Array.isArray(n)?n:[n],request:e,getAccessToken:o,logger:s});try{i=await t(e)}catch(e){r=e,i=e.response}if(a.authorizeRequestOnChallenge&&401===(null==i?void 0:i.status)&&function(e){const t=e.headers.get("WWW-Authenticate");if(401===e.status&&t)return t}(i)&&await a.authorizeRequestOnChallenge({scopes:Array.isArray(n)?n:[n],request:e,response:i,getAccessToken:o,logger:s}))return t(e);if(r)throw r;return i}}}({credential:e,scopes:["https://communication.azure.com//.default"]}):S(e)}const L=/endpoint=(.*);accesskey=(.*)/i,x=e=>{const t=(e=>{const t=e.match(L);if((null==t?void 0:t[1])&&t[2])return{endpoint:t[1],credential:new O(t[2])}})(e);if(t)return t;throw new Error(`Invalid connection string ${e}`)},U=e=>{if(!(e=>{var t;const i=new URL(e);return!!(null===(t=i.protocol)||void 0===t?void 0:t.match(/^http[s]?/))&&void 0!==i.host&&""!==i.host&&(void 0===i.pathname||""===i.pathname||"/"===i.pathname)})(e))throw new Error(`Invalid endpoint url ${e}`)},F=e=>{const t=e;return t&&"string"==typeof t.key&&void 0===t.getToken},V=(e,t)=>{if(F(t)||k(t))return U(e),{url:e,credential:t};{const{endpoint:t,credential:i}=x(e);return U(t),{url:t,credential:i}}},B=e=>"string"==typeof e.communicationUserId,H=e=>"string"==typeof e.phoneNumber,$=e=>"string"==typeof e.microsoftTeamsUserId,G=e=>"string"==typeof e.teamsAppId,j=e=>"string"==typeof e.id,q=e=>B(e)?Object.assign(Object.assign({},e),{kind:"communicationUser"}):H(e)?Object.assign(Object.assign({},e),{kind:"phoneNumber"}):$(e)?Object.assign(Object.assign({},e),{kind:"microsoftTeamsUser"}):G(e)?Object.assign(Object.assign({},e),{kind:"microsoftTeamsApp"}):Object.assign(Object.assign({},e),{kind:"unknown"}),W=e=>{const t=q(e);switch(t.kind){case"communicationUser":return t.communicationUserId;case"microsoftTeamsUser":{const{microsoftTeamsUserId:e,rawId:i,cloud:n,isAnonymous:r}=t;if(i)return i;if(r)return`8:teamsvisitor:${e}`;switch(n){case"dod":return`8:dod:${e}`;case"gcch":return`8:gcch:${e}`;case"public":return`8:orgid:${e}`}return`8:orgid:${e}`}case"microsoftTeamsApp":{const{teamsAppId:e,rawId:i,cloud:n}=t;if(i)return i;switch(n){case"dod":return`28:dod:${e}`;case"gcch":return`28:gcch:${e}`}return`28:orgid:${e}`}case"phoneNumber":{const{phoneNumber:e,rawId:i}=t;return i||`4:${e}`}case"unknown":return t.id}},z=(e,t)=>({kind:"microsoftTeamsApp",teamsAppId:e,cloud:t}),J=(e,t,i)=>({kind:"microsoftTeamsUser",microsoftTeamsUserId:e,isAnonymous:i,cloud:t}),K=e=>{if(e.startsWith("4:"))return{kind:"phoneNumber",phoneNumber:`${e.substring(2)}`};const t=e.split(":");if(3!==t.length)return{kind:"unknown",id:e};const i=`${t[0]}:${t[1]}:`,n=t[2];switch(i){case"8:teamsvisitor:":return{kind:"microsoftTeamsUser",microsoftTeamsUserId:n,isAnonymous:!0};case"8:orgid:":return J(n,"public",!1);case"8:dod:":return J(n,"dod",!1);case"8:gcch:":return J(n,"gcch",!1);case"8:acs:":case"8:spool:":case"8:dod-acs:":case"8:gcch-acs:":return{kind:"communicationUser",communicationUserId:e};case"28:orgid:":return z(n,"public");case"28:gcch:":return z(n,"gcch");case"28:dod:":return z(n,"dod")}return{kind:"unknown",id:e}},Y=(e,t)=>{const i=Object.keys(e)[0],n=e[i];if(t in n)return n[t];throw new Error(`Property ${t} is required for identifier of type ${i}.`)},Q=e=>{var t,i,n,r,s,a;const o=q(e);switch(o.kind){case"communicationUser":return{rawId:W(o),communicationUser:{id:o.communicationUserId}};case"phoneNumber":return{rawId:null!==(t=o.rawId)&&void 0!==t?t:W(o),phoneNumber:{value:o.phoneNumber}};case"microsoftTeamsUser":return{rawId:null!==(i=o.rawId)&&void 0!==i?i:W(o),microsoftTeamsUser:{userId:o.microsoftTeamsUserId,isAnonymous:null!==(n=o.isAnonymous)&&void 0!==n&&n,cloud:null!==(r=o.cloud)&&void 0!==r?r:"public"}};case"microsoftTeamsApp":return{rawId:null!==(s=o.rawId)&&void 0!==s?s:W(o),microsoftTeamsApp:{appId:o.teamsAppId,cloud:null!==(a=o.cloud)&&void 0!==a?a:"public"}};case"unknown":return{rawId:o.id};default:throw new Error(`Can't serialize an identifier with kind ${o.kind}`)}},X=e=>{var t;(e=>{const t=[];if(void 0!==e.communicationUser&&t.push("communicationUser"),void 0!==e.microsoftTeamsUser&&t.push("microsoftTeamsUser"),void 0!==e.microsoftTeamsApp&&t.push("microsoftTeamsApp"),void 0!==e.phoneNumber&&t.push("phoneNumber"),t.length>1)throw new Error(`Only one of the properties in ${JSON.stringify(t)} should be present.`)})(e);const{communicationUser:i,microsoftTeamsUser:n,microsoftTeamsApp:r,phoneNumber:s}=e,a=null!==(t=e.kind)&&void 0!==t?t:(e=>e.communicationUser?"communicationUser":e.phoneNumber?"phoneNumber":e.microsoftTeamsUser?"microsoftTeamsUser":e.microsoftTeamsApp?"microsoftTeamsApp":"unknown")(e);return"communicationUser"===a&&i?{kind:"communicationUser",communicationUserId:Y({communicationUser:i},"id")}:"phoneNumber"===a&&s?{kind:"phoneNumber",phoneNumber:Y({phoneNumber:s},"value"),rawId:Y({phoneNumber:e},"rawId")}:"microsoftTeamsUser"===a&&n?{kind:"microsoftTeamsUser",microsoftTeamsUserId:Y({microsoftTeamsUser:n},"userId"),isAnonymous:Y({microsoftTeamsUser:n},"isAnonymous"),cloud:Y({microsoftTeamsUser:n},"cloud"),rawId:Y({microsoftTeamsUser:e},"rawId")}:"microsoftTeamsApp"===a&&r?{kind:"microsoftTeamsApp",teamsAppId:Y({microsoftTeamsApp:r},"appId"),cloud:Y({microsoftTeamsApp:r},"cloud"),rawId:Y({microsoftTeamsApp:e},"rawId")}:{kind:"unknown",id:Y({unknown:e},"rawId")}}},367:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AzureLogger:()=>v,createClientLogger:()=>T,getLogLevel:()=>_,setLogLevel:()=>C});const n="undefined"!=typeof process&&process.env&&process.env.DEBUG||void 0;let r,s=[],a=[];const o=[];n&&l(n);const c=Object.assign((e=>h(e)),{enable:l,enabled:d,disable:function(){const e=r||"";return l(""),e},log:function(...e){if(e.length>0){const t=String(e[0]);t.includes(":error")?console.error(...e):t.includes(":warning")?console.warn(...e):t.includes(":info")?console.info(...e):(t.includes(":verbose"),console.debug(...e))}}});function l(e){r=e,s=[],a=[];const t=/\*/g,i=e.split(",").map((e=>e.trim().replace(t,".*?")));for(const e of i)e.startsWith("-")?a.push(new RegExp(`^${e.substr(1)}$`)):s.push(new RegExp(`^${e}$`));for(const e of o)e.enabled=d(e.namespace)}function d(e){if(e.endsWith("*"))return!0;for(const t of a)if(t.test(e))return!1;for(const t of s)if(t.test(e))return!0;return!1}function h(e){const t=Object.assign((function(...i){t.enabled&&(i.length>0&&(i[0]=`${e} ${i[0]}`),t.log(...i))}),{enabled:d(e),destroy:u,log:c.log,namespace:e,extend:g});return o.push(t),t}function u(){const e=o.indexOf(this);return e>=0&&(o.splice(e,1),!0)}function g(e){const t=h(`${this.namespace}:${e}`);return t.log=this.log,t}const p=c,m=new Set,f="undefined"!=typeof process&&process.env&&process.env.AZURE_LOG_LEVEL||void 0;let S;const v=p("azure");v.log=(...e)=>{p.log(...e)};const y=["verbose","info","warning","error"];function C(e){if(e&&!R(e))throw new Error(`Unknown log level '${e}'. Acceptable values: ${y.join(",")}`);S=e;const t=[];for(const e of m)A(e)&&t.push(e.namespace);p.enable(t.join(","))}function _(){return S}f&&(R(f)?C(f):console.error(`AZURE_LOG_LEVEL set to unknown log level '${f}'; logging is not enabled. Acceptable values: ${y.join(", ")}.`));const E={verbose:400,info:300,warning:200,error:100};function T(e){const t=v.extend(e);return I(v,t),{error:b(t,"error"),warning:b(t,"warning"),info:b(t,"info"),verbose:b(t,"verbose")}}function I(e,t){t.log=(...t)=>{e.log(...t)}}function b(e,t){const i=Object.assign(e.extend(t),{level:t});if(I(e,i),A(i)){const e=p.disable();p.enable(e+","+i.namespace)}return m.add(i),i}function A(e){return Boolean(S&&E[e.level]<=E[S])}function R(e){return y.includes(e)}}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e=i(961),t=i(639);let n=document.getElementById("acs");const r=document.querySelector('[src="https://nodered.vncluster.infodation.com/api/getScript2"]');let s=r.getAttribute("data-token");const a=r.getAttribute("data-target"),o=r.getAttribute("data-search");null==n&&((a?document.querySelector(a):document.body).insertAdjacentHTML("beforeend",'\n<div class="acs" id="acs">\n    <div class="acs-main">\n    <div class="acs-header">\n        <div class="acs-header-title">ACS</div>\n        <div class="acs-header-description"><span id="caller-info">+0123453</span> \n        </br> \n        <span id="time">Incoming call</span></div>\n    </div>\n    <div class="acs-buttons">\n        <button class="acs-reject" id="acs-reject"> Decline</button>\n        <button class="acs-accept" id="acs-accept"> Accept</button>\n    </div>\n    </div>\n</div> \n\n<style>\n  .acs {\n  position: fixed;\n  font-family: "San Francisco", sans-serif; \n  width: 350px; \n  height: 200px; \n  left: -400px;\n  bottom: 30px;\n  background-color: #1a1a28; \n  z-index: 100;\n  color: #fff; \n  border-radius: 15px; \n  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n  transition: all 0.3s ease;\n}\n.active {\n  left: 30px;\n}\n#time{\n  font-style: italic;\n}\n\n\n.acs-main {\n  padding: 20px; \n}\n\n.acs-header-title {\n  text-align: center;\n  font-size: 24px; \n  font-weight: 600; \n  margin-bottom: 10px; \n}\n\n.acs-header-description {\n  font-size: 16px; \n  color: #b0b0b0; \n  text-align: center;\n}\n\n.acs-buttons {\n  display: flex;\n  gap: 20px;\n  justify-content: space-around; \n}\n\n.acs-accept,\n.acs-reject {\n  background-color: #333; \n  color: #fff;\n  padding: 8px 30px;\n  text-align: center;\n  text-decoration: none;\n  font-size: 17px;\n  font-weight: 500;\n  cursor: pointer;\n  border-radius: 25px;\n  transition: all 0.3s ease;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n  border: 2px solid transparent;\n  margin-top: 20px;\n}\n\n.acs-accept {\n  border-color: #4CAF50; \n}\n\n.acs-reject {\n  border-color: #f44336; \n}\n\n.acs-accept:hover {\n  background-color: #66BB6A;\n  border-color: #66BB6A; \n  box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);\n  transform: translateY(-2px);\n}\n\n.acs-reject:hover {\n  background-color: #EF5350;\n  border-color: #EF5350; \n  box-shadow: 0 4px 8px rgba(244, 67, 54, 0.4);\n  transform: translateY(-2px);\n}\n\n           \n</style>\n'),n=document.getElementById("acs"));let c,l,d,h,u,g,p="";const m=document.getElementById("acs-accept"),f=document.getElementById("acs-reject"),S=document.getElementById("caller-info"),v=document.getElementById("time");let y="";const C=new e.CallClient;async function _(e="",t={},i=!1){const n={"Content-Type":"application/json"};if(i){let e=localStorage.getItem("jhi-authenticationtoken");e=JSON.parse(e),n.Authorization=`Bearer ${e}`}try{const i=fetch(e,{method:"POST",headers:n,body:JSON.stringify(t)}),r=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Request timed out"))),1e4)})),s=await Promise.race([i,r]);if(!s.ok)throw new Error("Network response was not ok");return await s.json()}catch(e){return console.error("Error:",e),null}}new MutationObserver((e=>{e.forEach((e=>{Array.from(e.removedNodes).filter((e=>"SCRIPT"===e.tagName&&e.src.includes("https://nodered.vncluster.infodation.com"))).forEach((e=>{const t={id:p,status:"off"};p&&navigator.sendBeacon("https://nodered.vncluster.infodation.com/api/updateCallAgentStatus",JSON.stringify(t))}))}))})).observe(document.body,{childList:!0,subtree:!0}),window.onbeforeunload=function(){let e={id:`${p}`,status:"off"};p&&navigator.sendBeacon("https://nodered.vncluster.infodation.com/api/updateCallAgentStatus",JSON.stringify(e))},(async()=>{try{let e=localStorage.getItem("jhi-authenticationtoken");console.log(e),e=JSON.parse(e);const i=await _("https://nodered.vncluster.infodation.com/getCallAgent",{token:e});if(null==i||i==[])return void console.log("Please submit a valid token!");s=i.token,p=i.id,console.log(p),u=new t.H(s),d=await C.createCallAgent(u),h=await C.getDeviceManager();const[r,a]=await Promise.all([h.getMicrophones(),h.getSpeakers()]);r[0].name&&a[0].name||(console.log("No microphone or speaker found"),!1===(await h.askDevicePermission({audio:!0})).audio&&alert("Please allow microphone access to make calls")),d.on("incomingCall",(async e=>{try{l=e.incomingCall;const t=l._call._remoteParticipants.filter((e=>"phoneNumber"==e.identifier.kind))[0]?.identifier?.phoneNumber,i=l._call._id;console.log(l._call);let r=await _("https://nodered.vncluster.infodation.com/api/getCustomer/"+t,{});S.textContent=r[0]?.name??t,y=r[0]?.name??t;const s="https://api.uat.kikker.nl/otrs-acs/api/tickets/acs-create";if(!r[0]?.name){const e=(new Date).toLocaleString("en-US",{timeZone:"UTC",timeZoneName:"short"}),n=`https://haitest365.blob.core.windows.net/acs1/Record-${i}.wav`,r=`https://nodered.vncluster.infodation.com/api/getTranscription?correlationId=${i}`;_(s,{title:"NEW CUSTOMER CALL TO ACS",titleNl:"NIEUWE KLANTOPROEP NAAR ACS",categoryId:15,description:`${t} on ${e} called ACS <br> Audio Record : <a href="${n}" target="_blank">${n}</a> <br> Transcription: <a href="${r}" target="_blank">${r}</a>`,descriptionNl:`${t} om ${e} belde ACS`,priority:"High",sendNotification:1},!0)}n.classList.add("active"),l.on("callEnded",(async()=>{console.log("Call ended"),console.log(c),null!=c&&(await c.hangUp({forEveryone:!0}),c=void 0),await _("https://nodered.vncluster.infodation.com/api/updateCallAgentStatus",{id:`${p}`,status:"on"}),clearInterval(g),v.textContent="Incoming call",n.classList.remove("active"),m.style.visibility="visible"}))}catch(e){console.error(e)}}))}catch(e){console.error(e),console.log("Please submit a valid token!")}})(),f.addEventListener("click",(async()=>{console.log(c);try{null==c?await l.reject():(await c.hangUp({forEveryone:!0}),c=void 0),await _("https://nodered.vncluster.infodation.com/api/updateCallAgentStatus",{id:`${p}`,status:"on"})}catch(e){console.error(e)}finally{clearInterval(g),v.textContent="Incoming call",n.classList.remove("active"),m.style.visibility="visible"}})),m.addEventListener("click",(async()=>{m.style.visibility="hidden",c=await l.accept(),console.log(c),console.log(c.remoteParticipants[0].identifier),console.log(`Call Id: ${c.id}`),c.on("stateChanged",(async()=>{try{if(console.log(`Call state changed: ${c.state}`),"Connected"===c.state){const e=Date.now();g=setInterval((()=>{const t=Math.floor((Date.now()-e)/1e3);v.textContent=`Connected: ${E(t)} `}),1e3)}else"Disconnected"===c.state&&(console.log("Call Disconnected"),clearInterval(g),v.textContent="Incoming call",n.classList.remove("active"),m.style.visibility="visible",console.log(c),null!=c&&(await c.hangUp({forEveryone:!0}),c=void 0),console.log("Call Disconnected end"))}catch(e){console.error(e)}}));const e=document.getElementById(o);if(e){e.value=y,e.focus();const t=new KeyboardEvent("keyup",{key:"Enter"});e.dispatchEvent(t),console.log("click enter event"),navigator.clipboard.writeText(y).then((()=>{}),(e=>{console.error("Could not copy text: ",e)}))}}));const E=e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}})()})();